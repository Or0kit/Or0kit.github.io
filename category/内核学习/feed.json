{
    "version": "https://jsonfeed.org/version/1",
    "title": "Or0kit • All posts by \"内核学习\" category",
    "description": "临渊羡鱼，不如退而结网",
    "home_page_url": "https://Or0kit.github.io",
    "items": [
        {
            "id": "https://or0kit.github.io/Bin/Core/Drive-Development/%E6%96%87%E4%BB%B6%E8%BF%87%E6%BB%A4%E9%A9%B1%E5%8A%A8%E6%80%BB%E7%BB%93%E4%B8%8E%E6%89%A9%E5%B1%95/",
            "url": "https://or0kit.github.io/Bin/Core/Drive-Development/%E6%96%87%E4%BB%B6%E8%BF%87%E6%BB%A4%E9%A9%B1%E5%8A%A8%E6%80%BB%E7%BB%93%E4%B8%8E%E6%89%A9%E5%B1%95/",
            "title": "文件过滤驱动总结与扩展",
            "date_published": "2023-01-14T09:11:30.000Z",
            "content_html": "<h1 id=\"分层驱动框架\"><a class=\"anchor\" href=\"#分层驱动框架\">#</a> 分层驱动框架</h1>\n<ul>\n<li>NT 驱动框架：<strong>单层</strong>驱动，只能接受自己进程的 IRP</li>\n<li>Sfilter 驱动框架：<strong>多层</strong>驱动，接受所有进程的 IRP\n<ul>\n<li>过滤：分层驱动中<strong>再加一层</strong>而不影响它的上下层，以过滤它们之间的数据，对数据或行为进行安全控制。过滤是通过设备绑定实现的 (有多少个文件卷设备就生成多少个文件过滤驱动设备对象一一绑定，这样，发给各个卷设备对象的 IRP 都会被监控到)。</li>\n</ul>\n</li>\n<li>磁盘过滤驱动：用于文件还原</li>\n</ul>\n<h1 id=\"绑定与过滤\"><a class=\"anchor\" href=\"#绑定与过滤\">#</a> 绑定与过滤</h1>\n<ul>\n<li><code>设备栈绑定的形式</code> ：驱动自己生成一个设备 ( <code>过滤设备</code> ), 调用系统提供的绑定 API，绑定到自标设备上，并  <code>返回</code> 一个在  <code>未绑定</code> 之前目标设备所在设备栈的  <code>最顶层设备</code> 。这样发往下层的 IRP 或者发往土层的数据都会被过滤设备截获。</li>\n<li><code>绑定的API</code> :\n<ul>\n<li>loAttachDevice()</li>\n<li>loAttachDeviceToDeviceStackSafe (2000 SP4 以及 XP 以上)</li>\n<li>loAttachDeviceToDeviceStack()</li>\n</ul>\n</li>\n</ul>\n<p>1111111 设备栈的理解</p>\n<h2 id=\"ioattachdevicetodevicestack绑定\"><a class=\"anchor\" href=\"#ioattachdevicetodevicestack绑定\">#</a> IoAttachDeviceToDeviceStack (绑定)</h2>\n<p>函数原型：</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">/// AttachedDevice 需要记录在 DEVICE_EXTENSION 中，以便调用 IoCallDriver () 继续下发 IRP</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\">/// 返回一个在未绑定之前目标设备所在设备栈的最顶层设备，</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\">/// 目的是为了 IRP 继续往下发，所以需要备份下一层的设备对象，即未绑定之前目标设备所在设备栈的最顶层设备</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>PDEVICE_OBJECT <span class=\"token function\">IoAttachDeviceToDeviceStack</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre> IN PDEVICE_OBJECT SourceDevice<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre> IN PDEVICE_OBJECT TargetDevice</pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>windbg 查看设备栈:</p>\n<p><code>!devobj</code>  查看设备对象信息<br />\n <code>!drvobj</code>  查看驱动对象信息<br />\n <code>!devstack</code>  查看设备栈<br />\n <code>!devnode 0 1</code>  系统设备树</p>\n<h2 id=\"设备对象\"><a class=\"anchor\" href=\"#设备对象\">#</a> 设备对象</h2>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">typedef</span> <span class=\"token keyword\">struct</span> <span class=\"token class-name\">_DEVICE</span> _OBJECT</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  SHORT Type<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  WORD Size<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  LONG ReferenceCount<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  PORITER OBIECT DriverObject<span class=\"token punctuation\">;</span> <span class=\"token comment\">///&lt; 生成该设备对象的驱动对象</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  DEVICE OBTECT NextDevice<span class=\"token punctuation\">;</span> <span class=\"token comment\">///&lt; 驱动对象生成的所有设备对象通过 NextDevice 指针组织在 1 个链表里</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  PDEVICE OBTECT AttachedDevice<span class=\"token punctuation\">;</span> <span class=\"token comment\">///&lt; 被哪个设备所绑定</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  PIRP CurrentIrp<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  PIO TIMER Timer<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  LONG Flags<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  LONG Characteristics<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>  PUPB Vpb<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>  VOID DeviceExtension<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>  LONG DeviceType<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>  CHAR StackSize<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>  BYTE Queue <span class=\"token punctuation\">[</span><span class=\"token number\">40</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>  LONG AlignmentRequirement<span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>  DEVICE QUEUE DeviceQueue<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>  KDPC Dpc<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>  LONG ActiveThreadCount<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>  VOID SecurityDescriptor<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>  EVENT DeviceLock<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>  WORD SectorSize<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>  WORD Sparel<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>  PDEVOBT _EXTENSION DeviceObjectExtension<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>  VOID Reserved<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre><span class=\"token punctuation\">&#125;</span>DEVICE OBJECT<span class=\"token punctuation\">,</span> <span class=\"token operator\">*</span>PDEVICE_OBJECT<span class=\"token operator\">:</span></pre></td></tr></table></figure><p><strong>可以利用  <code>AttachedDevice</code>  成员遍历目标设备的设备栈</strong>。由此判断目标设备是否被我们绑定。</p>\n<h2 id=\"对设备对象作不同处理过滤\"><a class=\"anchor\" href=\"#对设备对象作不同处理过滤\">#</a> 对设备对象作不同处理 (过滤)</h2>\n<ol>\n<li><strong>控制设备对象</strong></li>\n</ol>\n<ul>\n<li>DriverEntry 中创建的设备对象</li>\n<li>用来接收自己客户端的 IRP</li>\n</ul>\n<ol start=\"2\">\n<li><strong>过滤设备对象</strong></li>\n</ol>\n<ul>\n<li>绑定时候创建的设备对象</li>\n<li>用来接收其它 R3 程序的 IRP</li>\n</ul>\n<ol start=\"3\">\n<li>分发函数将接收各进程 IRP</li>\n</ol>\n<ul>\n<li>设备对象分控制设备对象和过滤设备对象，但用来接受 Irp 分发函数<strong>只有一个</strong>。</li>\n<li>比如 FilterCreate (PDEVICE_OBJECT DeviceObject,PIRP plrp)，既接收自己进程的 IRP (发给 <strong>控制设备对象</strong>)，也用来接受其他进程 IRP (发给 <strong>过滤设备对象</strong>)</li>\n</ul>\n<ol start=\"4\">\n<li>如何区分 IRP 是自己进程下发的 (发给控制设备对象)，还是别的进程下发的 (发给过滤设备对象)？</li>\n</ol>\n<p>首先认识以下两个宏：</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">/// 宏定义 判断设备对象是否是过滤设备对象:</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\">/// 1. 过滤设备对象不为空</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\">/// 2. 过滤设备对象是由驱动对象创建</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token comment\">/// 3. 如果是过滤设备对象，DeviceExtension 保存着下一层的设备对象</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">IS_MY_DEVICE</span> <span class=\"token expression\"><span class=\"token function\">OBJECT</span><span class=\"token punctuation\">(</span>_devObj<span class=\"token punctuation\">)</span></span><span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre> <span class=\"token expression\"><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>_devObj<span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;&amp;</span></span><span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre> <span class=\"token expression\"><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>_devObj<span class=\"token punctuation\">)</span><span class=\"token operator\">-></span>DriverObject <span class=\"token operator\">==</span> gSfilterDriverObject<span class=\"token punctuation\">)</span><span class=\"token operator\">&amp;&amp;</span></span><span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre> <span class=\"token expression\"><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>devObj<span class=\"token punctuation\">)</span><span class=\"token operator\">-></span>DeviceExtension <span class=\"token operator\">!=</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> </span></span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token comment\">/// 宏定义 判断设备对象是否是控制设备对象:</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token comment\">/// 1.gSfilterControlDeviceObject 指针保存的是在 DriverEntry 创建的控制设备对象的地址</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token comment\">/// 2. 控制设备对象是由驱动对象创建</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token comment\">/// 3. 如果是控制设备对象，DeviceExtension 为空</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name function\">IS_MY_CONTROL_DEVICE_OBJECT</span><span class=\"token expression\"><span class=\"token punctuation\">(</span>_devObj<span class=\"token punctuation\">)</span></span><span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre> <span class=\"token expression\"><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>_devObj<span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> gSfilterControlDeviceObject<span class=\"token punctuation\">)</span> <span class=\"token operator\">?</span></span><span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre> <span class=\"token expression\"><span class=\"token punctuation\">(</span><span class=\"token function\">ASSERT</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>_devObj<span class=\"token punctuation\">)</span><span class=\"token operator\">-></span>DriverObject <span class=\"token operator\">==</span> gSfilterDriverObject<span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;&amp;</span> </span><span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre> <span class=\"token expression\"><span class=\"token punctuation\">(</span>_devObj<span class=\"token punctuation\">)</span><span class=\"token operator\">-></span>DeviceExtension <span class=\"token operator\">==</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>TRUE<span class=\"token punctuation\">)</span><span class=\"token operator\">:</span>FALSE<span class=\"token punctuation\">)</span></span></span></pre></td></tr></table></figure><p>在过滤分发函数的处理：</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">///xxx 表示任意的过滤分发函数</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>NTSTATUS <span class=\"token function\">FilterXXX</span><span class=\"token punctuation\">(</span>IN PDEVICE_OBJECT DeviceObject<span class=\"token punctuation\">,</span> IN PIRP Irp<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    NTSTATUS status<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token function\">PAGED_CODE</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token comment\">// 判断是否是控制设备。</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">IS_MY_CONTROL_DEVICE_OBJECT</span><span class=\"token punctuation\">(</span>DeviceObject<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>        Irp<span class=\"token operator\">-></span>IoStatus<span class=\"token punctuation\">.</span>Status <span class=\"token operator\">=</span> STATUS_INVALID_DEVICE_REQUEST<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>        Irp<span class=\"token operator\">-></span>IoStatus<span class=\"token punctuation\">.</span>Information <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>        <span class=\"token function\">IoCompleteRequest</span><span class=\"token punctuation\">(</span>Irp<span class=\"token punctuation\">,</span> IO_NO_INCREMENT<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>        <span class=\"token comment\">//return STATUS_INVALID_DEVICE_REQUEST;        // 这样写的后果是：我们用 CreateFile 函数在 Ring3 下打开此控制设备符号链接的时候会失败</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>        <span class=\"token keyword\">return</span> STATUS_SUCCESS<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    <span class=\"token comment\">// 判断是否是文件系统的其他设备</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token function\">IS_MY_DEVICE_OBJECT</span><span class=\"token punctuation\">(</span>DeviceObject<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>        <span class=\"token comment\">// 不是我们关心的设备，直接下发</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>        <span class=\"token function\">IoSkipCurrentIrpStackLocation</span><span class=\"token punctuation\">(</span>Irp<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>        <span class=\"token keyword\">return</span> <span class=\"token function\">IoCallDriver</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>PSFILTER_DEVICE_EXTENSION<span class=\"token punctuation\">)</span>DeviceObject<span class=\"token operator\">-></span>DeviceExtension<span class=\"token punctuation\">)</span><span class=\"token operator\">-></span>AttachedToDeviceObject<span class=\"token punctuation\">,</span> Irp<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>    <span class=\"token comment\">// 接下来就是处理来自卷设备 IRP 的 xxx 操作了</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>    ……</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>    ……</pre></td></tr><tr><td data-num=\"28\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h1 id=\"文件系统过滤框架\"><a class=\"anchor\" href=\"#文件系统过滤框架\">#</a> 文件系统过滤框架</h1>\n<ul>\n<li>Sfilter</li>\n<li>Minifilter</li>\n</ul>\n<h2 id=\"sfilter\"><a class=\"anchor\" href=\"#sfilter\">#</a> Sfilter</h2>\n<p>sfilter 是微软的文件过滤驱动样例。</p>\n<h3 id=\"sfilter-代码通读分析\"><a class=\"anchor\" href=\"#sfilter-代码通读分析\">#</a> Sfilter 代码通读分析</h3>\n<ul>\n<li>\n<p>框架代码 <strong>不要钻牛角尖</strong>，把握整体流程即可，不求把每行代码每个变量都扣的清楚。(上万行代码)</p>\n<ul>\n<li>除了过滤分发函数，其他代码理解即可，不需要做改动。</li>\n<li>所以在 Minifilter 中就把这部分代码给封装隐藏了，只需要注册回调函数即可</li>\n</ul>\n</li>\n</ul>\n<p>代码过长，我就放到 github 了，里面有我详细的注释。</p>\n<p>自己画的流程图：</p>\n<p>11111111</p>\n<p>运行效果：</p>\n<p>11111 gif</p>\n<h3 id=\"过滤驱动与irp处理方式\"><a class=\"anchor\" href=\"#过滤驱动与irp处理方式\">#</a> 过滤驱动与 IRP 处理方式</h3>\n<p>1. <code>IoCopyxxX+完成例程</code> 下发</p>\n<ul>\n<li><code>IoCopyCurrentlrpStackLocationToNext</code> + <code>完成例程</code> ：把 IRP 下发之后，上层驱动在某个事件上进行等待。下一层驱动把 IRP 完成之后就会调用完成例程设置事件为有事件状态来通知上层驱动</li>\n</ul>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">/// 拿到当前 IRP 的栈</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\">/// 拿到下一层 IRP 的栈</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\">/// 把当前 IRP 的栈拷贝到下一层 IRP 的栈上，因为当前 IRP 还没下发，所以下一层 IRP 的栈是空的，所以不存在下层 IRP 栈原来有数据被覆盖的问题</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">IoCopycurrentIrpStackLocationToNext</span> <span class=\"token expression\"><span class=\"token punctuation\">(</span>Irp<span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></span><span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre> <span class=\"token expression\">PIO_STACK_LOCATION __irpSp<span class=\"token punctuation\">;</span></span><span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre> <span class=\"token expression\">PI0_STACK_LOCATION __nextIrpSp<span class=\"token punctuation\">;</span></span><span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre> <span class=\"token expression\">__irpsp <span class=\"token operator\">=</span> <span class=\"token function\">IoGetcurrentIrpstackLocation</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>Irp<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></span><span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre> <span class=\"token expression\">__nextIrpSp <span class=\"token operator\">=</span><span class=\"token function\">IoGetNextIrpstackLocation</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>Irp<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></span><span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre> <span class=\"token expression\"><span class=\"token function\">RtlCopyMemory</span><span class=\"token punctuation\">(</span> __nextIrpSp<span class=\"token punctuation\">,</span>__irpSp<span class=\"token punctuation\">,</span><span class=\"token function\">FIELD__OFFSET</span><span class=\"token punctuation\">(</span>IO_STACK_IOCATIONCompletionRoutine<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></span><span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre> <span class=\"token expression\">nextIrpSp<span class=\"token operator\">-></span>control <span class=\"token operator\">=</span> O<span class=\"token punctuation\">;</span><span class=\"token punctuation\">&#125;</span></span></span></pre></td></tr></table></figure><p>2. <code>IoSkip+IoCall</code>  直接下发</p>\n<ul>\n<li><code>IoSkipCurrentIrpStackLocation</code> ，下层设备拿到的 IO_STACKLOCATION 和当前的一样</li>\n</ul>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name function\">IoskipcurrentIrpStackLocation</span><span class=\"token expression\"><span class=\"token punctuation\">(</span>Irp<span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></span><span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre> <span class=\"token expression\"><span class=\"token punctuation\">(</span>Irp<span class=\"token punctuation\">)</span><span class=\"token operator\">-></span>currentLocation<span class=\"token operator\">++</span><span class=\"token punctuation\">;</span> </span><span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre> <span class=\"token expression\"><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span></span></span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre> <span class=\"token comment\">/// 相互抵消，相当于 IRP 栈没有发生变化，下一层驱动对应的 IRP 栈和当前驱动用的是同一个栈，好像 IRP 从来没有到达过当前的驱动层一样</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre> <span class=\"token comment\">/// 为什么不用像第一种方式一样需要拷贝栈数据？是因为当前驱动不需要知道下一层的 IRP 结果，就不需要保存当前驱动对应 IRP 栈的的空间了</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre> <span class=\"token comment\">/// 为什么不直接不加不减？因为下发必然会减 (IoCallDriver)，为保持下一层使用当前驱动对应的 IRP 栈，所以需要先加</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre> </pre></td></tr><tr><td data-num=\"8\"></td><td><pre> <span class=\"token function\">IoskipcurrentIrpstackLocation</span><span class=\"token punctuation\">(</span>Irp<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><span class=\"token comment\">//location+1</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre> <span class=\"token function\">IoCallDriver</span><span class=\"token punctuation\">(</span>deviceExtension<span class=\"token operator\">-></span>nextLower<span class=\"token punctuation\">,</span>Irp<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><span class=\"token comment\">//location-1</span></pre></td></tr></table></figure><p>3. <code>结束IRP</code>  不下发</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">/// 一般用于拒绝的时候</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>PIO_STACK_LOCATION irpStack<span class=\"token operator\">=</span> <span class=\"token function\">IoGetCurrentlrpStackLocation</span><span class=\"token punctuation\">(</span>Irp<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>Irp<span class=\"token operator\">-></span>loStatus<span class=\"token punctuation\">.</span>Status <span class=\"token operator\">=</span> STATUS_ACCESS_DENIED<span class=\"token punctuation\">;</span><span class=\"token comment\">//STATUS_ACCESS_DENIED</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>irp<span class=\"token operator\">-></span>loStatus<span class=\"token punctuation\">.</span>Information <span class=\"token operator\">=</span> O</pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token function\">IoCompleteRequest</span><span class=\"token punctuation\">(</span>lrp<span class=\"token punctuation\">,</span> IO_NO_INCREMENT<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><h4 id=\"irp完成例程注意事项\"><a class=\"anchor\" href=\"#irp完成例程注意事项\">#</a> IRP 完成例程注意事项</h4>\n<ol>\n<li>\n<p>在驱动程序将 IRP 传递个下一个驱动之后，就不再拥有这个 IRP，并且不能试图再去访问它。否则会导致系统崩溃（蓝屏）。</p>\n<ul>\n<li>那个 IRP 会被其它的驱动或者线程  <code>释放或完成</code> 。</li>\n<li>如果驱动需要访问一个已经在栈里传下去的 IRP, 这个驱动必须实现并设置  <code>IoCompletion</code>  例程。</li>\n<li>当 I/O 管理器调用  <code>IoCompletion</code>  例程时，这个驱动就能够在  <code>IoCompletion 例程执行期间</code> 重新获得对这一 IRP 的所有权。如此，loCompletion 例程就能够访问 IRP 中的域。</li>\n</ul>\n</li>\n<li>\n<p>若是驱动的分发例程也还需要在 IRP 被后面的驱动处理完成之后再处理它，这个 IoCompletion 例程必须返回  <code>STATUS_MORE_PROCESSING_REQUIRED</code> ，以将 IRP 的所有权返回给  <code>分发例程</code> 。</p>\n<ul>\n<li>如此一来，I/O 管理器会停止 IRP 的处理，将最终完成 IRP 的任务留给分发例程。分发例程能够在之后调用  <code>IoCompleteRequest</code>  来完成这个 IRP, 或者还能将这个 IRP 标记为等候进一步处理。</li>\n</ul>\n</li>\n</ol>\n<h4 id=\"iocopyxxx完成例程下发\"><a class=\"anchor\" href=\"#iocopyxxx完成例程下发\">#</a>  <code>IoCopyxxX+完成例程</code> 下发</h4>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">/// IoCopyxxX + 完成例程 下发</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\">/// 分发例程</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>KEVENT event<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token function\">KelnitializeEvent</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>event<span class=\"token punctuation\">,</span> NotificationEvent<span class=\"token punctuation\">,</span>FALSE<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">///&lt; 设置一个事件</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token function\">IoCopyCurrentlrpStackLocationToNext</span><span class=\"token punctuation\">(</span>Irp<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">/// 把当前驱动对应的 IRP 栈数据拷贝到下一层驱动上 IRP 栈上</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token comment\">/// 为当前 IRP 设置一个完成例程</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token comment\">/// 驱动需要访问一个已经在栈里传下去的 IRP, 这个驱动必须实现并设置 `IoCompletion` 例程。</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token function\">IoSetCompletionRoutine</span><span class=\"token punctuation\">(</span>Irp<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre> IoCompRoutine<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre> <span class=\"token operator\">&amp;</span>event<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre> TRUE<span class=\"token punctuation\">,</span>TRUE<span class=\"token punctuation\">,</span>TRUE</pre></td></tr><tr><td data-num=\"13\"></td><td><pre> <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token comment\">/// 将 IRP 往下发</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>status <span class=\"token operator\">=</span> <span class=\"token function\">IoCallDriver</span><span class=\"token punctuation\">(</span>DeviceObject<span class=\"token punctuation\">,</span>Irp<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token comment\">/// 如果 IRP 处于 pending 状态，就在这个事件上等待</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>status <span class=\"token operator\">==</span> STATUS_PENDING<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre> status <span class=\"token operator\">=</span> <span class=\"token function\">KeWaitForSingleObject</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>event<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>  Executive<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>  KernelMode<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>  FALSE<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>  <span class=\"token constant\">NULL</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>  <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre> </pre></td></tr><tr><td data-num=\"26\"></td><td><pre><span class=\"token function\">ASSERT</span><span class=\"token punctuation\">(</span><span class=\"token function\">NT_SUCCESS</span><span class=\"token punctuation\">(</span>status<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre><span class=\"token comment\">/// 驱动的分发例程也还需要在 IRP 被后面的驱动处理完成之后再处理它，一般在驱动程序将 IRP 传递个下一个驱动之后，就不再拥有这个 IRP，并且不能试图再去访问它。否则会导致系统崩溃。因为那个 IRP 会被其它的驱动或者线程 `释放或完成`。这里可以访问是因为设置了完成例程，并且这个 IoCompletion 例程返回了 `STATUS_MORE_PROCESSING_REQUIRED`</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>status <span class=\"token operator\">=</span> Irp<span class=\"token operator\">-></span>IoStatus<span class=\"token punctuation\">.</span>Status<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre><span class=\"token function\">IoFreelrp</span><span class=\"token punctuation\">(</span>Irp<span class=\"token punctuation\">)</span> <span class=\"token comment\">///&lt; 原本有完成例程负责 Irp 的销毁，这时候就需要交给分发例程来做了</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre></pre></td></tr><tr><td data-num=\"32\"></td><td><pre></pre></td></tr><tr><td data-num=\"33\"></td><td><pre><span class=\"token comment\">/// 完成例程</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>NTSTATUS <span class=\"token function\">IoCompRoutine</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre> IN PDEVICE_OBJECT DeviceObject<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre> IN PIRP Irp<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre> IN PVOID Context</pre></td></tr><tr><td data-num=\"38\"></td><td><pre> <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre> PKEVENT event <span class=\"token operator\">=</span> Context<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre> <span class=\"token comment\">/// 当 I/O 管理器调用 `IoCompletion` 例程时，这个驱动就能够在 IoCompletion `例程执行期间` 重新获得对这一 IRP 的所有权。</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre> <span class=\"token comment\">/// 如此，IoCompletion 例程就能够访问 IRP 中的域。</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre> Irp<span class=\"token operator\">-></span>UserIosb<span class=\"token operator\">-></span>Status <span class=\"token operator\">=</span> Irp<span class=\"token operator\">-></span>IoStatus<span class=\"token punctuation\">.</span>Status<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre> Irp<span class=\"token operator\">-></span>UserIosb<span class=\"token operator\">-></span>Infomation <span class=\"token operator\">=</span> Irp<span class=\"token operator\">-></span>IoStatus<span class=\"token punctuation\">.</span>Information<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre> <span class=\"token function\">KeSetEvent</span><span class=\"token punctuation\">(</span>event<span class=\"token punctuation\">,</span>IO_NO_INCREMENT<span class=\"token punctuation\">,</span> FALSE<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre> <span class=\"token comment\">//IoFreelrp (Irp) ///&lt; 原本有完成例程负责 Irp 的销毁，这时候就需要交给分发例程来做了</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre> <span class=\"token keyword\">return</span> STATUS_MORE_PROCESSING_REQUIRED<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre> <span class=\"token comment\">/// 返回 STATUS_MORE_PROCESSING_REQUIRED，以将 IRP 的所有权返回给 `分发例程`</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre> <span class=\"token comment\">/// I/O 管理器会停止 IRP 的处理，将最终完成 IRP 的在务留给分发例程。分发例程能够在之后调用 `IoCompleteRequest` 来完成这个 IRP, 或者还能将这个 IRP 标记为等候进一步处理。</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h4 id=\"ioskipiocall直接下发\"><a class=\"anchor\" href=\"#ioskipiocall直接下发\">#</a>  <code>IoSkip+IoCall</code>  直接下发</h4>\n<ul>\n<li>对 IRP 没有任何改动的时候，比如放行</li>\n</ul>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>PDEVICE_EXTENSION deviceExtension<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token function\">IoSkipCurrentlrpstackLocation</span><span class=\"token punctuation\">(</span>lrp<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\">/// 拿到保存在设备扩展里的下层设备 deviceExtension</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token punctuation\">(</span>PDEVICE_EXTENSION<span class=\"token punctuation\">)</span> DeviceObject<span class=\"token operator\">-></span>DeviceExtension<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token comment\">/// 下发</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token comment\">/// 在驱动程序将 IRP 传递个下一个驱动之后，就不再拥有这个 IRP，并且不能试图再去访问它。否则会导致系统崩溃。</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token comment\">/// 因为这个 IRP 会被其它的驱动或者线程 `释放或完成`。</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token keyword\">return</span> <span class=\"token function\">IoCallDriver</span><span class=\"token punctuation\">(</span>deviceExtension<span class=\"token operator\">-></span>TargetDeviceObject<span class=\"token punctuation\">,</span>Irp<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><h4 id=\"错误的下发方式\"><a class=\"anchor\" href=\"#错误的下发方式\">#</a> 错误的下发方式:</h4>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">/// 没有设置完成例程（并且在完成例程中返回 STATUS_MORE_PROCESSING_REQUIRED，以将 IRP 的所有权返回给 `分发例程`）</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\">// Forward request to next driver</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token function\">IoCopyCurrentlrpStackLocationToNext</span><span class=\"token punctuation\">(</span>Irp<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token comment\">// Send the lRP down</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>status <span class=\"token function\">IoCallDriver</span><span class=\"token punctuation\">(</span>nextDevice<span class=\"token punctuation\">,</span>Irp<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token comment\">// The following is an error because thisdriver</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token comment\">// no longer owns the IRP</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>status <span class=\"token operator\">==</span> STATUS_PENDING<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre> <span class=\"token function\">IoMarklrpPending</span><span class=\"token punctuation\">(</span>Irp<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// 错误，无权操作 Irp 了</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token comment\">// Return the lower driver's status</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token keyword\">return</span> status<span class=\"token punctuation\">;</span></pre></td></tr></table></figure><h2 id=\"基于sfilter的hips\"><a class=\"anchor\" href=\"#基于sfilter的hips\">#</a> 基于 Sfilter 的 HIPS</h2>\n<ul>\n<li>监控敏感目录 (全盘监控效率低)</li>\n<li>防勒索工具</li>\n</ul>\n<h3 id=\"过滤分发函数\"><a class=\"anchor\" href=\"#过滤分发函数\">#</a> 过滤分发函数</h3>\n<p>过滤分发函数中所需要做的事情：</p>\n<ul>\n<li>\n<p><code>FilterCreate</code> （创建)</p>\n<ul>\n<li>病毒和木马进入系统肯定会生成一些文件，比如释放  <code>.sys</code> , <code>.dll</code>  文件或者一个  <code>链接</code> 等等都属于文件创建操作</li>\n<li>全局监控太耗性能，只监控一些敏感的区域比较好</li>\n</ul>\n</li>\n<li>\n<p><code>FilterRead</code>  (一般不拦，加解密处理)</p>\n<ul>\n<li>读操作不会修改文件，但是如果作为  <code>隐私保护器</code> ，那需要拦截，防止别人读取文件</li>\n<li>加解密中也要拦截， 读操作这时候是解密</li>\n</ul>\n</li>\n<li>\n<p><code>FilterWrite</code> （修改，小心加解密处理)</p>\n<ul>\n<li>修改文件肯定要拦截</li>\n<li>加解密中也要拦截， 写操作这时候是加密</li>\n</ul>\n</li>\n<li>\n<p><code>FilterSetInfo</code>  (删，重命名)</p>\n<ul>\n<li>删，重命名对应 IRP_MJ_SET_INFORMATION 下的次功能号，所以也需要拦</li>\n</ul>\n</li>\n<li>\n<p><code>FilterClose</code>  (一般不拦)</p>\n</li>\n<li>\n<p><code>FilterClean</code> （写关闭等)</p>\n<ul>\n<li>写关闭：写操作完成之后关闭，要拦截。</li>\n<li>比如，一个病毒特征码是  <code>foul</code> , 要把病毒写到文件中去，直接写  <code>foul</code> , 在写的时候就会被杀毒软件匹配并拦截到。但每次写的时候只写一部分，第 1 次写  <code>f</code> ，第 2 次写  <code>o</code> ，第 3 次写  <code>u</code> ，第 4 次写  <code>l</code> ，写完之后文件保存就是  <code>foul</code> ，绕过了杀毒软件的查杀。所以要在每次写完的关闭之前都需要扫描一遍文件是不是匹配病毒特征码，所以写关闭是需要拦截的。</li>\n<li>写关闭有时候无法直接区分，因为打开文件再关闭， <code>关闭之前不知道是读还是写</code> ，在 xp 里面，关闭的时候 information 是 2 则表示是写，win7 及以后版本则没有了这些标志。</li>\n<li>所以在 Sfilter 里面，往往是通过文件的修改时间来判断，如果是在  <code>1min</code>  之内则认为是写关闭。</li>\n<li>Minifilter 里面有  <code>上下文</code> ，写操作在打开文件的时候我们是知道的，因为打开文件的时候带写权限，把信息记录下来通过上下文的形式传给关闭操作的。</li>\n</ul>\n</li>\n</ul>\n<h3 id=\"代码详解\"><a class=\"anchor\" href=\"#代码详解\">#</a> 代码详解</h3>\n<h2 id=\"minifilter\"><a class=\"anchor\" href=\"#minifilter\">#</a> Minifilter</h2>\n<h3 id=\"minifilter与legacy-filtersfilter区别\"><a class=\"anchor\" href=\"#minifilter与legacy-filtersfilter区别\">#</a> Minifilter 与 legacy filter (Sfilter) 区别</h3>\n<ul>\n<li>\n<p>新一代的文件过滤驱动框架: Minifilter</p>\n</li>\n<li>\n<p>比 sfilter  <code>加载顺序更易控制</code> 。 <code>altitude</code>  被绑定到合适的位置。</p>\n</li>\n<li>\n<p><code>可卸载</code> 能力。</p>\n<ul>\n<li>系统不重启的情况下，HOOK 不支持卸载，卸载可能会蓝屏，是因为有的 IRP 可能没有立即返回，会被  <code>pending</code>  起来，如果这时候把 hook 的函数卸载，当重新回来执行的时候，函数的地址就失效了，内存无效，蓝屏。</li>\n<li>解决方法：引用计数</li>\n<li>minifiler 驱动是向 minifiler 框架注册的，minifilter 驱动卸载了，框架还在，就不会造成类似 HOOK 函数卸载后的问题</li>\n</ul>\n</li>\n<li>\n<p>Callback 模型  <code>仅需处理必要操作</code> 的能力 (pre_create,post create)</p>\n<ul>\n<li>相当于把 Sfilter 的分发函数分为两部分： <code>pre_create</code>  (IRP 下发之前), <code>post create</code>  (IRP 处理完之后)</li>\n<li>如果不想处理 IRP 就不需要注册对应的回调函数 (如果是 Sfilter 则需要为不处理的 IRP 注册一个  <code>通用</code> 的过滤分发函数)</li>\n<li>绑定过滤设备对象动作  <code>被隐藏</code></li>\n</ul>\n</li>\n<li>\n<p><code>兼容性</code> 更好</p>\n<ul>\n<li>hook 会打架，谁后生成谁优先</li>\n<li>Sfiler 不可卸载</li>\n<li>Minifilter 都没有上述问题</li>\n</ul>\n</li>\n<li>\n<p><code>名字处理</code> 更容易</p>\n<ul>\n<li>Minifilter 拿文件名只需直接调用函数就可以了</li>\n</ul>\n</li>\n<li>\n<p>安装方式 (.inf 或者用代码动态加载)</p>\n<ul>\n<li>动态安装，创建几个与之相关的注册表的键即可</li>\n</ul>\n</li>\n<li>\n<p>通信方式 (port)</p>\n<ul>\n<li>基于端口通信，效率非常高，应用层可以多个线程处理内核层发送的请求，每个线程也可以处理多个请求。</li>\n</ul>\n</li>\n<li>\n<p>同样遵循 IRQL, 锁等内核开发通用机制</p>\n</li>\n<li>\n<p>FltCreateFile/ZwCreateFile</p>\n<ul>\n<li>Minifilter 中不建议使用  <code>Zw*</code>  函数，而是使用  <code>Flt*</code>  函数，避免  <code>重入</code>  (死循环)</li>\n</ul>\n</li>\n</ul>\n<h3 id=\"minifilter框架\"><a class=\"anchor\" href=\"#minifilter框架\">#</a> Minifilter 框架</h3>\n<h4 id=\"minifilter-2\"><a class=\"anchor\" href=\"#minifilter-2\">#</a> Minifilter</h4>\n<p>下图显示了一个简化的 I/O 堆栈，其中包含过滤管理器和三个微型过滤驱动程序。</p>\n<p><img data-src=\"image001.png\" alt=\"\" /></p>\n<ul>\n<li><code>I/O Nanager</code> : 负责把应用层的 IO 请求封装成 IRP 包，发送给  <code>Filter Manager</code></li>\n<li><code>Filter Manager Frame</code> : 把 IRP 重新组装成  <code>FLT_CALLBACK_DATA</code>  结构体，把这个结构体传给逐层传给 Minifilter 驱动 A，B，C (Altitude 值不一样，每次加载的时候相对关系是固定的，值大的在上层，越优先处理)，即 Minifilter 中没有 IRP 这一说法了，处理 IO 数据的时候都是从  <code>FLT_CALLBACK_DATA</code>  结构体中拿数据。</li>\n</ul>\n<h4 id=\"minifilter与sfilter共存\"><a class=\"anchor\" href=\"#minifilter与sfilter共存\">#</a> Minifilter 与 Sfilter 共存</h4>\n<p>下图显示了一个简化的 I/O 堆栈，其中包含两个过滤管理器帧、微型过滤驱动程序实例和旧过滤驱动程序。</p>\n<p><img data-src=\"image002.png\" alt=\"\" /></p>\n<ul>\n<li>Legacy Filter Driver：指的是  <code>Sfilter</code>  驱动，虽然夹在两个  <code>Filter Manager Frame</code> , 但 Sfilter 驱动是  <code>没有高度</code> 的。Sfilter 驱动可以在  <code>Filter Manager Frame</code>  的上面也可以在下面，二者之间没有说谁的级别比谁的级别高。</li>\n</ul>\n<h4 id=\"altitude值\"><a class=\"anchor\" href=\"#altitude值\">#</a> Altitude 值</h4>\n<ul>\n<li>\n<p>20000-429999</p>\n</li>\n<li>\n<p>每一个  <code>minifilter驱动</code> 必须有一个叫做  <code>altitude</code>  的  <code>唯一标识符</code> 。一个 minifilter 驱动的 altitude 定义了它加载时在 I/O 栈中相对其他 minifilter 驱动的位置。值越小，栈中位置就越低。</p>\n</li>\n<li>\n<p>FSFilter Anti-Virus 320000-329999</p>\n<ul>\n<li>此组包括在文件 I/O 期间探测并杀毒的过滤驱动。</li>\n<li><code>反病毒在加解密之前</code> 是合理的，如果加解密在前面，把文件加密了，反病毒就无法识别病毒特征码了。</li>\n</ul>\n</li>\n<li>\n<p>FSFilter Encryption 140000-149999</p>\n<ul>\n<li>此组包括在文件 I/O 期间  <code>加密</code> 和  <code>解密</code> 数据的过滤驱动。</li>\n</ul>\n</li>\n</ul>\n<h3 id=\"minifilter中的结构和定义\"><a class=\"anchor\" href=\"#minifilter中的结构和定义\">#</a> Minifilter 中的结构和定义</h3>\n<ul>\n<li><code>FLT_REGISTRATION</code>  的定义</li>\n</ul>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">// https://docs.microsoft.com/en-us/windows-hardware/drivers/ifs/managing-contexts-in-a-minifilter-driver</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">const</span> FLT_REGISTRATION fileMonitorRegistration <span class=\"token operator\">=</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre> <span class=\"token keyword\">sizeof</span><span class=\"token punctuation\">(</span> FLT_REGISTRATION<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">///&lt; Size</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre> FELT_REGISTRATION_VERSION<span class=\"token punctuation\">,</span> <span class=\"token comment\">///&lt; Version</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span>                         <span class=\"token comment\">///&lt; Flags</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre> ContextRegistration<span class=\"token punctuation\">,</span>       <span class=\"token comment\">///&lt; ContextRegistration</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre> fileMonitorCallbacks<span class=\"token punctuation\">,</span>      <span class=\"token comment\">///&lt; Operation callbacks, 结构体数组，每一个结构体封装了 IRP 和与之对应的回调函数，注册的回调函数就是放在这个结构体数组里</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre> fileMonUnload<span class=\"token punctuation\">,</span>             <span class=\"token comment\">///&lt; FilterUnload, 在 Minifilter 卸载时调用，做一些清理工作</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre> fileMonInstanceSetup<span class=\"token punctuation\">,</span>      <span class=\"token comment\">///&lt; InstanceSetup，instance 类似 Sfilter 中的过滤设备对象，有多少的卷设备就生成多个实例与之绑定，生成的过程是不可见的（看不到生成实例的代码，是由框架去做的），instance 的数量和卷设备对象的数量相等的，一一对应。</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre> <span class=\"token comment\">///&lt; 调用时机：把 Minifilter 的实例绑定到卷设备对象上会调用这个函数</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre> <span class=\"token comment\">///&lt; 作用：可以记录下 instance 对应卷设备的一些属性，比如说是 C 盘还是 D 盘，文件类型是 FAT32 还是 NTFS，卷的扇区大小是 512B 还是 4KB。存到一个上下文里面（是个缓存），下次用到的时候，之间从缓存里面拿数据既可以了，提高效率。</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">,</span>                      <span class=\"token comment\">///&lt; InstanceQuery Teardown</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre> fileMonInstanceTeardownStart<span class=\"token punctuation\">,</span> <span class=\"token comment\">///&lt; InstanceTeardownStart</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">,</span>                         <span class=\"token comment\">///&lt; InstanceTeardownComplete</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">,</span>                         <span class=\"token comment\">///&lt; GenerateFileName</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">,</span>                         <span class=\"token comment\">///&lt; GenerateDestinationFileName</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre> <span class=\"token constant\">NULL</span>                          <span class=\"token comment\">///&lt; NormalizeNameComponent</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><ul>\n<li><code>fileMonitorCallbacks</code>  结构体数组的定义</li>\n</ul>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">const</span> FLT_OPERATION_REGISTRATION fileMonitorCallbacks<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token operator\">=</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  IRP_MJ_CREATE<span class=\"token punctuation\">,</span> <span class=\"token comment\">/// 表示创建或者打开 IRP 的回调函数</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  FLTFL_OPERATION_REGISTRATION_SKIP_PAGlNG_IO<span class=\"token punctuation\">,</span> <span class=\"token comment\">// Flag，忽略掉 paging_io</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  HOOK_PreNtCreateFile<span class=\"token punctuation\">,</span> <span class=\"token comment\">/// 可以缺省其中一个 </span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  HOOK_PostNtCreateFile <span class=\"token comment\">/// 可以缺省其中一个</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre> <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  IRP_MJCLEANUP<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  <span class=\"token number\">0</span>，</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  HOOK_PreNtCleanup<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>  <span class=\"token constant\">NULL</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre> <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>  IRP_MJ_WRITE<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>  <span class=\"token number\">0</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>  HOOK_PreNtWriteFile<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>  HOOK_PostNtWriteFile</pre></td></tr><tr><td data-num=\"20\"></td><td><pre> <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>  lRP_MJ_SETLINF ORMATION<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>  <span class=\"token number\">0</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>  HOOK_PreNtSetInformationFile<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>  HOOK_PostNtSetInformationFile</pre></td></tr><tr><td data-num=\"26\"></td><td><pre> <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>  IRPZMJ_ORERATION_END</pre></td></tr><tr><td data-num=\"28\"></td><td><pre> <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><ul>\n<li>\n<p>文件带缓存 IO:</p>\n<ul>\n<li>预先读入文件和延迟写入文件。在读 / 写文件的时候，为了提高效率，文件带缓冲进行 IO 操作，读的时候提前读入目标旁边的数据，写的时候会延迟写 ( <code>集中起来一次性写入</code> )，因为磁盘是低速设备，减少 IO 次数是能提高效率的。</li>\n<li>当 ReadFile 时，会调用 NtReadFile () 系统调用，它会构造一个 IRP 下发到 FSD，FSD 会检查这个 IRP 看是不是可以缓存的，是的话，如果还没有为此文件建立缓存的话，就会调用 CclnitializeCacheMap () 函数建立缓存，它里面会调用内存管理器 (VMM）函数建立一个节对象。</li>\n<li>当用到时，会把这个节对象 (和文件关联) 映射到内核空间。如果 IRP 是可缓存的，则调用 CcCopyRead 函数进行从缓存中读入文件。</li>\n<li>如果此文件还没有在内存中，则会产生页面错误，交给 MmAccessFault () 函教处理，它会调用 loPageRead iO 分配一个不缓存的 IRP (IRP_PAGING_lO)，但是它会走 FSD，不会调用缓存的函数，而是最终调用磁盘驱动进行真实的磁盘读写读入到内存。</li>\n<li>之后 CcCopyRead () 再不会产生错误了，会从缓存复制到用户 Buffer 中</li>\n</ul>\n</li>\n<li>\n<p>IRP_PAGING_IO:</p>\n<ul>\n<li>情况 1. <code>IRP_NOCACHE</code>  &amp;&amp; 非  <code>IRP_XXX_ PAGING _IO</code> , 也就是用户程序设置 FILE_NO_INTERMEDIATE_BUFFERING, 流程是 App-&gt;IO-&gt;FSD-&gt;DISK</li>\n<li>情况 2. <code>IRP_CACHE</code> &amp;&amp; 非  <code>IRP_XXX_PAGING_IO</code> , 也就是用户程序默认设置，流程是 APP-&gt;IO-&gt;FSD-CC (Cache Manger)-&gt;MM (-&gt;FSD-DISK)</li>\n<li><code>IRP_PAGING_IO</code> : 在情况 2 中：MM 会发起一个 IRP 并标记为  <code>IRP_XXX_PAGING_IO</code> , 流程是 MM-&gt;FSD-&gt;DISK (on behalt of vm), 所以  <code>IRP_PAGING_IO</code>  不是由用户程序发起的，而是由  <code>内存管理器</code> 发起的，所以不需要监控。</li>\n<li>如果设置了 IRP_XXX_PAGING_IO, 那就是 MM 内部用的 IRP,CACHE 标记此时没有意义 (on behalft of vmn)</li>\n<li>发给磁盘的机会:</li>\n<li>1. <code>FILE_NO_INTERMEDIATE_BUFFERING</code> &amp;&amp; 非  <code>IRR_XXX_PAGING_IO</code>  的时候会发给 DISK，即 App-&gt;IO-&gt;FSD-&gt;DISK</li>\n<li>2. <code>IRP_XXX_PAGING_IO</code>  时候会发给 DISK，即 MM-&gt;FSD-&gt;DISK</li>\n</ul>\n</li>\n<li>\n<p>预操作回调函数和后操作回调函数的定义</p>\n</li>\n</ul>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">/// 以 create 操作为例</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\">///create 执行之前调用</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>FLT_PREOP_CALLBACK_STATUS <span class=\"token function\">HOOK_PreNtCreateFile</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre> PFLTCALLBACK_DATA Data<span class=\"token punctuation\">,</span> <span class=\"token comment\">///Filter Manager Frame 将 IRP 重新组装成 `FLT_CALLBACK_DATA` 结构体</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre> PCFLT_RELATED_OBJECTS FltObjects<span class=\"token punctuation\">,</span> <span class=\"token comment\">/// 与 Minifilter 相关的对象</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre> PVOID <span class=\"token operator\">*</span>CompletionContext <span class=\"token comment\">/// 分配的一个 context 资源，可以传给 Post 函数处理，然后在 Post 函数释放掉 context 资源</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre> <span class=\"token comment\">//sandbox</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre> <span class=\"token comment\">// 主防</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre> <span class=\"token comment\">// 杀毒引擎</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre> <span class=\"token comment\">// 加解密</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre> <span class=\"token keyword\">return</span> xxx<span class=\"token punctuation\">;</span> <span class=\"token comment\">/// 这个返回值是返回给 Minifilter 管理器的，拿到返回值之后再决定要不要把操作继续往下发给 Mnifilter 驱动或者 Sfilter 驱动</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre> <span class=\"token comment\">/// Data->IoStatus.Status = STATUS_ACCESS_DENIED; 这个才是返回给 IO 管理器的，即应用层</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>  <span class=\"token comment\">/// PRE-OP 的返回值：(和 sfilter 比较)</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre> <span class=\"token comment\">/// FLT_PREOP_SUCCESS_WITH_CALLBACK // 告诉 Minifilte 管理器要把操作往下发，结束之后要调用 Post, 类似 Sfilter 中 `IoCopyxxX + 完成例程` 将 IRP 下发</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre> <span class=\"token comment\">/// FLTPREOP_SUCCESS_NO_CALLBACK // 告诉 Minifilte 管理器要把操作往下发，结束之后但不需要调用 Post, 类似 Sfilter 中 `IoSkip+IoCall` 直接下发</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre> <span class=\"token comment\">/// FLT_PREOP_PENDING  // 挂起</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre> <span class=\"token comment\">/// FLT PREOP DISALLOW_FASTIO // 禁用 fastio</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre> <span class=\"token comment\">/// FLT_PREOP_COMPLETE // 告诉 Minifilte 管理器要把操作完成之后不下发了，当前为止，不下发有拒绝 (STATUS_ACCESS_DENIED), 成功完成 (STATUS_ACCESS)</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre> <span class=\"token comment\">/// FLT_PREOP_SYNCHRONIZE // 同步</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre></pre></td></tr><tr><td data-num=\"24\"></td><td><pre><span class=\"token comment\">///create 完成之后创建 </span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>FLT_POSTOP_CALLBACK_STATUS <span class=\"token function\">HOOK_PostNtCreateFile</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre> PFLT_CALLBACK_DATA Data<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre> PCFLT RELATED_OBJECTS FltObjects<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre> PVOID completionContext， <span class=\"token comment\">// 在 PRE-OP 里返回 FLT_PREOPsuCcEss_wITH_CALLBACK 时获取里面的上下文，并最后释放 Context 资源</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre> FLT_POST_OPERATION_FLAGS Flags</pre></td></tr><tr><td data-num=\"30\"></td><td><pre><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre> <span class=\"token keyword\">return</span> xxx<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre> <span class=\"token comment\">// POST-OP 的返回值:</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre> <span class=\"token comment\">// FLT_POSTOP_FINISHED_PROCESSING // 最终完成处理</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre> <span class=\"token comment\">// FLT_POSTOP_MORE_PROCESSING_REQUIRED //post 处理完之后，还需要更多处理，一般发生在 Post 里面，如果 Irql 比较高，比如处于 DISPATCH_LEVEL，这样需要做一些操作的时候，是需要开一个工作者线程去做，这时候就需要返回一个 FLT_POSTOP_MORE_PROCESSING_REQUIRED</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre></pre></td></tr><tr><td data-num=\"37\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>FltObjects<span class=\"token operator\">-></span>volume<span class=\"token punctuation\">,</span>FltObjects<span class=\"token operator\">-></span>Instance<span class=\"token punctuation\">,</span>FltObjects<span class=\"token operator\">-></span>FileObject<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>FltObjects<span class=\"token operator\">-></span>FileObject<span class=\"token operator\">-></span>DeviceObject</pre></td></tr></table></figure><ul>\n<li><code>判断Data是什么操作的宏</code></li>\n</ul>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>FLT_IS_IRP_OPERATION  <span class=\"token comment\">/// 应用下发的 IRP</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>FLT_IS_FASTIO_OPERATION <span class=\"token comment\">/// 走缓存</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>FLJ IS_FS_FILTER_OPERATION <span class=\"token comment\">/// 其他 Minifilter 或者 Sfilter 下发的</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre> </pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token comment\">//eg：禁用 fastio</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token function\">FLT_IS_FASTIO_OPERATION</span><span class=\"token punctuation\">(</span>Data<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token comment\">/// 为真则是 Fasdtio 操作</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre> ntStatus STATUS_FLT DISALLOW_FAST_I0<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre> Data<span class=\"token operator\">-></span>loStatus<span class=\"token punctuation\">.</span>status <span class=\"token operator\">=</span> ntStatus<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre> Data<span class=\"token operator\">-></span>loStatus<span class=\"token punctuation\">.</span>Information <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre> <span class=\"token keyword\">return</span> FLT_PREOR_DISALLOW_FASTIO<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><ul>\n<li><code>参数数据的获取</code></li>\n</ul>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>PFLT_CALLBACK_DATA Data<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>PEPROCESS processObject <span class=\"token operator\">=</span> Data<span class=\"token operator\">-></span>Thread <span class=\"token operator\">?</span> <span class=\"token function\">loThreadToProcess</span><span class=\"token punctuation\">(</span>Data<span class=\"token operator\">-></span>Thread<span class=\"token punctuation\">)</span> <span class=\"token operator\">:</span> <span class=\"token function\">PsGetCurrentProcess</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">/// 把 Thread 转换成 Exprocess 结构</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token function\">HandleToUlong</span><span class=\"token punctuation\">(</span><span class=\"token function\">PsGetProcessld</span><span class=\"token punctuation\">(</span>processObject<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><span class=\"token comment\">/// 通过 Eprocess 结构拿到 PID</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>Data<span class=\"token operator\">-></span>IoStatus<span class=\"token punctuation\">.</span>Status <span class=\"token operator\">=</span> ntStatus<span class=\"token punctuation\">;</span> <span class=\"token comment\">///pIrp->loStatus.Status=ntStatus;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>Data<span class=\"token operator\">-></span>IoStatus<span class=\"token punctuation\">.</span>Information <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">/// 跟 IRP 类似</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>FltObjects<span class=\"token operator\">-></span>Volume<span class=\"token punctuation\">,</span> <span class=\"token comment\">/// 卷设备对象</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>FltObjects<span class=\"token operator\">-></span>Instance<span class=\"token punctuation\">,</span> <span class=\"token comment\">/// 实例对象和 Volume 一一对应</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>FltObjects<span class=\"token operator\">-></span>FileObject<span class=\"token punctuation\">,</span> <span class=\"token comment\">/// 要被操作目标文件的内核对象</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>FltObjects<span class=\"token operator\">-</span>FileObject<span class=\"token operator\">-></span>DeviceObject <span class=\"token comment\">/// 文件所在的设备对象</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre> </pre></td></tr><tr><td data-num=\"13\"></td><td><pre>PMDE pReadMdl <span class=\"token operator\">=</span> Data<span class=\"token operator\">-></span>lopb<span class=\"token operator\">-></span>Parameters<span class=\"token punctuation\">.</span>Read<span class=\"token punctuation\">.</span>MdlAddress<span class=\"token punctuation\">;</span> <span class=\"token comment\">///MdlAddress!=NULL 使用的是 direct io</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>PVOID pReadBuffer <span class=\"token operator\">=</span> Data<span class=\"token operator\">-></span>Iopb<span class=\"token operator\">-></span>Parameters<span class=\"token punctuation\">.</span>ReadBuffer<span class=\"token punctuation\">;</span><span class=\"token comment\">///MdlAddress==NULL 使用的是 readbuffer</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>ULONG uReadLength <span class=\"token operator\">=</span> Data<span class=\"token operator\">-></span>lopb<span class=\"token operator\">-></span>Parameters<span class=\"token punctuation\">.</span>Read<span class=\"token punctuation\">.</span>Length<span class=\"token punctuation\">;</span> <span class=\"token comment\">/// 读数据的长度</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>Data<span class=\"token operator\">-></span>Iopb<span class=\"token operator\">-></span>Parameters<span class=\"token punctuation\">.</span>create<span class=\"token punctuation\">.</span>SecurityContext<span class=\"token operator\">-></span>DesiredAccess <span class=\"token comment\">/// 如果是创建，创建的一些操作可以拿到，比如说以写的方式，读的方式还是读写的方式等</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre> </pre></td></tr><tr><td data-num=\"19\"></td><td><pre>PVOID pQueryBuffer</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>Data<span class=\"token operator\">></span>Iopb<span class=\"token operator\">-></span>Parameters<span class=\"token punctuation\">.</span>DirectoryControl<span class=\"token punctuation\">.</span>QueryDirectory<span class=\"token punctuation\">.</span>DineectoryBuffer<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre><span class=\"token comment\">/// 查询文件夹的 buffer</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>ULONG uQueryBuffersize <span class=\"token operator\">=</span> Data<span class=\"token operator\">-></span>lopb<span class=\"token operator\">-></span>Parameters<span class=\"token punctuation\">.</span>DirectoryControl<span class=\"token punctuation\">.</span>QueryDirectory<span class=\"token punctuation\">.</span>Length<span class=\"token punctuation\">;</span> <span class=\"token comment\">/// 查询文件夹的 buffer 长度</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre></pre></td></tr><tr><td data-num=\"24\"></td><td><pre><span class=\"token comment\">/// 返回</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>Data<span class=\"token operator\">-></span>IoStatus<span class=\"token punctuation\">.</span>Status <span class=\"token operator\">=</span> STATUS_ACCESS_DENIED<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>Data<span class=\"token operator\">-></span>IoStatus<span class=\"token punctuation\">.</span>Information <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre><span class=\"token keyword\">return</span> FLT_PREOP_COMPLETE<span class=\"token punctuation\">;</span></pre></td></tr></table></figure><ul>\n<li><code>启动mifilter</code></li>\n</ul>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">/// 注册</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\">/// 自己封装的一个 initFileMonitor</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>NTSTATUS <span class=\"token function\">initFileMonitor</span><span class=\"token punctuation\">(</span>PDRIVER_OBJECT DriverObject <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre> <span class=\"token comment\">//fileMonitorRegistration 结构体传给 FltRegisterFilter 函数进行注册，得到句柄 g_pFilter</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre> <span class=\"token keyword\">return</span> <span class=\"token function\">FltRegisterFilter</span><span class=\"token punctuation\">(</span> DriverObject<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>        <span class=\"token operator\">&amp;</span>fileMonitorRegistration<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>        <span class=\"token operator\">&amp;</span>g_pFilter<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token comment\">/// 启动</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>NTSTATUS <span class=\"token function\">startFileMonitor</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre> <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>g_pFilter<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>  <span class=\"token comment\">// 启动 Minifilter 驱动，以后所有与 Write，READ，SET_INFORMATION 等相关的 IO 操作依次会被 _Pre* 和 _Pos * 函数拦截</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>  <span class=\"token keyword\">return</span> <span class=\"token function\">FltStartFiltering</span><span class=\"token punctuation\">(</span>g_pFilter<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre> <span class=\"token keyword\">return</span> STATUS_INSUFFICIENT_RESOURCES<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre></pre></td></tr><tr><td data-num=\"20\"></td><td><pre><span class=\"token comment\">/// 卸载</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>VOID <span class=\"token function\">stopFileMonitor</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre> <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>g_pFilter<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre> </pre></td></tr><tr><td data-num=\"26\"></td><td><pre>  <span class=\"token function\">FltUnregisterFilter</span><span class=\"token punctuation\">(</span>g_pFilter<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// 卸载时会调用 fileMonitorRegistration.fileMonUnload 来释放一些资源</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>  g_pFilter <span class=\"token operator\">=</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre> <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h3 id=\"minifilter的安装方式\"><a class=\"anchor\" href=\"#minifilter的安装方式\">#</a> Minifilter 的安装方式</h3>\n<h4 id=\"inf格式安装\"><a class=\"anchor\" href=\"#inf格式安装\">#</a>  <code>.inf</code>  格式安装</h4>\n<p>当我们创建 Minifilter 项目的时候 VS 编译器会自动给我们生成一个格式。我们只需要修改一下几个关键点就可以了，其中也有微软的注释。</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">;</span><span class=\"token punctuation\">;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">;</span><span class=\"token punctuation\">;</span><span class=\"token punctuation\">;</span> xxxx 是驱动项目的名字</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">;</span><span class=\"token punctuation\">;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">[</span>Version<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>Signature   <span class=\"token operator\">=</span> <span class=\"token string\">\"$Windows NT$\"</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token punctuation\">;</span> TODO <span class=\"token operator\">-</span> Change the Class <span class=\"token operator\">and</span> ClassGuid to match the Load Order Group value<span class=\"token punctuation\">,</span> see https<span class=\"token operator\">:</span><span class=\"token comment\">//msdn.microsoft.com/en-us/windows/hardware/gg462963</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token punctuation\">;</span> Class       <span class=\"token operator\">=</span> <span class=\"token string\">\"ActivityMonitor\"</span>                         <span class=\"token punctuation\">;</span>This is determined by the work <span class=\"token keyword\">this</span> filter driver does</pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token punctuation\">;</span> ClassGuid   <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span>b86dff51<span class=\"token operator\">-</span>a31e<span class=\"token operator\">-</span><span class=\"token number\">4</span>bac<span class=\"token operator\">-</span>b3cf<span class=\"token operator\">-</span>e8cfe75c9fc2<span class=\"token punctuation\">&#125;</span>    <span class=\"token punctuation\">;</span>This value is determined by the Load Order Group value</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>Class <span class=\"token operator\">=</span> <span class=\"token string\">\"ActivityMonitor\"</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>ClassGuid <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span>b86dff51<span class=\"token operator\">-</span>a31e<span class=\"token operator\">-</span><span class=\"token number\">4</span>bac<span class=\"token operator\">-</span>b3cf<span class=\"token operator\">-</span>e8cfe75c9fc2<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>Provider    <span class=\"token operator\">=</span> <span class=\"token operator\">%</span>ManufacturerName<span class=\"token operator\">%</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>DriverVer   <span class=\"token operator\">=</span> </pre></td></tr><tr><td data-num=\"14\"></td><td><pre>CatalogFile <span class=\"token operator\">=</span> xxxx<span class=\"token punctuation\">.</span>cat</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>PnpLockDown<span class=\"token operator\">=</span><span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre></pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token punctuation\">[</span>DestinationDirs<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>DefaultDestDir          <span class=\"token operator\">=</span> <span class=\"token number\">12</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>MiniFilter<span class=\"token punctuation\">.</span>DriverFiles  <span class=\"token operator\">=</span> <span class=\"token number\">12</span>            <span class=\"token punctuation\">;</span><span class=\"token operator\">%</span>windir<span class=\"token operator\">%</span>\\system32\\drivers</pre></td></tr><tr><td data-num=\"20\"></td><td><pre></pre></td></tr><tr><td data-num=\"21\"></td><td><pre><span class=\"token punctuation\">;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre><span class=\"token punctuation\">;</span><span class=\"token punctuation\">;</span> Default install sections</pre></td></tr><tr><td data-num=\"23\"></td><td><pre><span class=\"token punctuation\">;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre></pre></td></tr><tr><td data-num=\"25\"></td><td><pre><span class=\"token punctuation\">[</span>DefaultInstall<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>OptionDesc          <span class=\"token operator\">=</span> <span class=\"token operator\">%</span>ServiceDescription<span class=\"token operator\">%</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>CopyFiles           <span class=\"token operator\">=</span> MiniFilter<span class=\"token punctuation\">.</span>DriverFiles</pre></td></tr><tr><td data-num=\"28\"></td><td><pre></pre></td></tr><tr><td data-num=\"29\"></td><td><pre><span class=\"token punctuation\">[</span>DefaultInstall<span class=\"token punctuation\">.</span>Services<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>AddService          <span class=\"token operator\">=</span> <span class=\"token operator\">%</span>ServiceName<span class=\"token operator\">%</span><span class=\"token punctuation\">,</span><span class=\"token punctuation\">,</span>MiniFilter<span class=\"token punctuation\">.</span>Service</pre></td></tr><tr><td data-num=\"31\"></td><td><pre></pre></td></tr><tr><td data-num=\"32\"></td><td><pre><span class=\"token punctuation\">;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre><span class=\"token punctuation\">;</span><span class=\"token punctuation\">;</span> Default uninstall sections</pre></td></tr><tr><td data-num=\"34\"></td><td><pre><span class=\"token punctuation\">;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre></pre></td></tr><tr><td data-num=\"36\"></td><td><pre><span class=\"token punctuation\">[</span>DefaultUninstall<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>DelFiles   <span class=\"token operator\">=</span> MiniFilter<span class=\"token punctuation\">.</span>DriverFiles</pre></td></tr><tr><td data-num=\"38\"></td><td><pre></pre></td></tr><tr><td data-num=\"39\"></td><td><pre><span class=\"token punctuation\">[</span>DefaultUninstall<span class=\"token punctuation\">.</span>Services<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>DelService <span class=\"token operator\">=</span> <span class=\"token operator\">%</span>ServiceName<span class=\"token operator\">%</span><span class=\"token punctuation\">,</span><span class=\"token number\">0x200</span>      <span class=\"token punctuation\">;</span>Ensure service is stopped before deleting</pre></td></tr><tr><td data-num=\"41\"></td><td><pre></pre></td></tr><tr><td data-num=\"42\"></td><td><pre><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre><span class=\"token punctuation\">;</span> Services Section</pre></td></tr><tr><td data-num=\"44\"></td><td><pre><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre></pre></td></tr><tr><td data-num=\"46\"></td><td><pre><span class=\"token punctuation\">[</span>MiniFilter<span class=\"token punctuation\">.</span>Service<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>DisplayName      <span class=\"token operator\">=</span> <span class=\"token operator\">%</span>ServiceName<span class=\"token operator\">%</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>Description      <span class=\"token operator\">=</span> <span class=\"token operator\">%</span>ServiceDescription<span class=\"token operator\">%</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>ServiceBinary    <span class=\"token operator\">=</span> <span class=\"token operator\">%</span><span class=\"token number\">12</span><span class=\"token operator\">%</span>\\<span class=\"token operator\">%</span>DriverName<span class=\"token operator\">%</span><span class=\"token punctuation\">.</span>sys        <span class=\"token punctuation\">;</span><span class=\"token operator\">%</span>windir<span class=\"token operator\">%</span>\\system32\\drivers\\</pre></td></tr><tr><td data-num=\"50\"></td><td><pre>Dependencies     <span class=\"token operator\">=</span> <span class=\"token string\">\"FltMgr\"</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>ServiceType      <span class=\"token operator\">=</span> <span class=\"token number\">2</span>                            <span class=\"token punctuation\">;</span>SERVICE_FILE_SYSTEM_DRIVER</pre></td></tr><tr><td data-num=\"52\"></td><td><pre>StartType        <span class=\"token operator\">=</span> <span class=\"token number\">3</span>                            <span class=\"token punctuation\">;</span>SERVICE_DEMAND_START</pre></td></tr><tr><td data-num=\"53\"></td><td><pre>ErrorControl     <span class=\"token operator\">=</span> <span class=\"token number\">1</span>                            <span class=\"token punctuation\">;</span>SERVICE_ERROR_NORMAL</pre></td></tr><tr><td data-num=\"54\"></td><td><pre><span class=\"token punctuation\">;</span> TODO <span class=\"token operator\">-</span> Change the Load Order Group value</pre></td></tr><tr><td data-num=\"55\"></td><td><pre><span class=\"token punctuation\">;</span> LoadOrderGroup <span class=\"token operator\">=</span> <span class=\"token string\">\"FSFilter Activity Monitor\"</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>LoadOrderGroup <span class=\"token operator\">=</span> <span class=\"token string\">\"_TODO_Change_LoadOrderGroup_appropriately_\"</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre>AddReg           <span class=\"token operator\">=</span> MiniFilter<span class=\"token punctuation\">.</span>AddRegistry</pre></td></tr><tr><td data-num=\"58\"></td><td><pre></pre></td></tr><tr><td data-num=\"59\"></td><td><pre><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre><span class=\"token punctuation\">;</span> Registry Modifications</pre></td></tr><tr><td data-num=\"61\"></td><td><pre><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"62\"></td><td><pre></pre></td></tr><tr><td data-num=\"63\"></td><td><pre><span class=\"token punctuation\">[</span>MiniFilter<span class=\"token punctuation\">.</span>AddRegistry<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"64\"></td><td><pre>HKR<span class=\"token punctuation\">,</span><span class=\"token punctuation\">,</span><span class=\"token string\">\"DebugFlags\"</span><span class=\"token punctuation\">,</span><span class=\"token number\">0x00010001</span> <span class=\"token punctuation\">,</span><span class=\"token number\">0x0</span></pre></td></tr><tr><td data-num=\"65\"></td><td><pre>HKR<span class=\"token punctuation\">,</span><span class=\"token punctuation\">,</span><span class=\"token string\">\"SupportedFeatures\"</span><span class=\"token punctuation\">,</span><span class=\"token number\">0x00010001</span><span class=\"token punctuation\">,</span><span class=\"token number\">0x3</span></pre></td></tr><tr><td data-num=\"66\"></td><td><pre>HKR<span class=\"token punctuation\">,</span><span class=\"token string\">\"Instances\"</span><span class=\"token punctuation\">,</span><span class=\"token string\">\"DefaultInstance\"</span><span class=\"token punctuation\">,</span><span class=\"token number\">0x00000000</span><span class=\"token punctuation\">,</span><span class=\"token operator\">%</span>DefaultInstance<span class=\"token operator\">%</span></pre></td></tr><tr><td data-num=\"67\"></td><td><pre>HKR<span class=\"token punctuation\">,</span><span class=\"token string\">\"Instances\\\"%Instance1.Name%,\"</span>Altitude\"<span class=\"token punctuation\">,</span><span class=\"token number\">0x00000000</span><span class=\"token punctuation\">,</span><span class=\"token operator\">%</span>Instance1<span class=\"token punctuation\">.</span>Altitude<span class=\"token operator\">%</span></pre></td></tr><tr><td data-num=\"68\"></td><td><pre>HKR<span class=\"token punctuation\">,</span><span class=\"token string\">\"Instances\\\"%Instance1.Name%,\"</span>Flags\"<span class=\"token punctuation\">,</span><span class=\"token number\">0x00010001</span><span class=\"token punctuation\">,</span><span class=\"token operator\">%</span>Instance1<span class=\"token punctuation\">.</span>Flags<span class=\"token operator\">%</span></pre></td></tr><tr><td data-num=\"69\"></td><td><pre></pre></td></tr><tr><td data-num=\"70\"></td><td><pre><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"71\"></td><td><pre><span class=\"token punctuation\">;</span> Copy Files</pre></td></tr><tr><td data-num=\"72\"></td><td><pre><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"73\"></td><td><pre></pre></td></tr><tr><td data-num=\"74\"></td><td><pre><span class=\"token punctuation\">[</span>MiniFilter<span class=\"token punctuation\">.</span>DriverFiles<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"75\"></td><td><pre><span class=\"token operator\">%</span>DriverName<span class=\"token operator\">%</span><span class=\"token punctuation\">.</span>sys</pre></td></tr><tr><td data-num=\"76\"></td><td><pre></pre></td></tr><tr><td data-num=\"77\"></td><td><pre><span class=\"token punctuation\">[</span>SourceDisksFiles<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"78\"></td><td><pre>xxxx<span class=\"token punctuation\">.</span>sys <span class=\"token operator\">=</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"79\"></td><td><pre></pre></td></tr><tr><td data-num=\"80\"></td><td><pre><span class=\"token punctuation\">[</span>SourceDisksNames<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"81\"></td><td><pre><span class=\"token number\">1</span> <span class=\"token operator\">=</span> <span class=\"token operator\">%</span>DiskId1<span class=\"token operator\">%</span><span class=\"token punctuation\">,</span><span class=\"token punctuation\">,</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"82\"></td><td><pre></pre></td></tr><tr><td data-num=\"83\"></td><td><pre><span class=\"token punctuation\">;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"84\"></td><td><pre><span class=\"token punctuation\">;</span><span class=\"token punctuation\">;</span> String Section</pre></td></tr><tr><td data-num=\"85\"></td><td><pre><span class=\"token punctuation\">;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"86\"></td><td><pre></pre></td></tr><tr><td data-num=\"87\"></td><td><pre><span class=\"token punctuation\">[</span>Strings<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"88\"></td><td><pre><span class=\"token punctuation\">;</span> TODO <span class=\"token operator\">-</span> Add your manufacturer</pre></td></tr><tr><td data-num=\"89\"></td><td><pre>ManufacturerName        <span class=\"token operator\">=</span> <span class=\"token string\">\"Template\"</span></pre></td></tr><tr><td data-num=\"90\"></td><td><pre>ServiceDescription      <span class=\"token operator\">=</span> <span class=\"token string\">\"xxxx Mini-Filter Driver\"</span></pre></td></tr><tr><td data-num=\"91\"></td><td><pre>ServiceName             <span class=\"token operator\">=</span> <span class=\"token string\">\"xxxx\"</span></pre></td></tr><tr><td data-num=\"92\"></td><td><pre>DriverName              <span class=\"token operator\">=</span> <span class=\"token string\">\"xxxx\"</span></pre></td></tr><tr><td data-num=\"93\"></td><td><pre>DiskId1                 <span class=\"token operator\">=</span> <span class=\"token string\">\"xxxx Device Installation Disk\"</span></pre></td></tr><tr><td data-num=\"94\"></td><td><pre></pre></td></tr><tr><td data-num=\"95\"></td><td><pre><span class=\"token punctuation\">;</span>Instances specific information<span class=\"token punctuation\">.</span></pre></td></tr><tr><td data-num=\"96\"></td><td><pre>DefaultInstance         <span class=\"token operator\">=</span> <span class=\"token string\">\"xxxx Instance\"</span></pre></td></tr><tr><td data-num=\"97\"></td><td><pre>Instance1<span class=\"token punctuation\">.</span>Name          <span class=\"token operator\">=</span> <span class=\"token string\">\"xxxx Instance\"</span></pre></td></tr><tr><td data-num=\"98\"></td><td><pre><span class=\"token punctuation\">;</span> TODO <span class=\"token operator\">-</span> Change the altitude value<span class=\"token punctuation\">,</span> see https<span class=\"token operator\">:</span><span class=\"token comment\">//msdn.microsoft.com/en-us/windows/hardware/drivers/ifs/load-order-groups-and-altitudes-for-minifilter-drivers</span></pre></td></tr><tr><td data-num=\"99\"></td><td><pre>Instance1<span class=\"token punctuation\">.</span>Altitude       <span class=\"token operator\">=</span> <span class=\"token string\">\"370030\"</span></pre></td></tr><tr><td data-num=\"100\"></td><td><pre>Instance1<span class=\"token punctuation\">.</span>Flags         <span class=\"token operator\">=</span> <span class=\"token number\">0x0</span>              <span class=\"token punctuation\">;</span> Allow all attachments</pre></td></tr></table></figure><ul>\n<li>对于  <code>.inf</code>  文件，可以右键选择安装。</li>\n<li>也可以直接调用 API</li>\n</ul>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">;</span><span class=\"token punctuation\">;</span> 加载</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>SetupCopyOEMlnf</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">;</span><span class=\"token punctuation\">;</span> 或者</pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token function\">InstallHinfSection</span><span class=\"token punctuation\">(</span><span class=\"token constant\">NULL</span><span class=\"token punctuation\">,</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">,</span><span class=\"token function\">TEXT</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"DefaultInstall128 .\\\\myfilter.inf\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">;</span><span class=\"token punctuation\">;</span> 卸载</pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token function\">InstallHinfSection</span><span class=\"token punctuation\">(</span><span class=\"token constant\">NULL</span><span class=\"token punctuation\">,</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">,</span><span class=\"token function\">TEXT</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"DefaultUninstall128 .\\\\upfilter.inf\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><h4 id=\"动态加载\"><a class=\"anchor\" href=\"#动态加载\">#</a> 动态加载</h4>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">// MinifilterInstall.cpp : Defines the entry point for the console application.</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">\"stdafx.h\"</span></span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;windows.h></span></span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;winioctl.h></span></span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;winsvc.h></span></span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;stdio.h></span></span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;conio.h></span></span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token comment\">//#include &lt;fltuser.h></span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token comment\">//#include &lt;dontuse.h></span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre></pre></td></tr><tr><td data-num=\"14\"></td><td><pre></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">DRIVER_NAME</span> <span class=\"token string\">\"驱动项目名字\"</span></span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">DRIVER_PATH</span> <span class=\"token string\">\".\\\\驱动项目名字.sys\"</span></span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">DRIVER_ALTITUDE</span>  <span class=\"token string\">\"370020\"</span> <span class=\"token comment\">// 这里没有使用 UNICODE 编码，导致安装不生效，是因为工程是宽字节的工程，如果是多字节工程那就没问题</span></span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre></pre></td></tr><tr><td data-num=\"19\"></td><td><pre><span class=\"token comment\">// SYS 文件跟程序放在同个目录下</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre><span class=\"token comment\">// InstallDriver(DRIVER_NAME,DRIVER_PATH,DRIVER_ALTITUDE);</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre><span class=\"token comment\">// 启动驱动服务 StartDriver (DRIVER_NAME);</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre><span class=\"token comment\">// 停止驱动服务 StopDriver (DRIVER_NAME);</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre><span class=\"token comment\">// 卸载服务 DeleteDriver (DRIVER_NAME);</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>BOOL <span class=\"token function\">InstallDriver</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">const</span> <span class=\"token keyword\">char</span><span class=\"token operator\">*</span> lpszDriverName<span class=\"token punctuation\">,</span><span class=\"token keyword\">const</span> <span class=\"token keyword\">char</span><span class=\"token operator\">*</span> lpszDriverPath<span class=\"token punctuation\">,</span><span class=\"token keyword\">const</span> <span class=\"token keyword\">char</span><span class=\"token operator\">*</span> lpszAltitude<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>    <span class=\"token keyword\">char</span>    szTempStr<span class=\"token punctuation\">[</span>MAX_PATH<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>    HKEY    hKey<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>    DWORD    dwData<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>    <span class=\"token keyword\">char</span>    szDriverImagePath<span class=\"token punctuation\">[</span>MAX_PATH<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>  </pre></td></tr><tr><td data-num=\"31\"></td><td><pre></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>    <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span> <span class=\"token constant\">NULL</span><span class=\"token operator\">==</span>lpszDriverName <span class=\"token operator\">||</span> <span class=\"token constant\">NULL</span><span class=\"token operator\">==</span>lpszDriverPath <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>        <span class=\"token keyword\">return</span> FALSE<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>    <span class=\"token comment\">// 得到完整的驱动路径</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>    <span class=\"token function\">GetFullPathName</span><span class=\"token punctuation\">(</span>lpszDriverPath<span class=\"token punctuation\">,</span> MAX_PATH<span class=\"token punctuation\">,</span> szDriverImagePath<span class=\"token punctuation\">,</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>    SC_HANDLE hServiceMgr<span class=\"token operator\">=</span><span class=\"token constant\">NULL</span><span class=\"token punctuation\">;</span><span class=\"token comment\">// SCM 管理器的句柄</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>    SC_HANDLE hService<span class=\"token operator\">=</span><span class=\"token constant\">NULL</span><span class=\"token punctuation\">;</span><span class=\"token comment\">// NT 驱动程序的服务句柄</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>    <span class=\"token comment\">// 打开服务控制管理器</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>    hServiceMgr <span class=\"token operator\">=</span> <span class=\"token function\">OpenSCManager</span><span class=\"token punctuation\">(</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">,</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">,</span> SC_MANAGER_ALL_ACCESS <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>    <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span> hServiceMgr <span class=\"token operator\">==</span> <span class=\"token constant\">NULL</span> <span class=\"token punctuation\">)</span> </pre></td></tr><tr><td data-num=\"45\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>        <span class=\"token comment\">// OpenSCManager 失败</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>        <span class=\"token function\">CloseServiceHandle</span><span class=\"token punctuation\">(</span>hServiceMgr<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>        <span class=\"token keyword\">return</span> FALSE<span class=\"token punctuation\">;</span>  </pre></td></tr><tr><td data-num=\"49\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>    <span class=\"token comment\">// OpenSCManager 成功  </span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>    <span class=\"token comment\">// 创建驱动所对应的服务</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre>    hService <span class=\"token operator\">=</span> <span class=\"token function\">CreateService</span><span class=\"token punctuation\">(</span> hServiceMgr<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre>        lpszDriverName<span class=\"token punctuation\">,</span>             <span class=\"token comment\">// 驱动程序的在注册表中的名字</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>        lpszDriverName<span class=\"token punctuation\">,</span>             <span class=\"token comment\">// 注册表驱动程序的 DisplayName 值</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre>        SERVICE_ALL_ACCESS<span class=\"token punctuation\">,</span>         <span class=\"token comment\">// 加载驱动程序的访问权限</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre>        SERVICE_FILE_SYSTEM_DRIVER<span class=\"token punctuation\">,</span> <span class=\"token comment\">// 表示加载的服务是文件系统驱动程序</span></pre></td></tr><tr><td data-num=\"59\"></td><td><pre>        SERVICE_DEMAND_START<span class=\"token punctuation\">,</span>       <span class=\"token comment\">// 注册表驱动程序的 Start 值</span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre>        SERVICE_ERROR_IGNORE<span class=\"token punctuation\">,</span>       <span class=\"token comment\">// 注册表驱动程序的 ErrorControl 值</span></pre></td></tr><tr><td data-num=\"61\"></td><td><pre>        szDriverImagePath<span class=\"token punctuation\">,</span>          <span class=\"token comment\">// 注册表驱动程序的 ImagePath 值</span></pre></td></tr><tr><td data-num=\"62\"></td><td><pre>        <span class=\"token string\">\"FSFilter Activity Monitor\"</span><span class=\"token punctuation\">,</span><span class=\"token comment\">// 注册表驱动程序的 Group 值</span></pre></td></tr><tr><td data-num=\"63\"></td><td><pre>        <span class=\"token constant\">NULL</span><span class=\"token punctuation\">,</span> </pre></td></tr><tr><td data-num=\"64\"></td><td><pre>        <span class=\"token string\">\"FltMgr\"</span><span class=\"token punctuation\">,</span>                   <span class=\"token comment\">// 注册表驱动程序的 DependOnService 值</span></pre></td></tr><tr><td data-num=\"65\"></td><td><pre>        <span class=\"token constant\">NULL</span><span class=\"token punctuation\">,</span> </pre></td></tr><tr><td data-num=\"66\"></td><td><pre>        <span class=\"token constant\">NULL</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"67\"></td><td><pre></pre></td></tr><tr><td data-num=\"68\"></td><td><pre>    <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span> hService <span class=\"token operator\">==</span> <span class=\"token constant\">NULL</span> <span class=\"token punctuation\">)</span> </pre></td></tr><tr><td data-num=\"69\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span>  </pre></td></tr><tr><td data-num=\"70\"></td><td><pre>        <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span> <span class=\"token function\">GetLastError</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> ERROR_SERVICE_EXISTS <span class=\"token punctuation\">)</span> </pre></td></tr><tr><td data-num=\"71\"></td><td><pre>        <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"72\"></td><td><pre>            <span class=\"token comment\">// 服务创建失败，是由于服务已经创立过</span></pre></td></tr><tr><td data-num=\"73\"></td><td><pre>            <span class=\"token function\">CloseServiceHandle</span><span class=\"token punctuation\">(</span>hService<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>       <span class=\"token comment\">// 服务句柄</span></pre></td></tr><tr><td data-num=\"74\"></td><td><pre>            <span class=\"token function\">CloseServiceHandle</span><span class=\"token punctuation\">(</span>hServiceMgr<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>    <span class=\"token comment\">// SCM 句柄</span></pre></td></tr><tr><td data-num=\"75\"></td><td><pre>            <span class=\"token keyword\">return</span> TRUE<span class=\"token punctuation\">;</span> </pre></td></tr><tr><td data-num=\"76\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"77\"></td><td><pre>        <span class=\"token keyword\">else</span> </pre></td></tr><tr><td data-num=\"78\"></td><td><pre>        <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"79\"></td><td><pre>            <span class=\"token function\">CloseServiceHandle</span><span class=\"token punctuation\">(</span>hService<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>       <span class=\"token comment\">// 服务句柄</span></pre></td></tr><tr><td data-num=\"80\"></td><td><pre>            <span class=\"token function\">CloseServiceHandle</span><span class=\"token punctuation\">(</span>hServiceMgr<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>    <span class=\"token comment\">// SCM 句柄</span></pre></td></tr><tr><td data-num=\"81\"></td><td><pre>            <span class=\"token keyword\">return</span> FALSE<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"82\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"83\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"84\"></td><td><pre>    <span class=\"token function\">CloseServiceHandle</span><span class=\"token punctuation\">(</span>hService<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>       <span class=\"token comment\">// 服务句柄</span></pre></td></tr><tr><td data-num=\"85\"></td><td><pre>    <span class=\"token function\">CloseServiceHandle</span><span class=\"token punctuation\">(</span>hServiceMgr<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>    <span class=\"token comment\">// SCM 句柄</span></pre></td></tr><tr><td data-num=\"86\"></td><td><pre></pre></td></tr><tr><td data-num=\"87\"></td><td><pre>    <span class=\"token comment\">//-------------------------------------------------------------------------------------------------------</span></pre></td></tr><tr><td data-num=\"88\"></td><td><pre>    <span class=\"token comment\">// SYSTEM\\\\CurrentControlSet\\\\Services\\\\DriverName\\\\Instances 子健下的键值项 </span></pre></td></tr><tr><td data-num=\"89\"></td><td><pre>    <span class=\"token comment\">//-------------------------------------------------------------------------------------------------------</span></pre></td></tr><tr><td data-num=\"90\"></td><td><pre>    <span class=\"token function\">strcpy</span><span class=\"token punctuation\">(</span>szTempStr<span class=\"token punctuation\">,</span><span class=\"token string\">\"SYSTEM\\\\CurrentControlSet\\\\Services\\\\\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"91\"></td><td><pre>    <span class=\"token function\">strcat</span><span class=\"token punctuation\">(</span>szTempStr<span class=\"token punctuation\">,</span>lpszDriverName<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"92\"></td><td><pre>    <span class=\"token function\">strcat</span><span class=\"token punctuation\">(</span>szTempStr<span class=\"token punctuation\">,</span><span class=\"token string\">\"\\\\Instances\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"93\"></td><td><pre>    <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token function\">RegCreateKeyEx</span><span class=\"token punctuation\">(</span>HKEY_LOCAL_MACHINE<span class=\"token punctuation\">,</span>szTempStr<span class=\"token punctuation\">,</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span><span class=\"token string\">\"\"</span><span class=\"token punctuation\">,</span>REG_OPTION_NON_VOLATILE<span class=\"token punctuation\">,</span>KEY_ALL_ACCESS<span class=\"token punctuation\">,</span><span class=\"token constant\">NULL</span><span class=\"token punctuation\">,</span><span class=\"token operator\">&amp;</span>hKey<span class=\"token punctuation\">,</span><span class=\"token punctuation\">(</span>LPDWORD<span class=\"token punctuation\">)</span><span class=\"token operator\">&amp;</span>dwData<span class=\"token punctuation\">)</span><span class=\"token operator\">!=</span>ERROR_SUCCESS<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"94\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"95\"></td><td><pre>        <span class=\"token keyword\">return</span> FALSE<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"96\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"97\"></td><td><pre>    <span class=\"token comment\">// 注册表驱动程序的 DefaultInstance 值 </span></pre></td></tr><tr><td data-num=\"98\"></td><td><pre>    <span class=\"token function\">strcpy</span><span class=\"token punctuation\">(</span>szTempStr<span class=\"token punctuation\">,</span>lpszDriverName<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"99\"></td><td><pre>    <span class=\"token function\">strcat</span><span class=\"token punctuation\">(</span>szTempStr<span class=\"token punctuation\">,</span><span class=\"token string\">\" Instance\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"100\"></td><td><pre>    <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token function\">RegSetValueEx</span><span class=\"token punctuation\">(</span>hKey<span class=\"token punctuation\">,</span><span class=\"token string\">\"DefaultInstance\"</span><span class=\"token punctuation\">,</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span>REG_SZ<span class=\"token punctuation\">,</span><span class=\"token punctuation\">(</span>CONST BYTE<span class=\"token operator\">*</span><span class=\"token punctuation\">)</span>szTempStr<span class=\"token punctuation\">,</span><span class=\"token punctuation\">(</span>DWORD<span class=\"token punctuation\">)</span><span class=\"token function\">strlen</span><span class=\"token punctuation\">(</span>szTempStr<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token operator\">!=</span>ERROR_SUCCESS<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"101\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"102\"></td><td><pre>        <span class=\"token keyword\">return</span> FALSE<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"103\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"104\"></td><td><pre>    <span class=\"token function\">RegFlushKey</span><span class=\"token punctuation\">(</span>hKey<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><span class=\"token comment\">// 刷新注册表</span></pre></td></tr><tr><td data-num=\"105\"></td><td><pre>    <span class=\"token function\">RegCloseKey</span><span class=\"token punctuation\">(</span>hKey<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"106\"></td><td><pre> </pre></td></tr><tr><td data-num=\"107\"></td><td><pre></pre></td></tr><tr><td data-num=\"108\"></td><td><pre>    <span class=\"token comment\">//-------------------------------------------------------------------------------------------------------</span></pre></td></tr><tr><td data-num=\"109\"></td><td><pre>    <span class=\"token comment\">// SYSTEM\\\\CurrentControlSet\\\\Services\\\\DriverName\\\\Instances\\\\DriverName Instance 子健下的键值项 </span></pre></td></tr><tr><td data-num=\"110\"></td><td><pre>    <span class=\"token comment\">//-------------------------------------------------------------------------------------------------------</span></pre></td></tr><tr><td data-num=\"111\"></td><td><pre>    <span class=\"token function\">strcpy</span><span class=\"token punctuation\">(</span>szTempStr<span class=\"token punctuation\">,</span><span class=\"token string\">\"SYSTEM\\\\CurrentControlSet\\\\Services\\\\\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"112\"></td><td><pre>    <span class=\"token function\">strcat</span><span class=\"token punctuation\">(</span>szTempStr<span class=\"token punctuation\">,</span>lpszDriverName<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"113\"></td><td><pre>    <span class=\"token function\">strcat</span><span class=\"token punctuation\">(</span>szTempStr<span class=\"token punctuation\">,</span><span class=\"token string\">\"\\\\Instances\\\\\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"114\"></td><td><pre>    <span class=\"token function\">strcat</span><span class=\"token punctuation\">(</span>szTempStr<span class=\"token punctuation\">,</span>lpszDriverName<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"115\"></td><td><pre>    <span class=\"token function\">strcat</span><span class=\"token punctuation\">(</span>szTempStr<span class=\"token punctuation\">,</span><span class=\"token string\">\" Instance\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"116\"></td><td><pre>    <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token function\">RegCreateKeyEx</span><span class=\"token punctuation\">(</span>HKEY_LOCAL_MACHINE<span class=\"token punctuation\">,</span>szTempStr<span class=\"token punctuation\">,</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span><span class=\"token string\">\"\"</span><span class=\"token punctuation\">,</span>REG_OPTION_NON_VOLATILE<span class=\"token punctuation\">,</span>KEY_ALL_ACCESS<span class=\"token punctuation\">,</span><span class=\"token constant\">NULL</span><span class=\"token punctuation\">,</span><span class=\"token operator\">&amp;</span>hKey<span class=\"token punctuation\">,</span><span class=\"token punctuation\">(</span>LPDWORD<span class=\"token punctuation\">)</span><span class=\"token operator\">&amp;</span>dwData<span class=\"token punctuation\">)</span><span class=\"token operator\">!=</span>ERROR_SUCCESS<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"117\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"118\"></td><td><pre>        <span class=\"token keyword\">return</span> FALSE<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"119\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"120\"></td><td><pre>    <span class=\"token comment\">// 注册表驱动程序的 Altitude 值</span></pre></td></tr><tr><td data-num=\"121\"></td><td><pre>    <span class=\"token function\">strcpy</span><span class=\"token punctuation\">(</span>szTempStr<span class=\"token punctuation\">,</span>lpszAltitude<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"122\"></td><td><pre>    <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token function\">RegSetValueEx</span><span class=\"token punctuation\">(</span>hKey<span class=\"token punctuation\">,</span><span class=\"token string\">\"Altitude\"</span><span class=\"token punctuation\">,</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span>REG_SZ<span class=\"token punctuation\">,</span><span class=\"token punctuation\">(</span>CONST BYTE<span class=\"token operator\">*</span><span class=\"token punctuation\">)</span>szTempStr<span class=\"token punctuation\">,</span><span class=\"token punctuation\">(</span>DWORD<span class=\"token punctuation\">)</span><span class=\"token function\">strlen</span><span class=\"token punctuation\">(</span>szTempStr<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token operator\">!=</span>ERROR_SUCCESS<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"123\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"124\"></td><td><pre>        <span class=\"token keyword\">return</span> FALSE<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"125\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"126\"></td><td><pre>    <span class=\"token comment\">// 注册表驱动程序的 Flags 值</span></pre></td></tr><tr><td data-num=\"127\"></td><td><pre>    dwData<span class=\"token operator\">=</span><span class=\"token number\">0x0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"128\"></td><td><pre>    <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token function\">RegSetValueEx</span><span class=\"token punctuation\">(</span>hKey<span class=\"token punctuation\">,</span><span class=\"token string\">\"Flags\"</span><span class=\"token punctuation\">,</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span>REG_DWORD<span class=\"token punctuation\">,</span><span class=\"token punctuation\">(</span>CONST BYTE<span class=\"token operator\">*</span><span class=\"token punctuation\">)</span><span class=\"token operator\">&amp;</span>dwData<span class=\"token punctuation\">,</span><span class=\"token keyword\">sizeof</span><span class=\"token punctuation\">(</span>DWORD<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token operator\">!=</span>ERROR_SUCCESS<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"129\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"130\"></td><td><pre>        <span class=\"token keyword\">return</span> FALSE<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"131\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"132\"></td><td><pre>    <span class=\"token function\">RegFlushKey</span><span class=\"token punctuation\">(</span>hKey<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><span class=\"token comment\">// 刷新注册表</span></pre></td></tr><tr><td data-num=\"133\"></td><td><pre>    <span class=\"token function\">RegCloseKey</span><span class=\"token punctuation\">(</span>hKey<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"134\"></td><td><pre></pre></td></tr><tr><td data-num=\"135\"></td><td><pre>    <span class=\"token keyword\">return</span> TRUE<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"136\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"137\"></td><td><pre></pre></td></tr><tr><td data-num=\"138\"></td><td><pre>BOOL <span class=\"token function\">StartDriver</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">const</span> <span class=\"token keyword\">char</span><span class=\"token operator\">*</span> lpszDriverName<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"139\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"140\"></td><td><pre>    SC_HANDLE        schManager<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"141\"></td><td><pre>    SC_HANDLE        schService<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"142\"></td><td><pre></pre></td></tr><tr><td data-num=\"143\"></td><td><pre>    <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token constant\">NULL</span><span class=\"token operator\">==</span>lpszDriverName<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"144\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"145\"></td><td><pre>        <span class=\"token keyword\">return</span> FALSE<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"146\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"147\"></td><td><pre></pre></td></tr><tr><td data-num=\"148\"></td><td><pre>    schManager<span class=\"token operator\">=</span><span class=\"token function\">OpenSCManager</span><span class=\"token punctuation\">(</span><span class=\"token constant\">NULL</span><span class=\"token punctuation\">,</span><span class=\"token constant\">NULL</span><span class=\"token punctuation\">,</span>SC_MANAGER_ALL_ACCESS<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"149\"></td><td><pre>    <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token constant\">NULL</span><span class=\"token operator\">==</span>schManager<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"150\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"151\"></td><td><pre>        <span class=\"token function\">CloseServiceHandle</span><span class=\"token punctuation\">(</span>schManager<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"152\"></td><td><pre>        <span class=\"token keyword\">return</span> FALSE<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"153\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"154\"></td><td><pre>    schService<span class=\"token operator\">=</span><span class=\"token function\">OpenService</span><span class=\"token punctuation\">(</span>schManager<span class=\"token punctuation\">,</span>lpszDriverName<span class=\"token punctuation\">,</span>SERVICE_ALL_ACCESS<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"155\"></td><td><pre>    <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token constant\">NULL</span><span class=\"token operator\">==</span>schService<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"156\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"157\"></td><td><pre>        <span class=\"token function\">CloseServiceHandle</span><span class=\"token punctuation\">(</span>schService<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"158\"></td><td><pre>        <span class=\"token function\">CloseServiceHandle</span><span class=\"token punctuation\">(</span>schManager<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"159\"></td><td><pre>        <span class=\"token keyword\">return</span> FALSE<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"160\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"161\"></td><td><pre></pre></td></tr><tr><td data-num=\"162\"></td><td><pre>    <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token function\">StartService</span><span class=\"token punctuation\">(</span>schService<span class=\"token punctuation\">,</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span><span class=\"token constant\">NULL</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"163\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"164\"></td><td><pre>        <span class=\"token function\">CloseServiceHandle</span><span class=\"token punctuation\">(</span>schService<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"165\"></td><td><pre>        <span class=\"token function\">CloseServiceHandle</span><span class=\"token punctuation\">(</span>schManager<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"166\"></td><td><pre>        <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span> <span class=\"token function\">GetLastError</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> ERROR_SERVICE_ALREADY_RUNNING <span class=\"token punctuation\">)</span> </pre></td></tr><tr><td data-num=\"167\"></td><td><pre>        <span class=\"token punctuation\">&#123;</span>   </pre></td></tr><tr><td data-num=\"168\"></td><td><pre>            <span class=\"token comment\">// 服务已经开启</span></pre></td></tr><tr><td data-num=\"169\"></td><td><pre>            <span class=\"token keyword\">return</span> TRUE<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"170\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span> </pre></td></tr><tr><td data-num=\"171\"></td><td><pre>        <span class=\"token keyword\">return</span> FALSE<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"172\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"173\"></td><td><pre>  </pre></td></tr><tr><td data-num=\"174\"></td><td><pre>    <span class=\"token function\">CloseServiceHandle</span><span class=\"token punctuation\">(</span>schService<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"175\"></td><td><pre>    <span class=\"token function\">CloseServiceHandle</span><span class=\"token punctuation\">(</span>schManager<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"176\"></td><td><pre></pre></td></tr><tr><td data-num=\"177\"></td><td><pre>    <span class=\"token keyword\">return</span> TRUE<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"178\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"179\"></td><td><pre></pre></td></tr><tr><td data-num=\"180\"></td><td><pre>BOOL <span class=\"token function\">StopDriver</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">const</span> <span class=\"token keyword\">char</span><span class=\"token operator\">*</span> lpszDriverName<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"181\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"182\"></td><td><pre>    SC_HANDLE        schManager<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"183\"></td><td><pre>    SC_HANDLE        schService<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"184\"></td><td><pre>    SERVICE_STATUS    svcStatus<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"185\"></td><td><pre>    <span class=\"token keyword\">bool</span>            bStopped<span class=\"token operator\">=</span><span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"186\"></td><td><pre></pre></td></tr><tr><td data-num=\"187\"></td><td><pre>    schManager<span class=\"token operator\">=</span><span class=\"token function\">OpenSCManager</span><span class=\"token punctuation\">(</span><span class=\"token constant\">NULL</span><span class=\"token punctuation\">,</span><span class=\"token constant\">NULL</span><span class=\"token punctuation\">,</span>SC_MANAGER_ALL_ACCESS<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"188\"></td><td><pre>    <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token constant\">NULL</span><span class=\"token operator\">==</span>schManager<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"189\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"190\"></td><td><pre>        <span class=\"token keyword\">return</span> FALSE<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"191\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"192\"></td><td><pre>    schService<span class=\"token operator\">=</span><span class=\"token function\">OpenService</span><span class=\"token punctuation\">(</span>schManager<span class=\"token punctuation\">,</span>lpszDriverName<span class=\"token punctuation\">,</span>SERVICE_ALL_ACCESS<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"193\"></td><td><pre>    <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token constant\">NULL</span><span class=\"token operator\">==</span>schService<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"194\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"195\"></td><td><pre>        <span class=\"token function\">CloseServiceHandle</span><span class=\"token punctuation\">(</span>schManager<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"196\"></td><td><pre>        <span class=\"token keyword\">return</span> FALSE<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"197\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span>  </pre></td></tr><tr><td data-num=\"198\"></td><td><pre>    <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token function\">ControlService</span><span class=\"token punctuation\">(</span>schService<span class=\"token punctuation\">,</span>SERVICE_CONTROL_STOP<span class=\"token punctuation\">,</span><span class=\"token operator\">&amp;</span>svcStatus<span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token punctuation\">(</span>svcStatus<span class=\"token punctuation\">.</span>dwCurrentState<span class=\"token operator\">!=</span>SERVICE_STOPPED<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"199\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"200\"></td><td><pre>        <span class=\"token function\">CloseServiceHandle</span><span class=\"token punctuation\">(</span>schService<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"201\"></td><td><pre>        <span class=\"token function\">CloseServiceHandle</span><span class=\"token punctuation\">(</span>schManager<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"202\"></td><td><pre>        <span class=\"token keyword\">return</span> FALSE<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"203\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"204\"></td><td><pre>  </pre></td></tr><tr><td data-num=\"205\"></td><td><pre>    <span class=\"token function\">CloseServiceHandle</span><span class=\"token punctuation\">(</span>schService<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"206\"></td><td><pre>    <span class=\"token function\">CloseServiceHandle</span><span class=\"token punctuation\">(</span>schManager<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"207\"></td><td><pre></pre></td></tr><tr><td data-num=\"208\"></td><td><pre>    <span class=\"token keyword\">return</span> TRUE<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"209\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"210\"></td><td><pre></pre></td></tr><tr><td data-num=\"211\"></td><td><pre>BOOL <span class=\"token function\">DeleteDriver</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">const</span> <span class=\"token keyword\">char</span><span class=\"token operator\">*</span> lpszDriverName<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"212\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"213\"></td><td><pre>    SC_HANDLE        schManager<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"214\"></td><td><pre>    SC_HANDLE        schService<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"215\"></td><td><pre>    SERVICE_STATUS    svcStatus<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"216\"></td><td><pre></pre></td></tr><tr><td data-num=\"217\"></td><td><pre>    schManager<span class=\"token operator\">=</span><span class=\"token function\">OpenSCManager</span><span class=\"token punctuation\">(</span><span class=\"token constant\">NULL</span><span class=\"token punctuation\">,</span><span class=\"token constant\">NULL</span><span class=\"token punctuation\">,</span>SC_MANAGER_ALL_ACCESS<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"218\"></td><td><pre>    <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token constant\">NULL</span><span class=\"token operator\">==</span>schManager<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"219\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"220\"></td><td><pre>        <span class=\"token keyword\">return</span> FALSE<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"221\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"222\"></td><td><pre>    schService<span class=\"token operator\">=</span><span class=\"token function\">OpenService</span><span class=\"token punctuation\">(</span>schManager<span class=\"token punctuation\">,</span>lpszDriverName<span class=\"token punctuation\">,</span>SERVICE_ALL_ACCESS<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"223\"></td><td><pre>    <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token constant\">NULL</span><span class=\"token operator\">==</span>schService<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"224\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"225\"></td><td><pre>        <span class=\"token function\">CloseServiceHandle</span><span class=\"token punctuation\">(</span>schManager<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"226\"></td><td><pre>        <span class=\"token keyword\">return</span> FALSE<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"227\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"228\"></td><td><pre>    <span class=\"token function\">ControlService</span><span class=\"token punctuation\">(</span>schService<span class=\"token punctuation\">,</span>SERVICE_CONTROL_STOP<span class=\"token punctuation\">,</span><span class=\"token operator\">&amp;</span>svcStatus<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"229\"></td><td><pre>    <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token function\">DeleteService</span><span class=\"token punctuation\">(</span>schService<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"230\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"231\"></td><td><pre>        <span class=\"token function\">CloseServiceHandle</span><span class=\"token punctuation\">(</span>schService<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"232\"></td><td><pre>        <span class=\"token function\">CloseServiceHandle</span><span class=\"token punctuation\">(</span>schManager<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"233\"></td><td><pre>        <span class=\"token keyword\">return</span> FALSE<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"234\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"235\"></td><td><pre>    <span class=\"token function\">CloseServiceHandle</span><span class=\"token punctuation\">(</span>schService<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"236\"></td><td><pre>    <span class=\"token function\">CloseServiceHandle</span><span class=\"token punctuation\">(</span>schManager<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"237\"></td><td><pre></pre></td></tr><tr><td data-num=\"238\"></td><td><pre>    <span class=\"token keyword\">return</span> TRUE<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"239\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"240\"></td><td><pre></pre></td></tr><tr><td data-num=\"241\"></td><td><pre><span class=\"token keyword\">int</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> argc<span class=\"token punctuation\">,</span> <span class=\"token keyword\">char</span><span class=\"token operator\">*</span> argv<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"242\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"243\"></td><td><pre> <span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Print any key to install driver\\n\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"244\"></td><td><pre> <span class=\"token function\">getch</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"245\"></td><td><pre> <span class=\"token function\">DeleteDriver</span><span class=\"token punctuation\">(</span>DRIVER_NAME<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"246\"></td><td><pre> <span class=\"token comment\">// 安装驱动调用这个函数</span></pre></td></tr><tr><td data-num=\"247\"></td><td><pre> BOOL bRet <span class=\"token operator\">=</span> <span class=\"token function\">InstallDriver</span><span class=\"token punctuation\">(</span>DRIVER_NAME<span class=\"token punctuation\">,</span> DRIVER_PATH<span class=\"token punctuation\">,</span> DRIVER_ALTITUDE<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"248\"></td><td><pre> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>bRet <span class=\"token operator\">==</span> FALSE<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"249\"></td><td><pre> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"250\"></td><td><pre>  <span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Driver install failed\\n\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"251\"></td><td><pre>  <span class=\"token keyword\">return</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"252\"></td><td><pre> <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"253\"></td><td><pre> <span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Print any key to start driver\\n\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"254\"></td><td><pre> <span class=\"token function\">getch</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"255\"></td><td><pre> <span class=\"token comment\">// 启动驱动调用这个函数</span></pre></td></tr><tr><td data-num=\"256\"></td><td><pre> bRet <span class=\"token operator\">=</span> <span class=\"token function\">StartDriver</span><span class=\"token punctuation\">(</span>DRIVER_NAME<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"257\"></td><td><pre> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>bRet <span class=\"token operator\">==</span> FALSE<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"258\"></td><td><pre> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"259\"></td><td><pre>  <span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"StartDriver failed\\n\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"260\"></td><td><pre>  <span class=\"token keyword\">return</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"261\"></td><td><pre> <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"262\"></td><td><pre> <span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Print any key to stop driver\\n\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"263\"></td><td><pre> <span class=\"token function\">getch</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"264\"></td><td><pre> <span class=\"token comment\">// 停止驱动调用这个</span></pre></td></tr><tr><td data-num=\"265\"></td><td><pre> <span class=\"token function\">StopDriver</span><span class=\"token punctuation\">(</span>DRIVER_NAME<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"266\"></td><td><pre> <span class=\"token comment\">// 删除服务调用这个</span></pre></td></tr><tr><td data-num=\"267\"></td><td><pre> <span class=\"token function\">DeleteDriver</span><span class=\"token punctuation\">(</span>DRIVER_NAME<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"268\"></td><td><pre></pre></td></tr><tr><td data-num=\"269\"></td><td><pre> </pre></td></tr><tr><td data-num=\"270\"></td><td><pre> <span class=\"token keyword\">return</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"271\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p><img data-src=\"image003.png\" alt=\"\" /></p>\n<h4 id=\"路径获取\"><a class=\"anchor\" href=\"#路径获取\">#</a> 路径获取</h4>\n<ul>\n<li>Minifilter 获取文件路径就是如此简单</li>\n</ul>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">/// 在 postcreate 里获得</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>PFLT_FILE_NAME_INFORMATON pNameInfo <span class=\"token operator\">=</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">///Q: 没有内存的指针，为什么可以直接传给 FltGetFileNameInformation 使用呢？</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token comment\">/// A:FltGetFileNameInformation 是带缓存的，如果第一次查询文件的路径，函数会在内部为其分配内存，把文件名放到结构体的内存里面，其他驱动再次查询这个文件路径的时候，如果路径在缓存中，就直接把缓存给它，不再分配新内存。这么多人使用缓存，难以管理，做不到谁分配谁谁释放，所以这里使用了引用计数。</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>ntStatus <span class=\"token operator\">=</span> <span class=\"token function\">FltGetFileNameInformation</span><span class=\"token punctuation\">(</span>Data<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre> FLT_FILE_NAME_NORMALIZED <span class=\"token operator\">|</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre> FLT_FILE_NAME_QuERY_DEFAULT<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre> <span class=\"token operator\">&amp;</span>pNamelnfo<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">/// 传二级指针或者指针的引用才能分配到内存</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token comment\">/// 解析</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token function\">F1tParseFileNamelnformation</span><span class=\"token punctuation\">(</span>pNamelnfo<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>pNamelnfo<span class=\"token operator\">-></span>Name <span class=\"token comment\">//\\\\device\\\\harddiskvolume3\\\\doc\\\\x.dat</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>pNamelnfo<span class=\"token operator\">-></span>Volume</pre></td></tr><tr><td data-num=\"15\"></td><td><pre></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token function\">FltReleaseFileNameInformation</span><span class=\"token punctuation\">(</span>Namelnfo<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// 并不是真正释放内存，而是将缓存的引用计数减 1，当减到 0 的时候才释放内存</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre></pre></td></tr><tr><td data-num=\"18\"></td><td><pre><span class=\"token comment\">// 重命名路径的获得:</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>PFILE_RENAME_INFORMATION</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>pFileRenamelnfomation <span class=\"token operator\">=</span><span class=\"token punctuation\">(</span>PENLE_RENAME_INFORMATION<span class=\"token punctuation\">)</span>Data<span class=\"token operator\">-></span>IopParameters<span class=\"token punctuation\">.</span>SetFilelnformationInfoBuffer<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre></pre></td></tr><tr><td data-num=\"22\"></td><td><pre><span class=\"token comment\">// 或者通过这样获得重命名的路径</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>FltGetDestinationFileInation<span class=\"token punctuation\">;</span></pre></td></tr></table></figure><h2 id=\"基于minifilter的passthrough\"><a class=\"anchor\" href=\"#基于minifilter的passthrough\">#</a> 基于 Minifilter 的 PASSTHROUGH</h2>\n<h2 id=\"应用监控进程创建\"><a class=\"anchor\" href=\"#应用监控进程创建\">#</a> 应用：监控进程创建</h2>\n<p>思路：</p>\n<ul>\n<li>\n<p>NtCreateSection (进程创建)</p>\n<ul>\n<li>对应的 Irp 是  <code>IRP_MJ ACQUIRE FOR_SECTION_SYNCHRONIZATION</code> ，在  <code>Passthrough</code>  中为这个 Irp 注册回调函数</li>\n<li>监控  <code>Data-&gt;lopb-&gt;Parameters.AcquireForSectionSynchronization.PageProtection ==PAGE_EXECUTE</code> ，如果等于就是在创建进程， <code>return STATS_ACCESS_DENY</code></li>\n</ul>\n</li>\n<li>\n<p>优点：SSDT HOOK 只支持 x86（SSDT HOOK 改内核，会触发  <code>patchguard</code>  机制，除非使用 VT 技术欺骗操作系统），Minifilter 不会触发  <code>patchguard</code>  机制，所以  <code>x86和x64 都支持</code> 。</p>\n</li>\n</ul>\n<h2 id=\"callback-irql\"><a class=\"anchor\" href=\"#callback-irql\">#</a> CallBack IRQL</h2>\n<ul>\n<li>1.a  <code>preoperation</code>  callback routine can be called at  <code>IRQL_PASSIVE_LEVEL</code>  or at  <code>IRQL_APC_LEVELS</code>  Typically it is called at  <code>IRQL_PASSIVE_LEVEL</code></li>\n<li>2.lf a minifilter driver's  <code>preoperation</code>  callback routine returns  <code>FLT_PREOP_SYNCHRONIZE</code>  for an lRP-based l/O operation,the corresponding  <code>postoperation</code>  callback routine is called at l  <code>RQL &lt;= APC_LEVEL</code> , in the same thread context as the  <code>preoperation</code> callback routine.</li>\n<li>3.The  <code>postoperation</code>  callback routine for a  <code>fast I/O</code>  operation is called  <code>IRQL_PASSIVE_LEVEL</code> , in the same thread context as the preoperation callback routine.</li>\n<li>4. <code>Post-create</code>  callback routines are called at  <code>IRQL_PASSIVE_LEVEL</code> in the context of the thread that originated the  <code>IRP_MJ_CREATE</code>  operation.</li>\n<li>总而言之， <code>preoperation</code>  一定处于  <code>IRQL_APC_LEVELS</code>  或者  <code>IRQL_PASSIVE_LEVEL</code>  ；而  <code>postoperation</code>  根据具体情况具体分析：2-4 中情况下，处于  <code>IRQL_PASSIVE_LEVEL</code> ，其他情况就不好说了。</li>\n</ul>\n<h2 id=\"避免重入\"><a class=\"anchor\" href=\"#避免重入\">#</a> 避免重入</h2>\n<ul>\n<li>Minifilter 中不建议使用  <code>Zw*</code>  函数，而是使用  <code>Flt*</code>  函数，避免  <code>重入</code>  (死循环)</li>\n<li>eg：不能使用 zwCreateFile 等函数，可能导致重入。</li>\n</ul>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>FltCreateFile</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>FltReadFile</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>FltWriteFile</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>FltClose</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>FltQueryXxxFltSetXxXFltGetXxx</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>FltPerformXxx</pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>ntStatus <span class=\"token operator\">=</span> <span class=\"token function\">FltCreateFile</span><span class=\"token punctuation\">(</span>pFilter<span class=\"token punctuation\">,</span> <span class=\"token comment\">/// 这个参数是注册 Minifilter 返回的句柄</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre> pDstInstance<span class=\"token punctuation\">,</span> <span class=\"token comment\">/// 这个参数是实例的指针，从 FltObjects 中拿，这两个参数是 FltCreateFile 特有的，其他参数和 FltReadFile、FltWriteFile 等都一致</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre> <span class=\"token operator\">&amp;</span>hDstFile<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre> GENERIC_WRITE <span class=\"token operator\">|</span> SYNCHRONIZE<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre> <span class=\"token operator\">&amp;</span>objDstAttrib<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre> <span class=\"token operator\">&amp;</span>ioStatus<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre> FILE_ATTRIBUTE_NORMAL<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre> FILE_SHARE_READ <span class=\"token operator\">|</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre> FILE_SHARE_WRITE <span class=\"token operator\">|</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre> FILE_SHARE DELETE<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre> FILECREATE<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre> CreateOptions<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><h2 id=\"上下文\"><a class=\"anchor\" href=\"#上下文\">#</a> 上下文</h2>\n<ul>\n<li>\n<p><code>设备扩展是什么?</code></p>\n<ul>\n<li>进程的创建和监视，曾经把进程的一些信息放入设备扩展里面</li>\n<li>在 Sfilter 创建过滤设备对象的时候，设备对象存放着下层设备对象的指针 (过滤设备所在的栈，未绑定之前的栈顶上的设备对象指针)</li>\n<li>可以理解为设备扩展的 ' 上下文 '。</li>\n</ul>\n</li>\n<li>\n<p><code>context上下文</code> ：其实就是附着在某个对象上的一段内存，这段内存缓存的相关数据由自己定义；</p>\n<ul>\n<li>eg: 1. 对象：人 2. 上下文：口袋 3. 数据：手机 如果人没有口袋，在路上想付款的时候，发现没有身上手机，只能回家去取 (相当于计算机重新获取数据的过程) 如果有口袋，出门之前把手机放口袋里 (一次性把数据查询出来，缓存到上下文里面), 在路上想付款的时候，直接从口袋里里掏出手机 (想要拿数据的时候，直接从上下文中拿数据，上下文可以提高计算机获取数据的效率)</li>\n<li><code>利用缓存提高程序执行的效率</code> 是非常重要的思想，包括在系统架构里面，经常使用 Redis (NOSQL 数据库) 把平时查询的数据库缓存起来，来缓解关系数据库后台执行程序的压力.</li>\n</ul>\n</li>\n</ul>\n<h3 id=\"minifilter-上下文\"><a class=\"anchor\" href=\"#minifilter-上下文\">#</a> Minifilter 上下文</h3>\n<ul>\n<li>\n<p><code>和中断、进程上下文区别</code> :</p>\n<ul>\n<li>中断上下文：中断传过来的数据，中断前  <code>进程的上下文</code></li>\n<li>进程上下文：寄存器，栈，堆，描述进程的结构体，</li>\n</ul>\n</li>\n<li>\n<p><code>Minifilter的上下文</code> ：其实就是附着在  <code>Minifilter</code>  中对象上的一段内存，这段内存缓存的相关数据由自己定义 (其实是 Mifnifilter 运行期间的所在环境中的信息)</p>\n<ul>\n<li><code>Minifilter</code>  中常见的对象 FileObject,Instance 等，可以给这些对象分配一块内存，存放自定义的数据</li>\n<li><code>分配上下文</code></li>\n</ul>\n</li>\n</ul>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>FltAllocateContext <span class=\"token comment\">// 分配上下文，可以指定上下文的类型，比如 Stream Context,Stream Handle Context,Instance Contxt 等等</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>FltReleaseContext <span class=\"token comment\">// 释放上下文，其实就是把引用计数减 1, 直到引用计数变为 0 之后才释放</span></pre></td></tr></table></figure><ul>\n<li>\n<p><code>Minifilter上下文的应用</code> ：写关闭</p>\n<ul>\n<li><code>写关闭</code> ：以写的方式打开，得到文件的句柄，往这个文件写入数据，最后把文件关闭掉</li>\n<li>(调用 CteateFile ()-&gt;ReadFile ()-&gt;CloseFile ())</li>\n<li>主防或者反病毒一般不关注读关闭 (读关闭不会造成系统破坏，最多会造成隐私泄漏)</li>\n<li>读 / 写关闭在应用层都是调用  <code>CloseHandle(FileHandle)</code> , 所以单从 FileHanle 这个参数是无法知道是读关闭还是写关闭 (在 XP 系统，IRP_MJ_Clean 这个 IRP 里面  <code>information等于2</code> , 就表示是写关闭，否则就是都关闭；但在 vista 中这个条件就不成立了)</li>\n<li>所以在 Sfilter 里面是根据文件最后修改时间，如果是  <code>1min之内</code> ，则认为是写关闭。</li>\n<li><code>Minifilter则可以使用上下文来记录标记</code> ，比如打开文件文件的时候是可以知道  <code>R/W的</code>  (必须传一个读写的标志)，然后把这个标记信息记录在文件 (FileObject) 的  <code>上下文</code> 里面，Clean 的时候 (调用 CloseHandle (FileHandle) 的时候)，通过 FilerHander 找到对应的 FileObject 的上下文找到打开时记录的  <code>R/W</code>  的标志，如果是写的话，即写关闭就处理它 (扫描一遍该文件，和病毒库的特征码匹配一遍，防止生成病毒)。</li>\n</ul>\n</li>\n</ul>\n<h3 id=\"minifilter-上下文的分类\"><a class=\"anchor\" href=\"#minifilter-上下文的分类\">#</a> Minifilter 上下文的分类</h3>\n<ul>\n<li>\n<p>分类依据是什么？</p>\n<ul>\n<li>Minifilter 有很多种对象， <code>根据对象不同</code> 分为不同的类。</li>\n<li>一个文件从磁盘打开加载到内存之后，会产生以下这些</li>\n</ul>\n</li>\n<li>\n<p><code>Stream Context</code>  (流上下文), 绑定到 FCB (File control Block，文件控制块) 的上下文， 文件和 FCB 是一对一的关系。</p>\n</li>\n</ul>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>FltGetStreamContext <span class=\"token comment\">// 获取对象上的上下文</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>FltSetStreamContext <span class=\"token comment\">// 将缓存重新设置到对象上，比如修改了上下文的数据，使用这个函数把上下文更新到对象上</span></pre></td></tr></table></figure><ul>\n<li><code>Stream Handle Context</code>  (流句柄上下文), 就是常见 FO (FileObjec), 文件和 FileObjec 是多对一的关系。\n<ul>\n<li>写关闭</li>\n</ul>\n</li>\n</ul>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>FltGetStreamHandleContext</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>FltSetStreamHandleContext</pre></td></tr></table></figure><ul>\n<li><code>Instance Context</code>  (实例上下文), 也就是过滤驱动在文件系统的设备堆栈上创建的一个过滤器实例；</li>\n</ul>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>FltGetlnstanceContext <span class=\"token comment\">// 获取对象上的上下文</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>FltSetInstanceC ontext <span class=\"token comment\">// 将缓存重新设置到对象上，比如修改了上下文的数据，使用这个函数把上下文更新到对象上</span></pre></td></tr></table></figure><ul>\n<li><code>volume context</code>  (卷上下文), 卷就是通常看到的 C,D 盘以及网络重定向器，一般情况下一个券对一个对滤器实例对象， <code>在实际应用上经常用Instance Context来代替volume Context。</code> (在启动 Minifilter 的时候有多少卷设备对象就生成多少个 Minigilter 实例，安装到卷设备上，安装的那一刻可以把卷设备的信息查询出来 (卷的名字，卷的文件系统信息，文件系统类型，卷的扇区大小等)) 放到 Instance  Context，以后要想知道卷的信息，直接从 Instance  Context 获取即可。</li>\n</ul>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>FltGetVolumeContext</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>FltSetvolumeContext</pre></td></tr></table></figure><ul>\n<li><code>文件上下文</code>  (vista 之后)</li>\n</ul>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>FltGetFileContext</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>FltSetFileContext</pre></td></tr></table></figure><ul>\n<li>其中，  <code>Stream Handle Context</code>  和  <code>Instance Context</code>  使用频率最高</li>\n<li>注册 Minifilter 的时候除了一组用来拦截 Irp 的  <code>fileMonitorCallbacks</code>  数组，还有  <code>一组用来清理Context的回调函数数组</code></li>\n</ul>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>PFLT_FILTER g_pFilter <span class=\"token operator\">=</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">const</span> FLT_CONTEXT_REGISTRATION ContextRegistration<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token operator\">=</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  <span class=\"token comment\">/// 在释放 context 之前调用，可以在此释放 context 里的内存等</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  FLT_INSTANCE_CONTEXT<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  <span class=\"token number\">0</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  CtxContextCleanup<span class=\"token punctuation\">,</span> <span class=\"token comment\">/// 每种类型的 Context 都共用同一个 CtxContextCleanup</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre> <span class=\"token comment\">///Q：既然有 FltReleaseContext 来释放 Context 了，为什么这里还需要 CtxContextCleanup？</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre> <span class=\"token comment\">///A：是为了针对 Minifilter 的 Context 中保存了一些其他资源或者指向其他内存的情况，可以用 CtxContextCleanup 释放掉，比如 Minifilter 的 Context 中存放了文件的句柄、锁、指针，得先用 CtxContextCleanup 释放掉，才可以用 FltReleaseContext 来释放 Context（类似 C++ 中的 delete，释放内存之前调用析构函数把内存中的其他资源释放掉，再释放要内存）</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  CTX_INSTANCE_CONTEXT_SIZE<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  CTX_INSTANCE_CONTEXT_TAG</pre></td></tr><tr><td data-num=\"12\"></td><td><pre> <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>  FLT_FILE_CONTEXT<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>  <span class=\"token number\">0</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>  CtxContextCleanup<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>  CTX_FILE_CONTEXT_SIZE<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>  CTX_FILE_CONTEXT_TAG</pre></td></tr><tr><td data-num=\"19\"></td><td><pre> <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>  FLT_STREAM_CONTEXT<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>  <span class=\"token number\">0</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>  CtxContextCleanup<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>  CTX_STREAM_CONTEXT_SIZE<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>  CTX_STREAM_CONTEXT_TAG</pre></td></tr><tr><td data-num=\"26\"></td><td><pre> <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>  FLT_STREAMHANDLE_CONTEXT<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>  <span class=\"token number\">0</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>  CtxContextCleanup<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>  CTX_STREAMHANDLE_CONTEXT_SIZE<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>  CTX_STREAMHANDLEICONTEXT_TAG</pre></td></tr><tr><td data-num=\"33\"></td><td><pre> <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>  FLT_CONTEXT_END</pre></td></tr><tr><td data-num=\"36\"></td><td><pre> <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h3 id=\"context-使用例子\"><a class=\"anchor\" href=\"#context-使用例子\">#</a> Context 使用例子</h3>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">/// @Warring 多线环境下记得加锁</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">typedef</span> <span class=\"token keyword\">struct</span> <span class=\"token class-name\">_INSTANCE_CONTEXT</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre> <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span> <span class=\"token comment\">/// 自定义的数据</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">&#125;</span>INSTANCE_CONTEXT，<span class=\"token operator\">*</span>PINSTANCECCONTEXT<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>PINSTANCE_CONTEXT pContext <span class=\"token operator\">=</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token comment\">/// 分配与设置 </span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>ntStatus <span class=\"token operator\">=</span> <span class=\"token function\">FltGetInstanceContext</span><span class=\"token punctuation\">(</span>FltObjects<span class=\"token operator\">-></span>Instance<span class=\"token punctuation\">,</span><span class=\"token operator\">&amp;</span>pContext<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">/// 拿到上下文</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token function\">NT_SUCCESS</span><span class=\"token punctuation\">(</span>ntStatus<span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> FALSE<span class=\"token punctuation\">)</span> <span class=\"token comment\">/// 失败说明还没有为其指定上下文</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre> <span class=\"token comment\">/// 分配上下文，指定上下文的类型</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre> ntStatus <span class=\"token operator\">=</span> <span class=\"token function\">FltAllocateContexti</span><span class=\"token punctuation\">(</span>g_pFilter<span class=\"token punctuation\">,</span> <span class=\"token comment\">///Minifilter 的句柄</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>  FLT_INSTANCE_CONTEXT<span class=\"token punctuation\">,</span> <span class=\"token comment\">///Context 类型</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>  <span class=\"token keyword\">sizeof</span><span class=\"token punctuation\">(</span>INSTANCE_CONTEXT<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">///Context 大小</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>  PagedPool<span class=\"token punctuation\">,</span> <span class=\"token comment\">/// 从 PagedPool 中分配</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>  <span class=\"token operator\">&amp;</span>pContext<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">/// 分配的内存的首地址放在这个指针上</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre> <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token function\">NT_SUCCESS</span><span class=\"token punctuation\">(</span>Status<span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> FALSE<span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>  <span class=\"token keyword\">return</span> ntStatus<span class=\"token punctuation\">;</span> <span class=\"token comment\">/// 如果分配失败，该函数直接 return 了</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre> <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre> <span class=\"token function\">RtZeroMemory</span><span class=\"token punctuation\">(</span>pContext<span class=\"token punctuation\">,</span><span class=\"token keyword\">sizeof</span><span class=\"token punctuation\">(</span>INSTANCE_CONTEXT<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">/// 初始化为 0</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre><span class=\"token comment\">/// 结构体里面定义了设备类型和结构体类型</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>pContext<span class=\"token operator\">-></span>m_DeviceType <span class=\"token operator\">=</span> VolumeDeviceType<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>pContext<span class=\"token operator\">-></span>m_FSType <span class=\"token operator\">=</span> volumeFilesystemType<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre><span class=\"token function\">FltSetInstanceContext</span><span class=\"token punctuation\">(</span>FltQbjects<span class=\"token operator\">-></span>Instance<span class=\"token punctuation\">,</span>FLT_SET_CONTEXT_TREPLACE_IF_EXISTS<span class=\"token punctuation\">,</span>pContext<span class=\"token punctuation\">,</span>NLLL<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">/// 把刚分配的上下文绑定到 instance 上去，引用计数 + 1</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre></pre></td></tr><tr><td data-num=\"30\"></td><td><pre><span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>pContext<span class=\"token punctuation\">)</span> <span class=\"token comment\">// 如果分配成功，需要对引用计数进行减 1，因为实际上没有新的 Context 产生，为保持引用计数的数量，一加就需要一减</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre> <span class=\"token function\">FltReleaseContext</span><span class=\"token punctuation\">(</span>pContext<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">/// 引用计数 - 1</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre></pre></td></tr><tr><td data-num=\"35\"></td><td><pre><span class=\"token comment\">/// 获取访问</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>PINSTANCE_CONTEXT pContext <span class=\"token operator\">=</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>Status <span class=\"token operator\">=</span> FltGetInstanceContext<span class=\"token punctuation\">&#123;</span>EItObjects<span class=\"token operator\">-></span>Instance<span class=\"token punctuation\">,</span><span class=\"token operator\">&amp;</span>pContext<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">/// 引用计数 + 1</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>pContext<span class=\"token operator\">-></span>xxx<span class=\"token operator\">-></span>xxx<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>FltReleaseConte <span class=\"token comment\">// -1</span></pre></td></tr></table></figure><h3 id=\"上下文的应用详解\"><a class=\"anchor\" href=\"#上下文的应用详解\">#</a> 上下文的应用详解</h3>\n<p>在初次接触上下文的时候，不知道在实际场景中需要使用哪种上下文，参阅了其他人的代码后，发现开源的代码中大部分应用场景都使用的流上下文类型。</p>\n<p>甚至也不知道是否需要使用上下文，以及使用上下文能够给自己的程序带来哪些好处。</p>\n<p>不管最终想要通过上下文实现的功能如何，比如不管你是否想要通过判断上下文知道文件是否是特定类型的还是加密的，<strong>在用到上下文的时候多是要解决不想反复判断，想为某个或某类特定文件的文件信息获取一次之后在特定应用场景下就不需要再次获取，从而提升驱动程序效率的办法</strong>。</p>\n<p>鉴于此，上下文主要解决了在程序生命周期中<strong>部分关键信息不想多次获取</strong>或<strong>需要在多个操作中传递信息</strong>的问题。</p>\n<p>前者可以通过多次获取关键信息而不用上下文就可以解决问题，后者有时候不得不使用上下文来传递信息，前者使用上下文的情况，主要应对关键信息获取比较繁琐，使用上下文来减少在不同操作中相同逻辑处理的次数。</p>\n<p>了解了上下文的一些基础场景后，接下来就是看选用哪种类型的上下文了，<strong>最终目标就是创建了上下文能不能在下次操作文件的时候操作上下文，获取上下文的信息，上下文的信息何时销毁</strong>。</p>\n<p>具体实验参见：<span class=\"exturl\" data-url=\"aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2ZpbmRfdGhlX2ZlcnJ5L2FydGljbGUvZGV0YWlscy8xMjEzNjA4MTI=\">https://blog.csdn.net/find_the_ferry/article/details/121360812</span></p>\n<p>作者已经写得很清楚了。我这里就直接写结论了。</p>\n<p><code>FLT_STREAM_CONTEXT</code>   <code>FLT_FILE_CONTEXT</code>  都可以跟随驱动或者文件的生命周期内存在，  <code>StreamHanleContext</code>  只有在文件的打开过程中有效，msdn 上有信息表明 FLT_FILE_CONTEXT 在 vista 之后支持。如果要记录文件的一些特殊信息可以在 <code>FLT_STREAM_CONTEXT</code>  上进行，当然也需要在关注的文件信息发生变动时更新上下文信息。</p>\n<h2 id=\"r0-r3通信新途径\"><a class=\"anchor\" href=\"#r0-r3通信新途径\">#</a> R0-R3 通信新途径</h2>\n<ul>\n<li>\n<p>Minifilter 框架提供了  <code>两套API</code> ，一套是在 R3 中调用的，另一套是在 R0 中调用的</p>\n<ul>\n<li>R3：Filterxxx</li>\n<li>R0：Fltxxx</li>\n</ul>\n</li>\n<li>\n<p>这些 API 不只局限于在 Minifilter 中使用，只要当前建立的工程是基于 Minifilter 框架的驱动，如果在 Minifilter 使用了 HOOK 等其他机制，都可以用这套 API 进行通信。</p>\n</li>\n</ul>\n<h3 id=\"r3主动-r0\"><a class=\"anchor\" href=\"#r3主动-r0\">#</a> R3 (主动)-&gt;R0</h3>\n<ul>\n<li>\n<p>在 NT 驱动中：R3 通过  <code>DeviceIoControl</code>  发数据给 R0,R0 通过  <code>DispatchIoctr</code>  来处理 R3 的下发的数据</p>\n</li>\n<li>\n<p>在 Minifilter 中：R3 是通过  <code>FilterSendMessage</code>  发数据给 R0，R0 通过  <code>fnMessageFromClient</code>  处理从 R3 FilterSendMessage 的请求</p>\n<ul>\n<li>没有控制码了怎么办，自己加个控制码，实际上是简化了控制码，想怎么定义就怎么定义，反而更方便了</li>\n</ul>\n</li>\n<li>\n<p><code>R3主动给R0发数据的情景</code> ：</p>\n<ul>\n<li>下规则</li>\n<li>R3 告诉 R0 监控什么位置</li>\n<li>杀一个进程，删一个文件，枚举隐藏的进程，枚举 hook 的函数</li>\n</ul>\n</li>\n</ul>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">/// R0 创建端口，</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\">/// @note 可以指定安全属性，比如可以指定为只允许管理员连接</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">const</span> PWSTR ScannerPortName <span class=\"token operator\">=</span> L<span class=\"token string\">\"\\\\ScannerPort\"</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token comment\">//    status = FltBuildDefaultSecurityDescriptor (&amp;sd, FLT_PORT_ALL_ACCESS); /// 创建安全描述符，指定为只允许管理员连接</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token function\">FltCreateCommunicationPort</span><span class=\"token punctuation\">(</span>g_pEilter<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre> <span class=\"token operator\">&amp;</span>g_pSeryerPort<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre> <span class=\"token operator\">&amp;</span>oa<span class=\"token punctuation\">,</span> <span class=\"token comment\">/// 设置 PORT 的名字</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre> <span class=\"token comment\">/// 获得 R3 端口 g_pClientPort 等</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre> fnConnectFromCRlient<span class=\"token punctuation\">,</span> <span class=\"token comment\">/// 有客户端连接 R0 端口的时候被调用</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre> <span class=\"token comment\">// 作用 1：这个函数执行的时候处在应用层当前进程的上下文中，可以记录下进程的信息，比如 pid 和 Exprocess 结构，以后发现由这个客户端发下来的请求，就可以把他放行了</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre> <span class=\"token comment\">// 作用 2：拿到 R3 的端口</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre> fnDisconnectFromclient<span class=\"token punctuation\">,</span> <span class=\"token comment\">/// 当客户端断开连接的时候被调用</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre> fnMessageFromClient<span class=\"token punctuation\">,</span> <span class=\"token comment\">/// 处理从 R3 FilterSendMessage 的请求，名字和随便起，只要保证接口一致，注册时一一对应即可</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre></pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token comment\">/// R3 连接 R0，即 R3 拿到 R0 的端口</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>FilterConnectCommunicationPort </pre></td></tr><tr><td data-num=\"19\"></td><td><pre></pre></td></tr><tr><td data-num=\"20\"></td><td><pre><span class=\"token comment\">/// R3 主动发请求给 RO</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre><span class=\"token function\">FilterSendMessage</span><span class=\"token punctuation\">(</span>Port<span class=\"token punctuation\">,</span> <span class=\"token comment\">/// 拿到的 R0 端口</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>      <span class=\"token operator\">&amp;</span>request<span class=\"token punctuation\">,</span> <span class=\"token comment\">///R3 给 R0 发数据的缓存，自定义控制码放在这里</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>      <span class=\"token keyword\">sizeof</span><span class=\"token punctuation\">(</span>REQUEST<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// 缓存的大小</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>      <span class=\"token operator\">&amp;</span>reply<span class=\"token punctuation\">,</span> <span class=\"token comment\">///R0 处理完数据返回给 R3 的结果</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>      <span class=\"token keyword\">sizeof</span><span class=\"token punctuation\">(</span>REPLY<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>      <span class=\"token operator\">&amp;</span>dwRtn<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">/// 实际上传输的字节数，对应 IRP 中的 IOSTATUS.Information</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre></pre></td></tr><tr><td data-num=\"28\"></td><td><pre><span class=\"token comment\">/// R0 处理从 R3 FilterSendMessage 的请求</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>NTSTATUS <span class=\"token function\">fnMessageFromClient</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre> IN PVOID PortCookie<span class=\"token punctuation\">,</span> <span class=\"token comment\">///Port 相关的私有数据</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre> IN PVOID InputBuffer OPTIONAL<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre> IN ULONG InputBufferLength<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre> OUT PVOLD OutputBuffer OPTIONAL<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre> IN PULONG OutputBufferLength<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre> OUT PULONG ReturnOutputEufferLength <span class=\"token comment\">/// 实际传输的长度</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre> <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre> <span class=\"token comment\">/// 这里通信方式使用的是 neither io 需要 ProbeForRead 和 ProbeForWite</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre> <span class=\"token comment\">/// 1. 保证内存对齐，2. 保证地址合法 (保证时用户态的地址，应用层程序没有权限访问内核态的地址)，避免提权</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre> __try</pre></td></tr><tr><td data-num=\"41\"></td><td><pre> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>  <span class=\"token function\">ProbeForRead</span><span class=\"token punctuation\">(</span>InputBuffer<span class=\"token punctuation\">,</span>InputBufferLength<span class=\"token punctuation\">,</span><span class=\"token keyword\">sizeof</span><span class=\"token punctuation\">(</span>ULONG<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>  <span class=\"token comment\">//GET InputBuffer</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>  <span class=\"token comment\">//Do something:</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>  <span class=\"token function\">ProbeForWite</span><span class=\"token punctuation\">(</span>OutputBuffer<span class=\"token punctuation\">,</span>OutputBufferLength<span class=\"token punctuation\">,</span><span class=\"token keyword\">sizeof</span><span class=\"token punctuation\">(</span>ULONG<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>  <span class=\"token comment\">//Copy Result to Outputbuffer</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre> <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre> <span class=\"token function\">__except</span><span class=\"token punctuation\">(</span>EXCEPTION_EXECUTE_HANDLER<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>  <span class=\"token keyword\">return</span> STATUS_NOT_IMPLEMENTED<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre> <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre> </pre></td></tr><tr><td data-num=\"53\"></td><td><pre> <span class=\"token keyword\">return</span> STATUS_SUCCESS<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h3 id=\"r0主动-r3-r0弹窗模型\"><a class=\"anchor\" href=\"#r0主动-r3-r0弹窗模型\">#</a> R0 (主动)-&gt;R3-R0 (弹窗模型)</h3>\n<ul>\n<li>R0 监控到数据，R0 通过  <code>FltSendMessage</code>  发数据给 R3 (FltSendMessage 可以设置  <code>超时等待</code> ，比如内核层等待弹窗返回结果 40s 或者无限等待)，R3 开启多个线程 (每个线程都可用来接受 R0 发送的数据)，通过  <code>FilterGetMessage</code>  来处理从 R0 的请求 ( <code>异步读</code> ，不管拿没拿到数据都会返回), 拿到数据处理完之后通过  <code>FilterReplyMessage</code>  返回给 R0</li>\n<li>R0-&gt;R3</li>\n</ul>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">/// 发送消息给 R3</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>timeout<span class=\"token punctuation\">.</span>QuadPart <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>LONGLONG<span class=\"token punctuation\">)</span><span class=\"token number\">40</span><span class=\"token operator\">*</span> <span class=\"token operator\">-</span><span class=\"token number\">10000000</span>i64<span class=\"token punctuation\">;</span> <span class=\"token comment\">///40 seconds，设为 0 不等待，设置为 null 无限等待</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>Status <span class=\"token operator\">=</span> <span class=\"token function\">FltSendMessage</span><span class=\"token punctuation\">(</span>g_pFilter<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>      <span class=\"token operator\">&amp;</span>g_pClientPort<span class=\"token punctuation\">,</span> <span class=\"token comment\">/// 客户端的端口</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>      <span class=\"token operator\">&amp;</span>request<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>      <span class=\"token keyword\">sizeof</span><span class=\"token punctuation\">(</span>SCANNER_NOTIFICATION<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>      <span class=\"token operator\">&amp;</span>reply<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>      replySize<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>      <span class=\"token operator\">&amp;</span>timeout<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token comment\">/// 关闭端口</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token function\">FItCloseCommunicationPort</span><span class=\"token punctuation\">(</span>g_pServerPort<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><ul>\n<li>R3-&gt;R0</li>\n</ul>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">/// 响应 R0 的：FltSendMessage ()</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\">/// 一般放在后台的工作者线程中去执行，而且可以创建多线程，在多个线程中去处理这个部分代码，提高处理的效率</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token function\">FilterConnectCommunicationPort</span><span class=\"token punctuation\">(</span>ScannerPortName<span class=\"token punctuation\">,</span> <span class=\"token comment\">/// 与 R0 端口名字一致</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>          <span class=\"token number\">0</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>          <span class=\"token constant\">NULL</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>          <span class=\"token number\">0</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>          <span class=\"token constant\">NULL</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>          <span class=\"token operator\">&amp;</span>Port<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">///RO 端口</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token comment\">/// 处理从 R0 来的请求，即 R0 调用 FltSendMessage 的请求</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>completion <span class=\"token operator\">=</span> <span class=\"token function\">CreateloCompletionPort</span><span class=\"token punctuation\">(</span>port<span class=\"token punctuation\">,</span><span class=\"token constant\">NULL</span><span class=\"token punctuation\">,</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">/// 创建一个完成端口</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token function\">FilterGetMessage</span><span class=\"token punctuation\">(</span>Port<span class=\"token punctuation\">,</span> <span class=\"token comment\">/// 异步读，拿没拿到数据都不等待，直接返回</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>     <span class=\"token operator\">&amp;</span>message<span class=\"token operator\">-></span>MessagelHleader<span class=\"token punctuation\">,</span> <span class=\"token comment\">/// 数据放在这里</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>     <span class=\"token function\">FIELD_OFFSET</span><span class=\"token punctuation\">(</span>SANDBOX_MESSAGE<span class=\"token punctuation\">,</span>Ovlp<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>     <span class=\"token operator\">&amp;</span>message<span class=\"token operator\">-></span>Ovlp<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token keyword\">while</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>   <span class=\"token function\">GetQueuedCompletionStatus</span><span class=\"token punctuation\">(</span>completion<span class=\"token punctuation\">,</span><span class=\"token operator\">&amp;</span>outSize<span class=\"token punctuation\">,</span><span class=\"token operator\">&amp;</span>key<span class=\"token punctuation\">,</span><span class=\"token operator\">&amp;</span>pOvlp<span class=\"token punctuation\">,</span>INFINITE<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">/// 在完成端口这里阻塞，一旦 R0 调用 FltSendMessage ()，completion 完成端口有了数据之后，这个函数就会返回</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre> <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span> <span class=\"token comment\">/// 处理数据</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre> </pre></td></tr><tr><td data-num=\"21\"></td><td><pre> <span class=\"token comment\">/// R3 处理结果返回给内核层</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre> <span class=\"token function\">FilterReplyMessage</span><span class=\"token punctuation\">(</span>Port<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>        <span class=\"token punctuation\">(</span>PEILTER_REPLY_HEADER<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>        <span class=\"token operator\">&amp;</span>replyMessage<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>        <span class=\"token keyword\">sizeof</span><span class=\"token punctuation\">(</span>replyMessage<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre> <span class=\"token comment\">/// 异步读，继续下一个循环</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre> <span class=\"token function\">FilterGetMessaget</span><span class=\"token punctuation\">(</span>Port<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>       <span class=\"token operator\">&amp;</span>message<span class=\"token operator\">-></span>MessageHeader<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>       FIELD_OFFSET_SANDBOXMESSAGE<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>       Ovlp<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>       <span class=\"token operator\">&amp;</span>message<span class=\"token operator\">-></span>Ovlp<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h2 id=\"深入分析scanner\"><a class=\"anchor\" href=\"#深入分析scanner\">#</a> 深入分析 Scanner</h2>\n<h3 id=\"编译运行\"><a class=\"anchor\" href=\"#编译运行\">#</a> 编译运行</h3>\n<h3 id=\"代码分析\"><a class=\"anchor\" href=\"#代码分析\">#</a> 代码分析</h3>\n<h4 id=\"驱动层\"><a class=\"anchor\" href=\"#驱动层\">#</a> 驱动层</h4>\n<h4 id=\"应用层\"><a class=\"anchor\" href=\"#应用层\">#</a> 应用层</h4>\n<h2 id=\"基于minifilter的sandbox\"><a class=\"anchor\" href=\"#基于minifilter的sandbox\">#</a> 基于 Minifilter 的 SandBox</h2>\n<h3 id=\"重定向reparse\"><a class=\"anchor\" href=\"#重定向reparse\">#</a> 重定向 reparse</h3>\n<h3 id=\"createfile重定向\"><a class=\"anchor\" href=\"#createfile重定向\">#</a> CreateFile 重定向</h3>\n<h3 id=\"deletefile\"><a class=\"anchor\" href=\"#deletefile\">#</a> DeleteFile</h3>\n<h3 id=\"queryfile重定向\"><a class=\"anchor\" href=\"#queryfile重定向\">#</a> QueryFile 重定向</h3>\n<h3 id=\"如何判断自己被沙盒\"><a class=\"anchor\" href=\"#如何判断自己被沙盒\">#</a> 如何判断自己被沙盒</h3>\n<h1 id=\"注册表回调框架\"><a class=\"anchor\" href=\"#注册表回调框架\">#</a> 注册表回调框架</h1>\n",
            "tags": [
                "Minifilter",
                "Sfilter"
            ]
        },
        {
            "id": "https://or0kit.github.io/Bin/Core/Drive-Development/%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E5%BE%AE%E8%BF%87%E6%BB%A4%E9%A9%B1%E5%8A%A8/",
            "url": "https://or0kit.github.io/Bin/Core/Drive-Development/%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E5%BE%AE%E8%BF%87%E6%BB%A4%E9%A9%B1%E5%8A%A8/",
            "title": "文件系统微过滤驱动",
            "date_published": "2022-08-06T15:24:13.000Z",
            "content_html": "<h1 id=\"文件系统微过滤驱动\"><a class=\"anchor\" href=\"#文件系统微过滤驱动\">#</a> 文件系统微过滤驱动</h1>\n<p>微软的 Windows 内核开发者开发了一个新的驱动， 称为过滤管理器（Filter Manager 或 fltmgr）</p>\n<h1 id=\"minifilter的编程框架\"><a class=\"anchor\" href=\"#minifilter的编程框架\">#</a> Minifilter 的编程框架</h1>\n<p>开始学习一个有关 Minifilter 应用的例子， 这个例子的作用主要是开发  <code>Minifilter</code>  的功能来限制对应用程序 “记事本” 文件（notepad.xe） 的操作， 进而达到限制扩展名为  <code>txt</code>  等使用记事本程序来编辑的功能。</p>\n<p>这是一个有意思的例子，因为文件名为  <code>notepad.exe</code>  的文件被禁止打开， 所以这个文件无法被双击执行、 无法被复制、 无法被改名， 也无法被删除。这个例子在实际中可能没有什么用处。 这样不可能限制文本文档不被编辑， 因为记事本不能使用， 用户依然可以使用其他的文本编辑工具， 甚至可以在别的计算机上为  <code>notepad.exe</code>  改一个名字， 然后拷贝到本机上来使用。 但是它足以说明  <code>Minifilter</code>  的简单使用效果。</p>\n<h2 id=\"微文件系统过滤的注册\"><a class=\"anchor\" href=\"#微文件系统过滤的注册\">#</a> 微文件系统过滤的注册</h2>\n<p>编写  <code>Minifilter</code>  的第一件事是向过滤管理器宣告我们的微过滤器的存在。<br />\n这里所谓的微过滤器是符合过滤管理器标准的过滤组件， 它其实是一组回调函数， 这组回调函数向过滤管理器注册之后， 过滤管理器就会在合适的时机（比如， 要求的文件操作发生时） 以合适的方式调用某个回调函数。如果我们编写这个回调函数中的内容， 就可以对文件系统加以过滤了。</p>\n<p>这比花很多精力去绑定各种设备要简单得多， 因为复杂的任务都在过滤管理器里做了。</p>\n<p>下面直接通过程序代码来了解一下程序的架构。<br />\n一开始我们必须要宣告注册的函数，这个宣告要符合  <code>Minifilter</code>  开发文件内的定义， 我们可以从 WDK 或文件内找到这个函数的意思。</p>\n<p>接下来按照惯例， 我们介绍一下  <code>DriverEntry</code>  入口函数。 和  <code>sfilter</code>  形成鲜明的对比， 这个例子的  <code>DriverEntry</code>  显得非常简单。 关键的函数有两个： 一个是  <code>FltReigsterFilter</code>  ， 用来注册一个微过滤器； 另一个是  <code>FltStartFiltering</code>  ， 用来开启过滤。</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>NTSTATUS</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token function\">DriverEntry</span> <span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    _In_ PDRIVER_OBJECT DriverObject<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    _In_ PUNICODE_STRING RegistryPath</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    NTSTATUS status<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token function\">UNREFERENCED_PARAMETER</span><span class=\"token punctuation\">(</span> RegistryPath <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    <span class=\"token comment\">// 向过滤管理器注册一个过滤器。这个过滤器使用 FilterRegistration 表示的</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    status <span class=\"token operator\">=</span> <span class=\"token function\">FltRegisterFilter</span><span class=\"token punctuation\">(</span> DriverObject<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>                                <span class=\"token operator\">&amp;</span>FilterRegistration<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>                                <span class=\"token operator\">&amp;</span>gFilterHandle <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    <span class=\"token function\">ASSERT</span><span class=\"token punctuation\">(</span> <span class=\"token function\">NT_SUCCESS</span><span class=\"token punctuation\">(</span> status <span class=\"token punctuation\">)</span> <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>   <span class=\"token comment\">// VS2019 中用的是 FLT_ASSERT</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">NT_SUCCESS</span><span class=\"token punctuation\">(</span> status <span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>        <span class=\"token comment\">// 开启过滤行为</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>        status <span class=\"token operator\">=</span> <span class=\"token function\">FltStartFiltering</span><span class=\"token punctuation\">(</span> gFilterHandle <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token function\">NT_SUCCESS</span><span class=\"token punctuation\">(</span> status <span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>            <span class=\"token comment\">// 如果不能正常开启，那么这个注册没有意义，取消注册并以失败退出</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>            <span class=\"token function\">FltUnregisterFilter</span><span class=\"token punctuation\">(</span> gFilterHandle <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>    <span class=\"token keyword\">return</span> status<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h3 id=\"fltregisterfilter-fltstartfiltering和fltregisterfilter\"><a class=\"anchor\" href=\"#fltregisterfilter-fltstartfiltering和fltregisterfilter\">#</a> FltRegisterFilter、FltStartFiltering 和 FltRegisterFilter</h3>\n<p>其中，  <code>FltRegisterFilter</code>  是一个非常重要的内核 API， 是微过滤器生命的开始。 这个函数的原型如下：</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">NTAPI</span> <span class=\"token expression\">__stdcall</span></span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">FLTAPI</span> <span class=\"token expression\">NTAPI</span></span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>NTSTATUS</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>FLTAPI</pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token function\">FltRegisterFilter</span> <span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    _In_ PDRIVER_OBJECT Driver<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    _In_ CONST FLT_REGISTRATION <span class=\"token operator\">*</span>Registration<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    _Outptr_ PFLT_FILTER <span class=\"token operator\">*</span>RetFilter</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>第 1 个参数是本驱动的驱动对象， 是在入口函数  <code>DriverEntry</code>  中作为参数传入的。<br />\n第 2 个参数就是一个宣告注册信息的结构， 这个结构内含描述这个过滤器的所有信息， 在本节中， 称为微过滤器注册结构。<br />\n第 3 个参数（RetFilter） 是一个返回参数， 返回注册成功的微过滤器句柄。 微过滤器句柄非常常用， 一般都保存在全局变量中以备后用， 在下面调用函数  <code>FltStartFiltering</code>  时就需要以这个句柄作为参数。</p>\n<p>显而易见， 调用  <code>FltRegisterFilter</code>  本身并不复杂， 问题在于要填写一个合法的  <code>FLT_REGISTRATION</code>  结构。 这个结构将在下面介绍。</p>\n<p>另一个函数是  <code>FltStartFiltering</code>  ， 在调用这个函数之前， 过滤是不起作用的。 这个函数的作用是开启。 它的原型如下：</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>NTSTATUS</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>FLTAPI</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token function\">FltStartFiltering</span> <span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    _In_ PFLT_FILTER Filter</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>此函数非常简单， 只有一个参数， 就是调用  <code>FltRegisterFilter</code>  时返回的微过滤器句柄。<br />\n一般情况下， 这个函数的调用会成功； 如果失败， 除了放弃过滤， 几乎别无选择。</p>\n<h2 id=\"微过滤器的数据结构\"><a class=\"anchor\" href=\"#微过滤器的数据结构\">#</a> 微过滤器的数据结构</h2>\n<p>注册微过滤器时， 我们填写了一个名为微过滤器注册结构（ <code>FLT_REGISTRATION</code> ）的数据结构。<br />\n定义如下：</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">typedef</span> <span class=\"token keyword\">struct</span> <span class=\"token class-name\">_FLT_REGISTRATION</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token comment\">// 结构的大小和结构的版本</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    USHORT Size<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    USHORT Version<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token comment\">// 微过滤器的标志位</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    FLT_REGISTRATION_FLAGS Flags<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    <span class=\"token comment\">//  Variable length array of routines that are used to manage contexts in the system.</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    <span class=\"token comment\">//  </span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    <span class=\"token comment\">// </span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    CONST FLT_CONTEXT_REGISTRATION <span class=\"token operator\">*</span>ContextRegistration<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>    <span class=\"token comment\">//  Variable length array of routines used for processing pre- and post-</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    <span class=\"token comment\">//  file system operations.</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>    <span class=\"token comment\">// 操作回调函数。这是重点中的重点。</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>    CONST FLT_OPERATION_REGISTRATION <span class=\"token operator\">*</span>OperationRegistration<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>    <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>    <span class=\"token comment\">//  This is called before a filter is unloaded.  If an ERROR or WARNING</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>    <span class=\"token comment\">//  status is returned then the filter is NOT unloaded.  A mandatory unload</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>    <span class=\"token comment\">//  can not be failed.</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>    <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>    <span class=\"token comment\">//  If a NULL is specified for this routine, then the filter can never be</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>    <span class=\"token comment\">//  unloaded.</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>    <span class=\"token comment\">// 卸载回调函数</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>    PFLT_FILTER_UNLOAD_CALLBACK FilterUnloadCallback<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>    <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>    <span class=\"token comment\">//  This is called to see if a filter would like to attach an instance</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>    <span class=\"token comment\">//  to the given volume.  If an ERROR or WARNING status is returned, an</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>    <span class=\"token comment\">//  attachment is not made.</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>    <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>    <span class=\"token comment\">//  If a NULL is specified for this routine, the attachment is always made.</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>    <span class=\"token comment\">// 实例安装回调</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>    PFLT_INSTANCE_SETUP_CALLBACK InstanceSetupCallback<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>    <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>    <span class=\"token comment\">//  This is called to see if the filter wants to detach from the given</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>    <span class=\"token comment\">//  volume.  This is only called for manual detach requests.  If an</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>    <span class=\"token comment\">//  ERROR or WARNING status is returned, the filter is not detached.</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>    <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>    <span class=\"token comment\">//  If a NULL is specified for this routine, then instances can never be</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>    <span class=\"token comment\">//  manually detached.</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre>    <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre></pre></td></tr><tr><td data-num=\"54\"></td><td><pre>    PFLT_INSTANCE_QUERY_TEARDOWN_CALLBACK InstanceQueryTeardownCallback<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>    <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre>    <span class=\"token comment\">//  This is called at the start of a filter detaching from a volume.</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre>    <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"59\"></td><td><pre>    <span class=\"token comment\">//  It is OK for this field to be NULL.</span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre>    <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"61\"></td><td><pre></pre></td></tr><tr><td data-num=\"62\"></td><td><pre>    PFLT_INSTANCE_TEARDOWN_CALLBACK InstanceTeardownStartCallback<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"63\"></td><td><pre></pre></td></tr><tr><td data-num=\"64\"></td><td><pre>    <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"65\"></td><td><pre>    <span class=\"token comment\">//  This is called at the end of a filter detaching from a volume.  All</span></pre></td></tr><tr><td data-num=\"66\"></td><td><pre>    <span class=\"token comment\">//  outstanding operations have been completed by the time this routine</span></pre></td></tr><tr><td data-num=\"67\"></td><td><pre>    <span class=\"token comment\">//  is called.</span></pre></td></tr><tr><td data-num=\"68\"></td><td><pre>    <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"69\"></td><td><pre>    <span class=\"token comment\">//  It is OK for this field to be NULL.</span></pre></td></tr><tr><td data-num=\"70\"></td><td><pre>    <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"71\"></td><td><pre></pre></td></tr><tr><td data-num=\"72\"></td><td><pre>    PFLT_INSTANCE_TEARDOWN_CALLBACK InstanceTeardownCompleteCallback<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"73\"></td><td><pre></pre></td></tr><tr><td data-num=\"74\"></td><td><pre>    <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"75\"></td><td><pre>    <span class=\"token comment\">//  The following callbacks are provided by a filter only if it is</span></pre></td></tr><tr><td data-num=\"76\"></td><td><pre>    <span class=\"token comment\">//  interested in modifying the name space.</span></pre></td></tr><tr><td data-num=\"77\"></td><td><pre>    <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"78\"></td><td><pre>    <span class=\"token comment\">//  If NULL is specified for these callbacks, it is assumed that the</span></pre></td></tr><tr><td data-num=\"79\"></td><td><pre>    <span class=\"token comment\">//  filter would not affect the name being requested.</span></pre></td></tr><tr><td data-num=\"80\"></td><td><pre>    <span class=\"token comment\">//  生成文件名回调</span></pre></td></tr><tr><td data-num=\"81\"></td><td><pre></pre></td></tr><tr><td data-num=\"82\"></td><td><pre>    PFLT_GENERATE_FILE_NAME GenerateFileNameCallback<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"83\"></td><td><pre>    <span class=\"token comment\">// 格式化名字组件</span></pre></td></tr><tr><td data-num=\"84\"></td><td><pre>    PFLT_NORMALIZE_NAME_COMPONENT NormalizeNameComponentCallback<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"85\"></td><td><pre>    <span class=\"token comment\">// 格式化上下文清理回调</span></pre></td></tr><tr><td data-num=\"86\"></td><td><pre>    PFLT_NORMALIZE_CONTEXT_CLEANUP NormalizeContextCleanupCallback<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"87\"></td><td><pre></pre></td></tr><tr><td data-num=\"88\"></td><td><pre>    <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"89\"></td><td><pre>    <span class=\"token comment\">//  The PFLT_NORMALIZE_NAME_COMPONENT_EX callback is also a name</span></pre></td></tr><tr><td data-num=\"90\"></td><td><pre>    <span class=\"token comment\">//  provider callback. It is not included here along with the</span></pre></td></tr><tr><td data-num=\"91\"></td><td><pre>    <span class=\"token comment\">//  other name provider callbacks to take care of the registration</span></pre></td></tr><tr><td data-num=\"92\"></td><td><pre>    <span class=\"token comment\">//  structure versioning issues.</span></pre></td></tr><tr><td data-num=\"93\"></td><td><pre>    <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"94\"></td><td><pre></pre></td></tr><tr><td data-num=\"95\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">if</span> <span class=\"token expression\">FLT_MGR_LONGHORN</span></span></pre></td></tr><tr><td data-num=\"96\"></td><td><pre></pre></td></tr><tr><td data-num=\"97\"></td><td><pre>    <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"98\"></td><td><pre>    <span class=\"token comment\">//  This is called for transaction notifications received from the KTM</span></pre></td></tr><tr><td data-num=\"99\"></td><td><pre>    <span class=\"token comment\">//  when a filter has enlisted on that transaction.</span></pre></td></tr><tr><td data-num=\"100\"></td><td><pre>    <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"101\"></td><td><pre></pre></td></tr><tr><td data-num=\"102\"></td><td><pre>    PFLT_TRANSACTION_NOTIFICATION_CALLBACK TransactionNotificationCallback<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"103\"></td><td><pre></pre></td></tr><tr><td data-num=\"104\"></td><td><pre>    <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"105\"></td><td><pre>    <span class=\"token comment\">//  This is the extended normalize name component callback</span></pre></td></tr><tr><td data-num=\"106\"></td><td><pre>    <span class=\"token comment\">//  If a mini-filter provides this callback, then  this callback</span></pre></td></tr><tr><td data-num=\"107\"></td><td><pre>    <span class=\"token comment\">//  will be used as opposed to using PFLT_NORMALIZE_NAME_COMPONENT</span></pre></td></tr><tr><td data-num=\"108\"></td><td><pre>    <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"109\"></td><td><pre>    <span class=\"token comment\">//  The PFLT_NORMALIZE_NAME_COMPONENT_EX provides an extra parameter</span></pre></td></tr><tr><td data-num=\"110\"></td><td><pre>    <span class=\"token comment\">//  (PFILE_OBJECT) in addition to the parameters provided to</span></pre></td></tr><tr><td data-num=\"111\"></td><td><pre>    <span class=\"token comment\">//  PFLT_NORMALIZE_NAME_COMPONENT. A mini-filter may use this parameter</span></pre></td></tr><tr><td data-num=\"112\"></td><td><pre>    <span class=\"token comment\">//  to get to additional information like the TXN_PARAMETER_BLOCK.</span></pre></td></tr><tr><td data-num=\"113\"></td><td><pre>    <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"114\"></td><td><pre>    <span class=\"token comment\">//  A mini-filter that has no use for the additional parameter may</span></pre></td></tr><tr><td data-num=\"115\"></td><td><pre>    <span class=\"token comment\">//  only provide a PFLT_NORMALIZE_NAME_COMPONENT callback.</span></pre></td></tr><tr><td data-num=\"116\"></td><td><pre>    <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"117\"></td><td><pre>    <span class=\"token comment\">//  A mini-filter may provide both a PFLT_NORMALIZE_NAME_COMPONENT</span></pre></td></tr><tr><td data-num=\"118\"></td><td><pre>    <span class=\"token comment\">//  callback and a PFLT_NORMALIZE_NAME_COMPONENT_EX callback. The</span></pre></td></tr><tr><td data-num=\"119\"></td><td><pre>    <span class=\"token comment\">//  PFLT_NORMALIZE_NAME_COMPONENT_EX callback will be used by fltmgr</span></pre></td></tr><tr><td data-num=\"120\"></td><td><pre>    <span class=\"token comment\">//  versions that understand this callback (Vista RTM and beyond)</span></pre></td></tr><tr><td data-num=\"121\"></td><td><pre>    <span class=\"token comment\">//  and PFLT_NORMALIZE_NAME_COMPONENT callback will be used by fltmgr</span></pre></td></tr><tr><td data-num=\"122\"></td><td><pre>    <span class=\"token comment\">//  versions that do not understand the PFLT_NORMALIZE_NAME_COMPONENT_EX</span></pre></td></tr><tr><td data-num=\"123\"></td><td><pre>    <span class=\"token comment\">//  callback (prior to Vista RTM). This allows the same mini-filter</span></pre></td></tr><tr><td data-num=\"124\"></td><td><pre>    <span class=\"token comment\">//  binary to run with all versions of fltmgr.</span></pre></td></tr><tr><td data-num=\"125\"></td><td><pre>    <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"126\"></td><td><pre></pre></td></tr><tr><td data-num=\"127\"></td><td><pre>    PFLT_NORMALIZE_NAME_COMPONENT_EX NormalizeNameComponentExCallback<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"128\"></td><td><pre></pre></td></tr><tr><td data-num=\"129\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">endif</span> <span class=\"token comment\">// FLT_MGR_LONGHORN</span></span></pre></td></tr><tr><td data-num=\"130\"></td><td><pre></pre></td></tr><tr><td data-num=\"131\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">if</span> <span class=\"token expression\">FLT_MGR_WIN8</span></span></pre></td></tr><tr><td data-num=\"132\"></td><td><pre></pre></td></tr><tr><td data-num=\"133\"></td><td><pre>    <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"134\"></td><td><pre>    <span class=\"token comment\">//  This is called for IO failures due to the existence of sections</span></pre></td></tr><tr><td data-num=\"135\"></td><td><pre>    <span class=\"token comment\">//  when those sections are created through FltCreateSectionForDatascan.</span></pre></td></tr><tr><td data-num=\"136\"></td><td><pre>    <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"137\"></td><td><pre></pre></td></tr><tr><td data-num=\"138\"></td><td><pre>    PFLT_SECTION_CONFLICT_NOTIFICATION_CALLBACK SectionNotificationCallback<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"139\"></td><td><pre></pre></td></tr><tr><td data-num=\"140\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">endif</span> <span class=\"token comment\">// FLT_MGR_WIN8</span></span></pre></td></tr><tr><td data-num=\"141\"></td><td><pre></pre></td></tr><tr><td data-num=\"142\"></td><td><pre><span class=\"token punctuation\">&#125;</span> FLT_REGISTRATION<span class=\"token punctuation\">,</span> <span class=\"token operator\">*</span>PFLT_REGISTRATION<span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>上面的结构来自 VS2019 中的定义，中文是书中的介绍。</p>\n<p>第 1 个域 Size 表示  <code>FLT_REGISTRATION</code>  结构的大小， 当然大小就是  <code>sizeof(FLT_REGISTRATION)</code> 。 微软习惯在 Windows 内核的数据结构前面加上大小， 易于排错。</p>\n<p>第 2 个域 Version 是  <code>FLT_REGISTRATION</code>  结构的版本号。 对于这个域， 读者不需要多加考虑， 直接按照惯例填写  <code>FLT_REGISTRATION_VERSION</code>  即可。</p>\n<p>第 3 个域 Flags 是标志位， 标记是否要收到这类的操作。 但是有趣的是， 这个域只有两种设置法： 一种设置为 NULL， 不起任何作用； 另一种则设置为  <code>FLTFL_REGISTRATION_DO_NOT_ SUPPORT_SERVICE_STOP</code>  ， 代表当停止服务时  <code>Minifilter</code>  不会响应且不会调用到  <code>FilterUnloadCallback</code>  ， 即使  <code>FilterUnloadCallback</code>  并不是 NULL。</p>\n<p>第 4 个域  <code>Context Registration</code>  是上下文注册， 注册处理上下文的函数。</p>\n<p>第 5 个域  <code>Operation Registration</code>  是操作回调函数集注册。 这是最重要的一个域， 我们将要过滤的文件操作回调函数写在其中， 可以定义所有功能代码对应的回调函数。</p>\n<p>举例如下：</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>CONST FLT_OPERATION_REGISTRATION Callbacks<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span> IRP_MJ_CREATE<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>      <span class=\"token number\">0</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>      XxxPreCreate<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>      XxxPostCreate <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span> IRP_MJ_CLEANUP<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>      <span class=\"token number\">0</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>      XxxPreCleanup<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>      <span class=\"token constant\">NULL</span> <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span> IRP_MJ_WRITE<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>      <span class=\"token number\">0</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>      XxxPreWrite<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>      XxxPostWrite <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    <span class=\"token comment\">// 填写要过滤的定义集合</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span> IRP_MJ_OPERATION_END <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>这是  <code>FLT_OPERATION_REGISTRATION</code>  这个结构， 后面会做更详细的学习。</p>\n<p>第 6 个域 FilterUnloadCallback 是驱动卸载回调函数。 在驱动被停止时， 函数被调用，<br />\n代表要释放程序内的资源以结束过滤行为。 这个域可以设置为 NULL。</p>\n<p>第 7 个域 InstanceSetupCallback 是实例安装回调函数， 当一个卷实例要加载时会通过此<br />\n回调函数处理。 这个域可以设置为 NULL。</p>\n<p>第 8 个域 InstanceQueryTeardownCallback 是控制实例销毁函数， 这个回调函数只会在一<br />\n个手工解除绑定的请求时被调用。 这个域可以设置为 NULL。</p>\n<p>第 9 个域 InstanceTeardownStartCallback 是实例解绑定函数， 当调用时代表已经决定解<br />\n除绑定。 这个域可以设置为 NULL。</p>\n<p>第 10 个域 InstanceTeardownCompleteCallback 是实例解绑定完成函数， 当确定时调用解<br />\n除绑定后的完成函数。 这个域可以设置为 NULL。</p>\n<p>还有一些域因为使用不多， 所以本书将其略去， 有兴趣的读者可以自己参考相关文档。 笔者习惯将它们设置为 NULL。</p>\n<p>下面是一个设置的例子。</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>CONST FLT_REGISTRATION FilterRegistration <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token keyword\">sizeof</span><span class=\"token punctuation\">(</span> FLT_REGISTRATION <span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>         <span class=\"token comment\">//  Size</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    FLT_REGISTRATION_VERSION<span class=\"token punctuation\">,</span>           <span class=\"token comment\">//  Version</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token number\">0</span><span class=\"token punctuation\">,</span>                                  <span class=\"token comment\">//  Flags</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token constant\">NULL</span><span class=\"token punctuation\">,</span>                               <span class=\"token comment\">//  Context</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    Callbacks<span class=\"token punctuation\">,</span>                          <span class=\"token comment\">//  Operation callbacks</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    PtUnload<span class=\"token punctuation\">,</span>                           <span class=\"token comment\">//  MiniFilterUnload</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    PtInstanceSetup<span class=\"token punctuation\">,</span>                    <span class=\"token comment\">//  InstanceSetup</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    PtInstanceQueryTeardown<span class=\"token punctuation\">,</span>            <span class=\"token comment\">//  InstanceQueryTeardown</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    PtInstanceTeardownStart<span class=\"token punctuation\">,</span>            <span class=\"token comment\">//  InstanceTeardownStart</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    PtInstanceTeardownComplete<span class=\"token punctuation\">,</span>         <span class=\"token comment\">//  InstanceTeardownComplete</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    <span class=\"token constant\">NULL</span><span class=\"token punctuation\">,</span>                               <span class=\"token comment\">//  GenerateFileName</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>    <span class=\"token constant\">NULL</span><span class=\"token punctuation\">,</span>                               <span class=\"token comment\">//  GenerateDestinationFileName</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    <span class=\"token constant\">NULL</span>                                <span class=\"token comment\">//  NormalizeNameComponent</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre></pre></td></tr><tr><td data-num=\"21\"></td><td><pre><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>其中， 最重要的就是  <code>CallBacks</code> 。这是一个回调函数数组， 在其中可以处理所有的请求。</p>\n<p>但是处理方式和以前做请求过滤时有所不同， 以前处理的是 IRP， 其实有两种处理：<strong>一种是在请求完成之前就进行处理</strong>； <strong>另一种是用事件等待请求完成之后， 或者在完成函数中进行处理</strong>。</p>\n<p>前一种适合要拦截请求本身的情况， 后一种适合要拦截请求之后返回的结果的情况。<br />\n在 Minifilter 中， 这两种过滤被分在两个回调函数中， 一个称为预操作回调函数（Pre-Operation Function） ， 另一个称为后操作回调函数（Post-Operation Function） 。</p>\n<p>下面是一个例子。仅供参考。</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>CONST FLT_OPERATION_REGISTRATION Callbacks<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span> IRP_MJ_CREATE<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>      <span class=\"token number\">0</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>      XxxPreCreate<span class=\"token punctuation\">,</span> <span class=\"token comment\">// 生成预操作回调函数</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>      XxxPostCreate <span class=\"token comment\">// 生成后操作回调函数</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span> IRP_MJ_WRITE<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>      FLTFL_OPERATION_REGISTRATION_SKIP_CACHED_IO<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>      XxxPreWrite<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>      XxxPostWrite </pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p><code>Callbacks</code>  数组内存储数据结构为  <code>FLT_OPERATION_REGISTRATION</code>  的数组， 用意是把需要做过滤的请求一个个声明出来， 每个都包括了预操作回调函数与后操作回调函数，宣告过后通过注册就能使 IRP 包顺利地通过这边指定的函数来做处理了。 当有多个微过滤器时， IRP 会通过每一个微过滤器的预操作回调函数与后操作回调函数， 除非 IRP 传递到中途被直接返回而不再继续传递下去。</p>\n<p>读者可以看到， 这个数组的每个元素由四部分组成。 第 1 个域是请求的主功能号， 这是我们熟知的。 第 2 个域是一个标志位， 有三种写法： 第 1 种是写 0， 这个标志仅仅对读 / 写回调有用， 所以对生成请求的处理直接写 0 即可； 第 2 种是写  <code>FLTFL_OPERATION_REGISTRATION_SKIP_CACHED_IO</code>  ， 表示不过滤缓冲读 / 写请求； 第 3 种是写  <code>FLTFL_OPERATION_REGISTRATION_SKIP_PAGING_IO</code>  ， 表示不过滤分页读 / 写请求。 接下来的两个域就是预操作回调函数和后操作回调函数。请注意最后一个元素必须是  <code>IRP_MJ_OPERATION_END</code>  ， 否则过滤管理器无法知道到底有多少个元素。</p>\n<p>读者已经看到了上面有若干个回调函数， 其中有一些回调函数在操作回调函数集 Callbacks 中， 还有一些回调函数就直接在微过滤器注册结构中。 下面的任务就是逐个实现这些函数。在操作回调函数集中， 本章的例子只需要用到生成回调函数， 其他的回调处理可以按这个类推。</p>\n<h2 id=\"flt_preop_callback_status-返回值\"><a class=\"anchor\" href=\"#flt_preop_callback_status-返回值\">#</a> FLT_PREOP_CALLBACK_STATUS 返回值</h2>\n<p>在编写 minifilter 回调函数之前先了解一下其返回值所代表的的含义：</p>\n<table>\n<thead>\n<tr>\n<th>返回值</th>\n<th>描述</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><strong>FLT_PREOP_COMPLETE</strong></td>\n<td>minifilter 驱动程序正在完成 I/O 操作。过滤器管理器不会将 I/O 操作发送到驱动程序堆栈中调用者之下的任何微过滤器驱动程序或文件系统。在这种情况下，过滤器管理器只调用驱动堆栈中调用者之上的微过滤器驱动的后操作回调例程。</td>\n</tr>\n</tbody>\n<tbody>\n<tr>\n<td><strong>FLT_PREOP_DISALLOW_FASTIO</strong></td>\n<td>该操作是一个快速 I/O 操作，并且 minifilter 驱动程序不允许将快速 I/O 路径用于该操作。过滤器管理器不会将快速 I/O 操作发送到驱动程序堆栈中调用者下方的任何微过滤器驱动程序或文件系统。在这种情况下，过滤器管理器只调用驱动堆栈中调用者之上的微过滤器驱动的后操作回调例程。</td>\n</tr>\n</tbody>\n<tbody>\n<tr>\n<td><strong>FLT_PREOP_PENDING</strong></td>\n<td>minifilter 驱动程序挂起 I/O 操作，并且该操作仍在挂起。过滤器管理器不会进一步处理 I/O 操作，直到 minifilter 驱动调用<strong> FltCompletePendedPreOperation</strong>。</td>\n</tr>\n</tbody>\n<tbody>\n<tr>\n<td><strong>FLT_PREOP_SUCCESS_NO_CALLBACK</strong></td>\n<td>minifilter 驱动程序正在将 I/O 操作返回给 filter 管理器以供进一步处理。在这种情况下，过滤器管理器在 I/O 完成期间不会调用 minifilter 驱动程序的后操作回调（如果存在的话）。</td>\n</tr>\n</tbody>\n<tbody>\n<tr>\n<td><strong>FLT_PREOP_SUCCESS_WITH_CALLBACK</strong></td>\n<td>minifilter 驱动程序正在将 I/O 操作返回给 filter 管理器以供进一步处理。在这种情况下，过滤器管理器在 I/O 完成期间调用 minifilter 驱动程序的操作后回调。</td>\n</tr>\n</tbody>\n<tbody>\n<tr>\n<td><strong>FLT_PREOP_SYNCHRONIZE</strong></td>\n<td>minifilter 驱动将 I/O 操作返回给 filter 管理器进行进一步处理，但它没有完成操作。在这种情况下，过滤器管理器在 IRQL &lt;= APC_LEVEL 的当前线程的上下文中调用微过滤器的后操作回调。</td>\n</tr>\n</tbody>\n<tbody>\n<tr>\n<td><strong>FLT_PREOP_DISALLOW_FSFILTER_IO</strong></td>\n<td>minifilter 驱动程序不允许快速 QueryOpen 操作并强制操作沿着慢速路径进行。这样做会导致 I/O 管理器通过执行文件的打开 / 查询 / 关闭来为请求提供服务。Minifilter 驱动程序应该只为 QueryOpen 返回这个状态。</td>\n</tr>\n</tbody>\n</table>\n<h2 id=\"卸载函数\"><a class=\"anchor\" href=\"#卸载函数\">#</a> 卸载函数</h2>\n<p>在卸载回调函数中， 应该注销我们曾经注册过的微过滤器， 这可以通过调用内核 API 函数 FltUnregisterFilter 来实现。 除此之外， 在这个回调函数中， 读者可以完成以前在传统型的文件过滤驱动中驱动卸载函数所完成的所有工作。 但是本例非常简单， 仅仅是调用 FltUnregisterFilter 而已。 这个函数也只有一个参数， 就是微过滤器句柄。</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>NTSTATUS</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token function\">FsFilter01Unload</span> <span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    _In_ FLT_FILTER_UNLOAD_FLAGS Flags</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token function\">UNREFERENCED_PARAMETER</span><span class=\"token punctuation\">(</span> Flags <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token function\">PAGED_CODE</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    <span class=\"token function\">PT_DBG_PRINT</span><span class=\"token punctuation\">(</span> PTDBG_TRACE_ROUTINES<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>                  <span class=\"token punctuation\">(</span><span class=\"token string\">\"FsFilter01!FsFilter01Unload: Entered\\n\"</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    <span class=\"token function\">FltUnregisterFilter</span><span class=\"token punctuation\">(</span> gFilterHandle <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    <span class=\"token keyword\">return</span> STATUS_SUCCESS<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>这个函数的主要工作是释放资源，  <code>FltUnregisterFilter</code>  与  <code>FltRegisterFilter</code>  互相对应， <code>FltUnregisterFilter</code> <strong> 用来释放已注册的微过滤器在 Windows 内核内部所使用的资源</strong>。</p>\n<h2 id=\"预操作回调函数\"><a class=\"anchor\" href=\"#预操作回调函数\">#</a> 预操作回调函数</h2>\n<p>我们针对  <code>IRP_MJ_CREATE</code>  这个主功能号<em>来设置预操作回调函数与后操作回调函数</em>，当系统接收到标识为  <code>IRP_MJ_CREATE</code>  的 IRP 也就是试图生成或者打开文件时， 就会调用到预操作回调函数与后操作回调函数。</p>\n<p><code>NPPreCreate</code>  是我们<strong>设置的预操作回调函数</strong>。这个函数有三个参数， 其中第一个参数是一个  <code>FLT_CALLBACK_DATA</code>  的指针，   <code>FLT_CALLBACK_DATA</code>  称为回调数据包， 这个数据包内含有和这个请求相关的全部信息。 正是因为有了这个参数， 所以不再直接读取 IRP 的信息了。 这个函数的参数中不再有 IRP 的指针。</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>FLT_PREOP_CALLBACK_STATUS</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token function\">NPPreCreate</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    __inout PFLT_CALLBACK_DATA Data<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    __in PCFLT_RELATED_OBJECTS FltObjects<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    __deref_out_opt PVOID<span class=\"token operator\">*</span> CompletionContext</pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token comment\">// 缓存区，用来获得文件名</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token keyword\">char</span> FileName<span class=\"token punctuation\">[</span><span class=\"token number\">260</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token string\">\"X:\"</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    NTSTATUS status<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    PFLT_FILE_NAME_INFORMATION nameInfo<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    <span class=\"token comment\">// 未使用的参数，用宏掩盖之使其不发生编译警告</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    <span class=\"token function\">UNREFERENCED_PARAMETER</span><span class=\"token punctuation\">(</span>FltObjects<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    <span class=\"token function\">UNREFERENCED_PARAMETER</span><span class=\"token punctuation\">(</span>CompletionContext<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    <span class=\"token comment\">// 检测可分页代码</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    <span class=\"token function\">PAGED_CODE</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    __try <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>        <span class=\"token comment\">// 这里有获取文件名信息，获取文件名和解析文件名等几个函数，稍后在详细了解。</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>        status <span class=\"token operator\">=</span> <span class=\"token function\">FltGetFileNameInformation</span><span class=\"token punctuation\">(</span>Data<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>            FLT_FILE_NAME_NORMALIZED <span class=\"token operator\">|</span> FLT_FILE_NAME_QUERY_DEFAULT<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>            <span class=\"token operator\">&amp;</span>nameInfo<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">NT_SUCCESS</span><span class=\"token punctuation\">(</span>status<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>            <span class=\"token comment\">//如果成功了，解析文件名信息，然后比较其中是否有 NOTEPAD.EXE 子字符串</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>gCommand <span class=\"token operator\">==</span> ENUM_BLOCK<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>                <span class=\"token function\">FltParseFileNameInformation</span><span class=\"token punctuation\">(</span>nameInfo<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>                <span class=\"token comment\">// 将字符串转换为 CHAR 大写以利于比对字符串</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>                <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">NPUnicodeStringToChar</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>nameInfo<span class=\"token operator\">-></span>Name<span class=\"token punctuation\">,</span> FileName<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>                    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">strstr</span><span class=\"token punctuation\">(</span>FileName<span class=\"token punctuation\">,</span> <span class=\"token string\">\"NOTEPAD.EXE\"</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">></span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>                        <span class=\"token comment\">// 填写拒绝</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>                        Data<span class=\"token operator\">-></span>IoStatus<span class=\"token punctuation\">.</span>Status <span class=\"token operator\">=</span> STATUS_ACCESS_DENIED<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>                        Data<span class=\"token operator\">-></span>IoStatus<span class=\"token punctuation\">.</span>Information <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>                        <span class=\"token function\">FltReleaseFileNameInformation</span><span class=\"token punctuation\">(</span>nameInfo<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>                        <span class=\"token comment\">// 返回请求已经结束，，也就是不用在下传了</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>                        <span class=\"token keyword\">return</span> FLT_PREOP_COMPLETE<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>                    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>                <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>            <span class=\"token comment\">// 释放名字资源 </span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>            <span class=\"token function\">FltReleaseFileNameInformation</span><span class=\"token punctuation\">(</span>nameInfo<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>    <span class=\"token function\">__except</span> <span class=\"token punctuation\">(</span>EXCEPTION_EXECUTE_HANDLER<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>        <span class=\"token function\">DbgPrint</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"NPPreCreate EXCEPTION_EXECUTE_HANDLER\\n\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>    <span class=\"token keyword\">return</span> FLT_PREOP_SUCCESS_WITH_CALLBACK<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>这是一个很简单的预操作回调函数， 它的主要作用就是尽可能地解析目前的文件名称， 然后判断这个名称是否符合我们需要的条件。 我们的目的是限制名为 “notepad.exe” 的文件被使用， 任何文件的操作比如读取、 删除、 覆盖、 重命名、 执行等， 必定都会先调用到打开请求。 因此，在这里做个简单的判断， 试图分辨出目前系统操作的文件是否符合我们所寻找的条件。</p>\n<p>上面用到了一个自定义函数  <code>NPUnicodeStringToChar</code> 。 该函数将  <code>UNICODE_STRING</code>  转换为全大写的 CHAR 数组， 以便搜索子字符串 “NOTEPAD.EXE”。 其中使用了内核 API 函数  <code>RtlUpperChar</code>  转换大小写， 我们可以试着自己实现这个函数。</p>\n<h3 id=\"了解相关数据结构\"><a class=\"anchor\" href=\"#了解相关数据结构\">#</a> 了解相关数据结构</h3>\n<p><code>FLT_CALLBACK_DATA</code>  、  <code>PFLT_IO_PARAMETER_BLOCK</code>  、  <code>FLT_PARAMETERS</code></p>\n<h4 id=\"flt_callback_data\"><a class=\"anchor\" href=\"#flt_callback_data\">#</a> FLT_CALLBACK_DATA</h4>\n<p>下面是回调数据包  <code>FLT_CALLBACK_DATA</code>  的定义:</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">typedef</span> <span class=\"token keyword\">struct</span> <span class=\"token class-name\">_FLT_CALLBACK_DATA</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token comment\">//  Flags</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    FLT_CALLBACK_DATA_FLAGS Flags<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    <span class=\"token comment\">//  Thread that initiated this operation.</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    PETHREAD CONST Thread<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    <span class=\"token comment\">//  Pointer to the changeable i/o parameters</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    PFLT_IO_PARAMETER_BLOCK CONST Iopb<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>    <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>    <span class=\"token comment\">//  For pre-op calls: if filter returns STATUS_IO_COMPLETE, then it should</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>    <span class=\"token comment\">//  set the return i/o status here.  For post-operation calls, this is set</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>    <span class=\"token comment\">//  by filter-manager indicating the completed i/o status.</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>    <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>    IO_STATUS_BLOCK IoStatus<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre></pre></td></tr><tr><td data-num=\"29\"></td><td><pre></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>    <span class=\"token keyword\">struct</span> <span class=\"token class-name\">_FLT_TAG_DATA_BUFFER</span> <span class=\"token operator\">*</span>TagData<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>    <span class=\"token keyword\">union</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>        <span class=\"token keyword\">struct</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>            <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>            <span class=\"token comment\">//  Queue links if the FltMgr queue is used to</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>            <span class=\"token comment\">//  pend the callback</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>            <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>            LIST_ENTRY QueueLinks<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>            <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>            <span class=\"token comment\">//  Additional context</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>            <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>            PVOID QueueContext<span class=\"token punctuation\">[</span><span class=\"token number\">2</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>        <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>        <span class=\"token comment\">//  The following are available to filters to use</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>        <span class=\"token comment\">//  in whatever manner desired if not using the filter manager</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre>        <span class=\"token comment\">//  queues.</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>        <span class=\"token comment\">//  NOTE:  These fields are only valid while the filter is</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre>        <span class=\"token comment\">//         processing this operation which is inside the operation</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre>        <span class=\"token comment\">//         callback or while the operation is pended.</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>        <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre></pre></td></tr><tr><td data-num=\"58\"></td><td><pre>        PVOID FilterContext<span class=\"token punctuation\">[</span><span class=\"token number\">4</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"59\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre></pre></td></tr><tr><td data-num=\"61\"></td><td><pre>    <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"62\"></td><td><pre>    <span class=\"token comment\">//  Original requester mode of caller</span></pre></td></tr><tr><td data-num=\"63\"></td><td><pre>    <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"64\"></td><td><pre></pre></td></tr><tr><td data-num=\"65\"></td><td><pre>    KPROCESSOR_MODE RequestorMode<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"66\"></td><td><pre></pre></td></tr><tr><td data-num=\"67\"></td><td><pre><span class=\"token punctuation\">&#125;</span> FLT_CALLBACK_DATA<span class=\"token punctuation\">,</span> <span class=\"token operator\">*</span>PFLT_CALLBACK_DATA<span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>回调数据包结构代表了一个 I/O 操作。 过滤管理器与微过滤驱动都使用这个结构来初始化与处理 I/O 操作， 内含许多嵌套结构定义， 可以在 WDK 头文件  <code>fltkernel.h</code>  中找到更多有关的数据。这个结构可以说是 Minifilter 的基础。</p>\n<p>大部分读者会提出疑问， 以前在  <code>sfilter</code>  中， 我们从 IRP 指针及 IRP 的当前栈空间指针中得到许多信息， 比如写请求的长度等， 现<br />\n在如何能得到这些信息呢？</p>\n<h4 id=\"pflt_io_parameter_block\"><a class=\"anchor\" href=\"#pflt_io_parameter_block\">#</a> PFLT_IO_PARAMETER_BLOCK</h4>\n<p>注意  <code>Iopb</code>  域， 这是一个  <code>PFLT_IO_PARAMETER_BLOCK</code>  指针。 这个数据结构定义如下：</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">typedef</span> <span class=\"token keyword\">struct</span> <span class=\"token class-name\">_FLT_IO_PARAMETER_BLOCK</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token comment\">//  Fields from IRP</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token comment\">//  Flags</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    ULONG IrpFlags<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token comment\">//  Major/minor functions from IRP</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    UCHAR MajorFunction<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    UCHAR MinorFunction<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    <span class=\"token comment\">//  The flags associated with operations.</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    <span class=\"token comment\">//  The IO_STACK_LOCATION.Flags field in the old model (SL_* flags)</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>    <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>    UCHAR OperationFlags<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>    <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>    <span class=\"token comment\">//  For alignment</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>    <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>    UCHAR Reserved<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre></pre></td></tr><tr><td data-num=\"28\"></td><td><pre></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>    <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>    <span class=\"token comment\">//  The FileObject that is the target for this</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>    <span class=\"token comment\">//  IO operation.</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>    <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>    PFILE_OBJECT TargetFileObject<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>    <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>    <span class=\"token comment\">//  Instance that i/o is directed to</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>    <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>    PFLT_INSTANCE TargetInstance<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>    <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>    <span class=\"token comment\">//  Normalized parameters for the operation</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>    <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>    FLT_PARAMETERS Parameters<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre></pre></td></tr><tr><td data-num=\"48\"></td><td><pre><span class=\"token punctuation\">&#125;</span> FLT_IO_PARAMETER_BLOCK<span class=\"token punctuation\">,</span> <span class=\"token operator\">*</span>PFLT_IO_PARAMETER_BLOCK<span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>在这里就可以找到以前熟悉的许多信息了， 包括主功能号、 次功能号和文件对象指针等。</p>\n<h4 id=\"flt_parameters\"><a class=\"anchor\" href=\"#flt_parameters\">#</a> FLT_PARAMETERS</h4>\n<p>此外， 其中还有一个结构为  <code>FLT_PARAMETERS</code>  的<strong>参数域</strong>， 这个数据结构是一个共用体， 应用的域根据不同的主功能号而不同， 该结构体的部分如下：</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">typedef</span> <span class=\"token keyword\">union</span> _FLT_PARAMETERS <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token comment\">//  IRP_MJ_CREATE</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token keyword\">struct</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>        PIO_SECURITY_CONTEXT SecurityContext<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>        <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>        <span class=\"token comment\">//  The low 24 bits contains CreateOptions flag values.</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>        <span class=\"token comment\">//  The high 8 bits contains the CreateDisposition values.</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>        <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>        ULONG Options<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>        USHORT POINTER_ALIGNMENT FileAttributes<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>        USHORT ShareAccess<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>        ULONG POINTER_ALIGNMENT EaLength<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>        PVOID EaBuffer<span class=\"token punctuation\">;</span>                 <span class=\"token comment\">//Not in IO_STACK_LOCATION parameters list</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>        LARGE_INTEGER AllocationSize<span class=\"token punctuation\">;</span>   <span class=\"token comment\">//Not in IO_STACK_LOCATION parameters list</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span> Create<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>    ………</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>    <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>    <span class=\"token comment\">//  IRP_MJ_READ</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>    <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>    <span class=\"token keyword\">struct</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>        ULONG Length<span class=\"token punctuation\">;</span>                   <span class=\"token comment\">//Length of transfer</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>        ULONG POINTER_ALIGNMENT Key<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>        LARGE_INTEGER ByteOffset<span class=\"token punctuation\">;</span>       <span class=\"token comment\">//Offset to read from</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>        PVOID ReadBuffer<span class=\"token punctuation\">;</span>       <span class=\"token comment\">//Not in IO_STACK_LOCATION parameters list</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>        PMDL MdlAddress<span class=\"token punctuation\">;</span>        <span class=\"token comment\">//Mdl address for the buffer  (maybe NULL)</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span> Read<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>    <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>    <span class=\"token comment\">//  IRP_MJ_WRITE</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>    <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>    <span class=\"token keyword\">struct</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>        ULONG Length<span class=\"token punctuation\">;</span>                   <span class=\"token comment\">//Length of transfer</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>        ULONG POINTER_ALIGNMENT Key<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>        LARGE_INTEGER ByteOffset<span class=\"token punctuation\">;</span>       <span class=\"token comment\">//Offset to write to</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>        PVOID WriteBuffer<span class=\"token punctuation\">;</span>      <span class=\"token comment\">//Not in IO_STACK_LOCATION parameters list</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>        PMDL MdlAddress<span class=\"token punctuation\">;</span>        <span class=\"token comment\">//Mdl address for the buffer  (maybe NULL)</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span> Write<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre></pre></td></tr><tr><td data-num=\"52\"></td><td><pre>    ………</pre></td></tr><tr><td data-num=\"53\"></td><td><pre><span class=\"token punctuation\">&#125;</span> FLT_PARAMETERS<span class=\"token punctuation\">,</span> <span class=\"token operator\">*</span>PFLT_PARAMETERS<span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>从这里就很容易找到写请求包括的写入位置、 长度和缓冲区等相关参数。</p>\n<h3 id=\"解析文件路径所需要调用的函数\"><a class=\"anchor\" href=\"#解析文件路径所需要调用的函数\">#</a> 解析文件路径所需要调用的函数</h3>\n<h4 id=\"fltgetfilenameinformation\"><a class=\"anchor\" href=\"#fltgetfilenameinformation\">#</a> FltGetFileNameInformation</h4>\n<p>第一个函数是  <code>FltGetFileNameInformation</code>  ，这个函数可以取得一个文件或目录的文件名信息结构。</p>\n<p><strong>语法:</strong></p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>NTSTATUS FLTAPI <span class=\"token function\">FltGetFileNameInformation</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>  <span class=\"token punctuation\">[</span>in<span class=\"token punctuation\">]</span>  PFLT_CALLBACK_DATA         CallbackData<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  <span class=\"token punctuation\">[</span>in<span class=\"token punctuation\">]</span>  FLT_FILE_NAME_OPTIONS      NameOptions<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  <span class=\"token punctuation\">[</span>out<span class=\"token punctuation\">]</span> PFLT_FILE_NAME_INFORMATION <span class=\"token operator\">*</span>FileNameInformation</pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p><strong>参数:</strong></p>\n<p><code>[in] CallbackData</code></p>\n<p>指向  <code>FLT_CALLBACK_DATA</code>  结构的指针，它是 I/O 操作的回调数据结构。 此参数是必需的，不能为  <strong>NULL</strong> 。</p>\n<p><code>[in] NameOptions</code></p>\n<p>一个  <code>FLT_FILE_NAME_OPTIONS</code>  值，该值包含指定要返回的名称信息的格式以及筛选器管理器要使用的查询方法的标志。 (名称提供程序微型筛选器驱动程序可以使用其他标志来指定名称查询选项。) 此参数是必需的，不能为  <strong>NULL</strong> 。</p>\n<p>下面是文件名格式标志值。 只能指定以下标志之一。 有关这些格式的说明，请参阅  <code>FLT_FILE_NAME_INFORMATION</code>  。</p>\n<table>\n<thead>\n<tr>\n<th>名称格式标志值</th>\n<th>含义</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>FLT_FILE_NAME_NORMALIZED</td>\n<td><em>FileNameInformation</em> 参数接收包含文件的规范化名称的结构的地址。</td>\n</tr>\n<tr>\n<td>FLT_FILE_NAME_OPENED</td>\n<td><em>FileNameInformation</em> 参数接收包含打开文件时使用的名称的结构的地址。</td>\n</tr>\n<tr>\n<td>FLT_FILE_NAME_SHORT</td>\n<td><em>FileNameInformation</em> 参数接收包含文件的短 (8.3) 名称的结构的地址。 短名称由最多 8 个字符组成，后跟一个句点，最多 3 个字符。 文件的短名称不包括卷名称、目录路径或流名称。 在预创建路径中无效。</td>\n</tr>\n</tbody>\n</table>\n<p>下面是文件名查询方法标志值。 只能指定以下标志之一。</p>\n<table>\n<thead>\n<tr>\n<th>查询方法标志值</th>\n<th>含义</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>FLT_FILE_NAME_QUERY_DEFAULT</td>\n<td>如果目前无法安全地查询文件系统中的文件名，<strong>FltGetFileNameInformation</strong> 不执行任何操作。 否则， <strong>FltGetFileNameInformation</strong> 会查询筛选器管理器的名称缓存以获取文件名信息。 如果在缓存中找不到该名称， <strong>FltGetFileNameInformation</strong> 会查询文件系统并缓存结果。</td>\n</tr>\n<tr>\n<td>FLT_FILE_NAME_QUERY_CACHE_ONLY</td>\n<td><strong>FltGetFileNameInformation</strong> 查询筛选器管理器的名称缓存以获取文件名信息。 <strong>FltGetFileNameInformation</strong> 不查询文件系统。</td>\n</tr>\n<tr>\n<td>FLT_FILE_NAME_QUERY_FILESYSTEM_ONLY</td>\n<td><strong>FltGetFileNameInformation</strong> 查询文件系统以获取文件名信息。 <strong>FltGetFileNameInformation</strong> 不会查询筛选器管理器的名称缓存，也不会缓存文件系统查询的结果。</td>\n</tr>\n<tr>\n<td>FLT_FILE_NAME_QUERY_ALWAYS_ALLOW_CACHE_LOOKUP</td>\n<td><strong>FltGetFileNameInformation</strong> 查询筛选器管理器的名称缓存以获取文件名信息。 如果在缓存中找不到该名称，并且目前可以安全地执行此操作， <strong>FltGetFileNameInformation</strong> 会查询文件系统以获取文件名信息并缓存结果。</td>\n</tr>\n</tbody>\n</table>\n<p>名称提供程序微型筛选器使用以下标志来指定文件名操作的属性。</p>\n<table>\n<thead>\n<tr>\n<th>名称提供程序标志值</th>\n<th>含义</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>FLT_FILE_NAME_REQUEST_FROM_CURRENT_PROVIDER</td>\n<td>名称提供程序微型筛选器可以使用此标志指定名称查询请求应重定向到自身， (名称提供程序微型筛选器) ，而不是由堆栈中较低的名称提供程序满足。</td>\n</tr>\n<tr>\n<td>FLT_FILE_NAME_DO_NOT_CACHE</td>\n<td>此标志表示不应缓存从此查询检索到的名称。 名称提供程序微型筛选器使用此标志来执行中间查询以生成名称。</td>\n</tr>\n<tr>\n<td>FLT_FILE_NAME_ALLOW_QUERY_ON_REPARSE</td>\n<td>名称提供程序微型筛选器可以使用此标志指定在创建后路径中查询名称是安全的，即使返回了 STATUS_REPARSE 也是如此。 调用方负责确保<strong> FileObject-FileName&gt;</strong> 字段未更改。 请勿将此标志用于装入点或符号链接重新分析点。</td>\n</tr>\n</tbody>\n</table>\n<p><code>[out] FileNameInformation</code></p>\n<p>指向调用方分配的变量的指针，该变量接收包含文件名信息的系统分配 <span class=\"exturl\" data-url=\"aHR0cHM6Ly9kb2NzLm1pY3Jvc29mdC5jb20vemgtY24vd2luZG93cy1oYXJkd2FyZS9kcml2ZXJzL2RkaS9mbHRrZXJuZWwvbnMtZmx0a2VybmVsLV9mbHRfZmlsZV9uYW1lX2luZm9ybWF0aW9u\">FLT_FILE_NAME_INFORMATION</span> 结构的地址。 <strong>FltGetFileNameInformation</strong> 从分页池分配此结构。 此参数是必需的，不能为  <strong>NULL</strong> 。</p>\n<p><strong>返回值:</strong></p>\n<p>如果成功返回名称信息， <strong>FltGetFileNameInformation</strong> 将返回 STATUS_SUCCESS。 否则，它将返回相应的 NTSTATUS 值，例如以下值之一：</p>\n<p><img data-src=\"image001.png\" alt=\"\" /></p>\n<h4 id=\"fltparsefilenameinformation\"><a class=\"anchor\" href=\"#fltparsefilenameinformation\">#</a> FltParseFileNameInformation</h4>\n<p>第二个函数是  <code>FltParseFileNameInformation</code> ，</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>NTSTATUS FLTAPI <span class=\"token function\">FltParseFileNameInformation</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>  <span class=\"token punctuation\">[</span>in<span class=\"token punctuation\">,</span> out<span class=\"token punctuation\">]</span> PFLT_FILE_NAME_INFORMATION FileNameInformation</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>详细参见微软的官方文档→<span class=\"exturl\" data-url=\"aHR0cHM6Ly9kb2NzLm1pY3Jvc29mdC5jb20vemgtY24vd2luZG93cy1oYXJkd2FyZS9kcml2ZXJzL2RkaS9mbHRrZXJuZWwvbmYtZmx0a2VybmVsLWZsdHBhcnNlZmlsZW5hbWVpbmZvcm1hdGlvbj9mMXVybD0lM0ZhcHBJZCUzRERldjE2SURFRjElMjZsJTNEWkgtQ04lMjZrJTNEayhGTFRLRVJORUwlMjUyRkZsdFBhcnNlRmlsZU5hbWVJbmZvcm1hdGlvbiklM0JrKEZsdFBhcnNlRmlsZU5hbWVJbmZvcm1hdGlvbiklM0JrKERldkxhbmctQyUyNTJCJTI1MkIpJTNCayhUYXJnZXRPUy1XaW5kb3dzKSUyNnJkJTNEdHJ1ZQ==\">fltParseFileNameInformation 函数</span></p>\n<p><em>通过  <code>FltParseFileNameInformation</code>  函数可以得到一个含有路径名称与文件名的结构</em>， 我们再用字符串转换与比对便可以轻易地找出路径内是否有 NOTEPAD.EXE 等字符串。</p>\n<p>这里我调试了一下：</p>\n<p><img data-src=\"image003.png\" alt=\"\" /></p>\n<p>可以对比发现  <code>FltParseFileNameInformation</code>  函数做了什么。</p>\n<h3 id=\"否决请求\"><a class=\"anchor\" href=\"#否决请求\">#</a> 否决请求</h3>\n<p>在决定否决这个请求之后， 我们采用常见的与填写 IRP 的 IoStatus 域完全一样的方法否决这次请求， 相关代码如下：</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>Data<span class=\"token operator\">-></span>IoStatus<span class=\"token punctuation\">.</span>Status <span class=\"token operator\">=</span> STATUS_ACCESS_DENIED<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>Data<span class=\"token operator\">-></span>IoStatus<span class=\"token punctuation\">.</span>Information <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token function\">FltReleaseFileNameInformation</span><span class=\"token punctuation\">(</span>nameInfo<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">return</span> FLT_PREOP_COMPLETE<span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>这段程序代码主要是告诉过滤管理器， 这个请求要即刻返回失败， 即代表这个 IRP 不会往下处理。</p>\n<p>我在 Win10 中测试当试图去打开 notepad.exe 时会显示如下图：</p>\n<p><img data-src=\"image002.png\" alt=\"\" /></p>\n<p>当我们去双击默认是 notepad.exe 打开的文件时，会出现显示如下：</p>\n<p><img data-src=\"image004.png\" alt=\"\" /></p>\n<p>让我们选择打开方式。</p>\n<h2 id=\"后操作回调函数\"><a class=\"anchor\" href=\"#后操作回调函数\">#</a> 后操作回调函数</h2>\n<p>当 IRP 完成返回时就会通过后操作回调函数， 例如， 若不想让文件新建成功， 则可以通过 FltCancelFileOpen 来取消之前的 FILE_CREATE、 FILE_OPEN 等操作。</p>\n<p>在这段程序代码中并无 FltCancelFileOpen 操作， 是因为我们在预操作回调函数内就已经过滤该行为且设定返回值的动作了， 并不需要在这里重复操作。</p>\n<p>下面<strong>这个后处理回调函数对程序的功能本身并没有意义</strong>， 仅仅作为后处理回调写法的说明展示。</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>FLT_POSTOP_CALLBACK_STATUS</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token function\">NPPostCreate</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    __inout PFLT_CALLBACK_DATA Data<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    __in PCFLT_RELATED_OBJECTS FltObjects<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    __in_opt PVOID CompletionContext<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    __in FLT_POST_OPERATION_FLAGS Flags</pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    FLT_POSTOP_CALLBACK_STATUS returnStatus <span class=\"token operator\">=</span> FLT_POSTOP_FINISHED_PROCESSING<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    PFLT_FILE_NAME_INFORMATION nameInfo<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    NTSTATUS status<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    <span class=\"token function\">UNREFERENCED_PARAMETER</span><span class=\"token punctuation\">(</span>CompletionContext<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    <span class=\"token function\">UNREFERENCED_PARAMETER</span><span class=\"token punctuation\">(</span>Flags<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    <span class=\"token comment\">//  If this create was failing anyway, don't bother scanning now.</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>    <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token function\">NT_SUCCESS</span><span class=\"token punctuation\">(</span>Data<span class=\"token operator\">-></span>IoStatus<span class=\"token punctuation\">.</span>Status<span class=\"token punctuation\">)</span> <span class=\"token operator\">||</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>        <span class=\"token punctuation\">(</span>STATUS_REPARSE <span class=\"token operator\">==</span> Data<span class=\"token operator\">-></span>IoStatus<span class=\"token punctuation\">.</span>Status<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>        <span class=\"token keyword\">return</span> FLT_POSTOP_FINISHED_PROCESSING<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>    <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>    <span class=\"token comment\">//  Check if we are interested in this file.</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>    <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>    status <span class=\"token operator\">=</span> <span class=\"token function\">FltGetFileNameInformation</span><span class=\"token punctuation\">(</span>Data<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>        FLT_FILE_NAME_NORMALIZED <span class=\"token operator\">|</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>        FLT_FILE_NAME_QUERY_DEFAULT<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>        <span class=\"token operator\">&amp;</span>nameInfo<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token function\">NT_SUCCESS</span><span class=\"token punctuation\">(</span>status<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>        <span class=\"token keyword\">return</span> FLT_POSTOP_FINISHED_PROCESSING<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>    <span class=\"token keyword\">return</span> returnStatus<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>书上给的这个函数实际上什么也没做。返回  <code>FLT_POSTOP_FINISHED_PROCESSING</code> ， 代表 Minifilter 已经完成对 I/O 的所有处理， 并返回控制给过滤管理器。</p>\n<h2 id=\"其他回调函数\"><a class=\"anchor\" href=\"#其他回调函数\">#</a> 其他回调函数</h2>\n<p>除了前面介绍的回调函数， 还有其他的回调函数需要实现。 但是在大多数情况下， 这些函数的实现非常简单， 以至于用户只需要简单地拷贝例子中的代码就可以实现它们。 根据笔者的开发经验， 极少会利用到这些回调函数提供的功能。 下面对这些回调函数集中做个简单的介绍。 请注意这些函数都是可选的， 编程者可以不实现它们， 在微过滤器注册结构中将它们设置为 NULL。</p>\n<h3 id=\"instatancesetupcallback\"><a class=\"anchor\" href=\"#instatancesetupcallback\">#</a> InstatanceSetupCallback</h3>\n<p><code>InstatanceSetupCallback</code>  这个回调函数存在的目的， 在于让本驱动的开发者来决定哪个<br />\n卷需要绑定， 哪个卷不需要绑定。  <code>InstatanceSetupCallback</code>  在下列情况下会被调用。</p>\n<ol>\n<li>当一个微过滤器加载时， 每个存在的卷都会导致这个调用。</li>\n<li>当一个新的卷被挂载时。</li>\n<li>当 FltAttachVolume 被调用（内核模式） 时。</li>\n<li>当 FltAttachVolumeAtAltitude 被调用（内核模式） 时。</li>\n<li>当 FilterAttach 被调用（用户模式） 时。</li>\n<li>当 FilterAttachAtAltitude 被调用（用户模式） 时。</li>\n</ol>\n<p>在这个过程中， 微过滤器决定是否在这个卷上生成实例。 这个回调函数的原型如下：</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">typedef</span> <span class=\"token function\">NTSTATUS</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">(</span>FLTAPI <span class=\"token operator\">*</span>PFLT_INSTANCE_SETUP_CALLBACK<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    _In_ PCFLT_RELATED_OBJECTS FltObjects<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    _In_ FLT_INSTANCE_SETUP_FLAGS Flags<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    _In_ DEVICE_TYPE VolumeDeviceType<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    _In_ FLT_FILESYSTEM_TYPE VolumeFilesystemType</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p><strong>参数详解：</strong></p>\n<p><code>FltObjects</code> : 结构含有指向微过滤器、 卷和实例的指针。<em>这个实例是指将要在 InstanceSetupCallback 函数中生成的实例。</em></p>\n<p><code>Flags</code> : 标记是什么操作导致激发了  <code>InstanceSetupCallback</code> ：</p>\n<p><code>FLTFL_INSTANCE_SETUP_AUTOMATIC_ATTACHMENT</code> ： 这是一个微过滤器注册时， 一个自动的绑定通知。 过滤管理器为每个刚加载的微过滤器枚举所有的卷。 如果使用者明确地指定一个实例绑定到某一个卷， 则不会设置这个标记。<br />\n <code>FLTFL_INSTANCE_SETUP_MANUAL_ATTACHMENT</code> ： 通过调用 FilterAttach（用户态） 、 FilterAttachVolumeAtAltitude（用户态） 或者 FltAttachVolume（内核态） 所发起的一个手工请求。<br />\n <code>FLTFL_INSTANCE_SETUP_NEWLY_MOUNTED_VOLUME</code> ： 文件系统刚刚挂载了一个卷， 所以呼叫 InstanceSetupCallback 来通知微过滤器， 如果它愿意则可以生成实例来绑定这个卷。</p>\n<p>在  <code>InstanceSetupCallback</code>  中， 微过滤器同时得到了卷设备类型（ <code>VolumeDeviceType</code> ）和卷文件系统类型（ <code>VolumeFilesystemType</code> ） ， 用来判断这个卷是否是过滤器所感兴趣的。</p>\n<p>同时， 微过滤器可以调用  <code>FltGetVolumeProperties</code>  来获取卷属性。通过  <code>FltSetInstanceContext</code>  在实例上设置上下文， 当然这是在需要绑定时。它甚至可以在卷上打开或者关闭文件。</p>\n<p><strong>如果这个回调函数返回了成功， 那么这个实例将绑定到卷上； 如果返回了一个警告或者错误， 那么不会绑定。 如果微过滤器没有指定这个回调函数回调， 那么系统将认为用户总是返回  <code>STATUS_SUCCESS</code> ， 实例总是会生成并绑定</strong>。</p>\n<h3 id=\"instancequeryteardowncallback\"><a class=\"anchor\" href=\"#instancequeryteardowncallback\">#</a> InstanceQueryTeardownCallback</h3>\n<p>InstanceQueryTeardownCallback 是控制实例销毁函数， 这个回调函数只会在一个手工<br />\n解除绑定请求时被调用。 手工解除绑定意味着两种可能：<br />\n内核模式调试 FltDetachVolume；<br />\n用户模式调试 FilterDetach。<br />\n如果过滤器没有提供这个回调函数， 那么手工解除绑定是不被允许的， 但是卷的卸载<br />\n和过滤器的卸载仍是可以运作的。 如果这个调用成功， 那么第 9 个域<br />\n InstanceTeardownStartCallback 和第 10 个域 InstanceTeardownCompleteCallback 将会被调用；<br />\n当这些函数返回错误时， 手工解除绑定失败， 推荐的错误代码有<br />\n STATUS_FLT_DO_NOT_DETACH， 不过返回其他错误代码也是可以的。<br />\n（3） InstanceTeardownStartCallback<br />\nInstanceTeardownStartCallback 是实例解除绑定回调函数。 调用则代表已经决定要解除<br />\n绑定， 这个函数应该做以下事情。<br />\n①重设所有未决的 I/O 操作（包括预操作和后操作） 。<br />\n②保证不会有新的 I/O 操作进入未决。<br />\n③对刚刚到达的操作开始最少的工作。<br />\n同时进行以下操作：<br />\n①关闭所有打开的文件。<br />\n②取消所有本过滤器发起的 I/O 请求。<br />\n③停止将新的工作任务排队。<br />\n然后， 微过滤器把控制权交还过滤管理器来继续它的销毁过程。 当所有与这个实例相关的操作都排除干净或者完成时， InstanceTeardownComplete 会被调用。 过滤管理器保证<br />\n此时此实例存在的所有操作回调都完成了， 这时微过滤器必须关闭这个实例打开的所有文<br />\n件。 这个函数原型和 InstanceTeardownCompleteCallback 将一并介绍。</p>\n<h2 id=\"minifilter与应用程序通信\"><a class=\"anchor\" href=\"#minifilter与应用程序通信\">#</a> Minifilter 与应用程序通信</h2>\n<p>考虑到内核态和用户态之间的互动， 以前的做法是使用用户态的 API 函数  <code>DeviceIoControl</code>  结合在内核模块中的处理控制请求来实现双方数据的传递。 但是在 Minifilter 中则不同， Minifilter 有内建支持的 API 提供给开发者使用， 这里就先针对这些 API 来做介绍。</p>\n<p>该方法叫作通信端口（Communication Port） ， 顾名思义， 就是<strong>先定义一个通道名称， 通过双边已经定义好的通信端口来做数据上的沟通</strong>； 使用上很像 socket 或管道（pipe） 之类的通信程序设计。</p>\n<h3 id=\"建立通信端口\"><a class=\"anchor\" href=\"#建立通信端口\">#</a> 建立通信端口</h3>\n<p>下面的代码演示了如何建立一个通信端口。</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>PSECURITY_DESCRIPTOR sd<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>OBJECT_ATTRIBUTES oa<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>status <span class=\"token operator\">=</span> <span class=\"token function\">FltBuildDefaultSecurityDescriptor</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>sd<span class=\"token punctuation\">,</span> FLT_PORT_ALL_ACCESS<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token function\">NT_SUCCESS</span><span class=\"token punctuation\">(</span>status<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token keyword\">goto</span> final<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>status <span class=\"token operator\">=</span> <span class=\"token function\">FltBuildDefaultSecurityDescriptor</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>sd<span class=\"token punctuation\">,</span> FLT_PORT_ALL_ACCESS<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token function\">NT_SUCCESS</span><span class=\"token punctuation\">(</span>status<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    <span class=\"token keyword\">goto</span> final<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre></pre></td></tr><tr><td data-num=\"17\"></td><td><pre></pre></td></tr><tr><td data-num=\"18\"></td><td><pre><span class=\"token function\">RtlInitUnicodeString</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>uniString<span class=\"token punctuation\">,</span> MINISPY_PORT_NAME<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre></pre></td></tr><tr><td data-num=\"20\"></td><td><pre><span class=\"token function\">InitializeObjectAttributes</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>oa<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>    <span class=\"token operator\">&amp;</span>uniString<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>    OBJ_KERNEL_HANDLE <span class=\"token operator\">|</span> OBJ_CASE_INSENSITIVE<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>    <span class=\"token constant\">NULL</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>    sd<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>status <span class=\"token operator\">=</span> <span class=\"token function\">FltCreateCommunicationPort</span><span class=\"token punctuation\">(</span>gFilterHandle<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>    <span class=\"token operator\">&amp;</span>gServerPort<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>    <span class=\"token operator\">&amp;</span>oa<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>    <span class=\"token constant\">NULL</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>    NPMiniConnect<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>    NPMiniDisconnect<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>    NPMiniMessage<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>    <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p><strong>代码详解如下：</strong></p>\n<p><code>FltBuildDefaultSecurityDescriptor</code>  以  <code>FLT_PORT_ALL_ACCESS</code>  权限来产生一个安全性的描述符，  <code>MINISPY_PORT_NAME</code>  是刚刚所讲的通信端口定义的名称， 通过  <code>InitializeObjectAttributes</code>  来初始化对象属性（OBJECT_ATTRIBUTES） ， 接下来便要注册这个通信端口以及所需要使用到的函数。</p>\n<p>这里必须提供三个回调函数， 类似于以前我们为了实现通信所写的控制请求的分发函数。<br />\n这三个回调函数分别是  <code>NPMiniConnect</code> 、  <code>NPMiniDisconnect</code> 、  <code>NPMiniMessage</code> 。</p>\n<p><code>NPMiniConnect</code>  是用户态与内核态建立连接时内核会调用到的函数。<br />\n <code>NPMiniDisconnect</code>  是用户态与内核态连接结束时内核会调用到的函数。<br />\n <code>NPMiniMessage</code>  是用户态与内核态传送数据时内核会调用到的函数。</p>\n<p><em>用户态不需要再使用  <code>CreateFile</code>  和  <code>DeviceIoControl</code>  系列的 API， Minifilter 有专门的 API 提供给用户态程序使用</em>。</p>\n<p>这里用到的相关的 API 主要有两个：  <code>FilterConnectCommunicationPort</code>  和  <code>FilterSendMessage</code> ， 通过  <code>FilterConnectCommunicationPort</code>  可以调用到我们提供的  <code>NPMiniConnec</code> t 函数， 通过  <code>FilterSendMessage</code>  可以调用到相对应的  <code>NPMiniMessage</code> 。一对一关系很容易理解。</p>\n<p>至于参数则都是  <code>PVOID</code>  的指针， 开发时两边程序<strong>通过自定义的数据结构</strong>， 传入指针即可将数据传入或取出。</p>\n<p>接下来学习一下  <code>FilterConnectCommunicationPort</code>  和  <code>FilterSendMessage</code>  函数</p>\n<h4 id=\"filterconnectcommunicationport和filtersendmessage函数\"><a class=\"anchor\" href=\"#filterconnectcommunicationport和filtersendmessage函数\">#</a> FilterConnectCommunicationPort 和 FilterSendMessage 函数</h4>\n<p>WDK 定义的  <code>FilterConnectCommunicationPort</code>  原型如下：</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>HRESULT <span class=\"token function\">FilterConnectCommunicationPort</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>  <span class=\"token punctuation\">[</span>in<span class=\"token punctuation\">]</span>           LPCWSTR               lpPortName<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  <span class=\"token punctuation\">[</span>in<span class=\"token punctuation\">]</span>           DWORD                 dwOptions<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  <span class=\"token punctuation\">[</span>in<span class=\"token punctuation\">,</span> optional<span class=\"token punctuation\">]</span> LPCVOID               lpContext<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  <span class=\"token punctuation\">[</span>in<span class=\"token punctuation\">]</span>           WORD                  wSizeOfContext<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  <span class=\"token punctuation\">[</span>in<span class=\"token punctuation\">,</span> optional<span class=\"token punctuation\">]</span> LPSECURITY_ATTRIBUTES lpSecurityAttributes<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  <span class=\"token punctuation\">[</span>out<span class=\"token punctuation\">]</span>          HANDLE                <span class=\"token operator\">*</span>hPort</pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>函数在头文件  <code>fltuser.h</code>  中。</p>\n<p><strong>参数</strong></p>\n<p><code>[in] lpPortName</code></p>\n<p>指向以 NULL 结尾的宽字符串的指针，该字符串包含通信服务器端口的完全限定名称（例如，L&quot;\\MyFilterPort&quot;）。</p>\n<p><code>[in] dwOptions</code></p>\n<p>通信端口的连接选项。在 Windows 8.1 之前，此值设置为 0。</p>\n<table>\n<thead>\n<tr>\n<th>值</th>\n<th>意义</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><strong>FLT_PORT_FLAG_SYNC_HANDLE</strong></td>\n<td><em>hPort</em> 中 返回的句柄用于同步 I/O。此标志从 Windows 8.1 开始可用。</td>\n</tr>\n</tbody>\n</table>\n<p><code>[in, optional] lpContext</code></p>\n<p>指向调用者提供的上下文信息的指针，该上下文信息将传递给内核模式微过滤器的连接通知例程。（请参阅 FltCreateCommunicationPort 参考页面中的<em> ConnectNotifyCallback</em> 参数。）此参数是可选的，可以为 NULL。</p>\n<p><code>[in] wSizeOfContext</code></p>\n<p><em>lpContext</em> 参数指向的结构的大小（以字节为单位） 。如果<em> lpContext</em> 的值为非 <strong>NULL</strong> ，则此参数必须为非零。如果<em> lpContext</em> 为 <strong>NULL</strong> ，则此参数必须为零。</p>\n<p><code>[in, optional] lpSecurityAttributes</code></p>\n<p>指向 SECURITY_ATTRIBUTES 结构的指针，该结构确定返回的句柄是否可以被子进程继承。有关 SECURITY_ATTRIBUTES 结构的详细信息，请参阅 Microsoft Windows SDK 文档。此参数是可选的，可以是 <strong>NULL</strong> 。如果此参数为 <strong>NULL</strong> ，则无法继承句柄。</p>\n<p><code>[out] hPort</code></p>\n<p>指向调用者分配的变量的指针，如果对<strong> FilterConnectCommunicationPort</strong> 的调用成功，该变量将接收新创建的连接端口的句柄；否则，它会收到 INVALID_HANDLE_VALUE。</p>\n<p><strong>返回值</strong><br />\n如果成功， FilterConnectCommunicationPort 返回 S_OK。否则，它返回一个错误值。</p>\n<hr />\n<hr />\n<p>接下来是  <code>FilterSendMessage</code>  函数，其功能是向微过滤器发送消息。</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>HRESULT <span class=\"token function\">FilterSendMessage</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>  <span class=\"token punctuation\">[</span>in<span class=\"token punctuation\">]</span>           HANDLE  hPort<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  <span class=\"token punctuation\">[</span>in<span class=\"token punctuation\">,</span> optional<span class=\"token punctuation\">]</span> LPVOID  lpInBuffer<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  <span class=\"token punctuation\">[</span>in<span class=\"token punctuation\">]</span>           DWORD   dwInBufferSize<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  <span class=\"token punctuation\">[</span>out<span class=\"token punctuation\">]</span>          LPVOID  lpOutBuffer<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  <span class=\"token punctuation\">[</span>in<span class=\"token punctuation\">]</span>           DWORD   dwOutBufferSize<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  <span class=\"token punctuation\">[</span>out<span class=\"token punctuation\">]</span>          LPDWORD lpBytesReturned</pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>各参数说明如下。<br />\n <code>hPort</code>  ： 连接端口名称， 宽字符字符串。<br />\n <code>lpInBuffer</code>  ： 输入缓冲区。 将定义好的结构用指针传入。<br />\n <code>dwInBufferSize</code>  ： 输入缓冲区大小。<br />\n <code>lpOutBuffer</code>  ： 输出缓冲区。 既可传入数据也可取得返回的数据。<br />\n <code>dwOutBufferSize</code>  ： 输出缓冲区大小。<br />\n <code>lpBytesReturned</code>  ： FilterSendMessage 调用成功则会返回一个标识 lpOutBuffer 大小的<br />\n值。</p>\n<p><code>[in] hPort</code></p>\n<p>先前调用<span class=\"exturl\" data-url=\"aHR0cHM6Ly9kb2NzLm1pY3Jvc29mdC5jb20vZW4tdXMvd2luZG93cy9kZXNrdG9wL2FwaS9mbHR1c2VyL25mLWZsdHVzZXItZmlsdGVyY29ubmVjdGNvbW11bmljYXRpb25wb3J0\"> FilterConnectCommunicationPort</span> 返回的通信端口句柄。此参数是必需的，不能为 <strong>NULL</strong> 。</p>\n<p><code>[in, optional] lpInBuffer</code></p>\n<p>指向调用者分配的缓冲区的指针，该缓冲区包含要发送到微过滤器的消息。消息格式是调用者定义的。此参数是必需的，不能为 <strong>NULL</strong> 。</p>\n<p><code>[in] dwInBufferSize</code></p>\n<p><em>lpInBuffer</em> 指向的缓冲区的大小，以字节为单位。</p>\n<p><code>[out] lpOutBuffer</code></p>\n<p>指向调用者分配的缓冲区的指针，该缓冲区接收来自微过滤器的回复（如果有的话）。</p>\n<p><code>[in] dwOutBufferSize</code></p>\n<p><em>lpOutBuffer</em> 指向的缓冲区的大小，以字节为单位。如果<em> lpOutBuffer</em> 为<strong> NULL</strong> ，则忽略此值。</p>\n<p><code>[out] lpBytesReturned</code></p>\n<p>指向调用者分配的变量的指针，如果对 FilterSendMessage 的调用成功，则该变量接收<em> lpOutBuffer</em> 指向的缓冲区中返回的字节数。此参数是必需的，不能为 NULL。</p>\n<p><strong>返回值</strong></p>\n<p><strong>如果成功， FilterSendMessage</strong> 返回 S_OK。否则，它返回一个错误值。</p>\n<h3 id=\"在用户态通过dll使用通信端口的范例\"><a class=\"anchor\" href=\"#在用户态通过dll使用通信端口的范例\">#</a> 在用户态通过 DLL 使用通信端口的范例</h3>\n<p>为什么编写一个 dll：<em>在用户态编写应用程序时， 开发者可以编写一个简单的动态链接库（DLL） 来提供与内核中的 Minifilter 内核驱动程序通信的功能， 在应用程序中就可以调用这个 DLL 来与内核通信了</em>。</p>\n<p>在编写这个 DLL 时， 必须要包含 WDK 中的头文件  <code>fltUser.h</code> ， 此外还必须连接 Minifilter 提供给用户态程序使用的静态库  <code>fltLib.lib</code>  和  <code>fltMgr.lib</code> 。</p>\n<p>编程中要注意的第一件事是： <strong>在处理  <code>DLL_PROCESS_ATTACH</code>  时要调用  <code>FilterConnectCommunicationPort</code> ， 便能完成与 Minifilter 沟通的通信端口的初始化， 然后可以通过  <code>FilterSendMessage</code>  传送数据， 等到程序关闭后关闭并释放这个通信端口</strong>。</p>\n<p>以下是本章的例子中  <code>NPdll.dll</code>  的程序代码示例。</p>\n<p>这是头文件。</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">// 首先要引入头文件和要连接的静态库。</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">\"windows.h\"</span></span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;stdio.h></span></span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token comment\">// 一定要包含 Minifilter 的头文件</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;fltUser.h></span></span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">pragma</span> <span class=\"token expression\"><span class=\"token function\">comment</span><span class=\"token punctuation\">(</span>lib<span class=\"token punctuation\">,</span> </span><span class=\"token string\">\"user32.lib\"</span><span class=\"token expression\"><span class=\"token punctuation\">)</span></span></span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">pragma</span> <span class=\"token expression\"><span class=\"token function\">comment</span><span class=\"token punctuation\">(</span>lib<span class=\"token punctuation\">,</span> </span><span class=\"token string\">\"kernel32.lib\"</span><span class=\"token expression\"><span class=\"token punctuation\">)</span></span></span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token comment\">// 注意必须连接 Minifilter 提供的静态库</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">pragma</span> <span class=\"token expression\"><span class=\"token function\">comment</span><span class=\"token punctuation\">(</span>lib<span class=\"token punctuation\">,</span> </span><span class=\"token string\">\"fltLib.lib\"</span><span class=\"token expression\"><span class=\"token punctuation\">)</span></span></span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">pragma</span> <span class=\"token expression\"><span class=\"token function\">comment</span><span class=\"token punctuation\">(</span>lib<span class=\"token punctuation\">,</span> </span><span class=\"token string\">\"fltMgr.lib\"</span><span class=\"token expression\"><span class=\"token punctuation\">)</span></span></span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">pragma</span> <span class=\"token expression\"><span class=\"token function\">comment</span><span class=\"token punctuation\">(</span>lib<span class=\"token punctuation\">,</span> </span><span class=\"token string\">\"ntoskrnl.lib\"</span><span class=\"token expression\"><span class=\"token punctuation\">)</span></span></span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">pragma</span> <span class=\"token expression\"><span class=\"token function\">comment</span><span class=\"token punctuation\">(</span>lib<span class=\"token punctuation\">,</span> </span><span class=\"token string\">\"hal.lib\"</span><span class=\"token expression\"><span class=\"token punctuation\">)</span></span></span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token comment\">// 在全局变量 g_hPort 中保存通信端口的句柄；</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token keyword\">extern</span> HANDLE g_hPort<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token comment\">// 定义微过滤器的名字和通信端口的名字。 注意： 必须是宽字符的。</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">NPMINI_NAME</span>            <span class=\"token expression\">L</span><span class=\"token string\">\"NPminifilter\"</span></span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">NPMINI_PORT_NAME</span>       <span class=\"token expression\">L</span><span class=\"token string\">\"\\\\NPMiniPort\"</span></span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre></pre></td></tr><tr><td data-num=\"20\"></td><td><pre><span class=\"token comment\">// DLL 的编程规范， 声明导出函数</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre><span class=\"token function\">__declspec</span><span class=\"token punctuation\">(</span>dllexport<span class=\"token punctuation\">)</span>\t<span class=\"token keyword\">int</span> <span class=\"token function\">InitialCommunicationPort</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">void</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre><span class=\"token function\">__declspec</span><span class=\"token punctuation\">(</span>dllexport<span class=\"token punctuation\">)</span>   <span class=\"token keyword\">int</span> <span class=\"token function\">NPSendMessage</span><span class=\"token punctuation\">(</span>PVOID InputBuffer<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre></pre></td></tr><tr><td data-num=\"24\"></td><td><pre><span class=\"token comment\">// 自定义的数据结构</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre><span class=\"token keyword\">typedef</span> <span class=\"token keyword\">enum</span> <span class=\"token class-name\">_NPMINI_COMMAND</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>    ENUM_PASS <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>    ENUM_BLOCK</pre></td></tr><tr><td data-num=\"28\"></td><td><pre><span class=\"token punctuation\">&#125;</span> NPMINI_COMMAND<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre></pre></td></tr><tr><td data-num=\"30\"></td><td><pre><span class=\"token keyword\">typedef</span> <span class=\"token keyword\">struct</span> <span class=\"token class-name\">_COMMAND_MESSAGE</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>    <span class=\"token comment\">// 储存列举 NPMINI_COMMAND 命令的结构</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>    NPMINI_COMMAND \tCommand<span class=\"token punctuation\">;</span>  </pre></td></tr><tr><td data-num=\"33\"></td><td><pre><span class=\"token punctuation\">&#125;</span> COMMAND_MESSAGE<span class=\"token punctuation\">,</span> <span class=\"token operator\">*</span>PCOMMAND_MESSAGE<span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>接下来开始编写 DLL 程序的进入点：</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">\"NPdll.h\"</span></span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>HANDLE g_hPort <span class=\"token operator\">=</span> INVALID_HANDLE_VALUE<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">ifdef</span> <span class=\"token expression\">_MANAGED</span></span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">pragma</span> <span class=\"token expression\"><span class=\"token function\">managed</span><span class=\"token punctuation\">(</span>push<span class=\"token punctuation\">,</span> off<span class=\"token punctuation\">)</span></span></span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">endif</span></span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>BOOL APIENTRY <span class=\"token function\">DllMain</span><span class=\"token punctuation\">(</span> HMODULE hModule<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>                       DWORD  ul_reason_for_call<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>                       LPVOID lpReserved</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>\t\t\t\t\t <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>\t<span class=\"token keyword\">switch</span> <span class=\"token punctuation\">(</span>ul_reason_for_call<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>\t<span class=\"token keyword\">case</span> DLL_PROCESS_ATTACH<span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>\t\t<span class=\"token function\">InitialCommunicationPort</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>\t<span class=\"token keyword\">case</span> DLL_THREAD_ATTACH<span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>\t<span class=\"token keyword\">case</span> DLL_THREAD_DETACH<span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>\t<span class=\"token keyword\">case</span> DLL_PROCESS_DETACH<span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>\t\t<span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>    <span class=\"token keyword\">return</span> TRUE<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre></pre></td></tr><tr><td data-num=\"26\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">ifdef</span> <span class=\"token expression\">_MANAGED</span></span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">pragma</span> <span class=\"token expression\"><span class=\"token function\">managed</span><span class=\"token punctuation\">(</span>pop<span class=\"token punctuation\">)</span></span></span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">endif</span></span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre></pre></td></tr><tr><td data-num=\"30\"></td><td><pre><span class=\"token keyword\">int</span> <span class=\"token function\">InitialCommunicationPort</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">void</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>    DWORD hResult <span class=\"token operator\">=</span> <span class=\"token function\">FilterConnectCommunicationPort</span><span class=\"token punctuation\">(</span> </pre></td></tr><tr><td data-num=\"33\"></td><td><pre>\t\tNPMINI_PORT_NAME<span class=\"token punctuation\">,</span>   <span class=\"token comment\">// 通信端口名称</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>\t\t<span class=\"token number\">0</span><span class=\"token punctuation\">,</span> </pre></td></tr><tr><td data-num=\"35\"></td><td><pre>\t\t<span class=\"token constant\">NULL</span><span class=\"token punctuation\">,</span> </pre></td></tr><tr><td data-num=\"36\"></td><td><pre>\t\t<span class=\"token number\">0</span><span class=\"token punctuation\">,</span> </pre></td></tr><tr><td data-num=\"37\"></td><td><pre>\t\t<span class=\"token constant\">NULL</span><span class=\"token punctuation\">,</span> </pre></td></tr><tr><td data-num=\"38\"></td><td><pre>\t\t<span class=\"token operator\">&amp;</span>g_hPort <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>     <span class=\"token comment\">// 通信端口句柄</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>hResult <span class=\"token operator\">!=</span> S_OK<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>\t\t<span class=\"token keyword\">return</span> hResult<span class=\"token punctuation\">;</span> <span class=\"token comment\">// 当连接失败时返回错误信息</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>\t<span class=\"token keyword\">return</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre></pre></td></tr><tr><td data-num=\"46\"></td><td><pre><span class=\"token comment\">// 传送数据函数</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre><span class=\"token keyword\">int</span> <span class=\"token function\">NPSendMessage</span><span class=\"token punctuation\">(</span>PVOID InputBuffer<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>\tDWORD bytesReturned <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>    <span class=\"token comment\">// 返回的结构大小</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>\tDWORD hResult <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>          <span class=\"token comment\">// 返回值</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>\tPCOMMAND_MESSAGE commandMessage <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>PCOMMAND_MESSAGE<span class=\"token punctuation\">)</span> InputBuffer<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>    hResult <span class=\"token operator\">=</span> <span class=\"token function\">FilterSendMessage</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre>\t\tg_hPort<span class=\"token punctuation\">,</span>                    <span class=\"token comment\">// 通信端口句柄</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre>        commandMessage<span class=\"token punctuation\">,</span>             <span class=\"token comment\">// 传入结构</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>        <span class=\"token keyword\">sizeof</span><span class=\"token punctuation\">(</span>COMMAND_MESSAGE<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>    <span class=\"token comment\">// 传入结构长度</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre>        <span class=\"token constant\">NULL</span><span class=\"token punctuation\">,</span>                       <span class=\"token comment\">// 传入或返回结构</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre>        <span class=\"token constant\">NULL</span><span class=\"token punctuation\">,</span>                       <span class=\"token comment\">// 传入结构</span></pre></td></tr><tr><td data-num=\"59\"></td><td><pre>        <span class=\"token operator\">&amp;</span>bytesReturned <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre></pre></td></tr><tr><td data-num=\"61\"></td><td><pre>\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>hResult <span class=\"token operator\">!=</span> S_OK<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"62\"></td><td><pre>\t\t<span class=\"token keyword\">return</span> hResult<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"63\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"64\"></td><td><pre>\t<span class=\"token keyword\">return</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"65\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>当载入 DLL 时（DLL_PROCESS_ATTACH） 会调用  <code>InitialCommunicationPort</code> ， 这个调用主要是为了初始化通信端口， 以便后面的函数可以调用这个接口的 API。</p>\n<p>当调用到  <code>NPSendMessage</code>  时，传入的参数也需要是一个  <code>COMMAND_MESSAGE</code>  结构的指针， 当传送成功时返回  <code>S_OK</code> ， 失败时可根据返回值  <code>hResult</code>  得知错误代码。</p>\n<h2 id=\"minifilter的安装与加载\"><a class=\"anchor\" href=\"#minifilter的安装与加载\">#</a> Minifilter 的安装与加载</h2>\n<p>安装驱动的方法有许多种， 可以通过函数注册或用 INF 文件向系统注册驱动。</p>\n<p>接下来学习有关安装 Minifilter 驱动的方法， 在安装驱动时， 使用 INF 的方式来进行安装。</p>\n<h3 id=\"安装minifilter的inf文件\"><a class=\"anchor\" href=\"#安装minifilter的inf文件\">#</a> 安装 Minifilter 的 INF 文件</h3>\n<p><code>inf</code>  文件是一个暗转信息的配置文件，指明了安装的  <code>.sys</code>  文件路径，、安装到哪个位置、以及写到注册表中的何种位置。</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>Version<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>Signature   <span class=\"token operator\">=</span> <span class=\"token string\">\"$Windows NT$\"</span>   </pre></td></tr><tr><td data-num=\"3\"></td><td><pre>Class       <span class=\"token operator\">=</span> <span class=\"token string\">\"ActivityMonitor\"</span>  <span class=\"token punctuation\">;</span>指明了驱动的分组<span class=\"token punctuation\">,</span>必须指定<span class=\"token punctuation\">.</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>ClassGuid   <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span>b86dff51<span class=\"token operator\">-</span>a31e<span class=\"token operator\">-</span><span class=\"token number\">4</span>bac<span class=\"token operator\">-</span>b3cf<span class=\"token operator\">-</span>e8cfe75c9fc2<span class=\"token punctuation\">&#125;</span>  <span class=\"token punctuation\">;</span>GUID 每个分组都有固定的GUID</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>Provider    <span class=\"token operator\">=</span> <span class=\"token operator\">%</span>Msft<span class=\"token operator\">%</span> <span class=\"token punctuation\">;</span>变量值 从STRING节中可以看到驱动提供者的名称 </pre></td></tr><tr><td data-num=\"6\"></td><td><pre>DriverVer   <span class=\"token operator\">=</span> <span class=\"token number\">06</span><span class=\"token operator\">/</span><span class=\"token number\">16</span><span class=\"token operator\">/</span><span class=\"token number\">2007</span><span class=\"token punctuation\">,</span><span class=\"token number\">1.0</span><span class=\"token punctuation\">.</span><span class=\"token number\">0.1</span> <span class=\"token punctuation\">;</span>版本号</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>CatalogFile <span class=\"token operator\">=</span> passthrough<span class=\"token punctuation\">.</span>cat    <span class=\"token punctuation\">;</span>inf对应的cat 文件 可以不需要</pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token punctuation\">[</span>DestinationDirs<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>DefaultDestDir          <span class=\"token operator\">=</span> <span class=\"token number\">12</span>    <span class=\"token punctuation\">;</span>告诉我们驱动拷贝到哪里 <span class=\"token number\">12</span>代表拷贝到<span class=\"token operator\">%</span>windir<span class=\"token operator\">%</span>\\system32\\drivers</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>MiniFilter<span class=\"token punctuation\">.</span>DriverFiles  <span class=\"token operator\">=</span> <span class=\"token number\">12</span>   </pre></td></tr><tr><td data-num=\"13\"></td><td><pre></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token punctuation\">;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token punctuation\">;</span><span class=\"token punctuation\">;</span> Default install sections</pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token punctuation\">;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre></pre></td></tr><tr><td data-num=\"18\"></td><td><pre><span class=\"token punctuation\">[</span>DefaultInstall<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>OptionDesc          <span class=\"token operator\">=</span> <span class=\"token operator\">%</span>ServiceDescription<span class=\"token operator\">%</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>CopyFiles           <span class=\"token operator\">=</span> MiniFilter<span class=\"token punctuation\">.</span>DriverFiles</pre></td></tr><tr><td data-num=\"21\"></td><td><pre></pre></td></tr><tr><td data-num=\"22\"></td><td><pre><span class=\"token punctuation\">[</span>DefaultInstall<span class=\"token punctuation\">.</span>Services<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>AddService          <span class=\"token operator\">=</span> <span class=\"token operator\">%</span>ServiceName<span class=\"token operator\">%</span><span class=\"token punctuation\">,</span><span class=\"token punctuation\">,</span>MiniFilter<span class=\"token punctuation\">.</span>Service</pre></td></tr><tr><td data-num=\"24\"></td><td><pre></pre></td></tr><tr><td data-num=\"25\"></td><td><pre><span class=\"token punctuation\">;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre><span class=\"token punctuation\">;</span><span class=\"token punctuation\">;</span> Default uninstall sections</pre></td></tr><tr><td data-num=\"27\"></td><td><pre><span class=\"token punctuation\">;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre></pre></td></tr><tr><td data-num=\"29\"></td><td><pre><span class=\"token punctuation\">[</span>DefaultUninstall<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>DelFiles   <span class=\"token operator\">=</span> MiniFilter<span class=\"token punctuation\">.</span>DriverFiles</pre></td></tr><tr><td data-num=\"31\"></td><td><pre></pre></td></tr><tr><td data-num=\"32\"></td><td><pre><span class=\"token punctuation\">[</span>DefaultUninstall<span class=\"token punctuation\">.</span>Services<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>DelService <span class=\"token operator\">=</span> <span class=\"token operator\">%</span>ServiceName<span class=\"token operator\">%</span><span class=\"token punctuation\">,</span><span class=\"token number\">0x200</span>      <span class=\"token punctuation\">;</span>标识服务停止后才删除</pre></td></tr><tr><td data-num=\"34\"></td><td><pre></pre></td></tr><tr><td data-num=\"35\"></td><td><pre><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre><span class=\"token punctuation\">;</span> Services Section</pre></td></tr><tr><td data-num=\"37\"></td><td><pre><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre></pre></td></tr><tr><td data-num=\"39\"></td><td><pre><span class=\"token punctuation\">[</span>MiniFilter<span class=\"token punctuation\">.</span>Service<span class=\"token punctuation\">]</span>                 <span class=\"token punctuation\">;</span>服务的一些信息</pre></td></tr><tr><td data-num=\"40\"></td><td><pre>DisplayName      <span class=\"token operator\">=</span> <span class=\"token operator\">%</span>ServiceName<span class=\"token operator\">%</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>Description      <span class=\"token operator\">=</span> <span class=\"token operator\">%</span>ServiceDescription<span class=\"token operator\">%</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>ServiceBinary    <span class=\"token operator\">=</span> <span class=\"token operator\">%</span><span class=\"token number\">12</span><span class=\"token operator\">%</span>\\<span class=\"token operator\">%</span>DriverName<span class=\"token operator\">%</span><span class=\"token punctuation\">.</span>sys        <span class=\"token punctuation\">;</span><span class=\"token operator\">%</span>windir<span class=\"token operator\">%</span>\\system32\\drivers\\</pre></td></tr><tr><td data-num=\"43\"></td><td><pre>Dependencies     <span class=\"token operator\">=</span> <span class=\"token string\">\"FltMgr\"</span>                     <span class=\"token punctuation\">;</span>服务的依赖</pre></td></tr><tr><td data-num=\"44\"></td><td><pre>ServiceType      <span class=\"token operator\">=</span> <span class=\"token number\">2</span>                            <span class=\"token punctuation\">;</span>SERVICE_FILE_SYSTEM_DRIVER</pre></td></tr><tr><td data-num=\"45\"></td><td><pre>StartType        <span class=\"token operator\">=</span> <span class=\"token number\">3</span>                            <span class=\"token punctuation\">;</span>SERVICE_DEMAND_START</pre></td></tr><tr><td data-num=\"46\"></td><td><pre>ErrorControl     <span class=\"token operator\">=</span> <span class=\"token number\">1</span>                            <span class=\"token punctuation\">;</span>SERVICE_ERROR_NORMAL</pre></td></tr><tr><td data-num=\"47\"></td><td><pre>LoadOrderGroup   <span class=\"token operator\">=</span> <span class=\"token string\">\"FSFilter Activity Monitor\"</span>  <span class=\"token punctuation\">;</span>文件过滤分组</pre></td></tr><tr><td data-num=\"48\"></td><td><pre>AddReg           <span class=\"token operator\">=</span> MiniFilter<span class=\"token punctuation\">.</span>AddRegistry       <span class=\"token punctuation\">;</span>文件过滤注册表需要添加的高度值等信息</pre></td></tr><tr><td data-num=\"49\"></td><td><pre></pre></td></tr><tr><td data-num=\"50\"></td><td><pre><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre><span class=\"token punctuation\">;</span> Registry Modifications</pre></td></tr><tr><td data-num=\"52\"></td><td><pre><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre></pre></td></tr><tr><td data-num=\"54\"></td><td><pre><span class=\"token punctuation\">[</span>MiniFilter<span class=\"token punctuation\">.</span>AddRegistry<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre>HKR<span class=\"token punctuation\">,</span><span class=\"token punctuation\">,</span><span class=\"token string\">\"DebugFlags\"</span><span class=\"token punctuation\">,</span><span class=\"token number\">0x00010001</span> <span class=\"token punctuation\">,</span><span class=\"token number\">0x0</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>HKR<span class=\"token punctuation\">,</span><span class=\"token string\">\"Instances\"</span><span class=\"token punctuation\">,</span><span class=\"token string\">\"DefaultInstance\"</span><span class=\"token punctuation\">,</span><span class=\"token number\">0x00000000</span><span class=\"token punctuation\">,</span><span class=\"token operator\">%</span>DefaultInstance<span class=\"token operator\">%</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre>HKR<span class=\"token punctuation\">,</span><span class=\"token string\">\"Instances\\\"%Instance1.Name%,\"</span>Altitude\"<span class=\"token punctuation\">,</span><span class=\"token number\">0x00000000</span><span class=\"token punctuation\">,</span><span class=\"token operator\">%</span>Instance1<span class=\"token punctuation\">.</span>Altitude<span class=\"token operator\">%</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre>HKR<span class=\"token punctuation\">,</span><span class=\"token string\">\"Instances\\\"%Instance1.Name%,\"</span>Flags\"<span class=\"token punctuation\">,</span><span class=\"token number\">0x00010001</span><span class=\"token punctuation\">,</span><span class=\"token operator\">%</span>Instance1<span class=\"token punctuation\">.</span>Flags<span class=\"token operator\">%</span></pre></td></tr><tr><td data-num=\"59\"></td><td><pre></pre></td></tr><tr><td data-num=\"60\"></td><td><pre><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"61\"></td><td><pre><span class=\"token punctuation\">;</span> Copy Files</pre></td></tr><tr><td data-num=\"62\"></td><td><pre><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"63\"></td><td><pre></pre></td></tr><tr><td data-num=\"64\"></td><td><pre><span class=\"token punctuation\">[</span>MiniFilter<span class=\"token punctuation\">.</span>DriverFiles<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"65\"></td><td><pre><span class=\"token operator\">%</span>DriverName<span class=\"token operator\">%</span><span class=\"token punctuation\">.</span>sys</pre></td></tr><tr><td data-num=\"66\"></td><td><pre></pre></td></tr><tr><td data-num=\"67\"></td><td><pre><span class=\"token punctuation\">[</span>SourceDisksFiles<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"68\"></td><td><pre>passthrough<span class=\"token punctuation\">.</span>sys <span class=\"token operator\">=</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"69\"></td><td><pre></pre></td></tr><tr><td data-num=\"70\"></td><td><pre><span class=\"token punctuation\">[</span>SourceDisksNames<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"71\"></td><td><pre><span class=\"token number\">1</span> <span class=\"token operator\">=</span> <span class=\"token operator\">%</span>DiskId1<span class=\"token operator\">%</span><span class=\"token punctuation\">,</span><span class=\"token punctuation\">,</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"72\"></td><td><pre></pre></td></tr><tr><td data-num=\"73\"></td><td><pre><span class=\"token punctuation\">;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"74\"></td><td><pre><span class=\"token punctuation\">;</span><span class=\"token punctuation\">;</span> String Section</pre></td></tr><tr><td data-num=\"75\"></td><td><pre><span class=\"token punctuation\">;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"76\"></td><td><pre></pre></td></tr><tr><td data-num=\"77\"></td><td><pre><span class=\"token punctuation\">[</span>Strings<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"78\"></td><td><pre>Msft                    <span class=\"token operator\">=</span> <span class=\"token string\">\"Microsoft Corporation\"</span></pre></td></tr><tr><td data-num=\"79\"></td><td><pre>ServiceDescription      <span class=\"token operator\">=</span> <span class=\"token string\">\"NPminifilter Mini-Filter Driver\"</span></pre></td></tr><tr><td data-num=\"80\"></td><td><pre>ServiceName             <span class=\"token operator\">=</span> <span class=\"token string\">\"NPminifilter\"</span></pre></td></tr><tr><td data-num=\"81\"></td><td><pre>DriverName              <span class=\"token operator\">=</span> <span class=\"token string\">\"NPminifilter\"</span></pre></td></tr><tr><td data-num=\"82\"></td><td><pre>DiskId1                 <span class=\"token operator\">=</span> <span class=\"token string\">\"NPminifilter Device Installation Disk\"</span></pre></td></tr><tr><td data-num=\"83\"></td><td><pre></pre></td></tr><tr><td data-num=\"84\"></td><td><pre><span class=\"token punctuation\">;</span>Instances specific information<span class=\"token punctuation\">.</span></pre></td></tr><tr><td data-num=\"85\"></td><td><pre>DefaultInstance         <span class=\"token operator\">=</span> <span class=\"token string\">\"NPminifilter Instance\"</span></pre></td></tr><tr><td data-num=\"86\"></td><td><pre>Instance1<span class=\"token punctuation\">.</span>Name          <span class=\"token operator\">=</span> <span class=\"token string\">\"NPminifilter Instance\"</span></pre></td></tr><tr><td data-num=\"87\"></td><td><pre>Instance1<span class=\"token punctuation\">.</span>Altitude      <span class=\"token operator\">=</span> <span class=\"token string\">\"370030\"</span></pre></td></tr><tr><td data-num=\"88\"></td><td><pre>Instance1<span class=\"token punctuation\">.</span>Flags         <span class=\"token operator\">=</span> <span class=\"token number\">0x0</span>              <span class=\"token punctuation\">;</span> Allow all attachments</pre></td></tr></table></figure><p>接下来先简单了解一下</p>\n<p><code>StartType</code>  被称为启动类型。  <code>StartType</code>  为  <code>3</code>  即  <code>DEMAND_START</code> ，<em>表示当有需求加载时才启动此驱动的功能</em>；<br />\n <code>StartType</code>  为  <code>0</code>  即  <code>BOOT_START</code> ， 表示计算机开机启动时就自动加载此驱动的功能。</p>\n<p>根据上面的 INF 文件可以看出， 此驱动文件是依附于  <code>FltMgr</code>  服务的。</p>\n<p><code>Altitude</code>  是微过滤器的层级码。 层级码决定过滤层次的上下。</p>\n<p><em>根据微软的文档， 微过滤器的层级码范围是多个以数字标识的范围区段（例如： 20000~429999） ， 正式的商业软件的层级码是需要向微软申请注册的</em>。 例如， 许多防毒软件都要向微软申请一个特定的层级码， 不过我们在测试时可以先给出这个范围内的一个值， 这里先定义为  <code>370030</code> ， 也就是本章示例的微过滤器在过滤层中的位置。这个可是去微软官方 &lt; <span class=\"exturl\" data-url=\"aHR0cHM6Ly9tc2RuLm1pY3Jvc29mdC5jb20vZW4tdXMvd2luZG93cy9oYXJkd2FyZS9kcml2ZXJzL2lmcy9sb2FkLW9yZGVyLWdyb3Vwcy1hbmQtYWx0aXR1ZGVzLWZvci1taW5pZmlsdGVyLWRyaXZlcnM=\">https://msdn.microsoft.com/en-us/windows/hardware/drivers/ifs/load-order-groups-and-altitudes-for-minifilter-drivers</span>&gt; 查找。</p>\n<p>编写这个 INF 文件后， 测试时只要跟  <code>Minifilter.sys</code>  放在同一个目录下， 通过鼠标右键选择 INF 菜单 “安装”， 便可以成功将 Minifilter 安装到系统目录下， 安装完毕也可以去  <code>%windir%\\system32\\drivers</code>  下查看这个文件是否存在。 另外， 也可以使用  <code>OSR driverloader</code>  来检查已经安装的 Minifilter 在系统上的  <code>Load Group</code>  顺序</p>\n<p>修改上面的  <code>[Strings]</code>  节就可以成为不同的驱动程序的 INF 文件。 比如本书的例子， 服务名为  <code>NPminifilter</code> ， 驱动名为  <code>NPMinifilter.sys</code> ， 那么把这一节改为：</p>\n<figure class=\"highlight raw\"><figcaption data-lang=\"\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>[Strings]</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>Msft                    &#x3D; &quot;Microsoft Corporation&quot;</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>ServiceDescription      &#x3D; &quot;NPminifilter Mini-Filter Driver&quot;</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>ServiceName             &#x3D; &quot;NPminifilter&quot;</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>DriverName              &#x3D; &quot;NPminifilter&quot;</pre></td></tr></table></figure><p>也就是说修改此节中的这些部分就可以了。</p>\n<h1 id=\"扩展\"><a class=\"anchor\" href=\"#扩展\">#</a> 扩展</h1>\n<ol>\n<li>INF 安装与普通的驱动安装方法有什么区别？是否可以代码实现 inf 安装？</li>\n<li>模仿写一个类似的：<span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cuNTJwb2ppZS5jbi90aHJlYWQtMTMxNDA5Ni0xLTEuaHRtbA==\">https://www.52pojie.cn/thread-1314096-1-1.html</span></li>\n<li>了解  <code>OSR driverloader</code>  是如何获取系统中的  <code>Load Group</code> 。</li>\n</ol>\n",
            "tags": [
                "Minifilter"
            ]
        },
        {
            "id": "https://or0kit.github.io/Bin/Core/Drive-Development/%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E7%9A%84%E8%BF%87%E6%BB%A4%E4%B8%8E%E7%9B%91%E6%8E%A7/",
            "url": "https://or0kit.github.io/Bin/Core/Drive-Development/%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E7%9A%84%E8%BF%87%E6%BB%A4%E4%B8%8E%E7%9B%91%E6%8E%A7/",
            "title": "文件系统的过滤与监控",
            "date_published": "2022-08-04T08:12:26.000Z",
            "content_html": "<h1 id=\"文件系统的过滤与监控简介\"><a class=\"anchor\" href=\"#文件系统的过滤与监控简介\">#</a> 文件系统的过滤与监控简介</h1>\n<p>开始学习<strong>复杂的文件系统过滤</strong>。</p>\n<p>文件系统过滤的目标，<strong>是捕获 Windows 系统对文件的种种操作行为</strong>，比如文件的<em>创建、打开、读 / 写、改名，目录的创建、打开、枚举、改名、删除等</em>。捕获对文件的操作，并对其进行过滤，能实现许多强大的功能，比如检查病毒、数据加密、数据备份、安全监控等。</p>\n<p>文件系统过滤比串口、键盘、硬盘都更加复杂，这主要源于文件系统的复杂性。串口基本上只需要发送和接收数据就可以了，键盘只需要等待按键即可，硬盘最重要的操作也只有两种：读数据和写数据；而文件系统则不同。</p>\n<p>请不要把文件系统驱动和存储驱动混淆。<em>硬盘是典型的存储设备，只负责数据的读与写</em>；而文件系统则不管数据是如何读 / 写到硬盘（或者其他设备）上的，<em>它只负责将数据在硬盘的平坦空间内组织成文件和目录</em>。</p>\n<p><strong>文件和目录都是很复杂的信息集合。一个文件至少要有文件名、内容、大小、各种属性等，这些信息在硬盘实际空间中的保存结构和组织方式极其复杂。此外还有目录，目录是可以嵌套的。一个目录的删除、移动都涉及其下所有的子目录和文件的删除、移动。因此，文件系统本身是极为复杂的系统，文件系统的过滤也尤为复杂。</strong></p>\n<p><em>一般地说，如果一个功能能在存储设备的层次上完成，那么就让它在存储设备的层次上完成，这比在文件系统上完成要简单得多。有些人为了加密硬盘或者为了实现硬盘还原而研究文件系统过滤。实际上没有必要，因为存储设备过滤就足以解决这样的问题了。</em></p>\n<p>但是一旦要求区分目录（比如要求指定某个目录下的文件可以加密）或者有其他的牵涉到文件系统的要求，存储设备驱动过滤就很难解决问题了，此时只能进行文件系统过滤。</p>\n<p>将文件系统过滤应用于实时监控的防毒软件最为典型。防毒软件一般都带有文件系统过滤驱动，当 Windows 上任何软件试图写一个文件的时候，防毒软件都会过滤其写入的内容，检查其中是否有病毒的特征码。</p>\n<p>此外，还有一些其他的应用，如<em>文件或者目录的还原、隐藏、转向、文件系统透明加密</em>等。</p>\n<h1 id=\"文件系统的设备对象\"><a class=\"anchor\" href=\"#文件系统的设备对象\">#</a> 文件系统的设备对象</h1>\n<p>在 Windows 上，大家熟知的两种文件系统是 FAT32 和 NTFS。<br />\nFAT32 的驱动在 Windows 下叫作 <code>fastfat.sys</code> ，NTFS 的驱动在 Windows 下叫作 <code>ntfs.sys</code> 。这两个文件都在 Windows 系统目录中的 drivers 目录下。</p>\n<p>文件系统过滤虽然复杂，但是基本方法还是一样的，<em>就是生成过滤设备对象来绑定真实的设备对象</em>。</p>\n<p>为此，<strong>先了解一下文件系统驱动会生成哪些设备对象</strong>。</p>\n<h2 id=\"控制设备与卷设备\"><a class=\"anchor\" href=\"#控制设备与卷设备\">#</a> 控制设备与卷设备</h2>\n<p>首先了解什么是<em>控制设备</em>和<em>卷设备</em>。</p>\n<p>像 FAT32、NTFS 这样的文件系统（File System，FS），主要生成两类设备。<br />\n首先文件系统驱动本身往往生成一个 <code>控制设备（CDO）</code> ，这个设备的主要任务是<em>修改整个驱动的内部配置</em>。因此，<strong>一个文件系统只对应一个 CDO</strong>。</p>\n<p>另一种设备是这个文件系统的 <code>卷设备</code> 。 一般 <code>一个卷对应一个逻辑盘</code> 。</p>\n<p>一个 FS 可能有多个加载的卷， 也可能一个都没有。 例如， 如果计算机上有 C:、 D:、E:、 F: 4 个逻辑盘， 则有 4 个卷设备。 实际上， “C:” 是设备的符号链接（Symbolic Link）名， 而不是真正的设备名。 如果读者安装有专门查看符号链接的工具 Symbolic LinksViewer， 则可以看到： “C:” 这个符号链接名对应的设备名是 <code>“\\Device\\HarddiskVolume1”</code> ，因此该设备的设备真名为 <code>“\\Device\\HarddiskVolume1”</code> 。</p>\n<p>请注意这个卷设备本身并不是文件系统驱动生成的， 而是卷管理器生成的。 但是当有一个卷使用了某种文件系统时， 该文件系统会对应地为该设备生成一个没有名字的设备对象， 本章将其称为文件系统的卷设备。</p>\n<p>本章中所说的 “卷设备” 都是特指文件系统的卷设备， 并常常用真正的卷设备的符号链接或者名字来称呼它们。</p>\n<p>比如：如果 <code>C:</code> 、  <code>D:</code>  为 NTFS；  <code>E:</code> 、  <code>F:</code>  为 FAT32， 那么 <code>E:</code> 、  <code>F:</code>  则是 FAT32 的两个卷设备对象； 而 <code>C:</code> 、  <code>D:</code>  为 NTFS 的两个卷设备对象。</p>\n<p>但是这只是一种称呼。 实际上， 如果按照前面的方法去打开设备 <code>“\\Device\\HarddiskVolume1”</code> ， 然后绑定是不对的， 因为这样并没有绑定文件系统生成的卷设备， 而是绑定了一个真正的卷设备。  <code>所以绑定文件系统的卷设备， 并不是用名字来解决的（那些设备是没有名字的）</code> 。</p>\n<p>同时， 从这里也可以看出来， 文件系统驱动是针对每个卷来生成一个设备对象， 而不是针对每个文件的。 实际上，对文件读 / 写的 IRP，都发到卷设备对象上了， 并不会生成一个 “文件设备对象”。</p>\n<p>需要关心的就是以上两类设备（控制设备和卷设备）。</p>\n<p>发送给<strong>控制设备的请求（IRP）一般是文件系统控制 IRP</strong>（主功能号为 <code>IRP_MJ_FILE_SYSTEM_CONTROL</code> ）；而发送给<strong>卷设备的 IRP 则一般是文件操作 IRP</strong>。</p>\n<hr />\n<p><em>过滤最终是为了得到文件操作 IRP， 但是控制设备的 IRP 一般用来捕获卷设备的生成信息</em>。 换句话说，<strong>最终目标是绑定文件系统的卷设备， 但前提是先绑定文件系统控制设备</strong>。</p>\n<p>这里的代码都以 WDK 中的 sfilter 为例， WDK 目录下的 <code>\\src\\filesys\\filter\\sfilter</code>  中有完整的代码。</p>\n<p>看雪一个大佬的在十年前就发了一个中文注释的版本，这里附上链接：<span class=\"exturl\" data-url=\"aHR0cHM6Ly9iYnMucGVkaXkuY29tL3RocmVhZC0xNTIzMzguaHRt\">https://bbs.pediy.com/thread-152338.htm</span>，其文章最后的评论中有代码的下载链接。</p>\n<p>书中的代码是以一个点进行切入学习的，刚开始的时候并不全。</p>\n<h2 id=\"生成自己的一个控制设备\"><a class=\"anchor\" href=\"#生成自己的一个控制设备\">#</a> 生成自己的一个控制设备</h2>\n<p>首先是 DriverEntry。 进入的第一步是生成这个驱动自己使用的 CDO， 这一步非常重要， 因为<em>文件过滤驱动往往必须和外界的应用程序通信</em>（比如杀毒软件的过滤驱动必须把发现的信息告诉有界面的应用程序部分） ， 通信的主要接口就是这个<em>控制设备</em>。</p>\n<p><em>在文件过滤中， 唯一不同的是， 控制设备按照惯例应该生成在 “\\FileSystem\\Filters\\” 下， 但是这个路径是后来才出现的， 在一些早期版本的 Windows 系统中， 这个路径可能不存在。 此时， 改为生成在 “\\FileSystem\\” 目录下即可。</em></p>\n<p>先以此代码为基础进行学习。</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>NTSTATUS </pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token function\">DriverEntry</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>\tPDRIVER_OBJECT pDriverObject<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>\tPUNICODE_STRING pRegPath</pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>\tUNICODE_STRING nameString<span class=\"token punctuation\">;</span>\t\t\t<span class=\"token comment\">// 定义名字串结构变量</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>\tNTSTATUS status<span class=\"token punctuation\">;</span>\t\t\t\t\t<span class=\"token comment\">// 状态码</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\t<span class=\"token function\">RtlInitUnicodeString</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>nameString<span class=\"token punctuation\">,</span> L<span class=\"token string\">\"\\\\FileSystem\\\\Filters\\\\SFilter\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>\t<span class=\"token comment\">// 生成控制设备</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>\tstatus <span class=\"token operator\">=</span> <span class=\"token function\">IoCreateDevice</span><span class=\"token punctuation\">(</span>pDriverObject<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>\t\t<span class=\"token number\">0</span><span class=\"token punctuation\">,</span>\t\t\t\t\t\t\t\t\t\t\t\t<span class=\"token comment\">// 没有 设备扩展 </span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>\t\t<span class=\"token operator\">&amp;</span>nameString<span class=\"token punctuation\">,</span>\t\t\t\t\t\t\t\t\t<span class=\"token comment\">// 设备名:   FileSystem\\\\Filters\\\\SFilter</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>\t\tFILE_DEVICE_DISK_FILE_SYSTEM<span class=\"token punctuation\">,</span>\t\t\t\t\t<span class=\"token comment\">// 设备类型：磁盘文件系统</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>\t\tFILE_DEVICE_SECURE_OPEN<span class=\"token punctuation\">,</span>\t\t\t\t\t\t<span class=\"token comment\">// 设备特征：对发送到 CDO 的打开请求进行安全检查</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>\t\tFALSE<span class=\"token punctuation\">,</span>\t\t\t\t\t\t\t\t\t\t\t<span class=\"token comment\">// 生成一个在用户模式下使用的设备</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>\t\t<span class=\"token operator\">&amp;</span>gSFilterControlDeviceObject<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\t\t\t\t\t<span class=\"token comment\">// 接收生成的 \"控制设备对象\"</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre></pre></td></tr><tr><td data-num=\"22\"></td><td><pre></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>status <span class=\"token operator\">==</span> STATUS_OBJECT_PATH_NOT_FOUND<span class=\"token punctuation\">)</span>\t\t\t\t\t\t\t\t<span class=\"token comment\">// 判断是否 未找到路径</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>\t\t<span class=\"token function\">RtlInitUnicodeString</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>nameString<span class=\"token punctuation\">,</span> L<span class=\"token string\">\"\\\\FileSystem\\\\SFilterCDO\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\t\t<span class=\"token comment\">// 重新创建 控制设备名称 </span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>\t\tstatus <span class=\"token operator\">=</span> <span class=\"token function\">IoCreateDevice</span><span class=\"token punctuation\">(</span>pDriverObject<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>\t\t\t<span class=\"token operator\">&amp;</span>nameString<span class=\"token punctuation\">,</span>\t\t\t\t\t\t\t\t\t\t\t<span class=\"token comment\">// 设备名: FileSystem\\\\SFilterCDO</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>\t\t\tFILE_DEVICE_DISK_FILE_SYSTEM<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>\t\t\tFILE_DEVICE_SECURE_OPEN<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>\t\t\tFALSE<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>\t\t\t<span class=\"token operator\">&amp;</span>gSFilterControlDeviceObject<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\t\t\t\t\t\t\t<span class=\"token comment\">// 接收生成的 控制设备对象 </span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre></pre></td></tr><tr><td data-num=\"33\"></td><td><pre></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>\t\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token function\">NT_SUCCESS</span><span class=\"token punctuation\">(</span>status<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t<span class=\"token comment\">// 判断 IoCreateDevice 调用是否成功</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>\t\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>\t\t\t<span class=\"token function\">KdPrint</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"SFilter!DriverEntry: Error creating control device object \\\"%wZ\\\", status=%08x\\n\"</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>nameString<span class=\"token punctuation\">,</span> status<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>\t\t\t<span class=\"token keyword\">return</span> status<span class=\"token punctuation\">;</span>\t\t<span class=\"token comment\">// 错误返回 (创建 CDO 失败)</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>\t<span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token function\">NT_SUCCESS</span><span class=\"token punctuation\">(</span>status<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>\t\t<span class=\"token comment\">// 如果路径正确但生成控制设备失败，也打印一个 log，并直接返回错误</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>\t\t<span class=\"token function\">KdPrint</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"SFilter!DriverEntry:Error creating control device object \\\"%wZ\\\",status=%08x\\n\"</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>nameString<span class=\"token punctuation\">,</span> status<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>\t\t<span class=\"token keyword\">return</span> status<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre></pre></td></tr><tr><td data-num=\"47\"></td><td><pre></pre></td></tr><tr><td data-num=\"48\"></td><td><pre></pre></td></tr><tr><td data-num=\"49\"></td><td><pre></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>\t<span class=\"token keyword\">return</span> STATUS_SUCCESS<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>这段代码只能生成一个控制设备， 还没有对文件系统已有的设备对象进行绑定。</p>\n<p>接下来继续学习文件系统过滤所需要注意的分发函数。</p>\n<h1 id=\"文件系统的分发函数\"><a class=\"anchor\" href=\"#文件系统的分发函数\">#</a> 文件系统的分发函数</h1>\n<p>在学习分发函数之前先看两个后面会用到的宏：</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">// 宏定义: IS_MY_DEVICE_OBJECT (指向设备对象的指针); 意义: (指针≠NULL) 且 (设备对象的 DriverObject 是 gSFilterDriverObject) 且 (设备对象的 DeviceExtension≠NULL)</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name function\">IS_MY_DEVICE_OBJECT</span><span class=\"token expression\"><span class=\"token punctuation\">(</span>_devObj<span class=\"token punctuation\">)</span>  <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>_devObj<span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>_devObj<span class=\"token punctuation\">)</span><span class=\"token operator\">-></span>DriverObject <span class=\"token operator\">==</span> gSFilterDriverObject<span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>_devObj<span class=\"token punctuation\">)</span><span class=\"token operator\">-></span>DeviceExtension <span class=\"token operator\">!=</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></span></span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token comment\">// 宏定义：测试是不是我的 \"控制设备对象\"</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name function\">IS_MY_CONTROL_DEVICE_OBJECT</span><span class=\"token expression\"><span class=\"token punctuation\">(</span>_devObj<span class=\"token punctuation\">)</span>  <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>_devObj<span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> gSFilterControlDeviceObject<span class=\"token punctuation\">)</span> <span class=\"token operator\">?</span> <span class=\"token punctuation\">(</span><span class=\"token function\">ASSERT</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>_devObj<span class=\"token punctuation\">)</span><span class=\"token operator\">-></span>DriverObject <span class=\"token operator\">==</span> gSFilterDriverObject<span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>_devObj<span class=\"token punctuation\">)</span><span class=\"token operator\">-></span>DeviceExtension <span class=\"token operator\">==</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> TRUE<span class=\"token punctuation\">)</span> <span class=\"token operator\">:</span> FALSE<span class=\"token punctuation\">)</span></span></span></pre></td></tr></table></figure><p>这两个宏都借助了我们的全局 CDO 变量 <code>gSFilterControlDeviceObject</code> 。</p>\n<h2 id=\"普通的分发函数\"><a class=\"anchor\" href=\"#普通的分发函数\">#</a> 普通的分发函数</h2>\n<p>上一节仅仅生成了控制设备对象， 开发文件过滤驱动的主要工作还是撰写分发函数。在上面的代码中，  <code>DriverObject</code>  是从 <code>DriverEntry</code>  中传入的驱动对象指针， 现在来指定几个分发函数。  <code>SfPassThrough</code>  负责所有不需要处理、 直接下发到下层驱动的 IRP。</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">// 注册默认派遣函数</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>\t<span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span>i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;=</span> IRP_MJ_MAXIMUM_FUNCTION<span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>\t\tDriverObject<span class=\"token operator\">-></span>MajorFunction<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> SfPassThrough<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>作为过滤驱动， 一些特殊的分发函数必须受到特殊的处理。</p>\n<p>其中主要包括：</p>\n<ol>\n<li>\n<p>打开请求（主功能号为 <code>IRP_MJ_CREATE</code> ， 但本章中还包括另外两种主功能号：  <code>IRP_MJ_CREATE_NAMED_PIPE</code>  和 <code>IRP_MJ_CREATE_MAILSLOT</code> ）。</p>\n</li>\n<li>\n<p>文件系统控制请求（这种请求仅在文件系统过滤中出现， 主功能号为 <code>IRP_MJ_FILE_SYSTEM_ CONTROL</code> ） 、 清理请求（ <code>IRP_MJ_CLEANUP</code> ） 和关闭请求（ <code>IRP_MJ_CLOSE</code> ） 。</p>\n</li>\n</ol>\n<p>这些 IRP 对文件系统来说都很关键。 为此， 给予它们单独的分发函数，</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">// 注册具体派遣函数</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>DriverObject<span class=\"token operator\">-></span>MajorFunction<span class=\"token punctuation\">[</span>IRP_MJ_CREATE<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> SfCreate<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>DriverObject<span class=\"token operator\">-></span>MajorFunction<span class=\"token punctuation\">[</span>IRP_MJ_CREATE_NAMED_PIPE<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> SfCreate<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>DriverObject<span class=\"token operator\">-></span>MajorFunction<span class=\"token punctuation\">[</span>IRP_MJ_CREATE_MAILSLOT<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> SfCreate<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>DriverObject<span class=\"token operator\">-></span>MajorFunction<span class=\"token punctuation\">[</span>IRP_MJ_FILE_SYSTEM_CONTROL<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> SfFsControl<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>DriverObject<span class=\"token operator\">-></span>MajorFunction<span class=\"token punctuation\">[</span>IRP_MJ_CLEANUP<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> SfCleanupClose<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>DriverObject<span class=\"token operator\">-></span>MajorFunction<span class=\"token punctuation\">[</span>IRP_MJ_CLOSE<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> SfCleanupClose<span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>至于过滤中最简单的处理， 当然就是不做任何处理， 直接下发了。</p>\n<p>下面是 <code>SfPassThrough</code>  函数：</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>NTSTATUS  <span class=\"token function\">SfPassThrough</span><span class=\"token punctuation\">(</span>IN PDEVICE_OBJECT DeviceObject<span class=\"token punctuation\">,</span> IN PIRP Irp<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  <span class=\"token comment\">// ASSERT 宏只在调试版本中编译才有意义，在发行版本中编译时不起任何作用。</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  <span class=\"token comment\">// 测试是不是是我的 \"控制设备对象\"</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>\t<span class=\"token function\">ASSERT</span><span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token function\">IS_MY_CONTROL_DEVICE_OBJECT</span><span class=\"token punctuation\">(</span>DeviceObject<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  <span class=\"token comment\">// IS_MY_DEVICE_OBJECT (指向设备对象的指针); 意义: (指针≠NULL) 且 (设备对象的 DriverObject 是 gSFilterDriverObject) 且 (设备对象的 DeviceExtension≠NULL)</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\t<span class=\"token function\">ASSERT</span><span class=\"token punctuation\">(</span><span class=\"token function\">IS_MY_DEVICE_OBJECT</span><span class=\"token punctuation\">(</span>DeviceObject<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  <span class=\"token comment\">// 直接下发 IRP</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>\t<span class=\"token function\">IoSkipCurrentIrpStackLocation</span><span class=\"token punctuation\">(</span>Irp<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>\t<span class=\"token keyword\">return</span> <span class=\"token function\">IoCallDriver</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>PSFILTER_DEVICE_EXTENSION<span class=\"token punctuation\">)</span>DeviceObject<span class=\"token operator\">-></span>DeviceExtension<span class=\"token punctuation\">)</span><span class=\"token operator\">-></span>AttachedToDeviceObject<span class=\"token punctuation\">,</span> Irp<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>这两个 ASSERT 是来确认两个事实：</p>\n<p>（1） 进入 <code>SfPassThrough</code>  例程的 IRP 不是发送给本驱动的控制设备的。 因为这个驱动的控制设备是自己生成用来通信的， 所以它没有下层真实设备， 它所有的 IRP 都必须由本驱动自己处理。 因此发送给自己控制设备的 IRP 如果进入了 <code>SfPassThrough</code>  例程， 将产生一个致命的错误。</p>\n<p>（2） 这个 <code>DeviceObject</code>  是本驱动生成的过滤设备。 如果这个 <code>DeviceObject</code>  不是本驱动生成的过滤设备， 那么也不会有一个类型为 <code>SFILTER_DEVICE_EXTENSION</code>  的设备扩展， 且下面 <code>将AttachedToDeviceObject</code>  作为真实设备也是错误的。</p>\n<p>到这里为止都还没有讨论如何生成过滤设备（只生成了一个简单的控制设备） ，也没有谈及过滤设备的设备扩展。 在后面会看到相关信息， 在这里不需要深究。</p>\n<p><em>在内核编程中， 虽然极力仔细地编程， 但各种未能预料的结果依然是随时可能发生的。 如果认为一个现象不应该发生， 那么加上一个 ASSERT 来确认是个好习惯。 因为一旦不该发生的事情发生了， ASSERT 马上就会报错。 错误报得越早， 查找问题的根源就越容易， 这样就能在调试版本阶段， 把很多潜在的错误挖掘出来。</em></p>\n<h2 id=\"文件过滤的快速io分发函数\"><a class=\"anchor\" href=\"#文件过滤的快速io分发函数\">#</a> 文件过滤的快速 IO 分发函数</h2>\n<p>由于这个驱动将要绑定到文件系统驱动的上边，文件系统出来正常的 IRP 之外，还要处理<strong>快速 IO</strong>（Fast I/O）；除了普通的分发函数之外，还得为驱动对象撰写另一组快速 IO 分发函数。 这组函数的指针在 driver-&gt;FastIoDispatch 中， 而且这里本来是没有空间的， 所以为了保存这一组指针， 必须自己分配空间。</p>\n<p>下面的代码使用 <code>ExAllocatePoolWithTag</code>  分配内存空间。</p>\n<p><code>ExAllocatePoolWithTag</code>  是 Windows 内核动态分配内存的常用函数（相当于标准 C 的 malloc）。<br />\n第一个参数是要分配的内存类型。 <strong>快速 IO 分发函数表必须在非分页内存空间中， 所以这里使用 <code>NonPagedPool</code> </strong>。<br />\n第二个参数表示要分配的缓冲区的长度。<br />\n第三个参数是任意填写的一个长整数， 作为这次分配的标记。 标记往往用于查找内存泄漏的错误。</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">// 处理 Fast I/O</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>\tPFAST_IO_DISPATCH fastIoDispatch<span class=\"token punctuation\">;</span>\t<span class=\"token comment\">// 定义 FAST_IO_DISPATCH 结构变量</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>\tfastIoDispatch <span class=\"token operator\">=</span> <span class=\"token function\">ExAllocatePoolWithTag</span><span class=\"token punctuation\">(</span>NonPagedPool<span class=\"token punctuation\">,</span>\t<span class=\"token comment\">// 从非分页池中分配</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>\t\t<span class=\"token keyword\">sizeof</span><span class=\"token punctuation\">(</span>FAST_IO_DISPATCH<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\t\t\t\t\t\t\t<span class=\"token comment\">// 要分配的字节数</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>\t\tSFLT_POOL_TAG<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\t\t\t\t\t\t\t\t\t\t<span class=\"token comment\">// 指定一个 4 字节的标签 (前面已宏定义:'tlFS')</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>fastIoDispatch<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\t\t<span class=\"token function\">IoDeleteDevice</span><span class=\"token punctuation\">(</span>gSFilterControlDeviceObject<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\t<span class=\"token comment\">// 删除上面创建的的 CDO</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>\t\t<span class=\"token keyword\">return</span> STATUS_INSUFFICIENT_NVRAM_RESOURCES<span class=\"token punctuation\">;</span>\t\t<span class=\"token comment\">// 返回一个错误的 status 码（资源不足）</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>\t<span class=\"token function\">RtlZeroMemory</span><span class=\"token punctuation\">(</span>fastIoDispatch<span class=\"token punctuation\">,</span> <span class=\"token keyword\">sizeof</span><span class=\"token punctuation\">(</span>FAST_IO_DISPATCH<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>\tfastIoDispatch<span class=\"token operator\">-></span>SizeOfFastIoDispatch <span class=\"token operator\">=</span> <span class=\"token keyword\">sizeof</span><span class=\"token punctuation\">(</span>FAST_IO_DISPATCH<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\t<span class=\"token comment\">// 设置 FastIo 分配表的长度域</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>\tfastIoDispatch<span class=\"token operator\">-></span>FastIoCheckIfPossible <span class=\"token operator\">=</span> SfFastIoCheckIfPossible<span class=\"token punctuation\">;</span>\t\t<span class=\"token comment\">// 设置 FastIo 分派函数，共 21 个</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>\tfastIoDispatch<span class=\"token operator\">-></span>FastIoRead <span class=\"token operator\">=</span> SfFastIoRead<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>\tfastIoDispatch<span class=\"token operator\">-></span>FastIoWrite <span class=\"token operator\">=</span> SfFastIoWrite<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>\tfastIoDispatch<span class=\"token operator\">-></span>FastIoQueryBasicInfo <span class=\"token operator\">=</span> SfFastIoQueryBasicInfo<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>\tfastIoDispatch<span class=\"token operator\">-></span>FastIoQueryStandardInfo <span class=\"token operator\">=</span> SfFastIoQueryStandardInfo<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>\tfastIoDispatch<span class=\"token operator\">-></span>FastIoLock <span class=\"token operator\">=</span> SfFastIoLock<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>\tfastIoDispatch<span class=\"token operator\">-></span>FastIoUnlockSingle <span class=\"token operator\">=</span> SfFastIoUnlockSingle<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>\tfastIoDispatch<span class=\"token operator\">-></span>FastIoUnlockAll <span class=\"token operator\">=</span> SfFastIoUnlockAll<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>\tfastIoDispatch<span class=\"token operator\">-></span>FastIoUnlockAllByKey <span class=\"token operator\">=</span> SfFastIoUnlockAllByKey<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>\tfastIoDispatch<span class=\"token operator\">-></span>FastIoDeviceControl <span class=\"token operator\">=</span> SfFastIoDeviceControl<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>\tfastIoDispatch<span class=\"token operator\">-></span>FastIoDetachDevice <span class=\"token operator\">=</span> SfFastIoDetachDevice<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>\tfastIoDispatch<span class=\"token operator\">-></span>FastIoQueryNetworkOpenInfo <span class=\"token operator\">=</span> SfFastIoQueryNetworkOpenInfo<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>\tfastIoDispatch<span class=\"token operator\">-></span>MdlRead <span class=\"token operator\">=</span> SfFastIoMdlRead<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>\tfastIoDispatch<span class=\"token operator\">-></span>MdlReadComplete <span class=\"token operator\">=</span> SfFastIoMdlReadComplete<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>\tfastIoDispatch<span class=\"token operator\">-></span>PrepareMdlWrite <span class=\"token operator\">=</span> SfFastIoPrepareMdlWrite<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>\tfastIoDispatch<span class=\"token operator\">-></span>MdlWriteComplete <span class=\"token operator\">=</span> SfFastIoMdlWriteComplete<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>\tfastIoDispatch<span class=\"token operator\">-></span>FastIoReadCompressed <span class=\"token operator\">=</span> SfFastIoReadCompressed<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>\tfastIoDispatch<span class=\"token operator\">-></span>FastIoWriteCompressed <span class=\"token operator\">=</span> SfFastIoWriteCompressed<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>\tfastIoDispatch<span class=\"token operator\">-></span>MdlReadCompleteCompressed <span class=\"token operator\">=</span> SfFastIoMdlReadCompleteCompressed<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>\tfastIoDispatch<span class=\"token operator\">-></span>MdlWriteCompleteCompressed <span class=\"token operator\">=</span> SfFastIoMdlWriteCompleteCompressed<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>\tfastIoDispatch<span class=\"token operator\">-></span>FastIoQueryOpen <span class=\"token operator\">=</span> SfFastIoQueryOpen<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>\tpDriverObject<span class=\"token operator\">-></span>FastIoDispatch <span class=\"token operator\">=</span> fastIoDispatch<span class=\"token punctuation\">;</span>\t\t\t\t\t\t<span class=\"token comment\">// 将 FastIo 分派表保存到驱动对象的 FastIoDispatch 域</span></pre></td></tr></table></figure><p>在了解快速 IO 分发函数时，可能会疑问为什么在前面的串口、 键盘和硬盘这些过滤程序中， 都没见过填写如此复杂的接口？</p>\n<p>实际上， 驱动对象结构 <code>DRIVER_OBJECT</code>  中既然有快速 IO 分发函数的设置接口， 那么从理论上讲， 所有的驱动对象都可以有快速 IO 分发函数 —— 只是它们可能根本不被调用。</p>\n<p>显然串口、 键盘的快速 IO 分发函数都不会被调用 ———— 在驱动里它们根本就没有被设置。</p>\n<p>但是文件系统不行， 如果不设置， 上层依然会调用， 而且会导致蓝屏。</p>\n<p>快速 IO 分发函数是独立于普通的处理 IRP 的分发函数之外的另一组接口。<br />\n但是它们的作用是一样的， 就是由驱动处理外部给予的请求， 而且所处理的请求也基本相同， 只是根本没有 IRP， 本来应该写在 IRP 中的参数， 直接通过函数的参数被传递进来了。 这可以减少分配 IRP 的效率消耗。</p>\n<p>文件系统的普通分发函数和快速 IO 分发函数都随时有可能被调用， 好的过滤驱动显然应该同时过滤这两套接口。</p>\n<p>但是， 一般资料都只介绍 IRP 过滤的方法， 快速 IO 分发函数非常复杂， 但是与 IRP 过滤是基本一一对应的， 只要了解了前者， 后者就很容易能够学<br />\n会。</p>\n<p>在开发的初期学习阶段， 有一个折中的简单方案： 可以简单地设置所有的快速 IO 分发函数返回 FALSE 并不做任何事， 这样这些请求都会通过 IRP 重新发送而被普通分发函数捕获。</p>\n<p>有一定的效率损失， 但并不是很大， 有文档曾表示： 效率的损失在 10% 以下。</p>\n<p>有些读者反复地询问笔者： “所有快速 IO 分发函数都返回 FALSE， 和细心地全部实现它们， 真的只有效率上的区别吗？ 会导致系统中未期望的结果吗？”</p>\n<p>笔者的回答是： 是的， 真的只有效率上的差别， 但是这个差别并不总是在 10% 以下（虽然也许 99% 的情况都在 10% 以下） 。</p>\n<p>笔者见过这样一种金蝶的 ERP 系统， 在安装了一个快速 IO 分发函数全部返回 FALSE 的文件系统过滤驱动的计算机上， 需要 15 分钟才能启<br />\n动完毕； 而当笔者完整地实现了一个关键的快速 IO 分发函数（不直接返回 FALSE， 而是完成其功能） 之后， 启动只需要 5 秒钟。 笔者仅见过这一次， 实现和不实现之间， 有可以察觉的效率差别。</p>\n<hr />\n<p>书上说了这么多，无非就是想让我们知道，快速 IO 分发函数是可以直接返回 FALSE。下面学习如何编写快速 IO 分发函数。</p>\n<h2 id=\"快速io分发函数的一个实现\"><a class=\"anchor\" href=\"#快速io分发函数的一个实现\">#</a> 快速 IO 分发函数的一个实现</h2>\n<p>下面就以上面的第一个函数为例， 来介绍一个 FastIo 过滤函数的 passthrough 的例子。</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>BOOLEAN <span class=\"token function\">SfFastIoCheckIfPossible</span><span class=\"token punctuation\">(</span>IN PFILE_OBJECT FileObject<span class=\"token punctuation\">,</span> IN PLARGE_INTEGER FileOffset<span class=\"token punctuation\">,</span> IN ULONG Length<span class=\"token punctuation\">,</span> IN BOOLEAN Wait<span class=\"token punctuation\">,</span> IN ULONG LockKey<span class=\"token punctuation\">,</span> IN BOOLEAN CheckForReadOperation<span class=\"token punctuation\">,</span> OUT PIO_STATUS_BLOCK IoStatus<span class=\"token punctuation\">,</span> IN PDEVICE_OBJECT DeviceObject<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>\tPDEVICE_OBJECT pNextDeviceObject<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>\tPFAST_IO_DISPATCH fastIoDispatch<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>\t<span class=\"token function\">PAGED_CODE</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>DeviceObject<span class=\"token operator\">-></span>DeviceExtension<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\t\t<span class=\"token function\">ASSERT</span><span class=\"token punctuation\">(</span><span class=\"token function\">IS_MY_DEVICE_OBJECT</span><span class=\"token punctuation\">(</span>DeviceObject<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>\t\t<span class=\"token comment\">// 得到本驱动绑定的设备</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>\t\tnextDeviceObject <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>PSFILTER_DEVICE_EXTENSION<span class=\"token punctuation\">)</span>DeviceObject<span class=\"token operator\">-></span>DeviceExtension<span class=\"token punctuation\">)</span><span class=\"token operator\">-></span>AttachedToDeviceObject<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>\t\t<span class=\"token function\">ASSERT</span><span class=\"token punctuation\">(</span>nextDeviceObject<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>\t\t<span class=\"token comment\">// 得到目标设备的 FastIo 分发函数接口</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>\t\tfastIoDispatch <span class=\"token operator\">=</span> nextDeviceObject<span class=\"token operator\">-></span>DriverObject<span class=\"token operator\">-></span>FastIoDispatch<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>\t\t<span class=\"token comment\">// 判断有效性</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>\t\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">VALID_FAST_IO_DISPATCH_HANDLER</span><span class=\"token punctuation\">(</span>fastIoDispatch<span class=\"token punctuation\">,</span> FastIoCheckIfPossible<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>\t\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>\t\t\t<span class=\"token comment\">// 直接调用</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>\t\t\t<span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span>fastIoDispatch<span class=\"token operator\">-></span>FastIoCheckIfPossible<span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>\t\t\t\tFileObject<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>\t\t\t\tFileOffset<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>\t\t\t\tLength<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>\t\t\t\tWait<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>\t\t\t\tLockKey<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>\t\t\t\tCheckForReadOperation<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>\t\t\t\tIoStatus<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>\t\t\t\tnextDeviceObject<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>\t<span class=\"token keyword\">return</span> FALSE<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>前面也说了，也可以使用最简单的方法直接返回 FALSE， 就不需要调用下层真实驱动的 FastIo 接口了。至于这个设备扩展的结构 <code>PSFILTER_DEVICE_EXTENSION</code>  下面会学习，结构和之前写得过滤驱动都差不多。</p>\n<h2 id=\"快速io分发函数逐个简介\"><a class=\"anchor\" href=\"#快速io分发函数逐个简介\">#</a> 快速 IO 分发函数逐个简介</h2>\n<p>在例子 sfilter 中， 快速 IO 分发函数一般都只做两种处理： 直接返回 FALSE， 或者直接调用下层驱动接口。我们可以仅作初步的了解， 不必深究。</p>\n<p>下面简要地了解一下快速 IO 分发函数的各接口。 这些简单的介绍来自网络上的一篇短文， 作者为陆麟。</p>\n<p>（1）  <code>FastIoCheckIfPossible</code>  ， 此调用并不是由 IO 管理器直接调用的， 而是被 FsRtlXXX 系列函数调用， 用于确认读 / 写操作是否可以用快速 IO 接口进行。<br />\n（2）  <code>FastIoRead</code> / <code>FastIoWrite</code>  ， 很明显是读 / 写处理的调用。<br />\n（3）  <code>FastIoQueryBasicInfo</code>  、  <code>FastIoQueryStandardInfo</code>  ， 用于获取各种文件信息， 例如创建时间、 修改时间等。<br />\n（4）  <code>FastIoLock</code>  、  <code>FastIoUnlockSingle</code>  、  <code>FastIoUnlockAll</code> / <code>FastIoUnlockAllByKey</code>  ， 用于对文件的锁定操作。<br />\n（5）  <code>FastIoDeviceControl</code>  ， 用于提供 <code>NtDeviceIoControlFile</code>  的支持。<br />\n（6）  <code>AcquireFileForNtCreateSection</code> / <code>ReleaseFileForNtCreateSection</code> ， 是 NTFS 在映射文件内容到内存页面前进行的操作。<br />\n（7）  <code>FastIoDetachDevice</code>  ， 当可移动介质被拿走后， 文件系统的设备对象会在任意时刻被销毁， 只有正确地处理这个调用， 才能使上层设备和将要销毁的设备解除绑定。 如果不解决这个函数， 系统会直接崩溃。<br />\n（8）  <code>FastIoQueryNetworkOpenInfo</code>  ， 当 CIFS（也就是网上邻居， 更准确地说是网络重定向驱动） 尝试获取文件信息时， 会使用这个调用。该调用是因为各种历史原因而产生的， 当时设计 CIFS 是为了避免多次在网上传输文件信息请求， 在 NT 4 时传输协议增加了一个 <code>FileNetworkOpenInformation</code>  网络文件请求， 而 FSD 则增加了这个接口， 用于在一次操作中获得所有的文件信息； 客户端发送 <code>FileNetworkOpenInformation</code> ， 服务器端的 FSD 用本接口完成信息填写。<br />\n（9）  <code>FastIoAcquireForModWrite</code>  ， Modified Page Writer 会调用这个接口来获取文件锁。 如果实现这个接口， 则能使文件锁定范围减小到调用指定的范围； 不实现此接口， 则会使整个文件被锁。<br />\n（10）  <code>FastIoPrepareMdlWrite</code>  ， FSD 提供 MDL， 以后向此 MDL 写入数据就代表向文件写入数据。 调用参数中有 FILE_OBJECT 用于描述要写的目标文件。<br />\n（11）  <code>FastIoMdlWriteComplete</code>  ， 写操作完成， FSD 回收 MDL。<br />\n（12）  <code>FastIoReadCompressed</code>  ， 当此调用被调用时， 读到的数据是压缩后的。 应该兼容于标准的 NT 提供的压缩库， 因为调用者负责解压缩。<br />\n（13）  <code>FastIoWriteCompressed</code>  ， 当此调用被调用时， 可以将数据压缩后存储。<br />\n（14）  <code>FastIoMdlReadCompressed</code> / <code>FastIoMdlReadCompleteCompressed</code>  ， MDL 版本的压缩读。 当后一个接口被调用时， MDL 必须被释放。<br />\n（15）  <code>FastIoMdlWriteCompressed</code> / <code>FastIoMdlWriteCompleteCompressed</code>  ， MDL 版本的压缩写。 当后一个接口被调用时， MDL 必须被释放。<br />\n（16）  <code>FastIoQueryOpen</code>  ， 这不是打开文件的操作， 但是却提供了一个 IRP_MJ_CREATE 的 IRP。 这个操作是打开文件、 获取文件基本信息、 关闭文件的操作。<br />\n（17）  <code>FastIoReleaseForModWrite</code>  ， 释放 <code>FastIoAcquireForModWrite</code>  调用所占有的锁。<br />\n（18）  <code>FastIoAcquireForCcFlush</code> / <code>FastIoReleaseForCcFlush</code>  ， FsRtl 会调用此接口， 在延迟写线程将要把修改后的文件数据写入前调用， 获取文件锁。</p>\n<h1 id=\"设备的绑定前期工作\"><a class=\"anchor\" href=\"#设备的绑定前期工作\">#</a> 设备的绑定前期工作</h1>\n<h2 id=\"动态地选择绑定函数\"><a class=\"anchor\" href=\"#动态地选择绑定函数\">#</a> 动态地选择绑定函数</h2>\n<p>sfilter 有一个有趣的地方是它用了动态加载的方法来使用内核函数。 我们知道只有在高版本的 Windows 系统上才有 <code>IoAttachDeviceToDeviceStackSafe</code>  函数。 如果我们在驱动中直接调用 <code>IoAttachDeviceToDeviceStackSafe</code> ， 则该驱动在不含这个函数的 Windows 系统上的表现是： 加载直接失败。</p>\n<p>动态加载此类函数的好处就是， 即使在低版本的 Windows 系统上， 这段程序依然可以加载成功。 当然， 动态加载这个函数肯定会失败， 结果就是加载的函数指针为 NULL， 此时代码中判断该函数指针为 NULL 时， 再换用函数 <code>IoAttachDeviceToDeviceStack</code>  来代替，这样该驱动就可以兼容不同版本的 Windows 了。</p>\n<p>使用 <code>MmGetSystemRoutineAddress</code>  可以动态地寻找一个内核函数的指针。 这个内核 API 函数原型如下：</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>NTKERNELAPI</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>PVOID</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token function\">MmGetSystemRoutineAddress</span> <span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    IN PUNICODE_STRING SystemRoutineName</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token punctuation\">)</span></pre></td></tr></table></figure><p><code>SystemRoutineName</code>  是一个字符串， 是要动态寻找地址的内核函数的名字， 比如 <code>IoAttachDeviceToDeviceStackSafe</code>  的名字就是 <code>L&quot;IoAttachDeviceToDeviceStackSafe&quot;</code> 。<br />\n这个函数的使用非常容易， 我们要自己写一段代码， 把 <code>IoAttachDeviceToDeviceStackSafe</code>  函数的指针动态加载到全局变量 <code>gSfDynamicFunctions.AttachDeviceToDeviceStackSafe</code>  中。  <code>gSfDynamicFunctions</code>  是一个全局变量， 实际上是一个结构体， 里面有所有需要动态加载的函数。</p>\n<p>在头文件中声明动态加载函数：</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">if</span> <span class=\"token expression\">WINVER <span class=\"token operator\">>=</span> <span class=\"token number\">0x0501</span>\t\t\t\t</span><span class=\"token comment\">// 如果编译时的 OS 是 WinXP 时，编译这两个函数，否则不编译</span></span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>VOID  <span class=\"token function\">SfLoadDynamicFunctions</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">endif</span></span></pre></td></tr></table></figure><p>函数定义如下：</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">// SfLoadDynamicFunctions 函数 (仅在 WindowsXP 系统下编译该函数)</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">if</span> <span class=\"token expression\">WINVER <span class=\"token operator\">>=</span> <span class=\"token number\">0x0501</span></span></span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>VOID <span class=\"token function\">SfLoadDynamicFunctions</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>\t<span class=\"token comment\">/*</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>\t动态加载下面的这些内核函数。使用动态加载所谓理由是：在低版本的 Windows 操作系统上，这段程序依然可以加载成功。</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>\t*/</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\tUNICODE_STRING functionName<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\t<span class=\"token function\">RtlZeroMemory</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>gSfDynamicFunctions<span class=\"token punctuation\">,</span> <span class=\"token keyword\">sizeof</span><span class=\"token punctuation\">(</span>gSfDynamicFunctions<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\t\t<span class=\"token comment\">// 将 gSfDynamicFunctions 结构变量清 0</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>\t<span class=\"token function\">RtlInitUnicodeString</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>functionName<span class=\"token punctuation\">,</span> L<span class=\"token string\">\"IoAttachDeviceToDeviceStackSafe\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>\tgSfDynamicFunctions<span class=\"token punctuation\">.</span>AttachDeviceToDeviceStackSafe <span class=\"token operator\">=</span> <span class=\"token function\">MmGetSystemRoutineAddress</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>functionName<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre></pre></td></tr><tr><td data-num=\"15\"></td><td><pre></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>\t<span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">endif</span></span></pre></td></tr></table></figure><p>其中我们需要定义函数指针，并定义动态加载函数的结构变量：</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">//=================== 条件编译 (WinXP 及以上 OS 时编译下段代码) ====================</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">if</span> <span class=\"token expression\">WINVER <span class=\"token operator\">>=</span> <span class=\"token number\">0x0501</span></span></span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\">// 定义 IoAttachDeviceToDeviceStackSafe 的函数指针类型</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">typedef</span>  <span class=\"token function\">NTSTATUS</span><span class=\"token punctuation\">(</span><span class=\"token operator\">*</span>PSF_ATTACH_DEVICE_TO_DEVICE_STACK_SAFE<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">(</span>IN PDEVICE_OBJECT SourceDevice<span class=\"token punctuation\">,</span> IN PDEVICE_OBJECT TargetDevice<span class=\"token punctuation\">,</span> OUT PDEVICE_OBJECT<span class=\"token operator\">*</span> AttachedToDeviceObject<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token comment\">// 定义动态加载函数结构体</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token keyword\">typedef</span> <span class=\"token keyword\">struct</span> <span class=\"token class-name\">_SF_DYNAMIC_FUNCTION_POINTERS</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>\t<span class=\"token comment\">// 声明定义 IoAttachDeviceToDeviceStackSafe 的函数指针类型变量</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\tPSF_ATTACH_DEVICE_TO_DEVICE_STACK_SAFE AttachDeviceToDeviceStackSafe<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token punctuation\">&#125;</span> SF_DYNAMIC_FUNCTION_POINTERS<span class=\"token punctuation\">,</span> <span class=\"token operator\">*</span> PSF_DYNAMIC_FUNCTION_POINTERS<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>SF_DYNAMIC_FUNCTION_POINTERS gSfDynamicFunctions <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span> <span class=\"token number\">0</span> <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span>\t<span class=\"token comment\">// 定义该结构变量并初始化为 0</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">endif</span></span></pre></td></tr></table></figure><p>后面如果还有函数需要动态加载，就可以以此为基础添加了。</p>\n<p>代码中的 <code>“#if WINVER &gt;= 0x0501”</code> ， 这里是编译时判断指令， 当编译结果期望适用的 Windows 版本高于 <code>0x0501</code>  时， 使用动态加载函数的方式；当编译结果期望适用的 Windows 版本比这个低时， 没有必要尝试动态加载高级版本的函数， 直接使用低级版本的 <code>IoAttachDeviceToDeviceStack</code>  即可。</p>\n<p>下面的附加设备栈函数就用到了这种动态加载。</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>NTSTATUS  <span class=\"token function\">SfAttachDeviceToDeviceStack</span><span class=\"token punctuation\">(</span>IN PDEVICE_OBJECT SourceDevice<span class=\"token punctuation\">,</span> IN PDEVICE_OBJECT TargetDevice<span class=\"token punctuation\">,</span> IN OUT PDEVICE_OBJECT<span class=\"token operator\">*</span> AttachedToDeviceObject<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>\t<span class=\"token comment\">/*</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>\t参数说明:</pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>\tSourceDevice:\t\t\t   它是调用者创建的设备对象。比如调用者使用 IoCreateDevice 函数来创建设备对象。</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>\tTargetDevice:\t\t\t   它指向其它驱动程序的设备对象。</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>\tAttachedToDeviceObject:\t   它用来存储 IoAttachDeviceToDeviceStack 函数的返回值。</pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\t*/</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>\t<span class=\"token function\">PAGED_CODE</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">if</span> <span class=\"token expression\">WINVER <span class=\"token operator\">>=</span> <span class=\"token number\">0x0501</span></span></span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">IS_WINDOWSXP_OR_LATER</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>\t\t<span class=\"token function\">ASSERT</span><span class=\"token punctuation\">(</span><span class=\"token constant\">NULL</span> <span class=\"token operator\">!=</span> gSfDynamicFunctions<span class=\"token punctuation\">.</span>AttachDeviceToDeviceStackSafe<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>\t\t<span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span>gSfDynamicFunctions<span class=\"token punctuation\">.</span>AttachDeviceToDeviceStackSafe<span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span>SourceDevice<span class=\"token punctuation\">,</span> TargetDevice<span class=\"token punctuation\">,</span> AttachedToDeviceObject<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>\t<span class=\"token keyword\">else</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>\t\t<span class=\"token function\">ASSERT</span><span class=\"token punctuation\">(</span><span class=\"token constant\">NULL</span> <span class=\"token operator\">==</span> gSfDynamicFunctions<span class=\"token punctuation\">.</span>AttachDeviceToDeviceStackSafe<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">endif</span></span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>\t\t<span class=\"token operator\">*</span> AttachedToDeviceObject <span class=\"token operator\">=</span> TargetDevice<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>\t\t<span class=\"token operator\">*</span>AttachedToDeviceObject <span class=\"token operator\">=</span> <span class=\"token function\">IoAttachDeviceToDeviceStack</span><span class=\"token punctuation\">(</span>SourceDevice<span class=\"token punctuation\">,</span> TargetDevice<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>\t\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">*</span>AttachedToDeviceObject <span class=\"token operator\">==</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>\t\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>\t\t\t<span class=\"token keyword\">return</span> STATUS_NO_SUCH_DEVICE<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>\t\t<span class=\"token keyword\">return</span> STATUS_SUCCESS<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre></pre></td></tr><tr><td data-num=\"36\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">if</span> <span class=\"token expression\">WINVER <span class=\"token operator\">>=</span> <span class=\"token number\">0x0501</span></span></span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">endif</span></span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>上面的区分版本编译在 WDK 下意义不大。 即使以 Windows 2003 以上系统为目标编译， sfilter 在 Windows 2000 上也依然可以正常运行。 正是因为 <code>MmGetSystemRoutineAddress</code>  的使用， 所以可以忽略上面的 <code>“#if WINVER &gt;= 0x0501”</code> ， 删除也不会有错。</p>\n<h2 id=\"注册文件系统变动回调\"><a class=\"anchor\" href=\"#注册文件系统变动回调\">#</a> 注册文件系统变动回调</h2>\n<p>感觉书上写的云里雾里，那就带着问题来学习吧。</p>\n<ol>\n<li>为什么要注册文件系统变动回调呢？</li>\n</ol>\n<p>为了动态处理文件系统卷。</p>\n<ol start=\"2\">\n<li>什么是动态处理文件系统卷？</li>\n</ol>\n<p>如果一个 U 盘插入 USB 口， 会有一个 <code>“J:”</code>  之类的卷动态生成， 那么 <code>sfilter</code>  就可以捕获这个事件， 并生成一个过滤设备来绑定它。</p>\n<p>这里要了解两个新名词：挂载和解挂载。</p>\n<p>一个新的存储媒介被系统发现并在文件系统中生成一个卷的过程称为挂载（Mount） ， 与之相反的过程称为解挂载（Dismount）。</p>\n<p>其过程开始时， FS 的 CDO 将得到一个 IRP， 其主功能号为 <code>IRP_MJ_FILE_SYSTEM_CONTROL</code> ， 次功能号为 <code>IRP_MN_MOUNT</code> 。</p>\n<p>知道以上知识后我们就可以知道：<em>如果我们的过滤驱动已经生成了一个设备并绑定了文件系统的 CDO</em>，那么程序中就可以得到这样的一个 IRP，以此就可以知道是否有新的卷挂载了。</p>\n<hr />\n<p><strong>接下来就引出了标题。</strong></p>\n<ol start=\"3\">\n<li>那么我们该如何知道系统中有哪些文件系统， 以及应该在什么时候绑定它们的控制设备呢？</li>\n</ol>\n<p><strong>我们需要用到一个非常有用的系统调用 <code>IoRegisterFsRegistrationChange</code> ， 这个调用会注册一个回调函数。 当系统中有任何文件系统被激活或者被注销时， 注册过的回调函数就会被调用。 这种回调函数被称为文件系统变动回调。</strong></p>\n<ol start=\"4\">\n<li>什么是文件系统的激活和注销？</li>\n</ol>\n<p>需要注意文件系统的激活和卷的挂载是两码事。所谓文件系统的激活， 是指当系统中没有任何卷采用了 NTFS 文件系统时， Windows 没有加载 NTFS 文件系统驱动， 此时可以称为 NTFS 未激活； 当一个新的使用了 NTFS 的卷被加载到系统中时， NTFS 就被加载了， 此时可以说 NTFS 被激活。 第二次再加载新的 NTFS 的卷时， 就和文件系统的激活没什么关系了， 因为对应的文件系统已经在系统中被激活。 与文件系统的激活相反的过程则称为文件系统的卸载。</p>\n<p><code>IoRegisterFsRegistrationChange</code>  注册的回调函数， 只有在文件系统被激活或者注销时才会回调， 和新增加卷或者拔出卷没有直接关系。</p>\n<hr />\n<p>总结：</p>\n<p>当一个新的卷挂载时，如果我们的过滤驱动已经生成了一个设备并绑定了文件系统的 CDO，那么程序中就获得一个 IRP，以此就可以知道是否有新的卷挂载了；如果我们的过滤驱动设备并没有绑定了文件系统的 CDO，那么就要用到 <code>IoRegisterFsRegistrationChange</code>  去注册一个回调函数来绑定这个文件系统的 CDO。</p>\n<hr />\n<p>下面看 sfilter 的 <code>DriverEntry</code>  对 <code>IoRegisterFsRegistrationChange</code>  函数的调用， 代码如下：</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">// SfFsNotification 是我们的回调函数，注意它的格式</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>\tstatus <span class=\"token operator\">=</span> <span class=\"token function\">IoRegisterFsRegistrationChange</span><span class=\"token punctuation\">(</span>pDriverObject<span class=\"token punctuation\">,</span> SfFsNotification<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token function\">NT_SUCCESS</span><span class=\"token punctuation\">(</span>status<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>\t\t<span class=\"token comment\">// 如果失败了，前面分配的 FastIo 分发函数就没用了，直接释放掉</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>\t\t<span class=\"token function\">KdPrint</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"SFilter!DriverEntry:Error registering FS change notification，status=%08x\\n\"</span><span class=\"token punctuation\">,</span> status<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>\t\tpDriverObject<span class=\"token operator\">-></span>FastIoDispatch <span class=\"token operator\">=</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">;</span>\t\t\t\t\t<span class=\"token comment\">// 注销指向 fastIo 函数组的指针为 NULL</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>\t\t<span class=\"token function\">ExFreePoolWithTag</span><span class=\"token punctuation\">(</span>fastIoDispatch<span class=\"token punctuation\">,</span> SFLT_POOL_TAG<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\t\t<span class=\"token comment\">// 释放分配给 fastIo 函数组的内存</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\t\t<span class=\"token function\">IoDeleteDevice</span><span class=\"token punctuation\">(</span>gSFilterControlDeviceObject<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\t\t\t<span class=\"token comment\">// 删除上面创建的 CDO</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\t\t<span class=\"token keyword\">return</span> status<span class=\"token punctuation\">;</span>\t\t\t\t\t\t\t\t\t\t\t<span class=\"token comment\">// 错误返回</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h2 id=\"文件系统变动回调的一个实现\"><a class=\"anchor\" href=\"#文件系统变动回调的一个实现\">#</a> 文件系统变动回调的一个实现</h2>\n<p>有必要为此写一个回调函数 <code>SfFsNotification</code> 。 请注意这个回调函数的原型必须符合条件。这是在 vs2019 中 <code>ntifs.h</code>  中的定义：</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">typedef</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>VOID</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token function\">DRIVER_FS_NOTIFICATION</span> <span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    _In_ <span class=\"token keyword\">struct</span> <span class=\"token class-name\">_DEVICE_OBJECT</span> <span class=\"token operator\">*</span>DeviceObject<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    _In_ BOOLEAN FsActive</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token keyword\">typedef</span> DRIVER_FS_NOTIFICATION <span class=\"token operator\">*</span>PDRIVER_FS_NOTIFICATION<span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>第一个参数是一个设备对象指针。 这个设备对象就是文件系统的控制设备（注意文件系统的控制设备可能已经被其他文件的过滤驱动绑定， 此时， 这个设备对象指针总是当前设备栈顶的那个设备）。<br />\n第二个参数是一个 BOOLEAN 值， 如果为 TRUE 则表示文件系统的激活； 如果为 FALSE 则表示文件系统的卸载。</p>\n<p>下面是 <code>sfilter</code>  中的回调函数 <code>SfFsNotification</code> ：</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>VOID  <span class=\"token function\">SfFsNotification</span><span class=\"token punctuation\">(</span>IN PDEVICE_OBJECT DeviceObject<span class=\"token punctuation\">,</span> IN BOOLEAN FsActive<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>\t<span class=\"token comment\">/*</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>\t  SfFsNotification 函数：</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>\t  它创建一个设备对象，并将它附加到指定的文件系统控制设备对象 (File System CDO) 的对象栈上。这就允许这个设备对象过滤所有发送给文件系统的请求。</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>\t  这样，我们就能够获得一个挂载卷的请求，就可以附加到这个新的卷设备对象的设备对象栈上。</pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\t  当 SfFsNotification 函数调用完毕以后，我们的过滤驱动设备对象就能够接收到发送到文件系统 CDO 的请求，即接收到 IRP_MJ_FILE_SYSTEM_CONTROL，或者说，</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\t  文件系统控制设备已经被绑定，可以动态监控卷的挂载了。那么以后的工作就是要完成对卷的监控绑定了。</pre></td></tr><tr><td data-num=\"11\"></td><td><pre></pre></td></tr><tr><td data-num=\"12\"></td><td><pre></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>\t  参数说明:</pre></td></tr><tr><td data-num=\"14\"></td><td><pre></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>\t  DeviceObject:   它指向文件系统的控制设备对象 (CDO)。即 被激活或则撤消的 File System CDO</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>\t  FsActive:       值为 TRUE，表示文件系统的激活。值为 FALSE，表示文件系统的卸载。</pre></td></tr><tr><td data-num=\"17\"></td><td><pre></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>\t */</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>\tUNICODE_STRING name<span class=\"token punctuation\">;</span>\t\t\t\t\t<span class=\"token comment\">// 定义结构变量</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>\tWCHAR nameBuffer<span class=\"token punctuation\">[</span>MAX_DEVNAME_LENGTH<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\t<span class=\"token comment\">// 定义宽字符缓冲区，长度 64</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>\t<span class=\"token function\">PAGED_CODE</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre></pre></td></tr><tr><td data-num=\"25\"></td><td><pre></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>\t<span class=\"token comment\">// 下面获取设备名和 SF_LOG_PRINT 没有什么实际意义，主要是为了获得一些 log，让我们知道绑定了那些设备</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>\t<span class=\"token function\">RtlInitEmptyUnicodeString</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>name<span class=\"token punctuation\">,</span> nameBuffer<span class=\"token punctuation\">,</span> <span class=\"token keyword\">sizeof</span><span class=\"token punctuation\">(</span>nameBuffer<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\t\t<span class=\"token comment\">// 初始化 name (成员 Buffer->nameBuffer,Length=0,MaximumLength=64)</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>\t<span class=\"token function\">SfGetObjectName</span><span class=\"token punctuation\">(</span>DeviceObject<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>name<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>\t<span class=\"token function\">SF_LOG_PRINT</span><span class=\"token punctuation\">(</span>SFDEBUG_DISPLAY_ATTACHMENT_NAMES<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>\t\t<span class=\"token punctuation\">(</span><span class=\"token string\">\"SFilter!SfFsNotification:                    %s   %p \\\"%wZ\\\" (%s)\\n\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>\t\t\t<span class=\"token punctuation\">(</span>FsActive<span class=\"token punctuation\">)</span> <span class=\"token operator\">?</span> <span class=\"token string\">\"Activating file system  \"</span> <span class=\"token operator\">:</span> <span class=\"token string\">\"Deactivating file system\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>\t\t\tDeviceObject<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>\t\t\t<span class=\"token operator\">&amp;</span>name<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>\t\t\t<span class=\"token function\">GET_DEVICE_TYPE_NAME</span><span class=\"token punctuation\">(</span>DeviceObject<span class=\"token operator\">-></span>DeviceType<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre></pre></td></tr><tr><td data-num=\"36\"></td><td><pre></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>\t<span class=\"token comment\">// 到这里才是最重要的。</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>\t<span class=\"token comment\">// 如果是文件系统激活，那么就绑定文件系统的控制设备。</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>\t<span class=\"token comment\">// 如果是注销，则解除绑定。</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>\t<span class=\"token comment\">// 这些绑定过程都是需要自己写的函数实现的。</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>FsActive<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>\t\t<span class=\"token function\">SfAttachToFileSystemDevice</span><span class=\"token punctuation\">(</span>DeviceObject<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>name<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\t<span class=\"token comment\">// 用于完成对文件系统控制设备的绑定</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>\t<span class=\"token keyword\">else</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>\t\t<span class=\"token function\">SfDetachFromFileSystemDevice</span><span class=\"token punctuation\">(</span>DeviceObject<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>这里涉及一些关于驱动加载方式的问题。 驱动的动态加载是指我们常用的加载驱动的方法， 在 Windows 启动之后， 我们用工具或者输入命令行命令手工启动驱动。驱动的静态加载则一般用 inf 文件安装驱动， 并设置启动模式为 Windows 启动时自动启动。</p>\n<p><code>IoRegisterFsRegistrationChange</code>  可以注册对激活文件系统的回调， 但是对于调用这个函数时早就已经激活的文件系统来说， 回调是否会被调用呢？ 早期的 Windows 版本如 Windows 2000 是不会调用的； 而 Windows 2000 SP4 和 Windows XP 则会被调用，<strong>让注册变动回调的人以为所有的已存在文件系统都会被重新 “激活” 一次</strong>。</p>\n<p>所以在 Windows 2000 下进行动态加载有一定的困难， 因为 Windows 启动早就结束了，某些文件系统可能早已被激活， 这样就必须自己枚举所有已经激活的文件系统。 同时在 Windows 2000 下枚举文件系统又有一个困难， 就是必须使用未公开的调用。 所以在 Windows 2000 下， sfilter 一般都做成静态加载、 早期启动的方式（在所有的文件系统启动之前就启动起来）。</p>\n<p>因为文件系统过滤比较复杂， 所以现在再回顾一下在 DriverEntry 中应该做的工作。</p>\n<p>第一步： 生成一个控制设备。 当然此前必须给控制设备指定名称。<br />\n第二步： 设置普通分发函数。<br />\n第三步： 设置快速 IO 分发函数。<br />\n第四步： 编写一个文件系统变动回调函数， 在其中绑定刚激活的文件系统控制设备。<br />\n第五步： 使用 <code>IoRegisterFsRegistrationChange</code>  调用注册这个回调函数。</p>\n<p>现在还没有解决的问题是：该如何绑定一个文件系统的控制设备， 即如何实现函数 <code>SfAttachToFileSystemDevice</code>  呢？ 下面就开始实现这个函数。</p>\n<h2 id=\"文件系统识别器\"><a class=\"anchor\" href=\"#文件系统识别器\">#</a> 文件系统识别器</h2>\n<p>上一节讲到的最后一个问题是要绑定一个刚刚被激活的文件系统控制设备。 前面实现过用 <code>sfAttachDeviceToStack</code>  来绑定这个设备， 但是并不是每次文件系统变动回调发现有新的文件系统激活都直接绑定它。</p>\n<p>首先判断是否是需要关心的文件系统类型。 过滤驱动可能只对文件系统的 CDO 设备类型中的某些感兴趣。 假设只关心磁盘文件系统、 光盘（CD-ROM） 和网络文件系统， 那么就只需要注意这三种类型就可以了。 下面的代码定义了一个宏来判断一个设备的类型是否是本驱动需要关心的。</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">// 宏定义：测试是不是所需要的 \"设备类型\"</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name function\">IS_DESIRED_DEVICE_TYPE</span><span class=\"token expression\"><span class=\"token punctuation\">(</span>_type<span class=\"token punctuation\">)</span> </span><span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>         <span class=\"token expression\"><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>_type<span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> FILE_DEVICE_DISK_FILE_SYSTEM<span class=\"token punctuation\">)</span> <span class=\"token operator\">||</span> </span><span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>\t\t <span class=\"token expression\"><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>_type<span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> FILE_DEVICE_CD_ROM_FILE_SYSTEM<span class=\"token punctuation\">)</span> <span class=\"token operator\">||</span> </span><span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>\t\t <span class=\"token expression\"><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>_type<span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> FILE_DEVICE_NETWORK_FILE_SYSTEM<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></span></span></pre></td></tr></table></figure><hr />\n<p>首先了解一下什么是文件系统识别器。</p>\n<p><em>文件系统识别器是文件系统驱动的一个很小的替身</em>。 为了避免没有使用到的文件系统驱动占据内核内存， Windows 系统不加载这些大驱动， 而以该文件系统驱动对应的文件系统识别器来代替。当新的物理存储媒介进入系统后， IO 管理器会依次尝试用各种文件系统对它进行 “识别”， 若识别成功， 则立刻加载真正的文件系统驱动， 对应的文件系统识别器则被卸载掉。</p>\n<p><em>文件系统识别器的控制设备看起来就像一个文件系统控制设备， 绑定它可能会带来问题， 也可能不会。 有时跳过是最简单的办法， 有时或许又有特别的需求需要绑定， 但无论如何都必须有判断的方法。</em></p>\n<p>这里详细介绍了文件系统识别器：<span class=\"exturl\" data-url=\"aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3N0b25lNTU1NS9hcnRpY2xlL2RldGFpbHMvODE5NTMyMjA=\">https://blog.csdn.net/stone5555/article/details/81953220</span></p>\n<p><strong> <code>sfilter</code>  是跳过了文件系统识别器</strong>。 那么如何跳过文件它呢？</p>\n<p>通过驱动的名字可以分辨出部分 Windows 的标准文件系统识别器。 Windows 的标准文件系统识别器一般都是由驱动 <code>“\\FileSystem\\Fs_Rec”</code>  生成的， 所以直接判断驱动的名字可以解决一部分问题。</p>\n<p>我在查看了我主机 win10 和 xp 虚拟机中的注册表，发现 <code>Fs_Rec</code>  所在的位置为 <code>&quot;HKEY_LOCAL_MACHINE\\SYSTEM\\CurrentControlSet\\Services\\Fs_Rec&quot;</code> ，并没有 <code>FileSytem</code>  这个路径，可能驱动的名字是 <code>“\\FileSystem\\Fs_Rec”</code>  吧。</p>\n<p>下面的代码可以完成这个判断， 如果是肯定的， 则直接返回成功， 即放弃绑定。</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>UNICODE_STRING fsrecName<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>UNICODE_STRING fsName<span class=\"token punctuation\">;</span>\t\t\t\t\t<span class=\"token comment\">// 文件系统名</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>WCHAR tempNameBuffer<span class=\"token punctuation\">[</span>MAX_DEVNAME_LENGTH<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span><span class=\"token comment\">// 临时缓冲区 (存放名字串)</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token comment\">/*</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>* Windows 的标准文件系统识别器基本上都是由驱动 \\FileSystem\\Fs_Rec 生成的。所以直接判断驱动的名字可以解决一部分问题。</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>* 也不一定非得要把文件系统识别器生成在驱动 \\FileSystem\\Fs_Rec 下面。只是说，一般情况下是在 \\FileSystem\\Fs_Rec 下面。</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>*/</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token function\">RtlInitEmptyUnicodeString</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>fsName<span class=\"token punctuation\">,</span> tempNameBuffer<span class=\"token punctuation\">,</span> <span class=\"token keyword\">sizeof</span><span class=\"token punctuation\">(</span>tempNameBuffer<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token function\">RtlInitUnicodeString</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>fsrecName<span class=\"token punctuation\">,</span> L<span class=\"token string\">\"\\\\FileSystem\\\\Fs_Rec\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token function\">SfGetObjectName</span><span class=\"token punctuation\">(</span>DeviceObject<span class=\"token operator\">-></span>DriverObject<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>fsName<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">RtlCompareUnicodeString</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>fsName<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>fsrecName<span class=\"token punctuation\">,</span> TRUE<span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>\t<span class=\"token comment\">// 通过驱动的名字来分辨出部分 Windows 的标准文件系统识别器。如果是，那么返回成功，也就是放弃绑定了。</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>\t<span class=\"token comment\">// 如果，有错过的文件系统识别器没有被判断到，文件系统控制请求的过滤驱动中有对应的处理。</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>\t<span class=\"token keyword\">return</span> STATUS_SUCCESS<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>上面这段代码可以放在文件系统变动回调函数 <code>SfFsNotification</code>  中， 也可以放在绑定文件系统控制设备的函数 <code>SfAttachToFileSystemDevice</code>  中。 后面有使用这些代码的例子。</p>\n<p>要注意没有人规定文件系统识别器一定在驱动 <code>“\\FileSystem\\Fs_Rec”</code>  下生成， 所以这个方法只跳过了部分 “微软的规矩的” 文件系统识别器。 对于这里所错过的内容， 在文件系统控制请求的过滤中有对应的处理。</p>\n<h1 id=\"绑定文件系统的控制设备\"><a class=\"anchor\" href=\"#绑定文件系统的控制设备\">#</a> 绑定文件系统的控制设备</h1>\n<h2 id=\"生成文件系统控制设备的过滤设备\"><a class=\"anchor\" href=\"#生成文件系统控制设备的过滤设备\">#</a> 生成文件系统控制设备的过滤设备</h2>\n<p>接下来将要生成过滤设备。 这里要再次提到设备扩展的概念。 设备扩展是一个数据结构， 为了表示不同的设备， 里面将有一片自定义的空间， 用来记录这个设备的特有信息。在 sfilter 中生成的过滤设备的设备扩展如下：</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">typedef</span> <span class=\"token keyword\">struct</span> <span class=\"token class-name\">_SFILTER_DEVICE_EXTENSION</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>\tPDEVICE_OBJECT AttachedToDeviceObject<span class=\"token punctuation\">;</span>\t\t\t\t\t<span class=\"token comment\">// 绑定的文件系统设备</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>\tPDEVICE_OBJECT StorageStackDeviceObject<span class=\"token punctuation\">;</span>\t\t\t\t<span class=\"token comment\">// 与文件系统设备相关的真实设备 (磁盘) </span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>\tUNICODE_STRING DeviceName<span class=\"token punctuation\">;</span>\t\t\t\t\t\t\t\t<span class=\"token comment\">// 如果绑定了一个卷，这是物理磁盘卷名；否则，为绑定的控制设备名。</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>\tWCHAR DeviceNameBuffer<span class=\"token punctuation\">[</span>MAX_DEVNAME_LENGTH<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\t\t\t\t<span class=\"token comment\">// 用来保存名字串的缓冲区</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">&#125;</span> SFILTER_DEVICE_EXTENSION<span class=\"token punctuation\">,</span> <span class=\"token operator\">*</span> PSFILTER_DEVICE_EXTENSION<span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>如何定义结构完全依赖于用户的需求。 在 sfilter 中对结构的定义比较简单， 主要是记得自己绑定在哪个设备上即可。 如果需要更多的信息， 则可以在这里增加新的域。 扩展空间的大小是在生成这个设备（调用 IoCreateDevice 生成设备） 时指定的。代码如下：</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">// 是我们关心的文件系统，且不是微软的文件系统识别器的设备，创建一个设备绑定这个设备对象。</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>\tstatus <span class=\"token operator\">=</span> <span class=\"token function\">IoCreateDevice</span><span class=\"token punctuation\">(</span>gSFilterDriverObject<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>\t\t<span class=\"token keyword\">sizeof</span><span class=\"token punctuation\">(</span>SFILTER_DEVICE_EXTENSION<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>\t\t<span class=\"token constant\">NULL</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>\t\tDeviceObject<span class=\"token operator\">-></span>DeviceType<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>\t\t<span class=\"token number\">0</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>\t\tFALSE<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>\t\t<span class=\"token operator\">&amp;</span>newDeviceObject<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token function\">NT_SUCCESS</span><span class=\"token punctuation\">(</span>status<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>\t\t<span class=\"token keyword\">return</span> status<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>得到设备对象指针后， 使用下面的代码即可获取这个设备所绑定的原始设备。</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>nextDeviceObject <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>PSFILTER_DEVICE_EXTENSION<span class=\"token punctuation\">)</span>DeviceObject<span class=\"token operator\">-></span>DeviceExtension<span class=\"token punctuation\">)</span><span class=\"token operator\">-></span>AttachedToDeviceObject<span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>这些知识在写前面的过滤时都已经了解了。</p>\n<p>生成设备后， 为了让系统过滤设备看起来和原来的设备没什么区别， 必须将该设备的一些标志位与所绑定的设备设置相同。</p>\n<p>这和前面所学的各种过滤都是类似的， 只是关心的标志位有所不同。</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token function\">FlagOn</span><span class=\"token punctuation\">(</span>DeviceObject<span class=\"token operator\">-></span>Flags<span class=\"token punctuation\">,</span> DO_BUFFERED_IO<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>\t<span class=\"token function\">SetFlag</span><span class=\"token punctuation\">(</span>newDeviceObject<span class=\"token operator\">-></span>Flags<span class=\"token punctuation\">,</span> DO_BUFFERED_IO<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token function\">FlagOn</span><span class=\"token punctuation\">(</span>DeviceObject<span class=\"token operator\">-></span>Flags<span class=\"token punctuation\">,</span> DO_DIRECT_IO<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>\t<span class=\"token function\">SetFlag</span><span class=\"token punctuation\">(</span>newDeviceObject<span class=\"token operator\">-></span>Flags<span class=\"token punctuation\">,</span> DO_DIRECT_IO<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token function\">FlagOn</span><span class=\"token punctuation\">(</span>DeviceObject<span class=\"token operator\">-></span>Characteristics<span class=\"token punctuation\">,</span> FILE_DEVICE_SECURE_OPEN<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>\t<span class=\"token function\">SetFlag</span><span class=\"token punctuation\">(</span>newDeviceObject<span class=\"token operator\">-></span>Characteristics<span class=\"token punctuation\">,</span> FILE_DEVICE_SECURE_OPEN<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>这里的标志 <code>DO_BUFFERED_IO</code>  和 <code>DO_DIRECT_IO</code> ， 也就是之前学过的缓冲 IO 和直接 IO 两种方式。<br />\n这两种方式的不同之处在于， 外部向这些设备发送读 / 写请求时， 所用的缓冲地址不同。 在过滤文件读 / 写时会再复习到这一点。</p>\n<h2 id=\"绑定文件系统控制设备\"><a class=\"anchor\" href=\"#绑定文件系统控制设备\">#</a> 绑定文件系统控制设备</h2>\n<p>就是实现整个 <code>SfAttachToFileSystemDevice</code>  函数。</p>\n<p><code>SfAttachToFileSystemDevice</code>  函数是用来完成绑定文件系统控制设备的过程。只要在文件系统变动回调函数中调用这个函数， 就完成了对文件系统控制设备的绑定。</p>\n<p><em>这里需要注意的是这个函数仅能用来绑定文件系统控制设备， 不能用来绑定文件系统卷。所以我们的下一步目标就是如何绑定文件系统的卷设备了</em>。</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>NTSTATUS  <span class=\"token function\">SfAttachToFileSystemDevice</span><span class=\"token punctuation\">(</span>IN PDEVICE_OBJECT DeviceObject<span class=\"token punctuation\">,</span> IN PUNICODE_STRING DeviceName<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>\t<span class=\"token comment\">/*</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>\t SfAttachToFileSystemDevice 函数用来完成对文件系统控制设备的绑定。</pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>\t 参数说明:</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>\t DeviceObject:   它指向文件系统的控制设备对象 (CDO)。即 被激活或则撤消的 File System CDO</pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\t*/</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>\tPDEVICE_OBJECT newDeviceObject<span class=\"token punctuation\">;</span>\t\t\t<span class=\"token comment\">// 新设备对象</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>\tPSFILTER_DEVICE_EXTENSION devExt<span class=\"token punctuation\">;</span>\t\t<span class=\"token comment\">// 文件系统过滤驱动定义的设备扩展</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>\tNTSTATUS status<span class=\"token punctuation\">;</span>\t\t\t\t\t\t<span class=\"token comment\">// 状态码</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>\tUNICODE_STRING fsrecName<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>\tUNICODE_STRING fsName<span class=\"token punctuation\">;</span>\t\t\t\t\t<span class=\"token comment\">// 文件系统名</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>\tWCHAR tempNameBuffer<span class=\"token punctuation\">[</span>MAX_DEVNAME_LENGTH<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span><span class=\"token comment\">// 临时缓冲区 (存放名字串)</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>\t<span class=\"token function\">PAGED_CODE</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token function\">IS_DESIRED_DEVICE_TYPE</span><span class=\"token punctuation\">(</span>DeviceObject<span class=\"token operator\">-></span>DeviceType<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\t<span class=\"token comment\">// 测试给定设备是不是所需要关心的设备</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>\t\t<span class=\"token keyword\">return</span> STATUS_SUCCESS<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre></pre></td></tr><tr><td data-num=\"25\"></td><td><pre></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>\t<span class=\"token comment\">/*</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>\t * Windows 的标准文件系统识别器基本上都是由驱动 \\FileSystem\\Fs_Rec 生成的。所以直接判断驱动的名字可以解决一部分问题。</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>\t * 也不一定非得要把文件系统识别器生成在驱动 \\FileSystem\\Fs_Rec 下面。只是说，一般情况下是在 \\FileSystem\\Fs_Rec 下面。</pre></td></tr><tr><td data-num=\"29\"></td><td><pre>\t */</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>\t<span class=\"token function\">RtlInitEmptyUnicodeString</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>fsName<span class=\"token punctuation\">,</span> tempNameBuffer<span class=\"token punctuation\">,</span> <span class=\"token keyword\">sizeof</span><span class=\"token punctuation\">(</span>tempNameBuffer<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>\t<span class=\"token comment\">// 根据我们是否要绑定识别器，来决定是否跳过文件系统识别器</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token function\">FlagOn</span><span class=\"token punctuation\">(</span>SfDebug<span class=\"token punctuation\">,</span> SFDEBUG_ATTACH_TO_FSRECOGNIZER<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>\t\t<span class=\"token function\">RtlInitUnicodeString</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>fsrecName<span class=\"token punctuation\">,</span> L<span class=\"token string\">\"\\\\FileSystem\\\\Fs_Rec\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>\t\t<span class=\"token function\">SfGetObjectName</span><span class=\"token punctuation\">(</span>DeviceObject<span class=\"token operator\">-></span>DriverObject<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>fsName<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>\t\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">RtlCompareUnicodeString</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>fsName<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>fsrecName<span class=\"token punctuation\">,</span> TRUE<span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>\t\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>\t\t\t<span class=\"token comment\">// 通过驱动的名字来分辨出部分 Windows 的标准文件系统识别器。如果是，那么返回成功，也就是放弃绑定了。</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>\t\t\t<span class=\"token comment\">// 如果，有错过的文件系统识别器没有被判断到，文件系统控制请求的过滤驱动中有对应的处理。</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>\t\t\t<span class=\"token keyword\">return</span> STATUS_SUCCESS<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre></pre></td></tr><tr><td data-num=\"46\"></td><td><pre></pre></td></tr><tr><td data-num=\"47\"></td><td><pre></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>\t<span class=\"token comment\">// 是我们关心的文件系统，且不是微软的文件系统识别器的设备，创建一个设备绑定这个设备对象。</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>\tstatus <span class=\"token operator\">=</span> <span class=\"token function\">IoCreateDevice</span><span class=\"token punctuation\">(</span>gSFilterDriverObject<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>\t\t<span class=\"token keyword\">sizeof</span><span class=\"token punctuation\">(</span>SFILTER_DEVICE_EXTENSION<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>\t\t<span class=\"token constant\">NULL</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre>\t\tDeviceObject<span class=\"token operator\">-></span>DeviceType<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>\t\t<span class=\"token number\">0</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre>\t\tFALSE<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre>\t\t<span class=\"token operator\">&amp;</span>newDeviceObject<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre></pre></td></tr><tr><td data-num=\"57\"></td><td><pre>\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token function\">NT_SUCCESS</span><span class=\"token punctuation\">(</span>status<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"59\"></td><td><pre>\t\t<span class=\"token keyword\">return</span> status<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"61\"></td><td><pre></pre></td></tr><tr><td data-num=\"62\"></td><td><pre>\t<span class=\"token comment\">// 将过滤设备的一些标志位与所绑定的设备设置相同</span></pre></td></tr><tr><td data-num=\"63\"></td><td><pre>\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">FlagOn</span><span class=\"token punctuation\">(</span>DeviceObject<span class=\"token operator\">-></span>Flags<span class=\"token punctuation\">,</span> DO_BUFFERED_IO<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"64\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"65\"></td><td><pre>\t\t<span class=\"token function\">SetFlag</span><span class=\"token punctuation\">(</span>newDeviceObject<span class=\"token operator\">-></span>Flags<span class=\"token punctuation\">,</span> DO_BUFFERED_IO<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"66\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"67\"></td><td><pre></pre></td></tr><tr><td data-num=\"68\"></td><td><pre>\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">FlagOn</span><span class=\"token punctuation\">(</span>DeviceObject<span class=\"token operator\">-></span>Flags<span class=\"token punctuation\">,</span> DO_DIRECT_IO<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"69\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"70\"></td><td><pre>\t\t<span class=\"token function\">SetFlag</span><span class=\"token punctuation\">(</span>newDeviceObject<span class=\"token operator\">-></span>Flags<span class=\"token punctuation\">,</span> DO_DIRECT_IO<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"71\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"72\"></td><td><pre></pre></td></tr><tr><td data-num=\"73\"></td><td><pre>\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">FlagOn</span><span class=\"token punctuation\">(</span>DeviceObject<span class=\"token operator\">-></span>Characteristics<span class=\"token punctuation\">,</span> FILE_DEVICE_SECURE_OPEN<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"74\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"75\"></td><td><pre>\t\t<span class=\"token function\">SetFlag</span><span class=\"token punctuation\">(</span>newDeviceObject<span class=\"token operator\">-></span>Characteristics<span class=\"token punctuation\">,</span> FILE_DEVICE_SECURE_OPEN<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"76\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"77\"></td><td><pre></pre></td></tr><tr><td data-num=\"78\"></td><td><pre>\tdevExt <span class=\"token operator\">=</span> newDeviceObject<span class=\"token operator\">-></span>DeviceExtension<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"79\"></td><td><pre></pre></td></tr><tr><td data-num=\"80\"></td><td><pre></pre></td></tr><tr><td data-num=\"81\"></td><td><pre>\t<span class=\"token comment\">/*</pre></td></tr><tr><td data-num=\"82\"></td><td><pre>\t  调用 SfAttachDeviceToDeviceStack 函数将过滤设备对象绑定到 File System CDO 的设备栈上面。</pre></td></tr><tr><td data-num=\"83\"></td><td><pre>\t  这样，我们的 newDeviceObject 就可以接收到发送到 File System CDO 的 IRP_MJ_FILE_SYSTEM_CONTROL 请求了。</pre></td></tr><tr><td data-num=\"84\"></td><td><pre>\t  以后，程序就可以去绑定卷了。</pre></td></tr><tr><td data-num=\"85\"></td><td><pre>\t  使用 SfAttachDeviceToDeviceStack 函数来进行绑定。参数 1 绑定到参数 2，绑定函数返回的设备存储在参数 3 中。</pre></td></tr><tr><td data-num=\"86\"></td><td><pre>\t */</span></pre></td></tr><tr><td data-num=\"87\"></td><td><pre>\tstatus <span class=\"token operator\">=</span> <span class=\"token function\">SfAttachDeviceToDeviceStack</span><span class=\"token punctuation\">(</span>newDeviceObject<span class=\"token punctuation\">,</span> </pre></td></tr><tr><td data-num=\"88\"></td><td><pre>\t\tDeviceObject<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"89\"></td><td><pre>\t\t<span class=\"token operator\">&amp;</span>devExt<span class=\"token operator\">-></span>AttachedToDeviceObject<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"90\"></td><td><pre>\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token function\">NT_SUCCESS</span><span class=\"token punctuation\">(</span>status<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"91\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"92\"></td><td><pre>\t\t<span class=\"token keyword\">goto</span> ErrorCleanupDevice<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"93\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"94\"></td><td><pre>\t<span class=\"token comment\">// 将设备名字记录到设备扩展中</span></pre></td></tr><tr><td data-num=\"95\"></td><td><pre>\t<span class=\"token function\">RtlInitEmptyUnicodeString</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>devExt<span class=\"token operator\">-></span>DeviceName<span class=\"token punctuation\">,</span> </pre></td></tr><tr><td data-num=\"96\"></td><td><pre>\t\tdevExt<span class=\"token operator\">-></span>DeviceNameBuffer<span class=\"token punctuation\">,</span> </pre></td></tr><tr><td data-num=\"97\"></td><td><pre>\t\t<span class=\"token keyword\">sizeof</span><span class=\"token punctuation\">(</span>devExt<span class=\"token operator\">-></span>DeviceNameBuffer<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"98\"></td><td><pre>\t<span class=\"token function\">RtlCopyUnicodeString</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>devExt<span class=\"token operator\">-></span>DeviceName<span class=\"token punctuation\">,</span> DeviceName<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>        <span class=\"token comment\">//Save Name</span></pre></td></tr><tr><td data-num=\"99\"></td><td><pre>\t<span class=\"token function\">ClearFlag</span><span class=\"token punctuation\">(</span>newDeviceObject<span class=\"token operator\">-></span>Flags<span class=\"token punctuation\">,</span> DO_DEVICE_INITIALIZING<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"100\"></td><td><pre></pre></td></tr><tr><td data-num=\"101\"></td><td><pre>\t<span class=\"token function\">SF_LOG_PRINT</span><span class=\"token punctuation\">(</span>SFDEBUG_DISPLAY_ATTACHMENT_NAMES<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"102\"></td><td><pre>\t\t<span class=\"token punctuation\">(</span><span class=\"token string\">\"SFilter!SfAttachToFileSystemDevice:          Attaching to file system   %p \\\"%wZ\\\" (%s)\\n\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"103\"></td><td><pre>\t\t\tDeviceObject<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"104\"></td><td><pre>\t\t\t<span class=\"token operator\">&amp;</span>devExt<span class=\"token operator\">-></span>DeviceName<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"105\"></td><td><pre>\t\t\t<span class=\"token function\">GET_DEVICE_TYPE_NAME</span><span class=\"token punctuation\">(</span>newDeviceObject<span class=\"token operator\">-></span>DeviceType<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"106\"></td><td><pre></pre></td></tr><tr><td data-num=\"107\"></td><td><pre></pre></td></tr><tr><td data-num=\"108\"></td><td><pre>\t<span class=\"token comment\">/*</pre></td></tr><tr><td data-num=\"109\"></td><td><pre>\t下面是不同版本的兼容性设计。当期望目标操作系统的版本大于 0x501 时</pre></td></tr><tr><td data-num=\"110\"></td><td><pre>\t Windwows 内核一定有 EnumerateDeviceObjectList 等函数。这时可以枚举所有的卷并逐个绑定。</pre></td></tr><tr><td data-num=\"111\"></td><td><pre>\t 如果期望的目标操作系统比这个小，那么这些函数根本不存在，我们无法绑定已经加载的卷</pre></td></tr><tr><td data-num=\"112\"></td><td><pre>\t */</span></pre></td></tr><tr><td data-num=\"113\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">if</span> <span class=\"token expression\">WINVER <span class=\"token operator\">>=</span> <span class=\"token number\">0x0501</span></span></span></pre></td></tr><tr><td data-num=\"114\"></td><td><pre></pre></td></tr><tr><td data-num=\"115\"></td><td><pre>\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">IS_WINDOWSXP_OR_LATER</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"116\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"117\"></td><td><pre>\t\t<span class=\"token comment\">// 断言 动态加载函数是否被加载</span></pre></td></tr><tr><td data-num=\"118\"></td><td><pre>\t\t<span class=\"token function\">ASSERT</span><span class=\"token punctuation\">(</span><span class=\"token constant\">NULL</span> <span class=\"token operator\">!=</span> gSfDynamicFunctions<span class=\"token punctuation\">.</span>EnumerateDeviceObjectList <span class=\"token operator\">&amp;&amp;</span></pre></td></tr><tr><td data-num=\"119\"></td><td><pre>\t\t\t<span class=\"token constant\">NULL</span> <span class=\"token operator\">!=</span> gSfDynamicFunctions<span class=\"token punctuation\">.</span>GetDiskDeviceObject <span class=\"token operator\">&amp;&amp;</span></pre></td></tr><tr><td data-num=\"120\"></td><td><pre>\t\t\t<span class=\"token constant\">NULL</span> <span class=\"token operator\">!=</span> gSfDynamicFunctions<span class=\"token punctuation\">.</span>GetDeviceAttachmentBaseRef <span class=\"token operator\">&amp;&amp;</span></pre></td></tr><tr><td data-num=\"121\"></td><td><pre>\t\t\t<span class=\"token constant\">NULL</span> <span class=\"token operator\">!=</span> gSfDynamicFunctions<span class=\"token punctuation\">.</span>GetLowerDeviceObject<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"122\"></td><td><pre></pre></td></tr><tr><td data-num=\"123\"></td><td><pre></pre></td></tr><tr><td data-num=\"124\"></td><td><pre>\t\t<span class=\"token comment\">/*</pre></td></tr><tr><td data-num=\"125\"></td><td><pre>\t\t函数 SpyEnumerateFileSystemVolumes 枚举给定的文件系统下的当前存在的所有挂载了的设备，并且绑定他们。</pre></td></tr><tr><td data-num=\"126\"></td><td><pre>\t\t这样做的目的，是因为过滤驱动可能随时被加载，但是加载过滤驱动的时候，文件系统已经挂载了卷设备。</pre></td></tr><tr><td data-num=\"127\"></td><td><pre>\t\t既是：让过滤驱动加载后，随时都能绑定已经存在或刚刚挂载上来的文件系统卷设备。</pre></td></tr><tr><td data-num=\"128\"></td><td><pre>\t\t*/</span></pre></td></tr><tr><td data-num=\"129\"></td><td><pre>\t\tstatus <span class=\"token operator\">=</span> <span class=\"token function\">SfEnumerateFileSystemVolumes</span><span class=\"token punctuation\">(</span>DeviceObject<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>fsName<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"130\"></td><td><pre>\t\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token function\">NT_SUCCESS</span><span class=\"token punctuation\">(</span>status<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"131\"></td><td><pre>\t\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"132\"></td><td><pre>\t\t\t<span class=\"token function\">IoDetachDevice</span><span class=\"token punctuation\">(</span>devExt<span class=\"token operator\">-></span>AttachedToDeviceObject<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"133\"></td><td><pre>\t\t\t<span class=\"token keyword\">goto</span> ErrorCleanupDevice<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"134\"></td><td><pre>\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"135\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"136\"></td><td><pre></pre></td></tr><tr><td data-num=\"137\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">endif</span></span></pre></td></tr><tr><td data-num=\"138\"></td><td><pre></pre></td></tr><tr><td data-num=\"139\"></td><td><pre>\t<span class=\"token keyword\">return</span> STATUS_SUCCESS<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"140\"></td><td><pre>\t<span class=\"token comment\">// 错误处理</span></pre></td></tr><tr><td data-num=\"141\"></td><td><pre>ErrorCleanupDevice<span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"142\"></td><td><pre>\t<span class=\"token function\">SfCleanupMountedDevice</span><span class=\"token punctuation\">(</span>newDeviceObject<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"143\"></td><td><pre>\t<span class=\"token function\">IoDeleteDevice</span><span class=\"token punctuation\">(</span>newDeviceObject<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"144\"></td><td><pre></pre></td></tr><tr><td data-num=\"145\"></td><td><pre>\t<span class=\"token keyword\">return</span> status<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"146\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h2 id=\"利用文件系统控制请求\"><a class=\"anchor\" href=\"#利用文件系统控制请求\">#</a> 利用文件系统控制请求</h2>\n<p>文件系统控制设备已经被绑定， 绑定的目的是为了获得发送给文件系统控制设备的文件系统控制请求。 这些 IRP 的主功能号是 <code>IRP_MJ_FILE_SYSTEM_CONTROL</code> ， 一般每个主功能号下都有次功能号。</p>\n<p>从这些控制 IRP 中能得到足够的信息， 确定一个卷被挂载， 这样才有可能去绑定文件系统的卷设备。 最早在设置分发函数时， SfFsControl 函数就已经被设置了。 请回顾第 11.2.1 节 “普通的分发函数” 中对分发函数的设置。当有卷被挂载或者解挂载时， SfFsControl 就会被系统回调。 现在的任务是在这个函数中获得卷设备的相关信息并对它实行绑定， 才能捕获各种针对文件的 IRP， 从而获得监控各种文件操作的能力。</p>\n<p>主功能号为 IRP_MJ_FILE_SYSTEM_CONTROL 时， 有以下几个不同次功能号的 IRP 要处理：</p>\n<p>（1） 次功能号为 <code>IRP_MN_MOUNT_VOLUME</code> 。 说明一个卷被挂载， 应该调用 <code>SfFsControlMountVolume</code>  来绑定一个卷。在下一节中将会阐明 <code>SfFsControlMountVolume</code>  的实现方法。<br />\n（2） 次功能号为 <code>IRP_MN_LOAD_FILE_SYSTEM</code> 。 这个请求比较特殊， 它一般在文件系统识别器要求加载真正的文件系统时出现， 此时说明前面绑定了一个文件系统识别器， 现在应该从这里开始绑定真正的文件系统控制设备了。</p>\n<p>（3） 次功能号为 <code>IRP_MN_USER_FS_REQUEST</code> 。 可以从 <code>irpSp→Parameters.FileSystemControl.FsControlCode</code>  得到一个控制码， 当控制码为 <code>FSCTL_DISMOUNT_VOLUME</code>  时， 说明这是一个磁盘在解挂载。 （ 注： 手动拔出 U 盘并不会导致这个请求。 如果要捕获 U 盘的拔出， 需要更复杂的代码。 幸运的是， 读者会发现磁盘在解挂载后， 就算 sfilter 不删除过滤设备， 程序也不会出问题， 除了极少发生的内存泄漏。 所以本书将这个问题忽略。 ）</p>\n<p>相关代码如下：</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>NTSTATUS  <span class=\"token function\">SfFsControl</span><span class=\"token punctuation\">(</span>IN PDEVICE_OBJECT DeviceObject<span class=\"token punctuation\">,</span> IN PIRP Irp<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>\t<span class=\"token comment\">/*</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>\t参数说明:</pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>\tDeviceObject:    我们创建的设备对象。它是被绑定到文件系统控制设备对象栈上。</pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>\t*/</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\tPIO_STACK_LOCATION irpSp <span class=\"token operator\">=</span> <span class=\"token function\">IoGetCurrentIrpStackLocation</span><span class=\"token punctuation\">(</span>Irp<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>\t<span class=\"token function\">PAGED_CODE</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>\t<span class=\"token function\">ASSERT</span><span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token function\">IS_MY_CONTROL_DEVICE_OBJECT</span><span class=\"token punctuation\">(</span>DeviceObject<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>\t<span class=\"token function\">ASSERT</span><span class=\"token punctuation\">(</span><span class=\"token function\">IS_MY_DEVICE_OBJECT</span><span class=\"token punctuation\">(</span>DeviceObject<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>\t<span class=\"token comment\">// 分别处理次功能号</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>\t<span class=\"token keyword\">switch</span> <span class=\"token punctuation\">(</span>irpSp<span class=\"token operator\">-></span>MinorFunction<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>\t<span class=\"token keyword\">case</span> IRP_MN_MOUNT_VOLUME<span class=\"token operator\">:</span>\t\t\t\t\t\t\t\t\t<span class=\"token comment\">// 当一个卷被挂载</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>\t\t<span class=\"token keyword\">return</span> <span class=\"token function\">SfFsControlMountVolume</span><span class=\"token punctuation\">(</span>DeviceObject<span class=\"token punctuation\">,</span> Irp<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\t\t<span class=\"token comment\">// 调用函数去绑定这个卷</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>\t\t</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>\t<span class=\"token keyword\">case</span> IRP_MN_LOAD_FILE_SYSTEM<span class=\"token operator\">:</span>\t\t\t\t\t\t\t\t<span class=\"token comment\">// 当文件系统识别器要加载真正的文件系统时</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>\t\t<span class=\"token keyword\">return</span> <span class=\"token function\">SfFsControlLoadFileSystem</span><span class=\"token punctuation\">(</span>DeviceObject<span class=\"token punctuation\">,</span> Irp<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\t<span class=\"token comment\">// 调用函数去绑定真正的文件系统</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>\t<span class=\"token keyword\">case</span> IRP_MN_USER_FS_REQUEST<span class=\"token operator\">:</span>\t\t\t\t\t\t\t\t</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>\t\t<span class=\"token comment\">// 判断磁盘是否在解挂载</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>\t\t<span class=\"token keyword\">switch</span> <span class=\"token punctuation\">(</span>irpSp<span class=\"token operator\">-></span>Parameters<span class=\"token punctuation\">.</span>FileSystemControl<span class=\"token punctuation\">.</span>FsControlCode<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\t</pre></td></tr><tr><td data-num=\"28\"></td><td><pre></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>\t\t<span class=\"token keyword\">case</span> FSCTL_DISMOUNT_VOLUME<span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>\t\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>\t\t\t<span class=\"token comment\">// 可以什么都不做，仅仅打印一下 log</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>\t\t\tPSFILTER_DEVICE_EXTENSION devExt <span class=\"token operator\">=</span> DeviceObject<span class=\"token operator\">-></span>DeviceExtension<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>\t\t\t<span class=\"token function\">SF_LOG_PRINT</span><span class=\"token punctuation\">(</span>SFDEBUG_DISPLAY_ATTACHMENT_NAMES<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>\t\t\t\t<span class=\"token punctuation\">(</span><span class=\"token string\">\"SFilter!SfFsControl:                         Dismounting volume         %p \\\"%wZ\\\"\\n\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>\t\t\t\t\tdevExt<span class=\"token operator\">-></span>AttachedToDeviceObject<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>\t\t\t\t\t<span class=\"token operator\">&amp;</span>devExt<span class=\"token operator\">-></span>DeviceName<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>\t\t\t<span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>\t\t<span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>\t<span class=\"token comment\">// 不是我们关心的 IRP 直接下发</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>\t<span class=\"token function\">IoSkipCurrentIrpStackLocation</span><span class=\"token punctuation\">(</span>Irp<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>\t<span class=\"token keyword\">return</span> <span class=\"token function\">IoCallDriver</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>PSFILTER_DEVICE_EXTENSION<span class=\"token punctuation\">)</span>DeviceObject<span class=\"token operator\">-></span>DeviceExtension<span class=\"token punctuation\">)</span><span class=\"token operator\">-></span>AttachedToDeviceObject<span class=\"token punctuation\">,</span> Irp<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>看了上面的代码，我们还要知道 <code>SfFsControlMountVolume()</code>  是如何去绑定卷设备，以此监控所有的卷。</p>\n<p>另外在这个 <code>FSCTL_DISMOUNT_VOLUME</code>  中并没有做解除绑定和销毁设备的处理。 实际上， 这个请求的出现是理论性的。 在进行过的测试中， 这个请求似乎根本不会出现。 其他一些请求会出现， 但是往往不是一一对应的关系， 所以要真正准确地捕获解挂载操作是很困难的。</p>\n<p><code>sfilter</code>  采用了通融的办法， 并不解除绑定也不销毁设备。 可能是因为设备拔除对多余的设备并没有影响。 此外， 拔出与插入这样的情况并不会太频繁， 所以内存泄漏也不明显。</p>\n<p>这是书的作者个人的猜测， 作者并没有确认过是否有其他的机制能销毁设备。虽然有点不靠谱，但这些大佬都不知道，网上更别提什么资料了，大佬怎么做我们就怎么做吧。</p>\n<p>这里另外还有一个 <code>SfFsControlLoadFileSystem</code>  函数， 发生在 <code>IRP_MN_LOAD_FILESYS</code>  中。 这个功能码的意义是当一个文件识别器（见上文） 决定加载真正的文件系统时， 如果已经绑定了文件系统识别器， <strong>那么现在就应该解除绑定并销毁设备， 同时生成新的设备去绑定真的文件系统</strong>。</p>\n<p>直接看 <code>SfFsControlLoadFileSystem</code>  实现的代码：</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>NTSTATUS  <span class=\"token function\">SfFsControlLoadFileSystem</span><span class=\"token punctuation\">(</span>IN PDEVICE_OBJECT DeviceObject<span class=\"token punctuation\">,</span> IN PIRP Irp<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>\tPSFILTER_DEVICE_EXTENSION devExt <span class=\"token operator\">=</span> DeviceObject<span class=\"token operator\">-></span>DeviceExtension<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>\tNTSTATUS status<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>\tPFSCTRL_COMPLETION_CONTEXT completionContext<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>\t<span class=\"token function\">PAGED_CODE</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> </pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\t<span class=\"token function\">SF_LOG_PRINT</span><span class=\"token punctuation\">(</span>SFDEBUG_DISPLAY_ATTACHMENT_NAMES<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\t\t\t<span class=\"token punctuation\">(</span><span class=\"token string\">\"SFilter!SfFscontrolLoadFileSystem:           Loading File System, Detaching from \\\"%wZ\\\"\\n\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>\t\t\t\t<span class=\"token operator\">&amp;</span>devExt<span class=\"token operator\">-></span>DeviceName<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">if</span> <span class=\"token expression\">WINVER <span class=\"token operator\">>=</span> <span class=\"token number\">0x0501</span></span></span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">IS_WINDOWSXP_OR_LATER</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>\t\tKEVENT waitEvent<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>\t\t<span class=\"token function\">KeInitializeEvent</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>waitEvent<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>\t\t\tNotificationEvent<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>\t\t\tFALSE<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>\t\t<span class=\"token function\">IoCopyCurrentIrpStackLocationToNext</span><span class=\"token punctuation\">(</span>Irp<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>\t\t<span class=\"token function\">IoSetCompletionRoutine</span><span class=\"token punctuation\">(</span>Irp<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>\t\t\tSfFsControlCompletion<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>\t\t\t<span class=\"token operator\">&amp;</span>waitEvent<span class=\"token punctuation\">,</span>     <span class=\"token comment\">//context parameter</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>\t\t\tTRUE<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>\t\t\tTRUE<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>\t\t\tTRUE<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>\t\tstatus <span class=\"token operator\">=</span> <span class=\"token function\">IoCallDriver</span><span class=\"token punctuation\">(</span>devExt<span class=\"token operator\">-></span>AttachedToDeviceObject<span class=\"token punctuation\">,</span> Irp<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>\t\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>STATUS_PENDING <span class=\"token operator\">==</span> status<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>\t\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>\t\t\tstatus <span class=\"token operator\">=</span> <span class=\"token function\">KeWaitForSingleObject</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>waitEvent<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>\t\t\t\tExecutive<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>\t\t\t\tKernelMode<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>\t\t\t\tFALSE<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>\t\t\t\t<span class=\"token constant\">NULL</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>\t\t\t<span class=\"token function\">ASSERT</span><span class=\"token punctuation\">(</span>STATUS_SUCCESS <span class=\"token operator\">==</span> status<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>\t\t<span class=\"token function\">ASSERT</span><span class=\"token punctuation\">(</span><span class=\"token function\">KeReadStateEvent</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>waitEvent<span class=\"token punctuation\">)</span> <span class=\"token operator\">||</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>\t\t\t<span class=\"token operator\">!</span><span class=\"token function\">NT_SUCCESS</span><span class=\"token punctuation\">(</span>Irp<span class=\"token operator\">-></span>IoStatus<span class=\"token punctuation\">.</span>Status<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>\t\tstatus <span class=\"token operator\">=</span> <span class=\"token function\">SfFsControlLoadFileSystemComplete</span><span class=\"token punctuation\">(</span>DeviceObject<span class=\"token punctuation\">,</span> Irp<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>\t<span class=\"token keyword\">else</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">endif</span>    </span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre></pre></td></tr><tr><td data-num=\"54\"></td><td><pre>\t\tcompletionContext <span class=\"token operator\">=</span> <span class=\"token function\">ExAllocatePoolWithTag</span><span class=\"token punctuation\">(</span>NonPagedPool<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre>\t\t\t<span class=\"token keyword\">sizeof</span><span class=\"token punctuation\">(</span>FSCTRL_COMPLETION_CONTEXT<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>\t\t\tSFLT_POOL_TAG<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre></pre></td></tr><tr><td data-num=\"58\"></td><td><pre>\t\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>completionContext <span class=\"token operator\">==</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"59\"></td><td><pre></pre></td></tr><tr><td data-num=\"60\"></td><td><pre>\t\t\t<span class=\"token function\">IoSkipCurrentIrpStackLocation</span><span class=\"token punctuation\">(</span>Irp<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"61\"></td><td><pre>\t\t\tstatus <span class=\"token operator\">=</span> <span class=\"token function\">IoCallDriver</span><span class=\"token punctuation\">(</span>devExt<span class=\"token operator\">-></span>AttachedToDeviceObject<span class=\"token punctuation\">,</span> Irp<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"62\"></td><td><pre></pre></td></tr><tr><td data-num=\"63\"></td><td><pre>\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"64\"></td><td><pre>\t\t<span class=\"token keyword\">else</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"65\"></td><td><pre></pre></td></tr><tr><td data-num=\"66\"></td><td><pre>\t\t\t<span class=\"token function\">ExInitializeWorkItem</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>completionContext<span class=\"token operator\">-></span>WorkItem<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"67\"></td><td><pre>\t\t\t\tSfFsControlLoadFileSystemCompleteWorker<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"68\"></td><td><pre>\t\t\t\tcompletionContext<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"69\"></td><td><pre>\t\t\tcompletionContext<span class=\"token operator\">-></span>DeviceObject <span class=\"token operator\">=</span> DeviceObject<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"70\"></td><td><pre>\t\t\tcompletionContext<span class=\"token operator\">-></span>Irp <span class=\"token operator\">=</span> Irp<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"71\"></td><td><pre>\t\t\tcompletionContext<span class=\"token operator\">-></span>NewDeviceObject <span class=\"token operator\">=</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"72\"></td><td><pre></pre></td></tr><tr><td data-num=\"73\"></td><td><pre>\t\t\t<span class=\"token function\">IoCopyCurrentIrpStackLocationToNext</span><span class=\"token punctuation\">(</span>Irp<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"74\"></td><td><pre></pre></td></tr><tr><td data-num=\"75\"></td><td><pre>\t\t\t<span class=\"token function\">IoSetCompletionRoutine</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"76\"></td><td><pre>\t\t\t\tIrp<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"77\"></td><td><pre>\t\t\t\tSfFsControlCompletion<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"78\"></td><td><pre>\t\t\t\tcompletionContext<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"79\"></td><td><pre>\t\t\t\tTRUE<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"80\"></td><td><pre>\t\t\t\tTRUE<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"81\"></td><td><pre>\t\t\t\tTRUE<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"82\"></td><td><pre></pre></td></tr><tr><td data-num=\"83\"></td><td><pre>\t\t\t<span class=\"token function\">IoDetachDevice</span><span class=\"token punctuation\">(</span>devExt<span class=\"token operator\">-></span>AttachedToDeviceObject<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"84\"></td><td><pre>\t\t\tstatus <span class=\"token operator\">=</span> <span class=\"token function\">IoCallDriver</span><span class=\"token punctuation\">(</span>devExt<span class=\"token operator\">-></span>AttachedToDeviceObject<span class=\"token punctuation\">,</span> Irp<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"85\"></td><td><pre>\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"86\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">if</span> <span class=\"token expression\">WINVER <span class=\"token operator\">>=</span> <span class=\"token number\">0x0501</span></span></span></pre></td></tr><tr><td data-num=\"87\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"88\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">endif</span></span></pre></td></tr><tr><td data-num=\"89\"></td><td><pre></pre></td></tr><tr><td data-num=\"90\"></td><td><pre>\t<span class=\"token keyword\">return</span> status<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"91\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p><code>SfFsControlLoadFileSystem</code>  函数主要是设置了一个 IRP 完成回调函数，通过等待事件得知 IRP 请求事是否完成，最后调用 <code>SfFsControlLoadFileSystemComplete</code>  函数去绑定文件系统。</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>NTSTATUS  <span class=\"token function\">SfFsControlLoadFileSystemComplete</span><span class=\"token punctuation\">(</span>IN PDEVICE_OBJECT DeviceObject<span class=\"token punctuation\">,</span> IN PIRP Irp<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>\tPSFILTER_DEVICE_EXTENSION devExt<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>\tNTSTATUS status<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>\t<span class=\"token function\">PAGED_CODE</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>\tdevExt <span class=\"token operator\">=</span> DeviceObject<span class=\"token operator\">-></span>DeviceExtension<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\t<span class=\"token function\">SF_LOG_PRINT</span><span class=\"token punctuation\">(</span>SFDEBUG_DISPLAY_ATTACHMENT_NAMES<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\t\t<span class=\"token punctuation\">(</span><span class=\"token string\">\"SFilter!SfFsControlLoadFileSystem:           Detaching from recognizer  %p \\\"%wZ\\\", status=%08x\\n\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>\t\t\tDeviceObject<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>\t\t\t<span class=\"token operator\">&amp;</span>devExt<span class=\"token operator\">-></span>DeviceName<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>\t\t\tIrp<span class=\"token operator\">-></span>IoStatus<span class=\"token punctuation\">.</span>Status<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token function\">NT_SUCCESS</span><span class=\"token punctuation\">(</span>Irp<span class=\"token operator\">-></span>IoStatus<span class=\"token punctuation\">.</span>Status<span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token punctuation\">(</span>Irp<span class=\"token operator\">-></span>IoStatus<span class=\"token punctuation\">.</span>Status <span class=\"token operator\">!=</span> STATUS_IMAGE_ALREADY_LOADED<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>\t\t<span class=\"token function\">SfAttachDeviceToDeviceStack</span><span class=\"token punctuation\">(</span>DeviceObject<span class=\"token punctuation\">,</span> devExt<span class=\"token operator\">-></span>AttachedToDeviceObject<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>devExt<span class=\"token operator\">-></span>AttachedToDeviceObject<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>\t\t<span class=\"token function\">ASSERT</span><span class=\"token punctuation\">(</span>devExt<span class=\"token operator\">-></span>AttachedToDeviceObject <span class=\"token operator\">!=</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>\t<span class=\"token keyword\">else</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>\t\t<span class=\"token function\">SfCleanupMountedDevice</span><span class=\"token punctuation\">(</span>DeviceObject<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>\t\t<span class=\"token function\">IoDeleteDevice</span><span class=\"token punctuation\">(</span>DeviceObject<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>\tstatus <span class=\"token operator\">=</span> Irp<span class=\"token operator\">-></span>IoStatus<span class=\"token punctuation\">.</span>Status<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>\t<span class=\"token function\">IoCompleteRequest</span><span class=\"token punctuation\">(</span>Irp<span class=\"token punctuation\">,</span> IO_NO_INCREMENT<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>\t<span class=\"token keyword\">return</span> status<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>再次总结如下：<br />\n第一步： 生成一个控制设备。 当然， 此前必须给控制设备指定名称。<br />\n第二步： 设置分发函数和快速 IO 分发函数。<br />\n第三步： 编写一个文件系统变动回调函数， 在其中绑定刚激活的文件系统的控制设备， 并注册这个回调函数。<br />\n第四步： 编写默认的分发函数。<br />\n第五步： 处理文件系统控制请求（IRP 的主功能号为 IRP_MJ_FILE_SYSTEM_CONTROL） ， 在其中监控卷设备的挂载和解挂载。</p>\n<h1 id=\"绑定文件系统卷设备\"><a class=\"anchor\" href=\"#绑定文件系统卷设备\">#</a> 绑定文件系统卷设备</h1>\n<h2 id=\"从irp中获得vpb指针\"><a class=\"anchor\" href=\"#从irp中获得vpb指针\">#</a> 从 IRP 中获得 VPB 指针</h2>\n<p>前面我们实现了  <code>SfFsControlLoadFileSystem</code>  函数，接下来实现 <code>SfFsControlMountVolume</code>  函数的代码， 实现绑定文件系统卷的功能。</p>\n<p>如何从这个 IRP 的信息中得到文件系统的卷设备呢？</p>\n<p>实际上， 卷设备就在 <code>irpSp→Parameters.MountVolume.Vpb→DeviceObject</code>  中（irpSp 是这个 IRP 的当前栈空间指针）。</p>\n<p>指针 <code>irpSp→Parameters.MountVolume.Vpb</code>  是一个 VPB。<strong>VPB 是卷参数块（VolumeParameter Block），一个重要的数据结构，它在这里的主要作用是把实际的存储媒介设备对象和文件系统上的卷设备对象联系起来</strong>。</p>\n<p>用 VPB 来对下面的代码做一下倒手工作。 首先从 <code>irpSp</code>  中获得文件系统卷设备的 VPB， 然后从 VPB 中获得一个存储设备对象。</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">// 从 VPB 中获得一个存储设备对象</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>storageStackDeviceObject <span class=\"token operator\">=</span> irpSp<span class=\"token operator\">-></span>Parameters<span class=\"token punctuation\">.</span>MountVolume<span class=\"token punctuation\">.</span>Vpb<span class=\"token operator\">-></span>RealDevice<span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>以后可以从这个存储设备对象再得到原来的 VPB。 这里记下存储设备， 实际上是为了从存储设备对象找回 VPB， 再找回文件系统的卷设备。 为什么需要这个倒手过程呢？</p>\n<p>这里的 IRP 是一个挂载请求， 而文件系统的卷设备对象实际上在请求完成之后才可用。因此，在请求还没有完成之前 <code>irpSp→Parameters.MountVolume.Vpb→DeviceObject</code>  是没有意义的，必须等这个 IRP 完成后 <code>irpSp→Parameters.MountVolume.Vpb→DeviceObject</code>  才是需要绑定的设备对象。</p>\n<p>但是在这个 IRP 传递的过程中， <code>irpSp→Parameters.MountVolume.Vpb</code>  可能会被修改。</p>\n<p>换句话说，在 IRP 完成之后，这个指针就可能已经不是原来的那个了。 对这种情况的处理， WDK 的文档中有一段特殊的说明，引用如下（请注意这段话经过翻译）。</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>irpSp<span class=\"token operator\">-></span>Parameters<span class=\"token punctuation\">.</span>MountVolume<span class=\"token punctuation\">.</span>Vpb</pre></td></tr></table></figure><p>指向一个被挂载卷的卷参数块（VPB）指针。支持可移动介质的文件系统，可能替换掉预先传入的参数。 在这样的文件系统中， 卷被挂载后， 指针可能不再有效。</p>\n<p>过滤这种文件系统的过滤驱动必须按下面的方法使用这个参数： <strong>在把 IRP 发送到下层驱动之前， 保存 <code>irpSp→Parameters.MountVolume.Vpb→RealDevice</code>  的值。在这个卷被成功挂载之后， 过滤驱动可以通过这个存储设备的指针重新获得正确的 VPB 指针</strong>。</p>\n<p>为此，必须先获得 <code>irpSp→Parameters.MountVolume.Vpb→RealDevice</code>  的值并将其保存起来， 等待 IRP 完成之后， 再从 RealDevice 中获得的 VPB 才是正确的。</p>\n<h2 id=\"设置完成函数并等待irp完成\"><a class=\"anchor\" href=\"#设置完成函数并等待irp完成\">#</a> 设置完成函数并等待 IRP 完成</h2>\n<p>在本书前面的几个例子中， 都讲过等待 IRP 完成的方法。 读者可以回忆一下： 首先拷贝当前栈空间， 然后向下发送请求， 但在此之前， 要先给 IRP 分配一个完成函数。 一旦 IRP 完成， 完成函数将被调用。 这样， 就可以在完成函数中得到文件系统的卷设备， 并实施绑定过程。</p>\n<p>完成函数的一个特点是它处于 Dispatch 中断级， 这是一个比较高的级别。 总之， 任何代码执行时， 总是处在某个当前的中断级之中。 某些系统调用只能在低级别的中断级中执行。 请注意， 如果一个调用可以在高级别运行， 那么它就能在低级别运行； 反过来则不行。</p>\n<p>读者需要关心的只有 Passive 中断级和 Dispatch 中断级， 而且 Dispatch 中断级的级别较高。 一般 WDK 的函数在帮助中都会标明， 如果标明 “irq level=PASSIVE”， 那么就不能在 Dispatch 中断级的代码中调用它们了。</p>\n<p>那么如何判断当前的代码处于哪个中断级呢？ 之前我们使用 <code>KeGetCurrentIrql</code>  函数。</p>\n<p>这里有一个更加实际的判断方法： <em>在实际编码中， 一般都认为如果代码执行是由应用程序（或者说上层） 的调用引发的， 则应该在 Passive 中断级； 如果代码执行是由下层硬件引发的， 则有可能在 Dispatch 中断级</em>。</p>\n<p>以上只是极为粗略的便于记忆的理解方法， 而实际的应用是这样的： 由于所有的分发函数都是由上层发来的 IRP 而导致的调用， 所以应该都在 Passive 中断级， 在其中可以调用绝大多数系统调用。 而如网卡的 OnReceive、 硬盘读 / 写完毕返回而回调的完成函数， 都有可能在 Dispatch 中断级。 注意都是有可能，而不是绝对是。 但是一旦有了可能， 在调用其他函数时， 当然就应该按照最坏的情况考虑。</p>\n<p>下面是 <code>SfFsControlMountVolume</code>  的执行过程。 这里没有绑定卷设备， 而是把 IRP 发送下去， 等待完成之后， 再在完成函数中绑定。</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>NTSTATUS  <span class=\"token function\">SfFsControlMountVolume</span><span class=\"token punctuation\">(</span>IN PDEVICE_OBJECT DeviceObject<span class=\"token punctuation\">,</span> IN PIRP Irp<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>\t<span class=\"token comment\">/*</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>\t参数说明:</pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>\tDeviceObject:    它是我们创建的设备对象。它被绑定到文件系统 CDO 的设备栈上。</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>\tIrp:             它是发送给文件系统 CDO 的挂载请求。它是一个新卷的挂载请求。</pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\t*/</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>\tPSFILTER_DEVICE_EXTENSION devExt <span class=\"token operator\">=</span> DeviceObject<span class=\"token operator\">-></span>DeviceExtension<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>\tPIO_STACK_LOCATION irpSp <span class=\"token operator\">=</span> <span class=\"token function\">IoGetCurrentIrpStackLocation</span><span class=\"token punctuation\">(</span>Irp<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>\tPDEVICE_OBJECT storageStackDeviceObject<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre></pre></td></tr><tr><td data-num=\"16\"></td><td><pre></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>\t<span class=\"token comment\">//newDeviceObject 是将要绑定到文件系统的卷设备对象上。或者说，这个 newDeviceObject 要被绑定到新挂载卷的设备卷上。</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>\tPDEVICE_OBJECT newDeviceObject<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>\tPSFILTER_DEVICE_EXTENSION newDevExt<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>\tNTSTATUS status<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>\tBOOLEAN isShadowCopyVolume<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>\tPFSCTRL_COMPLETION_CONTEXT completionContext<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre></pre></td></tr><tr><td data-num=\"25\"></td><td><pre></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>\t<span class=\"token function\">PAGED_CODE</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>\t<span class=\"token function\">ASSERT</span><span class=\"token punctuation\">(</span><span class=\"token function\">IS_MY_DEVICE_OBJECT</span><span class=\"token punctuation\">(</span>DeviceObject<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>\t<span class=\"token function\">ASSERT</span><span class=\"token punctuation\">(</span><span class=\"token function\">IS_DESIRED_DEVICE_TYPE</span><span class=\"token punctuation\">(</span>DeviceObject<span class=\"token operator\">-></span>DeviceType<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre></pre></td></tr><tr><td data-num=\"31\"></td><td><pre></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>\t<span class=\"token comment\">/*</pre></td></tr><tr><td data-num=\"33\"></td><td><pre>\t 在把 IRP 发送到文件系统之前，当挂载请求到来时，Vpb->RealDevice 保存的是：将要被挂载的磁盘设备对象。</pre></td></tr><tr><td data-num=\"34\"></td><td><pre>\t storageStackDeviceObject 事先保存了 VPB 的值，这是因为：当 IRP 下发给底层驱动后，可能会改变。</pre></td></tr><tr><td data-num=\"35\"></td><td><pre>\t */</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>\tstorageStackDeviceObject <span class=\"token operator\">=</span> irpSp<span class=\"token operator\">-></span>Parameters<span class=\"token punctuation\">.</span>MountVolume<span class=\"token punctuation\">.</span>Vpb<span class=\"token operator\">-></span>RealDevice<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>\t<span class=\"token comment\">// 判断是否是卷影</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>\tstatus <span class=\"token operator\">=</span> <span class=\"token function\">SfIsShadowCopyVolume</span><span class=\"token punctuation\">(</span>storageStackDeviceObject<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>isShadowCopyVolume<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">NT_SUCCESS</span><span class=\"token punctuation\">(</span>status<span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;&amp;</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>\t\tisShadowCopyVolume <span class=\"token operator\">&amp;&amp;</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>\t\t<span class=\"token operator\">!</span><span class=\"token function\">FlagOn</span><span class=\"token punctuation\">(</span>SfDebug<span class=\"token punctuation\">,</span> SFDEBUG_ATTACH_TO_SHADOW_COPIES<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>\t\t<span class=\"token comment\">// 打印 log</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>\t\tUNICODE_STRING shadowDeviceName<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>\t\tWCHAR shadowNameBuffer<span class=\"token punctuation\">[</span>MAX_DEVNAME_LENGTH<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>\t\t<span class=\"token function\">RtlInitEmptyUnicodeString</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>shadowDeviceName<span class=\"token punctuation\">,</span> shadowNameBuffer<span class=\"token punctuation\">,</span> <span class=\"token keyword\">sizeof</span><span class=\"token punctuation\">(</span>shadowNameBuffer<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>\t\t<span class=\"token function\">SfGetObjectName</span><span class=\"token punctuation\">(</span>storageStackDeviceObject<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>shadowDeviceName<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>\t\t<span class=\"token function\">SF_LOG_PRINT</span><span class=\"token punctuation\">(</span>SFDEBUG_DISPLAY_ATTACHMENT_NAMES<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre>\t\t\t<span class=\"token punctuation\">(</span><span class=\"token string\">\"SFilter!SfFsControlMountVolume               Not attaching to Volume    %p \\\"%wZ\\\", shadow copy volume\\n\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>\t\t\t\tstorageStackDeviceObject<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre>\t\t\t\t<span class=\"token operator\">&amp;</span>shadowDeviceName<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>\t\t<span class=\"token comment\">// 如果不打算绑定卷影则跳到下一层驱动</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre>\t\t<span class=\"token function\">IoSkipCurrentIrpStackLocation</span><span class=\"token punctuation\">(</span>Irp<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre>\t\t<span class=\"token keyword\">return</span> <span class=\"token function\">IoCallDriver</span><span class=\"token punctuation\">(</span>devExt<span class=\"token operator\">-></span>AttachedToDeviceObject<span class=\"token punctuation\">,</span> Irp<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"59\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre></pre></td></tr><tr><td data-num=\"61\"></td><td><pre>\t<span class=\"token comment\">// 生成过滤设备</span></pre></td></tr><tr><td data-num=\"62\"></td><td><pre>\tstatus <span class=\"token operator\">=</span> <span class=\"token function\">IoCreateDevice</span><span class=\"token punctuation\">(</span>gSFilterDriverObject<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"63\"></td><td><pre>\t\t<span class=\"token keyword\">sizeof</span><span class=\"token punctuation\">(</span>SFILTER_DEVICE_EXTENSION<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"64\"></td><td><pre>\t\t<span class=\"token constant\">NULL</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"65\"></td><td><pre>\t\tDeviceObject<span class=\"token operator\">-></span>DeviceType<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"66\"></td><td><pre>\t\t<span class=\"token number\">0</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"67\"></td><td><pre>\t\tFALSE<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"68\"></td><td><pre>\t\t<span class=\"token operator\">&amp;</span>newDeviceObject<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"69\"></td><td><pre></pre></td></tr><tr><td data-num=\"70\"></td><td><pre></pre></td></tr><tr><td data-num=\"71\"></td><td><pre></pre></td></tr><tr><td data-num=\"72\"></td><td><pre>\t<span class=\"token comment\">/* 如果不把 IRP 发送到文件系统中，那么文件系统就不会收到这个卷的挂载请求。*/</span></pre></td></tr><tr><td data-num=\"73\"></td><td><pre>\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token function\">NT_SUCCESS</span><span class=\"token punctuation\">(</span>status<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"74\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"75\"></td><td><pre>\t\t<span class=\"token function\">KdPrint</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"SFilter!SfFsControlMountVolume: Error creating volume device object, status=%08x\\n\"</span><span class=\"token punctuation\">,</span> status<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"76\"></td><td><pre></pre></td></tr><tr><td data-num=\"77\"></td><td><pre>\t\tIrp<span class=\"token operator\">-></span>IoStatus<span class=\"token punctuation\">.</span>Information <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"78\"></td><td><pre>\t\tIrp<span class=\"token operator\">-></span>IoStatus<span class=\"token punctuation\">.</span>Status <span class=\"token operator\">=</span> status<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"79\"></td><td><pre>\t\t<span class=\"token function\">IoCompleteRequest</span><span class=\"token punctuation\">(</span>Irp<span class=\"token punctuation\">,</span> IO_NO_INCREMENT<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"80\"></td><td><pre></pre></td></tr><tr><td data-num=\"81\"></td><td><pre>\t\t<span class=\"token keyword\">return</span> status<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"82\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"83\"></td><td><pre></pre></td></tr><tr><td data-num=\"84\"></td><td><pre></pre></td></tr><tr><td data-num=\"85\"></td><td><pre>\t<span class=\"token comment\">// 填写设备扩展，这样目的是：可以让完成函数更容易到 storageStackDeviceObject</span></pre></td></tr><tr><td data-num=\"86\"></td><td><pre>\tnewDevExt <span class=\"token operator\">=</span> newDeviceObject<span class=\"token operator\">-></span>DeviceExtension<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"87\"></td><td><pre>\tnewDevExt<span class=\"token operator\">-></span>StorageStackDeviceObject <span class=\"token operator\">=</span> storageStackDeviceObject<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"88\"></td><td><pre>\t<span class=\"token function\">RtlInitEmptyUnicodeString</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>newDevExt<span class=\"token operator\">-></span>DeviceName<span class=\"token punctuation\">,</span> newDevExt<span class=\"token operator\">-></span>DeviceNameBuffer<span class=\"token punctuation\">,</span> <span class=\"token keyword\">sizeof</span><span class=\"token punctuation\">(</span>newDevExt<span class=\"token operator\">-></span>DeviceNameBuffer<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"89\"></td><td><pre>\t<span class=\"token function\">SfGetObjectName</span><span class=\"token punctuation\">(</span>storageStackDeviceObject<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>newDevExt<span class=\"token operator\">-></span>DeviceName<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"90\"></td><td><pre></pre></td></tr><tr><td data-num=\"91\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">if</span> <span class=\"token expression\">WINVER <span class=\"token operator\">>=</span> <span class=\"token number\">0x0501</span></span></span></pre></td></tr><tr><td data-num=\"92\"></td><td><pre></pre></td></tr><tr><td data-num=\"93\"></td><td><pre>\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">IS_WINDOWSXP_OR_LATER</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"94\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"95\"></td><td><pre></pre></td></tr><tr><td data-num=\"96\"></td><td><pre>\t\t<span class=\"token comment\">// 在这里设置了事件对象，把它用在完成例程中。这样做的目的是：通知当前例程，文件系统已经完成了当前卷的挂载。</span></pre></td></tr><tr><td data-num=\"97\"></td><td><pre>\t\tKEVENT waitEvent<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"98\"></td><td><pre>\t\t<span class=\"token function\">KeInitializeEvent</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>waitEvent<span class=\"token punctuation\">,</span> NotificationEvent<span class=\"token punctuation\">,</span> FALSE<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"99\"></td><td><pre>\t\t<span class=\"token function\">IoCopyCurrentIrpStackLocationToNext</span><span class=\"token punctuation\">(</span>Irp<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"100\"></td><td><pre>\t\t<span class=\"token function\">IoSetCompletionRoutine</span><span class=\"token punctuation\">(</span>Irp<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"101\"></td><td><pre>\t\t\tSfFsControlCompletion<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"102\"></td><td><pre>\t\t\t<span class=\"token operator\">&amp;</span>waitEvent<span class=\"token punctuation\">,</span>     <span class=\"token comment\">//context parameter</span></pre></td></tr><tr><td data-num=\"103\"></td><td><pre>\t\t\tTRUE<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"104\"></td><td><pre>\t\t\tTRUE<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"105\"></td><td><pre>\t\t\tTRUE<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"106\"></td><td><pre>\t\tstatus <span class=\"token operator\">=</span> <span class=\"token function\">IoCallDriver</span><span class=\"token punctuation\">(</span>devExt<span class=\"token operator\">-></span>AttachedToDeviceObject<span class=\"token punctuation\">,</span> Irp<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"107\"></td><td><pre>\t\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>STATUS_PENDING <span class=\"token operator\">==</span> status<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"108\"></td><td><pre>\t\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"109\"></td><td><pre></pre></td></tr><tr><td data-num=\"110\"></td><td><pre>\t\t\t<span class=\"token comment\">// 等待更底层的驱动完成，然后就会调用完成例程。</span></pre></td></tr><tr><td data-num=\"111\"></td><td><pre>\t\t\tstatus <span class=\"token operator\">=</span> <span class=\"token function\">KeWaitForSingleObject</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>waitEvent<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"112\"></td><td><pre>\t\t\t\tExecutive<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"113\"></td><td><pre>\t\t\t\tKernelMode<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"114\"></td><td><pre>\t\t\t\tFALSE<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"115\"></td><td><pre>\t\t\t\t<span class=\"token constant\">NULL</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"116\"></td><td><pre>\t\t\t<span class=\"token function\">ASSERT</span><span class=\"token punctuation\">(</span>STATUS_SUCCESS <span class=\"token operator\">==</span> status<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"117\"></td><td><pre>\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"118\"></td><td><pre>\t\t<span class=\"token function\">ASSERT</span><span class=\"token punctuation\">(</span><span class=\"token function\">KeReadStateEvent</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>waitEvent<span class=\"token punctuation\">)</span> <span class=\"token operator\">||</span></pre></td></tr><tr><td data-num=\"119\"></td><td><pre>\t\t\t<span class=\"token operator\">!</span><span class=\"token function\">NT_SUCCESS</span><span class=\"token punctuation\">(</span>Irp<span class=\"token operator\">-></span>IoStatus<span class=\"token punctuation\">.</span>Status<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"120\"></td><td><pre></pre></td></tr><tr><td data-num=\"121\"></td><td><pre></pre></td></tr><tr><td data-num=\"122\"></td><td><pre>\t\t<span class=\"token comment\">// 执行到了这里，说明卷的挂载已经完成，要开始绑定卷了。等到完成函数设置了事件之后，再来绑定卷。</span></pre></td></tr><tr><td data-num=\"123\"></td><td><pre>\t\tstatus <span class=\"token operator\">=</span> <span class=\"token function\">SfFsControlMountVolumeComplete</span><span class=\"token punctuation\">(</span>DeviceObject<span class=\"token punctuation\">,</span> Irp<span class=\"token punctuation\">,</span> newDeviceObject<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"124\"></td><td><pre></pre></td></tr><tr><td data-num=\"125\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"126\"></td><td><pre>\t<span class=\"token keyword\">else</span></pre></td></tr><tr><td data-num=\"127\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"128\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">endif</span></span></pre></td></tr><tr><td data-num=\"129\"></td><td><pre>\t\tcompletionContext <span class=\"token operator\">=</span> <span class=\"token function\">ExAllocatePoolWithTag</span><span class=\"token punctuation\">(</span>NonPagedPool<span class=\"token punctuation\">,</span> <span class=\"token keyword\">sizeof</span><span class=\"token punctuation\">(</span>FSCTRL_COMPLETION_CONTEXT<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> SFLT_POOL_TAG<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"130\"></td><td><pre>\t\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>completionContext <span class=\"token operator\">==</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"131\"></td><td><pre>\t\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"132\"></td><td><pre>\t\t\t<span class=\"token function\">IoSkipCurrentIrpStackLocation</span><span class=\"token punctuation\">(</span>Irp<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"133\"></td><td><pre>\t\t\tstatus <span class=\"token operator\">=</span> <span class=\"token function\">IoCallDriver</span><span class=\"token punctuation\">(</span>devExt<span class=\"token operator\">-></span>AttachedToDeviceObject<span class=\"token punctuation\">,</span> Irp<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"134\"></td><td><pre>\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"135\"></td><td><pre>\t\t<span class=\"token keyword\">else</span></pre></td></tr><tr><td data-num=\"136\"></td><td><pre>\t\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"137\"></td><td><pre>\t\t\t<span class=\"token comment\">// 初始化一个工作任务。指定一个有待执行的函数 SfFsControlMountVolumeCompleteWorker，把这个函数插入到某个线程中去执行。</span></pre></td></tr><tr><td data-num=\"138\"></td><td><pre>\t\t\t<span class=\"token function\">ExInitializeWorkItem</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>completionContext<span class=\"token operator\">-></span>WorkItem<span class=\"token punctuation\">,</span> SfFsControlMountVolumeCompleteWorker<span class=\"token punctuation\">,</span> completionContext<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"139\"></td><td><pre>\t\t\tcompletionContext<span class=\"token operator\">-></span>DeviceObject <span class=\"token operator\">=</span> DeviceObject<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"140\"></td><td><pre>\t\t\tcompletionContext<span class=\"token operator\">-></span>Irp <span class=\"token operator\">=</span> Irp<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"141\"></td><td><pre>\t\t\tcompletionContext<span class=\"token operator\">-></span>NewDeviceObject <span class=\"token operator\">=</span> newDeviceObject<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"142\"></td><td><pre>\t\t\t<span class=\"token function\">IoCopyCurrentIrpStackLocationToNext</span><span class=\"token punctuation\">(</span>Irp<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"143\"></td><td><pre>\t\t\t<span class=\"token function\">IoSetCompletionRoutine</span><span class=\"token punctuation\">(</span>Irp<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"144\"></td><td><pre>\t\t\t\tSfFsControlCompletion<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"145\"></td><td><pre>\t\t\t\t<span class=\"token operator\">&amp;</span>completionContext<span class=\"token operator\">-></span>WorkItem<span class=\"token punctuation\">,</span> <span class=\"token comment\">//context parameter</span></pre></td></tr><tr><td data-num=\"146\"></td><td><pre>\t\t\t\tTRUE<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"147\"></td><td><pre>\t\t\t\tTRUE<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"148\"></td><td><pre>\t\t\t\tTRUE<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"149\"></td><td><pre>\t\t\tstatus <span class=\"token operator\">=</span> <span class=\"token function\">IoCallDriver</span><span class=\"token punctuation\">(</span>devExt<span class=\"token operator\">-></span>AttachedToDeviceObject<span class=\"token punctuation\">,</span> Irp<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"150\"></td><td><pre>\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"151\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">if</span> <span class=\"token expression\">WINVER <span class=\"token operator\">>=</span> <span class=\"token number\">0x0501</span>        </span></span></pre></td></tr><tr><td data-num=\"152\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"153\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">endif</span></span></pre></td></tr><tr><td data-num=\"154\"></td><td><pre></pre></td></tr><tr><td data-num=\"155\"></td><td><pre>\t<span class=\"token keyword\">return</span> status<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"156\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>上面的代码中提到了卷影，卷影是 Windows 系统自带的一种用于磁盘数据恢复的特殊设备， 在本例中不打算对卷影进行过滤。 如何判断是否是卷影并不是重要的问题， 略， 有兴趣可以自行参考 <code>sfilter</code>  的代码。</p>\n<hr />\n<p>当完成函数被调用时， 请求就结束了。 可以向完成函数传递一个上下文指针来保存我们的信息， 以确定哪一次调用与哪一次完成对应。</p>\n<p>有一种经典的同步方法： <strong>初始化一个事件（KEVENT） ， 并通过上下文传递到完成函数中。 在完成函数中设置该事件， 而本函数则等待这个事件， 在等待结束时， 请求就完成了</strong>。</p>\n<p><code>SfFsControlMountVolume</code>  后面的代码中， 有几处是目标操作系统的编译时和运行时判断，具体的处理下面有相关解释。</p>\n<p>请注意 <code>IoSetCompletionRoutine</code>  的第三个参数， 就是完成函数中的 Context 指针。 这是为了将信息传递到完成函数的接口。 上面填写的信息是那个事件的指针， 因为在这里发送 IRP 之后， 下面就要等待完成函数的发生， 所以把事件指针传递给完成函数。 完成函数只要一被调用， 就设置这个事件， 这样， 只要等待那个事件， 就知道这个请求什么时候完成了。 在完成函数中， 应该取得 Context 并把它当作一个事件指针直接设置。</p>\n<p>所以我们在完成函数 <code>SfFsControlCompletion</code>  中的核心就是一句代码：</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">// 设置了等待事件</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token function\">KeSetEvent</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>PKEVENT<span class=\"token punctuation\">)</span>Context<span class=\"token punctuation\">,</span> IO_NO_INCREMENT<span class=\"token punctuation\">,</span> FALSE<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>因为是这个事件是 <code>NotificationEvevt</code>  类型的，在完成函数中一设置，那么另一边 <code>SfFsControlMountVolume</code>  中，代码就不会继续卡在 <code>KeWaitForSingleObject</code>  了，这样， 只要执行过 <code>KeWaitForSingleObject</code> ，IRP 请求就已经完成了， 之后执行绑定卷的操作即可。</p>\n<h2 id=\"完整的卷挂载irp完成函数\"><a class=\"anchor\" href=\"#完整的卷挂载irp完成函数\">#</a> 完整的卷挂载 IRP 完成函数</h2>\n<p>前面的代码很容易让人产生疑问： 为何不在完成函数中直接绑定设备， 而非要等完成函数设置了事件之后， 再回来做呢？ 这是<em>因为完成函数的中断级别过高</em>。 虽然 Dispatch 中断级应该可以执行 <code>IoAttachDeviceToDeviceStack</code> ， 但是在绑定卷的过程中，  <code>sfilter</code>  使用了 <code>ExAcquireFastMutex</code>  来等待这些不适宜在 Dispatch 级别使用的函数。</p>\n<h3 id=\"低版本windows的兼容处理\"><a class=\"anchor\" href=\"#低版本windows的兼容处理\">#</a> 低版本 Windows 的兼容处理</h3>\n<p><code>SfFsControlMountVolume</code>  后面的代码中， 有几处是目标操作系统的编译时和运行时判断，这是因为用事件等待完成函数的发生虽然是一个通用的方法， 但是在 Windows 2000 上， 如果采用这样的方法， 则在绑定卷设备时可能发生死锁。 这是 Windows 早期的固有缺陷， 这里忽略该问题的原因， 直接应用 <code>sfilter</code>  中的解决方法， 对 Windows 2000 的情况进行特殊处理。</p>\n<p>解决方法是<strong>在完成函数中把任务放到一个预先生成的系统线程中处理。系统线程执行的中断级别为 Passive 中断级， 在这个线程中完成绑定是没有问题的</strong>。</p>\n<p>Windows 本身有一个系统线程负责处理一些日常工作， 也可以把自己的工作任务插入其中， 以免除需要多生成一个线程的开销。</p>\n<p>剩下的是运行时用 <code>IS_WINDOWSXP_OR_LATER</code>  来判断驱动是运行在 Windows XP 或者更高级的版本上， 还是运行在 Windows XP 以下的版本（主要是指 Windows 2000） 上。</p>\n<p>其区别是， 在 Windows XP 或者以上的操作系统中， <em>都使用生成事件、 传递给完成函数、等待完成函数通知完成之后直接绑定的方法</em>。</p>\n<p>在 Windows 2000 中， 比较特殊地采用了<em>生成工作任务、 传递给完成函数、 完成函数将任务插入系统工作线程中的方法</em>。 显然 Windows 2000 下的处理比较麻烦， 在一般的开发中（包括 Windows XP、 Windows 2003、 Windows Vista） 都应该使用简单的方案。</p>\n<p>在 Windows 中， <strong>所谓的工作任务（Work Item） 的本质是用户可以自由指定的一个有待执行的函数</strong>。</p>\n<p>这个函数可以插入到某个线程中去执行。 使用内核 API 函数 <code>ExInitializeWorkItem</code>  可以初始化一个工作任务。</p>\n<p>这个内核 API 的函数原型如下：</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>VOID</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token function\">ExInitializeWorkItem</span> <span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    _Out_    PWORK_QUEUE_ITEM Item<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    _In_opt_ PWORKER_THREAD_ROUTINE Routine<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    _In_opt_ PVOID Context</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    Item<span class=\"token operator\">-></span>WorkerRoutine <span class=\"token operator\">=</span> Routine<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    Item<span class=\"token operator\">-></span>Parameter <span class=\"token operator\">=</span> Context<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    Item<span class=\"token operator\">-></span>List<span class=\"token punctuation\">.</span>Flink <span class=\"token operator\">=</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>第一个参数是要初始化的工作任务；<br />\n第二个参数就是我们的待执行函数；<br />\n第三个参数是一个上下文指针， 其内部结构完全由用户自定义。工作任务机制确保这个指针作为一个参数原封不动地传入到我们指定执行的函数（也就是第二个参数 Routine） 中， 用来传递设置与执行之间的信息。</p>\n<p>使用内核 API 函数 <code>ExQueueWorkItem</code>  可以将这个工作任务插入到某个队列中。Windows 内核会依次执行这些队列中的工作任务， 而且执行时会确保中断级别是 Passive 级。 函数 <code>ExQueueWorkItem</code>  会在下一小节的开头做详细介绍。</p>\n<h2 id=\"完成函数的相应实现\"><a class=\"anchor\" href=\"#完成函数的相应实现\">#</a> 完成函数的相应实现</h2>\n<p>完成函数也必须相应地修改一下， 在其中区分 Windows 2000 和 Windows XP 及以上操作系统的不同情况， 即一种情况是设置一个事件， 而另一种情况则是要插入工作任务。 插入工作任务使用内核 API 函数 <code>ExQueueWorkItem</code> ， 该函数的原型如下：</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>VOID</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token function\">ExQueueWorkItem</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    IN PWORK_QUEUE_ITEM WorkItem<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    IN WORK_QUEUE_TYPE QueueType</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>第一个参数是工作任务的指针。<br />\n第二个参数是枚举型常数， 用户可以选择 <code>CriticalWorkQueue</code>  或者 <code>DelayedWorkQueue</code> 。 二者的区别在于执行的优先级， <code>CriticalWorkQueue</code>  的执行优先级比较高， 而 <code>DelayedWorkQueue</code>  的执行优先级根据系统当前状态的变化而变化。 一般地说， 如果只是为了在 Passive 中断级执行某些代码， 指定 <code>DelayedWorkQueue</code>  即可。</p>\n<p>下面是比较完整的完成函数的实现， 请注意工作任务是在 IRP 的分发函数里初始化的， 但是通过上下文指针传递到了完成函数中。</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>NTSTATUS  <span class=\"token function\">SfFsControlCompletion</span><span class=\"token punctuation\">(</span>IN PDEVICE_OBJECT DeviceObject<span class=\"token punctuation\">,</span> IN PIRP Irp<span class=\"token punctuation\">,</span> IN PVOID Context<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>\t<span class=\"token function\">UNREFERENCED_PARAMETER</span><span class=\"token punctuation\">(</span>DeviceObject<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>\t<span class=\"token function\">UNREFERENCED_PARAMETER</span><span class=\"token punctuation\">(</span>Irp<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>\t<span class=\"token function\">ASSERT</span><span class=\"token punctuation\">(</span><span class=\"token function\">IS_MY_DEVICE_OBJECT</span><span class=\"token punctuation\">(</span>DeviceObject<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>\t<span class=\"token function\">ASSERT</span><span class=\"token punctuation\">(</span>Context <span class=\"token operator\">!=</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">if</span> <span class=\"token expression\">WINVER <span class=\"token operator\">>=</span> <span class=\"token number\">0x0501</span></span></span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">IS_WINDOWSXP_OR_LATER</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>\t\t<span class=\"token function\">KeSetEvent</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>PKEVENT<span class=\"token punctuation\">)</span>Context<span class=\"token punctuation\">,</span> IO_NO_INCREMENT<span class=\"token punctuation\">,</span> FALSE<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>\t<span class=\"token keyword\">else</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">endif</span></span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>\t\t<span class=\"token comment\">// 如果中断等级过高时，工作任务放到 DelayeWorkQueue 队列中执行</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>\t\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">KeGetCurrentIrql</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">></span> PASSIVE_LEVEL<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>\t\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>\t\t\t<span class=\"token function\">ExQueueWorkItem</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>PWORK_QUEUE_ITEM<span class=\"token punctuation\">)</span>Context<span class=\"token punctuation\">,</span> DelayedWorkQueue<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>\t\t<span class=\"token keyword\">else</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>\t\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>\t\t\t<span class=\"token comment\">// 否则直接执行 SfFsControlMountVolumeCompleteWorker 函数</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>\t\t\tPWORK_QUEUE_ITEM workItem <span class=\"token operator\">=</span> Context<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>\t\t\t<span class=\"token punctuation\">(</span>workItem<span class=\"token operator\">-></span>WorkerRoutine<span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span>workItem<span class=\"token operator\">-></span>Parameter<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre></pre></td></tr><tr><td data-num=\"29\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">if</span> <span class=\"token expression\">WINVER <span class=\"token operator\">>=</span> <span class=\"token number\">0x0501</span></span></span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">endif</span></span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>\t<span class=\"token keyword\">return</span> STATUS_MORE_PROCESSING_REQUIRED<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p><code>UNREFERENCED_PARAMETER</code>  的意义在于可以去掉 C 编译器对于没有使用的参数所产生的一个警告。 一般地说， 内核代码会打开所有的警告以避免比较隐晦的错误。如果已经确定了这个警告不是错误， 则使用类似的宏来手动删除它。</p>\n<p>以上就在不同版本的 Windows 上实现了相同的功能。这样，IRP 请求就已经完成了， 之后执行绑定卷的操作即可</p>\n<h2 id=\"绑定卷的实现\"><a class=\"anchor\" href=\"#绑定卷的实现\">#</a> 绑定卷的实现</h2>\n<p><code>SfFsControlMountVolumeCompleteWorker</code>  函数的任务很简单， 就是调用 <code>SfFsControlMountVolumeComplete</code> ， 因为这个函数最终绑定卷设备， 所以这里我们只要看 <code>SfFsControlMount VolumeComplete</code>  的实现就可以了。</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>VOID  <span class=\"token function\">SfFsControlMountVolumeCompleteWorker</span><span class=\"token punctuation\">(</span>IN PFSCTRL_COMPLETION_CONTEXT Context<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>\t<span class=\"token function\">ASSERT</span><span class=\"token punctuation\">(</span>Context <span class=\"token operator\">!=</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>\t<span class=\"token function\">SfFsControlMountVolumeComplete</span><span class=\"token punctuation\">(</span>Context<span class=\"token operator\">-></span>DeviceObject<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>\t\tContext<span class=\"token operator\">-></span>Irp<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>\t\tContext<span class=\"token operator\">-></span>NewDeviceObject<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\t<span class=\"token function\">ExFreePoolWithTag</span><span class=\"token punctuation\">(</span>Context<span class=\"token punctuation\">,</span> SFCO_POOL_TAG<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>下面是函数 <code>SfFsControlMountVolumeComplete</code>  的实现代码。</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>NTSTATUS  <span class=\"token function\">SfFsControlMountVolumeComplete</span><span class=\"token punctuation\">(</span>IN PDEVICE_OBJECT DeviceObject<span class=\"token punctuation\">,</span> IN PIRP Irp<span class=\"token punctuation\">,</span> IN PDEVICE_OBJECT NewDeviceObject<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>\t<span class=\"token comment\">/*</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>\t参数说明:</pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>\tDeviceObject:        它是绑定到文件系统控制设备对象的设备栈上，它是一个过滤设备对象。</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>\tIrp:                 它是发送给文件系统 CDO 的挂载请求。它是一个新卷的挂载请求。</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>\tNewDeviceObject:     它是新创建的过滤设备对象，用于绑定到文件系统的卷设备对象的设备栈上。</pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\t*/</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>\tPVPB vpb<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>\tPSFILTER_DEVICE_EXTENSION newDevExt<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>\tPIO_STACK_LOCATION irpSp<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>\tPDEVICE_OBJECT attachedDeviceObject<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>\tNTSTATUS status<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>\t<span class=\"token function\">PAGED_CODE</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>\tnewDevExt <span class=\"token operator\">=</span> NewDeviceObject<span class=\"token operator\">-></span>DeviceExtension<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>\tirpSp <span class=\"token operator\">=</span> <span class=\"token function\">IoGetCurrentIrpStackLocation</span><span class=\"token punctuation\">(</span>Irp<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>\t<span class=\"token comment\">/*</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>\t * 获取我们保存的 VPB，这个时候就可以通过该设备对象得到 VPB</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>\t * VPB->DeviceObject 是  文件系统创建的卷设备对象</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>\t * VPB->RealDevice 是    磁盘驱动创建的物理设备对象</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>\t */</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>\tvpb <span class=\"token operator\">=</span> newDevExt<span class=\"token operator\">-></span>StorageStackDeviceObject<span class=\"token operator\">-></span>Vpb<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>vpb <span class=\"token operator\">!=</span> irpSp<span class=\"token operator\">-></span>Parameters<span class=\"token punctuation\">.</span>MountVolume<span class=\"token punctuation\">.</span>Vpb<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>\t\t<span class=\"token function\">SF_LOG_PRINT</span><span class=\"token punctuation\">(</span>SFDEBUG_DISPLAY_ATTACHMENT_NAMES<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>\t\t\t<span class=\"token punctuation\">(</span><span class=\"token string\">\"SFilter!SfFsControlMountVolume:              VPB in IRP stack changed   %p IRPVPB=%p VPB=%p\\n\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>\t\t\t\tvpb<span class=\"token operator\">-></span>DeviceObject<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>\t\t\t\tirpSp<span class=\"token operator\">-></span>Parameters<span class=\"token punctuation\">.</span>MountVolume<span class=\"token punctuation\">.</span>Vpb<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>\t\t\t\tvpb<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">NT_SUCCESS</span><span class=\"token punctuation\">(</span>Irp<span class=\"token operator\">-></span>IoStatus<span class=\"token punctuation\">.</span>Status<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>\t\t<span class=\"token comment\">// 获得一个互斥体的内核对象，以便下面的代码可以以 “原子方式” 判断是否绑定过改卷设备，防止对同一个卷设备判定两次</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>\t\t<span class=\"token function\">ExAcquireFastMutex</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>gSfilterAttachLock<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>\t\t<span class=\"token comment\">// 判断是否绑定过了</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>\t\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token function\">SfIsAttachedToDevice</span><span class=\"token punctuation\">(</span>vpb<span class=\"token operator\">-></span>DeviceObject<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>attachedDeviceObject<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>\t\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>\t\t\t<span class=\"token comment\">/*</pre></td></tr><tr><td data-num=\"47\"></td><td><pre>\t\t\t * SfAttachToMountedDevice 的意义：将我们创建的过滤设备对象 NewDeviceObject 绑定到文件系统创建的 VPB->DeviceObject 的设备对象栈上。</pre></td></tr><tr><td data-num=\"48\"></td><td><pre>\t\t\t */</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>\t\t\tstatus <span class=\"token operator\">=</span> <span class=\"token function\">SfAttachToMountedDevice</span><span class=\"token punctuation\">(</span>vpb<span class=\"token operator\">-></span>DeviceObject<span class=\"token punctuation\">,</span> NewDeviceObject<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>\t\t\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token function\">NT_SUCCESS</span><span class=\"token punctuation\">(</span>status<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre>\t\t\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>\t\t\t\t<span class=\"token function\">SfCleanupMountedDevice</span><span class=\"token punctuation\">(</span>NewDeviceObject<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre>\t\t\t\t<span class=\"token function\">IoDeleteDevice</span><span class=\"token punctuation\">(</span>NewDeviceObject<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre>\t\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre></pre></td></tr><tr><td data-num=\"57\"></td><td><pre>\t\t\t<span class=\"token function\">ASSERT</span><span class=\"token punctuation\">(</span><span class=\"token constant\">NULL</span> <span class=\"token operator\">==</span> attachedDeviceObject<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre>\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"59\"></td><td><pre>\t\t<span class=\"token keyword\">else</span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre>\t\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"61\"></td><td><pre>\t\t\t</pre></td></tr><tr><td data-num=\"62\"></td><td><pre>\t\t\t<span class=\"token function\">SF_LOG_PRINT</span><span class=\"token punctuation\">(</span>SFDEBUG_DISPLAY_ATTACHMENT_NAMES<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"63\"></td><td><pre>\t\t\t\t<span class=\"token punctuation\">(</span><span class=\"token string\">\"SFilter!SfFsControlMountVolume               Mount volume failure for   %p \\\"%wZ\\\", already attached\\n\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"64\"></td><td><pre>\t\t\t\t\t<span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>PSFILTER_DEVICE_EXTENSION<span class=\"token punctuation\">)</span>attachedDeviceObject<span class=\"token operator\">-></span>DeviceExtension<span class=\"token punctuation\">)</span><span class=\"token operator\">-></span>AttachedToDeviceObject<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"65\"></td><td><pre>\t\t\t\t\t<span class=\"token operator\">&amp;</span>newDevExt<span class=\"token operator\">-></span>DeviceName<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"66\"></td><td><pre>\t\t\t<span class=\"token comment\">// 到这里说明是已经绑定过的，直接放弃即可</span></pre></td></tr><tr><td data-num=\"67\"></td><td><pre>\t\t\t<span class=\"token function\">SfCleanupMountedDevice</span><span class=\"token punctuation\">(</span>NewDeviceObject<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"68\"></td><td><pre>\t\t\t<span class=\"token function\">IoDeleteDevice</span><span class=\"token punctuation\">(</span>NewDeviceObject<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"69\"></td><td><pre>\t\t\t<span class=\"token function\">ObDereferenceObject</span><span class=\"token punctuation\">(</span>attachedDeviceObject<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"70\"></td><td><pre>\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"71\"></td><td><pre></pre></td></tr><tr><td data-num=\"72\"></td><td><pre>\t\t<span class=\"token function\">ExReleaseFastMutex</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>gSfilterAttachLock<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"73\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"74\"></td><td><pre>\t<span class=\"token keyword\">else</span></pre></td></tr><tr><td data-num=\"75\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"76\"></td><td><pre>\t\t<span class=\"token function\">SF_LOG_PRINT</span><span class=\"token punctuation\">(</span>SFDEBUG_DISPLAY_ATTACHMENT_NAMES<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"77\"></td><td><pre>\t\t\t<span class=\"token punctuation\">(</span><span class=\"token string\">\"SFilter!SfFsControlMountVolume:              Mount volume failure for   %p \\\"%wZ\\\", status=%08x\\n\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"78\"></td><td><pre>\t\t\t\tDeviceObject<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"79\"></td><td><pre>\t\t\t\t<span class=\"token operator\">&amp;</span>newDevExt<span class=\"token operator\">-></span>DeviceName<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"80\"></td><td><pre>\t\t\t\tIrp<span class=\"token operator\">-></span>IoStatus<span class=\"token punctuation\">.</span>Status<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"81\"></td><td><pre>\t\t<span class=\"token function\">SfCleanupMountedDevice</span><span class=\"token punctuation\">(</span>NewDeviceObject<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"82\"></td><td><pre>\t\t<span class=\"token function\">IoDeleteDevice</span><span class=\"token punctuation\">(</span>NewDeviceObject<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"83\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"84\"></td><td><pre>\t<span class=\"token comment\">// 完成请求</span></pre></td></tr><tr><td data-num=\"85\"></td><td><pre>\tstatus <span class=\"token operator\">=</span> Irp<span class=\"token operator\">-></span>IoStatus<span class=\"token punctuation\">.</span>Status<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"86\"></td><td><pre>\t<span class=\"token function\">IoCompleteRequest</span><span class=\"token punctuation\">(</span>Irp<span class=\"token punctuation\">,</span> IO_NO_INCREMENT<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"87\"></td><td><pre>\t<span class=\"token keyword\">return</span> status<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"88\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>这个过程确实比较复杂， 可以使读者意识到： 在文件系统这种 Windows 核心组件上进行的修改， 与对串口、 键盘这样简单设备的修改不同。 即使是简单地调用一个内核调用去绑定一个设备， 也要充分考虑到对整个执行环境的影响。</p>\n<p>下面介绍了 <code>SfAttachToMountedDevice</code>  的实现。 这个函数是调用 <code>SfAttachDeviceToDeviceStack</code>  来实现最终绑定的。</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>NTSTATUS  <span class=\"token function\">SfAttachToMountedDevice</span><span class=\"token punctuation\">(</span>IN PDEVICE_OBJECT DeviceObject<span class=\"token punctuation\">,</span> IN PDEVICE_OBJECT SFilterDeviceObject<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>\t<span class=\"token comment\">/*</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>\tSfAttachToMountedDevice 函数的功能：完成绑定一个文件系统卷设备的操作。</pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>\t参数说明:</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>\tSFilterDeviceObject:  它是我们使用 IoCreateDevice 函数来创建的设备对象。</pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\t*/</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>\tPSFILTER_DEVICE_EXTENSION newDevExt <span class=\"token operator\">=</span> SFilterDeviceObject<span class=\"token operator\">-></span>DeviceExtension<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>\tNTSTATUS status<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>\tULONG i<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>\t<span class=\"token function\">PAGED_CODE</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>\t<span class=\"token function\">ASSERT</span><span class=\"token punctuation\">(</span><span class=\"token function\">IS_MY_DEVICE_OBJECT</span><span class=\"token punctuation\">(</span>SFilterDeviceObject<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">if</span> <span class=\"token expression\">WINVER <span class=\"token operator\">>=</span> <span class=\"token number\">0x0501</span></span></span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>\t<span class=\"token function\">ASSERT</span><span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token function\">SfIsAttachedToDevice</span><span class=\"token punctuation\">(</span>DeviceObject<span class=\"token punctuation\">,</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">endif</span></span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>\t<span class=\"token comment\">// 设备标志的复制</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">FlagOn</span><span class=\"token punctuation\">(</span>DeviceObject<span class=\"token operator\">-></span>Flags<span class=\"token punctuation\">,</span> DO_BUFFERED_IO<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>\t\t<span class=\"token function\">SetFlag</span><span class=\"token punctuation\">(</span>SFilterDeviceObject<span class=\"token operator\">-></span>Flags<span class=\"token punctuation\">,</span> DO_BUFFERED_IO<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">FlagOn</span><span class=\"token punctuation\">(</span>DeviceObject<span class=\"token operator\">-></span>Flags<span class=\"token punctuation\">,</span> DO_DIRECT_IO<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>\t\t<span class=\"token function\">SetFlag</span><span class=\"token punctuation\">(</span>SFilterDeviceObject<span class=\"token operator\">-></span>Flags<span class=\"token punctuation\">,</span> DO_DIRECT_IO<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>\t<span class=\"token comment\">// 循环尝试绑定，绑定有可能失败，这可能和其他用户恰好试图对这个磁盘做特殊的操作比如解挂载有关。</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>\t<span class=\"token comment\">// 反复进行 8 次尝试，以尽可能低避开这些巧合。</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>\t<span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span>i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> <span class=\"token number\">8</span><span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>\t\tLARGE_INTEGER interval<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>\t\t<span class=\"token comment\">// 调用 SfAttachDeviceToDeviceStack 函数进行  卷的绑定</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>\t\tstatus <span class=\"token operator\">=</span> <span class=\"token function\">SfAttachDeviceToDeviceStack</span><span class=\"token punctuation\">(</span>SFilterDeviceObject<span class=\"token punctuation\">,</span> DeviceObject<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>newDevExt<span class=\"token operator\">-></span>AttachedToDeviceObject<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>\t\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">NT_SUCCESS</span><span class=\"token punctuation\">(</span>status<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>\t\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>\t\t\t<span class=\"token function\">ClearFlag</span><span class=\"token punctuation\">(</span>SFilterDeviceObject<span class=\"token operator\">-></span>Flags<span class=\"token punctuation\">,</span> DO_DEVICE_INITIALIZING<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>\t\t\t<span class=\"token function\">SF_LOG_PRINT</span><span class=\"token punctuation\">(</span>SFDEBUG_DISPLAY_ATTACHMENT_NAMES<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>\t\t\t\t<span class=\"token punctuation\">(</span><span class=\"token string\">\"SFilter!SfAttachToMountedDevice:             Attaching to volume        %p \\\"%wZ\\\"\\n\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>\t\t\t\t\tnewDevExt<span class=\"token operator\">-></span>AttachedToDeviceObject<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>\t\t\t\t\t<span class=\"token operator\">&amp;</span>newDevExt<span class=\"token operator\">-></span>DeviceName<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>\t\t\t<span class=\"token keyword\">return</span> STATUS_SUCCESS<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>\t\t<span class=\"token comment\">// 把这个线程延迟 500ms 后再继续</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>\t\tinterval<span class=\"token punctuation\">.</span>QuadPart <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token number\">500</span> <span class=\"token operator\">*</span> DELAY_ONE_MILLISECOND<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>      <span class=\"token comment\">//delay 1/2 second</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>\t\t<span class=\"token function\">KeDelayExecutionThread</span><span class=\"token punctuation\">(</span>KernelMode<span class=\"token punctuation\">,</span> FALSE<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>interval<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>\t<span class=\"token keyword\">return</span> status<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>这里的结果表示绑定已完成， 下面开始讲解各种操作的过滤。</p>\n<h1 id=\"读写操作的过滤\"><a class=\"anchor\" href=\"#读写操作的过滤\">#</a> 读 / 写操作的过滤</h1>\n<h2 id=\"设置一个读处理函数\"><a class=\"anchor\" href=\"#设置一个读处理函数\">#</a> 设置一个读处理函数</h2>\n<p>文件系统有许多种操作， 但是读 / 写操作依然是最重要的。 对于杀毒软件的动态监控而言， 新建目录、 新建文件、 文件改名等操作都只能得到文件名信息， 对查找病毒的意义不大。 只有文件内容的读和写， 才是扫描病毒的合适时机。</p>\n<p>在 Windows 系统中， 如果在任何文件被读取时都检查读出的内容中是否含有病毒特征码， 就可以防止病毒从硬盘（或者其他介质） 中被加载到内存中执行； 如果在任何文件被写入时都检查写入的内容中是否含有病毒特征码， 就可以防止病毒被写入硬盘， 也就可以防止已经存在于硬盘上的文件被病毒感染。</p>\n<p>由于前面的代码已经绑定了文件系统卷， 而所有的文件都是保存在卷上的， 所以处理截获到的主功能号为 <code>IRP_MJ_READ</code>  和 <code>IRP_MJ_WRITE</code>  的 IRP， 就可以实现扫描病毒特征码的功能。 当然， 一个必要的条件是， 必须从这两种 IRP 中解析出读取到和要写入的文件内容。</p>\n<p>回忆一下在驱动的入口函数 <code>DriverEntry</code>  中对分发函数的设置。 下面来编写两个函数分别处理读和写的 IRP， 其中处理读的函数称为 <code>SfRead</code> ， 而处理写的函数称为 <code>SfWrite</code> 。 这两个函数的处理过程非常类似， 但是有一点需要注意 — 如果要获得操作的文件内容， 对于读请求来说， 必须将其完成才能得到内容； 写请求则可以直接得到。</p>\n<p>因为写请求的数据是由发请求的上层程序填写的， 在请求完成之前就已经存在于输入缓冲区里了； 而读请求的数据则是必须从硬盘上获得的， 必须要在请求完成之后才能在输出缓冲区里存在。 因此， 读请求的处理会比写请求复杂一点。 下面的例子都是讲述 <code>SfRead</code>  的； 而 <code>SfWrite</code>  则请读者举一反三， 自己动手试试。</p>\n<p>在 <code>DriverEntry</code>  中没有设置读请求分发函数， 因此在后面加上一条：</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>pDriverObject<span class=\"token operator\">-></span>MajorFunction<span class=\"token punctuation\">[</span>IRP_MJ_READ<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> SfRead<span class=\"token punctuation\">;</span></pre></td></tr></table></figure><h2 id=\"设备对象的区分处理\"><a class=\"anchor\" href=\"#设备对象的区分处理\">#</a> 设备对象的区分处理</h2>\n<p>对 SfRead 的处理， 要注意一些什么呢？</p>\n<p>首先， <strong>判断设备对象是不是一个绑定在文件系统卷设备上的过滤设备</strong>， 如果是， 那么就是一个读 / 写文件的操作。</p>\n<p>请注意， 绑定在文件系统的控制设备上的过滤设备也有可能发生读请求， 但是那就不是在读取文件了。</p>\n<p>那么如何判断呢？</p>\n<p><strong>记得绑定 Volume 的代码已经在设备扩展中设置了域 StorageDev。如果不是（比如控制设备的绑定就没设置过） ， 那么判断 StorageDev 中是否为空， 就可以知道这是否是一个文件系统的卷设备</strong>。</p>\n<p>由此可见，过滤设备上的设备扩展是非常有用的。 实际上，它就是用来在绑定时保存任意信息， 以便将来能在过滤时得到这些信息的一个上下文。</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>PSFILTER_DEVICE_EXTENSION devExt <span class=\"token operator\">=</span> DeviceObject<span class=\"token operator\">-></span>DeviceExtension<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>devExt<span class=\"token operator\">-></span>StorageStackDeviceObject<span class=\"token operator\">!=</span><span class=\"token constant\">NULL</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>\t\t<span class=\"token comment\">// 到这里说明是卷设备，也就是说，这是一个文件的写操作</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>\t\t…………</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>其他的情况不需要捕获， 请直接传递到下层。</p>\n<p>读 / 写请求的 IRP 情况非常复杂， 请有足够的心理准备。 可以依赖 WDK 的帮助， 但是尽信帮助不如无帮助。 当然， 对本书也是尽信书不如无书， 最好的办法就是自己打印 IRP 的各细节， 自己查看文件读操作的完成过程。</p>\n<p>下面实现函数 SfRead， 这里的判断处理稍有不同。 如果是对本程序自己的控制设备的读操作， 则返回失败， 因为本程序的控制设备并没有提供读接口。 然后判断如果不是文件读操作， 就直接放过。 最后的省略处是要加入的读处理。</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>NTSTATUS <span class=\"token function\">SfRead</span><span class=\"token punctuation\">(</span>IN PDEVICE_OBJECT DeviceObject<span class=\"token punctuation\">,</span> IN PIRP Irp<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>\tPIO_STACK_LOCATION irpsp <span class=\"token operator\">=</span> <span class=\"token function\">IoGetCurrentIrpStackLocation</span><span class=\"token punctuation\">(</span>Irp<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>\tPFILE_OBJECT file_object <span class=\"token operator\">=</span> irpsp<span class=\"token operator\">-></span>FileObject<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>\tPSFILTER_DEVICE_EXTENSION devExt <span class=\"token operator\">=</span> DeviceObject<span class=\"token operator\">-></span>DeviceExtension<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>\t<span class=\"token comment\">// 对于控制设备的操作，如果没有什么需求，那么直接返回失败就可以</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">IS_MY_DEVICE_OBJECT</span><span class=\"token punctuation\">(</span>DeviceObject<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\t\tIrp<span class=\"token operator\">-></span>IoStatus<span class=\"token punctuation\">.</span>Status <span class=\"token operator\">=</span> STATUS_INVALID_DEVICE_REQUEST<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>\t\tIrp<span class=\"token operator\">-></span>IoStatus<span class=\"token punctuation\">.</span>Information <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>\t\t<span class=\"token function\">IoCompleteRequest</span><span class=\"token punctuation\">(</span>Irp<span class=\"token punctuation\">,</span> IO_NO_INCREMENT<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>\t\t<span class=\"token keyword\">return</span> STATUS_INVALID_DEVICE_REQUEST<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>\t<span class=\"token comment\">// 对于文件系统其他设备的操作，直接下发到下层驱动即可。</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>devExt<span class=\"token operator\">-></span>StorageStackDeviceObject <span class=\"token operator\">=</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>\t\t<span class=\"token comment\">// 直接调用 SfPassThrough 来下发</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>\t\t<span class=\"token keyword\">return</span> <span class=\"token function\">SfPassThrough</span><span class=\"token punctuation\">(</span>DeviceObject<span class=\"token punctuation\">,</span> Irp<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>\t<span class=\"token comment\">// 到这里就是对卷的文件操作了</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>\t…………</pre></td></tr><tr><td data-num=\"25\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h2 id=\"解析读请求中的文件信息\"><a class=\"anchor\" href=\"#解析读请求中的文件信息\">#</a> 解析读请求中的文件信息</h2>\n<p>接下来的工作是分析这个 IRP。<br />\n对于一个读操作， 程序员需要知道的是：</p>\n<ol>\n<li>这是对哪个文件的读操作？</li>\n</ol>\n<blockquote>\n<p>IRP 的当前栈空间下有一个文件对象指针， 指向一个文件对象， 从文件对象中可以得到文件对象的名字。在后面的 “路径过滤的实现” 中， 再详细讲解文件名和路径的获取。</p>\n</blockquote>\n<p>用以下代码来得到文件对象（从 irpsp 中）：</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>PIO_STACK_LOCATION irpsp <span class=\"token operator\">=</span> <span class=\"token function\">IoGetCurrentIrpStackLocation</span><span class=\"token punctuation\">(</span>Irp<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>PFILE_OBJECT file_object <span class=\"token operator\">=</span> irpsp<span class=\"token operator\">-></span>FileObject<span class=\"token punctuation\">;</span></pre></td></tr></table></figure><ol start=\"2\">\n<li>读取的偏移量是多少？</li>\n</ol>\n<blockquote>\n<p>在 Windows 2000 下文件系统得到的偏移量都是从文件起始位置开始计算的。 偏移量是一个 <code>LARGE_INTEGER</code> ， 这是一个在 Windows 驱动开发中常用的 64 位整数数据的共用体。</p>\n</blockquote>\n<p>用以下代码来得到偏移量（从 irpsp 中）：</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>PIO_STACK_LOCATION irpsp <span class=\"token operator\">=</span> <span class=\"token function\">IoGetCurrentIrpStackLocation</span><span class=\"token punctuation\">(</span>Irp<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>LARGE_INTEGER offset<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>ULONG length<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>offset<span class=\"token punctuation\">.</span>QuadPart <span class=\"token operator\">=</span> irpsp<span class=\"token operator\">-></span>Parameters<span class=\"token punctuation\">.</span>Read<span class=\"token punctuation\">.</span>ByteOffset<span class=\"token punctuation\">.</span>QuadPart<span class=\"token punctuation\">;</span></pre></td></tr></table></figure><ol start=\"3\">\n<li>读取的长度是多少？</li>\n</ol>\n<p>用以下代码来得到读取的文件内容长度（从 irpsp 中）：</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>length <span class=\"token operator\">=</span> irpsp<span class=\"token operator\">-></span>Parameters<span class=\"token punctuation\">.</span>Read<span class=\"token punctuation\">.</span>Length<span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>如果这是个写操作， 写的偏移量和长度则为:</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>offset<span class=\"token punctuation\">.</span>QuadPart <span class=\"token operator\">=</span> irpsp<span class=\"token operator\">-></span>Parameters<span class=\"token punctuation\">.</span>Write<span class=\"token punctuation\">.</span>ByteOffset<span class=\"token punctuation\">.</span>QuadPart<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>length <span class=\"token operator\">=</span> irpsp<span class=\"token operator\">-></span>Parameters<span class=\"token punctuation\">.</span>Write<span class=\"token punctuation\">.</span>Length<span class=\"token punctuation\">;</span></pre></td></tr></table></figure><ol start=\"4\">\n<li>读取成功了吗？ 如果读取成功了， 那么读到的内容放在哪里呢？</li>\n</ol>\n<p>这里需要了解一些知识：如果杀毒软件要扫描病毒， 此时当然<em>希望能得到所读到的数据内容</em>。 数据只能在完成之后获取， 所以下面要<strong>设置完成函数</strong>。</p>\n<p>完成 IRP 时是忽略还是拷贝当前栈空间（ <code>IO_STACK_LOCATION</code> ） ， 返回什么状态值， 以及在完成函数中如何结束 IRP， 是不那么容易弄清楚的事情。</p>\n<p>书中作者总结如下：</p>\n<p>(1) 如果对 IRP 完成之后的事情无兴趣， 则直接忽略当前 <code>IO_STACK_LOCATION</code> （从代码上说， 调用内核 API 函数 <code>IoSkipCurrentIrpStackLocation</code> ） ， 然后向下传递请求， 返回 <code>IoCallDriver</code>  所返回的状态。</p>\n<p>(2) 不但对 IRP 完成之后的事情无兴趣， 而且不打算继续传递， 打算立刻返回成功或失败， 那么不用忽略或者拷贝当前 <code>IO_STACK_LOCATION</code> ， 可以在填写 IRP 的状态参数后调用 <code>IoCompleteRequest</code> ， 并返回自己想返回的结果。</p>\n<p>(3) 如果对 IRP 完成之后的事情有兴趣， 并打算在完成函数中处理， 则应该首先拷贝当前 <code>IO_STACK_LOCATION</code> （  <code>IoCopyCurrentIrpStackLocationToNext</code> ） ， 然后指定完成函数， 并返回 <code>IoCallDriver</code>  所返回的状态。 在完成函数中， 不需要调用 <code>IoCompleteRequest</code> ， 直接返回 IRP 的当前状态即可。</p>\n<p>(4) 同第三种情况， 有时候， 会把任务塞入系统工作线程中或者希望在另外的线程中去完成 IRP， 那么在完成函数中应该返回 <code>STATUS_MORE_PROCESSING_REQUIRED</code> ，此时完成 IRP 时应该调用 <code>IoCompleteRequest</code> 。</p>\n<p>(5)<strong> 第五种情况是在分发函数中等待在完成函数中设置事件， 那么完成函数返回 <code>STATUS_MORE_PROCESSING_REQUIRED</code> ， 分发函数在等待结束后调用 <code>IoCompleteRequest</code> </strong>。</p>\n<hr />\n<p>下面的问题就是<em>如何获取读取到的内容</em>了。</p>\n<p>IRP 的缓冲区放在哪里取决于这个操作的 IO 方式。<br />\nIO 方式有三种： 缓冲方式、 直接方式和皆不是方式。皆不是方式听起来比较怪异， 因为英文资料上这三种方式分别为：  <code>Buffered IO</code> 、 <code>Direct IO</code>  和 <code>Neither IO</code> 。 既然 Neither 表示前两者皆不是， 那么中文就可以命名为皆不是 IO 了。</p>\n<p>对这三种不同方式的介绍如下：</p>\n<p>（1） 缓冲方式。 这种方式在文件读 / 写请求中没有出现过， 作者也认为不会出现。 但是在前面的串口过滤中出现过， 可以参考 “串口的过滤” 中的 IRP 处理。 请求的缓冲区本来是在应用程序的用户态空间里的（ 因为是应用程序发起的请求）。请求会被发送到内核中处理。 内核不一定会在当前进程上下文中处理它， 有可能处理的时候已经在其他进程里了。 但不同的进程中无法访问这个缓冲区（ 进程用户态内存空间是相互隔离的） 。而缓冲方式就会在内核内存中分配一个缓冲区， 将用户态的请求缓冲区拷贝到内核缓冲区中。 由于内核内存可以在任何进程中访问， 所以缓冲方式能够避免内核处理请求时， 用户态空间地址失效的问题。 但这种方式中间需要拷贝， 所以比较慢。</p>\n<p>（2） 直接方式。 直接方式是使用 MDL 来传递缓冲区的。 因为请求一般都是用户进程发起的， 原始的空间都在用户空间中， 这些空间指针如果传递到内核代码里， 虽然可以正常使用内核， 但是却必须保证其在当前进程空间范围内。 如果对内核做一些特殊的处理，比如把请求放入队列， 等待另一个进程中的线程去完成它， 那么问题就来了： 这些空间指针失效了。 缓冲方式虽然没这个问题， 但是需要拷贝。 为了避免拷贝， 出现了直接方式，<em>就是直接把用户空间的范围直接映射到内核空间</em>。 为此， 当然要做修改页表之类的种种事务， 但是我们不用关心， 只需要了解 MDL 会解决这个问题即可。 因此缓冲区在 <code>Irp→MdlAddress</code>  对应的空间内， 这个 MDL 指针可以用 <code>MmGetSystemAddressForMdlSafe</code>  转换得到实际缓冲区的指针。</p>\n<p>（3） 皆不是方式。 皆不是方式是最简单的， 可以直接把用户空间的指针传递进来，不做任何处理， 这个指针就是 <code>Irp→UserBuffer</code> 。</p>\n<p><em>这个空间在 <code>SfRead</code>  中当然可以直接用， 但是不可以放到其他线程中处理（ 比如放到完成函数中） 。 一般可以设置一个事件， 等待完成函数被调用后继续在 <code>SfRead</code>  中处理， 是不会有问题的</em>。</p>\n<p>在实际中， 简单地说，  <code>Irp→MdlAddress</code>  如果不为 NULL， 则使用 <code>Irp→MdlAddress</code> ， 缓冲区位置为 <code>MmGetSystemAddressForMdl(Irp→MdlAddress)</code> ； 否则直接使用 <code>Irp→UserBuffer</code> ，  <code>UseBuffer</code>  是一个只在当前线程上下文处才有效的地址。</p>\n<p>那么， 获得读取内容的主要方法示例如下：</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>KEVENT waitEvent<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">void</span><span class=\"token operator\">*</span> buf<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>ULONG length<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token function\">KeInitializeEvent</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>waitEvent<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>\t\t\t\t\tNotificationEvent<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>\t\t\t\t\tFALSE<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token function\">IoCopyCurrentIrpStackLocationToNext</span><span class=\"token punctuation\">(</span>Irp<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token function\">IoSetCompletionRoutine</span><span class=\"token punctuation\">(</span>Irp<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\t\t\t\t\t\tSfReadCompletion<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>\t\t\t\t\t\t<span class=\"token operator\">&amp;</span>waitEvent<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>\t\t\t\t\t\tTRUE<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>\t\t\t\t\t\tTRUE<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>\t\t\t\t\t\tTRUE<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>status <span class=\"token operator\">=</span> <span class=\"token function\">IoCallDriver</span><span class=\"token punctuation\">(</span>devExt<span class=\"token operator\">-></span>AttachedToDeviceObject<span class=\"token punctuation\">,</span> Irp<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre></pre></td></tr><tr><td data-num=\"18\"></td><td><pre><span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>STATUS_PENDING <span class=\"token operator\">==</span> status<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>\tstatus <span class=\"token operator\">=</span> <span class=\"token function\">KeWaitForSingleObject</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>waitEvent<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>\t\tExecutive<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>\t\tKernelMode<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>\t\tFALSE<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>\t\t<span class=\"token constant\">NULL</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>\t<span class=\"token function\">ASSERT</span><span class=\"token punctuation\">(</span>STATUS_SUCCESS <span class=\"token operator\">==</span> status<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre></pre></td></tr><tr><td data-num=\"28\"></td><td><pre><span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>Irp<span class=\"token operator\">-></span>IoStatus<span class=\"token punctuation\">.</span>Status <span class=\"token operator\">==</span> STATUS_SUCCESS<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>\t<span class=\"token comment\">// 如果成功地完成了，那么获取读到的内容在缓冲区 buf 中</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>\t<span class=\"token comment\">// 至于内容的长度，可以从 Irp->IoStatus.Information 中获得</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>Irp<span class=\"token operator\">-></span>MdlAddress <span class=\"token operator\">!=</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>\t\tbuf <span class=\"token operator\">=</span> <span class=\"token function\">MmGetSystemAddressForMdl</span><span class=\"token punctuation\">(</span>Irp<span class=\"token operator\">-></span>MdlAddress<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>\t<span class=\"token keyword\">else</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>\t\tbuf <span class=\"token operator\">=</span> Irp<span class=\"token operator\">-></span>UserBuffer<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>\tlength <span class=\"token operator\">=</span> Irp<span class=\"token operator\">-></span>IoStatus<span class=\"token punctuation\">.</span>Information<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>如果是写操作的内容则直接从 <code>Irp→UserBuffer</code>  或 <code>Irp→MdlAddress</code>  中得到。</p>\n<h2 id=\"读请求的完成\"><a class=\"anchor\" href=\"#读请求的完成\">#</a> 读请求的完成</h2>\n<p>因为读请求在内核中被封装为 IRP， 往内核驱动中层层下发（每个驱动程序只占一层） 。 所以对一个驱动程序来说， 完成读请求就是收到一个 IRP， 处理完这个 IRP， 然后通知自己的上层驱动， 这个 IRP 已经完成的过程。</p>\n<p>常常有读者疑惑， 文件过滤驱动并不是真实的文件系统驱动， 更不直接牵涉到硬盘， 但只有硬盘才能真正完成读请求， 那么文件过滤又如何能完成一个读请求呢？</p>\n<p><em>实际上， 任何驱动都可以完成它收到的请求。 对于一个 IRP 而言， 只要填好它需要的信息（比如读取到的内容、 读完的状态， 以及读到了多少） ， 然后就可以向上层报告这个 IRP 完成了。 至于这些数据从哪里来， 真实硬件返回的是什么状态， 上层根本不关心。 即使这个驱动根本就没有把请求下发到下层驱动， 而是自己 “虚构” 地填写一些数据， 也不会有什么问题， 上层驱动是不会关心这些的。</em></p>\n<p>一般地说， 文件系统过滤驱动对 IRP 进行监控， 允许或禁止（禁止的话， 返回失败，这也是完成的一种， 只是不虚构数据） ， 或者对 IRP 进行一些修改。 比如在写之前， 先把缓冲区中要写的数据加密。 但是也有一些情况， 需要自己完成这个请求； 或者说， 有时自己完成请求也是种选择。</p>\n<hr />\n<p><em>考虑一下文件系统过滤在视频点播方面的应用。 视频点播的特点是文件一般很大， 而且有多个客户要对同一个文件进行从头到尾的连续读取。 这时候， 使用大量内存对这些文件进行专门的缓冲， 就非常有价值了。假设在这个设计中， 驱动针对特殊的流媒体文件， 采取预先读取到内存中的方式。 当一个读请求被这个文件过滤驱动捕获时， 假设这个读请求经过检查， 刚好被本驱动的缓冲命中， 那么就可以直接从内存中读出， 不用下传到下面的真实文件系统了。 此时， 自己完成请求显然是很有意义的</em>。</p>\n<hr />\n<p>这里要谈到 IRP 的次功能号。 前面已经讨论过， 如果 <code>irpsp→MajorFunction</code>  是 <code>IRP_MJ_READ</code> ， 则是读请求。 读请求也有几个不同的次功能号， 可以用如下的代码得到：</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>PIO_STACK_LOCATION irpsp <span class=\"token operator\">=</span> <span class=\"token function\">IoGetCurrentIrpStackLocation</span><span class=\"token punctuation\">(</span>irp<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>UCHAR minor_code <span class=\"token operator\">=</span> irpsp<span class=\"token operator\">-></span>MinorFunction<span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>每个主功能号下面都有一些次功能号， 如果一个 IRP 的主功能号是 <code>IRP_MJ_READ</code> ，检查它的次功能号， 则应该有以下几种情况：</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>IRP_MN_NORMAL</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>IRP_MN_MDL</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>IRP_MN_MDL_ COMPLETE</pre></td></tr></table></figure><p>还有其他几种情况， 资料上有解释， 但是书的作者没调试过，也就没有介绍，我们暂时也不用深究了，看这三种介绍即可。</p>\n<ol>\n<li>\n<p><code>IRP_MN_NORMAL</code>  既有可能在 <code>Irp→MdlAddress</code>  中返回数据， 也有可能在 <code>Irp→UserBuffer</code>  中返回数据。 如果要完成这样的请求， 直接判断 <code>Irp→MdlAddress</code>  是否为空即可。 如果为空， 则把数据填入 <code>Irp→UserBuffer</code>  中， 这些空间都是预先分配好的， 不需要编程者自己分配。</p>\n</li>\n<li>\n<p>次功能号为 <code>IRP_MN_MDL</code>  是比较罕见的。 这种 IRP 的 <code>Irp→MdlAddress和Irp→UserBuffer</code>  都为空， 那么过滤驱动应该把数据往哪里拷贝呢？</p>\n</li>\n<li>\n<p><code>IRP_MN_MDL</code>  的要求是请编程者分配一个 MDL， 然后令 MDL 指向数据所在的空间， 最后返回给上层。 MDL 自然是要释放的， 换句话说， 使用完毕要归还， 所以又有 <code>IRP_MN_MDL_ COMPLETE</code> ， 意思是一个 MDL 已经使用完毕， 可以释放了。可见这种 IRP 比较特殊。 需要两个 IRP 才能完全完成。 当编程者收到 <code>IRP_MN_MDL</code>  的 IRP 时， 要分配 MDL； 之后会再收到一个 <code>IRP_MN_MDL_COMPLETE</code>  的 IRP， 此时就可以释放上次分配的 MDL 了。</p>\n</li>\n</ol>\n<p>下面写一些函数来分配和释放 MDL， 并令 MDL 指向内存位置或者得到 MDL 所指向的内存。</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">// MDL 相关，注意是内联函数</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">SFMD_POOL_TAG</span>  <span class=\"token string\">'dmFS'</span>  </span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\">// 函数分配 MDL，缓冲必须是用户预先分配好的</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>__inline PMDL <span class=\"token function\">MyMdlAllocate</span><span class=\"token punctuation\">(</span>PVOID buf<span class=\"token punctuation\">,</span> ULONG length<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>\tPMDL pmdl <span class=\"token operator\">=</span> <span class=\"token function\">IoAllocateMdl</span><span class=\"token punctuation\">(</span>buf<span class=\"token punctuation\">,</span> length<span class=\"token punctuation\">,</span> FALSE<span class=\"token punctuation\">,</span> FALSE<span class=\"token punctuation\">,</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>pmdl <span class=\"token operator\">==</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\t\t<span class=\"token keyword\">return</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>\t<span class=\"token function\">MmBuildMdlForNonPagedPool</span><span class=\"token punctuation\">(</span>pmdl<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>\t<span class=\"token keyword\">return</span> pmdl<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token comment\">// 函数分配一个 MDL，并且带有一块内存</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>__inline PMDL <span class=\"token function\">MyMdlMemoryAllocate</span><span class=\"token punctuation\">(</span>ULONG length<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>\tPMDL pmdl<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>\t<span class=\"token keyword\">void</span><span class=\"token operator\">*</span> buffer <span class=\"token operator\">=</span> <span class=\"token function\">ExAllocatePoolWithTag</span><span class=\"token punctuation\">(</span>NonPagedPool<span class=\"token punctuation\">,</span> length<span class=\"token punctuation\">,</span> SFMD_POOL_TAG<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>buffer <span class=\"token operator\">==</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>\t\t<span class=\"token keyword\">return</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>\tpmdl <span class=\"token operator\">=</span> <span class=\"token function\">MyMdlAllocate</span><span class=\"token punctuation\">(</span>buffer<span class=\"token punctuation\">,</span> length<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>pmdl <span class=\"token operator\">==</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>\t\t<span class=\"token function\">ExFreePoolWithTag</span><span class=\"token punctuation\">(</span>buffer<span class=\"token punctuation\">,</span> SFMD_POOL_TAG<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>\t\t<span class=\"token keyword\">return</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre></pre></td></tr><tr><td data-num=\"32\"></td><td><pre></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>\t<span class=\"token keyword\">return</span> pmdl<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre></pre></td></tr><tr><td data-num=\"36\"></td><td><pre><span class=\"token comment\">// 函数释放 MDL，释放 MDL 所带的内存</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>__inline PMDL <span class=\"token function\">MyMdlMemoryFree</span><span class=\"token punctuation\">(</span>PMDL pmdl<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>\t<span class=\"token keyword\">void</span><span class=\"token operator\">*</span> buffer <span class=\"token operator\">=</span> <span class=\"token function\">MmGetSystemAddressForMdlSafe</span><span class=\"token punctuation\">(</span>pmdl<span class=\"token punctuation\">,</span> NormalPagePriority<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>\t<span class=\"token function\">IoFreeMdl</span><span class=\"token punctuation\">(</span>pmdl<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>\t<span class=\"token function\">ExFreePoolWithTag</span><span class=\"token punctuation\">(</span>buffer<span class=\"token punctuation\">,</span> SFMD_POOL_TAG<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>要完成请求还有一个问题， 就是 <code>irp→IoStatus.Information</code> 。 这里必须填上实际读取到的字节数， 不然上层不知道有多少数据返回。 这个数字不一定与请求的长度等同（一般只要成功， 就应该都是等同的， 唯一的例外是读取到文件结束的地方长度不够了， 只能返回一个不足的值） 。 必须设置这个数字：</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>irp<span class=\"token operator\">-></span>IoStatus<span class=\"token punctuation\">.</span>Information <span class=\"token operator\">=</span> length<span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>作为读文件的情况， <strong>如果是自己完成请求， 那么不能忘记移动文件指针</strong>； 否则操作系统由于不知道文件指针移动了而反复读同一个地方， 永远找不到文件尾， 书的作者就碰到过这样的情况。 一般应按以下方法处理， 如果文件读取失败， 则请保持原来的文件指针位置不变； 如果文件读取成功， 则请把文件指针指到 “读请求偏移量 + 成功读取长度” 的位置。这个所谓的指针是指 <code>irp→FileObject→CurrentByteOffset</code> 。 如果请求没有下发， 完全自己虚拟执行这个请求的话，  <code>irp→FileObject→CurrentByteOffset</code>  也必须同步地修改。</p>\n<p>下面是示例的代码。 现在看看怎么完成这些请求， 假设已经得到了要读取的数据。 这些当然都是在 <code>SfRead</code>  中或者是其他想完成这个 IRP 的地方做的， 假设其他必要的判断都已经做了， 下面直接根据次功能号来判断。</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">switch</span> <span class=\"token punctuation\">(</span>irpsp<span class=\"token operator\">-></span>MinorFunction<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>\t<span class=\"token comment\">// 先保留文件的偏移位置</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token keyword\">case</span> IRP_MN_NORMAL<span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>\t<span class=\"token keyword\">void</span><span class=\"token operator\">*</span> buffer<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>Irp<span class=\"token operator\">-></span>MdlAddress <span class=\"token operator\">!=</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\t\tbuffer <span class=\"token operator\">=</span> <span class=\"token function\">MmGetSystemAddressForMdlSafe</span><span class=\"token punctuation\">(</span>Irp<span class=\"token operator\">-></span>MdlAddress<span class=\"token punctuation\">,</span> NormalPagePriority<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>\t<span class=\"token keyword\">else</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>\t\tbuffer <span class=\"token operator\">=</span> Irp<span class=\"token operator\">-></span>UserBuffer<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>\t<span class=\"token comment\">//  这样我们就获得了读取的内容</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre></pre></td></tr><tr><td data-num=\"19\"></td><td><pre></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>\t<span class=\"token function\">KdPrint</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Read IRP buffer : %p\\r\\n\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>\t<span class=\"token comment\">// 完成请求，返回成功</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>\tIrp<span class=\"token operator\">-></span>IoStatus<span class=\"token punctuation\">.</span>Information <span class=\"token operator\">=</span> length<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>\tIrp<span class=\"token operator\">-></span>IoStatus<span class=\"token punctuation\">.</span>Status <span class=\"token operator\">=</span> STATUS_SUCCESS<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>\tirpsp<span class=\"token operator\">-></span>FileObject<span class=\"token operator\">-></span>CurrentByteOffset<span class=\"token punctuation\">.</span>QuadPart <span class=\"token operator\">=</span> offset<span class=\"token punctuation\">.</span>QuadPart <span class=\"token operator\">+</span> length<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>\t<span class=\"token function\">IoCompleteRequest</span><span class=\"token punctuation\">(</span>Irp<span class=\"token punctuation\">,</span> IO_NO_INCREMENT<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>\t<span class=\"token keyword\">return</span> STATUS_SUCCESS<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre><span class=\"token keyword\">case</span> IRP_MN_MDL<span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>\t<span class=\"token comment\">// 请先分配 MDL</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>\tPMDL pmdl <span class=\"token operator\">=</span> <span class=\"token function\">MyMdlMemoryAllocate</span><span class=\"token punctuation\">(</span>length<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>pmdl <span class=\"token operator\">==</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>\t\t<span class=\"token comment\">// 返回资源不足</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>\t\t<span class=\"token keyword\">return</span> STATUS_INSUFFICIENT_RESOURCES<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>\tIrp<span class=\"token operator\">-></span>MdlAddress <span class=\"token operator\">=</span> pmdl<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>\t<span class=\"token comment\">// …… 如果有数据，就写入 MDL 的 buffer 中</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre></pre></td></tr><tr><td data-num=\"43\"></td><td><pre></pre></td></tr><tr><td data-num=\"44\"></td><td><pre></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>\tIrp<span class=\"token operator\">-></span>IoStatus<span class=\"token punctuation\">.</span>Information <span class=\"token operator\">=</span> length<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>\tIrp<span class=\"token operator\">-></span>IoStatus<span class=\"token punctuation\">.</span>Status <span class=\"token operator\">=</span> STATUS_SUCCESS<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>\tirpsp<span class=\"token operator\">-></span>FileObject<span class=\"token operator\">-></span>CurrentByteOffset<span class=\"token punctuation\">.</span>QuadPart <span class=\"token operator\">=</span> offset<span class=\"token punctuation\">.</span>QuadPart <span class=\"token operator\">+</span> length<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>\t<span class=\"token function\">IoCompleteRequest</span><span class=\"token punctuation\">(</span>Irp<span class=\"token punctuation\">,</span> IO_NO_INCREMENT<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>\t<span class=\"token keyword\">return</span> STATUS_SUCCESS<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre></pre></td></tr><tr><td data-num=\"51\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre><span class=\"token comment\">/*</pre></td></tr><tr><td data-num=\"53\"></td><td><pre>\t书上写的是 IRP_MN_MDL_COMPLETE 但是在 VS2019 中看到的却是</pre></td></tr><tr><td data-num=\"54\"></td><td><pre></pre></td></tr><tr><td data-num=\"55\"></td><td><pre>\t#define IRP_MN_COMPLETE_MDL      (IRP_MN_COMPLETE | IRP_MN_MDL)</pre></td></tr><tr><td data-num=\"56\"></td><td><pre>\t查了一下资料，https://www.cnblogs.com/jasononline/archive/2008/06/28/1231774.html</pre></td></tr><tr><td data-num=\"57\"></td><td><pre></pre></td></tr><tr><td data-num=\"58\"></td><td><pre>\tIRP_MN_COMPLETE | IRP_MN_MDL   就是 IRP_MN_MDL_COMPLETE</pre></td></tr><tr><td data-num=\"59\"></td><td><pre>\t这么多年过去了 或许变成了  IRP_MN_COMPLETE_MDL</pre></td></tr><tr><td data-num=\"60\"></td><td><pre></pre></td></tr><tr><td data-num=\"61\"></td><td><pre>*/</span></pre></td></tr><tr><td data-num=\"62\"></td><td><pre><span class=\"token keyword\">case</span> IRP_MN_COMPLETE_MDL<span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"63\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"64\"></td><td><pre>\t<span class=\"token comment\">// 没有其他任务，就是释放 MDL</span></pre></td></tr><tr><td data-num=\"65\"></td><td><pre>\tIrp<span class=\"token operator\">-></span>IoStatus<span class=\"token punctuation\">.</span>Information <span class=\"token operator\">=</span> length<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"66\"></td><td><pre>\tIrp<span class=\"token operator\">-></span>IoStatus<span class=\"token punctuation\">.</span>Status <span class=\"token operator\">=</span> STATUS_SUCCESS<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"67\"></td><td><pre>\tirpsp<span class=\"token operator\">-></span>FileObject<span class=\"token operator\">-></span>CurrentByteOffset<span class=\"token punctuation\">.</span>QuadPart <span class=\"token operator\">=</span> offset<span class=\"token punctuation\">.</span>QuadPart <span class=\"token operator\">+</span> length<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"68\"></td><td><pre>\t<span class=\"token function\">IoCompleteRequest</span><span class=\"token punctuation\">(</span>Irp<span class=\"token punctuation\">,</span> IO_NO_INCREMENT<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"69\"></td><td><pre>\t<span class=\"token keyword\">return</span> STATUS_SUCCESS<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"70\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"71\"></td><td><pre></pre></td></tr><tr><td data-num=\"72\"></td><td><pre><span class=\"token keyword\">default</span><span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"73\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"74\"></td><td><pre>\t<span class=\"token comment\">// 其他情况不过滤比较简单</span></pre></td></tr><tr><td data-num=\"75\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"76\"></td><td><pre></pre></td></tr><tr><td data-num=\"77\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>以上代码书上讲的并不怎么清楚，仍有许多疑问。</p>\n<p>对于 <code>IRP_MN_MDL</code>  的情况， 需要分配一个 MDL， 并且这个 MDL 所带有的内存是有一定长度的， 这个长度必须与后来的 <code>irp→IoStatus.Information</code>  相同。 似乎上层并不以 <code>irp→IoStatus.Information</code>  返回的长度为准， 比如明明只读了 50 个字节， 但是过滤驱动返回了一个指向内存长度为 60 个字节的 MDL， 则操作系统认为已经读了 60 个字节。 这非常糟糕。</p>\n<p><strong>那么还是如何判断读取到文件结尾的呢</strong>？</p>\n<p><em>如果到某一处返回成功， 但是实际读取到的数据没有请求的数据长， 则还是返回 <code>STATUS_SUCCESS</code> ， 此后操作系统会马上发 IRP 来读最后一个位置， 此时返回长度为 0， 返回状态 <code>STATUS_FILE_END</code>  即可。 上层操作系统就会明确知道文件到结尾了</em>。</p>\n<h1 id=\"其他操作的过滤\"><a class=\"anchor\" href=\"#其他操作的过滤\">#</a> 其他操作的过滤</h1>\n<p>更多种类的过滤操作在写文件系统透明加密时学习。这里主要了解文件的打开、关闭和删除。</p>\n<h2 id=\"文件对象的生存周期\"><a class=\"anchor\" href=\"#文件对象的生存周期\">#</a> 文件对象的生存周期</h2>\n<p>首先了解什么是一个文件对象的生存周期。</p>\n<p>在进行文件系统操作过滤时，被操作的对象始终是<strong>文件对象</strong>（结构为 <code>FILE_OBJECT</code> ）。</p>\n<p>熟悉 Windows 应用编程的都知道， 对文件的操作一般都是针对文件句柄的。首先用 <code>CreateFile</code>  获得一个文件句柄； 然后可以对这个文件进行读 / 写、 查询和设置属性的操作； 最后用 <code>CloseHandle</code>  来关闭这个文件句柄。</p>\n<p>在内核中的<strong>文件对象指针</strong>， 也可以视为和文件句柄类似的东西。实际上， 在应用层使用的句柄， 是直接对应于内核中的文件对象的， 二者可以互相转换。但是它们并不是一对一的关系， 一个文件对象可以获得多个句柄。</p>\n<p>在文件系统过滤驱动中， 读者设置的分发函数首先拿到的是 IRP， 然后通过 IRP 得到文件对象指针。</p>\n<p>使用下面的代码从 IRP 中获得文件对象指针：</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>PIO_STACK_LOCATION irpsp <span class=\"token operator\">=</span> <span class=\"token function\">IoGetCurrentIrpStackLocation</span><span class=\"token punctuation\">(</span>irp<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>PFILE_OBJECT file_obj <span class=\"token operator\">=</span> irpsp<span class=\"token operator\">-></span>FileObject<span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>和句柄类似， 文件对象是在主功能号为 <code>IRP_MJ_CREATE</code>  的 IRP 完成之后诞生的（<strong>在获得这个 IRP，但是 IRP 还没有被完成时，文件对象指针已经可用。只是这时还没有真正打开文件，所以可以看作一个无效的文件对象</strong>）。</p>\n<p>同理， 文件对象是在主功能号为 <code>IRP_MJ_CLOSE</code>  的 IRP 完成之后被销毁的，之后就不能再去使用那个文件对象指针了，理论上相关内存应该已经被释放。</p>\n<p>得到文件对象之后， 在过滤某个操作时， 才能知道这个操作是在操作哪个文件。 因此， 获得文件对象非常重要。</p>\n<h2 id=\"文件的打开与关闭\"><a class=\"anchor\" href=\"#文件的打开与关闭\">#</a> 文件的打开与关闭</h2>\n<h3 id=\"如何判断是文件还是目录\"><a class=\"anchor\" href=\"#如何判断是文件还是目录\">#</a> 如何判断是文件还是目录</h3>\n<p>实际上，文件对象并不仅仅指文件。 在 Windows 文件系统中， 目录和文件都是用文件对象来抽象的。</p>\n<p><em>那么对于一个已经存在的文件对象， 如何判断它是目录还是文件呢</em>？</p>\n<p>对于一个已经存在的文件对象， 我们必须发送 IRP 向卷设备询问这个文件对象的信息。</p>\n<p>自己发送 IRP 虽然可行， 但是并不简单， 因为官方并没有标准的文档（只有 OSR 的一些资料中有介绍）。</p>\n<p><em>但是文件对象都是在打开文件时诞生的，在诞生的过程中，可以通过使用一些方法得知这个即将诞生（或者已经诞生）的文件对象是文件还是目录</em>。</p>\n<p>在文件系统过滤中常用到的做法是：<strong>在打开文件时获得文件的信息并保存起来， 然后在其他时候使用这些信息， 最后在文件被关闭时删除这些信息</strong>。</p>\n<p>之所以这样做，是因为文件系统过滤驱动代码往往在文件被操作时执行。此时再发出文件系统操作（比如查询是文件还是目录），如果不自行向下层发送 IRP 或者采取其他避免重入的手段， 则往往会导致这些操作再次被自己捕获到（这些操作也被自己过滤了），而带来很多重入处理的麻烦。 所以，往往会坚持以下原则。</p>\n<ol>\n<li>\n<p><strong>在一个文件被打开（IRP 的主功能号为 <code>IRP_MJ_CREATE</code> ） 时， 决定这个文件对象是 “要过滤” 的还是 “不要过滤” 的</strong>。 在决定之前， 默认是不要过滤的， 所以尽可以对它进行各种操作， 收集更多的信息， 都不会重入。 这些信息被存入一个哈希表中。</p>\n</li>\n<li>\n<p>在其他的文件操作（如读、 写、 查询、 设置等） 时， 只过滤哈希表中存在且标明为 “要过滤” 的文件对象的请求， 其他的操作一律放过。 此时需要的信息（如这是个文件还是目录、 全路径等） 直接从哈希表中获取， 不用尝试自己去获取了。</p>\n</li>\n<li>\n<p>在文件对象被关闭时释放哈希表中的内容。收到一个文件打开的 IRP 时， 先获得当前 <code>IO_STACK_LOCATION</code> ， 那么 <code>irpsp→Parameters.Create</code>  的结构如下：</p>\n</li>\n</ol>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\">// System service parameters for:  NtCreateFile</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token keyword\">struct</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>\tPIO_SECURITY_CONTEXT SecurityContext<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>\tULONG Options<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>\tUSHORT POINTER_ALIGNMENT FileAttributes<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\tUSHORT ShareAccess<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\tULONG POINTER_ALIGNMENT EaLength<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token punctuation\">&#125;</span> Create<span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>在 <code>irpsp→Parameters.Create.Options</code>  中可以取得一个和目录相关的关键标记，相关代码如下：</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>ULONG options <span class=\"token operator\">=</span> irpsp<span class=\"token operator\">-></span>Parameters<span class=\"token punctuation\">.</span>Create<span class=\"token punctuation\">.</span>Options<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>options <span class=\"token operator\">&amp;</span> FILE_DIRECTORY_FILE<span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>\t……</pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>并不是 Options 里面有 <code>FILE_DIRECTORY_FILE</code>  标记就表示这是一个目录，因为生成或者打开是一种尝试性的动作，<strong>只有当生成或者打开文件成功时， 判断文件对象是文件还是目录才有意义</strong>， 否则是空谈。</p>\n<p>成功有两种可能：<br />\n一、是已经打开了原有的文件或者目录；<br />\n二、是新建立了文件或者目录。</p>\n<p><code>Options</code>  里面带有 <code>FILE_DIRECTORY_FILE</code>  标记， 表示打开或者生成的对象必须是一个目录才能成功。如果在这个打开请求的<em>完成函数</em>中， 证实生成或者打开是成功的， 那么返回得到的文件确实应该是一个目录。</p>\n<p>如果这个操作失败， 那么就没有必要关心那个存在或者不存在的文件对象到底是文件还是目录了。因为操作失败了， 以后也不会再过滤它的后继操作了。所以，<strong>一般的做法是在生成（或者打开） 成功时捕获这个信息， 并记录在一个哈希表中</strong>。</p>\n<p><em>这时我们得写一个用来表示哈希表的数据结构。为了简便， 也可以简单地使用链表甚至数组，要注意保证操作时的多线程安全性</em>。</p>\n<p>我们这里要实现的功能，只是判断一个文件对象是否是目录。</p>\n<p>简单的设计： <strong>把所有认为是目录的文件对象放到一个集合里。 那么在以后的过滤中， 要判断一个文件对象是否是目录， 只要判断它是否在这个集合里即可</strong>。</p>\n<p>下面需要改动一下生成请求的完成函数。</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>NTSTATUS  <span class=\"token function\">SfCreateCompletion</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>\tIN PDEVICE_OBJECT DeviceObject<span class=\"token punctuation\">,</span> </pre></td></tr><tr><td data-num=\"3\"></td><td><pre>\tIN PIRP Irp<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>\t IN PVOID Context<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>\tPKEVENT event <span class=\"token operator\">=</span> Context<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>\tPIO</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>\t<span class=\"token function\">UNREFERENCED_PARAMETER</span><span class=\"token punctuation\">(</span>DeviceObject<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\t<span class=\"token function\">ASSERT</span><span class=\"token punctuation\">(</span><span class=\"token function\">IS_MY_DEVICE_OBJECT</span><span class=\"token punctuation\">(</span>DeviceObject<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>\t<span class=\"token function\">KeSetEvent</span><span class=\"token punctuation\">(</span>event<span class=\"token punctuation\">,</span> IO_NO_INCREMENT<span class=\"token punctuation\">,</span> FALSE<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>\t<span class=\"token keyword\">return</span> STATUS_MORE_PROCESSING_REQUIRED<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>现在所有的目录都被记录了。 当得到一个文件对象指针 <code>FileObject</code>  时， 可以判断这个  <code>FileObject</code>  在不在集合里， 如果在， 就说明是目录， 反之是文件。</p>\n<p>当这个 <code>FileObject</code>  被关闭时， 应该把它从集合中删除。 可以捕获主功能号为 <code>IRP_MJ_CLOSE</code>  的 IRP 来做这个工作。</p>\n<p>上面的方法是否可以精确地判断一个文件对象是否是目录呢？</p>\n<p>可以肯定的是， 在 <code>irpsp→Parameters.Create.Options &amp; FILE_DIRECTORY_FILE != 0</code>  的条件下， 如果一个文件对象被成功打开了， 那么这个文件对象一定是目录对象。</p>\n<p>笔者不能肯定的是， 在 <code>irpsp→Parameters.Create.Options &amp; FILE_DIRECTORY_FILE和irpsp→Parameters.Create.Options &amp; FILE_NONDIRECTORY_FILE</code>  均为 0 的情况下，Windows 是否有打开一个文件对象的可能， 而且打开后发现这个文件对象是一个目录。</p>\n<p>这一点只能请读者自己来调试验证了。</p>\n<h2 id=\"文件的删除\"><a class=\"anchor\" href=\"#文件的删除\">#</a> 文件的删除</h2>\n<p>文件是如何被删除的呢？（书中的代码里文件删除的过滤操作并没有实现）</p>\n<p>Windows 删除文件的步骤：</p>\n<p>第一步是发送一个请求打开文件， 打开文件时必须设置为有删除的访问权限； 如果打开失败， 则直接导致无法删除文件。<br />\n第二步是发出一个设置请求（主功能号是 <code>IRP_MJ_SET_INFORMATION</code> ），表示这个文件将被删除。<br />\n第三步是关闭文件， 关闭时文件将被系统删除。</p>\n<p>但是也存在不需要第二步就可能删除一个文件的情况。 一个典型的例子是， 一些临时文件在被打开时就已经被设置了 “关闭时删除”， 所以这些文件不需要再出现设置请求， 在关闭后就会被删除。一个文件被设置了 “关闭时删除” 属性之后， 这个文件在关闭之前依然存在， 但是对这个文件的大部分操作（比如写、 读、 查询等） 都会返回一个 “文件在删除中” 的错误。</p>\n<p>注意， 这里的 “删除” 并非把文件删除到回收站。 如果要测试删除， 操作时要按住 Shift 键彻底删除文件。</p>\n<p>把文件删除到回收站只是一种改名操作。改名操作是另一种设置操作（主功能号也是 <code>IRP_MJ_SET_INFORMATION</code> ， 但是 <code>IrpSp→Parameters.SetFile.FileInformationClass</code>  不同）。</p>\n<p>接下来学习如何判断是文件删除操作。</p>\n<p>注意两个关键点：</p>\n<p>第一是打开文件。</p>\n<p>在文件被打开时，捕获到 irpsp 的参数， 查阅 <code>irpsp→Parameters.Create</code>  的数据结构中， 第一域是一个 <code>IO_SECURITY_CONTEXT</code>  的指针 <code>SecurityContext</code> 。</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>PIO_SECURITY_CONTEXT SecurityContext<span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>其结构如下：</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">typedef</span> <span class=\"token keyword\">struct</span> <span class=\"token class-name\">_IO_SECURITY_CONTEXT</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    PSECURITY_QUALITY_OF_SERVICE SecurityQos<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    PACCESS_STATE AccessState<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    ACCESS_MASK DesiredAccess<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    ULONG FullCreateOptions<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">&#125;</span> IO_SECURITY_CONTEXT<span class=\"token punctuation\">,</span> <span class=\"token operator\">*</span>PIO_SECURITY_CONTEXT<span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>注意其中的 <code>DesiredAccess</code> ， 必须设置 <code>DELETE</code>  位， 才有可能删除文件。</p>\n<p>第二是设置 “关闭时删除”。</p>\n<p>因为这是通过发送一个 IRP（ <code>IRP_MJ_SET_INFORMATION</code> ）来设置的。所以我们捕获的主功能号 <code>IRP_MJ_SET_INFORMATION</code>  的 IRP 后：首先，  <code>irpsp→Parameters.SetFile.FileInformationClass</code>  应该为 <code>FileDispositionInformation</code> 。然后，  <code>irp→AssociatedIrp.SystemBuffer</code>  指向如下的一个结构：</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">typedef</span> <span class=\"token keyword\">struct</span> <span class=\"token class-name\">_FILE_DISPOSITION_INFORMATION</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    BOOLEAN DeleteFile<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">&#125;</span> FILE_DISPOSITION_INFORMATION<span class=\"token punctuation\">,</span> <span class=\"token operator\">*</span>PFILE_DISPOSITION_INFORMATION<span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>如果域 <code>DeleteFile</code>  为 <code>TRUE</code> ，那么这是一个删除文件的操作，文件将在这个文件对象关闭时被真正删除。</p>\n<p>知道了这些后就可以判断是否是文件删除操作了，进而去实现过滤操作。</p>\n<h1 id=\"路径过滤\"><a class=\"anchor\" href=\"#路径过滤\">#</a> 路径过滤</h1>\n<p>路径过滤是指根据文件的路径来决定是否要过滤这个文件。</p>\n<p>在文件系统过滤中，路径过滤是极其常见的需求。比较典型的有， 如果进行文件加密， 有时候客户会要求不加密某个目录下的文件；或者要求只加密某个目录下的文件。同样，在视频点播时，也可以把所有的流媒体文件都放在某些特定的目录下，则在文件过滤处理时就不用关心其他的文件了。</p>\n<h2 id=\"取得路径的三种情况\"><a class=\"anchor\" href=\"#取得路径的三种情况\">#</a> 取得路径的三种情况</h2>\n<p>现在的问题就是， 如何从 IRP 中（或者说如何从文件对象中） 得到这个文件的路径？</p>\n<p>取得文件的路径有三种情况：</p>\n<p>第一， 在文件打开之前， 从打开文件的请求中提取路径。 换句话说，这个文件并不一定真实存在， 只是在 Windows 试图打开（或者生成） 某个文件时， 从 <code>FileObject-&gt;FileName</code>  中提取文件路径。 后面会讨论这种方法的困难之处。</p>\n<p>第二， 在文件打开 IRP 处理结束后获取路径。是最容易解决的。</p>\n<p>第三， 在文件过滤其他 IRP 时（如改名、 查询、 设置、 读、 写） ， 得到文件对象所对应的文件路径。</p>\n<p>以上三种情况中的第一种情况最麻烦； 第二种情况最简单； 第三种情况则一般都按照前面提到过的常用做法： 把要关心路径的文件对象指针及其路径（在第二种情况下获得）都保存在哈希表中， 然后在第三种情况下直接查哈希表。 所以只要第二种情况的问题得到了解决， 在第三种情况下就可以轻松获得文件路径， 不需要再另想办法了。</p>\n<h2 id=\"打开成功后获取路径\"><a class=\"anchor\" href=\"#打开成功后获取路径\">#</a> 打开成功后获取路径</h2>\n<p>在文件打开 IRP 完成后，文件对象已经生成完成，我们可以使用  <code>ObQueryNameString</code>  函数。函数的原型如下：</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>NTSTATUS</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token function\">ObQueryNameString</span> <span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    IN PVOID Object<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    OUT POBJECT_NAME_INFORMATION ObjectNameInfo<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    IN ULONG Length<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    OUT PULONG ReturnLength</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>此例程处理对象名称信息的查询</p>\n<p><strong>参数：</strong></p>\n<p><code>Object</code> : 提供要查询的对象。</p>\n<p><code>ObjectNameInfo</code> : 提供缓冲区以存储返回的名称字符串信息。</p>\n<p><code>Length</code> : 指定原始对象名称信息缓冲区的长度（以字节为单位）。</p>\n<p><code>ReturnLength</code> : 返还 <code>ObjectNameInfo</code>  中已使用的字节数。</p>\n<p>（ <code>Length</code>  减去 <code>ReturnLength</code> ）实际上是输出缓冲区中剩余的字节数。提供给此调用的缓冲区实际上可能在原始用户缓冲区内偏移</p>\n<p>其中的 <code>ObjectNameInfo</code>  的结构如下：</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">typedef</span> <span class=\"token keyword\">struct</span> <span class=\"token class-name\">_OBJECT_NAME_INFORMATION</span> <span class=\"token punctuation\">&#123;</span>               </pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    UNICODE_STRING Name<span class=\"token punctuation\">;</span>                                </pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">&#125;</span> OBJECT_NAME_INFORMATION<span class=\"token punctuation\">,</span> <span class=\"token operator\">*</span>POBJECT_NAME_INFORMATION<span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>这个结构必须自己分配好内存， 而且它需要的长度取决于实际要返回的名字的长度。</p>\n<p>注意， 这里的 <code>Name</code>  是一个 <code>UNICODE_STRING</code> 。 我们知道实际的字符串内容会写入 <code>Name.Buffer</code>  中。但是要注意的是， 我们不要自己去分配 <code>Name.Buffer</code> ， <code>ObQueryNameString</code>  会自动把 <code>Name.Buffer</code>  设置为 <code>Name</code>  域之后紧接着的地址。<br />\n<strong>如果要使用这个函数获得正确的结果， 就必须传入一个长度足够的 <code>POBJECT_NAME_INFORMATION</code>  指针</strong>。</p>\n<p>如何预知需要多长的缓冲区呢？</p>\n<p>可以在第一次调用时， 使用一个预测的缓冲区长度，然后设置 <code>Length</code>  参数为缓冲区的长度。 如果成功，后面的操作就是多余的； 如果不成功，这个函数就会返回 <code>STATUS_INFO_LENGTH_MISMATCH</code> ， 并且在 <code>ReturnLength</code>  中得到实际需要的长度。</p>\n<p>该函数的正确调用方法示例如下：</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">// 先猜测行地假设只需要 64 个字节长度的数据</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>\tUCHAR buf<span class=\"token punctuation\">[</span><span class=\"token number\">64</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span> <span class=\"token number\">0</span> <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>\tPUCHAR new_buf <span class=\"token operator\">=</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>\tULONG length <span class=\"token operator\">=</span> <span class=\"token number\">64</span><span class=\"token punctuation\">,</span> ret_length<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>\tPOBJECT_NAME_INFORMATION name_infor <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>POBJECT_NAME_INFORMATION<span class=\"token punctuation\">)</span>buf<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>\tNTSTATUS status <span class=\"token operator\">=</span> STATUS_SUCCESS<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>\t<span class=\"token comment\">// 第一次调用，使用默认的长度</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\tstatus <span class=\"token operator\">=</span> <span class=\"token function\">ObQueryNameString</span><span class=\"token punctuation\">(</span>pFileObj<span class=\"token punctuation\">,</span> name_infor<span class=\"token punctuation\">,</span> length<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>ret_length<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>status <span class=\"token operator\">==</span> STATUS_INFO_LENGTH_MISMATCH<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>\t\t<span class=\"token comment\">// 第二次调用，重新分配长度</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>\t\tnew_buf <span class=\"token operator\">=</span> <span class=\"token function\">ExAllocatePoolWithTag</span><span class=\"token punctuation\">(</span>NonPagedPool<span class=\"token punctuation\">,</span> ret_length<span class=\"token punctuation\">,</span> SFLT_POOL_TAG<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>\t\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>new_buf <span class=\"token operator\">==</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>\t\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>\t\t\t<span class=\"token comment\">// 内存不足，错误处理</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>\t\tname_infor <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>POBJECT_NAME_INFORMATION<span class=\"token punctuation\">)</span>new_buf<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>\t\tstatus <span class=\"token operator\">=</span> <span class=\"token function\">ObQueryNameString</span><span class=\"token punctuation\">(</span>pFileObj<span class=\"token punctuation\">,</span> name_infor<span class=\"token punctuation\">,</span> ret_length<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>ret_length<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>\t\t<span class=\"token comment\">// 如果 status 为 STATUS_SUCCESS，那么 name_infor->Name 就是要获得的名字了。</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>\t\t<span class=\"token comment\">// 这里可以加入自己的处理</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>\t\t<span class=\"token comment\">// ……</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>new_buf <span class=\"token operator\">!=</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">)</span> </pre></td></tr><tr><td data-num=\"28\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>\t\t<span class=\"token function\">ExFreePoolWithTag</span><span class=\"token punctuation\">(</span>new_buf<span class=\"token punctuation\">,</span> SFLT_POOL_TAG<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>若对一个叫作 <code>MyFile.Name</code>  的文件使用上面的方法， 则返回的路径可能是 <code>“\\Device\\HardDisk- Volume1\\MyDirectory\\MyFile.Name”</code> 。</p>\n<p>这里再次强调一下， 必须在文件打开 IRP 完成之后再进行调用。 如果直接在 <code>SfCreate</code>  函数的早期进行调用， 则只能得到一个路径：  <code>“\\Device\\HardDiskVolume1”</code> 。这个路径不完整， 只能看到卷设备路径。通过卷设备路径可以获得盘符， 可以确定文件在哪个逻辑盘上。 但无法得知文件的具体路径。</p>\n<p>可能有些读者会联想到， 既然通过  <code>QbQueryNameString</code>  就可以获得路径， 那么在其他请求的过滤中， 直接对文件对象调用  <code>QbQueryNameString</code>  就行了。但是需要注意的是，  <code>ObQueryNameString</code>  只能在打开（ <code>IRP_MJ_CREATE</code> ） IRP 和清理（ <code>IRP_MJ_CLEANUP</code> ） 或者关闭（ <code>IRP_MJ_CLOSE</code> ） IRP 的处理中使用； 否则很容易锁死， 原因不明。（有时间逆一下 QbQueryNameString 函数看一下）。</p>\n<h2 id=\"在其他时刻获得文件路径\"><a class=\"anchor\" href=\"#在其他时刻获得文件路径\">#</a> 在其他时刻获得文件路径</h2>\n<p>在文件过滤其他请求时（如改名、 查询、 设置、 读、 写） ， 如何获得文件对象所对应的文件路径呢？</p>\n<p>在文件读 / 写时往往没有好的办法可以直接得到文件路径。 对文件对象进行 ObQueryNameString 很容易导致死机， 这似乎是 Windows 本身的问题。 但是如果读者可以直接向下层设备发送 IRP 进行查询， 就不会死机。 发送一个主功能号为 IRP_MJ_QUERY_INFORMATION 的代码还算比较简单， 可以在网上找到例子。 但是， 这并非是有文档可查、 合理的方法， 因为微软并没有公开每个请求的 IRP 如何填写， 许多细节是一些开发者自己调试出来的， 所以未来难保在兼容性上不出现问题。</p>\n<p>有些读者会发现 <code>FileObject-&gt;FileName</code>  是存在的， 并且保存着这个文件在设备上的路径（不包括盘符） 。 但是遗憾的是， 微软的文档已经声明， 任何过滤层都可以修改 <code>FileObject-&gt;FileName</code> 。 在文件成功打开之后， 就不能再认为 <code>FileObject-&gt;FileName</code>  依然有效了（虽然实际在大多数情况下是有效的） 。 此外，  <code>FileObject-&gt;FileName</code>  还存在一些其他的问题， 将在下一节中进行少量说明。</p>\n<p>既然前面在文件对象的生成请求处理结束后已经得到了路径， 那么就可以把它存在一个表中， 当 FileObject 被关闭时清除这个表项以避免内存泄露。 然后无论是读、 写、 查询、 设置还是重命名（设置的一种） ， 我们都可以通过这个表来查询路径。</p>\n<p>应该用哈希表来提高效率。 哈希表是数据结构问题， 请读者自己实现。 这个表的使用方法简述如下：</p>\n<p>（1） 在 <code>SfCreate</code>  中， 获得 <code>FileObject</code>  的文件路径（用前面的方法） ， 并把 <code>FileObject</code>  指针和路径的对应关系保存在一个哈希表中。<br />\n（2） 在任何时候都可以在表中查询到一个 <code>FileObject</code>  对应的路径， 不必担心重入和中断级别等问题。<br />\n（3） 在 <code>SfCleanUp</code>  中删去该 <code>FileObject</code>  对应的节点。</p>\n<h2 id=\"在打开请求完成之前获得路径名\"><a class=\"anchor\" href=\"#在打开请求完成之前获得路径名\">#</a> 在打开请求完成之前获得路径名</h2>\n<p>最后一个问题是， 如何在打开 IRP（ <code>IRP_MJ_CREATE</code> ） 处理之前得到路径名？</p>\n<p>唯一的途径是使用 <code>FileObject-&gt;FileName</code> 。 要注意 <code>FileObject→ReleatedObject</code>  不为空的情况， 这时 <code>FileObject-&gt;FileName</code>  是 <code>RelatedObject</code>  的相对路径（ <code>RelatedObject</code>  一般是一个目录）。</p>\n<p>首先要调用内核 API 函数 <code>ObQueryNameString</code>  来查询这个对象的全路径，得到路径之后再和 <code>FileObject-&gt;FileName</code>  组合， 在组合时还要注意， 中间是否需要插入一个 <code>“\\”</code> （根据前后是否已经有 <code>“\\”</code>  存在来决定）。</p>\n<p>相关的代码如下。 请注意， 这个函数能获得的路径是从 <code>FileObject-&gt;FileName</code>  中获得的， 有一个问题就是其中可能含有短名。 如果一定要获得长名， 则需要按照下一节中的方法进行特殊处理。</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">MEM_TAG</span> <span class=\"token string\">'mymt'</span></span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token comment\">// 在 Create 之前，获得完整的路径</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>ULONG <span class=\"token function\">MyFileFullPathPreCreate</span><span class=\"token punctuation\">(</span>IN PFILE_OBJECT pFileObj<span class=\"token punctuation\">,</span> OUT PUNICODE_STRING path<span class=\"token punctuation\">)</span> </pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>\tNTSTATUS status<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>\tPOBJECT_NAME_INFORMATION obj_name_info <span class=\"token operator\">=</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\tWCHAR buf<span class=\"token punctuation\">[</span><span class=\"token number\">64</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span> <span class=\"token number\">0</span> <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\t<span class=\"token keyword\">void</span><span class=\"token operator\">*</span> obj_ptr<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>\tULONG length <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>\tBOOLEAN need_split <span class=\"token operator\">=</span> FALSE<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>\t<span class=\"token function\">ASSERT</span><span class=\"token punctuation\">(</span>pFileObj <span class=\"token operator\">!=</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>pFileObj <span class=\"token operator\">==</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>\t\t<span class=\"token keyword\">return</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>pFileObj<span class=\"token operator\">-></span>FileName<span class=\"token punctuation\">.</span>Buffer <span class=\"token operator\">==</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>\t\t<span class=\"token keyword\">return</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>\tobj_name_info <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>POBJECT_NAME_INFORMATION<span class=\"token punctuation\">)</span>buf<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>\t<span class=\"token keyword\">do</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>\t\t<span class=\"token comment\">// 获取 FileName 前面的部分（设备路径或者根目录路径）</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>\t\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>pFileObj<span class=\"token operator\">-></span>RelatedFileObject <span class=\"token operator\">!=</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>\t\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>\t\t\tobj_ptr <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">void</span><span class=\"token operator\">*</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span>pFileObj<span class=\"token operator\">-></span>RelatedFileObject<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>\t\t<span class=\"token keyword\">else</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>\t\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>\t\t\tobj_ptr <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">void</span><span class=\"token operator\">*</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span>pFileObj<span class=\"token operator\">-></span>DeviceObject<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>\t\tstatus <span class=\"token operator\">=</span> <span class=\"token function\">ObQueryNameString</span><span class=\"token punctuation\">(</span>obj_ptr<span class=\"token punctuation\">,</span> obj_name_info<span class=\"token punctuation\">,</span> <span class=\"token number\">64</span> <span class=\"token operator\">*</span> <span class=\"token keyword\">sizeof</span><span class=\"token punctuation\">(</span>WCHAR<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>length<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>\t\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>status <span class=\"token operator\">==</span> STATUS_INFO_LENGTH_MISMATCH<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>\t\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>\t\t\tobj_name_info <span class=\"token operator\">=</span> <span class=\"token function\">ExAllocatePoolWithTag</span><span class=\"token punctuation\">(</span>NonPagedPool<span class=\"token punctuation\">,</span> length<span class=\"token punctuation\">,</span> MEM_TAG<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>\t\t\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>obj_name_info <span class=\"token operator\">==</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>\t\t\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>\t\t\t\t<span class=\"token keyword\">return</span> STATUS_INSUFFICIENT_RESOURCES<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>\t\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>\t\t\t<span class=\"token function\">RtlZeroMemory</span><span class=\"token punctuation\">(</span>obj_name_info<span class=\"token punctuation\">,</span> length<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>\t\t\tstatus <span class=\"token operator\">=</span> <span class=\"token function\">ObQueryNameString</span><span class=\"token punctuation\">(</span>obj_ptr<span class=\"token punctuation\">,</span> obj_name_info<span class=\"token punctuation\">,</span> length<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>length<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>\t\t<span class=\"token comment\">//  若失败直接跳出即可</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>\t\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token function\">NT_SUCCESS</span><span class=\"token punctuation\">(</span>status<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>\t\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre>\t\t\t<span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre></pre></td></tr><tr><td data-num=\"55\"></td><td><pre>\t\t<span class=\"token comment\">/* </pre></td></tr><tr><td data-num=\"56\"></td><td><pre>\t\t判断二者之间是否需要多加一个 \"\\\" </pre></td></tr><tr><td data-num=\"57\"></td><td><pre>\t\t若 FileName 的第一个字符不是 \"\\\" 且 obj_name_info 的最后一个字符不是 \"\\\" 则加入 \"\\\"</pre></td></tr><tr><td data-num=\"58\"></td><td><pre>\t\t*/</span></pre></td></tr><tr><td data-num=\"59\"></td><td><pre>\t\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre>\t\t\tpFileObj<span class=\"token operator\">-></span>FileName<span class=\"token punctuation\">.</span>Length <span class=\"token operator\">></span> <span class=\"token number\">2</span> <span class=\"token operator\">&amp;&amp;</span></pre></td></tr><tr><td data-num=\"61\"></td><td><pre>\t\t\tpFileObj<span class=\"token operator\">-></span>FileName<span class=\"token punctuation\">.</span>Buffer<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">!=</span> L<span class=\"token string\">\"\\\\\"</span> <span class=\"token operator\">&amp;&amp;</span></pre></td></tr><tr><td data-num=\"62\"></td><td><pre>\t\t\tobj_name_info<span class=\"token operator\">-></span>Name<span class=\"token punctuation\">.</span>Buffer<span class=\"token punctuation\">[</span></pre></td></tr><tr><td data-num=\"63\"></td><td><pre>\t\t\t\tobj_name_info<span class=\"token operator\">-></span>Name<span class=\"token punctuation\">.</span>Length <span class=\"token operator\">/</span> <span class=\"token keyword\">sizeof</span><span class=\"token punctuation\">(</span>WCHAR<span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">!=</span> L<span class=\"token string\">\"\\\\\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"64\"></td><td><pre>\t\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"65\"></td><td><pre>\t\t\tneed_split <span class=\"token operator\">=</span> TRUE<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"66\"></td><td><pre>\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"67\"></td><td><pre>\t\t</pre></td></tr><tr><td data-num=\"68\"></td><td><pre>\t\t<span class=\"token comment\">// 获取总体名字的长度。如果长度不足，直接返回</span></pre></td></tr><tr><td data-num=\"69\"></td><td><pre>\t\tlength <span class=\"token operator\">=</span> obj_name_info<span class=\"token operator\">-></span>Name<span class=\"token punctuation\">.</span>Length <span class=\"token operator\">+</span> pFileObj<span class=\"token operator\">-></span>FileName<span class=\"token punctuation\">.</span>Length<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"70\"></td><td><pre>\t\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>need_split<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"71\"></td><td><pre>\t\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"72\"></td><td><pre>\t\t\tlength <span class=\"token operator\">+=</span> <span class=\"token keyword\">sizeof</span><span class=\"token punctuation\">(</span>WCHAR<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"73\"></td><td><pre>\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"74\"></td><td><pre>\t\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>path<span class=\"token operator\">-></span>MaximumLength <span class=\"token operator\">&lt;</span> length<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"75\"></td><td><pre>\t\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"76\"></td><td><pre>\t\t\t<span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"77\"></td><td><pre>\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"78\"></td><td><pre>\t\t</pre></td></tr><tr><td data-num=\"79\"></td><td><pre>\t\t<span class=\"token comment\">// 先把设备名拷贝进去</span></pre></td></tr><tr><td data-num=\"80\"></td><td><pre>\t\t<span class=\"token function\">RtlCopyUnicodeString</span><span class=\"token punctuation\">(</span>path<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>obj_name_info<span class=\"token operator\">-></span>Name<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"81\"></td><td><pre>\t\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>need_split<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"82\"></td><td><pre>\t\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"83\"></td><td><pre>\t\t\t<span class=\"token comment\">// 追加一个 \"\\\"</span></pre></td></tr><tr><td data-num=\"84\"></td><td><pre>\t\t\t<span class=\"token function\">RtlAppendUnicodeStringToString</span><span class=\"token punctuation\">(</span>path<span class=\"token punctuation\">,</span> L<span class=\"token string\">\"\\\\\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"85\"></td><td><pre>\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"86\"></td><td><pre></pre></td></tr><tr><td data-num=\"87\"></td><td><pre>\t\t<span class=\"token comment\">// 然后追加 FileName</span></pre></td></tr><tr><td data-num=\"88\"></td><td><pre>\t\t<span class=\"token function\">RtlAppendUnicodeStringToString</span><span class=\"token punctuation\">(</span>path<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>pFileObj<span class=\"token operator\">-></span>FileName<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"89\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"90\"></td><td><pre></pre></td></tr><tr><td data-num=\"91\"></td><td><pre>\t<span class=\"token comment\">// 如果分配过空间就释放掉</span></pre></td></tr><tr><td data-num=\"92\"></td><td><pre>\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">void</span><span class=\"token operator\">*</span><span class=\"token punctuation\">)</span>obj_name_info <span class=\"token operator\">!=</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">void</span><span class=\"token operator\">*</span><span class=\"token punctuation\">)</span>buf<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"93\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"94\"></td><td><pre>\t\t<span class=\"token function\">ExFreePoolWithTag</span><span class=\"token punctuation\">(</span>obj_name_info<span class=\"token punctuation\">,</span> MEM_TAG<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"95\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"96\"></td><td><pre>\t<span class=\"token keyword\">return</span> length<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"97\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h2 id=\"把短名转换为长名\"><a class=\"anchor\" href=\"#把短名转换为长名\">#</a> 把短名转换为长名</h2>\n<p>在早期的 DOS 系统上， 文件名最长为 8 个字符， 扩展名最长为 3 个字符， 所以， 如果 Windows 上的文件名超过 8 个字符， Windows 就会为它分配一个短名， 例如文件名 <code>123456789.123</code>  会变成 <code>123456～1.123</code> 。当然， 也有保存为长名的。 在 <code>FileObject-&gt;FileName</code>  中保存的文件名不一定是长名， 也有可能是短名。 一旦碰到， 你想要获得完整的文件长名就比较麻烦了。 笔者没有找到将这些短名转换为长名的简易方法， 有人提供了一个非常麻烦但是确实有效的办法， 其思想是：</p>\n<p>首先假设得到一个路径 <code>\\aaaaaa~1\\bbbbbb~1\\cccccc~1\\dddddd~1.txt</code> ， 然后把它分解成 5 个对象：</p>\n<figure class=\"highlight raw\"><figcaption data-lang=\"\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>\\</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>aaaaaa~1</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>bbbbbb~1</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>cccccc~1</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>dddddd~1.txt</pre></td></tr></table></figure><p>先用 ZwCreateFile 打开第一个目录， 第一个目录总是 “\\”（不需要长短转换） ， 然后调用 <code>ZwQueryDirectoryFile</code>  枚举下面所有的文件和目录。 如果进行查询（令查询类别为 FileIdBoth- DirectoryInformation） ， 那么会得到一组 <code>FILE_ID_BOTH_DIR_INFORMATION</code> ， 代表下面的每个文件和目录。 得到的 <code>FILE_ID_BOTH_DIR_INFORMATION</code>  结构如下：</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">typedef</span> <span class=\"token keyword\">struct</span> <span class=\"token class-name\">_FILE_ID_BOTH_DIR_INFORMATION</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    ULONG NextEntryOffset<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    ULONG FileIndex<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    LARGE_INTEGER CreationTime<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    LARGE_INTEGER LastAccessTime<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    LARGE_INTEGER LastWriteTime<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    LARGE_INTEGER ChangeTime<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    LARGE_INTEGER EndOfFile<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    LARGE_INTEGER AllocationSize<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    ULONG FileAttributes<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    ULONG FileNameLength<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    ULONG EaSize<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    CCHAR ShortNameLength<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    WCHAR ShortName<span class=\"token punctuation\">[</span><span class=\"token number\">12</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\t<span class=\"token comment\">// 这里有短名</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    LARGE_INTEGER FileId<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    WCHAR FileName<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\t\t<span class=\"token comment\">// 这里有长名</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token punctuation\">&#125;</span> FILE_ID_BOTH_DIR_INFORMATION<span class=\"token punctuation\">,</span> <span class=\"token operator\">*</span>PFILE_ID_BOTH_DIR_INFORMATION<span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>长、 短名都到手了， 那么编程者当然可以找到 “\\” 之下的第一个 “aaaaaa~1” 所对应的长名， 然后依此类推， 逐个查询。 这是个麻烦的办法， 但是确实有效。</p>\n<p>此代码书中并没有给需要我们自己完成它。</p>\n",
            "tags": [
                "文件系统"
            ]
        },
        {
            "id": "https://or0kit.github.io/Bin/Core/Drive-Development/%E7%A3%81%E7%9B%98%E7%9A%84%E8%BF%87%E6%BB%A4/",
            "url": "https://or0kit.github.io/Bin/Core/Drive-Development/%E7%A3%81%E7%9B%98%E7%9A%84%E8%BF%87%E6%BB%A4/",
            "title": "磁盘的过滤",
            "date_published": "2022-07-31T14:41:58.000Z",
            "content_html": "<h1 id=\"磁盘过滤\"><a class=\"anchor\" href=\"#磁盘过滤\">#</a> 磁盘过滤</h1>\n<h2 id=\"磁盘过滤驱动的概念\"><a class=\"anchor\" href=\"#磁盘过滤驱动的概念\">#</a> 磁盘过滤驱动的概念</h2>\n<p>首先需要了解一些关于磁盘过滤驱动的相关概念。</p>\n<h3 id=\"设备过滤和类过滤\"><a class=\"anchor\" href=\"#设备过滤和类过滤\">#</a> 设备过滤和类过滤</h3>\n<p>过滤的概念：所谓过滤就是在本来已有的设备栈中加入一个自己的设备。</p>\n<p>由于 Windows 向任何一个设备发送 IRP 请求都会首先发给这个设备所在设备栈的最上层设备，然后再依次传递下去，这就使得加入的设备在目标设备之前获取 IRP 请求成为可能，这时候就可以有机会加入用户自己的处理流程。在这里将插入设备栈的用户设备称为过滤设备，将建立这个设备并使其具有特殊功能的驱动称为过滤驱动。</p>\n<p>前面我们已经学习了设备过滤，<em>如何建立一个过滤设备并将其绑定在一个有名字的设备上</em>。从设备过滤这个名字可以看出，<strong>这是对某个特定设备加以过滤的方法。</strong></p>\n<p>但是在实际应用中，还有很多问题，例如，Windows 中有很多即插即用的设备，如何在这些设备加入系统中时就自动地对它们进行绑定？Windows 中还存在一些具有共同类型的设备，如何对这一类设备进行绑定？</p>\n<p>实际上，在 Windows 的过滤驱动架构中，还有一种叫作<strong>类过滤驱动</strong>的驱动程序，<strong>能够在某一类特定的设备建立时由 PnP 管理器调用指定的过滤驱动代码，并且允许用户在此时对这一类设备进行绑定</strong>。根据用户设备在整个设备栈上相对于系统本来存在设备的不同位置，可以分为上层过滤和下层过滤，其中以上层过滤最为常见，因为这时过滤设备在设备栈上位于实际功能设备的上面，会首先获得 Windows 系统发下来的 IRP 请求，便于过滤设备的实现者进行处理。</p>\n<h3 id=\"磁盘设备和磁盘卷设备过滤驱动\"><a class=\"anchor\" href=\"#磁盘设备和磁盘卷设备过滤驱动\">#</a> 磁盘设备和磁盘卷设备过滤驱动</h3>\n<p>本章主要学习 Windows 存储系统的过滤，在学习代码之前，还需要了解一下 Windows 存储系统中的一些概念。</p>\n<p><em>在 Windows 的存储系统中，最底层的是磁盘，而在磁盘上面又有卷，卷虽然只是逻辑上的一个概念，但是 Windows 仍然为其建立了设备，所以在 Windows 的存储系统里有磁盘设备和磁盘卷设备两种类型的设备。</em></p>\n<p>如果一个磁盘卷位于某个磁盘上，那么对于磁盘卷的访问最终也会体现在相应的磁盘上。<strong>但是这不意味着它们在一个设备栈上，IRP 不会原封不动地从磁盘卷设备栈上一直传到磁盘设备栈上，更何况 Windows 中还存在着跨磁盘的卷、软 RAID 卷等不能对应到唯一磁盘上的卷</strong>。所以务必将这两种设备的概念区分开，而不要将其当作同一种设备来对待。</p>\n<p>从驱动的角度来讲，<em>这两种设备收到的读 / 写请求都是针对磁盘大小或者卷大小范围之内的请求，都是以扇区大小对齐的，处理起来也没有什么太大的区别</em>。</p>\n<p>在本章中主要讲解磁盘卷设备的上层类过滤驱动，因为对于 Windows 用户来说，卷是最直接看到的对象；而对于开发人员来说，使用卷过滤会在一定程度上减少工作量，因为不需要处理磁盘设备中才会遇到的一些问题，但是同时也限制了一些功能的实现，原因同样是不能处理磁盘设备上的问题，正所谓有利必有弊。</p>\n<h3 id=\"注册表和磁盘卷设备过滤驱动\"><a class=\"anchor\" href=\"#注册表和磁盘卷设备过滤驱动\">#</a> 注册表和磁盘卷设备过滤驱动</h3>\n<p>在实际的系统运行过程中，一个普通的驱动程序是如何告知 Windows 操作系统它是一个类过滤驱动，并且如何和相应的设备类联系起来呢？这就需要注册表的帮忙了。</p>\n<p>我们知道一个驱动程序作为服务是如何在注册表中存在的：在  <code>\\HKEY_LOCAL_MACHINE\\SYSTEM\\CurrentControlSet\\Services</code>  下服务键的名字也就是这个服务的名字了。</p>\n<p>在 <code>\\HKEY_LOCAL_MACHINE\\SYSTEM\\CurrentControlSet\\Control\\Class</code>  下，也有许多类的名字，这些类的名字都是一长串数字，这一长串数字实际上是一个 <code>ClassGUID</code> ，随意选择一个键，下面都会有一个叫作 Class 的值，这就是一个类。</p>\n<p><strong>在这些键中，可以找到一个 Class 值为 <code>“Volume”</code>  的键，这就是磁盘卷类。最关心的是其中一个叫作 <code>UpperFilters</code>  的值，这个值起了最为关键的作用 —— 说明这个类的上层过滤驱动都有哪些。</strong></p>\n<p><img data-src=\"image001.png\" alt=\"\" /></p>\n<p><em>只需要在这个 UpperFilter 值中填入相应的驱动名（服务名），这个驱动就会作为这一类设备的上层过滤驱动被 Windows 操作系统所识别，实际上这样也就完成了上层过滤驱动的安装工作。</em></p>\n<h2 id=\"具有还原功能的磁盘卷过滤驱动\"><a class=\"anchor\" href=\"#具有还原功能的磁盘卷过滤驱动\">#</a> 具有还原功能的磁盘卷过滤驱动</h2>\n<p>将磁盘卷上的数据恢复到之前的某个时间点，在这个时间点之后无论对磁盘卷上的文件做过什么操作都将被抹去，这个卷被称为还原卷。</p>\n<p>由于这个过滤驱动只是为了讲解而写的，所以这里对它的使用条件限制得比较多。这个驱动工作时需要系统中只有一个硬盘，需要使用 Windows XP 系统，并且硬盘被分为 C 盘为主分区、D 盘和 E 盘都为扩展分区的分区形式，而且所有分区都必须是 NTFS 系统。本驱动只保护 D 盘并且会在 E 盘上建立临时文件，而且要求操作系统安装在 C 盘上，故这里需要 C、D、E 三个分区。</p>\n<h3 id=\"基本思想\"><a class=\"anchor\" href=\"#基本思想\">#</a> 基本思想</h3>\n<p>为了实现还原，一种简单的思路如下：</p>\n<ul>\n<li>\n<p>在开启还原之后，所有对还原卷的写操作将被写到另一个地方，而不会真正写在还原卷上。这里所说的另一个地方也可以称之为转存处。</p>\n</li>\n<li>\n<p>在开启还原之后，所有对还原卷的读操作将分为两种情况处理：一种情况是读了开启还原之前就存在的内容，这种情况就按照正常的读取方式从还原卷上读取；另一种情况是读了开启还原之后写到还原卷上的内容，这种情况将会从转存处把之前写过的内容读取出来。</p>\n</li>\n<li>\n<p>上述读 / 写必须建立在互斥的基础上，不能出现写了一半就开始读的情况。</p>\n</li>\n<li>\n<p>重启之后转存处的数据清零，所有在还原开始后被写过的数据也就不复存在了。</p>\n</li>\n<li>\n<p>上述转存同样必须在卷设定为还原之后立即起作用，而不能出现写了一半才开始转存的情况；否则数据会在重启之后不同步。</p>\n</li>\n</ul>\n<p>如果严格按照这几点来执行，确实能够达到重启之后卷上数据就全部还原的效果。</p>\n<h2 id=\"驱动分析\"><a class=\"anchor\" href=\"#驱动分析\">#</a> 驱动分析</h2>\n<p>开始学习代码，了解如何用代码实现磁盘的还原功能，学习编写的思路。</p>\n<h3 id=\"driverentry函数\"><a class=\"anchor\" href=\"#driverentry函数\">#</a> DriverEntry 函数</h3>\n<p>驱动入口函数，主要负责初始化本驱动的各分发函数。</p>\n<ol>\n<li>将所有的分发函数都设置成一个统一的处理函数，这个函数是对大部分 IRP 请求的处理方式；</li>\n<li>将本驱动关心的分发函数指定为驱动专门实现的函数；</li>\n<li>指定这个驱动的 <code>AddDevice</code>  函数和 <code>Unload</code>  函数。</li>\n<li>注册一个 <code>boot</code>  类型驱动的完成回调函数。</li>\n</ol>\n<p>由于这个驱动被注册成了磁盘卷设备的上层过滤驱动，<em>PnP 管理器将会在一个新的磁盘卷设备建立之后</em>，<strong>首先调用本过滤驱动的 <code>AddDevice</code>  函数，然后再调用磁盘卷设备驱动中的 <code>AddDevice</code>  函数</strong>。这就让过滤驱动有了在系统加入磁盘卷设备起作用之前做一些工作的机会，而 Unload 函数会在过滤驱动结束时被调用，用来做一些清理的工作。不过本过滤驱动将会一直工作到系统关机，所以基本上 Unload 函数将不会做任何清理工作。</p>\n<p>这里注意  <code>AddDevice</code>  函数的调用时机。</p>\n<p>另外，本过滤驱动是作为一个 <code>boot</code>  类型驱动存在的，这一点可以在注册表的 <code>\\HKEY_LOCAL_MACHINE\\SYSTEM\\CurrentControlSet\\Services</code>  下驱动服务的 start 值中指定，0 为 boot 类型。</p>\n<p><strong>boot 类型的驱动程序是启动最早的驱动程序，在系统引导时就必须加载完毕；而对于注册为 boot 类型驱动的完成回调函数的函数，将会在所有的 boot 类型驱动执行完毕之后被调用一次，需要注意的是，这时候仍然是系统启动过程中比较早的时候。</strong></p>\n<p>在这里需要注册这个回调函数，是因为驱动中有些工作需要等到这个时间才能做，具体是什么工作后面会知道的。</p>\n<p>下面是代码：</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>NTSTATUS</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token function\">DriverEntry</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    IN\tPDRIVER_OBJECT\tDriverObject<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    IN\tPUNICODE_STRING\tRegistryPath</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>\t<span class=\"token keyword\">int</span> i<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\t<span class=\"token comment\">//KdBreakPoint();</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>\t<span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span>i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;=</span> IRP_MJ_MAXIMUM_FUNCTION<span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>\t\t<span class=\"token comment\">// 初始化这个驱动所有的分发函数，默认值是初始化为 DPDispatchAny</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>\t\tDriverObject<span class=\"token operator\">-></span>MajorFunction<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> DPDispatchAny<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    </pre></td></tr><tr><td data-num=\"17\"></td><td><pre>\t<span class=\"token comment\">// 下面将我们特殊关注的分发函数重新赋值为我们自己的处理函数</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>    DriverObject<span class=\"token operator\">-></span>MajorFunction<span class=\"token punctuation\">[</span>IRP_MJ_POWER<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> DPDispatchPower<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    DriverObject<span class=\"token operator\">-></span>MajorFunction<span class=\"token punctuation\">[</span>IRP_MJ_PNP<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> DPDispatchPnp<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>    DriverObject<span class=\"token operator\">-></span>MajorFunction<span class=\"token punctuation\">[</span>IRP_MJ_DEVICE_CONTROL<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> DPDispatchDeviceControl<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>    DriverObject<span class=\"token operator\">-></span>MajorFunction<span class=\"token punctuation\">[</span>IRP_MJ_READ<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> DPDispatchReadWrite<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>    DriverObject<span class=\"token operator\">-></span>MajorFunction<span class=\"token punctuation\">[</span>IRP_MJ_WRITE<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> DPDispatchReadWrite<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>\t<span class=\"token comment\">// 将这个驱动的 AddDevice 函数初始化为 DpAddDevice 函数</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>    DriverObject<span class=\"token operator\">-></span>DriverExtension<span class=\"token operator\">-></span>AddDevice <span class=\"token operator\">=</span> DPAddDevice<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>\t<span class=\"token comment\">// 将这个驱动的 unload 函数初始化为 DpUnload 函数</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>    DriverObject<span class=\"token operator\">-></span>DriverUnload <span class=\"token operator\">=</span> DPUnload<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>    </pre></td></tr><tr><td data-num=\"29\"></td><td><pre>\t<span class=\"token comment\">// 注册一个 boot 驱动结束回调，这个回调函数会在所有的 boot 型驱动都运行完毕之后再去执行</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>\t<span class=\"token function\">IoRegisterBootDriverReinitialization</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>\t\tDriverObject<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>\t\tDPReinitializationRoutine<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>\t\t<span class=\"token constant\">NULL</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>\t\t<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>\t<span class=\"token comment\">// 作为一个过滤驱动，无论如何都要返回成功</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>    <span class=\"token keyword\">return</span> STATUS_SUCCESS<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h3 id=\"adddevice函数\"><a class=\"anchor\" href=\"#adddevice函数\">#</a> AddDevice 函数</h3>\n<p>前面已经说过  <code>AddDevice</code>  函数的调用时机。并且在过滤驱动的 DriverEntry 函数中将驱动对象的 AddDevice 函数赋值成自己实现的  <code>DPAddDevice</code>  函数，这样在有任何磁盘卷设备建立时， <code>DPAddDevice</code>  函数都会被调用。</p>\n<p>但是需要特别注意的是， <code>DPAddDevice</code>  被调用时，实际上磁盘卷设备已经建立起来了，只是还不能被使用，也就是说，这个设备的设备对象有了，但是不能响应大部分的 IRP 请求。</p>\n<p>在  <code>DPAddDevice</code>  中将建立一个过滤设备，这个设备将被绑定在真正的磁盘卷设备上。<br />\n<em>并且由于这是一个上层过滤驱动，这个过滤设备将会位于磁盘卷设备的栈顶方向上，也就是先于磁盘卷设备收到 IRP 请求。</em><br />\n在建立并绑定了这个过滤设备之后，需要对这个过滤设备做一些初始化，而过滤设备的所有基本信息都会以  <code>DP_FILTER_DEV_EXTENSION</code>  结构的类型存储在设备扩展中。</p>\n<p>在这里先对 <code>DP_FILTER_DEV_EXTENSION</code>  数据结构中的成员变量进行简单的介绍，这些变量的具体作用和使用方法将会在下面讲解程序时提到</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">// 用来存储一个卷所有的相关信息的数据结构，放在过滤设备的设备扩展中</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">typedef</span> <span class=\"token keyword\">struct</span> <span class=\"token class-name\">_DP_FILTER_DEV_EXTENSION_</span> </pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>\t<span class=\"token comment\">// 卷的名字，例如 \"C:,D:\" 等中的字母部分</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>\tWCHAR\t\t\t\t\tVolumeLetter<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>\t<span class=\"token comment\">// 这个卷是否在保护状态</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>\tBOOL\t\t\t\t\tProtect<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>\t<span class=\"token comment\">// 这个卷的总大小，以 byte 为单位</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\tLARGE_INTEGER\t\t\tTotalSizeInByte<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\t<span class=\"token comment\">// 这个卷上文件系统的每簇大小，以 byte 为单位</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>\tDWORD\t\t\t\t\tClusterSizeInByte<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>\t<span class=\"token comment\">// 这个卷的每个扇区大小，以 byte 为单位</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>\tDWORD\t\t\t\t\tSectorSizeInByte<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>\t<span class=\"token comment\">// 这个卷设备对应的过滤设备的设备对象</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>\tPDEVICE_OBJECT\t\t\tFltDevObj<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>\t<span class=\"token comment\">// 这个卷设备对应的过滤设备的下层设备对象</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>\tPDEVICE_OBJECT\t\t\tLowerDevObj<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>\t<span class=\"token comment\">// 这个卷设备对应的物理设备的设备对象</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>\tPDEVICE_OBJECT\t\t\tPhyDevObj<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>\t<span class=\"token comment\">// 这个数据结构是否已经被初始化完毕了</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>\tBOOL\t\t\t\t\tInitializeCompleted<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>\t<span class=\"token comment\">// 这个卷上的保护系统使用的位图的句柄</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>\tPDP_BITMAP\t\tBitmap<span class=\"token punctuation\">;</span>\t</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>\t<span class=\"token comment\">// 用来转储的文件句柄</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>\tHANDLE\t\t\t\t\tTempFile<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>\t<span class=\"token comment\">// 这个卷上的保护系统使用的请求队列</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>\tLIST_ENTRY\t\t\t\tReqList<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>\t<span class=\"token comment\">// 这个卷上的保护系统使用的请求队列的锁</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>\tKSPIN_LOCK\t\t\t\tReqLock<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>\t<span class=\"token comment\">// 这个卷上的保护系统使用的请求队列的同步事件</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>\tKEVENT\t\t\t\t\tReqEvent<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>\t<span class=\"token comment\">// 这个卷上的保护系统使用的请求队列的处理线程之线程句柄</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>\tPVOID\t\t\t\t\tThreadHandle<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>\t<span class=\"token comment\">// 这个卷上的保护系统使用的请求队列的处理线程之结束标志</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>\tBOOLEAN\t\t\t\t\tThreadTermFlag<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>\t<span class=\"token comment\">// 这个卷上的保护系统的关机分页电源请求的计数事件</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>\tKEVENT\t\t\t\t\tPagingPathCountEvent<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>\t<span class=\"token comment\">// 这个卷上的保护系统的关机分页电源请求的计数</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>\tLONG\t\t\t\t\tPagingPathCount<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre><span class=\"token punctuation\">&#125;</span> DP_FILTER_DEV_EXTENSION<span class=\"token punctuation\">,</span> <span class=\"token operator\">*</span>PDP_FILTER_DEV_EXTENSION<span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>在上面的数据结构中可以看到有三个设备对象：过滤设备、物理设备和下层设备，其中过滤设备是本过滤驱动自己建立的；物理设备是通过 <code>AddDevice</code>  函数的参数传递进来的设备，是真正的磁盘卷设备；而下层设备是在将过滤设备绑定到物理设备上之后，返回的绑定之前物理设备栈上最顶部的设备。</p>\n<p><em>那么下层设备和物理设备是一样的吗？答：系统中的一个类驱动并不一定只有一个上层过滤驱动存在</em>。</p>\n<p>例如，在  <code>\\HKEY_LOCAL_MACHINE\\SYSTEM\\CurrentControlSet\\Control\\Class</code>  下的磁盘卷类中，系统自带了一个上层过滤驱动叫作 <code>VolSnap</code> ，如果将本章的驱动名字写在上层驱动列表中的 <code>VolSnap</code>  后面，那么在驱动的 <code>AddDevice</code>  调用时， <code>VolSnap</code>  的设备已经绑定在了磁盘卷设备上，也就是说，这时再去做绑定，返回的下层设备将会是 <code>VolSnap</code>  的设备。</p>\n<p><strong>在通常情况下，过滤设备的设备属性，例如 Flag 值等都需要和它的下层设备一样，当然过滤设备也可以加入自己特有的一些属性值</strong>。</p>\n<p><em>一般来说，下层设备是过滤驱动在需要调用正常的 IRP 请求处理流程时使用的目标设备。</em><br />\n在过滤驱动中如果将 IRP 请求发给下层设备，这个 IRP 受到的处理就如同过滤驱动不存在一样。</p>\n<p><em>在 <code>DP_FILTER_DEV_EXTENSION</code>  数据结构中可以看到，针对每个过滤设备都会建立一个处理线程和相应的请求队列，这是因为在这个驱动中同样采用了将所有请求依次排队，然后使用一个单独的线程依次处理的方式</em>。这么做的好处在于将所有的读 / 写请求串行化，程序易于编写而且<strong>不会出现读 / 写请求之间的同步问题</strong>。</p>\n<p>在  <code>DPAddDevice</code>  函数中读者还会发现初始化了  <code>PagingPathCountEvent</code>  和  <code>PagingPathCount</code>  这两个与分页路径相关的变量，它们将会在 PnP IRP 请求的处理中被用到，这里暂时只需要知道它们的初始化值是多少即可。</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>NTSTATUS</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token function\">DPAddDevice</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    IN\tPDRIVER_OBJECT\tDriverObject<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    IN\tPDEVICE_OBJECT\tPhysicalDeviceObject</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>\t<span class=\"token comment\">//NTSTATUS 类型的函数返回值</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>\tNTSTATUS\t\t\t\t\tntStatus <span class=\"token operator\">=</span> STATUS_SUCCESS<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token comment\">// 用来指向过滤设备的设备扩展的指针</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\tPDP_FILTER_DEV_EXTENSION\tDevExt <span class=\"token operator\">=</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>\t<span class=\"token comment\">// 过滤设备的下层设备的指针对象</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>\tPDEVICE_OBJECT\t\t\t\tLowerDevObj <span class=\"token operator\">=</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>\t<span class=\"token comment\">// 过滤设备的设备指针的指针对象</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>\tPDEVICE_OBJECT\t\t\t\tFltDevObj <span class=\"token operator\">=</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>\t<span class=\"token comment\">// 过滤设备的处理线程的线程句柄</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>\tHANDLE\t\t\t\t\t\tThreadHandle <span class=\"token operator\">=</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>\t<span class=\"token comment\">// 建立一个过滤设备，这个设备是 FILE_DEVICE_DISK 类型的设备并且具有 DP_FILTER_DEV_EXTENSION 类型的设备扩展</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>\tntStatus <span class=\"token operator\">=</span> <span class=\"token function\">IoCreateDevice</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>\t\tDriverObject<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>\t\t<span class=\"token keyword\">sizeof</span><span class=\"token punctuation\">(</span>DP_FILTER_DEV_EXTENSION<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>\t\t<span class=\"token constant\">NULL</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>\t\tFILE_DEVICE_DISK<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>\t\tFILE_DEVICE_SECURE_OPEN<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>\t\tFALSE<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>\t\t<span class=\"token operator\">&amp;</span>FltDevObj<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token function\">NT_SUCCESS</span><span class=\"token punctuation\">(</span>ntStatus<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> </pre></td></tr><tr><td data-num=\"28\"></td><td><pre>\t\t<span class=\"token keyword\">goto</span> ERROUT<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>\t<span class=\"token comment\">// 将 DevExt 指向过滤设备的设备扩展指针</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>\tDevExt <span class=\"token operator\">=</span> FltDevObj<span class=\"token operator\">-></span>DeviceExtension<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>\t<span class=\"token comment\">// 清空过滤设备的设备扩展</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>\t<span class=\"token function\">RtlZeroMemory</span><span class=\"token punctuation\">(</span>DevExt<span class=\"token punctuation\">,</span><span class=\"token keyword\">sizeof</span><span class=\"token punctuation\">(</span>DP_FILTER_DEV_EXTENSION<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>\t<span class=\"token comment\">// 将刚刚建立的过滤设备附加到这个卷设备的物理设备上</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>\tLowerDevObj <span class=\"token operator\">=</span> <span class=\"token function\">IoAttachDeviceToDeviceStack</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>\t\tFltDevObj<span class=\"token punctuation\">,</span> </pre></td></tr><tr><td data-num=\"37\"></td><td><pre>\t\tPhysicalDeviceObject<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token constant\">NULL</span> <span class=\"token operator\">==</span> LowerDevObj<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>\t\tntStatus <span class=\"token operator\">=</span> STATUS_NO_SUCH_DEVICE<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>\t\t<span class=\"token keyword\">goto</span> ERROUT<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>\t<span class=\"token comment\">// 初始化这个卷设备的分页路径计数的计数事件</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>\t<span class=\"token function\">KeInitializeEvent</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>\t\t<span class=\"token operator\">&amp;</span>DevExt<span class=\"token operator\">-></span>PagingPathCountEvent<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>\t\tNotificationEvent<span class=\"token punctuation\">,</span> </pre></td></tr><tr><td data-num=\"48\"></td><td><pre>\t\tTRUE<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>\t<span class=\"token comment\">// 对过滤设备的设备属性进行初始化，过滤设备的设备属性应该和它的下层设备相同</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>\tFltDevObj<span class=\"token operator\">-></span>Flags <span class=\"token operator\">=</span> LowerDevObj<span class=\"token operator\">-></span>Flags<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre>\t<span class=\"token comment\">// 给过滤设备的设备属性加上电源可分页的属性</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>\tFltDevObj<span class=\"token operator\">-></span>Flags <span class=\"token operator\">|=</span> DO_POWER_PAGABLE<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre>\t<span class=\"token comment\">// 对过滤设备进行设备初始化</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre>\tFltDevObj<span class=\"token operator\">-></span>Flags <span class=\"token operator\">&amp;=</span> <span class=\"token operator\">~</span>DO_DEVICE_INITIALIZING<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre></pre></td></tr><tr><td data-num=\"57\"></td><td><pre>\t<span class=\"token comment\">// 将过滤设备对应的设备扩展中的相应变量进行初始化</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre>\t<span class=\"token comment\">// 卷设备的过滤设备对象</span></pre></td></tr><tr><td data-num=\"59\"></td><td><pre>\tDevExt<span class=\"token operator\">-></span>FltDevObj <span class=\"token operator\">=</span> FltDevObj<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre>\t<span class=\"token comment\">// 卷设备的物理设备对象</span></pre></td></tr><tr><td data-num=\"61\"></td><td><pre>\tDevExt<span class=\"token operator\">-></span>PhyDevObj <span class=\"token operator\">=</span> PhysicalDeviceObject<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"62\"></td><td><pre>\t<span class=\"token comment\">// 卷设备的下层设备对象</span></pre></td></tr><tr><td data-num=\"63\"></td><td><pre>\tDevExt<span class=\"token operator\">-></span>LowerDevObj <span class=\"token operator\">=</span> LowerDevObj<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"64\"></td><td><pre></pre></td></tr><tr><td data-num=\"65\"></td><td><pre>\t<span class=\"token comment\">// 初始化这个卷的请求处理队列</span></pre></td></tr><tr><td data-num=\"66\"></td><td><pre>\t<span class=\"token function\">InitializeListHead</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>DevExt<span class=\"token operator\">-></span>ReqList<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"67\"></td><td><pre>\t<span class=\"token comment\">// 初始化请求处理队列的锁</span></pre></td></tr><tr><td data-num=\"68\"></td><td><pre>\t<span class=\"token function\">KeInitializeSpinLock</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>DevExt<span class=\"token operator\">-></span>ReqLock<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"69\"></td><td><pre>\t<span class=\"token comment\">// 初始化请求处理队列的同步事件</span></pre></td></tr><tr><td data-num=\"70\"></td><td><pre>\t<span class=\"token function\">KeInitializeEvent</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"71\"></td><td><pre>\t\t<span class=\"token operator\">&amp;</span>DevExt<span class=\"token operator\">-></span>ReqEvent<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"72\"></td><td><pre>\t\tSynchronizationEvent<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"73\"></td><td><pre>\t\tFALSE</pre></td></tr><tr><td data-num=\"74\"></td><td><pre>\t\t<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"75\"></td><td><pre></pre></td></tr><tr><td data-num=\"76\"></td><td><pre>\t<span class=\"token comment\">// 初始化终止处理线程标志</span></pre></td></tr><tr><td data-num=\"77\"></td><td><pre>\tDevExt<span class=\"token operator\">-></span>ThreadTermFlag <span class=\"token operator\">=</span> FALSE<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"78\"></td><td><pre>\t<span class=\"token comment\">// 建立用来处理这个卷的请求的处理线程，线程函数的参数则是设备扩展</span></pre></td></tr><tr><td data-num=\"79\"></td><td><pre>\tntStatus <span class=\"token operator\">=</span> <span class=\"token function\">PsCreateSystemThread</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"80\"></td><td><pre>\t\t<span class=\"token operator\">&amp;</span>ThreadHandle<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"81\"></td><td><pre>\t\t<span class=\"token punctuation\">(</span>ACCESS_MASK<span class=\"token punctuation\">)</span><span class=\"token number\">0L</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"82\"></td><td><pre>\t\t<span class=\"token constant\">NULL</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"83\"></td><td><pre>\t\t<span class=\"token constant\">NULL</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"84\"></td><td><pre>\t\t<span class=\"token constant\">NULL</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"85\"></td><td><pre>\t\tDPReadWriteThread<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"86\"></td><td><pre>\t\tDevExt</pre></td></tr><tr><td data-num=\"87\"></td><td><pre>\t\t<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"88\"></td><td><pre>\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token function\">NT_SUCCESS</span><span class=\"token punctuation\">(</span>ntStatus<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"89\"></td><td><pre>\t\t<span class=\"token keyword\">goto</span> ERROUT<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"90\"></td><td><pre></pre></td></tr><tr><td data-num=\"91\"></td><td><pre>\t<span class=\"token comment\">// 获取处理线程的对象</span></pre></td></tr><tr><td data-num=\"92\"></td><td><pre>\tntStatus <span class=\"token operator\">=</span> <span class=\"token function\">ObReferenceObjectByHandle</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"93\"></td><td><pre>\t\tThreadHandle<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"94\"></td><td><pre>\t\tTHREAD_ALL_ACCESS<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"95\"></td><td><pre>\t\t<span class=\"token constant\">NULL</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"96\"></td><td><pre>\t\tKernelMode<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"97\"></td><td><pre>\t\t<span class=\"token operator\">&amp;</span>DevExt<span class=\"token operator\">-></span>ThreadHandle<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"98\"></td><td><pre>\t\t<span class=\"token constant\">NULL</span></pre></td></tr><tr><td data-num=\"99\"></td><td><pre>\t\t<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"100\"></td><td><pre>\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token function\">NT_SUCCESS</span><span class=\"token punctuation\">(</span>ntStatus<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"101\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"102\"></td><td><pre>\t\tDevExt<span class=\"token operator\">-></span>ThreadTermFlag <span class=\"token operator\">=</span> TRUE<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"103\"></td><td><pre>\t\t<span class=\"token function\">KeSetEvent</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"104\"></td><td><pre>\t\t\t<span class=\"token operator\">&amp;</span>DevExt<span class=\"token operator\">-></span>ReqEvent<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"105\"></td><td><pre>\t\t\t<span class=\"token punctuation\">(</span>KPRIORITY<span class=\"token punctuation\">)</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"106\"></td><td><pre>\t\t\tFALSE</pre></td></tr><tr><td data-num=\"107\"></td><td><pre>\t\t\t<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"108\"></td><td><pre>\t\t<span class=\"token keyword\">goto</span> ERROUT<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"109\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"110\"></td><td><pre></pre></td></tr><tr><td data-num=\"111\"></td><td><pre>ERROUT<span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"112\"></td><td><pre>\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token function\">NT_SUCCESS</span><span class=\"token punctuation\">(</span>ntStatus<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"113\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span>\t</pre></td></tr><tr><td data-num=\"114\"></td><td><pre>\t\t<span class=\"token comment\">// 如果上面有不成功的地方，首先需要解除可能存在的附加</span></pre></td></tr><tr><td data-num=\"115\"></td><td><pre>\t\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token constant\">NULL</span> <span class=\"token operator\">!=</span> LowerDevObj<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"116\"></td><td><pre>\t\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"117\"></td><td><pre>\t\t\t<span class=\"token function\">IoDetachDevice</span><span class=\"token punctuation\">(</span>LowerDevObj<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"118\"></td><td><pre>\t\t\tDevExt<span class=\"token operator\">-></span>LowerDevObj <span class=\"token operator\">=</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"119\"></td><td><pre>\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"120\"></td><td><pre>\t\t<span class=\"token comment\">// 然后删除可能建立的过滤设备</span></pre></td></tr><tr><td data-num=\"121\"></td><td><pre>\t\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token constant\">NULL</span> <span class=\"token operator\">!=</span> FltDevObj<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"122\"></td><td><pre>\t\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"123\"></td><td><pre>\t\t\t<span class=\"token function\">IoDeleteDevice</span><span class=\"token punctuation\">(</span>FltDevObj<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"124\"></td><td><pre>\t\t\tDevExt<span class=\"token operator\">-></span>FltDevObj <span class=\"token operator\">=</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"125\"></td><td><pre>\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"126\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"127\"></td><td><pre>\t<span class=\"token comment\">// 关闭线程句柄，我们今后不会用到它，所有对线程的引用都通过线程对象来进行了</span></pre></td></tr><tr><td data-num=\"128\"></td><td><pre>\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token constant\">NULL</span> <span class=\"token operator\">!=</span> ThreadHandle<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"129\"></td><td><pre>\t\t<span class=\"token function\">ZwClose</span><span class=\"token punctuation\">(</span>ThreadHandle<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"130\"></td><td><pre>\t<span class=\"token comment\">// 返回状态值</span></pre></td></tr><tr><td data-num=\"131\"></td><td><pre>    <span class=\"token keyword\">return</span> ntStatus<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"132\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h3 id=\"pnp即插即用请求的处理\"><a class=\"anchor\" href=\"#pnp即插即用请求的处理\">#</a> PnP（即插即用）请求的处理</h3>\n<p>作为一个卷过滤驱动 PnP 请求是非常重要的，这是因为 Windows 操作系统在某些时刻会向存储设备发出专门的请求，如果没有进行正确的处理，将会造成系统无法正常关机等一系列问题。</p>\n<p>在收到了 PnP 请求之后，由于在 <code>DriverEntry</code>  中对 PnP 请求的处理函数特别设置成了 <code>DPDispatchPnp</code>  函数，所以 <code>DPDispatchPnp</code>  函数将会被调用。</p>\n<p>它具有两个参数： <code>DeviceObject</code>  和 <code>irp</code> ，分别说明了<em>这个请求发往的设备</em>和<em>这个请求的具体细节</em>。</p>\n<p>由于这是过滤驱动的 PnP 分发函数，所以也只有过滤驱动所建立的设备收到 PnP 请求时才会调用这个函数，那么很容易想到这个 <code>DeviceObject</code>  一定是<strong>过滤设备</strong>。</p>\n<p>在 <code>AddDevice</code>  函数中，<strong>每个卷的过滤设备都会被建立相应的设备扩展，里面存储有很多这个过滤设备的属性信息</strong>，所以在函数的一开始就需要将这些信息拿出来，同时需要通过 <code>irp</code>  参数中的  <code>irp stack</code>  成员来<strong>进一步确定这个 IRP 请求的具体目的</strong>。类似的操作在之后的各种不同请求的处理函数中都会见到，代码如下：</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">// 用来指向过滤设备的设备扩展的指针</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>PDP_FILTER_DEV_EXTENSION\tDevExt <span class=\"token operator\">=</span> DeviceObject<span class=\"token operator\">-></span>DeviceExtension<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\">// 返回值</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>NTSTATUS ntStatus <span class=\"token operator\">=</span> STATUS_SUCCESS<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token comment\">// 用来指向 irp stack 的指针</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>PIO_STACK_LOCATION  irpsp <span class=\"token operator\">=</span> <span class=\"token function\">IoGetCurrentIrpStackLocation</span><span class=\"token punctuation\">(</span>Irp<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p><em>在获取到了这些参数之后，可以直接通过判断 irp stack 中的 MinorFunction 来判断这个 IRP 请求的具体目的</em>。<br />\n<em>在 irp stack 中，通常会存在 MajorFunction 和 MinorFunction 两个请求号，其中 MajorFunction 是大请求号，一般是类似于 Write、Read、PnP、DeviceIoControl 等大分类的请求</em>；<br />\n<em>而 MinorFunction 是小请求号，一般是在某一个大分类中的子请求号。我们知道在这个分发函数中 MajorFunction 肯定是 PnP 请求，而 MinorFunction 才是在这个函数中需要关心的</em>。</p>\n<p>这里有两个 PnP 请求需要我们来处理，对于其他的 PnP 请求，直接交给下层设备去处理就可以了。</p>\n<h4 id=\"设备移除请求\"><a class=\"anchor\" href=\"#设备移除请求\">#</a> 设备移除请求</h4>\n<p>第一个需要处理的 PnP 子请求是<strong>设备移除请求</strong>，这个请求会在 Windows 进行设备热插拔、均衡或者关机时被发送到磁盘卷设备。</p>\n<p>当然，过滤驱动会先于磁盘卷设备收到这个请求，在这个请求发送时，所有的磁盘卷设备的读 / 写请求应该都已经完成，所以在过滤驱动收到这个请求时，<strong>只需要简单地将曾经建立过的所有设备和初始化过的所有内部数据结构全部销毁即可</strong>。</p>\n<p><em>建立过的设备主要是在 <code>AddDevice</code>  函数中建立的过滤设备和由绑定而生成的下层设备，内部数据结构主要包括了下面将要了解的 <code>bitmap</code>  数据结构。此外，在 <code>AddDevice</code>  函数中为卷设备建立的请求处理线程也需要停掉</em>。</p>\n<h4 id=\"设备使用通告请求\"><a class=\"anchor\" href=\"#设备使用通告请求\">#</a> 设备使用通告请求</h4>\n<p>第二个需要处理的请求是设备使用通告请求，Windows 操作系统会在建立或者删除特殊文件的时候向存储设备发出这个 IRP 请求，作为存储设备卷过滤设备自然也会收到这个请求。</p>\n<p>这里说的特殊文件包括页面文件、休眠文件和 dump 文件。</p>\n<ul>\n<li>\n<p><strong>页面文件</strong>：页文件 (也称为 “分页文件”) 是硬盘上的可选隐藏系统文件。也就是虚拟内存 RAM 的物理扩展，页面文件使系统能够从物理内存中删除不常访问的修改页，使系统能够更高效地使用物理内存来更频繁地访问页面。</p>\n</li>\n<li>\n<p><strong>休眠文件</strong>：是系统保存着内存数据的备份文件，随时进行更新。这个文件无法复制，删除，修改或移动。只有当在电源管理中对系统启用了休眠功能后，才会产生这个文件。通过使用这个休眠文件来时刻将内存中的所有信息保存起来。停用休眠选项后系统会自己把它删除。如果还没启动休眠在 c 盘根目录就已经有了同名文件，会导致休眠无法启动。“休眠” 将保存一份桌面及所有打开文件和文档的映像，然后关闭计算机电源，监视器和硬盘也会同时关闭，内存中的内容都会以备份文件的形式保存在磁盘上。打开电源时，文件和文档就会按原来离开时的样子在桌面上打开。</p>\n</li>\n<li>\n<p><strong>dump 文件</strong>：是进程的内存镜像。</p>\n</li>\n</ul>\n<p>Windows 会通过 <code>irp stack</code>  中的 <code>Parameters.UsageNotification.Type</code>  域来说明<strong>请求的是哪种文件</strong>，并且会使用 <code>Parameters.UsageNotification.InPath</code>  域来说明<strong>这个请求是在询问设备是否可以建立这个文件，还是在删除了这个文件之后对这个设备的通知</strong>。</p>\n<p>在处理这个请求时，过滤驱动比较关心的是对页面文件的处理，因为这牵扯到过滤设备标志位中的 <code>DO_POWER_PAGABLE</code>  位。关于这个位，简单来说，就是如果有页面文件在这个卷上，那么就应该清除  <code>DO_POWER_PAGABLE</code> ；反之，就应该加上  <code>DO_POWER_PAGABLE</code> 。</p>\n<p>这个请求的根本目的是，<strong>Windows 操作系统用来查询设备是否可以在其上建立特殊文件</strong>，作为过滤驱动是不应该对这种询问加以回答的，正确的做法是将这个请求发送给下层设备，由下层设备来回答这个问题。但是同时过滤驱动需要监视下层设备的回答，如果下层设备不支持这个请求，自然是最简单不过的事情，过滤设备什么都不做就可以了；反之，如果下层设备支持这个请求，那么过滤设备就需要进行处理，在下层设备对第一个页面文件建立请求回答是之后，过滤设备需要对  <code>DO_POWER_PAGABLE</code>  位进行相应的设置，并且做一个计数。这个计数会随着页面文件建立的请求而增加，随着页面文件删除通知而减少，当减少到最后一个计数时，过滤设备又需要对  <code>DO_POWER_PAGABLE</code>  位进行相应的设置。</p>\n<h4 id=\"完整的pnp请求处理代码\"><a class=\"anchor\" href=\"#完整的pnp请求处理代码\">#</a> 完整的 PnP 请求处理代码</h4>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>NTSTATUS\t</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token function\">DPDispatchPnp</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>\tIN\tPDEVICE_OBJECT\tDeviceObject<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>\tIN\tPIRP\t\t\tIrp</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>\t<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>\t<span class=\"token comment\">// 用来指向过滤设备的设备扩展的指针</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>\tPDP_FILTER_DEV_EXTENSION\tDevExt <span class=\"token operator\">=</span> DeviceObject<span class=\"token operator\">-></span>DeviceExtension<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\t<span class=\"token comment\">// 返回值</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\tNTSTATUS ntStatus <span class=\"token operator\">=</span> STATUS_SUCCESS<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>\t<span class=\"token comment\">// 用来指向 irp stack 的指针</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>\tPIO_STACK_LOCATION  irpsp <span class=\"token operator\">=</span> <span class=\"token function\">IoGetCurrentIrpStackLocation</span><span class=\"token punctuation\">(</span>Irp<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>\t<span class=\"token keyword\">switch</span><span class=\"token punctuation\">(</span>irpsp<span class=\"token operator\">-></span>MinorFunction<span class=\"token punctuation\">)</span> </pre></td></tr><tr><td data-num=\"15\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>\t<span class=\"token keyword\">case</span> IRP_MN_REMOVE_DEVICE<span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>\t\t<span class=\"token comment\">// 如果是 PnP manager 发过来的移除设备的 irp，将进入这里</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>\t\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>\t\t\t<span class=\"token comment\">// 这里主要做一些清理工作</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>\t\t\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>DevExt<span class=\"token operator\">-></span>ThreadTermFlag <span class=\"token operator\">!=</span> TRUE <span class=\"token operator\">&amp;&amp;</span> <span class=\"token constant\">NULL</span> <span class=\"token operator\">!=</span> DevExt<span class=\"token operator\">-></span>ThreadHandle<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>\t\t\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>\t\t\t\t<span class=\"token comment\">// 如果线程还在运行的话需要停止它，这里通过设置线程停止运行的标志并且发送事件信息，让线程自己终止运行</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>\t\t\t\tDevExt<span class=\"token operator\">-></span>ThreadTermFlag <span class=\"token operator\">=</span> TRUE<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>\t\t\t\t<span class=\"token function\">KeSetEvent</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>\t\t\t\t\t<span class=\"token operator\">&amp;</span>DevExt<span class=\"token operator\">-></span>ReqEvent<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>\t\t\t\t\t<span class=\"token punctuation\">(</span>KPRIORITY<span class=\"token punctuation\">)</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>\t\t\t\t\tFALSE</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>\t\t\t\t\t<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>\t\t\t\t<span class=\"token comment\">// 等待线程结束</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>\t\t\t\t<span class=\"token function\">KeWaitForSingleObject</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>\t\t\t\t\tDevExt<span class=\"token operator\">-></span>ThreadHandle<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>\t\t\t\t\tExecutive<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>\t\t\t\t\tKernelMode<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>\t\t\t\t\tFALSE<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>\t\t\t\t\t<span class=\"token constant\">NULL</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>\t\t\t\t\t<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>\t\t\t\t<span class=\"token comment\">// 解除引用线程对象</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>\t\t\t\t<span class=\"token function\">ObDereferenceObject</span><span class=\"token punctuation\">(</span>DevExt<span class=\"token operator\">-></span>ThreadHandle<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>\t\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>\t \t\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token constant\">NULL</span> <span class=\"token operator\">!=</span> DevExt<span class=\"token operator\">-></span>Bitmap<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>\t \t\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>\t\t\t\t<span class=\"token comment\">// 如果还有位图，就释放</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>\t \t\t\t<span class=\"token function\">DPBitmapFree</span><span class=\"token punctuation\">(</span>DevExt<span class=\"token operator\">-></span>Bitmap<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>\t \t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>\t\t\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token constant\">NULL</span> <span class=\"token operator\">!=</span> DevExt<span class=\"token operator\">-></span>LowerDevObj<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>\t\t\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>\t\t\t\t<span class=\"token comment\">// 如果存在着下层设备，就先去掉挂接</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>\t\t\t\t<span class=\"token function\">IoDetachDevice</span><span class=\"token punctuation\">(</span>DevExt<span class=\"token operator\">-></span>LowerDevObj<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>\t\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>\t \t\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token constant\">NULL</span> <span class=\"token operator\">!=</span> DevExt<span class=\"token operator\">-></span>FltDevObj<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>\t \t\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre>\t\t\t\t<span class=\"token comment\">// 如果存在过滤设备，就要删除它</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>\t \t\t\t<span class=\"token function\">IoDeleteDevice</span><span class=\"token punctuation\">(</span>DevExt<span class=\"token operator\">-></span>FltDevObj<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre>\t \t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre>\t\t\t<span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre>\t<span class=\"token comment\">// 这个是 PnP 管理器用来询问设备能否支持特殊文件的 irp，作为卷的过滤驱动，我们必须处理</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre>\t<span class=\"token keyword\">case</span> IRP_MN_DEVICE_USAGE_NOTIFICATION<span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"59\"></td><td><pre>\t\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre>\t\t\tBOOLEAN setPagable<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"61\"></td><td><pre>\t\t\t<span class=\"token comment\">// 如果是询问是否支持休眠文件和 dump 文件，则直接下发给下层设备去处理</span></pre></td></tr><tr><td data-num=\"62\"></td><td><pre>\t\t\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>irpsp<span class=\"token operator\">-></span>Parameters<span class=\"token punctuation\">.</span>UsageNotification<span class=\"token punctuation\">.</span>Type <span class=\"token operator\">!=</span> DeviceUsageTypePaging<span class=\"token punctuation\">)</span> </pre></td></tr><tr><td data-num=\"63\"></td><td><pre>\t\t\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"64\"></td><td><pre>\t\t\t\tntStatus <span class=\"token operator\">=</span> <span class=\"token function\">DPSendToNextDriver</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"65\"></td><td><pre>\t\t\t\t\tDevExt<span class=\"token operator\">-></span>LowerDevObj<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"66\"></td><td><pre>\t\t\t\t\tIrp<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"67\"></td><td><pre>\t\t\t\t<span class=\"token keyword\">return</span> ntStatus<span class=\"token punctuation\">;</span> </pre></td></tr><tr><td data-num=\"68\"></td><td><pre>\t\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"69\"></td><td><pre>\t\t\t<span class=\"token comment\">// 这里等一下分页计数事件</span></pre></td></tr><tr><td data-num=\"70\"></td><td><pre>\t\t\tntStatus <span class=\"token operator\">=</span> <span class=\"token function\">KeWaitForSingleObject</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"71\"></td><td><pre>\t\t\t\t<span class=\"token operator\">&amp;</span>DevExt<span class=\"token operator\">-></span>PagingPathCountEvent<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"72\"></td><td><pre>\t\t\t\tExecutive<span class=\"token punctuation\">,</span> </pre></td></tr><tr><td data-num=\"73\"></td><td><pre>\t\t\t\tKernelMode<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"74\"></td><td><pre>\t\t\t\tFALSE<span class=\"token punctuation\">,</span> </pre></td></tr><tr><td data-num=\"75\"></td><td><pre>\t\t\t\t<span class=\"token constant\">NULL</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"76\"></td><td><pre></pre></td></tr><tr><td data-num=\"77\"></td><td><pre>\t\t\t<span class=\"token comment\">//setPagable 初始化为假，是没有设置过 DO_POWER_PAGABLE 的意思</span></pre></td></tr><tr><td data-num=\"78\"></td><td><pre>\t\t\tsetPagable <span class=\"token operator\">=</span> FALSE<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"79\"></td><td><pre>\t\t\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>irpsp<span class=\"token operator\">-></span>Parameters<span class=\"token punctuation\">.</span>UsageNotification<span class=\"token punctuation\">.</span>InPath<span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;&amp;</span></pre></td></tr><tr><td data-num=\"80\"></td><td><pre>\t\t\t\t<span class=\"token punctuation\">(</span>DevExt<span class=\"token operator\">-></span>PagingPathCount <span class=\"token operator\">==</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> </pre></td></tr><tr><td data-num=\"81\"></td><td><pre>\t\t\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"82\"></td><td><pre>\t\t\t\t<span class=\"token comment\">// 如果是 PnP manager 通知我们将要删去分页文件，且我们目前只剩下最后一个分页文件的时候会进入这里</span></pre></td></tr><tr><td data-num=\"83\"></td><td><pre>\t\t\t\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>DeviceObject<span class=\"token operator\">-></span>Flags <span class=\"token operator\">&amp;</span> DO_POWER_INRUSH<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"84\"></td><td><pre>\t\t\t\t<span class=\"token punctuation\">&#123;</span><span class=\"token punctuation\">&#125;</span> </pre></td></tr><tr><td data-num=\"85\"></td><td><pre>\t\t\t\t<span class=\"token keyword\">else</span> </pre></td></tr><tr><td data-num=\"86\"></td><td><pre>\t\t\t\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"87\"></td><td><pre>\t\t\t\t\t<span class=\"token comment\">// 到这里说明没有分页文件在这个设备上了，需要设置 DO_POWER_PAGABLE 这一位了</span></pre></td></tr><tr><td data-num=\"88\"></td><td><pre>\t\t\t\t\tDeviceObject<span class=\"token operator\">-></span>Flags <span class=\"token operator\">|=</span> DO_POWER_PAGABLE<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"89\"></td><td><pre>\t\t\t\t\tsetPagable <span class=\"token operator\">=</span> TRUE<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"90\"></td><td><pre>\t\t\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"91\"></td><td><pre>\t\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"92\"></td><td><pre>\t\t\t<span class=\"token comment\">// 到这里肯定是关于分页文件的是否可建立查询，或者是删除的通知，我们交给下层设备去做。这里需要用同步的方式给下层设备，也就是说要等待下层设备的返回</span></pre></td></tr><tr><td data-num=\"93\"></td><td><pre>\t\t\tntStatus <span class=\"token operator\">=</span> <span class=\"token function\">DPForwardIrpSync</span><span class=\"token punctuation\">(</span>DevExt<span class=\"token operator\">-></span>LowerDevObj<span class=\"token punctuation\">,</span>Irp<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"94\"></td><td><pre></pre></td></tr><tr><td data-num=\"95\"></td><td><pre>\t\t\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">NT_SUCCESS</span><span class=\"token punctuation\">(</span>ntStatus<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> </pre></td></tr><tr><td data-num=\"96\"></td><td><pre>\t\t\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"97\"></td><td><pre>\t\t\t\t<span class=\"token comment\">// 如果发给下层设备的请求成功了，说明下层设备支持这个操作，会执行到这里</span></pre></td></tr><tr><td data-num=\"98\"></td><td><pre>\t\t\t\t<span class=\"token comment\">// 在成功的条件下我们来改变我们自己的计数值，这样就能记录我们现在这个设备上到底有多少个分页文件</span></pre></td></tr><tr><td data-num=\"99\"></td><td><pre>\t\t\t\t<span class=\"token function\">IoAdjustPagingPathCount</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"100\"></td><td><pre>\t\t\t\t\t<span class=\"token operator\">&amp;</span>DevExt<span class=\"token operator\">-></span>PagingPathCount<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"101\"></td><td><pre>\t\t\t\t\tirpsp<span class=\"token operator\">-></span>Parameters<span class=\"token punctuation\">.</span>UsageNotification<span class=\"token punctuation\">.</span>InPath<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"102\"></td><td><pre>\t\t\t\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>irpsp<span class=\"token operator\">-></span>Parameters<span class=\"token punctuation\">.</span>UsageNotification<span class=\"token punctuation\">.</span>InPath<span class=\"token punctuation\">)</span> </pre></td></tr><tr><td data-num=\"103\"></td><td><pre>\t\t\t\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"104\"></td><td><pre>\t\t\t\t\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>DevExt<span class=\"token operator\">-></span>PagingPathCount <span class=\"token operator\">==</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span> </pre></td></tr><tr><td data-num=\"105\"></td><td><pre>\t\t\t\t\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"106\"></td><td><pre>\t\t\t\t\t\t<span class=\"token comment\">// 如果这个请求是一个建立分页文件的查询请求，并且下层设备支持这个请求，而且这是第一个在这个设备上的分页文件，那么我们需要清除 DO_POWER_PAGABLE 位</span></pre></td></tr><tr><td data-num=\"107\"></td><td><pre>\t\t\t\t\t\tDeviceObject<span class=\"token operator\">-></span>Flags <span class=\"token operator\">&amp;=</span> <span class=\"token operator\">~</span>DO_POWER_PAGABLE<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"108\"></td><td><pre>\t\t\t\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"109\"></td><td><pre>\t\t\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"110\"></td><td><pre>\t\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"111\"></td><td><pre>\t\t\t<span class=\"token keyword\">else</span> </pre></td></tr><tr><td data-num=\"112\"></td><td><pre>\t\t\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"113\"></td><td><pre>\t\t\t\t<span class=\"token comment\">// 到这里说明给下层设备发请求失败了，下层设备不支持这个请求，这时候我们需要把之前做过的操作还原</span></pre></td></tr><tr><td data-num=\"114\"></td><td><pre>\t\t\t\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>setPagable <span class=\"token operator\">==</span> TRUE<span class=\"token punctuation\">)</span> </pre></td></tr><tr><td data-num=\"115\"></td><td><pre>\t\t\t\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"116\"></td><td><pre>\t\t\t\t\t<span class=\"token comment\">// 根据 setPagable 变量的值来判断我们之前是否做过对 DO_POWER_PAGABLE 的设置，如果有的话就清楚这个设置</span></pre></td></tr><tr><td data-num=\"117\"></td><td><pre>\t\t\t\t\tDeviceObject<span class=\"token operator\">-></span>Flags <span class=\"token operator\">&amp;=</span> <span class=\"token operator\">~</span>DO_POWER_PAGABLE<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"118\"></td><td><pre>\t\t\t\t\tsetPagable <span class=\"token operator\">=</span> FALSE<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"119\"></td><td><pre>\t\t\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"120\"></td><td><pre>\t\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"121\"></td><td><pre>\t\t\t<span class=\"token comment\">// 设置分页计数事件</span></pre></td></tr><tr><td data-num=\"122\"></td><td><pre>\t\t\t<span class=\"token function\">KeSetEvent</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"123\"></td><td><pre>\t\t\t\t<span class=\"token operator\">&amp;</span>DevExt<span class=\"token operator\">-></span>PagingPathCountEvent<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"124\"></td><td><pre>\t\t\t\tIO_NO_INCREMENT<span class=\"token punctuation\">,</span> </pre></td></tr><tr><td data-num=\"125\"></td><td><pre>\t\t\t\tFALSE</pre></td></tr><tr><td data-num=\"126\"></td><td><pre>\t\t\t\t<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"127\"></td><td><pre>\t\t\t<span class=\"token comment\">// 到这里我们就可以完成这个 irp 请求了</span></pre></td></tr><tr><td data-num=\"128\"></td><td><pre>\t\t\t<span class=\"token function\">IoCompleteRequest</span><span class=\"token punctuation\">(</span>Irp<span class=\"token punctuation\">,</span> IO_NO_INCREMENT<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"129\"></td><td><pre>\t\t\t<span class=\"token keyword\">return</span> ntStatus<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"130\"></td><td><pre>\t\t<span class=\"token punctuation\">&#125;</span>\t\t</pre></td></tr><tr><td data-num=\"131\"></td><td><pre>\t<span class=\"token keyword\">default</span><span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"132\"></td><td><pre>\t\t<span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"133\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"134\"></td><td><pre>\t<span class=\"token keyword\">return</span> <span class=\"token function\">DPSendToNextDriver</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"135\"></td><td><pre>\t\tDevExt<span class=\"token operator\">-></span>LowerDevObj<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"136\"></td><td><pre>\t\tIrp<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"137\"></td><td><pre></pre></td></tr><tr><td data-num=\"138\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h3 id=\"power请求的处理\"><a class=\"anchor\" href=\"#power请求的处理\">#</a> Power 请求的处理</h3>\n<p>Power 请求的处理本应和大部分 IRP 请求一样，直接交给下层设备处理即可。</p>\n<p>只是在 Windows Vista 以前的操作系统中，下发所使用的函数是比较特殊的  <code>PoCallDriver</code>  ，而且在这之前还需要使用 <code>PoStartNextPowerIrp</code>  来处理一下 IRP 请求。<br />\n这一情况在 Windows Vista 中得以改变，开发人员只需要使用一般的方法下发这个 IRP 请求即可。本驱动中使用了一个编译宏来判断当前的驱动是为 Windows Vista 使用的还是为 Windows XP 使用的，从而决定编译时使用的代码。</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>NTSTATUS</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token function\">DPDispatchPower</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    IN\tPDEVICE_OBJECT\tDeviceObject<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    IN\tPIRP\t\t\tIrp</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>\t<span class=\"token comment\">// 用来指向过滤设备的设备扩展的指针</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>\tPDP_FILTER_DEV_EXTENSION\tDevExt <span class=\"token operator\">=</span> DeviceObject<span class=\"token operator\">-></span>DeviceExtension<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">if</span> <span class=\"token expression\"><span class=\"token punctuation\">(</span>NTDDI_VERSION <span class=\"token operator\">&lt;</span> NTDDI_VISTA<span class=\"token punctuation\">)</span></span></span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\t<span class=\"token comment\">// 如果是 vista 以前的版本的 windows，需要使用特殊的向下层设备转发的函数</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>\t<span class=\"token function\">PoStartNextPowerIrp</span><span class=\"token punctuation\">(</span>Irp<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>\t<span class=\"token function\">IoSkipCurrentIrpStackLocation</span><span class=\"token punctuation\">(</span>Irp<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>\t<span class=\"token keyword\">return</span> <span class=\"token function\">PoCallDriver</span><span class=\"token punctuation\">(</span>DevExt<span class=\"token operator\">-></span>LowerDevObj<span class=\"token punctuation\">,</span> Irp<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">else</span></span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>\t<span class=\"token comment\">// 如果是 vista 系统，可以使用和一般下发 irp 一样的方法来下发</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>\t<span class=\"token keyword\">return</span> <span class=\"token function\">DPSendToNextDriver</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>\t\tDevExt<span class=\"token operator\">-></span>LowerDevObj<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>\t\tIrp<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">endif</span>  </span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h3 id=\"deviceiocontrol请求的处理\"><a class=\"anchor\" href=\"#deviceiocontrol请求的处理\">#</a> DeviceIoControl 请求的处理</h3>\n<p><code>DeviceIoControl</code>  请求的处理函数是  <code>DPDispatchDeviceControl</code>  ，作为一个磁盘卷设备的过滤驱动，理论上是不需要对  <code>DeviceIoControl</code>  做任何处理的，只需要如实地转发给下层设备去处理即可。但是在这里本驱动需要截获一个特殊的  <code>DeviceIoControl</code>  请求 —  <code>IOCTL_VOLUME_ONLINE</code> ，这个请求是由 Windows 操作系统发出的，<strong>它本身的作用是把目标卷设备设置为在线状态，在这个状态设置完成之后，才会有对这个卷的读 / 写等操作发生</strong>。</p>\n<p>对于这个以还原为目的的驱动来说，最好是尽量对读 / 写操作进行处理。基于这个理由， <code>IOCTL_VOLUME_ONLINE</code>  是一个很好的机会，所以在本驱动中，<strong>大部分的数据结构等初始化工作都将被放到这个 <code>DeviceIoControl</code>  时完成</strong>。</p>\n<p>这里我们可能会认为在收到  <code>IOCTL_VOLUME_ONLINE</code>  这个 <code>DeviceIoControl</code>  请求时直接做初始化工作即可，然后再将这个请求发往下层设备。这是不行的，原因如下：</p>\n<p>初始化工作需要目标卷的一些信息，例如需要知道这个卷的卷标，因为这个驱动只保护 “D” 盘；需要知道这个卷的一些信息（如卷的大小），因为初始化 <code>bitmap</code>  需要这个信息作为参数，但是这一切都必须要等过滤驱动的下层设备也就是真正的卷设备开始运行之后才能够提供，而卷设备开始运行却需要这个 <code>IOCTL_VOLUME_ONLINE</code>  的 <code>DeviceIoControl</code>  请求发下去…… 这样似乎陷入了一个先有鸡还是先有蛋的循环中，但实际上有一个很简单的办法可以解决这个问题，就是<strong>让请求先发下去，等下层设备处理完毕之后再进行初始化工作，同时由于下发请求时采用了同步的方式，因此在完成请求之前是不会有其他请求发生的</strong>。</p>\n<p>WDM 驱动框架为实现上文所述的操作提供了相当方便的操作方式，<em>只需要复制一份 <code>irp stack</code> ，设置好完成函数和一个等待事件，在调用下层设备之后就开始等待这个事件，当下层设备处理完成之后之前设置的完成函数会被调用，在完成函数中会唤醒刚才所说的等待事件，于是一切都会顺理成章地走下去，当然在完成函数里上文所述的初始化工作就可以进行了</em>。</p>\n<p>下面是如何设置完成函数和等待事件的代码，也就是在 DeviceIoControl 的分发函数中所做的事情。</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>NTSTATUS</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token function\">DPDispatchDeviceControl</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>\tIN\tPDEVICE_OBJECT\tDeviceObject<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>\tIN\tPIRP\t\t\tIrp</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>\t<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>\t<span class=\"token comment\">// 用来指向过滤设备的设备扩展的指针</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>\tPDP_FILTER_DEV_EXTENSION\tDevExt <span class=\"token operator\">=</span> DeviceObject<span class=\"token operator\">-></span>DeviceExtension<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\t<span class=\"token comment\">// 返回值</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\tNTSTATUS ntStatus <span class=\"token operator\">=</span> STATUS_SUCCESS<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>\t<span class=\"token comment\">// 用来指向 irp stack 的指针</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>\tPIO_STACK_LOCATION  irpsp <span class=\"token operator\">=</span> <span class=\"token function\">IoGetCurrentIrpStackLocation</span><span class=\"token punctuation\">(</span>Irp<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>\t<span class=\"token comment\">// 用来同步 IOCTL_VOLUME_ONLINE 处理的事件</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>\tKEVENT\t\t\t\t\tEvent<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>\t<span class=\"token comment\">// 用来传给 IOCTL_VOLUME_ONLINE 的完成函数的上下文</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>\tVOLUME_ONLINE_CONTEXT\tcontext<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>\t<span class=\"token keyword\">switch</span> <span class=\"token punctuation\">(</span>irpsp<span class=\"token operator\">-></span>Parameters<span class=\"token punctuation\">.</span>DeviceIoControl<span class=\"token punctuation\">.</span>IoControlCode<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>\t<span class=\"token keyword\">case</span> IOCTL_VOLUME_ONLINE<span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>\t\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>\t\t\t<span class=\"token comment\">// 如果是卷设备的 IOCTL_VOLUME_ONLINE，会进入到这里</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>\t\t\t<span class=\"token comment\">// 我们打算自己处理这个 irp 请求，这里先初始化一个事件用来在这个请求的完成函数里面做同步信号</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>\t\t\t<span class=\"token function\">KeInitializeEvent</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>Event<span class=\"token punctuation\">,</span> NotificationEvent<span class=\"token punctuation\">,</span> FALSE<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>\t\t\t<span class=\"token comment\">// 给这个请求的完成函数初始化参数</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>\t\t\tcontext<span class=\"token punctuation\">.</span>DevExt <span class=\"token operator\">=</span> DevExt<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>\t\t\tcontext<span class=\"token punctuation\">.</span>Event <span class=\"token operator\">=</span> <span class=\"token operator\">&amp;</span>Event<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>\t\t\t<span class=\"token comment\">// 这里 copy 一份 irp stack</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>\t\t\t<span class=\"token function\">IoCopyCurrentIrpStackLocationToNext</span><span class=\"token punctuation\">(</span>Irp<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>\t\t\t<span class=\"token comment\">// 设置完成函数</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>\t\t\t<span class=\"token function\">IoSetCompletionRoutine</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>\t\t\t\tIrp<span class=\"token punctuation\">,</span> </pre></td></tr><tr><td data-num=\"33\"></td><td><pre>\t\t\t\tDPVolumeOnLineCompleteRoutine<span class=\"token punctuation\">,</span> </pre></td></tr><tr><td data-num=\"34\"></td><td><pre>\t\t\t\t<span class=\"token operator\">&amp;</span>context<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>\t\t\t\tTRUE<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>\t\t\t\tTRUE<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>\t\t\t\tTRUE<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>\t\t\t<span class=\"token comment\">// 调用下层设备来处理这个 irp</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>\t\t\tntStatus <span class=\"token operator\">=</span> <span class=\"token function\">IoCallDriver</span><span class=\"token punctuation\">(</span>DevExt<span class=\"token operator\">-></span>LowerDevObj<span class=\"token punctuation\">,</span> Irp<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>\t\t\t<span class=\"token comment\">// 等待下层设备处理结束这个 irp</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>\t\t\t<span class=\"token function\">KeWaitForSingleObject</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>\t\t\t\t<span class=\"token operator\">&amp;</span>Event<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>\t\t\t\tExecutive<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>\t\t\t\tKernelMode<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>\t\t\t\tFALSE<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>\t\t\t\t<span class=\"token constant\">NULL</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>\t\t\t<span class=\"token comment\">// 返回</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>\t\t\t<span class=\"token keyword\">return</span> ntStatus<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>\t<span class=\"token keyword\">default</span><span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>\t\t<span class=\"token comment\">// 对于其它 DeviceIoControl，我们一律调用下层设备去处理</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre>\t\t<span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre>\t<span class=\"token keyword\">return</span> <span class=\"token function\">DPSendToNextDriver</span><span class=\"token punctuation\">(</span>DevExt<span class=\"token operator\">-></span>LowerDevObj<span class=\"token punctuation\">,</span>Irp<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\t\t</pre></td></tr><tr><td data-num=\"55\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h4 id=\"ioctl_volume_online的完成回调函数\"><a class=\"anchor\" href=\"#ioctl_volume_online的完成回调函数\">#</a> IOCTL_VOLUME_ONLINE 的完成回调函数</h4>\n<p>从上面的代码中可以看到，在如何获取到  <code>IOCTL_VOLUME_ONLINE</code>  请求时设置了名为  <code>DPVolumeOnLineCompleteRoutine</code>  的完成函数，这个函数将在下层设备处理完 IRP 时被调用。</p>\n<p>下面看一下这个完成函数里都做了什么，这里需要注意的是，在这个完成函数里，下层设备所对应的磁盘卷设备已经可以工作了。</p>\n<p>在完成函数里首先获取了卷的名称，即常见的 C、D、E 等盘符，这是通过系统调用获取到的，如果有兴趣，会发现这个系统调用是无法在 <code>IOCTL_VOLUME_ONLINE</code>  被下发之前使用的。<br />\n在获取了这些盘符之后，根据驱动设计，这里只对 “D” 盘感兴趣，在发现盘符为 “D” 的卷设备之后，首先获取这个卷的基本信息，例如卷有多大等。</p>\n<p>这个获取信息的函数是驱动自己实现的，它通过读取卷的第一个扇区并分析其内容来取得所需的信息。</p>\n<p>在上一章中我们学过 <code>DBR</code> ，应该会比较容易地理解这些信息是如何获取的，这里就不再对代码进行分析了。</p>\n<p>在获取了卷的信息之后，需要初始化一个 <code>bitmap</code> ，这个 <code>bitmap</code>  是还原功能的核心数据结构，具体的作用和实现后面会了解的，<strong>这里只需要知道初始化 <code>bitmap</code>  时需要卷的总大小作为参数即可</strong>。</p>\n<p>在这些工作都完成之后，<strong>将用来标识还原卷的全局变量赋值</strong>，<em>在今后运行的读 / 写分发函数和 boot 驱动回调函数等众多函数中，都会引用这个全局变量，并根据它的内容来确定哪个是需要保护的卷</em>。</p>\n<p>下面是完成函数的具体实现过程，在代码中读者可以发现，作为参数被传入的等待事件在最后被唤醒，这使得上面的 <code>DeviceIoControl</code>  处理代码中的等待得以返回，系统调用得以继续运行下去。</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>NTSTATUS</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token function\">DPVolumeOnLineCompleteRoutine</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>\tIN PDEVICE_OBJECT  DeviceObject<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>\tIN PIRP  Irp<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>\tIN PVOLUME_ONLINE_CONTEXT  Context</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>\t<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>\t<span class=\"token comment\">// 返回值</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\tNTSTATUS ntStatus <span class=\"token operator\">=</span> STATUS_SUCCESS<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\t<span class=\"token comment\">// 这个卷设备的 dos 名字，也就是 C，D 等</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>\tUNICODE_STRING\t\tDosName <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span> <span class=\"token number\">0</span> <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>\t<span class=\"token comment\">// 在这里 Context 是不可能为空的，为空就是出错了</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>\t<span class=\"token function\">ASSERT</span><span class=\"token punctuation\">(</span>Context<span class=\"token operator\">!=</span><span class=\"token constant\">NULL</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>\t<span class=\"token comment\">// 下面调用我们自己的 VolumeOnline 处理</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>\t<span class=\"token comment\">// 获取这个卷的 dos 名字</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>\tntStatus <span class=\"token operator\">=</span> <span class=\"token function\">IoVolumeDeviceToDosName</span><span class=\"token punctuation\">(</span>Context<span class=\"token operator\">-></span>DevExt<span class=\"token operator\">-></span>PhyDevObj<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>DosName<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token function\">NT_SUCCESS</span><span class=\"token punctuation\">(</span>ntStatus<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>\t\t<span class=\"token keyword\">goto</span> ERROUT<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>\t<span class=\"token comment\">// 将 dos 名字变成大写形式</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>\tContext<span class=\"token operator\">-></span>DevExt<span class=\"token operator\">-></span>VolumeLetter <span class=\"token operator\">=</span> DosName<span class=\"token punctuation\">.</span>Buffer<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>Context<span class=\"token operator\">-></span>DevExt<span class=\"token operator\">-></span>VolumeLetter <span class=\"token operator\">></span> L<span class=\"token string\">'Z'</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>\t\tContext<span class=\"token operator\">-></span>DevExt<span class=\"token operator\">-></span>VolumeLetter <span class=\"token operator\">-=</span> <span class=\"token punctuation\">(</span>L<span class=\"token string\">'a'</span> <span class=\"token operator\">-</span> L<span class=\"token string\">'A'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>\t<span class=\"token comment\">// 我们只保护 “D” 盘</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>Context<span class=\"token operator\">-></span>DevExt<span class=\"token operator\">-></span>VolumeLetter <span class=\"token operator\">==</span> L<span class=\"token string\">'D'</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>\t\t<span class=\"token comment\">// 获取这个卷的基本信息</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>\t\tntStatus <span class=\"token operator\">=</span> <span class=\"token function\">DPQueryVolumeInformation</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>\t\t\tContext<span class=\"token operator\">-></span>DevExt<span class=\"token operator\">-></span>PhyDevObj<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>\t\t\t<span class=\"token operator\">&amp;</span><span class=\"token punctuation\">(</span>Context<span class=\"token operator\">-></span>DevExt<span class=\"token operator\">-></span>TotalSizeInByte<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>\t\t\t<span class=\"token operator\">&amp;</span><span class=\"token punctuation\">(</span>Context<span class=\"token operator\">-></span>DevExt<span class=\"token operator\">-></span>ClusterSizeInByte<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>\t\t\t<span class=\"token operator\">&amp;</span><span class=\"token punctuation\">(</span>Context<span class=\"token operator\">-></span>DevExt<span class=\"token operator\">-></span>SectorSizeInByte<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>\t\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token function\">NT_SUCCESS</span><span class=\"token punctuation\">(</span>ntStatus<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>\t\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>\t\t\t<span class=\"token keyword\">goto</span> ERROUT<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>\t\t<span class=\"token comment\">// 建立这个卷对应的位图</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>\t\tntStatus <span class=\"token operator\">=</span> <span class=\"token function\">DPBitmapInit</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>\t\t\t<span class=\"token operator\">&amp;</span>Context<span class=\"token operator\">-></span>DevExt<span class=\"token operator\">-></span>Bitmap<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>\t\t\tContext<span class=\"token operator\">-></span>DevExt<span class=\"token operator\">-></span>SectorSizeInByte<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>\t\t\t<span class=\"token number\">8</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>\t\t\t<span class=\"token number\">25600</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>\t\t\t<span class=\"token punctuation\">(</span>DWORD<span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span>Context<span class=\"token operator\">-></span>DevExt<span class=\"token operator\">-></span>TotalSizeInByte<span class=\"token punctuation\">.</span>QuadPart <span class=\"token operator\">/</span> </pre></td></tr><tr><td data-num=\"44\"></td><td><pre>\t\t\t<span class=\"token punctuation\">(</span>LONGLONG<span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span><span class=\"token number\">25600</span> <span class=\"token operator\">*</span> <span class=\"token number\">8</span> <span class=\"token operator\">*</span> Context<span class=\"token operator\">-></span>DevExt<span class=\"token operator\">-></span>SectorSizeInByte<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>\t\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token function\">NT_SUCCESS</span><span class=\"token punctuation\">(</span>ntStatus<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>\t\t\t<span class=\"token keyword\">goto</span> ERROUT<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>\t\t<span class=\"token comment\">// 对全局量赋值，说明我们找到需要保护的那个设备了</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>\t\tgProtectDevExt <span class=\"token operator\">=</span> Context<span class=\"token operator\">-></span>DevExt<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"51\"></td><td><pre>ERROUT<span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre>\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token function\">NT_SUCCESS</span><span class=\"token punctuation\">(</span>ntStatus<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre>\t\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token constant\">NULL</span> <span class=\"token operator\">!=</span> Context<span class=\"token operator\">-></span>DevExt<span class=\"token operator\">-></span>Bitmap<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre>\t\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>\t\t\t<span class=\"token function\">DPBitmapFree</span><span class=\"token punctuation\">(</span>Context<span class=\"token operator\">-></span>DevExt<span class=\"token operator\">-></span>Bitmap<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre>\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre>\t\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token constant\">NULL</span> <span class=\"token operator\">!=</span> Context<span class=\"token operator\">-></span>DevExt<span class=\"token operator\">-></span>TempFile<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"59\"></td><td><pre>\t\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre>\t\t\t<span class=\"token function\">ZwClose</span><span class=\"token punctuation\">(</span>Context<span class=\"token operator\">-></span>DevExt<span class=\"token operator\">-></span>TempFile<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"61\"></td><td><pre>\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"62\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"63\"></td><td><pre>\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token constant\">NULL</span> <span class=\"token operator\">!=</span> DosName<span class=\"token punctuation\">.</span>Buffer<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"64\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"65\"></td><td><pre>\t\t<span class=\"token function\">ExFreePool</span><span class=\"token punctuation\">(</span>DosName<span class=\"token punctuation\">.</span>Buffer<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"66\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"67\"></td><td><pre>\t<span class=\"token comment\">// 设置等待同步事件，这样可以让我们等待的 DeviceIoControl 处理过程继续运行</span></pre></td></tr><tr><td data-num=\"68\"></td><td><pre>\t<span class=\"token function\">KeSetEvent</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"69\"></td><td><pre>\t\tContext<span class=\"token operator\">-></span>Event<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"70\"></td><td><pre>\t\t<span class=\"token number\">0</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"71\"></td><td><pre>\t\tFALSE<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"72\"></td><td><pre>\t<span class=\"token keyword\">return</span> STATUS_SUCCESS<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"73\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h3 id=\"bitmap的作用和分析\"><a class=\"anchor\" href=\"#bitmap的作用和分析\">#</a> bitmap 的作用和分析</h3>\n<p>在上面的分析中已经多次看到了 <code>bitmap</code> ，但却一直不知道它具体是什么，它的作用是什么，为什么要用它，它是如何实现的。</p>\n<p>下面将会来解答这些问题。</p>\n<p>顾名思义， <code>bitmap</code>  就是一个位图。<strong>它实际上是一些内存块，这些内存块的每一位用来标识一个磁盘上的最小访问单位，一般情况下是一个扇区。每一位可以被置位或者被清除，用来表示这个扇区所对应的两种状态</strong>。</p>\n<p>作为一个还原驱动，<strong>核心的问题在于如何将写入的数据存储在其他地方，而在读取时又能够准确地从其他地方找到</strong>。为了达到这个目的，就必须使用 <code>bitmap</code> 。 <code>bitmap</code>  中的每一位对应的是磁盘上的一个扇区，有多少个扇区就有多少位。<br />\n<em>这个位为 0 代表的意义是，这个位所对应的扇区的数据没有被存储到其他地方；反之，则代表这个扇区的数据被存储到了其他地方。在写数据时，根据写操作的范围可以将 <code>bitmap</code>  中对应的区域置为 1，在读操作时，则又会根据 <code>bitmap</code>  的内容把置为 1 的扇区从转存的地方读回来；而对 <code>bitmap</code>  为 0 的地方还是从原有设备上读取数据，这样 <code>bitmap</code>  就成了在这次系统启动生命周期中所有写操作的标志直到系统重启，在重启过后 <code>bitmap</code>  又将恢复为全 0 的状态，这时无论是什么读操作都不会从转存处拿数据，也就实现了还原的功能</em>。</p>\n<p>之所以说 <code>bitmap</code>  是一些内存块而不是一个连续的内存，是因为在设计 <code>bitmap</code>  时考虑到它所表示的位图可能对应着很大一块磁盘区域，即使是用 1 位来表示 512 字节的数据也有可能会是很大的一片内存空间。所以在设计 <code>bitmap</code>  时要求它能够按需分配内存，使用时才去分配对应的内存，这样就可以节约大量的内存空间。要知道这里所说的内存空间都是指非分页的内存，这一部分内存即使是在内核中也是非常宝贵的。</p>\n<p>首先来看一下 bitmap 的内部数据结构组成。</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">typedef</span> <span class=\"token keyword\">unsigned</span> <span class=\"token keyword\">char</span> tBitmap<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">pragma</span> <span class=\"token expression\"><span class=\"token function\">pack</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span></span></span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token keyword\">typedef</span> <span class=\"token keyword\">struct</span> <span class=\"token class-name\">_DP_BITMAP_</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>\t<span class=\"token comment\">// 这个卷中的每个扇区有多少字节，这同样也说明了 bitmap 中一个位所对应的字节数</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token keyword\">unsigned</span> <span class=\"token keyword\">long</span> sectorSize<span class=\"token punctuation\">;</span> </pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\t<span class=\"token comment\">// 每个 byte 里面有几个 bit，一般情况下是 8</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    <span class=\"token keyword\">unsigned</span> <span class=\"token keyword\">long</span> byteSize<span class=\"token punctuation\">;</span> </pre></td></tr><tr><td data-num=\"11\"></td><td><pre>\t<span class=\"token comment\">// 每个块是多大 byte，</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    <span class=\"token keyword\">unsigned</span> <span class=\"token keyword\">long</span> regionSize<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>\t<span class=\"token comment\">// 这个 bitmap 总共有多少个块</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    <span class=\"token keyword\">unsigned</span> <span class=\"token keyword\">long</span> regionNumber<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>\t<span class=\"token comment\">// 这个块对应了多少个实际的 byte，这个数字应该是 sectorSize * byteSize * regionSize</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    <span class=\"token keyword\">unsigned</span> <span class=\"token keyword\">long</span> regionReferSize<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>\t<span class=\"token comment\">// 这个 bitmap 对应了多少个实际的 byte，这个数字应该是 sectorSize * byteSize * regionSize * regionNumber</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>    __int64 bitmapReferSize<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>\t<span class=\"token comment\">// 指向 bitmap 存储空间的指针</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>    tBitmap<span class=\"token operator\">*</span><span class=\"token operator\">*</span> Bitmap<span class=\"token punctuation\">;</span> </pre></td></tr><tr><td data-num=\"21\"></td><td><pre>\t<span class=\"token comment\">// 用于存取 bitmap 的锁</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>    <span class=\"token keyword\">void</span><span class=\"token operator\">*</span> lockBitmap<span class=\"token punctuation\">;</span> </pre></td></tr><tr><td data-num=\"23\"></td><td><pre><span class=\"token punctuation\">&#125;</span> DP_BITMAP<span class=\"token punctuation\">,</span> <span class=\"token operator\">*</span> PDP_BITMAP<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre></pre></td></tr><tr><td data-num=\"25\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">pragma</span> <span class=\"token expression\"><span class=\"token function\">pack</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></span></span></pre></td></tr></table></figure><p>可以看到  <code>bitmap</code>  的最上层是一个类型为字节指针的指针（ <code>tBitmap**</code> ，实际等效于 <code>unsigned char**</code> ）的元素，名为 <code>bitmap</code> ，在这里可以把这个指针的指针理解成一个指针数组，数组有 <code>regionSize</code>  个元素，每个元素就是一个指向所谓的内存块的指针。在开始时这些指向内存块的指针都是空指针，这时它们代表了（而不是真正指向了）一个内容全部为 0 的内存块，只是实际的内存没有被分配出来。当需要将其中的任何一位设置为 1 时，这个内存块会首先被分配，在清零之后再对其中需要设置为 1 的位进行设置，这就是所说的按需分配，也是节约空间的关键所在。</p>\n<h4 id=\"初始化bitmap\"><a class=\"anchor\" href=\"#初始化bitmap\">#</a> 初始化 bitmap</h4>\n<p>下面是初始化这个数据结构的代码，用户通过指定 <code>bitmap</code>  的参数来初始化一个 <code>bitmap</code> ，在这里用户需要知道这个 <code>bitmap</code>  一共代表了多大的区域；同时需要给定一个块的大小，这个大小取的太大可能造成分配空间的浪费，取的太小又会使得块的数目太多，所以一般需要取一个合适的中间值。</p>\n<p>下面是初始化一个 <code>bitmap</code>  的代码</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>NTSTATUS <span class=\"token function\">DPBitmapInit</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>\tDP_BITMAP <span class=\"token operator\">*</span><span class=\"token operator\">*</span>     bitmap<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>\t<span class=\"token keyword\">unsigned</span> <span class=\"token keyword\">long</span>       sectorSize<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>\t<span class=\"token keyword\">unsigned</span> <span class=\"token keyword\">long</span>       byteSize<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>\t<span class=\"token keyword\">unsigned</span> <span class=\"token keyword\">long</span>       regionSize<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>\t<span class=\"token keyword\">unsigned</span> <span class=\"token keyword\">long</span>       regionNumber</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>\t<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\t<span class=\"token keyword\">int</span> i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\tDP_BITMAP <span class=\"token operator\">*</span> myBitmap <span class=\"token operator\">=</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>\tNTSTATUS status <span class=\"token operator\">=</span> STATUS_SUCCESS<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>\t<span class=\"token comment\">// 检查参数，以免使用了错误的参数导致发生处零错等错误</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token constant\">NULL</span> <span class=\"token operator\">==</span> bitmap <span class=\"token operator\">||</span> <span class=\"token number\">0</span> <span class=\"token operator\">==</span> sectorSize <span class=\"token operator\">||</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>\t\t<span class=\"token number\">0</span> <span class=\"token operator\">==</span> byteSize <span class=\"token operator\">||</span> <span class=\"token number\">0</span> <span class=\"token operator\">==</span> regionSize  <span class=\"token operator\">||</span> <span class=\"token number\">0</span> <span class=\"token operator\">==</span> regionNumber<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>\t\t<span class=\"token keyword\">return</span> STATUS_UNSUCCESSFUL<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>\t__try</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>\t\t<span class=\"token comment\">// 分配一个 bitmap 结构，这是无论如何都要分配的，这个结构相当于一个 bitmap 的 handle\t</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>\t\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token constant\">NULL</span> <span class=\"token operator\">==</span> <span class=\"token punctuation\">(</span>myBitmap <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>DP_BITMAP<span class=\"token operator\">*</span><span class=\"token punctuation\">)</span><span class=\"token function\">DPBitmapAlloc</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">sizeof</span><span class=\"token punctuation\">(</span>DP_BITMAP<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>\t\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>\t\t\tstatus <span class=\"token operator\">=</span> STATUS_INSUFFICIENT_RESOURCES<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>\t\t\t__leave<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>\t\t<span class=\"token comment\">// 清空结构</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>\t\t<span class=\"token function\">memset</span><span class=\"token punctuation\">(</span>myBitmap<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">sizeof</span><span class=\"token punctuation\">(</span>DP_BITMAP<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>\t\t<span class=\"token comment\">// 根据参数对结构中的成员进行赋值</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>\t\tmyBitmap<span class=\"token operator\">-></span>sectorSize <span class=\"token operator\">=</span> sectorSize<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>\t\tmyBitmap<span class=\"token operator\">-></span>byteSize <span class=\"token operator\">=</span> byteSize<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>\t\tmyBitmap<span class=\"token operator\">-></span>regionSize <span class=\"token operator\">=</span> regionSize<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>\t\tmyBitmap<span class=\"token operator\">-></span>regionNumber <span class=\"token operator\">=</span> regionNumber<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>\t\tmyBitmap<span class=\"token operator\">-></span>regionReferSize <span class=\"token operator\">=</span> sectorSize <span class=\"token operator\">*</span> byteSize <span class=\"token operator\">*</span> regionSize<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>\t\tmyBitmap<span class=\"token operator\">-></span>bitmapReferSize <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>__int64<span class=\"token punctuation\">)</span>sectorSize <span class=\"token operator\">*</span> <span class=\"token punctuation\">(</span>__int64<span class=\"token punctuation\">)</span>byteSize <span class=\"token operator\">*</span> <span class=\"token punctuation\">(</span>__int64<span class=\"token punctuation\">)</span>regionSize <span class=\"token operator\">*</span> <span class=\"token punctuation\">(</span>__int64<span class=\"token punctuation\">)</span>regionNumber<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>\t\t<span class=\"token comment\">// 分配出 regionNumber 那么多个指向 region 的指针，这是一个指针数组</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>\t\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token constant\">NULL</span> <span class=\"token operator\">==</span> <span class=\"token punctuation\">(</span>myBitmap<span class=\"token operator\">-></span>Bitmap <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>tBitmap <span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token punctuation\">)</span><span class=\"token function\">DPBitmapAlloc</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">sizeof</span><span class=\"token punctuation\">(</span>tBitmap<span class=\"token operator\">*</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">*</span> regionNumber<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>\t\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>\t\t\tstatus <span class=\"token operator\">=</span> STATUS_INSUFFICIENT_RESOURCES<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>\t\t\t__leave<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>\t\t<span class=\"token comment\">// 清空指针数组</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>\t\t<span class=\"token function\">memset</span><span class=\"token punctuation\">(</span>myBitmap<span class=\"token operator\">-></span>Bitmap<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">sizeof</span><span class=\"token punctuation\">(</span>tBitmap<span class=\"token operator\">*</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">*</span> regionNumber<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>\t\t<span class=\"token operator\">*</span> bitmap <span class=\"token operator\">=</span> myBitmap<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>\t\tstatus <span class=\"token operator\">=</span> STATUS_SUCCESS<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>\t<span class=\"token function\">__except</span><span class=\"token punctuation\">(</span>EXCEPTION_EXECUTE_HANDLER<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>\t\tstatus <span class=\"token operator\">=</span> STATUS_UNSUCCESSFUL<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token function\">NT_SUCCESS</span><span class=\"token punctuation\">(</span>status<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>\t\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token constant\">NULL</span> <span class=\"token operator\">!=</span> myBitmap<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre>\t\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre>\t\t\t<span class=\"token function\">DPBitmapFree</span><span class=\"token punctuation\">(</span>myBitmap<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre>\t\t<span class=\"token operator\">*</span> bitmap <span class=\"token operator\">=</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"59\"></td><td><pre>\t<span class=\"token keyword\">return</span> status<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"61\"></td><td><pre></pre></td></tr><tr><td data-num=\"62\"></td><td><pre><span class=\"token keyword\">void</span> <span class=\"token function\">DPBitmapFree</span><span class=\"token punctuation\">(</span>DP_BITMAP<span class=\"token operator\">*</span> bitmap<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"63\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"64\"></td><td><pre>\t<span class=\"token comment\">// 释放 bitmap</span></pre></td></tr><tr><td data-num=\"65\"></td><td><pre>\tDWORD i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"66\"></td><td><pre></pre></td></tr><tr><td data-num=\"67\"></td><td><pre>\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token constant\">NULL</span> <span class=\"token operator\">!=</span> bitmap<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"68\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"69\"></td><td><pre>\t\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token constant\">NULL</span> <span class=\"token operator\">!=</span> bitmap<span class=\"token operator\">-></span>Bitmap<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"70\"></td><td><pre>\t\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"71\"></td><td><pre>\t\t\t<span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span>i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> bitmap<span class=\"token operator\">-></span>regionNumber<span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"72\"></td><td><pre>\t\t\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"73\"></td><td><pre>\t\t\t\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token constant\">NULL</span> <span class=\"token operator\">!=</span> <span class=\"token operator\">*</span><span class=\"token punctuation\">(</span>bitmap<span class=\"token operator\">-></span>Bitmap <span class=\"token operator\">+</span> i<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"74\"></td><td><pre>\t\t\t\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"75\"></td><td><pre>\t\t\t\t\t<span class=\"token comment\">// 从最底层的块开始释放，所有块都轮询一次\t\t\t\t</span></pre></td></tr><tr><td data-num=\"76\"></td><td><pre>\t\t\t\t\t<span class=\"token function\">ExFreePool</span><span class=\"token punctuation\">(</span><span class=\"token operator\">*</span><span class=\"token punctuation\">(</span>bitmap<span class=\"token operator\">-></span>Bitmap <span class=\"token operator\">+</span> i<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"77\"></td><td><pre>\t\t\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"78\"></td><td><pre>\t\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"79\"></td><td><pre>\t\t\t<span class=\"token comment\">// 释放块的指针</span></pre></td></tr><tr><td data-num=\"80\"></td><td><pre>\t\t\t<span class=\"token function\">ExFreePool</span><span class=\"token punctuation\">(</span>bitmap<span class=\"token operator\">-></span>Bitmap<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"81\"></td><td><pre>\t\t<span class=\"token punctuation\">&#125;</span>\t</pre></td></tr><tr><td data-num=\"82\"></td><td><pre>\t\t<span class=\"token comment\">// 释放 bitmap 本身</span></pre></td></tr><tr><td data-num=\"83\"></td><td><pre>\t\t<span class=\"token function\">ExFreePool</span><span class=\"token punctuation\">(</span>bitmap<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"84\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"85\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>从上面的代码中可以看出，初始化 bitmap 的过程中仅仅分配了很少的一部分内存，而这时这个 bitmap 却是完全可用的，只有在对其进行位设置时才会有新的内存被分配出来。</p>\n<h4 id=\"bitmap置位函数\"><a class=\"anchor\" href=\"#bitmap置位函数\">#</a> bitmap 置位函数</h4>\n<p>bitmap 提供了一个接口，这个接口的作用是<em>把 bitmap 特定区域内的数据置位（即把某一位从 0 修改成 1），因为在 bitmap 的初始化过程中所有的位都认为是 0，而在今后使用的过程中也看不出需要将 1 变为 0 的可能，这就使得这里只需要提供置位的接口即可，而不需要清除位的接口</em>。这个接口函数需要考虑的第一个问题是，在所需置位的目标 bitmap 内存区域没有被分配时需要先分配才能置位。需要考虑的第二个问题是，如何能够尽快地完成一个对一长段连续的 bitmap 做置位的请求。</p>\n<p>下面请看这两个问题的具体处理方式。</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>NTSTATUS <span class=\"token function\">DPBitmapSet</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>\tDP_BITMAP <span class=\"token operator\">*</span>      bitmap<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>\tLARGE_INTEGER       offset<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>\t<span class=\"token keyword\">unsigned</span> <span class=\"token keyword\">long</span>       length</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>\t<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>\t__int64 i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>\t<span class=\"token keyword\">unsigned</span> <span class=\"token keyword\">long</span> myRegion <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> myRegionEnd <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\t<span class=\"token keyword\">unsigned</span> <span class=\"token keyword\">long</span> myRegionOffset <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> myRegionOffsetEnd <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\t<span class=\"token keyword\">unsigned</span> <span class=\"token keyword\">long</span> myByteOffset <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> myByteOffsetEnd <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>\t<span class=\"token keyword\">unsigned</span> <span class=\"token keyword\">long</span> myBitPos <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>\tNTSTATUS status <span class=\"token operator\">=</span> STATUS_SUCCESS<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>\tLARGE_INTEGER setBegin <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span> <span class=\"token number\">0</span> <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span> setEnd <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span> <span class=\"token number\">0</span> <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>\t__try</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>\t\t<span class=\"token comment\">// 检查变量</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>\t\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token constant\">NULL</span> <span class=\"token operator\">==</span> bitmap <span class=\"token operator\">||</span> offset<span class=\"token punctuation\">.</span>QuadPart <span class=\"token operator\">&lt;</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>\t\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>\t\t\tstatus <span class=\"token operator\">=</span> STATUS_INVALID_PARAMETER<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>\t\t\t__leave<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>\t\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token number\">0</span> <span class=\"token operator\">!=</span> offset<span class=\"token punctuation\">.</span>QuadPart <span class=\"token operator\">%</span> bitmap<span class=\"token operator\">-></span>sectorSize <span class=\"token operator\">||</span> <span class=\"token number\">0</span> <span class=\"token operator\">!=</span> length <span class=\"token operator\">%</span> bitmap</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>\t\t\t<span class=\"token operator\">-></span>sectorSize<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>\t\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>\t\t\tstatus <span class=\"token operator\">=</span> STATUS_INVALID_PARAMETER<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>\t\t\t__leave<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>\t\t<span class=\"token comment\">// 根据要设置的偏移量和长度来计算需要使用到哪些 region，如果需要的话，就分配他们指向的内存空间</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>\t\tmyRegion <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">unsigned</span> <span class=\"token keyword\">long</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span>offset<span class=\"token punctuation\">.</span>QuadPart <span class=\"token operator\">/</span> <span class=\"token punctuation\">(</span>__int64<span class=\"token punctuation\">)</span>bitmap<span class=\"token operator\">-></span>regionReferSize<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>\t\tmyRegionEnd <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">unsigned</span> <span class=\"token keyword\">long</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>offset<span class=\"token punctuation\">.</span>QuadPart <span class=\"token operator\">+</span> <span class=\"token punctuation\">(</span>__int64<span class=\"token punctuation\">)</span>length<span class=\"token punctuation\">)</span> <span class=\"token operator\">/</span> <span class=\"token punctuation\">(</span>__int64<span class=\"token punctuation\">)</span>bitmap<span class=\"token operator\">-></span>regionReferSize<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>\t\t<span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span>i <span class=\"token operator\">=</span> myRegion<span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;=</span> myRegionEnd<span class=\"token punctuation\">;</span> <span class=\"token operator\">++</span>i<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>\t\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>\t\t\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token constant\">NULL</span> <span class=\"token operator\">==</span> <span class=\"token operator\">*</span><span class=\"token punctuation\">(</span>bitmap<span class=\"token operator\">-></span>Bitmap <span class=\"token operator\">+</span> i<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>\t\t\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>\t\t\t\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token constant\">NULL</span> <span class=\"token operator\">==</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">*</span><span class=\"token punctuation\">(</span>bitmap<span class=\"token operator\">-></span>Bitmap <span class=\"token operator\">+</span> i<span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>tBitmap<span class=\"token operator\">*</span><span class=\"token punctuation\">)</span><span class=\"token function\">DPBitmapAlloc</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">sizeof</span><span class=\"token punctuation\">(</span>tBitmap<span class=\"token punctuation\">)</span> <span class=\"token operator\">*</span> bitmap<span class=\"token operator\">-></span>regionSize<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>\t\t\t\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>\t\t\t\t\tstatus <span class=\"token operator\">=</span> STATUS_INSUFFICIENT_RESOURCES<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>\t\t\t\t\t__leave<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>\t\t\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>\t\t\t\t<span class=\"token keyword\">else</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>\t\t\t\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>\t\t\t\t\t<span class=\"token function\">memset</span><span class=\"token punctuation\">(</span><span class=\"token operator\">*</span><span class=\"token punctuation\">(</span>bitmap<span class=\"token operator\">-></span>Bitmap <span class=\"token operator\">+</span> i<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">sizeof</span><span class=\"token punctuation\">(</span>tBitmap<span class=\"token punctuation\">)</span> <span class=\"token operator\">*</span> bitmap<span class=\"token operator\">-></span>regionSize<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>\t\t\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>\t\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>\t\t<span class=\"token comment\">// 开始设置 bitmap，首先我们需要将要设置的区域按照 byte 对齐，这样可以按 byte 设置而不需要按 bit 设置，加快设置速度</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>\t\t<span class=\"token comment\">// 对于没有 byte 对齐的区域先手工设置掉他们</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>\t\t<span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span>i <span class=\"token operator\">=</span> offset<span class=\"token punctuation\">.</span>QuadPart<span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> offset<span class=\"token punctuation\">.</span>QuadPart <span class=\"token operator\">+</span> <span class=\"token punctuation\">(</span>__int64<span class=\"token punctuation\">)</span>length<span class=\"token punctuation\">;</span> i <span class=\"token operator\">+=</span> bitmap<span class=\"token operator\">-></span>sectorSize<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre>\t\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>\t\t\tmyRegion <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">unsigned</span> <span class=\"token keyword\">long</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span>i <span class=\"token operator\">/</span> <span class=\"token punctuation\">(</span>__int64<span class=\"token punctuation\">)</span>bitmap<span class=\"token operator\">-></span>regionReferSize<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre>\t\t\tmyRegionOffset <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">unsigned</span> <span class=\"token keyword\">long</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span>i <span class=\"token operator\">%</span> <span class=\"token punctuation\">(</span>__int64<span class=\"token punctuation\">)</span>bitmap<span class=\"token operator\">-></span>regionReferSize<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre>\t\t\tmyByteOffset <span class=\"token operator\">=</span> myRegionOffset <span class=\"token operator\">/</span> bitmap<span class=\"token operator\">-></span>byteSize <span class=\"token operator\">/</span> bitmap<span class=\"token operator\">-></span>sectorSize<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>\t\t\tmyBitPos <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>myRegionOffset <span class=\"token operator\">/</span> bitmap<span class=\"token operator\">-></span>sectorSize<span class=\"token punctuation\">)</span> <span class=\"token operator\">%</span> bitmap<span class=\"token operator\">-></span>byteSize<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre>\t\t\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token number\">0</span> <span class=\"token operator\">==</span> myBitPos<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre>\t\t\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"59\"></td><td><pre>\t\t\t\tsetBegin<span class=\"token punctuation\">.</span>QuadPart <span class=\"token operator\">=</span> i<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre>\t\t\t\t<span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"61\"></td><td><pre>\t\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"62\"></td><td><pre>\t\t\t<span class=\"token operator\">*</span><span class=\"token punctuation\">(</span><span class=\"token operator\">*</span><span class=\"token punctuation\">(</span>bitmap<span class=\"token operator\">-></span>Bitmap <span class=\"token operator\">+</span> myRegion<span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> myByteOffset<span class=\"token punctuation\">)</span> <span class=\"token operator\">|=</span> bitmapMask<span class=\"token punctuation\">[</span>myBitPos<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"63\"></td><td><pre>\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"64\"></td><td><pre>\t\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>i <span class=\"token operator\">>=</span> offset<span class=\"token punctuation\">.</span>QuadPart <span class=\"token operator\">+</span> <span class=\"token punctuation\">(</span>__int64<span class=\"token punctuation\">)</span>length<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"65\"></td><td><pre>\t\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"66\"></td><td><pre>\t\t\tstatus <span class=\"token operator\">=</span> STATUS_SUCCESS<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"67\"></td><td><pre>\t\t\t__leave<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"68\"></td><td><pre>\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"69\"></td><td><pre></pre></td></tr><tr><td data-num=\"70\"></td><td><pre>\t\t<span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span>i <span class=\"token operator\">=</span> offset<span class=\"token punctuation\">.</span>QuadPart <span class=\"token operator\">+</span> <span class=\"token punctuation\">(</span>__int64<span class=\"token punctuation\">)</span>length <span class=\"token operator\">-</span> bitmap<span class=\"token operator\">-></span>sectorSize<span class=\"token punctuation\">;</span> i <span class=\"token operator\">>=</span> offset<span class=\"token punctuation\">.</span>QuadPart<span class=\"token punctuation\">;</span> i <span class=\"token operator\">-=</span> bitmap<span class=\"token operator\">-></span>sectorSize<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"71\"></td><td><pre>\t\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"72\"></td><td><pre>\t\t\tmyRegion <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">unsigned</span> <span class=\"token keyword\">long</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span>i <span class=\"token operator\">/</span> <span class=\"token punctuation\">(</span>__int64<span class=\"token punctuation\">)</span>bitmap<span class=\"token operator\">-></span>regionReferSize<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"73\"></td><td><pre>\t\t\tmyRegionOffset <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">unsigned</span> <span class=\"token keyword\">long</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span>i <span class=\"token operator\">%</span> <span class=\"token punctuation\">(</span>__int64<span class=\"token punctuation\">)</span>bitmap<span class=\"token operator\">-></span>regionReferSize<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"74\"></td><td><pre>\t\t\tmyByteOffset <span class=\"token operator\">=</span> myRegionOffset <span class=\"token operator\">/</span> bitmap<span class=\"token operator\">-></span>byteSize <span class=\"token operator\">/</span> bitmap<span class=\"token operator\">-></span>sectorSize<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"75\"></td><td><pre>\t\t\tmyBitPos <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>myRegionOffset <span class=\"token operator\">/</span> bitmap<span class=\"token operator\">-></span>sectorSize<span class=\"token punctuation\">)</span> <span class=\"token operator\">%</span> bitmap<span class=\"token operator\">-></span>byteSize<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"76\"></td><td><pre>\t\t\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token number\">7</span> <span class=\"token operator\">==</span> myBitPos<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"77\"></td><td><pre>\t\t\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"78\"></td><td><pre>\t\t\t\tsetEnd<span class=\"token punctuation\">.</span>QuadPart <span class=\"token operator\">=</span> i<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"79\"></td><td><pre>\t\t\t\t<span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"80\"></td><td><pre>\t\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"81\"></td><td><pre>\t\t\t<span class=\"token operator\">*</span><span class=\"token punctuation\">(</span><span class=\"token operator\">*</span><span class=\"token punctuation\">(</span>bitmap<span class=\"token operator\">-></span>Bitmap <span class=\"token operator\">+</span> myRegion<span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> myByteOffset<span class=\"token punctuation\">)</span> <span class=\"token operator\">|=</span> bitmapMask<span class=\"token punctuation\">[</span>myBitPos<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"82\"></td><td><pre>\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"83\"></td><td><pre></pre></td></tr><tr><td data-num=\"84\"></td><td><pre>\t\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>i <span class=\"token operator\">&lt;</span> offset<span class=\"token punctuation\">.</span>QuadPart <span class=\"token operator\">||</span> setEnd<span class=\"token punctuation\">.</span>QuadPart <span class=\"token operator\">==</span> setBegin<span class=\"token punctuation\">.</span>QuadPart<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"85\"></td><td><pre>\t\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"86\"></td><td><pre>\t\t\tstatus <span class=\"token operator\">=</span> STATUS_SUCCESS<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"87\"></td><td><pre>\t\t\t__leave<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"88\"></td><td><pre>\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"89\"></td><td><pre></pre></td></tr><tr><td data-num=\"90\"></td><td><pre>\t\tmyRegionEnd <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">unsigned</span> <span class=\"token keyword\">long</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span>setEnd<span class=\"token punctuation\">.</span>QuadPart <span class=\"token operator\">/</span> <span class=\"token punctuation\">(</span>__int64<span class=\"token punctuation\">)</span>bitmap<span class=\"token operator\">-></span>regionReferSize<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"91\"></td><td><pre></pre></td></tr><tr><td data-num=\"92\"></td><td><pre>\t\t<span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span>i <span class=\"token operator\">=</span> setBegin<span class=\"token punctuation\">.</span>QuadPart<span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;=</span> setEnd<span class=\"token punctuation\">.</span>QuadPart<span class=\"token punctuation\">;</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"93\"></td><td><pre>\t\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"94\"></td><td><pre>\t\t\tmyRegion <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">unsigned</span> <span class=\"token keyword\">long</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span>i <span class=\"token operator\">/</span> <span class=\"token punctuation\">(</span>__int64<span class=\"token punctuation\">)</span>bitmap<span class=\"token operator\">-></span>regionReferSize<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"95\"></td><td><pre>\t\t\tmyRegionOffset <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">unsigned</span> <span class=\"token keyword\">long</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span>i <span class=\"token operator\">%</span> <span class=\"token punctuation\">(</span>__int64<span class=\"token punctuation\">)</span>bitmap<span class=\"token operator\">-></span>regionReferSize<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"96\"></td><td><pre>\t\t\tmyByteOffset <span class=\"token operator\">=</span> myRegionOffset <span class=\"token operator\">/</span> bitmap<span class=\"token operator\">-></span>byteSize <span class=\"token operator\">/</span> bitmap<span class=\"token operator\">-></span>sectorSize<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"97\"></td><td><pre>\t\t\t<span class=\"token comment\">// 如果我们设置的区域没有跨两个 region，只需要使用 memset 去做按 byte 的设置然后跳出即可</span></pre></td></tr><tr><td data-num=\"98\"></td><td><pre>\t\t\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>myRegion <span class=\"token operator\">==</span> myRegionEnd<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"99\"></td><td><pre>\t\t\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"100\"></td><td><pre>\t\t\t\tmyRegionOffsetEnd <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">unsigned</span> <span class=\"token keyword\">long</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span>setEnd<span class=\"token punctuation\">.</span>QuadPart <span class=\"token operator\">%</span> <span class=\"token punctuation\">(</span>__int64<span class=\"token punctuation\">)</span>bitmap<span class=\"token operator\">-></span>regionReferSize<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"101\"></td><td><pre>\t\t\t\tmyByteOffsetEnd <span class=\"token operator\">=</span> myRegionOffsetEnd <span class=\"token operator\">/</span> bitmap<span class=\"token operator\">-></span>byteSize <span class=\"token operator\">/</span> bitmap<span class=\"token operator\">-></span>sectorSize<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"102\"></td><td><pre>\t\t\t\t<span class=\"token function\">memset</span><span class=\"token punctuation\">(</span><span class=\"token operator\">*</span><span class=\"token punctuation\">(</span>bitmap<span class=\"token operator\">-></span>Bitmap <span class=\"token operator\">+</span> myRegion<span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> myByteOffset<span class=\"token punctuation\">,</span> <span class=\"token number\">0xff</span><span class=\"token punctuation\">,</span> myByteOffsetEnd <span class=\"token operator\">-</span> myByteOffset <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"103\"></td><td><pre>\t\t\t\t<span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"104\"></td><td><pre>\t\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"105\"></td><td><pre>\t\t\t<span class=\"token comment\">// 如果我们设置的区域跨了两个 region，需要设置完后递增</span></pre></td></tr><tr><td data-num=\"106\"></td><td><pre>\t\t\t<span class=\"token keyword\">else</span></pre></td></tr><tr><td data-num=\"107\"></td><td><pre>\t\t\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"108\"></td><td><pre>\t\t\t\tmyRegionOffsetEnd <span class=\"token operator\">=</span> bitmap<span class=\"token operator\">-></span>regionReferSize<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"109\"></td><td><pre>\t\t\t\tmyByteOffsetEnd <span class=\"token operator\">=</span> myRegionOffsetEnd <span class=\"token operator\">/</span> bitmap<span class=\"token operator\">-></span>byteSize <span class=\"token operator\">/</span> bitmap<span class=\"token operator\">-></span>sectorSize<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"110\"></td><td><pre>\t\t\t\t<span class=\"token function\">memset</span><span class=\"token punctuation\">(</span><span class=\"token operator\">*</span><span class=\"token punctuation\">(</span>bitmap<span class=\"token operator\">-></span>Bitmap <span class=\"token operator\">+</span> myRegion<span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> myByteOffset<span class=\"token punctuation\">,</span> <span class=\"token number\">0xff</span><span class=\"token punctuation\">,</span> myByteOffsetEnd <span class=\"token operator\">-</span> myByteOffset<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"111\"></td><td><pre>\t\t\t\ti <span class=\"token operator\">+=</span> <span class=\"token punctuation\">(</span>myByteOffsetEnd <span class=\"token operator\">-</span> myByteOffset<span class=\"token punctuation\">)</span> <span class=\"token operator\">*</span> bitmap<span class=\"token operator\">-></span>byteSize <span class=\"token operator\">*</span> bitmap<span class=\"token operator\">-></span>sectorSize<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"112\"></td><td><pre>\t\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"113\"></td><td><pre>\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"114\"></td><td><pre>\t\tstatus <span class=\"token operator\">=</span> STATUS_SUCCESS<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"115\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"116\"></td><td><pre>\t<span class=\"token function\">__except</span><span class=\"token punctuation\">(</span>EXCEPTION_EXECUTE_HANDLER<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"117\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"118\"></td><td><pre>\t\tstatus <span class=\"token operator\">=</span> STATUS_UNSUCCESSFUL<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"119\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"120\"></td><td><pre></pre></td></tr><tr><td data-num=\"121\"></td><td><pre>\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token function\">NT_SUCCESS</span><span class=\"token punctuation\">(</span>status<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"122\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"123\"></td><td><pre>\t\t</pre></td></tr><tr><td data-num=\"124\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"125\"></td><td><pre>\t<span class=\"token keyword\">return</span> status<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"126\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>在上面的代码中看到，设置位的函数是如何先通过计算确定需要使用哪些块，并且在需要时分配它们的，然后是如何尽可能地按照一个字节而不是按照一个位来对所需要设置的位进行设置的。</p>\n<h4 id=\"bitmap位测试函数\"><a class=\"anchor\" href=\"#bitmap位测试函数\">#</a> bitmap 位测试函数</h4>\n<p>除了置位，bitmap 也需要提供一个能够测试指定位图区域是全部为 1 还是全部为 0，抑或兼而有之的接口，这个接口的目的在于，用户可以通过测试的结果决定如何进行下一步的操作。</p>\n<p>测试函数代码如下：</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">long</span> <span class=\"token function\">DPBitmapTest</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>\tDP_BITMAP <span class=\"token operator\">*</span>      bitmap<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>\tLARGE_INTEGER       offset<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>\t<span class=\"token keyword\">unsigned</span> <span class=\"token keyword\">long</span>       length</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>\t<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>\t<span class=\"token keyword\">char</span> flag <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>\t<span class=\"token keyword\">unsigned</span> <span class=\"token keyword\">long</span> i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\t<span class=\"token keyword\">unsigned</span> <span class=\"token keyword\">long</span> myRegion <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\t<span class=\"token keyword\">unsigned</span> <span class=\"token keyword\">long</span> myRegionOffset <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>\t<span class=\"token keyword\">unsigned</span> <span class=\"token keyword\">long</span> myByteOffset <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>\t<span class=\"token keyword\">unsigned</span> <span class=\"token keyword\">long</span> myBitPos <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>\t<span class=\"token keyword\">long</span> ret <span class=\"token operator\">=</span> BITMAP_BIT_UNKNOW<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>\t__try</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>\t\t<span class=\"token comment\">// 检查参数</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>\t\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token constant\">NULL</span> <span class=\"token operator\">==</span> bitmap <span class=\"token operator\">||</span> offset<span class=\"token punctuation\">.</span>QuadPart <span class=\"token operator\">&lt;</span> <span class=\"token number\">0</span> <span class=\"token operator\">||</span> offset<span class=\"token punctuation\">.</span>QuadPart <span class=\"token operator\">+</span> length <span class=\"token operator\">></span> bitmap<span class=\"token operator\">-></span>bitmapReferSize<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>\t\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>\t\t\tret <span class=\"token operator\">=</span> BITMAP_BIT_UNKNOW<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>\t\t\t__leave<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>\t\t<span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span>i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> length<span class=\"token punctuation\">;</span> i <span class=\"token operator\">+=</span> bitmap<span class=\"token operator\">-></span>sectorSize<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>\t\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>\t\t\t<span class=\"token comment\">// 针对需要测试的 bitmap 范围进行测试，如果全部为 0 则返回 BITMAP_RANGE_CLEAR，如果全部为 1，则返回 BITMAP_RANGE_SET，如果为 0，1 混合则返回 BITMAP_RANGE_BLEND</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>\t\t\tmyRegion <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">unsigned</span> <span class=\"token keyword\">long</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>offset<span class=\"token punctuation\">.</span>QuadPart <span class=\"token operator\">+</span> <span class=\"token punctuation\">(</span>__int64<span class=\"token punctuation\">)</span>i<span class=\"token punctuation\">)</span> <span class=\"token operator\">/</span> <span class=\"token punctuation\">(</span>__int64<span class=\"token punctuation\">)</span>bitmap<span class=\"token operator\">-></span>regionReferSize<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>\t\t\tmyRegionOffset <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">unsigned</span> <span class=\"token keyword\">long</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>offset<span class=\"token punctuation\">.</span>QuadPart <span class=\"token operator\">+</span> <span class=\"token punctuation\">(</span>__int64<span class=\"token punctuation\">)</span>i<span class=\"token punctuation\">)</span> <span class=\"token operator\">%</span> <span class=\"token punctuation\">(</span>__int64<span class=\"token punctuation\">)</span>bitmap<span class=\"token operator\">-></span>regionReferSize<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>\t\t\tmyByteOffset <span class=\"token operator\">=</span> myRegionOffset <span class=\"token operator\">/</span> bitmap<span class=\"token operator\">-></span>byteSize <span class=\"token operator\">/</span> bitmap<span class=\"token operator\">-></span>sectorSize<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>\t\t\tmyBitPos <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>myRegionOffset <span class=\"token operator\">/</span> bitmap<span class=\"token operator\">-></span>sectorSize<span class=\"token punctuation\">)</span> <span class=\"token operator\">%</span> bitmap<span class=\"token operator\">-></span>byteSize<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>\t\t\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token constant\">NULL</span> <span class=\"token operator\">!=</span> <span class=\"token operator\">*</span><span class=\"token punctuation\">(</span>bitmap<span class=\"token operator\">-></span>Bitmap <span class=\"token operator\">+</span> myRegion<span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">*</span><span class=\"token punctuation\">(</span><span class=\"token operator\">*</span><span class=\"token punctuation\">(</span>bitmap<span class=\"token operator\">-></span>Bitmap <span class=\"token operator\">+</span> myRegion<span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> myByteOffset<span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;</span>bitmapMask<span class=\"token punctuation\">[</span>myBitPos<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>\t\t\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>\t\t\t\tflag <span class=\"token operator\">|=</span> <span class=\"token number\">0x2</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>\t\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>\t\t\t<span class=\"token keyword\">else</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>\t\t\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>\t\t\t\tflag <span class=\"token operator\">|=</span> <span class=\"token number\">0x1</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>\t\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>\t\t\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>flag <span class=\"token operator\">==</span> <span class=\"token number\">0x3</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>\t\t\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>\t\t\t\t<span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>\t\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>\t\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token number\">0x2</span> <span class=\"token operator\">==</span> flag<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre>\t\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>\t\t\tret <span class=\"token operator\">=</span> BITMAP_RANGE_SET<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre>\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre>\t\t<span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token number\">0x01</span> <span class=\"token operator\">==</span> flag<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>\t\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre>\t\t\tret <span class=\"token operator\">=</span> BITMAP_RANGE_CLEAR<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre>\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"59\"></td><td><pre>\t\t<span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token number\">0x03</span> <span class=\"token operator\">==</span> flag<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre>\t\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"61\"></td><td><pre>\t\t\tret <span class=\"token operator\">=</span> BITMAP_RANGE_BLEND<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"62\"></td><td><pre>\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"63\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"64\"></td><td><pre>\t<span class=\"token function\">__except</span><span class=\"token punctuation\">(</span>EXCEPTION_EXECUTE_HANDLER<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"65\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"66\"></td><td><pre>\t\tret <span class=\"token operator\">=</span> BITMAP_BIT_UNKNOW<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"67\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"68\"></td><td><pre></pre></td></tr><tr><td data-num=\"69\"></td><td><pre>\t<span class=\"token keyword\">return</span> ret<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"70\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h4 id=\"获取指定区域位图函数\"><a class=\"anchor\" href=\"#获取指定区域位图函数\">#</a> 获取指定区域位图函数</h4>\n<p>bitmap 在完成了设置和测试的功能之后，还需要提供一个获取指定区域位图的接口，在后面的分析中可以看到，这个获取指定区域的位图操作一定是伴随着磁盘读操作而来的。</p>\n<p><strong>如果是读操作，对于 bitmap 设置为 1 的位置需要从转存数据中读取，而设置为 0 的位置则从原始的数据中读取，所以在获取了指定区域的位图之后，需要根据这个位图中的 0 和 1 来决定最终生成的数据哪一部分是从原始数据中来的，哪一部分是从转存数据中来的</strong>。</p>\n<p>由于使用环境的特殊性，这个接口被演变成将两个内存缓冲区的内容根据指定的 bitmap 来进行合并操作，读者应该很容易想到这两个缓冲区一个是读取自转存的数据，一个是读取自原始的数据。这个函数的代码如下：</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>NTSTATUS <span class=\"token function\">DPBitmapGet</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>\tDP_BITMAP <span class=\"token operator\">*</span>    bitmap<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>\tLARGE_INTEGER     offset<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>\t<span class=\"token keyword\">unsigned</span> <span class=\"token keyword\">long</span>     length<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>\t<span class=\"token keyword\">void</span> <span class=\"token operator\">*</span>            bufInOut<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>\t<span class=\"token keyword\">void</span> <span class=\"token operator\">*</span>            bufIn</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>\t<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\t<span class=\"token keyword\">unsigned</span> <span class=\"token keyword\">long</span> i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\t<span class=\"token keyword\">unsigned</span> <span class=\"token keyword\">long</span> myRegion <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>\t<span class=\"token keyword\">unsigned</span> <span class=\"token keyword\">long</span> myRegionOffset <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>\t<span class=\"token keyword\">unsigned</span> <span class=\"token keyword\">long</span> myByteOffset <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>\t<span class=\"token keyword\">unsigned</span> <span class=\"token keyword\">long</span> myBitPos <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>\tNTSTATUS status <span class=\"token operator\">=</span> STATUS_SUCCESS<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>\t__try</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>\t\t<span class=\"token comment\">// 检查参数</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>\t\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token constant\">NULL</span> <span class=\"token operator\">==</span> bitmap <span class=\"token operator\">||</span> offset<span class=\"token punctuation\">.</span>QuadPart <span class=\"token operator\">&lt;</span> <span class=\"token number\">0</span> <span class=\"token operator\">||</span> <span class=\"token constant\">NULL</span> <span class=\"token operator\">==</span> bufInOut <span class=\"token operator\">||</span> <span class=\"token constant\">NULL</span> <span class=\"token operator\">==</span> bufIn<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>\t\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>\t\t\tstatus <span class=\"token operator\">=</span> STATUS_INVALID_PARAMETER<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>\t\t\t__leave<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>\t\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token number\">0</span> <span class=\"token operator\">!=</span> offset<span class=\"token punctuation\">.</span>QuadPart <span class=\"token operator\">%</span> bitmap<span class=\"token operator\">-></span>sectorSize <span class=\"token operator\">||</span> <span class=\"token number\">0</span> <span class=\"token operator\">!=</span> length <span class=\"token operator\">%</span> bitmap<span class=\"token operator\">-></span>sectorSize<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>\t\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>\t\t\tstatus <span class=\"token operator\">=</span> STATUS_INVALID_PARAMETER<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>\t\t\t__leave<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>\t\t<span class=\"token comment\">// 遍历需要获取的位图范围，如果出现了位被设置为 1，就需要用 bufIn 参数中指向的相应位置的数据拷贝到 bufInOut 中</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>\t\t<span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span>i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> length<span class=\"token punctuation\">;</span> i <span class=\"token operator\">+=</span> bitmap<span class=\"token operator\">-></span>sectorSize<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>\t\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>\t\t\tmyRegion <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">unsigned</span> <span class=\"token keyword\">long</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>offset<span class=\"token punctuation\">.</span>QuadPart <span class=\"token operator\">+</span> <span class=\"token punctuation\">(</span>__int64<span class=\"token punctuation\">)</span>i<span class=\"token punctuation\">)</span> <span class=\"token operator\">/</span> <span class=\"token punctuation\">(</span>__int64<span class=\"token punctuation\">)</span>bitmap<span class=\"token operator\">-></span>regionReferSize<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>\t\t\tmyRegionOffset <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">unsigned</span> <span class=\"token keyword\">long</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>offset<span class=\"token punctuation\">.</span>QuadPart <span class=\"token operator\">+</span> <span class=\"token punctuation\">(</span>__int64<span class=\"token punctuation\">)</span>i<span class=\"token punctuation\">)</span> <span class=\"token operator\">%</span> <span class=\"token punctuation\">(</span>__int64<span class=\"token punctuation\">)</span>bitmap<span class=\"token operator\">-></span>regionReferSize<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>\t\t\tmyByteOffset <span class=\"token operator\">=</span> myRegionOffset <span class=\"token operator\">/</span> bitmap<span class=\"token operator\">-></span>byteSize <span class=\"token operator\">/</span> bitmap<span class=\"token operator\">-></span>sectorSize<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>\t\t\tmyBitPos <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>myRegionOffset <span class=\"token operator\">/</span> bitmap<span class=\"token operator\">-></span>sectorSize<span class=\"token punctuation\">)</span> <span class=\"token operator\">%</span> bitmap<span class=\"token operator\">-></span>byteSize<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>\t\t\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token constant\">NULL</span> <span class=\"token operator\">!=</span> <span class=\"token operator\">*</span><span class=\"token punctuation\">(</span>bitmap<span class=\"token operator\">-></span>Bitmap <span class=\"token operator\">+</span> myRegion<span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">*</span><span class=\"token punctuation\">(</span><span class=\"token operator\">*</span><span class=\"token punctuation\">(</span>bitmap<span class=\"token operator\">-></span>Bitmap <span class=\"token operator\">+</span> myRegion<span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> myByteOffset<span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;</span>bitmapMask<span class=\"token punctuation\">[</span>myBitPos<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>\t\t\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>\t\t\t\t<span class=\"token function\">memcpy</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>tBitmap<span class=\"token operator\">*</span><span class=\"token punctuation\">)</span>bufInOut <span class=\"token operator\">+</span> i<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span>tBitmap<span class=\"token operator\">*</span><span class=\"token punctuation\">)</span>bufIn <span class=\"token operator\">+</span> i<span class=\"token punctuation\">,</span> bitmap<span class=\"token operator\">-></span>sectorSize<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>\t\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>\t\tstatus <span class=\"token operator\">=</span> STATUS_SUCCESS<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>\t<span class=\"token function\">__except</span><span class=\"token punctuation\">(</span>EXCEPTION_EXECUTE_HANDLER<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>\t\tstatus <span class=\"token operator\">=</span> STATUS_UNSUCCESSFUL<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre></pre></td></tr><tr><td data-num=\"54\"></td><td><pre>\t<span class=\"token keyword\">return</span> status<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h3 id=\"boot驱动完成回调函数和稀疏文件\"><a class=\"anchor\" href=\"#boot驱动完成回调函数和稀疏文件\">#</a> boot 驱动完成回调函数和稀疏文件</h3>\n<p>到这里为止，离最终的读 / 写转存处理只有最后的一点准备工作需要做了，而这个工作放在了 boot 驱动完成回调函数中。至于为什么要放在这里，则是由本驱动采用的转存缓冲区的机制决定的。</p>\n<p>前面已经反复强调<strong>这个驱动会将写入保护磁盘卷的数据转存到另一个地方</strong>，那么这个地方在哪里？在此本驱动使用了一个最为简单的方法 ——<em> 把数据转存到另一个卷的稀疏文件中</em>。</p>\n<p><strong>稀疏文件是 NTFS 文件系统的一个特有的概念，它在建立时可以表示很大的空间，但是却完全不占用实际的存储空间，只有在向其中写入数据时才会使用到真正的存储空间。</strong></p>\n<p>这就是说，可以在一个容量只有 1GB 的磁盘卷上建立一个大小为 10GB 的稀疏文件，程序可以对这 10GB 空间中的任何一个位置进行读 / 写操作，但是写入的总数据量不能超过 1GB。至于为什么将这个稀疏文件放在了另一个磁盘卷上，主要是因为如果放在同一个磁盘卷上，在写入这个文件时势必会被过滤驱动捕获，然后写入的数据被转储到这个文件上，对文件的这个写入又被过滤驱动捕获，这就形成了典型的重入。<br />\n当然这种重入是很容易避免的，但是为了不引起不必要的麻烦，这个学习为目的的驱动就使用了另一个卷作为转储的空间，这样就从根本上避免了重入的问题。</p>\n<p>那么在本节的开始所说的准备工作又是什么呢？这个工作实际上就是准备好这个稀疏文件，建立它，设置它的大小并且打开它。</p>\n<p>那么为什么需要在 boot 驱动完成函数中做这些事情呢？<br />\n<em>这是因为稀疏文件的操作是依赖于文件系统的，作为文件系统的驱动程序，NTFS 驱动是一个 boot 型驱动，但是它只有在卷设备开始工作之后才会将自己的处理设备附加到这个卷上，从而响应对这个卷的所有文件请求</em>。</p>\n<p>这就说明之前无论是在  <code>AddDevice</code>  函数中还是在  <code>IOCTL_VOLUME_ONLINE</code>  的  <code>DeviceIoControl</code>  中， NTFS 文件都是不能读 / 写的。而在 boot 驱动的完成函数中，所有的 boot 驱动都已经加载完毕，NTFS 自然也不例外，这时对于 NTFS 文件的读 / 写就轻而易举了。下面看一下做最后一步准备工作的代码</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>VOID</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token function\">DPReinitializationRoutine</span><span class=\"token punctuation\">(</span> </pre></td></tr><tr><td data-num=\"3\"></td><td><pre>\tIN\tPDRIVER_OBJECT\tDriverObject<span class=\"token punctuation\">,</span> </pre></td></tr><tr><td data-num=\"4\"></td><td><pre>\tIN\tPVOID\t\t\tContext<span class=\"token punctuation\">,</span> </pre></td></tr><tr><td data-num=\"5\"></td><td><pre>\tIN\tULONG\t\t\tCount </pre></td></tr><tr><td data-num=\"6\"></td><td><pre>\t<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>\t<span class=\"token comment\">// 返回值</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\tNTSTATUS ntStatus<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\t<span class=\"token comment\">//D 盘的缓冲文件名</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>\tWCHAR\t\t\t\tSparseFilename<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> L<span class=\"token string\">\"\\\\??\\\\E:\\\\temp.dat\"</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>\tUNICODE_STRING\t\tSparseFilenameUni<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>\t<span class=\"token comment\">// 建立文件时的 io 操作状态值</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>\tIO_STATUS_BLOCK\t\t\t\t\tios <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span> <span class=\"token number\">0</span> <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>\t<span class=\"token comment\">// 建立文件时的对象属性变量</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>\tOBJECT_ATTRIBUTES\t\t\t\tObjAttr <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span> <span class=\"token number\">0</span> <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>\t<span class=\"token comment\">// 设置文件大小的时候使用的文件结尾描述符</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>\tFILE_END_OF_FILE_INFORMATION    FileEndInfo <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span> <span class=\"token number\">0</span> <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>\t<span class=\"token comment\">// 打开我们将要用来做转储的文件</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>\t<span class=\"token comment\">// 初始化要打开的文件名</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>\t<span class=\"token function\">RtlInitUnicodeString</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>SparseFilenameUni<span class=\"token punctuation\">,</span>SparseFilename<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>\t<span class=\"token comment\">// 初始化文件名对应的对象名，这里需要将其初始化为内核对象，并且大小写不敏感</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>\t<span class=\"token function\">InitializeObjectAttributes</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>\t\t<span class=\"token operator\">&amp;</span>ObjAttr<span class=\"token punctuation\">,</span> </pre></td></tr><tr><td data-num=\"26\"></td><td><pre>\t\t<span class=\"token operator\">&amp;</span>SparseFilenameUni<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>\t\tOBJ_KERNEL_HANDLE<span class=\"token operator\">|</span>OBJ_CASE_INSENSITIVE<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>\t\t<span class=\"token constant\">NULL</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>\t\t<span class=\"token constant\">NULL</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>\t<span class=\"token comment\">// 建立文件，这里需要注意的是，要加入 FILE_NO_INTERMEDIATE_BUFFERING 选项，避免文件系统再缓存这个文件</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>\tntStatus <span class=\"token operator\">=</span> <span class=\"token function\">ZwCreateFile</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>\t\t<span class=\"token operator\">&amp;</span>gProtectDevExt<span class=\"token operator\">-></span>TempFile<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>\t\tGENERIC_READ <span class=\"token operator\">|</span> GENERIC_WRITE<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>\t\t<span class=\"token operator\">&amp;</span>ObjAttr<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>\t\t<span class=\"token operator\">&amp;</span>ios<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>\t\t<span class=\"token constant\">NULL</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>\t\tFILE_ATTRIBUTE_NORMAL<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>\t\t<span class=\"token number\">0</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>\t\tFILE_OVERWRITE_IF<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>\t\tFILE_NON_DIRECTORY_FILE <span class=\"token operator\">|</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>\t\tFILE_RANDOM_ACCESS <span class=\"token operator\">|</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>\t\tFILE_SYNCHRONOUS_IO_NONALERT <span class=\"token operator\">|</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>\t\tFILE_NO_INTERMEDIATE_BUFFERING<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>\t\t<span class=\"token constant\">NULL</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>\t\t<span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>\t<span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token function\">NT_SUCCESS</span><span class=\"token punctuation\">(</span>ntStatus<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>\t\t<span class=\"token keyword\">goto</span> ERROUT<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>\t<span class=\"token comment\">// 设置这个文件为稀疏文件</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>\tntStatus <span class=\"token operator\">=</span> <span class=\"token function\">ZwFsControlFile</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre>\t\tgProtectDevExt<span class=\"token operator\">-></span>TempFile<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>\t\t<span class=\"token constant\">NULL</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre>\t\t<span class=\"token constant\">NULL</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre>\t\t<span class=\"token constant\">NULL</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>\t\t<span class=\"token operator\">&amp;</span>ios<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre>\t\tFSCTL_SET_SPARSE<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre>\t\t<span class=\"token constant\">NULL</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"59\"></td><td><pre>\t\t<span class=\"token number\">0</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre>\t\t<span class=\"token constant\">NULL</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"61\"></td><td><pre>\t\t<span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"62\"></td><td><pre>\t<span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token function\">NT_SUCCESS</span><span class=\"token punctuation\">(</span>ntStatus<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"63\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"64\"></td><td><pre>\t\t<span class=\"token keyword\">goto</span> ERROUT<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"65\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"66\"></td><td><pre>\t<span class=\"token comment\">// 设置这个文件的大小为 \"D\" 盘的大小并且留出 10m 的保护空间</span></pre></td></tr><tr><td data-num=\"67\"></td><td><pre>\tFileEndInfo<span class=\"token punctuation\">.</span>EndOfFile<span class=\"token punctuation\">.</span>QuadPart <span class=\"token operator\">=</span> gProtectDevExt<span class=\"token operator\">-></span>TotalSizeInByte<span class=\"token punctuation\">.</span>QuadPart <span class=\"token operator\">+</span> <span class=\"token number\">10</span><span class=\"token operator\">*</span><span class=\"token number\">1024</span><span class=\"token operator\">*</span><span class=\"token number\">1024</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"68\"></td><td><pre>\tntStatus <span class=\"token operator\">=</span> <span class=\"token function\">ZwSetInformationFile</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"69\"></td><td><pre>\t\tgProtectDevExt<span class=\"token operator\">-></span>TempFile<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"70\"></td><td><pre>\t\t<span class=\"token operator\">&amp;</span>ios<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"71\"></td><td><pre>\t\t<span class=\"token operator\">&amp;</span>FileEndInfo<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"72\"></td><td><pre>\t\t<span class=\"token keyword\">sizeof</span><span class=\"token punctuation\">(</span>FILE_END_OF_FILE_INFORMATION<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"73\"></td><td><pre>\t\tFileEndOfFileInformation</pre></td></tr><tr><td data-num=\"74\"></td><td><pre>\t\t<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"75\"></td><td><pre>\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token function\">NT_SUCCESS</span><span class=\"token punctuation\">(</span>ntStatus<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"76\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"77\"></td><td><pre>\t\t<span class=\"token keyword\">goto</span> ERROUT<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"78\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"79\"></td><td><pre>\t<span class=\"token comment\">// 如果成功初始化就将这个卷的保护标志设置为在保护状态</span></pre></td></tr><tr><td data-num=\"80\"></td><td><pre>\tgProtectDevExt<span class=\"token operator\">-></span>Protect <span class=\"token operator\">=</span> TRUE<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"81\"></td><td><pre>\t<span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"82\"></td><td><pre>ERROUT<span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"83\"></td><td><pre>\t<span class=\"token function\">KdPrint</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"error create temp file!\\n\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"84\"></td><td><pre>\t<span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"85\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>可以看到，在准备工作中首先建立了预先指定好文件名的文件，并将其属性设置为稀疏文件，之后通过设置文件结尾的方法将这个文件的大小变为之前获取到的 “D” 盘的大小。</p>\n<p>这时所有准备工作都已经齐备了，将保护标志设置为真，本驱动中最核心的数据转储过程即将开始。</p>\n<h3 id=\"读写请求的处理\"><a class=\"anchor\" href=\"#读写请求的处理\">#</a> 读 / 写请求的处理</h3>\n<p>在本驱动中，最为核心的部分就是读 / 写请求的处理部分。</p>\n<h4 id=\"读写请求同步处理\"><a class=\"anchor\" href=\"#读写请求同步处理\">#</a> 读 / 写请求同步处理</h4>\n<p><strong>所有的读 / 写请求必须按照顺序以同步的方式处理，只有上一个操作被处理完成之后，下一个操作才可以开始被处理</strong>。</p>\n<p><em>这是因为过滤驱动内部的 bitmap 设置、读取，转存文件的读 / 写等操作是无法做到并行处理的，如果不进行读 / 写请求的顺序化，则有可能带来读 / 写不同步的问题，即一个写操作还没有完成，另一个读取这个写操作目标位置的读操作又将到来，这会造成后来的读取数据不正确。</em></p>\n<p><em>为了达到这个目的，对所有流经过滤设备的磁盘卷设备读 / 写请求，除了不需要保护的卷，其他的必须全部顺序放入到一个处理队列中，由一个处理线程对这个队列中的请求进行顺序处理</em>。</p>\n<p>下面看一下将读 / 写请求排队的代码。</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>NTSTATUS</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token function\">DPDispatchReadWrite</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    IN\tPDEVICE_OBJECT\tDeviceObject<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    IN\tPIRP\t\t\tIrp</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">&#123;</span>\t</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>\t<span class=\"token comment\">// 用来指向过滤设备的设备扩展的指针</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>\tPDP_FILTER_DEV_EXTENSION\tDevExt <span class=\"token operator\">=</span> DeviceObject<span class=\"token operator\">-></span>DeviceExtension<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\t<span class=\"token comment\">// 返回值</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\tNTSTATUS ntStatus <span class=\"token operator\">=</span> STATUS_SUCCESS<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>DevExt<span class=\"token operator\">-></span>Protect<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>\t\t<span class=\"token comment\">// 这个卷在保护状态，</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>\t\t<span class=\"token comment\">// 我们首先把这个 irp 设为 pending 状态</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>\t\t<span class=\"token function\">IoMarkIrpPending</span><span class=\"token punctuation\">(</span>Irp<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>\t\t<span class=\"token comment\">// 然后将这个 irp 放进相应的请求队列里</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>\t\t<span class=\"token function\">ExInterlockedInsertTailList</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>\t\t\t<span class=\"token operator\">&amp;</span>DevExt<span class=\"token operator\">-></span>ReqList<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>\t\t\t<span class=\"token operator\">&amp;</span>Irp<span class=\"token operator\">-></span>Tail<span class=\"token punctuation\">.</span>Overlay<span class=\"token punctuation\">.</span>ListEntry<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>\t\t\t<span class=\"token operator\">&amp;</span>DevExt<span class=\"token operator\">-></span>ReqLock</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>\t\t\t<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>\t\t<span class=\"token comment\">// 设置队列的等待事件，通知队列对这个 irp 进行处理</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>\t\t<span class=\"token function\">KeSetEvent</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>\t\t\t<span class=\"token operator\">&amp;</span>DevExt<span class=\"token operator\">-></span>ReqEvent<span class=\"token punctuation\">,</span> </pre></td></tr><tr><td data-num=\"26\"></td><td><pre>\t\t\t<span class=\"token punctuation\">(</span>KPRIORITY<span class=\"token punctuation\">)</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span> </pre></td></tr><tr><td data-num=\"27\"></td><td><pre>\t\t\tFALSE<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>\t\t<span class=\"token comment\">// 返回 pending 状态，这个 irp 就算处理完了</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>\t\t<span class=\"token keyword\">return</span> STATUS_PENDING<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>\t<span class=\"token keyword\">else</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>\t\t<span class=\"token comment\">// 这个卷不在保护状态，直接交给下层设备进行处理</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>\t\t<span class=\"token keyword\">return</span> <span class=\"token function\">DPSendToNextDriver</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>\t\t\tDevExt<span class=\"token operator\">-></span>LowerDevObj<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>\t\t\tIrp<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>在上面的代码中可以看出，<strong>首先会对作为参数传入的设备对象的对象扩展中的保护位进行判断，这一位是在 boot 驱动结束回调函数中进行设置的，并且仅对 “D” 磁盘卷的设备扩展进行设置。如果这一位在非保护状态，过滤驱动将会把这个读 / 写请求直接发给下层设备去处理；反之，如果这一位在保护状态，过滤驱动将会把这个请求设置为等待处理状态，然后将其插入到为这个设备所准备的队列中，并且通过设置队列同步事件来通知处理线程对这个请求进行处理</strong>。</p>\n<p>至此，处理队列中已经塞满了等待处理的读 / 写请求，而处理线程将会忙于将这些请求分门别类地处理好。</p>\n<h4 id=\"读写请求的处理线程\"><a class=\"anchor\" href=\"#读写请求的处理线程\">#</a> 读 / 写请求的处理线程</h4>\n<p>下面将会讲解处理线程中的代码。</p>\n<hr />\n<p>首先是处理线程函数中只运行一遍的部分，包括变量的声明和对这个线程优先级的设置。由于这里不需要这个线程以非常高的优先级运行，所以将线程的优先级设置为低。</p>\n<hr />\n<p>接下来就是线程中的无限循环部分了。</p>\n<blockquote>\n<p><em>对于一个线程来说，其中必须有一个不会退出的循环体作为线程的工作主体，如果这个线程需要结束的话，一般会通过退出这个循环体来结束线程</em>。<br />\n<em>由于在线程外无法通过 API 调用的方式结束线程，所以在每个线程的循环体里一般会通过一个全局变量进行线程是否需要退出的判断，如果在线程外的任何地方将这个全局量设置为退出，那么在线程循环下一次运行到这个位置时就会自己跳出循环，结束自己</em>。</p>\n</blockquote>\n<hr />\n<p>下面就轮到真正的请求处理逻辑了。</p>\n<p>首先需要从处理请求队列中取出一个请求，这里通过带有锁机制的操作将处理请求队列头上的请求取出。由于在插入队列时是从队列的尾部插入的，这样就保证了是按照插入的顺序来进行请求处理的。在获取到请求之后，可以根据请求中的参数对一些局部变量进行赋值。</p>\n<hr />\n<p>下面轮到了对读请求的处理。</p>\n<p>这里首先根据需要读取的范围对 bitmap 中相应的范围进行测试。<br />\n<em>如果测试的结果是这些数据全部在原始磁盘上，那么这个请求就被直接发给下层设备去处理</em>。<br />\n<em>如果发现这些数据全部在转存文件中，就通过对转存文件的读取来获得数据，并完成这个 IRP 请求</em>。这里需要说明的是，如果出现这种情况，那么一定是之前有写请求将这一范围内的数据写入了转存文件中。<br />\n<em>如果发现需要读取的目标范围中的一部分在转存文件中，另一部分在实际磁盘上，首先就需要通过向下层设备发送请求来获取真实磁盘上的数据，然后通过读取转存文件来获取转储的数据，最后通过 bitmap 的相应接口函数将两个读取的数据按照 bitmap 的指示进行合并，再完成这个读的 IRP 请求</em>。</p>\n<hr />\n<p>对于写的操作处理起来很简单，因为只要发到这里的请求必定是需要写到转存文件中的。</p>\n<p><em>由于使用了稀疏文件，所以这个文件的可寻址范围和被保护磁盘的大小是相同的，转储操作就成了只需要直接写入文件即可</em>。<br />\n这里需要注意的是，要先写入转存文件，直到写入成功之后，才可以设置 bitmap 中的对应区域；如果反过来的话，则可能出现 bitmap 已经设置但是写入不成功的情况，这时需要清除 bitmap 的相应区域，这就不是一件简单的工作了。</p>\n<hr />\n<p>完整代码如下，可以对比上面的介绍来学习此函数。</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>VOID</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token function\">DPReadWriteThread</span> <span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>\tIN PVOID Context</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>\t<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>\t<span class=\"token comment\">//NTSTATUS 类型的函数返回值</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>\tNTSTATUS\t\t\t\t\tntStatus <span class=\"token operator\">=</span> STATUS_SUCCESS<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>\t<span class=\"token comment\">// 用来指向过滤设备的设备扩展的指针</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\tPDP_FILTER_DEV_EXTENSION\tDevExt <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>PDP_FILTER_DEV_EXTENSION<span class=\"token punctuation\">)</span>Context<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\t<span class=\"token comment\">// 请求队列的入口</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>\tPLIST_ENTRY\t\t\tReqEntry <span class=\"token operator\">=</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>\t<span class=\"token comment\">//irp 指针</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>\tPIRP\t\t\t\tIrp <span class=\"token operator\">=</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>\t<span class=\"token comment\">//irp stack 指针</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>\tPIO_STACK_LOCATION\tIrpsp <span class=\"token operator\">=</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>\t<span class=\"token comment\">//irp 中包括的数据地址</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>\tPBYTE\t\t\t\tsysBuf <span class=\"token operator\">=</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>\t<span class=\"token comment\">//irp 中的数据长度</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>\tULONG\t\t\t\tlength <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>\t<span class=\"token comment\">//irp 要处理的偏移量</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>\tLARGE_INTEGER\t\toffset <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span> <span class=\"token number\">0</span> <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>\t<span class=\"token comment\">// 文件缓冲指针</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>\tPBYTE\t\t\t\tfileBuf <span class=\"token operator\">=</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>\t<span class=\"token comment\">// 设备缓冲指针</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>\tPBYTE\t\t\t\tdevBuf <span class=\"token operator\">=</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>\t<span class=\"token comment\">//io 操作状态</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>\tIO_STATUS_BLOCK\t\tios<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>\t<span class=\"token comment\">// 设置这个线程的优先级</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>\t<span class=\"token function\">KeSetPriorityThread</span><span class=\"token punctuation\">(</span><span class=\"token function\">KeGetCurrentThread</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> LOW_REALTIME_PRIORITY<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>\t<span class=\"token comment\">// 下面是线程的实现部分，这个循环永不退出</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>\t<span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">;</span><span class=\"token punctuation\">;</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span>\t</pre></td></tr><tr><td data-num=\"34\"></td><td><pre>\t\t<span class=\"token comment\">// 先等待请求队列同步事件，如果队列中没有 irp 需要处理，我们的线程就等待在这里，让出 cpu 时间给其它线程</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>\t\t<span class=\"token function\">KeWaitForSingleObject</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>\t\t\t<span class=\"token operator\">&amp;</span>DevExt<span class=\"token operator\">-></span>ReqEvent<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>\t\t\tExecutive<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>\t\t\tKernelMode<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>\t\t\tFALSE<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>\t\t\t<span class=\"token constant\">NULL</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>\t\t\t<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>\t\t<span class=\"token comment\">// 如果有了线程结束标志，那么就在线程内部自己结束自己</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>\t\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>DevExt<span class=\"token operator\">-></span>ThreadTermFlag<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>\t\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>\t\t\t<span class=\"token comment\">// 这是线程的唯一退出地点</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>\t\t\t<span class=\"token function\">PsTerminateSystemThread</span><span class=\"token punctuation\">(</span>STATUS_SUCCESS<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>\t\t\t<span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>\t\t<span class=\"token comment\">// 从请求队列的首部拿出一个请求来准备处理，这里使用了自旋锁机制，所以不会有冲突</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>\t\t<span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span>ReqEntry <span class=\"token operator\">=</span> <span class=\"token function\">ExInterlockedRemoveHeadList</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>\t\t\t<span class=\"token operator\">&amp;</span>DevExt<span class=\"token operator\">-></span>ReqList<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre>\t\t\t<span class=\"token operator\">&amp;</span>DevExt<span class=\"token operator\">-></span>ReqLock</pre></td></tr><tr><td data-num=\"53\"></td><td><pre>\t\t\t<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre>\t\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre>\t\t\t<span class=\"token comment\">// 从队列的入口里找到实际的 irp 的地址</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>\t\t\tIrp <span class=\"token operator\">=</span> <span class=\"token function\">CONTAINING_RECORD</span><span class=\"token punctuation\">(</span>ReqEntry<span class=\"token punctuation\">,</span> IRP<span class=\"token punctuation\">,</span> Tail<span class=\"token punctuation\">.</span>Overlay<span class=\"token punctuation\">.</span>ListEntry<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre>\t\t\t<span class=\"token comment\">// 取得 irp stack</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre>\t\t\tIrpsp <span class=\"token operator\">=</span> <span class=\"token function\">IoGetCurrentIrpStackLocation</span><span class=\"token punctuation\">(</span>Irp<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"59\"></td><td><pre>\t\t\t<span class=\"token comment\">// 获取这个 irp 其中包含的缓存地址，这个地址可能来自 mdl，也可能就是直接的缓冲，这取决于我们当前设备的 io 方式是 buffer 还是 direct 方式</span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre>\t\t\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token constant\">NULL</span> <span class=\"token operator\">==</span> Irp<span class=\"token operator\">-></span>MdlAddress<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"61\"></td><td><pre>\t\t\t\tsysBuf <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>PBYTE<span class=\"token punctuation\">)</span>Irp<span class=\"token operator\">-></span>UserBuffer<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"62\"></td><td><pre>\t\t\t<span class=\"token keyword\">else</span></pre></td></tr><tr><td data-num=\"63\"></td><td><pre>\t\t\t\tsysBuf <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>PBYTE<span class=\"token punctuation\">)</span><span class=\"token function\">MmGetSystemAddressForMdlSafe</span><span class=\"token punctuation\">(</span>Irp<span class=\"token operator\">-></span>MdlAddress<span class=\"token punctuation\">,</span> NormalPagePriority<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"64\"></td><td><pre></pre></td></tr><tr><td data-num=\"65\"></td><td><pre>\t\t\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>IRP_MJ_READ <span class=\"token operator\">==</span> Irpsp<span class=\"token operator\">-></span>MajorFunction<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"66\"></td><td><pre>\t\t\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"67\"></td><td><pre>\t\t\t\t<span class=\"token comment\">// 如果是读的 irp 请求，我们在 irp stack 中取得相应的参数作为 offset 和 length</span></pre></td></tr><tr><td data-num=\"68\"></td><td><pre>\t\t\t\toffset <span class=\"token operator\">=</span> Irpsp<span class=\"token operator\">-></span>Parameters<span class=\"token punctuation\">.</span>Read<span class=\"token punctuation\">.</span>ByteOffset<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"69\"></td><td><pre>\t\t\t\tlength <span class=\"token operator\">=</span> Irpsp<span class=\"token operator\">-></span>Parameters<span class=\"token punctuation\">.</span>Read<span class=\"token punctuation\">.</span>Length<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"70\"></td><td><pre>\t\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"71\"></td><td><pre>\t\t\t<span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>IRP_MJ_WRITE <span class=\"token operator\">==</span> Irpsp<span class=\"token operator\">-></span>MajorFunction<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"72\"></td><td><pre>\t\t\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"73\"></td><td><pre>\t\t\t\t<span class=\"token comment\">// 如果是写的 irp 请求，我们在 irp stack 中取得相应的参数作为 offset 和 length</span></pre></td></tr><tr><td data-num=\"74\"></td><td><pre>\t\t\t\toffset <span class=\"token operator\">=</span> Irpsp<span class=\"token operator\">-></span>Parameters<span class=\"token punctuation\">.</span>Write<span class=\"token punctuation\">.</span>ByteOffset<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"75\"></td><td><pre>\t\t\t\tlength <span class=\"token operator\">=</span> Irpsp<span class=\"token operator\">-></span>Parameters<span class=\"token punctuation\">.</span>Write<span class=\"token punctuation\">.</span>Length<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"76\"></td><td><pre>\t\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"77\"></td><td><pre>\t\t\t<span class=\"token keyword\">else</span></pre></td></tr><tr><td data-num=\"78\"></td><td><pre>\t\t\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"79\"></td><td><pre>\t\t\t\t<span class=\"token comment\">// 除此之外，offset 和 length 都是 0</span></pre></td></tr><tr><td data-num=\"80\"></td><td><pre>\t\t\t\toffset<span class=\"token punctuation\">.</span>QuadPart <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"81\"></td><td><pre>\t\t\t\tlength <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"82\"></td><td><pre>\t\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"83\"></td><td><pre>\t\t\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token constant\">NULL</span> <span class=\"token operator\">==</span> sysBuf <span class=\"token operator\">||</span> <span class=\"token number\">0</span> <span class=\"token operator\">==</span> length<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"84\"></td><td><pre>\t\t\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"85\"></td><td><pre>\t\t\t\t<span class=\"token comment\">// 如果传下来的 irp 没有系统缓冲或者缓冲的长度是 0，那么我们就没有必要处理这个 irp，直接下发给下层设备就行了</span></pre></td></tr><tr><td data-num=\"86\"></td><td><pre>\t\t\t\t<span class=\"token keyword\">goto</span> ERRNEXT<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"87\"></td><td><pre>\t\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"88\"></td><td><pre>\t\t\t<span class=\"token comment\">// 下面是转储的过程了</span></pre></td></tr><tr><td data-num=\"89\"></td><td><pre>\t\t\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>IRP_MJ_READ <span class=\"token operator\">==</span> Irpsp<span class=\"token operator\">-></span>MajorFunction<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"90\"></td><td><pre>\t\t\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"91\"></td><td><pre>\t\t\t\t<span class=\"token comment\">// 这里是读的处理</span></pre></td></tr><tr><td data-num=\"92\"></td><td><pre>\t\t\t\t<span class=\"token comment\">// 首先根据 bitmap 来判断这次读操作读取的范围是全部为转储空间，还是全部为未转储空间，或者兼而有之</span></pre></td></tr><tr><td data-num=\"93\"></td><td><pre>\t\t\t\t<span class=\"token keyword\">long</span> tstResult <span class=\"token operator\">=</span> <span class=\"token function\">DPBitmapTest</span><span class=\"token punctuation\">(</span>DevExt<span class=\"token operator\">-></span>Bitmap<span class=\"token punctuation\">,</span> offset<span class=\"token punctuation\">,</span> length<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"94\"></td><td><pre>\t\t\t\t<span class=\"token keyword\">switch</span> <span class=\"token punctuation\">(</span>tstResult<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"95\"></td><td><pre>\t\t\t\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"96\"></td><td><pre>\t\t\t\t<span class=\"token keyword\">case</span> BITMAP_RANGE_CLEAR<span class=\"token operator\">:</span> </pre></td></tr><tr><td data-num=\"97\"></td><td><pre>\t\t\t\t\t<span class=\"token comment\">// 这说明这次读取的操作全部是读取未转储的空间，也就是真正的磁盘上的内容，我们直接发给下层设备去处理</span></pre></td></tr><tr><td data-num=\"98\"></td><td><pre>\t\t\t\t\t<span class=\"token keyword\">goto</span> ERRNEXT<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"99\"></td><td><pre>\t\t\t\t<span class=\"token keyword\">case</span> BITMAP_RANGE_SET<span class=\"token operator\">:</span> </pre></td></tr><tr><td data-num=\"100\"></td><td><pre>\t\t\t\t\t<span class=\"token comment\">// 这说明这次读取的操作全部是读取已经转储的空间，也就是缓冲文件上的内容，我们从文件中读取出来，然后直接完成这个 irp</span></pre></td></tr><tr><td data-num=\"101\"></td><td><pre>\t\t\t\t\t<span class=\"token comment\">// 分配一个缓冲区用来从缓冲文件中读取</span></pre></td></tr><tr><td data-num=\"102\"></td><td><pre>\t\t\t\t\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token constant\">NULL</span> <span class=\"token operator\">==</span> <span class=\"token punctuation\">(</span>fileBuf <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>PBYTE<span class=\"token punctuation\">)</span><span class=\"token function\">ExAllocatePoolWithTag</span><span class=\"token punctuation\">(</span>NonPagedPool<span class=\"token punctuation\">,</span> length<span class=\"token punctuation\">,</span> <span class=\"token string\">'xypD'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"103\"></td><td><pre>\t\t\t\t\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"104\"></td><td><pre>\t\t\t\t\t\tntStatus <span class=\"token operator\">=</span> STATUS_INSUFFICIENT_RESOURCES<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"105\"></td><td><pre>\t\t\t\t\t\tIrp<span class=\"token operator\">-></span>IoStatus<span class=\"token punctuation\">.</span>Information <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"106\"></td><td><pre>\t\t\t\t\t\t<span class=\"token keyword\">goto</span> ERRERR<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"107\"></td><td><pre>\t\t\t\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"108\"></td><td><pre>\t\t\t\t\t<span class=\"token function\">RtlZeroMemory</span><span class=\"token punctuation\">(</span>fileBuf<span class=\"token punctuation\">,</span>length<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"109\"></td><td><pre>\t\t\t\t\tntStatus <span class=\"token operator\">=</span> <span class=\"token function\">ZwReadFile</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"110\"></td><td><pre>\t\t\t\t\t\tDevExt<span class=\"token operator\">-></span>TempFile<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"111\"></td><td><pre>\t\t\t\t\t\t<span class=\"token constant\">NULL</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"112\"></td><td><pre>\t\t\t\t\t\t<span class=\"token constant\">NULL</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"113\"></td><td><pre>\t\t\t\t\t\t<span class=\"token constant\">NULL</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"114\"></td><td><pre>\t\t\t\t\t\t<span class=\"token operator\">&amp;</span>ios<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"115\"></td><td><pre>\t\t\t\t\t\tfileBuf<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"116\"></td><td><pre>\t\t\t\t\t\tlength<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"117\"></td><td><pre>\t\t\t\t\t\t<span class=\"token operator\">&amp;</span>offset<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"118\"></td><td><pre>\t\t\t\t\t\t<span class=\"token constant\">NULL</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"119\"></td><td><pre>\t\t\t\t\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">NT_SUCCESS</span><span class=\"token punctuation\">(</span>ntStatus<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"120\"></td><td><pre>\t\t\t\t\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"121\"></td><td><pre>\t\t\t\t\t\tIrp<span class=\"token operator\">-></span>IoStatus<span class=\"token punctuation\">.</span>Information <span class=\"token operator\">=</span> length<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"122\"></td><td><pre>\t\t\t\t\t\t<span class=\"token function\">RtlCopyMemory</span><span class=\"token punctuation\">(</span>sysBuf<span class=\"token punctuation\">,</span>fileBuf<span class=\"token punctuation\">,</span>Irp<span class=\"token operator\">-></span>IoStatus<span class=\"token punctuation\">.</span>Information<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"123\"></td><td><pre>\t\t\t\t\t\t<span class=\"token keyword\">goto</span> ERRCMPLT<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"124\"></td><td><pre>\t\t\t\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"125\"></td><td><pre>\t\t\t\t\t<span class=\"token keyword\">else</span></pre></td></tr><tr><td data-num=\"126\"></td><td><pre>\t\t\t\t\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"127\"></td><td><pre>\t\t\t\t\t\tntStatus <span class=\"token operator\">=</span> STATUS_INSUFFICIENT_RESOURCES<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"128\"></td><td><pre>\t\t\t\t\t\tIrp<span class=\"token operator\">-></span>IoStatus<span class=\"token punctuation\">.</span>Information <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"129\"></td><td><pre>\t\t\t\t\t\t<span class=\"token keyword\">goto</span> ERRERR<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"130\"></td><td><pre>\t\t\t\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"131\"></td><td><pre>\t\t\t\t\t<span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"132\"></td><td><pre></pre></td></tr><tr><td data-num=\"133\"></td><td><pre>\t\t\t\t<span class=\"token keyword\">case</span> BITMAP_RANGE_BLEND<span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"134\"></td><td><pre>\t\t\t\t\t<span class=\"token comment\">// 这说明这次读取的操作是混合的，我们也需要从下层设备中读出，同时从文件中读出，然后混合并返回</span></pre></td></tr><tr><td data-num=\"135\"></td><td><pre>\t\t\t\t\t<span class=\"token comment\">// 分配一个缓冲区用来从缓冲文件中读取</span></pre></td></tr><tr><td data-num=\"136\"></td><td><pre>\t\t\t\t\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token constant\">NULL</span> <span class=\"token operator\">==</span> <span class=\"token punctuation\">(</span>fileBuf <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>PBYTE<span class=\"token punctuation\">)</span><span class=\"token function\">ExAllocatePoolWithTag</span><span class=\"token punctuation\">(</span>NonPagedPool<span class=\"token punctuation\">,</span> length<span class=\"token punctuation\">,</span> <span class=\"token string\">'xypD'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"137\"></td><td><pre>\t\t\t\t\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"138\"></td><td><pre>\t\t\t\t\t\tntStatus <span class=\"token operator\">=</span> STATUS_INSUFFICIENT_RESOURCES<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"139\"></td><td><pre>\t\t\t\t\t\tIrp<span class=\"token operator\">-></span>IoStatus<span class=\"token punctuation\">.</span>Information <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"140\"></td><td><pre>\t\t\t\t\t\t<span class=\"token keyword\">goto</span> ERRERR<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"141\"></td><td><pre>\t\t\t\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"142\"></td><td><pre>\t\t\t\t\t<span class=\"token function\">RtlZeroMemory</span><span class=\"token punctuation\">(</span>fileBuf<span class=\"token punctuation\">,</span>length<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"143\"></td><td><pre>\t\t\t\t\t<span class=\"token comment\">// 分配一个缓冲区用来从下层设备中读取</span></pre></td></tr><tr><td data-num=\"144\"></td><td><pre>\t\t\t\t\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token constant\">NULL</span> <span class=\"token operator\">==</span> <span class=\"token punctuation\">(</span>devBuf <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>PBYTE<span class=\"token punctuation\">)</span><span class=\"token function\">ExAllocatePoolWithTag</span><span class=\"token punctuation\">(</span>NonPagedPool<span class=\"token punctuation\">,</span> length<span class=\"token punctuation\">,</span> <span class=\"token string\">'xypD'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"145\"></td><td><pre>\t\t\t\t\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"146\"></td><td><pre>\t\t\t\t\t\tntStatus <span class=\"token operator\">=</span> STATUS_INSUFFICIENT_RESOURCES<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"147\"></td><td><pre>\t\t\t\t\t\tIrp<span class=\"token operator\">-></span>IoStatus<span class=\"token punctuation\">.</span>Information <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"148\"></td><td><pre>\t\t\t\t\t\t<span class=\"token keyword\">goto</span> ERRERR<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"149\"></td><td><pre>\t\t\t\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"150\"></td><td><pre>\t\t\t\t\t<span class=\"token function\">RtlZeroMemory</span><span class=\"token punctuation\">(</span>devBuf<span class=\"token punctuation\">,</span>length<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"151\"></td><td><pre>\t\t\t\t\tntStatus <span class=\"token operator\">=</span> <span class=\"token function\">ZwReadFile</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"152\"></td><td><pre>\t\t\t\t\t\tDevExt<span class=\"token operator\">-></span>TempFile<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"153\"></td><td><pre>\t\t\t\t\t\t<span class=\"token constant\">NULL</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"154\"></td><td><pre>\t\t\t\t\t\t<span class=\"token constant\">NULL</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"155\"></td><td><pre>\t\t\t\t\t\t<span class=\"token constant\">NULL</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"156\"></td><td><pre>\t\t\t\t\t\t<span class=\"token operator\">&amp;</span>ios<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"157\"></td><td><pre>\t\t\t\t\t\tfileBuf<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"158\"></td><td><pre>\t\t\t\t\t\tlength<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"159\"></td><td><pre>\t\t\t\t\t\t<span class=\"token operator\">&amp;</span>offset<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"160\"></td><td><pre>\t\t\t\t\t\t<span class=\"token constant\">NULL</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"161\"></td><td><pre>\t\t\t\t\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token function\">NT_SUCCESS</span><span class=\"token punctuation\">(</span>ntStatus<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"162\"></td><td><pre>\t\t\t\t\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"163\"></td><td><pre>\t\t\t\t\t\tntStatus <span class=\"token operator\">=</span> STATUS_INSUFFICIENT_RESOURCES<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"164\"></td><td><pre>\t\t\t\t\t\tIrp<span class=\"token operator\">-></span>IoStatus<span class=\"token punctuation\">.</span>Information <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"165\"></td><td><pre>\t\t\t\t\t\t<span class=\"token keyword\">goto</span> ERRERR<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"166\"></td><td><pre>\t\t\t\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"167\"></td><td><pre>\t\t\t\t\t<span class=\"token comment\">// 把这个 irp 发给下层设备去获取需要从设备上读取的信息</span></pre></td></tr><tr><td data-num=\"168\"></td><td><pre>\t\t\t\t\tntStatus <span class=\"token operator\">=</span> <span class=\"token function\">DPForwardIrpSync</span><span class=\"token punctuation\">(</span>DevExt<span class=\"token operator\">-></span>LowerDevObj<span class=\"token punctuation\">,</span>Irp<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"169\"></td><td><pre>\t\t\t\t\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token function\">NT_SUCCESS</span><span class=\"token punctuation\">(</span>ntStatus<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"170\"></td><td><pre>\t\t\t\t\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"171\"></td><td><pre>\t\t\t\t\t\tntStatus <span class=\"token operator\">=</span> STATUS_INSUFFICIENT_RESOURCES<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"172\"></td><td><pre>\t\t\t\t\t\tIrp<span class=\"token operator\">-></span>IoStatus<span class=\"token punctuation\">.</span>Information <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"173\"></td><td><pre>\t\t\t\t\t\t<span class=\"token keyword\">goto</span> ERRERR<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"174\"></td><td><pre>\t\t\t\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"175\"></td><td><pre>\t\t\t\t\t<span class=\"token comment\">// 将从下层设备获取到的数据存储到 devBuf 中</span></pre></td></tr><tr><td data-num=\"176\"></td><td><pre>\t\t\t\t\t<span class=\"token function\">memcpy</span><span class=\"token punctuation\">(</span>devBuf<span class=\"token punctuation\">,</span> sysBuf<span class=\"token punctuation\">,</span> Irp<span class=\"token operator\">-></span>IoStatus<span class=\"token punctuation\">.</span>Information<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"177\"></td><td><pre>\t\t\t\t\t<span class=\"token comment\">// 把从文件获取到的数据和从设备获取到的数据根据相应的 bitmap 值来进行合并，合并的结果放在 devBuf 中</span></pre></td></tr><tr><td data-num=\"178\"></td><td><pre>\t\t\t\t\tntStatus <span class=\"token operator\">=</span> <span class=\"token function\">DPBitmapGet</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"179\"></td><td><pre>\t\t\t\t\t\tDevExt<span class=\"token operator\">-></span>Bitmap<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"180\"></td><td><pre>\t\t\t\t\t\toffset<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"181\"></td><td><pre>\t\t\t\t\t\tlength<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"182\"></td><td><pre>\t\t\t\t\t\tdevBuf<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"183\"></td><td><pre>\t\t\t\t\t\tfileBuf</pre></td></tr><tr><td data-num=\"184\"></td><td><pre>\t\t\t\t\t\t<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"185\"></td><td><pre>\t\t\t\t\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token function\">NT_SUCCESS</span><span class=\"token punctuation\">(</span>ntStatus<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"186\"></td><td><pre>\t\t\t\t\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"187\"></td><td><pre>\t\t\t\t\t\tntStatus <span class=\"token operator\">=</span> STATUS_INSUFFICIENT_RESOURCES<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"188\"></td><td><pre>\t\t\t\t\t\tIrp<span class=\"token operator\">-></span>IoStatus<span class=\"token punctuation\">.</span>Information <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"189\"></td><td><pre>\t\t\t\t\t\t<span class=\"token keyword\">goto</span> ERRERR<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"190\"></td><td><pre>\t\t\t\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"191\"></td><td><pre>\t\t\t\t\t<span class=\"token comment\">// 把合并完的数据存入系统缓冲并完成 irp</span></pre></td></tr><tr><td data-num=\"192\"></td><td><pre>\t\t\t\t\t<span class=\"token function\">memcpy</span><span class=\"token punctuation\">(</span>sysBuf<span class=\"token punctuation\">,</span> devBuf<span class=\"token punctuation\">,</span> Irp<span class=\"token operator\">-></span>IoStatus<span class=\"token punctuation\">.</span>Information<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"193\"></td><td><pre>\t\t\t\t\t<span class=\"token keyword\">goto</span> ERRCMPLT<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"194\"></td><td><pre>\t\t\t\t<span class=\"token keyword\">default</span><span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"195\"></td><td><pre>\t\t\t\t\tntStatus <span class=\"token operator\">=</span> STATUS_INSUFFICIENT_RESOURCES<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"196\"></td><td><pre>\t\t\t\t\t<span class=\"token keyword\">goto</span> ERRERR<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"197\"></td><td><pre>\t\t\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"198\"></td><td><pre>\t\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"199\"></td><td><pre>\t\t\t<span class=\"token keyword\">else</span></pre></td></tr><tr><td data-num=\"200\"></td><td><pre>\t\t\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"201\"></td><td><pre>\t\t\t\t<span class=\"token comment\">// 这里是写的过程</span></pre></td></tr><tr><td data-num=\"202\"></td><td><pre>\t\t\t\t<span class=\"token comment\">// 对于写，我们直接写缓冲文件，而不会写磁盘数据，这就是所谓的转储，但是转储之后需要在 bitmap 中做相应的标记</span></pre></td></tr><tr><td data-num=\"203\"></td><td><pre>\t\t\t\tntStatus <span class=\"token operator\">=</span> <span class=\"token function\">ZwWriteFile</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"204\"></td><td><pre>\t\t\t\t\tDevExt<span class=\"token operator\">-></span>TempFile<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"205\"></td><td><pre>\t\t\t\t\t<span class=\"token constant\">NULL</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"206\"></td><td><pre>\t\t\t\t\t<span class=\"token constant\">NULL</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"207\"></td><td><pre>\t\t\t\t\t<span class=\"token constant\">NULL</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"208\"></td><td><pre>\t\t\t\t\t<span class=\"token operator\">&amp;</span>ios<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"209\"></td><td><pre>\t\t\t\t\tsysBuf<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"210\"></td><td><pre>\t\t\t\t\tlength<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"211\"></td><td><pre>\t\t\t\t\t<span class=\"token operator\">&amp;</span>offset<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"212\"></td><td><pre>\t\t\t\t\t<span class=\"token constant\">NULL</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"213\"></td><td><pre>\t\t\t\t<span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token function\">NT_SUCCESS</span><span class=\"token punctuation\">(</span>ntStatus<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"214\"></td><td><pre>\t\t\t\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"215\"></td><td><pre>\t\t\t\t\tntStatus <span class=\"token operator\">=</span> STATUS_INSUFFICIENT_RESOURCES<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"216\"></td><td><pre>\t\t\t\t\t<span class=\"token keyword\">goto</span> ERRERR<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"217\"></td><td><pre>\t\t\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"218\"></td><td><pre>\t\t\t\t<span class=\"token keyword\">else</span></pre></td></tr><tr><td data-num=\"219\"></td><td><pre>\t\t\t\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"220\"></td><td><pre>\t\t\t\t\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">NT_SUCCESS</span><span class=\"token punctuation\">(</span>ntStatus <span class=\"token operator\">=</span> <span class=\"token function\">DPBitmapSet</span><span class=\"token punctuation\">(</span>DevExt<span class=\"token operator\">-></span>Bitmap<span class=\"token punctuation\">,</span> offset<span class=\"token punctuation\">,</span> length<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"221\"></td><td><pre>\t\t\t\t\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"222\"></td><td><pre>\t\t\t\t\t\t<span class=\"token keyword\">goto</span> ERRCMPLT<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"223\"></td><td><pre>\t\t\t\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"224\"></td><td><pre>\t\t\t\t\t<span class=\"token keyword\">else</span></pre></td></tr><tr><td data-num=\"225\"></td><td><pre>\t\t\t\t\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"226\"></td><td><pre>\t\t\t\t\t\tntStatus <span class=\"token operator\">=</span> STATUS_INSUFFICIENT_RESOURCES<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"227\"></td><td><pre>\t\t\t\t\t\t<span class=\"token keyword\">goto</span> ERRERR<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"228\"></td><td><pre>\t\t\t\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"229\"></td><td><pre>\t\t\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"230\"></td><td><pre>\t\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"231\"></td><td><pre>ERRERR<span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"232\"></td><td><pre>\t\t\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token constant\">NULL</span> <span class=\"token operator\">!=</span> fileBuf<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"233\"></td><td><pre>\t\t\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"234\"></td><td><pre>\t\t\t\t<span class=\"token function\">ExFreePool</span><span class=\"token punctuation\">(</span>fileBuf<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"235\"></td><td><pre>\t\t\t\tfileBuf <span class=\"token operator\">=</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"236\"></td><td><pre>\t\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"237\"></td><td><pre>\t\t\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token constant\">NULL</span> <span class=\"token operator\">!=</span> devBuf<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"238\"></td><td><pre>\t\t\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"239\"></td><td><pre>\t\t\t\t<span class=\"token function\">ExFreePool</span><span class=\"token punctuation\">(</span>devBuf<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"240\"></td><td><pre>\t\t\t\tdevBuf <span class=\"token operator\">=</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"241\"></td><td><pre>\t\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"242\"></td><td><pre>\t\t\t<span class=\"token function\">DPCompleteRequest</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"243\"></td><td><pre>\t\t\t\tIrp<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"244\"></td><td><pre>\t\t\t\tntStatus<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"245\"></td><td><pre>\t\t\t\tIO_NO_INCREMENT</pre></td></tr><tr><td data-num=\"246\"></td><td><pre>\t\t\t\t<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"247\"></td><td><pre>\t\t\t<span class=\"token keyword\">continue</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"248\"></td><td><pre>ERRNEXT<span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"249\"></td><td><pre>\t\t\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token constant\">NULL</span> <span class=\"token operator\">!=</span> fileBuf<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"250\"></td><td><pre>\t\t\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"251\"></td><td><pre>\t\t\t\t<span class=\"token function\">ExFreePool</span><span class=\"token punctuation\">(</span>fileBuf<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"252\"></td><td><pre>\t\t\t\tfileBuf <span class=\"token operator\">=</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"253\"></td><td><pre>\t\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"254\"></td><td><pre>\t\t\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token constant\">NULL</span> <span class=\"token operator\">!=</span> devBuf<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"255\"></td><td><pre>\t\t\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"256\"></td><td><pre>\t\t\t\t<span class=\"token function\">ExFreePool</span><span class=\"token punctuation\">(</span>devBuf<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"257\"></td><td><pre>\t\t\t\tdevBuf <span class=\"token operator\">=</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"258\"></td><td><pre>\t\t\t<span class=\"token punctuation\">&#125;</span>\t</pre></td></tr><tr><td data-num=\"259\"></td><td><pre>\t\t\t<span class=\"token function\">DPSendToNextDriver</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"260\"></td><td><pre>\t\t\t\tDevExt<span class=\"token operator\">-></span>LowerDevObj<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"261\"></td><td><pre>\t\t\t\tIrp<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"262\"></td><td><pre>\t\t\t<span class=\"token keyword\">continue</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"263\"></td><td><pre>ERRCMPLT<span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"264\"></td><td><pre>\t\t\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token constant\">NULL</span> <span class=\"token operator\">!=</span> fileBuf<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"265\"></td><td><pre>\t\t\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"266\"></td><td><pre>\t\t\t\t<span class=\"token function\">ExFreePool</span><span class=\"token punctuation\">(</span>fileBuf<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"267\"></td><td><pre>\t\t\t\tfileBuf <span class=\"token operator\">=</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"268\"></td><td><pre>\t\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"269\"></td><td><pre>\t\t\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token constant\">NULL</span> <span class=\"token operator\">!=</span> devBuf<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"270\"></td><td><pre>\t\t\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"271\"></td><td><pre>\t\t\t\t<span class=\"token function\">ExFreePool</span><span class=\"token punctuation\">(</span>devBuf<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"272\"></td><td><pre>\t\t\t\tdevBuf <span class=\"token operator\">=</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"273\"></td><td><pre>\t\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"274\"></td><td><pre>\t\t\t<span class=\"token function\">DPCompleteRequest</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"275\"></td><td><pre>\t\t\t\tIrp<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"276\"></td><td><pre>\t\t\t\tSTATUS_SUCCESS<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"277\"></td><td><pre>\t\t\t\tIO_DISK_INCREMENT</pre></td></tr><tr><td data-num=\"278\"></td><td><pre>\t\t\t\t<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"279\"></td><td><pre>\t\t\t<span class=\"token keyword\">continue</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"280\"></td><td><pre>\t\t\t</pre></td></tr><tr><td data-num=\"281\"></td><td><pre>\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"282\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"283\"></td><td><pre></pre></td></tr><tr><td data-num=\"284\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h2 id=\"驱动安装\"><a class=\"anchor\" href=\"#驱动安装\">#</a> 驱动安装</h2>\n<p>如何安装就不介绍了。</p>\n",
            "tags": [
                "磁盘的过滤",
                "具有还原功能的磁盘卷过滤驱动",
                "boot驱动",
                "bitmap"
            ]
        },
        {
            "id": "https://or0kit.github.io/Bin/Core/Drive-Development/%E7%A3%81%E7%9B%98%E7%9A%84%E8%99%9A%E6%8B%9F/",
            "url": "https://or0kit.github.io/Bin/Core/Drive-Development/%E7%A3%81%E7%9B%98%E7%9A%84%E8%99%9A%E6%8B%9F/",
            "title": "磁盘的虚拟",
            "date_published": "2022-07-27T14:35:15.000Z",
            "content_html": "<h1 id=\"虚拟的磁盘\"><a class=\"anchor\" href=\"#虚拟的磁盘\">#</a> 虚拟的磁盘</h1>\n<p>虚拟磁盘是我们可以在操作系统中增加一个行为完全可控的虚拟的磁盘驱动器。</p>\n<p>一个虚拟磁盘应用是加密，可以制作一个虚拟的磁盘，对这个磁盘的所有写入操作都通过某种算法以口令加密，同时对这个磁盘的读取作使用同样的算法和口令解密，那么在该程序运行时，操作系统和用户自己都可以看到正确的数据，而在这个程序不工作时，无论是谁企图读这磁盘，都只能看到被加密过的数据。这个特点使得这种磁盘成为一个存放机密文件的好地方，对这个磁盘的任何正常读 / 写，已经在不知不觉中被加（解）密了。</p>\n<h1 id=\"ramdisk\"><a class=\"anchor\" href=\"#ramdisk\">#</a> Ramdisk</h1>\n<p>我们接下来学习一下  <code>WDK6001.18000</code>  里自带的一个例子 —— <code>Ramdisk</code>  。</p>\n<p><code>Ramdisk</code>  使用非分页内存 (nonpaged memory) 做的磁盘存储空间，并将其以一个独立的磁盘形式暴露给用户，用户可以将其格式化成一个 Windows 能够使用的卷，并且像操作一般的磁盘卷一样对它进行操作。</p>\n<p>由于使用了内存作为虚拟的存储介质，这个磁盘具有的一个显著特点是性能的提高。由于内存本身的存取速度就比盘高许多倍，而且内存的随机存取速度又比磁盘寻道速度快很多，这几个优势使得这个内存盘非常适合作为各种软件的缓冲盘。</p>\n<p>这个磁盘的第二个显著特点是占用了大量的内存。这个特点几乎不需要解释，得到了多大的内存空间使用稀疏算法，使它看起来比实际上可用得要大得多，甚至还可以对内存空间进行压缩处理，使得它能存储更多的数据。</p>\n<p>这个磁盘的第三个显著特点就是，这是一个不具有非易失性的存储介质，这点很容易理解，关机重启之后，内存里没有数据可以留下来。</p>\n<p>这个例子使用了微软的 WDF 驱动开发框架，和普通的 WDM 驱动是不太一样的，接下来以这个驱动里的一些行为和方法对比普通的 WDM 驱动的行为和方法进行学习。</p>\n<p>WDM 驱动模型和 WDF 驱动模型的最大的区别是：</p>\n<ul>\n<li>wdf 驱动框架对 WDM 进行了一次封装，WDF 框架就好像 C++ 中的基类一样，且这个基类中的 model,IO model ,pnp 和电源管理模型；且提供了一些与操作系统相关的处理函数，这些函数好像 C++ 中的虚函数一样，WDF 驱动中能够对这些函数进行重写；特别是 Pnp 管理和电源管理！基本上都由 WDF 框架做了，而 WDF 的功能驱动几乎不要对它进行特殊的处理；</li>\n<li>WDF 驱动采用队列进行 IO 处理，而 WDM 中将所有的 IO 操作都用默认的队列进行处理，如果要进行 IRp 同步，必须使用 StartIO；</li>\n<li>WDF 是面向对象的，而 WDM 是面向过程的，WDF 提供对象的封装，如将 IRP 封装成 WDFREQUEST，对象提供方法和 Event。</li>\n</ul>\n<h2 id=\"入口函数\"><a class=\"anchor\" href=\"#入口函数\">#</a> 入口函数</h2>\n<p>再次学习一下驱动程序的入口函数。</p>\n<h3 id=\"入口函数的定义\"><a class=\"anchor\" href=\"#入口函数的定义\">#</a> 入口函数的定义</h3>\n<p>任何一个驱动程序，都会有一个  <code>DriverEntry</code>  入口函数，就像应用程序里的 main 一样。这个函数的声明是这样的:</p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>NTSTATUS <span class=\"token function\">DriverEntry</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>\tIN PDRIVER_OBJECT DrvierObject<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    IN PUNICODE_STRING RegisitryPath<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>这个函数的返回值是 NTSTATUS 类型，在驱动程序开发中经常会看到这个类型的返回值，它的各种预定义值几乎包含了驱动程序开发中所有可能出现的返回值，当然主要是各种各样的错误。<br />\n驱动程序开发人员的一个基本技能就是根据这个返回值来确定函数调用出了什么问题，这些返回值的定义位于  <code>WinDDK</code>  安装目录下的  <code>inc\\api\\ntstatus.h</code>  中，从返回值宏定义的英文意思上就基本可以判断出这个返回值的含义了。</p>\n<p>这个函数具有两个参数，第一个参数是一个  <code>PDRIVER_OBJECT</code>  类型的指针，它代表了 Windows 系统为这个驱动程序所分配的一个驱动对象。<strong>这个驱动对象是 Windows 系统中对某个驱动的唯一标识，里面包括了这个驱动的各种信息、各功能函数的入口地址等重要信息，信息量非常庞大，且复杂。</strong><br />\n在这里可以简单地认为，只要正确处理这个结构的每个成员，驱动就能够实现它的功能了。</p>\n<p>DriverEntry 的第二个参数是一个 Unicode 字符串，<strong>它代表了驱动在注册表中的参数所存放的位置。</strong><br />\n由于每一个驱动都是一个类似服务的形式存在的，在系统注册表的  <code>HKEY_LOCAL_MACHINE\\SYSTEM\\CurrentControlSet\\Services</code>  树下总有一个和驱动名字相同的子树用来描述这个驱动的一些基本信息，并提供一个可使用的存储空间供驱动存放自己的特有信息。<br />\n<strong>之所以在注册表中提供这么一个地方来供驱动存储信息，是因为很多驱动加载得非常早</strong>，甚至仅仅晚于 Windows 内核，这时文件系统还没有建立，驱动程序如果需要在此时享有自己可操作的存储空间（例如用来记录一些参数），除了注册表，没有其他任何地方可以使用。<strong>Windows 内核在启动时加载了一个最小的文件系统，分析磁盘并将注册表的  <code>HKEY_LOCAL_MACHINE\\SYSTEM</code>  树下的所有内容读入到内存里，这样就保证了这一部分的注册表内容在 Windows 内核刚加载之后就是可以读 / 写的。</strong><br />\nWindows 系统在启动过程中会在适当的时候将这棵子树的内容和磁盘上的注册表进行同步，之后的注册表操作就和一般的注册表操作别无二致了。在 Windows 内核刚加载之后，到这个适当的同步时间之前，任何加载的驱动程序都可以操作注册表并确保操作结果被最终留在了磁盘上，这就是 Windows 系统确保任何驱动都可以使用它提供的注册表路径来存储信息的秘密所在，也是这个注册表路径要作为驱动入口函数参数的重要意义。</p>\n<h3 id=\"ramdisk驱动的入口函数\"><a class=\"anchor\" href=\"#ramdisk驱动的入口函数\">#</a> Ramdisk 驱动的入口函数</h3>\n<p>这是 Ramdisk 驱动的入口函数源码：</p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>NTSTATUS</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token function\">DriverEntry</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    IN PDRIVER_OBJECT DriverObject<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    IN PUNICODE_STRING RegistryPath</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    WDF_DRIVER_CONFIG config<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token function\">KdPrint</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Windows Ramdisk Driver - Driver Framework Edition.\\n\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    <span class=\"token function\">KdPrint</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Built %s %s\\n\"</span><span class=\"token punctuation\">,</span> <span class=\"token constant\">__DATE__</span><span class=\"token punctuation\">,</span> <span class=\"token constant\">__TIME__</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre></pre></td></tr><tr><td data-num=\"12\"></td><td><pre></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    <span class=\"token function\">WDF_DRIVER_CONFIG_INIT</span><span class=\"token punctuation\">(</span> <span class=\"token operator\">&amp;</span>config<span class=\"token punctuation\">,</span> RamDiskEvtDeviceAdd <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    <span class=\"token keyword\">return</span> <span class=\"token function\">WdfDriverCreate</span><span class=\"token punctuation\">(</span>DriverObject<span class=\"token punctuation\">,</span> RegistryPath<span class=\"token punctuation\">,</span> WDF_NO_OBJECT_ATTRIBUTES<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>config<span class=\"token punctuation\">,</span> WDF_NO_HANDLE<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>看完源码后，我们需要了解  <code>WDF_DRIVER_CONFIG</code>  结构和  <code>WDF_DRIVER_CONFIG_INIT</code> ，还有后面的  <code>WdfDriverCreate</code>  函数。</p>\n<h4 id=\"wdf_driver_config-和-wdf_driver_config_init\"><a class=\"anchor\" href=\"#wdf_driver_config-和-wdf_driver_config_init\">#</a> WDF_DRIVER_CONFIG 和 WDF_DRIVER_CONFIG_INIT</h4>\n<p><code>WDF_DRIVER_CONFIG</code>  结构是  <code>WdfDriverCreate</code>  的输入参数。</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">typedef</span> <span class=\"token keyword\">struct</span> <span class=\"token class-name\">_WDF_DRIVER_CONFIG</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>  ULONG                     Size<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  PFN_WDF_DRIVER_DEVICE_ADD EvtDriverDeviceAdd<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  PFN_WDF_DRIVER_UNLOAD     EvtDriverUnload<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  ULONG                     DriverInitFlags<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  ULONG                     DriverPoolTag<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token punctuation\">&#125;</span> WDF_DRIVER_CONFIG<span class=\"token punctuation\">,</span> <span class=\"token operator\">*</span>PWDF_DRIVER_CONFIG<span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p><code>Size</code></p>\n<p>此结构的大小（以字节为单位）。</p>\n<p><code>EvtDriverDeviceAdd</code></p>\n<p>指向驱动程序的 EvtDriverDeviceAdd 回调函数的指针。</p>\n<p><code>EvtDriverUnload</code></p>\n<p>指向驱动程序的 EvtDriverUnload 回调函数的指针。</p>\n<p><code>DriverInitFlags</code></p>\n<p>一个或多个 WDF_DRIVER_INIT_FLAGS 类型值的按位或，用于标识驱动程序初始化标志。</p>\n<p><code>DriverPoolTag</code></p>\n<p>（KMDF 版本 1.5 和更高版本。）驱动程序定义的池标记，框架将分配给所有驱动程序的池分配。</p>\n<hr />\n<p>要初始化  <code>WDF_DRIVER_CONFIG</code>  结构，驱动程序必须调用  <code>WDF_DRIVER_CONFIG_INIT</code> 。</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">void</span> <span class=\"token function\">WDF_DRIVER_CONFIG_INIT</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>  <span class=\"token punctuation\">[</span>out<span class=\"token punctuation\">]</span>          PWDF_DRIVER_CONFIG        Config<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  <span class=\"token punctuation\">[</span>in<span class=\"token punctuation\">,</span> optional<span class=\"token punctuation\">]</span> PFN_WDF_DRIVER_DEVICE_ADD EvtDriverDeviceAdd</pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>参数<br />\n <code>[out] Config</code></p>\n<p>指向函数将初始化的 WDF_DRIVER_CONFIG 结构的指针。</p>\n<p><code>[in, optional] EvtDriverDeviceAdd</code></p>\n<p>指向驱动程序的  <code>EvtDriverDeviceAdd</code>  回调函数的指针。</p>\n<h4 id=\"wdfdrivercreate函数\"><a class=\"anchor\" href=\"#wdfdrivercreate函数\">#</a> WdfDriverCreate 函数</h4>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>NTSTATUS <span class=\"token function\">WdfDriverCreate</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>  <span class=\"token punctuation\">[</span>in<span class=\"token punctuation\">]</span>            PDRIVER_OBJECT         DriverObject<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  <span class=\"token punctuation\">[</span>in<span class=\"token punctuation\">]</span>            PCUNICODE_STRING       RegistryPath<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  <span class=\"token punctuation\">[</span>in<span class=\"token punctuation\">,</span> optional<span class=\"token punctuation\">]</span>  PWDF_OBJECT_ATTRIBUTES DriverAttributes<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  <span class=\"token punctuation\">[</span>in<span class=\"token punctuation\">]</span>            PWDF_DRIVER_CONFIG     DriverConfig<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  <span class=\"token punctuation\">[</span>out<span class=\"token punctuation\">,</span> optional<span class=\"token punctuation\">]</span> WDFDRIVER              <span class=\"token operator\">*</span>Driver</pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p><strong>参数</strong><br />\n <code>[in] DriverObject</code></p>\n<p>指向表示 Windows 驱动程序模型 (WDM) 驱动程序对象的 DRIVER_OBJECT 结构的指针。驱动程序接收该指针作为其 DriverEntry 例程的输入。</p>\n<p><code>[in] RegistryPath</code></p>\n<p>一个指向 UNICODE_STRING 结构的指针，该结构包含驱动程序接收的作为其 DriverEntry 例程的输入的注册表路径字符串。</p>\n<p><code>[in, optional] DriverAttributes</code></p>\n<p>指向调用者分配的 WDF_OBJECT_ATTRIBUTES 结构的指针。（结构的 ParentObject 成员必须为 NULL。）此参数是可选的，可以是 WDF_NO_OBJECT_ATTRIBUTES。</p>\n<p><code>[in] DriverConfig</code></p>\n<p>指向调用者分配的 WDF_DRIVER_CONFIG 结构的指针。</p>\n<p><code>[out, optional] Driver</code></p>\n<p>指向接收新框架驱动程序对象句柄的位置的指针。此参数是可选的，可以是 WDF_NO_HANDLE。</p>\n<p><strong>返回值</strong><br />\n如果操作成功， WdfDriverCreate 返回  <code>STATUS_SUCCESS</code>  。否则，此方法可能会返回以下值之一：</p>\n<table>\n<thead>\n<tr>\n<th style=\"text-align:left\">返回码</th>\n<th style=\"text-align:left\">描述</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td style=\"text-align:left\"><strong>STATUS_DRIVER_INTERNAL_ERROR</strong></td>\n<td style=\"text-align:left\">驱动程序多次调用 WdfDriverCreaterivercreate</td>\n</tr>\n<tr>\n<td style=\"text-align:left\"><strong>STATUS_INVALID_PARAMETER</strong></td>\n<td style=\"text-align:left\">非即插即用 (PnP) 驱动程序指定了 EvtDriverDeviceAdd 回调函数。</td>\n</tr>\n</tbody>\n</table>\n<h4 id=\"ramdisk的入口函数详解\"><a class=\"anchor\" href=\"#ramdisk的入口函数详解\">#</a> Ramdisk 的入口函数详解</h4>\n<ul>\n<li>DriverEntry 做的第一件事情是声明了一个  <code>WDF_DRIVER_CONFIG</code>  类型的变量  <code>config</code> ，并且在两句无关痛痒的输出语句之后，很快地使用  <code>WDF_DRIVER_ CONFIG_INIT</code>  初始化了  <code>config</code>  变量。</li>\n<li><code>WDF_DRIVER_CONFIG</code>  结构通常用来说明这个驱动程序的一些可配置项，其中包括了这个驱动程序的  <code>EvtDriverDeviceAdd</code>  和  <code>EvtDriverUnload</code>  回调函数的入口地址、这个驱动在初始化时的一些标志和在分配内存时所使用的  <code>tag</code>  值。</li>\n<li><code>WDF_DRIVER_CONFIG_INIT</code>  宏在初始化  <code>WDF_DRIVER_CONFIG</code>  类型的变量时会把用户提供的  <code>EvtDriverDeviceAdd</code>  回调函数的入口地址存入其中，并且初始化这个变量的其他部分。</li>\n<li><code>EvtDriverDeviceAdd</code>  回调函数是 WDF 驱动框架中的一个重要的回调函数，它用来在即插即用管理器发现一个新设备的时候对这个设备进行初始化操作，在这里读者可以将自己编写的  <code>RamDiskEvtDeviceAdd</code>  函数提供给系统作为本驱动的  <code>EvtDriverDeviceAdd</code>  回调函数。</li>\n<li>在设置好了  <code>config</code>  变量之后，  <code>DriverEntry</code>  直接调用了  <code>WdfDriverCreate</code>  并返回。<br />\n <code>WdfDriverCreate</code>  函数是在使用任何 WDF 框架提供的函数之前必须调用的一个函数，谭文认为，这无非是微软对原本的驱动程序开发方式的一次包装，它的作用就是根据参数来对 WDF 中的一些环境进行初始化工作，并且建立这个 WDF 驱动的驱动对象。<br />\n <code>WdfDriverCreate</code>  函数的前两个参数就是 DriverEntry 传入的驱动对象（DriverObject）和注册表路径 RegistryPath）；第三个参数被用来说明这个 WDF 驱动的驱动对象的一些属性，这里简单地用  <code>WDF_NO_OBJECT_ATTRIBUTES</code>  来说明不需要的特殊属性；第四个参数是之前初始化过的  <code>WDF_DRIVER_CONFIG</code>  变量；最后一个参数作为这个函数的输出结果 ——WDF 驱动的驱动对象。</li>\n<li>调用了这个函数之后，前面初始化过的 config 变量中的  <code>EvtDriverDeviceAdd</code>  回调函数 —— <code>RamDiskEvtDeviceAdd</code>  就和这个驱动挂钩起来，在今后的系统运行过程中，一旦发现了此类设备，RamDiskEvtDeviceAdd 就会被 Windows 的 PnP 管理器调用，这个驱动自己的处理流程也就要上演了。</li>\n</ul>\n<h2 id=\"evtdriverdeviceadd函数\"><a class=\"anchor\" href=\"#evtdriverdeviceadd函数\">#</a> EvtDriverDeviceAdd 函数</h2>\n<p>在本驱动中， RamDiskEvtDeviceAdd 作为一个 EvtDriverDeviceAdd 函数在 DriverEntry 中被注册，在 DriverEntry 函数执行完毕之后，这个驱动就只依靠 RamDiskEvtDriverDevicAdd 函数和系统保持联系了。正如上一节所说的，系统在运行过程中一旦发现了这种类型的设备，就会调用 RamDiskEvtDriverDevicAdd 函数。下面进行更仔细的分析:</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>NTSTATUS <span class=\"token function\">RamDiskEvtDeviceAdd</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>\tIN WDFDRIVER Driver<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>\tIN PWDFDEVICT_INIT DeviceInit</pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>这个函数的返回值是 NTSTATUS 类型，可以根据实际函数的执行结果选择返回代表正确的 STATUS_SUCCESS 或者其他代表错误的返回值。</p>\n<p>这个函数的第一个参数在这个例子中并不会使用到；第二个参数是一个  <code>WDFDEVICE_INIT</code>  类型的指针，这个参数是  <code>WDF</code>  驱动模型中自动分配出来的一个数据结构，专门传递给  <code>EvtDriverrDeviceAdd</code>  类函数用来建立一个新设备。<br />\n下面分段具体看这个驱动的  <code>EvtDriverDeviceAdd</code>  类函数是如何工作的。</p>\n<h3 id=\"局部变量的声明\"><a class=\"anchor\" href=\"#局部变量的声明\">#</a> 局部变量的声明</h3>\n<p>这里简单介绍一下每个变量的作用：</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">// 将要建立的设备对象的属性描述变量</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>WDF_OBJECT_ATTRIBUTES deviceAttributes<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\">// 将要调用的各种函数的状态返回值</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>NTSTATUS status<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token comment\">// 将要建立的设备</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>WDFDEVICE device<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token comment\">// 将要建立的队列对象的属性描述变量</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>WDF_OBJECT_ATTRIBUTES queueAttributes<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token comment\">// 将要建立的队列配置变量</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>WDF_IO_QUEUE_CONFIG ioQueueConfig<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token comment\">// 这个设备对应的设备扩展域的指针</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>PDEVICE_EXTENSION pDeviceExtension<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token comment\">// 将要建立的队列扩展域的指针</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>PQUEUE_EXTENSION pQueueContext <span class=\"token operator\">=</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token comment\">// 将要建立的队列</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>WDFQUEUE queue<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token comment\">// 声名一个 UNICODE_STRING 类型的变量，并将它初始化为 NT_DEVICE_NAME 宏所声名的字符串，这里实际上是 \\\\Device\\\\Ramdisk</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre><span class=\"token function\">DECLARE_CONST_UNICODE_STRING</span><span class=\"token punctuation\">(</span>ntDevictName<span class=\"token punctuation\">,</span>NT_DEVICE_NAME<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre><span class=\"token comment\">// 保证这个函数可以操作 paged 内存</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre><span class=\"token function\">PAGRD_CODE</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre><span class=\"token comment\">// 由于我们不适用 Driver 这个参数，为了避免警告，加入这句</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre><span class=\"token function\">UNREFFERENCED_PARAMETER</span><span class=\"token punctuation\">(</span>Driver<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><h3 id=\"磁盘设备的创建\"><a class=\"anchor\" href=\"#磁盘设备的创建\">#</a> 磁盘设备的创建</h3>\n<p><code>EvtDriverDeviceAdd</code>  类函数的一个重要任务是创建设备，而它的  <code>WDFDEVICE_INIT</code>  类型参数就是用来做这件事情的，在创建设备之前需要按照开发人员的思想对  <code>WDFDEVICE_INIT</code>  变量进行进一步的加工，使创建的设备能够达到想要的效果。</p>\n<p><strong>这里的设备首先需要一个名字，这是因为这个设备将会通过这个名字暴露给应用层并且被应用层所使用，一个没有名字的设备是无法在应用层使用的。</strong></p>\n<p>另外，需要将这个设备的类型设置为  <code>FILE_DEVICE_DISK</code>  ，这是因为所有的磁盘设备都需要使用这个设备类型。<br />\n将这个设备的 IO 类型设置为 <code>Direct</code>  方式，这样在将读 / 写和 <code>DeviceIoControl</code>  的 IRP 发送到这个设备时，IRP 所携带的缓冲区可以直接被使用。<br />\n将 <code>Exclusive</code>  设置为 <code>FALSE</code> ，这说明这个设备可以被多次打开。<br />\n这里还需要给这个设备对象关联一个设备扩展的上下文，<strong>这是开发人员指定类型的一块内存区域</strong>，这块内存区域被设备的设备扩展指针所指，开发人员可以在这块内存区域里存储自己定义的一些信息。<em>针对本驱动建立出的任何一个设备，这块内存区域的结构都是相同的，不同的是随设备对象不同而具有不同的内容</em>，这些内容在接下来的编程过程中将会在各种针对设备对象进行的处理中作为处理函数的参数。</p>\n<p>除此之外，还需要为设备的一些功能指定相应的处理函数，例如设备在销毁时将调用哪个函数，在收到  <code>PnP</code>  指令时将调用哪个函数等。</p>\n<p>幸运的是，  <code>WDF</code>  驱动模型框架已经为开发人员做了很多事情，基本上实现了所有功能的标准处理过程，在大部分情况下这些标准处理过程就已经足够了，只需要我们根据自己的要求进行很少的功能处理即可。</p>\n<p>这是  <code>EvtDriverDeviceAdd</code>  函数的的一部分：</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">// 首先需要为这个设备指定一个名词</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\">// \"\\\\Device\\\\Ramdisk\"</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>status <span class=\"token operator\">=</span> <span class=\"token function\">WdfDeviceInitAssignName</span><span class=\"token punctuation\">(</span>DeviceInit<span class=\"token punctuation\">,</span><span class=\"token operator\">&amp;</span>neDeviceName<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token function\">NT_SUCCESS</span><span class=\"token punctuation\">(</span>status<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token keyword\">return</span> status<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token comment\">// 接下来需要对这个设备进行一些属性的设置，包括设备类型和 IO 操作类型和设备的排他方式</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token function\">WdfDeviceInitSetDeviceType</span><span class=\"token punctuation\">(</span>DeviceInit<span class=\"token punctuation\">,</span>FILE_DEVICE_DISK<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token function\">WdfDeviceInitSetIoType</span><span class=\"token punctuation\">(</span>DeviceInit<span class=\"token punctuation\">,</span>WdfDeviceIoDirect<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token function\">WdfDeviceInitSetExclusive</span><span class=\"token punctuation\">(</span>DeviceInit<span class=\"token punctuation\">,</span>FALSE<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token comment\">// 下面来指定这个设备的设备对象扩展</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token comment\">// 这里的 DEVICE_EXTENSION 是一个在头文件中声名的结构体数据类型</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token comment\">// 我们使用一个 WDF_OBJECT_ATTRIBUTES 类型的变量并用其设置好 DEVICE_EXTENSION</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token function\">WDF_OBJECT_ATTRIBUTES_INIT_CONTEXT_TYPE</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>\t<span class=\"token operator\">&amp;</span>deviceAttributes<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>  DEVICE_EXTENSION</pre></td></tr><tr><td data-num=\"20\"></td><td><pre><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre><span class=\"token comment\">// 下面我们还将用这个 WDF_OBJECT_ATTRIBUTES 类型的变量来指定这个设备的清除回调函数</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre><span class=\"token comment\">// 这个 WDF_OBJECT_ATTRIBUTES 类型的变量将会在下面建立设备时作为一个参数传进去</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>deviceAttributes<span class=\"token punctuation\">.</span>EvtCleanupCallBack <span class=\"token operator\">=</span> RamDiskEvtDeviceContextCleanup<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre></pre></td></tr><tr><td data-num=\"25\"></td><td><pre><span class=\"token comment\">// 到这里，所有的准备工作都已经就绪了，我们可以开始真正建立这个设备了</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre><span class=\"token comment\">// 建立到的设备被保存到了变量 device 中了</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>status <span class=\"token operator\">=</span> <span class=\"token function\">WdfDeviceCreate</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>DeviceInit<span class=\"token punctuation\">,</span><span class=\"token operator\">&amp;</span>deviceAttributes<span class=\"token punctuation\">,</span><span class=\"token operator\">&amp;</span>device<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token function\">NT_SUCCESS</span><span class=\"token punctuation\">(</span>status<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>        <span class=\"token keyword\">return</span> status<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre><span class=\"token comment\">// 这个 pDeviceExtension 是我们声明的一个局部指针变量，将其指向新建立的设备拓展区域</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>pDeviceExtension <span class=\"token operator\">=</span> <span class=\"token function\">DeviceGetExtension</span><span class=\"token punctuation\">(</span>device<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><h3 id=\"如何处理发往设备的请求\"><a class=\"anchor\" href=\"#如何处理发往设备的请求\">#</a> 如何处理发往设备的请求</h3>\n<p>在设备被创建好了之后，如何处理所有可能发送给设备的请求是需要考虑的下一个问题。</p>\n<p>在以往的 WDM 开发中，常用的方式是：<em>开发者把自己实现的回调函数，作为这个设备的功能分发函数</em>。<br />\n此外，一些特殊的功能需求，也可以在回调函数中处理。例如，可以将所有的读 / 写请求都实现为去读 / 写内存，这就是最简单的内存盘。</p>\n<p>上面的处理方式说起来很简单，但是实现时还是需要一些技巧的。<br />\n一种常用的方式是 ** 建立一个或多个队列，将所有发送到这个设备的请求都插入到队列中，由另一个线程去处理队列。** 这是一个典型的生产者 — 消费者模型，这样做的好处是有了一个小小的缓冲，同时还不用担心由缓冲带来的同步问题，因为所有的请求都被队列排队了。</p>\n<p>无独有偶，在 WDF 驱动框架中，微软直接提供了这种处理队列，这样就不用开发人员自己去操心<em>如何建立队列、如何设置同步事件、如何在正确的时间销毁队列了</em>，这可真是一个造福大众的做法。</p>\n<p>为了实现<em>为驱动制作一个处理队列</em>这一目标，在 WDF 驱动框架中需要初始化一个队列配置变量 <code>ioQueueConfig</code> ，这个变量会说明队列的各种属性。<br />\n一种简单的初始化方法是将这个配置变量初始化为<em>默认状态</em>，之后再对一些具有特殊属性的请求注册回调函数，例如为读请求注册回调函数等。<br />\n在这样的初始化之后再为指定设备建立队列，WDF 驱动框架会自动将所有发往这个指定设备的请求都放入队列中处理，同时当请求符合感兴趣的属性（例如读 / 写操作）时会调用之前注册过的处理函数去处理。对每个设备可以建立多个队列，但是在本例中不会讨论多个处理队列的情况。另外，在队列中也具有和设备类似的扩展，下面也会使用到。</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">// 将队列的配置变量初始化为默认值</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token function\">WDF_IO_QUEUE_CONFIG_INIT_DEFAULT_QUEUE</span> <span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>      <span class=\"token operator\">&amp;</span>ioQueueConfig<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>      WdfIoQueueDispatchSequential</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>      <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token comment\">// 我们对读写和 DeviceControl 请求的处理设置为自己的函数，其余的使用默认值</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>ioQueueConfig<span class=\"token punctuation\">.</span>EvtIoDeviceControl <span class=\"token operator\">=</span> RamDiskEvtIoDeviceControl<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>ioQueueConfig<span class=\"token punctuation\">.</span>EvtIoRead          <span class=\"token operator\">=</span> RamDiskEvtIoRead<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>ioQueueConfig<span class=\"token punctuation\">.</span>EvtIoWrite         <span class=\"token operator\">=</span> RamDiskEvtIoWrite<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token comment\">// 指定这个队列的队列对象扩展，这里的 QUEUE_EXTENSION 是一个在头文件中声明好的结构体数据类型</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token function\">WDF_OBJECT_ATTRIBUTES_INIT_CONTEXT_TYPE</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>\t<span class=\"token operator\">&amp;</span>queueAttributes<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>\tQUEUE_EXTENSION</pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre></pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token comment\">// 万事俱备，我们将开始创建队列，将之前创建的设备作为这个队列的父对象</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre><span class=\"token comment\">// 在这个设备被销毁的同时，该队列也会被销毁，这样就不用担心队列结束的问题了</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>status <span class=\"token operator\">=</span> <span class=\"token function\">WdfIoQueueCreate</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>\tdevice<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>\t<span class=\"token operator\">&amp;</span>ioQueueConfig<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>\tqueueAttributes<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>\t<span class=\"token operator\">&amp;</span>queue</pre></td></tr><tr><td data-num=\"24\"></td><td><pre><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre><span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token function\">NT_SUCCESS</span><span class=\"token punctuation\">(</span>status<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>    <span class=\"token keyword\">return</span> status<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre><span class=\"token comment\">// 将指针 pQueueContext 指向刚刚生成的队列的扩展</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>pQueueContext <span class=\"token operator\">=</span> <span class=\"token function\">QueueGetExtension</span><span class=\"token punctuation\">(</span>queue<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre></pre></td></tr><tr><td data-num=\"32\"></td><td><pre><span class=\"token comment\">// 这里初始化队列扩展里的 DeviceExtension 项，将其</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre><span class=\"token comment\">// 设置为刚建立的设备拓展指针，这样以后在有队列的地方都</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre><span class=\"token comment\">// 可以轻松的获得这个队列对应的设备的设备扩展了</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>pQueueContext<span class=\"token operator\">-></span>DeviceExtension <span class=\"token operator\">=</span> pDeviceExtension<span class=\"token punctuation\">;</span></pre></td></tr></table></figure><h3 id=\"用户配置的初始化\"><a class=\"anchor\" href=\"#用户配置的初始化\">#</a> 用户配置的初始化</h3>\n<p>在设备和用来处理设备请求的队列都建立好了之后，接下来就需要初始化与内存盘相关的一些数据结构了。</p>\n<p>对于内存盘来说，在驱动层中就是以刚才建立的那个设备作为代表的，那么自然而然地，内存盘相应的数据结构也应该和这个设备相联系。</p>\n<p>在这里就使用了这个设备的设备扩展来存放这些数据结构的内容，具体而言，这个数据结构就是之前代码中的 <code>DEVICE_EXTENSION</code>  数据结构。</p>\n<p>同时为了给用户提供一些可配置的参数，在注册表中还开辟了一个键用来存放这些可配置参数，这些参数对应到驱动中就成为了一个 <code>DISK_INFO</code>  类型的数据结构，在 <code>DEVICE_EXTENSION</code>  中会有一个成员来表示它。下面先来认识一下这两个数据结构:</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">typedef</span> <span class=\"token keyword\">struct</span> <span class=\"token class-name\">_DISK_INFO</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token comment\">// 磁盘的大小，以 Byte (字节) 计算，所以我们的磁盘最大只有 4GB</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    ULONG   DiskSize<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token comment\">// 磁盘上根文件系统的进入节点</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    ULONG   RootDirEntries<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token comment\">// 磁盘的每个簇由多少个扇区组成</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    ULONG   SectorsPerCluster<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token comment\">// 磁盘的盘符</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    UNICODE_STRING DriveLetter<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token punctuation\">&#125;</span> DISK_INFO<span class=\"token punctuation\">,</span> <span class=\"token operator\">*</span>PDISK_INFO<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token keyword\">typedef</span> <span class=\"token keyword\">struct</span> <span class=\"token class-name\">_DEVICE_EXTENSION</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    <span class=\"token comment\">// 用来指向一块内存区域，作为内存盘的实际数据存储空间</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    PUCHAR              DiskImage<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    <span class=\"token comment\">// 用来存储内存盘的磁盘 Geometry</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    DISK_GEOMETRY       DiskGeometry<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    <span class=\"token comment\">// 我们自己定义的磁盘信息结构，在安装时存放在注册表中</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>    DISK_INFO           DiskRegInfo<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    <span class=\"token comment\">// 盘的符号链接名，这是真正的符号链接名</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>    UNICODE_STRING      SymbolicLink<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>    <span class=\"token comment\">// DiskRegInfo 中 DriveLetterBuffer 的存储空间，这是用户在注册表中指定的盘符</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>    WCHAR               DriveLetterBuffer<span class=\"token punctuation\">[</span>DRIVE_LETTER_BUFFER_SIZE<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>    <span class=\"token comment\">// SymbolicLink 的存储空间</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>    WCHAR               DosDeviceNameBuffer<span class=\"token punctuation\">[</span>DOS_DEVNAME_BUFFER_SIZE<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre><span class=\"token punctuation\">&#125;</span> DEVICE_EXTENSION<span class=\"token punctuation\">,</span> <span class=\"token operator\">*</span>PDEVICE_EXTENSION<span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>在了解了数据结构中各成员对象的用处之后，就可以开始进行这些数据结构的初始化工作了。</p>\n<p>首先需要去注册表中获取用户指定的信息，这里是通过自己实现的一个函数  <code>RamDiskQueryDiskRegParameters</code>  去获取的，这个函数的<em>第一个参数是注册表的路径</em>。<br />\n为了获取这个路径，首先通过  <code>WdfDeviceGetDriver</code>  从之前生成的设备中<em>获取到这个设备对应的驱动对象</em>，然后通过  <code>WdfDriverGetRegistryPath</code>  <em>从这个驱动对象中获取到相应的注册表路径</em>。<br />\n在这里使用的  <code>WdfDeviceGetDriver</code>  和  <code>WdfDriverGetRegistryPath</code>  都是 WDF 库提供的函数，它们的使用方法非常简单，作用也可以直接从函数名称中看出来，一个是通过 WDF 驱动的设备获取相应的驱动对象，而另一个是通过 WDF 驱动的驱动对象来获取注册表路径。</p>\n<p><code>RamDiskQueryDiskRegParameters</code>  函数的<em>第二个参数是一个结构体变量</em>，在这里将要向这个变量里面填写从注册表中获取的值。</p>\n<p><code>RamDiskQueryDiskRegParameters</code>  函数的具体实现比较简单，简单地认为在这个函数调用之后，  <code>pDeviceExtension→DiskRegInfo</code>  中的各成员变量就已经被初始化成了注册表中对应的值</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">// 将生成的设备的设备拓展中相应的 UNICODE_STRING 初始化</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>pDeviceExtension<span class=\"token operator\">-></span>DiskRegInfo<span class=\"token punctuation\">.</span>DriveLetter<span class=\"token punctuation\">.</span>Buffer <span class=\"token operator\">=</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>        <span class=\"token punctuation\">(</span>PWSTR<span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;</span>pDeviceExtension<span class=\"token operator\">-></span>DriveLetterBuffer<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>pDeviceExtension<span class=\"token operator\">-></span>DiskRegInfo<span class=\"token punctuation\">.</span>DriveLetter<span class=\"token punctuation\">.</span>MaximumLength <span class=\"token operator\">=</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>        <span class=\"token keyword\">sizeof</span><span class=\"token punctuation\">(</span>pDeviceExtension<span class=\"token operator\">-></span>DriveLetterBuffer<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token comment\">// 从系统为本驱动提供的注册表键中获取我们需要的信息</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token function\">RamDiskQueryDiskRegParameters</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>\t<span class=\"token function\">WdfDriverGetRegistryPath</span><span class=\"token punctuation\">(</span><span class=\"token function\">WdfDeviceGetDriver</span><span class=\"token punctuation\">(</span>device<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\t<span class=\"token operator\">&amp;</span>pDeviceExtension<span class=\"token operator\">-></span>DiskRegInfo</pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>从注册表中获取相应的参数只是初始化工作的第一步。由于这是一个使用内存来作为存储介质的模拟磁盘，因此需要分配出一定大小的内存空间来模拟磁盘空间，这个大小是由注册表中的磁盘大小参数所指定的，在以后的内容中，这块空间将被称为 Ramdisk 的磁盘镜像。</p>\n<p><em>这里需要特别说明的是，在 Windows 内核中，可以分配两种内存：一种是分页内存；另一种是非分页内存。分页内存的特点是它可能只是一个标识，实际存储的数据可能被放在磁盘上的页面文件中，在访问这个内存时系统会发出缺页中断，然后由复杂的页面管理机制将所缺的页面调入内存中。而非分页内存则相反，它永远在内存中，不会被换出到磁盘上。这样的特点也导致了分页内存可以分配得比较多，而非分页内存只能分配很少一部分。这里为了简单起见，全部分配非分页内存，这样的好处是在任何时候都不用担心要访问的地址数据是否真的在内存里，还是会引发复杂的缺页处理流程，这些流程将会导致需要在其他处理函数中作多方面的考虑。在分配内存的函数中还会出现一个内存的 TAG 值，这个值用来区分这个内存是谁分配的，在这里会将这个值赋成本驱动特殊的值，从而区别于其他的驱动所分配的内存。</em></p>\n<p>​在分配了内存之后，磁盘就有了存储空间，但是就好像任何新磁盘一样。这个磁盘需要被分区，格式化。需要我们自己去格式化操作，因为内核中是没有地方调用  <code>format</code>  命令的。具体的操作会在下面介绍。这里先知道  <code>RamDiskFormatDisk</code>  起的作用是把内存介质的磁盘格式化就可以了</p>\n<h3 id=\"链接给应用程序\"><a class=\"anchor\" href=\"#链接给应用程序\">#</a> 链接给应用程序</h3>\n<p>至此，程序建立了设备，建立了处理发往这个设备的队列，读取了用户的配置，并按照这个配置初始化了所需的内存空间和其他一些相关参数。</p>\n<p>接下来需要做的事情就是将它暴露给应用层以供使用。</p>\n<p>在 Windows 中的各盘符，例如 “C:”“D:” 实际上都是一个叫作符号链接的东西，应用层的代码不能够直接访问在内核中建立的设备，但是可以访问符号链接，所以在这里只需要用符号链接指向这个设备，便可以将对符号链接的访问指向这个设备了。</p>\n<p>这里所要做的是根据用户配置中选定的盘符去建立符号链接，将这个盘符和在这一节最开始所建立的符号链接联系起来。</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">// 分配用户指定大小的非分页内存，并使用我们自己的内存 TAG 值</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>pDeviceExtension<span class=\"token operator\">-></span>DiskImage <span class=\"token operator\">=</span> <span class=\"token function\">ExAllocatePoolWithTag</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>      NonPagedPool<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>      pDeviceExtension<span class=\"token operator\">-></span>DiskRegInfo<span class=\"token punctuation\">.</span>DiskSize<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>      RAMDISK_TAG</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>      <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  <span class=\"token comment\">// 下面的代码只有在内存分配成功时才会运行</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>pDeviceExtension<span class=\"token operator\">-></span>DiskImage<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>      UNICODE_STRING deviceName<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>      UNICODE_STRING win32Name<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>      <span class=\"token comment\">// 这里调用我们自己实现的函数去初始化磁盘</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>      <span class=\"token function\">RamDiskFormatDisk</span><span class=\"token punctuation\">(</span>pDeviceExtension<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>      status <span class=\"token operator\">=</span> STATUS_SUCCESS<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>      <span class=\"token comment\">// 初始化一个内容为 \"\\\\DosDevices\\\\\" 的 UNICODE_STRING 变量</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>      <span class=\"token function\">RtlInitUnicodeString</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>win32Name<span class=\"token punctuation\">,</span> DOS_DEVICE_NAME<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>      <span class=\"token comment\">// 初始化一个内容为 \"\\\\Device\\\\Ramdisk\" 的 UNICODE_STRING 变量</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>      <span class=\"token comment\">// 这个变量没有用处这里只是为了保持原文档的完整性</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>      <span class=\"token function\">RtlInitUnicodeString</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>deviceName<span class=\"token punctuation\">,</span> NT_DEVICE_NAME<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>      <span class=\"token comment\">// 在这里我们首先准备好用来存储符号链接名的 UNICODE_STRING 变量</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>      pDeviceExtension<span class=\"token operator\">-></span>SymbolicLink<span class=\"token punctuation\">.</span>Buffer <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>PWSTR<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>          <span class=\"token operator\">&amp;</span>pDeviceExtension<span class=\"token operator\">-></span>DosDeviceNameBuffer<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>      pDeviceExtension<span class=\"token operator\">-></span>SymbolicLink<span class=\"token punctuation\">.</span>MaximumLength <span class=\"token operator\">=</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>          <span class=\"token keyword\">sizeof</span><span class=\"token punctuation\">(</span>pDeviceExtension<span class=\"token operator\">-></span>DosDeviceNameBuffer<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>      pDeviceExtension<span class=\"token operator\">-></span>SymbolicLink<span class=\"token punctuation\">.</span>Length <span class=\"token operator\">=</span> win32Name<span class=\"token punctuation\">.</span>Length<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>      <span class=\"token comment\">// 将符号链接名的开头设置为 \"\\\\DosDevices\\\\\" ，这是所有符号链接共有的前缀</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>      <span class=\"token function\">RtlCopyUnicodeString</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>pDeviceExtension<span class=\"token operator\">-></span>SymbolicLink<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>win32Name<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>      <span class=\"token comment\">// 在上面赋值好的前缀后面连接我们从用户配置中读出来的用户指定的盘符</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>      <span class=\"token function\">RtlAppendUnicodeStringToString</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>pDeviceExtension<span class=\"token operator\">-></span>SymbolicLink<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>                                      <span class=\"token operator\">&amp;</span>pDeviceExtension<span class=\"token operator\">-></span>DiskRegInfo<span class=\"token punctuation\">.</span>DriveLetter<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>      <span class=\"token comment\">// 现在符号链接名已经准备好，我们调用 WDF 驱动框架模型提供的 WdfDeviceCreateSymbolicLink 函数来为之前生成的设备简历符号链接</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>      status <span class=\"token operator\">=</span> <span class=\"token function\">WdfDeviceCreateSymbolicLink</span><span class=\"token punctuation\">(</span>device<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>                                            <span class=\"token operator\">&amp;</span>pDeviceExtension<span class=\"token operator\">-></span>SymbolicLink<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>  <span class=\"token comment\">// 返回状态，函数完结</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>  <span class=\"token keyword\">return</span> status<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h3 id=\"小结\"><a class=\"anchor\" href=\"#小结\">#</a> 小结</h3>\n<p>到此为止，已经完整地分析了在  <code>Ramdisk</code>  驱动中  <code>EvtDriverDeviceAdd</code>  函数的具体实现。<strong>可以发现这个函数里面建立了设备对象，为了处理这个设备将要收到的各种请求，又建立了处理队列；同时由于对这个设备所需要处理的读 / 写和  <code>DeviceIoControl</code>  请求有自己的处理需求，因此没有使用系统默认的处理函数，而是注册了自己实现的 3 个处理函数。之后根据用户写在注册表中的配置参数初始化了一些相关属性，为设备存储数据准备好了内存，最后给设备建立了符号链接以便于应用层的代码访问。</strong></p>\n<p>至此，Ramdisk 的磁盘设备已经建立起来了，它在内核中代表了这个内存盘，而且由于这个设备已经暴露给了应用层的代码，各种各样的访问和请求必将接踵而至。<br />\n但是在分析如何处理这些请求之前，还需要先对磁盘卷的结构做一番介绍。</p>\n<h2 id=\"fat1216磁盘卷初始化\"><a class=\"anchor\" href=\"#fat1216磁盘卷初始化\">#</a> FAT12/16 磁盘卷初始化</h2>\n<h3 id=\"磁盘卷结构简介\"><a class=\"anchor\" href=\"#磁盘卷结构简介\">#</a> 磁盘卷结构简介</h3>\n<p>微软操作系统对磁盘的管理，包括分区的划分、每种文件系统的不同特性等。不过在这个驱动中，我们所面对的只是一个最简单的磁盘结构，即一个<em>分区基于 FAT12/16 的磁盘</em>。</p>\n<p>下面结合<strong>简单的磁盘结构</strong>和这个驱动的特性，对 FAT12/16 磁盘卷进行学习。</p>\n<p>Windows 磁盘卷首先继承了它所在磁盘的特性，这些特性是由硬件决定的，不可设置，不可更改。<br />\n这些特性包括如下内容。</p>\n<ol>\n<li>每扇区的字节数。扇区是磁盘读 / 写的基本单位，硬盘的物理设计导致它不能一次读 / 写一个字节，而是一次最少读 / 写一个扇区，现在几乎所有的硬盘扇区大小都是 512 字节。</li>\n<li>每磁道的扇区数。硬盘的盘片是圆形的，读者可以认为每个磁道都是一个圆圈，整个盘片被划分成了多个同心圆，即多个磁道。硬盘设计时规定每个磁道被划分成同样数目的扇区。</li>\n<li>每柱面的磁道数。硬盘不仅是由一个盘片组成的，当硬盘具有多个盘片时，读者可以认为所有盘片的同样位置的磁道组成了一个圆柱体，这就是一个柱面。这个参数实际上说明了硬盘的所有盘片加起来有多少个面（可能会遇见只有一个面的盘片，为了市场划分故意不在一个面上做磁性介质）。</li>\n<li>柱面数。表示硬盘的一个圆形盘片能够划分成多少个同心圆，这个数字随着硬盘技术的提高在不断地增大，因为磁盘的物理大小是固定的，那么柱面数越多就说明每个磁道越细，所需要的磁头分辨率也越高。</li>\n</ol>\n<p>这里可以参考《30 天制作操作系统》中的这张图：</p>\n<p><img data-src=\"image001.png\" alt=\"\" /></p>\n<p>磁盘结构是由制造过程中的物理结构决定的，而操作系统对磁盘的管理主要通过文件系统来实现，这是一种逻辑上的结构。<br />\n文件系统是建立在软件能够读 / 写磁盘任意扇区基础上的一种数据组织结构。在微软公司的操作系统中，常见的文件系统包括了 FAT12、FAT16、FAT32 和 NTFS 等。</p>\n<p>关于 FAT32 文件系统的详细说明可以参考其他资料，但是总体来说，FAT32 文件系统与 FAT12/16 文件系统的区别不是很大。</p>\n<p>至于 NTFS 文件系统，现在还没有一个完善的解决方案能够以第三方的代码来读 / 写它，也就是说，NTFS 文件系统的特性还没有被搞清楚，我们在任何时候都应该通过微软提供的文件系统驱动来读 / 写它，直到可信的第三方解决方案推出。</p>\n<p>在 FAT12/16 文件系统中，有几个参数需要了解一下。</p>\n<ul>\n<li>\n<p><strong>MBR</strong>。 MBR 是 Master Boot Record（主引导记录）的简称。<em>它位于整个磁盘的第一个扇区，大小正好是一个扇区的大小</em>，MBR 的起始处是一段程序，在 BIOS 的代码执行到最后时，BIOS 会将这段程序加载到内存中并开始执行。在这段程序的后面是一个硬盘分区表，<em>用于记录当前磁盘具体的分区信息</em>。由于 Ramdisk 驱动只是用来建立一个可用的磁盘卷，并不要求这个卷可以引导和具有其他一些特征，所以在 Ramdisk 的磁盘镜像中并不会看到 MBR 部分的存在，在这里将 Ramdisk 生成的磁盘卷当作一个分区即可。</p>\n</li>\n<li>\n<p><strong>DBR</strong>。 DBR 是 DOS Boot Record（操作系统引导记录）的简称。上面讲到过，在 MBR 的硬盘分区表中会记录每个分区的信息，包括起始位置等；而 DBR 就存在于这个起始位置指向的第一个扇区里，DBR 里面包括了有效的引导程序、厂商标志、描述数据区等。引导程序是一段用来加载真正操作系统的程序，在 DBR 的最开始是一个跳转指令，跳转到 DBR 后面一点的引导程序处。厂商标志又叫作 OEM 串，一般是由格式化程序所填写的。数据描述区又称为 BPB 的数据块，记录了分区的众多信息，这些信息用于系统在为这个逻辑盘建立文件系统时做初始参数，例如文件系统格式、根目录大小和簇大小等。作为文件系统的一个组成部分，DBR 是由操作系统的格式化程序建立的，在文件系统驱动操作任何一个磁盘卷时，这一部分的信息将被读取并作为文件系统在这个磁盘卷上的参数使用，所以在 Ramdisk 驱动中，DBR 部分是需要存在的。</p>\n</li>\n<li>\n<p><strong>FAT 区</strong>。 FAT 是 File Allocation Table（文件分配表）的简称。它位于 DBR 之后，并且以一式两份的形式连续保存。FAT 表实际上是一个链表，它的每个表项的编号都代表磁盘上的一个簇，每个表项的内容都是另一个簇的编号，而一条这样完整的链就代表了一个文件在磁盘上所占的所有的簇。FAT 表的第 0 项和第 1 项是被保留的，从第 2 项开始用来记录某个文件所在的位置。由上面内容可以知道，FAT 表的大小只和磁盘的大小及这个磁盘上的文件系统对每个簇的大小的定义相关。这里需要说明的是，FAT12 和 FAT16 的唯一区别就是一个 FAT 表的表项中能使用几位做存储空间，由于这个存储空间存储的就是另一个表项的索引值，所以这实际上就代表了表项个数的上限，换句话说，代表了这个文件系统中最大的簇的个数。如果用 12 个位来表示一个表项的索引值，那么这个索引值的上限就是 4096；而在 FAT16 文件系统中，最多可以有 65536 个簇。</p>\n</li>\n<li>\n<p><strong>根目录入口点</strong>。 上面说了 FAT 是多个链表的集合体，其中的每一条链代表了一个文件，但是这些链的起始点是如何确定的呢？这就要用到这里所说的根目录入口点了。多个根目录入口点形成了一个表，这个表紧跟着 FAT 表存储，这个表的每个表项代表了根目录下的一个文件或者一个目录，这个表项里面记载了很多相关的信息，例如文件或者目录的名字、属性和修改日期等，最重要的是记录了这个文件或者目录在 FAT 表中的起点，这样就可以通过查询 FAT 表找到这个文件或者目录的所有簇，进而获取所有的数据。而通过查询每个目录的目录项内容又可以知道这个目录下面存储的文件在 FAT 表中的对应位置，这样就可以遍历到磁盘上的所有文件了。</p>\n</li>\n</ul>\n<p>以上所说的磁盘结构和 FAT12/16 文件系统的一些结构在这个驱动中并不会全部用到。由于本驱动的目的只是用来演示，所以并不需要完善的磁盘特性，更何况这个磁盘每次开机之后才会建立起来，也不可能用它来进行引导，所以并不需要与之相关的数据和信息。在这里对这些知识能有所了解即可。</p>\n<h3 id=\"ramdisk对磁盘的初始化\"><a class=\"anchor\" href=\"#ramdisk对磁盘的初始化\">#</a> Ramdisk 对磁盘的初始化</h3>\n<p>在 Ramdisk 驱动中的  <code>EvtDriverDeviceAdd</code>  类函数里会调用  <code>RamDiskFormatDisk</code>  函数对所分配的用于做磁盘镜像的内存空间进行初始化，在简单了解了磁盘卷结构之后，来学习下这个函数是如何初始化这个磁盘映像空间的。</p>\n<p>首先来了解一下这个函数的本地变量声明，为了在分析过程中有所参照。</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">// 一个指向磁盘启动扇区的指针</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>PBOOT_SECTOR bootSector <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>PBOOT_SECTOR<span class=\"token punctuation\">)</span> devExt<span class=\"token operator\">-></span>DiskImage<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\">// 指向 FAT 第一个 FAT 表的指针</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>PUCHAR\t\tfirstFatSector<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token comment\">// 用于记录有多少个根目录日寇点</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>ULONG rootDirEntries<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token comment\">// 用于记录每个簇由多少扇区组成</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>ULONG sectorsPerCluster<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token comment\">// 用于记录 FAT 文件系统的类型，是 FAT12 还是 16</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>USHORT fatType<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token comment\">// 用于记录在 FAT 表里一共有多少个表项</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>USHORT fatEntries<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token comment\">// 用于记录一个 FAT 表需要占用多少个扇区来存储</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>USHORT fatSectorCnt<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token comment\">// 用于指向第一个根目录入口点</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>PDIR_ENTRY rootDir<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token comment\">// 用于确定这个函数是可以存取分页内存的</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre><span class=\"token function\">PAGED_CODE</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre><span class=\"token comment\">// 用于确定这个盘的引导扇区的大小确实是一个扇区大小</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre><span class=\"token function\">ASSERT</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">sizeof</span><span class=\"token punctuation\">(</span>BOOT_SECTOR<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> <span class=\"token number\">512</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre><span class=\"token comment\">// 用于确定我们操作的磁盘不是一个不可用的指针</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre><span class=\"token function\">ASSERT</span><span class=\"token punctuation\">(</span>devExt<span class=\"token operator\">-></span>DiskImage <span class=\"token operator\">!=</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre><span class=\"token comment\">// 清空磁盘镜像</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre><span class=\"token function\">RtlZeroMemory</span><span class=\"token punctuation\">(</span>devExt<span class=\"token operator\">-></span>DiskImage<span class=\"token punctuation\">,</span>devExt<span class=\"token operator\">-></span>DiskRegInfo<span class=\"token punctuation\">.</span>DiskSize<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>接下来格式化函数开始初始化一个保存在磁盘设备的设备扩展中的数据结构 <code>DiskGeometry</code> 。从名字就可以看出，这个数据结构保存了很多和磁盘物理结构相关的信息，也就是前面所说的磁盘特性。</p>\n<p>这个数据结构是 WinDDK 所定义好的，几乎适用于所有的磁盘。看一下这个数据结构的定义。</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">typedef</span> struce _DISK_GEOMETRY<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token comment\">// 有多少个柱面</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    LARGE_INTEGER Cylinders<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token comment\">// 磁盘介质的类型</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    MEDIA_TYPE MediaType<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token comment\">// 每个柱面有多少磁道，也就是有多少个盘片</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    ULONG TracksPerCylinder<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token comment\">// 每个磁道有多少扇区</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    ULONG SectorsPerTrack<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    <span class=\"token comment\">// 每个扇区有多少字节</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    ULONG BytePerSector<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token punctuation\">&#125;</span>DISK_GEOMETRY<span class=\"token punctuation\">,</span><span class=\"token operator\">*</span>PDISK_GEOMETRY<span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>这个数据结构被放在了磁盘设备的设备扩展中，在今后的很多场合中都作为磁盘的参数被访问。<br />\n接下来看看是如何初始化这个结构体的：</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">// 每个扇区有 512 个字节</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>devExt<span class=\"token operator\">-></span>DiskGeometry<span class=\"token punctuation\">.</span>BytesPerSector <span class=\"token operator\">=</span> <span class=\"token number\">512</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\">// 每个磁道有 32 个扇区</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>devExt<span class=\"token operator\">-></span>DiskGeometry<span class=\"token punctuation\">.</span>SectorsPerTrack <span class=\"token operator\">=</span> <span class=\"token number\">32</span><span class=\"token punctuation\">;</span>     </pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token comment\">// 每个柱面有 2 个磁道</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>devExt<span class=\"token operator\">-></span>DiskGeometry<span class=\"token punctuation\">.</span>TracksPerCylinder <span class=\"token operator\">=</span> <span class=\"token number\">2</span><span class=\"token punctuation\">;</span>    </pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token comment\">// 柱面数目有磁盘的总容量计算得到</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>devExt<span class=\"token operator\">-></span>DiskGeometry<span class=\"token punctuation\">.</span>Cylinders<span class=\"token punctuation\">.</span>QuadPart <span class=\"token operator\">=</span> devExt<span class=\"token operator\">-></span>DiskRegInfo<span class=\"token punctuation\">.</span>DiskSize <span class=\"token operator\">/</span> <span class=\"token number\">512</span> <span class=\"token operator\">/</span> <span class=\"token number\">32</span> <span class=\"token operator\">/</span> <span class=\"token number\">2</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token comment\">// 磁盘的介质类型使我们自己定义的 RAMDISK_MEDIA_TYPE</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>devExt<span class=\"token operator\">-></span>DiskGeometry<span class=\"token punctuation\">.</span>MediaType <span class=\"token operator\">=</span> RAMDISK_MEDIA_TYPE<span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>在初始化了磁盘的物理参数之后，这里初始化一个文件系统和磁盘相关的参数 ——<strong> 根目录入口点数</strong>，这个参数决定了根目录中能够存在多少个文件和子目录。还要初始化的还有每个簇由多少个扇区组成，这是根据用户指定的数目来初始化的。</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">// 根据用户指定的值对用户的根目录项的数据进行初始化</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>rootDirEntries <span class=\"token operator\">=</span> devExt<span class=\"token operator\">-></span>DiskRegInfo<span class=\"token punctuation\">.</span>RootDirEntries<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\">// 每个簇有多少扇区的初始化</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>sectorsPerCluster <span class=\"token operator\">=</span> devExt<span class=\"token operator\">-></span>DiskRegInfo<span class=\"token punctuation\">.</span>SectorsPerCluster<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token comment\">// 由于根目录入口点只是用 32 个字节，，但是最少占用一个扇区，这里为了充分利用空间，在用户指定的数目不合适时会修正这个数目，以使扇区空间得到充分的利用</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>rootDirEntries <span class=\"token operator\">&amp;</span> <span class=\"token punctuation\">(</span>DIR_ENTRIES_PER_SECTOR <span class=\"token operator\">-</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    rootDirEntries <span class=\"token operator\">=</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>        <span class=\"token punctuation\">(</span>rootDirEntries <span class=\"token operator\">+</span> <span class=\"token punctuation\">(</span>DIR_ENTRIES_PER_SECTOR <span class=\"token operator\">-</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>            <span class=\"token operator\">~</span> <span class=\"token punctuation\">(</span>DIR_ENTRIES_PER_SECTOR <span class=\"token operator\">-</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>在格式化函数的开头可以看到，  <code>bootSector</code>  指针直接指向了磁盘镜像的首地址，联系之前讲解过的磁盘和文件系统结构，通过之前的说明可以发现在磁盘镜像最前面存储的应该是这个分区的 DBR，也就是说 ，  <code>bootSector</code>  指针指向的是这个磁盘卷的 DBR。</p>\n<p>下面看一下 <code>bootSector</code>  结构体的实际数据结构，值得注意的是，这也是标准 DBR 的结构。</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">pragma</span> <span class=\"token expression\"><span class=\"token function\">pack</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span></span></span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">typedef</span> <span class=\"token keyword\">struct</span>  <span class=\"token class-name\">_BOOT_SECTOR</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    UCHAR       bsJump<span class=\"token punctuation\">[</span><span class=\"token number\">3</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>          <span class=\"token comment\">// x86 jmp instruction, checked by FS</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    CCHAR       bsOemName<span class=\"token punctuation\">[</span><span class=\"token number\">8</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>       <span class=\"token comment\">// OEM name of formatter</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    USHORT      bsBytesPerSec<span class=\"token punctuation\">;</span>      <span class=\"token comment\">// Bytes per Sector</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    UCHAR       bsSecPerClus<span class=\"token punctuation\">;</span>       <span class=\"token comment\">// Sectors per Cluster</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    USHORT      bsResSectors<span class=\"token punctuation\">;</span>       <span class=\"token comment\">// Reserved Sectors</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    UCHAR       bsFATs<span class=\"token punctuation\">;</span>             <span class=\"token comment\">// Number of FATs - we always use 1</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    USHORT      bsRootDirEnts<span class=\"token punctuation\">;</span>      <span class=\"token comment\">// Number of Root Dir Entries</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    USHORT      bsSectors<span class=\"token punctuation\">;</span>          <span class=\"token comment\">// Number of Sectors</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    UCHAR       bsMedia<span class=\"token punctuation\">;</span>            <span class=\"token comment\">// Media type - we use RAMDISK_MEDIA_TYPE</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    USHORT      bsFATsecs<span class=\"token punctuation\">;</span>          <span class=\"token comment\">// Number of FAT sectors</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    USHORT      bsSecPerTrack<span class=\"token punctuation\">;</span>      <span class=\"token comment\">// Sectors per Track - we use 32</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    USHORT      bsHeads<span class=\"token punctuation\">;</span>            <span class=\"token comment\">// Number of Heads - we use 2</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    ULONG       bsHiddenSecs<span class=\"token punctuation\">;</span>       <span class=\"token comment\">// Hidden Sectors - we set to 0</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    ULONG       bsHugeSectors<span class=\"token punctuation\">;</span>      <span class=\"token comment\">// Number of Sectors if > 32 MB size</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>    UCHAR       bsDriveNumber<span class=\"token punctuation\">;</span>      <span class=\"token comment\">// Drive Number - not used</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    UCHAR       bsReserved1<span class=\"token punctuation\">;</span>        <span class=\"token comment\">// Reserved</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>    UCHAR       bsBootSignature<span class=\"token punctuation\">;</span>    <span class=\"token comment\">// New Format Boot Signature - 0x29</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>    ULONG       bsVolumeID<span class=\"token punctuation\">;</span>         <span class=\"token comment\">// VolumeID - set to 0x12345678</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>    CCHAR       bsLabel<span class=\"token punctuation\">[</span><span class=\"token number\">11</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>        <span class=\"token comment\">// Label - set to RamDisk</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>    CCHAR       bsFileSystemType<span class=\"token punctuation\">[</span><span class=\"token number\">8</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span><span class=\"token comment\">// File System Type - FAT12 or FAT16</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>    CCHAR       bsReserved2<span class=\"token punctuation\">[</span><span class=\"token number\">448</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>   <span class=\"token comment\">// Reserved</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>    UCHAR       bsSig2<span class=\"token punctuation\">[</span><span class=\"token number\">2</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>          <span class=\"token comment\">// Originial Boot Signature - 0x55, 0xAA</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre><span class=\"token punctuation\">&#125;</span>   BOOT_SECTOR<span class=\"token punctuation\">,</span> <span class=\"token operator\">*</span>PBOOT_SECTOR<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>……</pre></td></tr><tr><td data-num=\"29\"></td><td><pre></pre></td></tr><tr><td data-num=\"30\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">pragma</span> <span class=\"token expression\"><span class=\"token function\">pack</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></span></span></pre></td></tr></table></figure><p>在谭文一书中对各个成员的中文解释为：</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">// 跳转指令，跳转到 DBR 中的引导程序</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>UCHAR bsJump<span class=\"token punctuation\">[</span><span class=\"token number\">3</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\">// 该卷的 OEM 名称</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>CCHAR bsOemName<span class=\"token punctuation\">[</span><span class=\"token number\">8</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token comment\">// 每个扇区有多少字节</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>USHORT bsBytesPerSec<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token comment\">// 每个簇有多少扇区</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>UCHAR bsSecPerClus<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token comment\">// 保留扇区数据，指的是第一个 FAT 表开始之前的扇区数，也包括 DBR 本身</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>USHORT bsResSector<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token comment\">// 这个卷有多少个 FAT 表</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>USHORT bsFATs<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token comment\">// 这个卷的根目录入口点有几个</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>USHORT bsRootEntrents<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token comment\">// 这个卷一共有多少个扇区，如果大于 65535 个扇区，则该字段为 0</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>USHORT bsSectors<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token comment\">// 这个卷的介质类型</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>UCHAR bsMedia<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre><span class=\"token comment\">// 每个 FAT 表占用多少个扇区</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>USHORT bsFATsecs<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre><span class=\"token comment\">// 每个磁道有多少个扇区</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>USHORT bsSecPerTrack<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre><span class=\"token comment\">// 有多少个磁头</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>USHORT bsHeads<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre><span class=\"token comment\">// 有多少个隐藏扇区</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>ULONG bsHiddenSecs<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre><span class=\"token comment\">// 一个卷超过 65535 个扇区时，会使用这个字段来说明总扇区数</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>ULONG bsHugeSectors<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre><span class=\"token comment\">// 驱动器编号</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>UCHAR bsDriverNumber<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre><span class=\"token comment\">// 保留字段</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>UCHAR bsReserved1<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre><span class=\"token comment\">// 磁盘扩展引导区标签，Windows 要求这个标签为 0x28 或者 0x29</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>UCHAR bsBootSignature<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre><span class=\"token comment\">// 磁盘卷 ID</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>ULONG bsVolumeID<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre><span class=\"token comment\">// 磁盘卷标</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>CCHAR bsLabel<span class=\"token punctuation\">[</span><span class=\"token number\">11</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre><span class=\"token comment\">// 磁盘上的文件系统类型</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>CCHAR bsFileSystemType<span class=\"token punctuation\">[</span><span class=\"token number\">8</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre><span class=\"token comment\">// 保留字段</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>CCHAR bsReserved2<span class=\"token punctuation\">[</span><span class=\"token number\">448</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre><span class=\"token comment\">//DBR 结束签名</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>UCHAR bsSig2<span class=\"token punctuation\">[</span><span class=\"token number\">2</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>了解了这个结构体后就要了解如何初始化这个结构体了。初始化这个数据结构是通过向磁盘镜像的起始位置填充指定数据来完成的。</p>\n<p>在下面的程序段中可以看到，对于 FAT12 和 FAT16 相同的结构体成员是如何初始化的。</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\">// We need to have the 0xeb and 0x90 since this is one of the checks the file system recognizer uses</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\">// 我们需要 0xeb 和 0x90，因为这是文件系统识别器使用的检查之一</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token comment\">// 对一开始的跳转指令成员填入硬编码，这是 windows 系统指定的</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>bootSector<span class=\"token operator\">-></span>bsJump<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token number\">0xeb</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>bootSector<span class=\"token operator\">-></span>bsJump<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token number\">0x3c</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>bootSector<span class=\"token operator\">-></span>bsJump<span class=\"token punctuation\">[</span><span class=\"token number\">2</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token number\">0x90</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token comment\">// Set OemName to \"RajuRam \"</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token comment\">// NOTE: Fill all 8 characters, eg. sizeof(bootSector->bsOemName);</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token comment\">// 注：填写全部 8 个字符，</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token comment\">// OEM 名称成员，本驱动的作者填入了他的名字，我们可以填写任意名称</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>bootSector<span class=\"token operator\">-></span>bsOemName<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token string\">'R'</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>bootSector<span class=\"token operator\">-></span>bsOemName<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token string\">'a'</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>bootSector<span class=\"token operator\">-></span>bsOemName<span class=\"token punctuation\">[</span><span class=\"token number\">2</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token string\">'j'</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>bootSector<span class=\"token operator\">-></span>bsOemName<span class=\"token punctuation\">[</span><span class=\"token number\">3</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token string\">'u'</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>bootSector<span class=\"token operator\">-></span>bsOemName<span class=\"token punctuation\">[</span><span class=\"token number\">4</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token string\">'R'</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>bootSector<span class=\"token operator\">-></span>bsOemName<span class=\"token punctuation\">[</span><span class=\"token number\">5</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token string\">'a'</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>bootSector<span class=\"token operator\">-></span>bsOemName<span class=\"token punctuation\">[</span><span class=\"token number\">6</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token string\">'m'</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>bootSector<span class=\"token operator\">-></span>bsOemName<span class=\"token punctuation\">[</span><span class=\"token number\">7</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token string\">' '</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre><span class=\"token comment\">// 每个扇区有多少个字节，这个成员的数值直接取自之前初始化的磁盘信息数据结构</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>bootSector<span class=\"token operator\">-></span>bsBytesPerSec <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>SHORT<span class=\"token punctuation\">)</span>devExt<span class=\"token operator\">-></span>DiskGeometry<span class=\"token punctuation\">.</span>BytesPerSector<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre><span class=\"token comment\">// 这个卷只有一个保留扇区，既 DBR 本身</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>bootSector<span class=\"token operator\">-></span>bsResSectors  <span class=\"token operator\">=</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre><span class=\"token comment\">// 和正常的卷不同，为了节省空间，我们只放一份 FAT 表，而不是通常的两份</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>bootSector<span class=\"token operator\">-></span>bsFATs        <span class=\"token operator\">=</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre><span class=\"token comment\">// 根目录入口点数由之前的计算得知</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>bootSector<span class=\"token operator\">-></span>bsRootDirEnts <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>USHORT<span class=\"token punctuation\">)</span>rootDirEntries<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre><span class=\"token comment\">// 这个磁盘的总扇区书有磁盘总大小和每个扇区的字节数计算得到</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>bootSector<span class=\"token operator\">-></span>bsSectors     <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>USHORT<span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span>devExt<span class=\"token operator\">-></span>DiskRegInfo<span class=\"token punctuation\">.</span>DiskSize <span class=\"token operator\">/</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>                                      devExt<span class=\"token operator\">-></span>DiskGeometry<span class=\"token punctuation\">.</span>BytesPerSector<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre><span class=\"token comment\">// 这个磁盘的介质类型由之前初始化的磁盘信息得到</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>bootSector<span class=\"token operator\">-></span>bsMedia       <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>UCHAR<span class=\"token punctuation\">)</span>devExt<span class=\"token operator\">-></span>DiskGeometry<span class=\"token punctuation\">.</span>MediaType<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre><span class=\"token comment\">// 每个簇有多少个扇区由之前的计算初始化得到</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>bootSector<span class=\"token operator\">-></span>bsSecPerClus  <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>UCHAR<span class=\"token punctuation\">)</span>sectorsPerCluster<span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>接下来开始计算这个磁盘 FAT 表所占用的空间。</p>\n<p>FAT 表里面存储的是一个将很多簇串联起来的链表，那么 FAT 表的表项数量就是磁盘上实际用来存储数据的簇的数量，而这个簇的数量又是由磁盘总扇区数减去用来存储其他数据的扇区数之后除以每个簇的扇区数得到的。</p>\n<p>下面看一下在实际程序中是如何计算的。</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">// FAT 表的表项数目是总扇区数减去保留的扇区数，再减去根目录入口点占据的扇区数，再除以每簇占据的扇区数得到簇的数量</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\">// 最后 + 2 因为 FAT 表的前两项是保留的</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>fatEntries <span class=\"token operator\">=</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>        <span class=\"token punctuation\">(</span>bootSector<span class=\"token operator\">-></span>bsSectors <span class=\"token operator\">-</span> bootSector<span class=\"token operator\">-></span>bsResSectors <span class=\"token operator\">-</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>            bootSector<span class=\"token operator\">-></span>bsRootDirEnts <span class=\"token operator\">/</span> DIR_ENTRIES_PER_SECTOR<span class=\"token punctuation\">)</span> <span class=\"token operator\">/</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>                bootSector<span class=\"token operator\">-></span>bsSecPerClus <span class=\"token operator\">+</span> <span class=\"token number\">2</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p><strong>根据这个表项数量首先可以决定到底使用 FAT12 还是 FAT16 文件系统</strong>。<br />\n在决定了使用哪种文件系统之后，就可以算出每个 FAT 表的表项需要占用多少空间，进而算出整个 FAT 表所占用的扇区数。在实际的计算过程中还需要做一些小修正，这是因为在考虑了 FAT 表占用的空间之后，总的 FAT 表的表项数目可能有一些小出入。</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">// 如果 FAT 表的表项数大于 4087，就使用 FAT16 文件系统，反之使用 FAT12 文件系统</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>fatEntries <span class=\"token operator\">></span> <span class=\"token number\">4087</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>        fatType <span class=\"token operator\">=</span>  <span class=\"token number\">16</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>        <span class=\"token comment\">// 做修正</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>        fatSectorCnt <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>fatEntries <span class=\"token operator\">*</span> <span class=\"token number\">2</span> <span class=\"token operator\">+</span> <span class=\"token number\">511</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">/</span> <span class=\"token number\">512</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>        fatEntries   <span class=\"token operator\">=</span> fatEntries <span class=\"token operator\">+</span> fatSectorCnt<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>        fatSectorCnt <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>fatEntries <span class=\"token operator\">*</span> <span class=\"token number\">2</span> <span class=\"token operator\">+</span> <span class=\"token number\">511</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">/</span> <span class=\"token number\">512</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token keyword\">else</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>        fatType <span class=\"token operator\">=</span>  <span class=\"token number\">12</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>        <span class=\"token comment\">// 做修正</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>        fatSectorCnt <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>fatEntries <span class=\"token operator\">*</span> <span class=\"token number\">3</span> <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">/</span> <span class=\"token number\">2</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> <span class=\"token number\">511</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">/</span> <span class=\"token number\">512</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>        fatEntries   <span class=\"token operator\">=</span> fatEntries <span class=\"token operator\">+</span> fatSectorCnt<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>        fatSectorCnt <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>fatEntries <span class=\"token operator\">*</span> <span class=\"token number\">3</span> <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">/</span> <span class=\"token number\">2</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> <span class=\"token number\">511</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">/</span> <span class=\"token number\">512</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>在上面的计算过程之后获得了文件系统的类型和 FAT 表需要占用的扇区数目。</p>\n<p>下面可以接着初始化 DBR 的数据结构了。</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">// 初始化 FAT 表所占用的分区数</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>bootSector<span class=\"token operator\">-></span>bsFATsecs       <span class=\"token operator\">=</span> fatSectorCnt<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\">// 初始化 DBR 中每个磁道的扇区数</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>bootSector<span class=\"token operator\">-></span>bsSecPerTrack   <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>USHORT<span class=\"token punctuation\">)</span>devExt<span class=\"token operator\">-></span>DiskGeometry<span class=\"token punctuation\">.</span>SectorsPerTrack<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token comment\">// 初始化磁头数，也就是每个柱面的磁道数</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>bootSector<span class=\"token operator\">-></span>bsHeads         <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>USHORT<span class=\"token punctuation\">)</span>devExt<span class=\"token operator\">-></span>DiskGeometry<span class=\"token punctuation\">.</span>TracksPerCylinder<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token comment\">// 初始化启动签名，Windows 要求是 0x28 或 0x29</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>bootSector<span class=\"token operator\">-></span>bsBootSignature <span class=\"token operator\">=</span> <span class=\"token number\">0x29</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token comment\">// 随便填写一个卷 ID</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>bootSector<span class=\"token operator\">-></span>bsVolumeID      <span class=\"token operator\">=</span> <span class=\"token number\">0x12345678</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token comment\">// 将卷标设置为 “RamDisk”</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>bootSector<span class=\"token operator\">-></span>bsLabel<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span>  <span class=\"token operator\">=</span> <span class=\"token string\">'R'</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>bootSector<span class=\"token operator\">-></span>bsLabel<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span>  <span class=\"token operator\">=</span> <span class=\"token string\">'a'</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>bootSector<span class=\"token operator\">-></span>bsLabel<span class=\"token punctuation\">[</span><span class=\"token number\">2</span><span class=\"token punctuation\">]</span>  <span class=\"token operator\">=</span> <span class=\"token string\">'m'</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>bootSector<span class=\"token operator\">-></span>bsLabel<span class=\"token punctuation\">[</span><span class=\"token number\">3</span><span class=\"token punctuation\">]</span>  <span class=\"token operator\">=</span> <span class=\"token string\">'D'</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>bootSector<span class=\"token operator\">-></span>bsLabel<span class=\"token punctuation\">[</span><span class=\"token number\">4</span><span class=\"token punctuation\">]</span>  <span class=\"token operator\">=</span> <span class=\"token string\">'i'</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>bootSector<span class=\"token operator\">-></span>bsLabel<span class=\"token punctuation\">[</span><span class=\"token number\">5</span><span class=\"token punctuation\">]</span>  <span class=\"token operator\">=</span> <span class=\"token string\">'s'</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>bootSector<span class=\"token operator\">-></span>bsLabel<span class=\"token punctuation\">[</span><span class=\"token number\">6</span><span class=\"token punctuation\">]</span>  <span class=\"token operator\">=</span> <span class=\"token string\">'k'</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>bootSector<span class=\"token operator\">-></span>bsLabel<span class=\"token punctuation\">[</span><span class=\"token number\">7</span><span class=\"token punctuation\">]</span>  <span class=\"token operator\">=</span> <span class=\"token string\">' '</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>bootSector<span class=\"token operator\">-></span>bsLabel<span class=\"token punctuation\">[</span><span class=\"token number\">8</span><span class=\"token punctuation\">]</span>  <span class=\"token operator\">=</span> <span class=\"token string\">' '</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>bootSector<span class=\"token operator\">-></span>bsLabel<span class=\"token punctuation\">[</span><span class=\"token number\">9</span><span class=\"token punctuation\">]</span>  <span class=\"token operator\">=</span> <span class=\"token string\">' '</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>bootSector<span class=\"token operator\">-></span>bsLabel<span class=\"token punctuation\">[</span><span class=\"token number\">10</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token string\">' '</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre></pre></td></tr><tr><td data-num=\"25\"></td><td><pre><span class=\"token comment\">// 根据我们之前计算得出的结果来悬着到底是 FAT12 还是 FAT16 文件系统</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>bootSector<span class=\"token operator\">-></span>bsFileSystemType<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token string\">'F'</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>bootSector<span class=\"token operator\">-></span>bsFileSystemType<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token string\">'A'</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>bootSector<span class=\"token operator\">-></span>bsFileSystemType<span class=\"token punctuation\">[</span><span class=\"token number\">2</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token string\">'T'</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>bootSector<span class=\"token operator\">-></span>bsFileSystemType<span class=\"token punctuation\">[</span><span class=\"token number\">3</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token string\">'1'</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>bootSector<span class=\"token operator\">-></span>bsFileSystemType<span class=\"token punctuation\">[</span><span class=\"token number\">4</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token string\">'?'</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>bootSector<span class=\"token operator\">-></span>bsFileSystemType<span class=\"token punctuation\">[</span><span class=\"token number\">5</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token string\">' '</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>bootSector<span class=\"token operator\">-></span>bsFileSystemType<span class=\"token punctuation\">[</span><span class=\"token number\">6</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token string\">' '</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>bootSector<span class=\"token operator\">-></span>bsFileSystemType<span class=\"token punctuation\">[</span><span class=\"token number\">7</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token string\">' '</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>bootSector<span class=\"token operator\">-></span>bsFileSystemType<span class=\"token punctuation\">[</span><span class=\"token number\">4</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span> fatType <span class=\"token operator\">==</span> <span class=\"token number\">16</span> <span class=\"token punctuation\">)</span> <span class=\"token operator\">?</span> <span class=\"token string\">'6'</span> <span class=\"token operator\">:</span> <span class=\"token string\">'2'</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre><span class=\"token comment\">// 签署 DBR 最后的标志，0x55AA</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>bootSector<span class=\"token operator\">-></span>bsSig2<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token number\">0x55</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>bootSector<span class=\"token operator\">-></span>bsSig2<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token number\">0xAA</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>DBR 初始化完毕。</p>\n<p>在 FAT12/16 文件系统中，DBR 之后紧接着的是 FAT 表，对于 FAT 表的初始化很简单，只需要在 FAT 表的第 1 个表项内填写介质标识即可。同时要注意的是，FAT12 和 FAT16 的表项长度不同</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">// 定位到 FAT 表的起始点，这里的定位方式是利用了 DBR 只有一个扇区这一条件</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>firstFatSector    <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>PUCHAR<span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span>bootSector <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\">// 填写介质类型标识</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>firstFatSector<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>UCHAR<span class=\"token punctuation\">)</span>devExt<span class=\"token operator\">-></span>DiskGeometry<span class=\"token punctuation\">.</span>MediaType<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>firstFatSector<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token number\">0xFF</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>firstFatSector<span class=\"token punctuation\">[</span><span class=\"token number\">2</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token number\">0xFF</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token comment\">// 注意如果是 FAT16，那么每个 FAT 表的表项是 4 个字节</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>fatType <span class=\"token operator\">==</span> <span class=\"token number\">16</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    firstFatSector<span class=\"token punctuation\">[</span><span class=\"token number\">3</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token number\">0xFF</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>在 FAT 表之后，就是根目录入口点了。</p>\n<p>在 FAT12/16 文件系统中，根目录入口点的数据结构定义如下：</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">pragma</span> <span class=\"token expression\"><span class=\"token function\">pack</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span></span></span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">typedef</span> <span class=\"token keyword\">struct</span>  <span class=\"token class-name\">_DIR_ENTRY</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  <span class=\"token comment\">// 文件名</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  UCHAR       deName<span class=\"token punctuation\">[</span><span class=\"token number\">8</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>          <span class=\"token comment\">// File Name</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  <span class=\"token comment\">// 文件扩展名</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  UCHAR       deExtension<span class=\"token punctuation\">[</span><span class=\"token number\">3</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>     <span class=\"token comment\">// File Extension</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  <span class=\"token comment\">// 文件属性</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  UCHAR       deAttributes<span class=\"token punctuation\">;</span>       <span class=\"token comment\">// File Attributes</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  <span class=\"token comment\">// 系统保留</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  UCHAR       deReserved<span class=\"token punctuation\">;</span>         <span class=\"token comment\">// Reserved</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>  <span class=\"token comment\">// 文件建立的时间</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>  USHORT      deTime<span class=\"token punctuation\">;</span>             <span class=\"token comment\">// File Time</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>  <span class=\"token comment\">// 文件建立的日期</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>  USHORT      deDate<span class=\"token punctuation\">;</span>             <span class=\"token comment\">// File Date</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>  <span class=\"token comment\">// 文件的第一个簇的编号</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>  USHORT      deStartCluster<span class=\"token punctuation\">;</span>     <span class=\"token comment\">// First Cluster of file</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>  <span class=\"token comment\">// 文件大小</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>  ULONG       deFileSize<span class=\"token punctuation\">;</span>         <span class=\"token comment\">// File Length</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre><span class=\"token punctuation\">&#125;</span>DIR_ENTRY<span class=\"token punctuation\">,</span> <span class=\"token operator\">*</span>PDIR_ENTRY<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre></pre></td></tr><tr><td data-num=\"23\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">pragma</span> <span class=\"token expression\"><span class=\"token function\">pack</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></span></span></pre></td></tr></table></figure><p>在 FAT12/16 文件系统中，通常第一个根目录入口点存储了一个最终被作为卷标的目录入口点，这里将其初始化，在这之后，这个磁盘卷就算是被格式化完毕了，也就可以拿来使用了。</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">// 由于紧跟着 FAT 表，所以根目录入口点的表的起始位置很容易定位</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>rootDir <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>PDIR_ENTRY<span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span>bootSector <span class=\"token operator\">+</span> <span class=\"token number\">1</span> <span class=\"token operator\">+</span> fatSectorCnt<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\">// 初始化卷标</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>rootDir<span class=\"token operator\">-></span>deName<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token string\">'M'</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>rootDir<span class=\"token operator\">-></span>deName<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token string\">'S'</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>rootDir<span class=\"token operator\">-></span>deName<span class=\"token punctuation\">[</span><span class=\"token number\">2</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token string\">'-'</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>rootDir<span class=\"token operator\">-></span>deName<span class=\"token punctuation\">[</span><span class=\"token number\">3</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token string\">'R'</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>rootDir<span class=\"token operator\">-></span>deName<span class=\"token punctuation\">[</span><span class=\"token number\">4</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token string\">'A'</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>rootDir<span class=\"token operator\">-></span>deName<span class=\"token punctuation\">[</span><span class=\"token number\">5</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token string\">'M'</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>rootDir<span class=\"token operator\">-></span>deName<span class=\"token punctuation\">[</span><span class=\"token number\">6</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token string\">'D'</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>rootDir<span class=\"token operator\">-></span>deName<span class=\"token punctuation\">[</span><span class=\"token number\">7</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token string\">'R'</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token comment\">// Set device extension name to \"IVE\"</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token comment\">// NOTE: Fill all 3 characters, eg. sizeof(rootDir->deExtension);</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>rootDir<span class=\"token operator\">-></span>deExtension<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token string\">'I'</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>rootDir<span class=\"token operator\">-></span>deExtension<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token string\">'V'</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>rootDir<span class=\"token operator\">-></span>deExtension<span class=\"token punctuation\">[</span><span class=\"token number\">2</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token string\">'E'</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre><span class=\"token comment\">// 将这个入口点的属性设置为卷标属性</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>rootDir<span class=\"token operator\">-></span>deAttributes <span class=\"token operator\">=</span> DIR_ATTR_VOLUME<span class=\"token punctuation\">;</span></pre></td></tr></table></figure><h2 id=\"驱动中的请求处理\"><a class=\"anchor\" href=\"#驱动中的请求处理\">#</a> 驱动中的请求处理</h2>\n<p><strong>WDF 驱动框架会将所有发往之前建立的磁盘设备的请求都排队放入已经建立的队列中，而在放入队列后绝大多数请求都得到了合适的处理</strong>，由于我们对读 / 写和 DeviceIoControl 请求注册了回调函数，所以队列会将这些请求交给注册的回调函数去处理。</p>\n<p>回调函数在收到请求之后，只能执行下面列举的 4 种操作中的一种，但是不能够忽略这个请求。</p>\n<p>这 4 种操作如下。</p>\n<ol>\n<li>重新排队。回调函数可以把这个请求放到另一个队列里去等待其他的处理函数处理。</li>\n<li>完成请求。回调函数可以对这个请求做自己的一些处理，并且在处理完毕之后完成它。这也是功能性驱动最常见的一种处理方式。</li>\n<li>撤销请求。回调函数可以要求撤销这个请求。</li>\n<li>转发请求。回调函数可以把这个请求转发给其他设备。</li>\n</ol>\n<p>​在 Windows 系统当中，设备之间是一种层叠的关系，在这个磁盘设备之上还会有文件系统设备，一般应用程序的访问都应该是访问文件系统设备，而文件系统设备会负责做文件系统方面的维护。比如对 FAT 表的维护、对文件的读写等，而这些操作最终都会转换成对磁盘的读写发往磁盘设备。</p>\n<h3 id=\"读写请求\"><a class=\"anchor\" href=\"#读写请求\">#</a> 读 / 写请求</h3>\n<p>读 / 写请求的回调函数原型如下：</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>VOID</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token function\">RamDiskEvtIoRead</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    IN WDFQUEUE Queue<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    IN WDFREQUEST Request<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    IN size_t Length</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>VOID</pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token function\">RamDiskEvtIoWrite</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    IN WDFQUEUE Queue<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    IN WDFREQUEST Request<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    IN size_t Length</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    <span class=\"token punctuation\">)</span></pre></td></tr></table></figure><p>这两个函数没有返回值。<br />\n它们的第一个参数是一个队列对象，这个对象说明了这个请求的来源；<br />\n第二个参数则是具体的请求；<br />\n最后一个参数是<strong>读 / 写请求的回调函数所特有的</strong>，用来说明需要读或者写多少个字节的内容</p>\n<p><em>之前建立队列时曾经将磁盘设备的设备扩展和队列的扩展联系起来</em>，在这里就可以看出它的用处 ——<strong> 我们可以轻易地在这些回调函数里通过队列对象获取到磁盘设备的设备扩展，进而获取到所有的相关参数</strong>。</p>\n<p><em>对于一个磁盘设备来说，读 / 写请求就是要读 / 写磁盘上的某一段区域的内容，这个区域由起始点（offset）和长度（length）来划定，长度已经由回调函数的参数提供，而起始点就要通过 WDF 驱动框架提供的各种函数在第二个参数 —— 请求参数中获取了。读 / 写请求还有另外一个重要的参数就是缓冲区，它由系统提供，用来存放读出来的数据或者需要写入的数据，这个参数也需要从请求参数中获取。</em></p>\n<p>在获取了所有必需的参数之后，作为以内存为介质的模拟磁盘设备来说，只需要简单地将内存镜像中适当地点、适当长度的数据拷贝到读缓冲区中，或者将写缓冲区中的数据拷贝到内存镜像中即可，这也就是作为一个内存盘来说，针对于标准磁盘读 / 写请求的特殊处理。</p>\n<p>在真实应用中，在磁盘设备之上的文件系统设备会根据 FAT 表等数据结构，将对文件的访问转换成对磁盘设备的访问，而磁盘对于上层来说，就是一个起始位置为 0、总长度为磁盘卷总大小的扁平的寻址空间，任何由文件系统转换过来的访问都应该在这个空间之内。</p>\n<p>下面看一下读请求的具体处理流程：</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>VOID</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token function\">RamDiskEvtIoRead</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    IN WDFQUEUE Queue<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    IN WDFREQUEST Request<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    IN size_t Length</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  <span class=\"token comment\">// 从队列的扩展中获取到对应的磁盘设备的扩展</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  PDEVICE_EXTENSION      devExt <span class=\"token operator\">=</span> <span class=\"token function\">QueueGetExtension</span><span class=\"token punctuation\">(</span>Queue<span class=\"token punctuation\">)</span><span class=\"token operator\">-></span>DeviceExtension<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  <span class=\"token comment\">// 用于保存各种函数返回值的状态变量</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  NTSTATUS               Status <span class=\"token operator\">=</span> STATUS_INVALID_PARAMETER<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  <span class=\"token comment\">// 用于获取请求参数的变量</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>  WDF_REQUEST_PARAMETERS Parameters<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>  <span class=\"token comment\">// 用于获取读请求起始地址的变量，这是一个 64 位的数据</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>  LARGE_INTEGER          ByteOffset<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>  <span class=\"token comment\">// 这是一个用于获取缓冲区的内存句柄</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>  WDFMEMORY              hMemory<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>  <span class=\"token comment\">// 初始化参数变量，为之后从请求参数中获取各种信息做准备</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>  <span class=\"token function\">WDF_REQUEST_PARAMETERS_INIT</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>Parameters<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>  <span class=\"token comment\">// 从请求参数中获取信息</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>  <span class=\"token function\">WdfRequestGetParameters</span><span class=\"token punctuation\">(</span>Request<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>Parameters<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>  <span class=\"token comment\">// 将请求参数中读的起始位置取出来</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>  ByteOffset<span class=\"token punctuation\">.</span>QuadPart <span class=\"token operator\">=</span> Parameters<span class=\"token punctuation\">.</span>Parameters<span class=\"token punctuation\">.</span>Read<span class=\"token punctuation\">.</span>DeviceOffset<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>  <span class=\"token comment\">// 这里是自己实现的一个参数检查函数。由于读取的范围不能超过磁盘镜像的大小</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>  <span class=\"token comment\">// 并且必须是扇区对齐，所以这里需要有一个参数检查。</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">RamDiskCheckParameters</span><span class=\"token punctuation\">(</span>devExt<span class=\"token punctuation\">,</span> ByteOffset<span class=\"token punctuation\">,</span> Length<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>      <span class=\"token comment\">// 从请求参数中获取读缓冲区的内存句柄</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>      Status <span class=\"token operator\">=</span> <span class=\"token function\">WdfRequestRetrieveOutputMemory</span><span class=\"token punctuation\">(</span>Request<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>hMemory<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>      <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token function\">NT_SUCCESS</span><span class=\"token punctuation\">(</span>Status<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>          <span class=\"token comment\">// 根据之前获取到的读参数进行内存拷贝，填写读请求的缓存区从而完成读请求的操作</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>          Status <span class=\"token operator\">=</span> <span class=\"token function\">WdfMemoryCopyFromBuffer</span><span class=\"token punctuation\">(</span>hMemory<span class=\"token punctuation\">,</span> <span class=\"token comment\">// Destination</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>                                          <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// Offset into the destination</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>                                          devExt<span class=\"token operator\">-></span>DiskImage <span class=\"token operator\">+</span> ByteOffset<span class=\"token punctuation\">.</span>LowPart<span class=\"token punctuation\">,</span> <span class=\"token comment\">// source</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>                                          Length<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>  <span class=\"token comment\">// 结束这个请求，这里要注意的是，需要将读取的长度作为返回的信息一并返回</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>  <span class=\"token function\">WdfRequestCompleteWithInformation</span><span class=\"token punctuation\">(</span>Request<span class=\"token punctuation\">,</span> Status<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span>ULONG_PTR<span class=\"token punctuation\">)</span>Length<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>写请求与读请求类似如下：</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>VOID</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token function\">RamDiskEvtIoWrite</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    IN WDFQUEUE Queue<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    IN WDFREQUEST Request<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    IN size_t Length</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    PDEVICE_EXTENSION      devExt <span class=\"token operator\">=</span> <span class=\"token function\">QueueGetExtension</span><span class=\"token punctuation\">(</span>Queue<span class=\"token punctuation\">)</span><span class=\"token operator\">-></span>DeviceExtension<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    NTSTATUS               Status <span class=\"token operator\">=</span> STATUS_INVALID_PARAMETER<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    WDF_REQUEST_PARAMETERS Parameters<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    LARGE_INTEGER          ByteOffset<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    WDFMEMORY              hMemory<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    <span class=\"token function\">WDF_REQUEST_PARAMETERS_INIT</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>Parameters<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    <span class=\"token function\">WdfRequestGetParameters</span><span class=\"token punctuation\">(</span>Request<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>Parameters<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>    ByteOffset<span class=\"token punctuation\">.</span>QuadPart <span class=\"token operator\">=</span> Parameters<span class=\"token punctuation\">.</span>Parameters<span class=\"token punctuation\">.</span>Write<span class=\"token punctuation\">.</span>DeviceOffset<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">RamDiskCheckParameters</span><span class=\"token punctuation\">(</span>devExt<span class=\"token punctuation\">,</span> ByteOffset<span class=\"token punctuation\">,</span> Length<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>        Status <span class=\"token operator\">=</span> <span class=\"token function\">WdfRequestRetrieveInputMemory</span><span class=\"token punctuation\">(</span>Request<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>hMemory<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>        <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token function\">NT_SUCCESS</span><span class=\"token punctuation\">(</span>Status<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>            Status <span class=\"token operator\">=</span> <span class=\"token function\">WdfMemoryCopyToBuffer</span><span class=\"token punctuation\">(</span>hMemory<span class=\"token punctuation\">,</span> <span class=\"token comment\">// Source</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>                                    <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// offset in Source memory where the copy has to start</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>                                    devExt<span class=\"token operator\">-></span>DiskImage <span class=\"token operator\">+</span> ByteOffset<span class=\"token punctuation\">.</span>LowPart<span class=\"token punctuation\">,</span> <span class=\"token comment\">// destination</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>                                    Length<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>    <span class=\"token function\">WdfRequestCompleteWithInformation</span><span class=\"token punctuation\">(</span>Request<span class=\"token punctuation\">,</span> Status<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span>ULONG_PTR<span class=\"token punctuation\">)</span>Length<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>其中的参数检查函数如下：</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>BOOLEAN</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token function\">RamDiskCheckParameters</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    IN PDEVICE_EXTENSION devExt<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    IN LARGE_INTEGER ByteOffset<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    IN size_t Length</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    <span class=\"token comment\">// Check for invalid parameters.  It is an error for the starting offset</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    <span class=\"token comment\">// + length to go past the end of the buffer, or for the length to</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    <span class=\"token comment\">// not be a proper multiple of the sector size.</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    <span class=\"token comment\">// Others are possible, but we don't check them since we trust the</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    <span class=\"token comment\">// file system.</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>    <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span> devExt<span class=\"token operator\">-></span>DiskRegInfo<span class=\"token punctuation\">.</span>DiskSize <span class=\"token operator\">&lt;</span> Length <span class=\"token operator\">||</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>        ByteOffset<span class=\"token punctuation\">.</span>QuadPart <span class=\"token operator\">&lt;</span> <span class=\"token number\">0</span> <span class=\"token operator\">||</span> <span class=\"token comment\">// QuadPart is signed so check for negative values</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>        <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>ULONGLONG<span class=\"token punctuation\">)</span>ByteOffset<span class=\"token punctuation\">.</span>QuadPart <span class=\"token operator\">></span> <span class=\"token punctuation\">(</span>devExt<span class=\"token operator\">-></span>DiskRegInfo<span class=\"token punctuation\">.</span>DiskSize <span class=\"token operator\">-</span> Length<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">||</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>            <span class=\"token punctuation\">(</span>Length <span class=\"token operator\">&amp;</span> <span class=\"token punctuation\">(</span>devExt<span class=\"token operator\">-></span>DiskGeometry<span class=\"token punctuation\">.</span>BytesPerSector <span class=\"token operator\">-</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>        <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>        <span class=\"token comment\">// Do not give an I/O boost for parameter errors.</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>        <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>        <span class=\"token function\">KdPrint</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>            <span class=\"token string\">\"Error invalid parameter\\n\"</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>            <span class=\"token string\">\"ByteOffset: %x\\n\"</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>            <span class=\"token string\">\"Length: %d\\n\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>            ByteOffset<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>            Length</pre></td></tr><tr><td data-num=\"33\"></td><td><pre>         <span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>        <span class=\"token keyword\">return</span> FALSE<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>    <span class=\"token keyword\">return</span> TRUE<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h3 id=\"deviceiocontrol请求\"><a class=\"anchor\" href=\"#deviceiocontrol请求\">#</a> DeviceIoControl 请求</h3>\n<p>在正常情况下，文件系统会发给本驱动所建立的磁盘设备一些读 / 写请求，而实际上除了读 / 写请求，还会有一些控制方面的请求，这种请求被统称为 DeviceIoControl 请求。</p>\n<p>一个标准的磁盘卷设备，需要支持数量庞大的 DeviceIoControl 请求，但是对于这个小例子来说，仅仅支持最小的能够保证正常工作的 DeviceIoControl 请求就已经足够了。</p>\n<p>下面来看看 Ramdisk 驱动是如何处理 DeviceIoControl 请求的。</p>\n<p>首先是  <code>DeviceIoControl</code>  请求的处理函数原型:</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>VOID</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token function\">RamDiskEvtIoDeviceControl</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    IN WDFQUEUE     Queue<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    IN WDFREQUEST   Request<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    IN size_t       OutputBufferLength<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    IN size_t       InputBufferLength<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    IN ULONG        IoControlCode</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token punctuation\">)</span></pre></td></tr></table></figure><ul>\n<li>这个回调函数没有返回值。</li>\n<li>第一个参数同样是请求来自于哪个队列；</li>\n<li>第二个参数是请求参数；</li>\n<li>第三个和第四个参数是作为 DeviceIoControl 回调函数所特有的参数，即输出缓冲区长度和输入缓冲区长度。由于 DeviceIoControl 请求通常是伴随着一些请求的相关信息而传入的，填满了请求到的信息传出，所以这里需要这两个缓冲区的长度；</li>\n<li>最后一个参数是请求的功能号，即说明这是一个什么样的 DeviceIoControl 请求。</li>\n</ul>\n<p>接下来看看这些请求是如何被处理的。</p>\n<p>DeviceIoControl 请求有很多种，针对每类不同的设备具有不同的含义，其中有些是必须要处理的，不处理这个设备就有可能不能启动，或者不能正常工作；还有一些在最简单的情况下是不需要处理的，不处理的后果最多会导致某些参数显示不正确等小错误发生。</p>\n<p>Ramdisk 驱动只需要处理几个 DeviceIoControl 请求即可，这几个请求是由相关文档的描述和开发人员的长期经验总结得出的。</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>VOID</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token function\">RamDiskEvtIoDeviceControl</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    IN WDFQUEUE Queue<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    IN WDFREQUEST Request<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    IN size_t OutputBufferLength<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    IN size_t InputBufferLength<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    IN ULONG IoControlCode</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  <span class=\"token comment\">// 初始化返回状态为非法的设备请求，这样在其他无关紧要的、不需要处理的 DeviceIoControl 请求到来时，可以直接返回这个状态</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    NTSTATUS          Status <span class=\"token operator\">=</span> STATUS_INVALID_DEVICE_REQUEST<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    <span class=\"token comment\">// 用来存放返回的 DeviceIoControl 所要求的的数据长度</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    ULONG_PTR         information <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    <span class=\"token comment\">// 中间变量</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    size_t            bufSize<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    <span class=\"token comment\">// 和读 / 写回调函数相同，也通过队列的扩展来获取设备的扩展</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    PDEVICE_EXTENSION devExt <span class=\"token operator\">=</span> <span class=\"token function\">QueueGetExtension</span><span class=\"token punctuation\">(</span>Queue<span class=\"token punctuation\">)</span><span class=\"token operator\">-></span>DeviceExtension<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>    <span class=\"token comment\">// 由于我们对发过来的请求的长度很有信心（因为是 Windows 标准请求），所以这不需要输入缓冲区和输出缓冲区</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    <span class=\"token function\">UNREFERENCED_PARAMETER</span><span class=\"token punctuation\">(</span>OutputBufferLength<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>    <span class=\"token function\">UNREFERENCED_PARAMETER</span><span class=\"token punctuation\">(</span>InputBufferLength<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>    <span class=\"token comment\">// 开始判断是哪个 DeviceIoControl 请求</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>    <span class=\"token keyword\">switch</span> <span class=\"token punctuation\">(</span>IoControlCode<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>    <span class=\"token comment\">// 这是一个获取当前分区信息的 DeviceIoControl 请求，需要处理</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>    <span class=\"token keyword\">case</span> IOCTL_DISK_GET_PARTITION_INFO<span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>            <span class=\"token comment\">// 首先声明一个输出缓冲区的指针</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>            PPARTITION_INFORMATION outputBuffer<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>            <span class=\"token comment\">// 由于这个 DeviceIoControl 请求所需的信息大部分是从 DBR 中获取的，所以需要一个指向 DBR 的指针</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>            PBOOT_SECTOR bootSector <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>PBOOT_SECTOR<span class=\"token punctuation\">)</span> devExt<span class=\"token operator\">-></span>DiskImage<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>            <span class=\"token comment\">// 这是将要返回的信息的长度，它会被上层发出 DeviceIoControl 请求的设备收到</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>            information <span class=\"token operator\">=</span> <span class=\"token keyword\">sizeof</span><span class=\"token punctuation\">(</span>PARTITION_INFORMATION<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>            <span class=\"token comment\">// 通过框架函数来获取这个 DeviceIoControl 请求所携带的输出缓冲区</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>            Status <span class=\"token operator\">=</span> <span class=\"token function\">WdfRequestRetrieveOutputBuffer</span><span class=\"token punctuation\">(</span>Request<span class=\"token punctuation\">,</span> <span class=\"token keyword\">sizeof</span><span class=\"token punctuation\">(</span>PARTITION_INFORMATION<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>outputBuffer<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>bufSize<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>            <span class=\"token comment\">// 如果获取缓冲区成功，将 DBR 中的相关信息填入缓冲区</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>            <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token function\">NT_SUCCESS</span><span class=\"token punctuation\">(</span>Status<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>                outputBuffer<span class=\"token operator\">-></span>PartitionType <span class=\"token operator\">=</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>                    <span class=\"token punctuation\">(</span>bootSector<span class=\"token operator\">-></span>bsFileSystemType<span class=\"token punctuation\">[</span><span class=\"token number\">4</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">==</span> <span class=\"token string\">'6'</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">?</span> PARTITION_FAT_16 <span class=\"token operator\">:</span> PARTITION_FAT_12<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>                <span class=\"token comment\">// 还需要根据这个驱动的现实情况来 “编造” 一些数据</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>                outputBuffer<span class=\"token operator\">-></span>BootIndicator       <span class=\"token operator\">=</span> FALSE<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>                outputBuffer<span class=\"token operator\">-></span>RecognizedPartition <span class=\"token operator\">=</span> TRUE<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>                outputBuffer<span class=\"token operator\">-></span>RewritePartition    <span class=\"token operator\">=</span> FALSE<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>                outputBuffer<span class=\"token operator\">-></span>StartingOffset<span class=\"token punctuation\">.</span>QuadPart <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>                outputBuffer<span class=\"token operator\">-></span>PartitionLength<span class=\"token punctuation\">.</span>QuadPart <span class=\"token operator\">=</span> devExt<span class=\"token operator\">-></span>DiskRegInfo<span class=\"token punctuation\">.</span>DiskSize<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>                outputBuffer<span class=\"token operator\">-></span>HiddenSectors       <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>ULONG<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">(</span><span class=\"token number\">1L</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>                outputBuffer<span class=\"token operator\">-></span>PartitionNumber     <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>ULONG<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">-</span><span class=\"token number\">1L</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>                <span class=\"token comment\">// 成功，修改返回状态</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>                Status <span class=\"token operator\">=</span> STATUS_SUCCESS<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>        <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre></pre></td></tr><tr><td data-num=\"52\"></td><td><pre>    <span class=\"token keyword\">case</span> IOCTL_DISK_GET_DRIVE_GEOMETRY<span class=\"token operator\">:</span>  <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>            <span class=\"token comment\">// 首先声明一个输出缓冲区</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre>            PDISK_GEOMETRY outputBuffer<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>            <span class=\"token comment\">// 这是将要返回的信息的长度，它会被上层发出 DeviceIoControl 请求的设备接收到</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre>            information <span class=\"token operator\">=</span> <span class=\"token keyword\">sizeof</span><span class=\"token punctuation\">(</span>DISK_GEOMETRY<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre>            <span class=\"token comment\">// 通过框架函数来获取这个 DeviceIoControl 请求所携带的输出缓冲区</span></pre></td></tr><tr><td data-num=\"59\"></td><td><pre>            Status <span class=\"token operator\">=</span> <span class=\"token function\">WdfRequestRetrieveOutputBuffer</span><span class=\"token punctuation\">(</span>Request<span class=\"token punctuation\">,</span> <span class=\"token keyword\">sizeof</span><span class=\"token punctuation\">(</span>DISK_GEOMETRY<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>outputBuffer<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>bufSize<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre>            <span class=\"token comment\">// 如果获取缓冲区成功，将相关信息填入缓冲区</span></pre></td></tr><tr><td data-num=\"61\"></td><td><pre>            <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token function\">NT_SUCCESS</span><span class=\"token punctuation\">(</span>Status<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"62\"></td><td><pre>                <span class=\"token comment\">// 这里实际上就是填入之前初始化好的磁盘的几何信息</span></pre></td></tr><tr><td data-num=\"63\"></td><td><pre>                <span class=\"token function\">RtlCopyMemory</span><span class=\"token punctuation\">(</span>outputBuffer<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span><span class=\"token punctuation\">(</span>devExt<span class=\"token operator\">-></span>DiskGeometry<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">sizeof</span><span class=\"token punctuation\">(</span>DISK_GEOMETRY<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"64\"></td><td><pre>                <span class=\"token comment\">// 修改返回状态</span></pre></td></tr><tr><td data-num=\"65\"></td><td><pre>                Status <span class=\"token operator\">=</span> STATUS_SUCCESS<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"66\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"67\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"68\"></td><td><pre>        <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"69\"></td><td><pre>    <span class=\"token comment\">// 对于这两个 DeviceIoControl 请求，直接返回成功，因为这两个请求是不需要其他信息的</span></pre></td></tr><tr><td data-num=\"70\"></td><td><pre>    <span class=\"token keyword\">case</span> IOCTL_DISK_CHECK_VERIFY<span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"71\"></td><td><pre>    <span class=\"token keyword\">case</span> IOCTL_DISK_IS_WRITABLE<span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"72\"></td><td><pre></pre></td></tr><tr><td data-num=\"73\"></td><td><pre>        <span class=\"token comment\">// 修改返回状态</span></pre></td></tr><tr><td data-num=\"74\"></td><td><pre>        Status <span class=\"token operator\">=</span> STATUS_SUCCESS<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"75\"></td><td><pre>        <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"76\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"77\"></td><td><pre>    <span class=\"token comment\">// 结束这个 DeviceIoControl 请求，需要将读取的长度作为返回信息一并返回</span></pre></td></tr><tr><td data-num=\"78\"></td><td><pre>    <span class=\"token function\">WdfRequestCompleteWithInformation</span><span class=\"token punctuation\">(</span>Request<span class=\"token punctuation\">,</span> Status<span class=\"token punctuation\">,</span> information<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"79\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>至此结束。</p>\n<h2 id=\"ramdisk的编译与安装\"><a class=\"anchor\" href=\"#ramdisk的编译与安装\">#</a> Ramdisk 的编译与安装</h2>\n<h3 id=\"编译\"><a class=\"anchor\" href=\"#编译\">#</a> 编译</h3>\n<p>pass</p>\n<h3 id=\"安装\"><a class=\"anchor\" href=\"#安装\">#</a> 安装</h3>\n<p>在编译完成之后，生成的文件是 WdfRamdisk.sys 和 ramdisk.inf。前者是驱动的二进制编译结果，后者则是用于安装的信息文件。<br />\n为了正常安装这个驱动，还需要一个小工具，它在 “WDK 安装目录” <code>\\redist\\wdf\\x86</code>  下，叫作 <code>WdfCoInstaller01007.dll</code> 。这个动态链接库文件是 WDF 驱动框架在安装时的一个必要文件，用于安装驱动框架本身的相关内容。</p>\n<p>在准备好了这三个文件之后，读者可以将这三个文件拷贝到要安装的机器的同一个目录中。在 “控制面板” 中找到 “添加硬件” 这一项，然后选择 “添加新的硬件设备”“安装我手动从列表选择的硬件（高级）”“显示所有设备”，单击 “从磁盘安装”，选择 ramdisk.inf。接着一直点击 Next”，这样驱动就安装完毕了，在重启系统之后，就会发现 “我的电脑” 中多出了一个盘，名为 RAMDISK。</p>\n<h3 id=\"对安装的深入探究\"><a class=\"anchor\" href=\"#对安装的深入探究\">#</a> 对安装的深入探究</h3>\n<p>那么安装时到底做了什么事情使得这个驱动可以在每次启动时工作起来呢？下面就来一探究竟。</p>\n<p>安装的过程都来自于 <code>ramdisk.inf</code>  的控制。 <code>ramdisk.inf</code>  文件是随着编译产生的，编译器在获取到了当前编译的平台、目标平台等信息之后（这些信息由编译环境提供），会将  <code>RAMDISK</code>  程序目录下的 <code>ramdisk.inx</code>  文件中的一些变量加以赋值，最终生成了适合于相应目标平台的 <code>ramdisk.inf</code>  文件。当然，仅仅有 <code>ramdisk.inf</code>  文件还是不够的，这里还使用了 Windows 系统自带的添加硬件向导来完成安装。在这里不需要搞清楚添加硬件向导到底在读入了这个 <code>ramdisk.inf</code>  之后做了哪些操作，这些操作必将是很复杂的，而且牵扯到过多的其他方面内容，读者只需要从结果来看看安装过程最终在系统中留下了什么即可。</p>\n<p>首先可以发现 <code>WdfRamdisk.sys</code>  文件被拷贝到了 Windows 的  <code>System32\\drivers</code>  目录下，这是正常的，因为所有的 Windows 驱动程序几乎都放在这个目录下。接下来读者会在注册表中发现一些增加的项，这些项各有作用，下面就对它们做一些简单的讲解。</p>\n<ol>\n<li>\n<p><code>“\\HKEY_LOCAL_MACHINE\\SYSTEM\\CurrentControlSet\\Enum\\Root\\UNKNOWN”</code> 。这是在安装之后新增加的一个键，在这之下还有一个叫作 <code>0000</code>  的子键，读者可以在管理员用户下用 <code>regedit</code>  命令查看这个键的内容。在 Windows 系统启动时，PnP 管理器会枚举  <code>“\\HKEY_LOCAL_MACHINE\\SYSTEM\\CurrentControlSet\\Enum\\Root\\”</code>  下的所有键，并会根据键中的信息为每个设备创建一个 PDO（物理设备对象 ） 。 在 <code>“\\HKEY_LOCAL_MACHINE\\SYSTEM\\CurrentControlSet\\Enum\\ Root\\”</code>  下的所有键代表了在系统安装时记录的或者通过添加硬件向导添加的一个硬件信息，Windows 虚拟了一条根总线并且把这些硬件挂接在上面。PnP 管理器完成 PDO 的建立之后会进行标准的 PnP 操作，与 PDO 相对应的驱动将会被加载。在 <code>“\\HKEY_LOCAL_MACHINE\\SYSTEM\\CurrentControlSet\\Enum\\Root\\UNKNOWN\\0000”</code>  键下可以看到和 Ramdisk 相关的信息，其中有一个值是 Service，系统将会寻找这个值指明的驱动，进行加载和调用。另外，在这个键下面还有一个值是 <code>ClassGUID</code> ，这个值的内容将作为这一类驱动的索引，在下面笔者将会用 <code>ClassGUID</code>  来代替这一长串的数字。</p>\n</li>\n<li>\n<p><code>“\\HKEY_LOCAL_MACHINE\\SYSTEM\\CurrentControlSet\\Services\\Ramdisk”</code> 。上面已经说到系统会去加载 Service 所指明的驱动，而在 <code>“\\HKEY_LOCAL_MACHINE\\SYSTEM\\CurrentControlSet\\Enum\\Root\\UNKNOWN\\0000”</code>  中的 Service 值的内容正是  <code>Ramdisk</code>  ，于是系统就会 在 <code>“\\HKEY_LOCAL_MACHINE\\SYSTEM\\CurrentControlSet\\Services\\”</code>  下面寻找这个叫作 Ramdisk 的服务，并根据它的内容去最终加载驱动程序本身。 <code>“\\HKEY_LOCAL_MACHINE\\SYSTEM\\CurrentControlSet\\Services\\Ramdisk”</code>  是一个标准的服务描述键，读者应该已经对它非常熟悉了，这里不再多讲，这个键最重要的一点就是指明了 <code>ramdisk.sys</code>  文件的位置。</p>\n</li>\n<li>\n<p><code>“\\HKEY_LOCAL_MACHINE\\SYSTEM\\CurrentControlSet\\Control\\Class\\ClassGUID”</code> 。请读者注意这个键最后的 <code>ClassGUID</code>  实际上是一长串数字，数字的内容在  <code>“\\HKEY_LOCAL_MACHINE\\SYSTEM\\CurrentControlSet\\Enum\\Root\\UNKNOWN\\0000”</code>  键的 <code>ClassGUID</code>  值中。这个键说明了具有同样 Class 的驱动所通用的一些信息，在 Ramdisk 驱动中这个键没有太大的用处，但是在其他的驱动如类过滤驱动等驱动程序中，这个键却起着非常重要的作用。</p>\n</li>\n</ol>\n<h1 id=\"结束\"><a class=\"anchor\" href=\"#结束\">#</a> 结束</h1>\n<p>通过 Ramdisk 驱动，简单了解了 WDF 驱动开发框架。</p>\n",
            "tags": [
                "磁盘虚拟",
                "DriverEntry函数的定义",
                "WDF_DRIVER_CONFIG结构",
                "EvtDriverDeviceAdd函数",
                "FAT12/16磁盘卷"
            ]
        },
        {
            "id": "https://or0kit.github.io/Bin/Core/Drive-Development/%E9%94%AE%E7%9B%98%E7%9A%84%E8%BF%87%E6%BB%A4/",
            "url": "https://or0kit.github.io/Bin/Core/Drive-Development/%E9%94%AE%E7%9B%98%E7%9A%84%E8%BF%87%E6%BB%A4/",
            "title": "键盘的过滤",
            "date_published": "2022-07-12T15:11:27.000Z",
            "content_html": "<h1 id=\"键盘过滤\"><a class=\"anchor\" href=\"#键盘过滤\">#</a> 键盘过滤</h1>\n<p>键盘过滤可以用来做什么？</p>\n<p>恶意程序会用很多方法结果键盘消息，我们可以使用过滤键盘的驱动进行保护。</p>\n<h1 id=\"技术原理\"><a class=\"anchor\" href=\"#技术原理\">#</a> 技术原理</h1>\n<p>了解编写键盘驱动相关的知识。</p>\n<h2 id=\"预备知识\"><a class=\"anchor\" href=\"#预备知识\">#</a> 预备知识</h2>\n<p>了解什么是 PDO、Windows 中从击键到内核的过程、键盘的硬件原理。</p>\n<h3 id=\"pdo\"><a class=\"anchor\" href=\"#pdo\">#</a> PDO</h3>\n<p>何为 PDO？前面解释过  <code>DO</code>  是  <code>Device Object</code>  的简称， <code>PDO</code>  是  <code>Phsiycal Device Object</code>  的简称，字面上的意义是物理设备。读者暂时可以这样理解：<strong>PDO 是设备栈最下面的那个设备对象。</strong> 这个理解并不精确，但是很实用。</p>\n<h3 id=\"windows中从击键到内核\"><a class=\"anchor\" href=\"#windows中从击键到内核\">#</a> Windows 中从击键到内核</h3>\n<p>了解 Windows 是是如何获得按键的，然后传递给各应用程序。</p>\n<p>在任务管理器中，查看  <code>csrss.exe</code>  进程：</p>\n<p><img data-src=\"image001.png\" alt=\"\" /></p>\n<p><code>Csrss.exe</code>  进程有一个线程叫做  <code>win32!RawInputThread</code> ，这个线程通过一个  <code>GUID(GUID_CLASS_KEYBOARD)</code>  来获得键盘设备栈的  <code>PDO</code>  符号链接名。</p>\n<p><code>Win32k!RawInputThread</code>  执行到函数  <code>win32k!OpenDevice</code> , 它的一个参数可以找到键盘设备栈的 PDO 的符号链接名。</p>\n<p><code>Win32k!OpenDevice</code>  有一个  <code>OBJECT_ATTRIBUTES</code>  结构的局部变量，它自己初始化这个局部变量，用传入参数中的键盘设备栈的  <code>PDO</code>  的符号链接名赋值  <code>OBJECT_ATTRIBUTES+0x8</code>  处的  <code>PUNICODE_STRING ObjectName</code> 。</p>\n<p>然后，调用  <code>ZwCreateFile</code> ， <code>ZwCreateFile</code>  完成打开设备的工作，最后通过传入的参数返回得到的句柄。 <code>Win32k!RawInputThread</code>  把得到的句柄保存起来，供后面的  <code>ReadFile</code> ， <code>DeviceIoControl</code>  等使用。</p>\n<p><code>win32k!RawInputThread</code>  在获得了句柄之后，会以这个句柄为参数，调用  <code>nt!ZwReadFile</code> ，向键盘驱动要求读入数据。 <code>nt!ZwReadFile</code>  会创建一个  <code>IRP_MJ_READ</code>  的 IRP 发给键盘驱动，告诉键盘驱动要求读入数据。键盘驱动通常会使这个 <code>IRP Pending</code> ，即  <code>IRP_MJ_READ</code>  不被满足，它会一直被放在那里，等待来自键盘的数据。而发出这个读请求的线程  <code>win32k!RawInputThread</code>  也会等待，等待这个读操作的完成。</p>\n<p>当键盘上有键被按下时，将触发键盘的中断，引起中断服务例程的执行，键盘中断的中断服务例程由键盘驱动提供。键盘驱动从端口读取扫描码，经过一系列的处理之后，把从键盘得到的数据交给 IRP，最后结束这个 IRP。这个 IRP 的结束，将导致  <code>win32k!RawInputThread</code>  线程对这个读操作的等待结束。 <code>win32k!RawInputThread</code>  线程将会对得到的数据做出处理，分发给合适的进程。一旦把输入数据处理完之后， <code>win32k!RawInputThread</code>  线程就会立刻再调用一个  <code>nt!ZwReadFile</code> ，向键盘驱动要求读入数据。于是又开始一个等待，等待键盘上的键被按下。</p>\n<p>简单地说， <code>win32k!RawInputThread</code>  线程总是调用  <code>nt!ZwReadFile</code>  函数要求读入数据，然后等待键盘上的键被按下。当键盘上的键被按下时，   <code>win32k!RawInputThread</code>  处理  <code>nt!ZwReadFile</code>  得到的数据，然后  <code>nt!ZwReadFile</code>  要求读入数据，再等待键盘上的键被按下。</p>\n<p>我们一般看到的  <code>PS/2</code>  键盘的设备栈，如果自己没有另外安装其他键盘过滤程序，那么设备栈的情况是这样的：</p>\n<p>最顶层的设备对象是驱动  <code>KbdClass</code>  生成的设备对象。<br />\n中间层的设备对象是驱动  <code>i8042prt</code>  生成的设备对象。<br />\n最底层的设备对象是驱动  <code>ACPI</code>  生成的设备对象。</p>\n<p>原理到这里就讲完了。这段描述似乎令人眼花缭乱，但是我们没有必要非常关心其细节，<strong>只要知道我们现在要去绑定的那个设备就是驱动  <code>KbdClass</code>  的设备对象就可以了</strong></p>\n<h3 id=\"键盘硬件原理\"><a class=\"anchor\" href=\"#键盘硬件原理\">#</a> 键盘硬件原理</h3>\n<p>从键盘被敲击到计算机屏幕上出现一个字符，中间有很多复杂的变换。</p>\n<p>一个字符显然并不代表一个键，因为大写和小写的字母是同一个键，只是根据 Shift 键来决定是大写还是小写字母。此外还有许多复杂的功能键，如 Ctrl、Alt 键，另外还有小键盘等。所以键并不用字符来代表，而是给每个键规定了一个扫描码。<strong>键盘驱动程序会读取扫描码并翻译成正确的动作</strong>，但是并非放之所有的键盘而皆准。我们应该知道每个键都对应着扫描码。</p>\n<p>键盘和 CPU 的交互方式是中断和读取端口，这个操作是串行的。发生一次中断，就等于键盘给了 CPU 一次通知，这个通知只能通知一个事件：某个键被按下了，某个键弹起来了。我们可能会以为在按下一个字母键时，CPU 可能会去读取 Shift 键的状态，看应该是大写还是小写字母，结果却完全不是这样的。CPU 只接收通知并读取端口的扫描码，从不主动去 “查看” 任何键。</p>\n<p>为此，一个键实际上需要两个扫描码：一个表示键按下；另一个表示键弹起。根据从网上找到的资料，如果按下的键的扫描码为 X，那么同一个键弹起的扫描码就为 X+0x80。键盘这种设备非常古老，所以貌似 Windosw XP 下端口和中断号都是定死的，即中断号为 0x93，端口为 0x60。每次中断发生时，CPU 都去读取端口 0x60 中的扫描码。0x60 中只保存一个字节，但是扫描码是可以有两个字节的，此时就会发生两次中断，CPU 会先后读到扫描码的两个字节。</p>\n<p>无论如何按键，信息的传递都是一次一个字节串行进行的。</p>\n<h1 id=\"键盘过滤框架\"><a class=\"anchor\" href=\"#键盘过滤框架\">#</a> 键盘过滤框架</h1>\n<p>编写一个键盘过滤驱动框架。</p>\n<h2 id=\"绑定键盘设备\"><a class=\"anchor\" href=\"#绑定键盘设备\">#</a> 绑定键盘设备</h2>\n<p>要过滤一种设备，首先要绑定它。</p>\n<p>现在需要找到所有代表键盘的设备。从前面的原理来看，可以认定的是，如果绑定了驱动  <code>KbdClass</code>  的所有设备对象，那么代表键盘的设备一定在其中。</p>\n<p>现在我们面临的第一个问题是：如何找到一个驱动下的所有设备对象呢？</p>\n<h3 id=\"获取驱动对象下的所有设备对象\"><a class=\"anchor\" href=\"#获取驱动对象下的所有设备对象\">#</a> 获取驱动对象下的所有设备对象</h3>\n<ol>\n<li>直接读取驱动对象下面的 DeviceObject 域。</li>\n</ol>\n<p>一个  <code>DRIVER_OBJECT</code>  下有一个域叫作  <code>DeviceObject</code> ，这看似是一个设备对象的指针，但是由于每个  <code>DeviceObject</code>  中又有一个域叫作  <code>NextDevice</code> ，指向同一个驱动中的下一个设备，所以这里实际上是一个设备链。</p>\n<ol start=\"2\">\n<li>调用函数  <code>IoEnumerateDeviceObjectList</code> ，这个函数可以枚举出一个驱动下的所有设备。</li>\n</ol>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>NTSTATUS <span class=\"token function\">IoEnumerateDeviceObjectList</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>  <span class=\"token punctuation\">[</span>in<span class=\"token punctuation\">]</span>  PDRIVER_OBJECT DriverObject<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  <span class=\"token punctuation\">[</span>out<span class=\"token punctuation\">]</span> PDEVICE_OBJECT <span class=\"token operator\">*</span>DeviceObjectList<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  <span class=\"token punctuation\">[</span>in<span class=\"token punctuation\">]</span>  ULONG          DeviceObjectListSize<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  <span class=\"token punctuation\">[</span>out<span class=\"token punctuation\">]</span> PULONG         ActualNumberDeviceObjects</pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p><strong>参数</strong><br />\n [in]  <code>DriverObject</code></p>\n<p>指向驱动程序的驱动程序对象的指针。</p>\n<p>[out]  <code>DeviceObjectList</code></p>\n<p>指向接收设备对象指针的调用方分配的数组的指针。此参数可以为 NULL。</p>\n<p>[in]  <code>DeviceObjectListSize</code></p>\n<p>DeviceObjectList 数组的大小（以字节为单位） 。可以为零。</p>\n<p>[out]  <code>ActualNumberDeviceObjects</code></p>\n<p>在驱动程序对象的设备对象列表中找到的设备对象的实际数量。请注意，如果 DeviceObjectList 处的数组太小，则复制到数组中的设备对象指针的数量将少于 ActualNumberDeviceObjects。</p>\n<p><strong>返回值</strong><br />\n IoEnumerateDeviceObjectList 可以返回以下之一：</p>\n<table>\n<thead>\n<tr>\n<th style=\"text-align:left\">返回码</th>\n<th style=\"text-align:left\">描述</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td style=\"text-align:left\">STATUS_SUCCESS</td>\n<td style=\"text-align:left\">对 IoEnumerateDeviceObjectList 的调用成功。</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">STATUS_BUFFER_TOO_SMALL</td>\n<td style=\"text-align:left\">DeviceObjectList 中 的数组太小，无法容纳整个设备对象列表。在这种情况下，IoEnumerateDeviceObjectList 将尽可能多的设备对象指针复制到数组中。</td>\n</tr>\n</tbody>\n</table>\n<p>接下来我们获取键盘的驱动对象。</p>\n<h3 id=\"获取驱动对象\"><a class=\"anchor\" href=\"#获取驱动对象\">#</a> 获取驱动对象</h3>\n<p>我们首先打开驱动对象  <code>KbdClass</code> ，然后绑定它下面的所有设备。</p>\n<p>这里用到一个新的函数 —— <code>ObReferenceObjectByName</code> ，它用于通过一个名字来获得一个对象的指针。</p>\n<p>但是我们需要声明这个未公开的函数，才可以调用它。</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>NTSTATUS</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token function\">ObReferenceObjectByName</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>\tIN PUNICODE_STRING ObjectName<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>\tIN ULONG Attributes<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>\tIN PACCESS_STATE AccessState OPTIONAL<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>\tIN ACCESS_MASK DesiredAccess OPTIONAL<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>\tIN POBJECT_TYPE ObjectType<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>\tIN KPROCESSOR_MODE AccessMode<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\tIN OUT PVOID ParseContext OPTIONAL<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\tOUT PVOID<span class=\"token operator\">*</span> Object</pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>这就不得不提到另一个需要声明的全局变量：</p>\n<p>获取导出全局变量:  <code>extern POBJECT_TYPE* IoDriverObjectType;</code>  我在 xp 的源码中看到是这样获取的，有大佬说谭文书上的不对。</p>\n<h3 id=\"设备扩展\"><a class=\"anchor\" href=\"#设备扩展\">#</a> 设备扩展</h3>\n<p>在生成一个过滤设备时，我们可以给这个设备指定一个任意长度的 “设备扩展”，这个扩展中的内容可以任意填写，作为一个自定义的数据结构。</p>\n<p>这样就可以把真实设备的指针保存在设备对象里了，就没有必要像串口过滤的时定义两个数组了。</p>\n<p>在这个键盘过滤中，我们可以专门定义一个结构作为设备扩展，如下：</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">// 设备扩展</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">typedef</span> <span class=\"token keyword\">struct</span> <span class=\"token class-name\">_DEV_EXT</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>\t<span class=\"token comment\">// 结构体大小</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>\tULONG ulSize<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>\t<span class=\"token comment\">// 过滤设备对象</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>\tPDEVICE_OBJECT pFilterDeviceObject<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>\t<span class=\"token comment\">// 绑定的目标设备对象</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\tPDEVICE_OBJECT pTargetDeviceObjecct<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\t<span class=\"token comment\">// 返回对象</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>\tPDEVICE_OBJECT pLowerDeviceObjecct<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>\t<span class=\"token comment\">// 自旋锁</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>\tKSPIN_LOCK IoRequestsSpinLock<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>\t<span class=\"token comment\">// 事件</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>\tKEVENT IoInProgressEvent<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token punctuation\">&#125;</span>DEV_EXT<span class=\"token punctuation\">,</span> <span class=\"token operator\">*</span> PDEV_EXT<span class=\"token punctuation\">;</span></pre></td></tr></table></figure><h3 id=\"绑定设备的代码\"><a class=\"anchor\" href=\"#绑定设备的代码\">#</a> 绑定设备的代码</h3>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">// 获取导出全局变量</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">extern</span> POBJECT_TYPE<span class=\"token operator\">*</span> IoDriverObjectType<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\">// 声明未公开函数</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>NTSTATUS</pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token function\">ObReferenceObjectByName</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>\tIN PUNICODE_STRING ObjectName<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>\tIN ULONG Attributes<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>\tIN PACCESS_STATE AccessState OPTIONAL<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\tIN ACCESS_MASK DesiredAccess OPTIONAL<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\tIN POBJECT_TYPE ObjectType<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>\tIN KPROCESSOR_MODE AccessMode<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>\tIN OUT PVOID ParseContext OPTIONAL<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>\tOUT PVOID<span class=\"token operator\">*</span> Object</pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token comment\">// 设备扩展</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token keyword\">typedef</span> <span class=\"token keyword\">struct</span> <span class=\"token class-name\">_DEV_EXT</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>\t<span class=\"token comment\">// 结构体大小</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>\tULONG ulSize<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>\t<span class=\"token comment\">// 过滤设备对象</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>\tPDEVICE_OBJECT pFilterDeviceObject<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>\t<span class=\"token comment\">// 绑定的目标设备对象</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>\tPDEVICE_OBJECT pTargetDeviceObject<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>\t<span class=\"token comment\">// 返回对象</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>\tPDEVICE_OBJECT pLowerDeviceObject<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>\t<span class=\"token comment\">// 自旋锁</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>\tKSPIN_LOCK IoRequestsSpinLock<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>\t<span class=\"token comment\">// 事件</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>\tKEVENT IoInProgressEvent<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre><span class=\"token punctuation\">&#125;</span>DEV_EXT<span class=\"token punctuation\">,</span> <span class=\"token operator\">*</span> PDEV_EXT<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre></pre></td></tr><tr><td data-num=\"32\"></td><td><pre></pre></td></tr><tr><td data-num=\"33\"></td><td><pre><span class=\"token comment\">// 绑定设备</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre><span class=\"token comment\">// 获取 KbdClassd 的驱动对象，然后绑定其所有设备对象</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>NTSTATUS <span class=\"token function\">kbdAttachDevices</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>\tIN PDRIVER_OBJECT pDriver<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>\tIN PUNICODE_STRING pRegPath</pre></td></tr><tr><td data-num=\"38\"></td><td><pre><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>\tNTSTATUS status <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>\tUNICODE_STRING uniNtNameString<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>\tPDEV_EXT pdevext<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>\tPDEVICE_OBJECT pFilterDeviceObject <span class=\"token operator\">=</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>\tPDEVICE_OBJECT pTargetDeviceObject <span class=\"token operator\">=</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>\tPDEVICE_OBJECT pLowerDeviceObject <span class=\"token operator\">=</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>\tPDRIVER_OBJECT KbdDriverObject <span class=\"token operator\">=</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>\t<span class=\"token function\">DbgPrint</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"MyAttach!\\t\\n\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>\t<span class=\"token comment\">// 获取 KbdClass 驱动对象</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre></pre></td></tr><tr><td data-num=\"52\"></td><td><pre>\t<span class=\"token function\">RtlInitUnicodeString</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>uniNtNameString<span class=\"token punctuation\">,</span> KBD_DRIVER_NAME<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>\tstatus <span class=\"token operator\">=</span> <span class=\"token function\">ObReferenceObjectByName</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre>\t\t<span class=\"token operator\">&amp;</span>uniNtNameString<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre>\t\tOBJ_CASE_INSENSITIVE<span class=\"token punctuation\">,</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>\t\t<span class=\"token operator\">*</span>IoDriverObjectType<span class=\"token punctuation\">,</span>\t\t<span class=\"token comment\">// 在 xp 源码中看到就是这样的</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre>\t\tKernelMode<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre>\t\t<span class=\"token constant\">NULL</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>KbdDriverObject</pre></td></tr><tr><td data-num=\"59\"></td><td><pre>\t<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre>\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token function\">NT_SUCCESS</span><span class=\"token punctuation\">(</span>status<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"61\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"62\"></td><td><pre>\t\t<span class=\"token function\">DbgPrint</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"MyAttach:Couldn't get the [KbdClass DriverObject]\\t\\n\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"63\"></td><td><pre>\t\t<span class=\"token keyword\">return</span> status<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"64\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"65\"></td><td><pre>\t<span class=\"token comment\">// 解引用</span></pre></td></tr><tr><td data-num=\"66\"></td><td><pre>\t<span class=\"token function\">ObDereferenceObject</span><span class=\"token punctuation\">(</span>KbdDriverObject<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"67\"></td><td><pre></pre></td></tr><tr><td data-num=\"68\"></td><td><pre>\t<span class=\"token comment\">// 获取 KbdClass 驱动对象下的所有设备对象并绑定</span></pre></td></tr><tr><td data-num=\"69\"></td><td><pre></pre></td></tr><tr><td data-num=\"70\"></td><td><pre>\t<span class=\"token comment\">// 设备链中第一个设备</span></pre></td></tr><tr><td data-num=\"71\"></td><td><pre>\tpTargetDeviceObject <span class=\"token operator\">=</span> KbdDriverObject<span class=\"token operator\">-></span>DeviceObject<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"72\"></td><td><pre></pre></td></tr><tr><td data-num=\"73\"></td><td><pre>\t<span class=\"token comment\">// 遍历设备链</span></pre></td></tr><tr><td data-num=\"74\"></td><td><pre>\t<span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span>pTargetDeviceObject<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"75\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"76\"></td><td><pre>\t\t<span class=\"token comment\">// 首先生成一个过滤设备</span></pre></td></tr><tr><td data-num=\"77\"></td><td><pre>\t\tstatus <span class=\"token operator\">=</span> <span class=\"token function\">IoCreateDevice</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"78\"></td><td><pre>\t\t\tIN pDriver<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"79\"></td><td><pre>\t\t\tIN <span class=\"token keyword\">sizeof</span><span class=\"token punctuation\">(</span>DEV_EXT<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"80\"></td><td><pre>\t\t\tIN <span class=\"token constant\">NULL</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"81\"></td><td><pre>\t\t\tIN pTargetDeviceObject<span class=\"token operator\">-></span>DeviceType<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"82\"></td><td><pre>\t\t\tIN pTargetDeviceObject<span class=\"token operator\">-></span>Characteristics<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"83\"></td><td><pre>\t\t\tIN FALSE<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"84\"></td><td><pre>\t\t\tOUT <span class=\"token operator\">&amp;</span> pFilterDeviceObject</pre></td></tr><tr><td data-num=\"85\"></td><td><pre>\t\t<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"86\"></td><td><pre></pre></td></tr><tr><td data-num=\"87\"></td><td><pre>\t\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token function\">NT_SUCCESS</span><span class=\"token punctuation\">(</span>status<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"88\"></td><td><pre>\t\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"89\"></td><td><pre>\t\t\t<span class=\"token function\">DbgPrint</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"MyAttach:Couldn't Create Filter Device Object\\t\\n\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"90\"></td><td><pre>\t\t\tpFilterDeviceObject <span class=\"token operator\">=</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"91\"></td><td><pre>\t\t\tpTargetDeviceObject <span class=\"token operator\">=</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"92\"></td><td><pre>\t\t\t<span class=\"token keyword\">return</span> status<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"93\"></td><td><pre>\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"94\"></td><td><pre></pre></td></tr><tr><td data-num=\"95\"></td><td><pre>\t\t<span class=\"token comment\">// 绑定</span></pre></td></tr><tr><td data-num=\"96\"></td><td><pre>\t\t<span class=\"token comment\">//pLowerDeviceObject 是目标设备 设备栈栈顶的那个设备！</span></pre></td></tr><tr><td data-num=\"97\"></td><td><pre>\t\tstatus <span class=\"token operator\">=</span> <span class=\"token function\">IoAttachDeviceToDeviceStackSafe</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"98\"></td><td><pre>\t\t\tpFilterDeviceObject<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"99\"></td><td><pre>\t\t\tpTargetDeviceObject<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"100\"></td><td><pre>\t\t\t<span class=\"token operator\">&amp;</span>pLowerDeviceObject</pre></td></tr><tr><td data-num=\"101\"></td><td><pre>\t\t<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"102\"></td><td><pre>\t\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token function\">NT_SUCCESS</span><span class=\"token punctuation\">(</span>status<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"103\"></td><td><pre>\t\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"104\"></td><td><pre>\t\t\t<span class=\"token function\">DbgPrint</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"MyAtach:Couldn't attach KbdClass Device Object\\t\\n\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"105\"></td><td><pre>\t\t\t<span class=\"token function\">IoDeleteDevice</span><span class=\"token punctuation\">(</span>pFilterDeviceObject<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"106\"></td><td><pre>\t\t\tpFilterDeviceObject <span class=\"token operator\">=</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"107\"></td><td><pre>\t\t\t<span class=\"token keyword\">return</span> status<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"108\"></td><td><pre>\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"109\"></td><td><pre></pre></td></tr><tr><td data-num=\"110\"></td><td><pre>\t\t<span class=\"token comment\">// 设置 设备扩展</span></pre></td></tr><tr><td data-num=\"111\"></td><td><pre>\t\tpdevext <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>PDEV_EXT<span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span>pFilterDeviceObject<span class=\"token operator\">-></span>DeviceExtension<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"112\"></td><td><pre>\t\t<span class=\"token comment\">// 初始化设备扩展</span></pre></td></tr><tr><td data-num=\"113\"></td><td><pre>\t\t<span class=\"token function\">DevExtInit</span><span class=\"token punctuation\">(</span>pdevext<span class=\"token punctuation\">,</span> pFilterDeviceObject<span class=\"token punctuation\">,</span> pTargetDeviceObject<span class=\"token punctuation\">,</span> pLowerDeviceObject<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"114\"></td><td><pre></pre></td></tr><tr><td data-num=\"115\"></td><td><pre>\t\t<span class=\"token comment\">// 设置相关属性</span></pre></td></tr><tr><td data-num=\"116\"></td><td><pre>\t\tpFilterDeviceObject<span class=\"token operator\">-></span>DeviceType <span class=\"token operator\">=</span> pLowerDeviceObject<span class=\"token operator\">-></span>DeviceType<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"117\"></td><td><pre>\t\tpFilterDeviceObject<span class=\"token operator\">-></span>Characteristics <span class=\"token operator\">=</span> pLowerDeviceObject<span class=\"token operator\">-></span>Characteristics<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"118\"></td><td><pre>\t\tpFilterDeviceObject<span class=\"token operator\">-></span>StackSize <span class=\"token operator\">=</span> pLowerDeviceObject<span class=\"token operator\">-></span>StackSize<span class=\"token operator\">+</span><span class=\"token number\">1</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"119\"></td><td><pre>\t\tpFilterDeviceObject<span class=\"token operator\">-></span>Flags <span class=\"token operator\">|=</span> pLowerDeviceObject<span class=\"token operator\">-></span>Flags <span class=\"token operator\">&amp;</span> <span class=\"token punctuation\">(</span>DO_BUFFERED_IO <span class=\"token operator\">|</span> DO_DIRECT_IO <span class=\"token operator\">|</span> DO_POWER_PAGABLE<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"120\"></td><td><pre></pre></td></tr><tr><td data-num=\"121\"></td><td><pre>\t\t<span class=\"token comment\">// 获取下一个设备对象</span></pre></td></tr><tr><td data-num=\"122\"></td><td><pre>\t\tpTargetDeviceObject <span class=\"token operator\">=</span> pTargetDeviceObject<span class=\"token operator\">-></span>NextDevice<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"123\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"124\"></td><td><pre>\t<span class=\"token keyword\">return</span> status<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"125\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h2 id=\"键盘过滤模块的driverentry\"><a class=\"anchor\" href=\"#键盘过滤模块的driverentry\">#</a> 键盘过滤模块的 DriverEntry</h2>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">// 入口函数</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>NTSTATUS <span class=\"token function\">DriverEntry</span><span class=\"token punctuation\">(</span>PDRIVER_OBJECT pDriver<span class=\"token punctuation\">,</span> PUNICODE_STRING pRegPath<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>\tNTSTATUS status<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>\tULONG i<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>\t<span class=\"token function\">DbgPrint</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"我是驱动,我运行了\\t\\n\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>\t<span class=\"token comment\">// 设置分发函数</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\t<span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span>i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> IRP_MJ_MAXIMUM_FUNCTION<span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>\t\tpDriver<span class=\"token operator\">-></span>MajorFunction<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> myDispatch<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>\t<span class=\"token comment\">// 单独填写一个 IRP_MJ_POWER 函数， 因为重要的过滤就是读取来的按键信息，其他的都不重要</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>\tpDriver<span class=\"token operator\">-></span>MajorFunction<span class=\"token punctuation\">[</span>IRP_MJ_READ<span class=\"token punctuation\">]</span>  <span class=\"token operator\">=</span> myReadDispatch<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>\t<span class=\"token comment\">// 单独写一个 IRP_MJ_POWER 函数</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>\tpDriver<span class=\"token operator\">-></span>MajorFunction<span class=\"token punctuation\">[</span>IRP_MJ_POWER<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> myPowerDispatch<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>\t<span class=\"token comment\">// PNP (即插即用) 我们要知道什么时候一个绑定过的设备被卸载（比如从机器上拔掉）</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>\tpDriver<span class=\"token operator\">-></span>MajorFunction<span class=\"token punctuation\">[</span>IRP_MJ_PNP<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> myPNPDispatch<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>\t<span class=\"token comment\">// 卸载函数</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>\tpDriver<span class=\"token operator\">-></span>DriverUnload <span class=\"token operator\">=</span> myDriverUnload<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>\t<span class=\"token comment\">// 绑定所有的键盘设备</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>\tstatus <span class=\"token operator\">=</span> <span class=\"token function\">kbdAttachDevices</span><span class=\"token punctuation\">(</span>pDriver<span class=\"token punctuation\">,</span> pRegPath<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre></pre></td></tr><tr><td data-num=\"29\"></td><td><pre></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>\t<span class=\"token keyword\">return</span> status<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h2 id=\"键盘过滤模块的动态卸载\"><a class=\"anchor\" href=\"#键盘过滤模块的动态卸载\">#</a> 键盘过滤模块的动态卸载</h2>\n<p>键盘过滤模块的动态卸载和前面的串口过滤稍有不同，这是因为键盘总是处于 “有一个读请求没有完成” 的状态。</p>\n<p>“当键盘上有键被按下时，将触发键盘的中断，引起中断服务例程的执行，键盘中断的中断服务例程由键盘驱动提供。键盘驱动从端口读取扫描码，经过一系列的处理之后，把从键盘得到的数据交给 IRP，然后结束这个 IRP。这个 IRP 的结束，将导致  <code>win32k!RawInputThread</code>  线程对这个读操作的等待结束。 <code>win32k!RawInputThread</code>  线程将会对得到的数据做出处理，分发给合适的进程。一旦把输入数据处理完之后， <code>win32k!RawInputThread</code>  线程会立刻再调用一个  <code>nt!ZwReadFile</code> ，向键盘驱动要求读入数据。于是又开始一个等待，等待键盘上的键被按下。”</p>\n<p>换句话说，就算类似于串口驱动一样等待 5 秒，这个请求也未必会完成（如果没有按键的话）。这样如果卸载了过滤驱动，那么等下次一按键，这个请求就被处理，很可能马上就蓝屏崩溃了。</p>\n<p>下面是对实际中动态卸载的处理。</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">// 解除绑定并删除设备</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>VOID <span class=\"token function\">c2pDetach</span><span class=\"token punctuation\">(</span>IN PDEVICE_OBJECT pDeviceObject<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>\tPDEV_EXT devExt<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>\tBOOLEAN NoRequestsOutstanding <span class=\"token operator\">=</span> FALSE<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>\tdevExt <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>PDEV_EXT<span class=\"token punctuation\">)</span>pDeviceObject<span class=\"token operator\">-></span>DeviceExtension<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>\t__try</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\t\t__try</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\t\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>\t\t\t<span class=\"token function\">IoDetachDevice</span><span class=\"token punctuation\">(</span>devExt<span class=\"token operator\">-></span>pTargetDeviceObject<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>\t\t\tdevExt<span class=\"token operator\">-></span>pTargetDeviceObject <span class=\"token operator\">=</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>\t\t\t<span class=\"token function\">IoDeleteDevice</span><span class=\"token punctuation\">(</span>pDeviceObject<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>\t\t\tdevExt<span class=\"token operator\">-></span>pFilterDeviceObject <span class=\"token operator\">=</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>\t\t\t<span class=\"token function\">DbgPrint</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Detach Finished\\n\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>\t\t<span class=\"token function\">__except</span> <span class=\"token punctuation\">(</span>EXCEPTION_EXECUTE_HANDLER<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>\t__finally <span class=\"token punctuation\">&#123;</span><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>\t<span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre></pre></td></tr><tr><td data-num=\"23\"></td><td><pre><span class=\"token comment\">// 卸载函数</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>VOID <span class=\"token function\">myDriverUnload</span><span class=\"token punctuation\">(</span>PDRIVER_OBJECT pDriver<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>\tPDEVICE_OBJECT pDeviceObject<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>\tPDEVICE_OBJECT OldDeviceObject<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>\tPDEV_EXT pdevext<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>\tLARGE_INTEGER lDelay<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>\tPRKTHREAD CurrentThread<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>\tlDelay <span class=\"token operator\">=</span> <span class=\"token function\">RtlConvertLongToLargeInteger</span><span class=\"token punctuation\">(</span><span class=\"token number\">100</span> <span class=\"token operator\">*</span> DELAY_ONE_MILLISECOND<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>\tCurrentThread <span class=\"token operator\">=</span> <span class=\"token function\">KeGetCurrentThread</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>\t<span class=\"token comment\">// 把当前线程设置为低实时模式，一遍让它的运行尽量少影响其他程序</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>\t<span class=\"token function\">KeSetPriorityThread</span><span class=\"token punctuation\">(</span>CurrentThread<span class=\"token punctuation\">,</span> LOW_REALTIME_PRIORITY<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>\t<span class=\"token comment\">// UNREFERENCED_PARAMETER(pDriver);</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>\t<span class=\"token function\">DbgPrint</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"DriverEntry unload..\\t\\n.\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>\t<span class=\"token comment\">// 遍历所有设备并一律解除绑定</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>\tpDeviceObject <span class=\"token operator\">=</span> pDriver<span class=\"token operator\">-></span>DeviceObject<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>\t<span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span>pDeviceObject<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>\t\t<span class=\"token comment\">// 解除绑定并删除设备</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>\t\t<span class=\"token function\">c2pDetach</span><span class=\"token punctuation\">(</span>pDeviceObject<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\t</pre></td></tr><tr><td data-num=\"48\"></td><td><pre>\t\tpDeviceObject<span class=\"token operator\">-></span>NextDevice<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>\t<span class=\"token function\">ASSERT</span><span class=\"token punctuation\">(</span><span class=\"token constant\">NULL</span> <span class=\"token operator\">==</span> DriverObject<span class=\"token operator\">-></span>DeviceObject<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>\t<span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span>gC2pKeyCount<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre>\t\t<span class=\"token comment\">// 睡眠 1 毫秒</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>\t\t<span class=\"token function\">KeDelayExecutionThread</span><span class=\"token punctuation\">(</span>KernelMode<span class=\"token punctuation\">,</span> FALSE<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>lDelay<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre>\t<span class=\"token function\">DbgPrint</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"我是驱动，我卸载了\\t\\n\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"59\"></td><td><pre>\t<span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>这里的防止未决请求没有完成的方法就是使用  <code>gC2pKeyCount</code> 。</p>\n<p><code>gC2pKeyCount</code>  在这里是一个全局变量，每次有一个读请求到来时， <code>gC2pKeyCount</code>  被加 1；每次完成时，则减 1。于是只有所有请求都完成后，才结束等待；否则就无休止地等待下去。</p>\n<p><strong>实际上，只有一个键被按下时，这个卸载过程才结束。</strong></p>\n<h2 id=\"键盘过滤的请求处理\"><a class=\"anchor\" href=\"#键盘过滤的请求处理\">#</a> 键盘过滤的请求处理</h2>\n<p>在  <code>DriverEntry</code>  中我们设置了相关的分发函数，在这里我们来逐个实现这些函数。</p>\n<h3 id=\"通常的处理\"><a class=\"anchor\" href=\"#通常的处理\">#</a> 通常的处理</h3>\n<p>最通常的处理就是直接发送到真实设备，跳过虚拟设备的处理。这和前面串口过滤用过的方法一样。代码如下：</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">// 普通分发函数</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>NTSTATUS <span class=\"token function\">myDispatch</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>\tIN PDEVICE_OBJECT pDevice<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>\tIN PIRP irp</pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>\t<span class=\"token comment\">//\t其他的分发函数，直接 skip，然后用 IoCallDriver 把 IRP 发送到真实设备的设备对象上</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>\t<span class=\"token function\">DbgPrint</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Other Disapatch!\\t\\n\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\t<span class=\"token function\">IoSkipCurrentIrpStackLocation</span><span class=\"token punctuation\">(</span>irp<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\t<span class=\"token keyword\">return</span> <span class=\"token function\">IoCallDriver</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>PDEV_EXT<span class=\"token punctuation\">)</span>pDevice<span class=\"token operator\">-></span>DeviceExtension<span class=\"token punctuation\">)</span><span class=\"token operator\">-></span>pLowerDeviceObject<span class=\"token punctuation\">,</span> irp<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><h3 id=\"pnp的处理\"><a class=\"anchor\" href=\"#pnp的处理\">#</a> PNP 的处理</h3>\n<p>唯一需要处理的是，当有一个设备被拔出时，解除绑定并删除过滤设备。代码的实现大致如下：</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">// PNP 处理</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>NTSTATUS <span class=\"token function\">myPNPDispatch</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>\tIN PDEVICE_OBJECT pDevice<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>\tIN PIRP irp</pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>\tPDEV_EXT pdevext<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>\tPIO_STACK_LOCATION pIrpStack<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\tNTSTATUS status <span class=\"token operator\">=</span> STATUS_SUCCESS<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\tKIRQL oldIrql<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>\tKEVENT event<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>\t<span class=\"token comment\">// 获取这真实设备</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>\tpdevext <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>PDEV_EXT<span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span>pDevice<span class=\"token operator\">-></span>DeviceExtension<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>\tpIrpStack <span class=\"token operator\">=</span> <span class=\"token function\">IoGetCurrentIrpStackLocation</span><span class=\"token punctuation\">(</span>irp<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>\t<span class=\"token comment\">// 获取次功能号</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>\t<span class=\"token keyword\">switch</span> <span class=\"token punctuation\">(</span>pIrpStack<span class=\"token operator\">-></span>MinorFunction<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>\t<span class=\"token keyword\">case</span> IRP_MN_REMOVE_DEVICE<span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>\t\t<span class=\"token function\">DbgPrint</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"IRP_MN_REMOVE_DEVICE\\t\\n\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>\t\t<span class=\"token comment\">// 首先把请求发下去</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>\t\t<span class=\"token function\">IoSkipCurrentIrpStackLocation</span><span class=\"token punctuation\">(</span>irp<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>\t\t<span class=\"token function\">IoCallDriver</span><span class=\"token punctuation\">(</span>pdevext<span class=\"token operator\">-></span>pLowerDeviceObject<span class=\"token punctuation\">,</span> irp<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>\t\t<span class=\"token comment\">// 然后接触绑定</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>\t\t<span class=\"token function\">IoDetachDevice</span><span class=\"token punctuation\">(</span>pdevext<span class=\"token operator\">-></span>pLowerDeviceObject<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>\t\t<span class=\"token comment\">// 删除我们生成的虚拟设备</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>\t\t<span class=\"token function\">IoDeleteDevice</span><span class=\"token punctuation\">(</span>pDevice<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>\t\tstatus <span class=\"token operator\">=</span> STATUS_SUCCESS<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>\t\t<span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre></pre></td></tr><tr><td data-num=\"32\"></td><td><pre></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>\t<span class=\"token keyword\">default</span><span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>\t\t<span class=\"token comment\">// 对于其他类型的 IRP，全部直接下发即可</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>\t\t<span class=\"token function\">IoSkipCurrentIrpStackLocation</span><span class=\"token punctuation\">(</span>irp<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>\t\tstatus <span class=\"token operator\">=</span> <span class=\"token function\">IoCallDriver</span><span class=\"token punctuation\">(</span>pdevext<span class=\"token operator\">-></span>pLowerDeviceObject<span class=\"token punctuation\">,</span> irp<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>\t\t<span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>\t<span class=\"token keyword\">return</span> status<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>当 PNP 请求过来时，是没有必要担心还有未完成的 IRP 的。<br />\n这是因为 Windows 系统要求卸载设备，此时 Windows 自己应该已经处理掉了所有未决的 IRP。</p>\n<p>这是和我们自己要求卸载过滤驱动不同的地方。</p>\n<h3 id=\"读的处理\"><a class=\"anchor\" href=\"#读的处理\">#</a> 读的处理</h3>\n<p>前面见过的所有请求，都是处理完毕之后，直接发送到下层驱动之后就不管了。但是在处理键盘读请求时，这样做是不行的。</p>\n<p>当一个读请求到来时，只是说 Windows 要从键盘驱动读取一个键扫描码值，但是在完成之前显然并不清楚这个值到底是多少。<br />\n我们要过滤的目的，就是要获得按下了什么键，所以不得不换一种处理方法，<strong>就是把这个请求下发完成之后，再去看这个值是多少。</strong></p>\n<p>要完成请求，可以采用如下的步骤。</p>\n<p>（1）调用  <code>IoCopyCurrentIrpStackLocationToNext</code>  把当前 IRP 栈空间拷贝到下一个栈空间（这和前面的调用  <code>IoSkipCurrentIrpStackLocation</code>  跳过当前栈空间形成对比）。<br />\n（2）给这个 IRP 设置一个完成函数。完成函数的含义是，如果这个 IRP 完成了，系统就会回调这个函数。<br />\n（3）调用  <code>IoCallDriver</code>  把请求发送到下一个设备</p>\n<p>另外一个需要解决的问题就是我们前面所需要的一个键计数器。</p>\n<p>即一个请求到来时，我们把全局变量  <code>gC2pKeyCount</code>  加 1，等完成之后再减 1。这个处理比较简单。</p>\n<p>完整的读处理请求如下：</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">// 读请求</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>NTSTATUS <span class=\"token function\">myReadDispatch</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>\tIN PDEVICE_OBJECT pDevice<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>\tIN PIRP irp</pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">)</span> </pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>\tNTSTATUS status <span class=\"token operator\">=</span> STATUS_SUCCESS<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>\tPDEV_EXT pdevext<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\tPIO_STACK_LOCATION pIrpStack<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\tKEVENT waitevent<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>\t<span class=\"token function\">KeInitializeEvent</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>waitevent<span class=\"token punctuation\">,</span> NotificationEvent<span class=\"token punctuation\">,</span> FALSE<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>\t<span class=\"token comment\">// 判断是否到达了 irp 栈的最低端</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>irp<span class=\"token operator\">-></span>CurrentLocation <span class=\"token operator\">==</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>\t\tULONG ReturnedInformation <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>\t\t<span class=\"token function\">DbgPrint</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Dispatach encountered bogus current location\\t\\n\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>\t\tstatus <span class=\"token operator\">=</span> STATUS_INVALID_DEVICE_REQUEST<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>\t\tirp<span class=\"token operator\">-></span>IoStatus<span class=\"token punctuation\">.</span>Status <span class=\"token operator\">=</span> status<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>\t\tirp<span class=\"token operator\">-></span>IoStatus<span class=\"token punctuation\">.</span>Information <span class=\"token operator\">=</span> ReturnedInformation<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>\t\t<span class=\"token function\">IoCompleteRequest</span><span class=\"token punctuation\">(</span>irp<span class=\"token punctuation\">,</span> IO_NO_INCREMENT<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>\t\t<span class=\"token keyword\">return</span> status<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>\t<span class=\"token comment\">// 全局变量键计数器加 1</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>\tgC2pKeyCount<span class=\"token operator\">++</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>\t<span class=\"token comment\">// 得到设备扩展，目的是为了获得下一个设备的指针</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>\tpdevext <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>PDEV_EXT<span class=\"token punctuation\">)</span>pDevice<span class=\"token operator\">-></span>DeviceExtension<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>\t<span class=\"token comment\">// 设置回调函数并把 IRP 传递下去。之后读的处理也就结束了。剩下的任务是等待读请求完成</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>\tpIrpStack <span class=\"token operator\">=</span> <span class=\"token function\">IoGetCurrentIrpStackLocation</span><span class=\"token punctuation\">(</span>irp<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>\t<span class=\"token comment\">// 复制当前 IRP 栈空间</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>\t<span class=\"token function\">IoCopyCurrentIrpStackLocationToNext</span><span class=\"token punctuation\">(</span>irp<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>\t<span class=\"token comment\">// 设置完成回调函数</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>\t<span class=\"token function\">IoSetCompletionRoutine</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>\t\tirp<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>\t\tmyReadComplete<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>\t\tpDevice<span class=\"token punctuation\">,</span> TRUE<span class=\"token punctuation\">,</span> TRUE<span class=\"token punctuation\">,</span> TRUE<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>\t<span class=\"token keyword\">return</span> <span class=\"token function\">IoCallDriver</span><span class=\"token punctuation\">(</span>pdevext<span class=\"token operator\">-></span>pLowerDeviceObject<span class=\"token punctuation\">,</span> irp<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h3 id=\"读完成的处理\"><a class=\"anchor\" href=\"#读完成的处理\">#</a> 读完成的处理</h3>\n<p><strong>读请求完成之后，应该获得输出缓冲区，按键信息就在输出缓冲区中，区局变量  <code>gC2pKeyCount</code>  应该减 1。</strong></p>\n<p>如何在缓冲区中获取按键信息呢？ 还需要了解一种数据结构</p>\n<h4 id=\"keyboard_input_data结构\"><a class=\"anchor\" href=\"#keyboard_input_data结构\">#</a> KEYBOARD_INPUT_DATA 结构</h4>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">typedef</span> <span class=\"token keyword\">struct</span> <span class=\"token class-name\">_KEYBOARD_INPUT_DATA</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>  USHORT UnitId<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  USHORT MakeCode<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  USHORT Flags<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  USHORT Reserved<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  ULONG  ExtraInformation<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token punctuation\">&#125;</span> KEYBOARD_INPUT_DATA<span class=\"token punctuation\">,</span> <span class=\"token operator\">*</span>PKEYBOARD_INPUT_DATA<span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p><code>UnitId</code></p>\n<p>指定键盘设备的单元号。键盘设备名称的格式为  <code>\\Device\\KeyboardPort</code>   <em>N</em> ，其中后缀<em> N</em> 是设备的单元号。例如，名称为 <code>\\Device\\KeyboardPort0</code>  的设备的单元号为 <code>0</code> ，名称为 <code>\\Device\\KeyboardPort1</code>  的设备的单元号为 <code>1</code> 。</p>\n<p><code>MakeCode</code></p>\n<p>指定与按键关联的扫描代码。</p>\n<p><code>Flags</code></p>\n<p>指定以下一个或多个标志的按位或，这些标志指示键是被按下还是释放，以及其他杂项信息。</p>\n<table>\n<thead>\n<tr>\n<th style=\"text-align:left\">价值</th>\n<th style=\"text-align:left\">意义</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td style=\"text-align:left\">KEY_MAKE</td>\n<td style=\"text-align:left\">键被按下。</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">KEY_BREAK</td>\n<td style=\"text-align:left\">键被释放了。</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">KEY_E0</td>\n<td style=\"text-align:left\">用于指示特殊键盘功能的扩展扫描码。</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">KEY_E1</td>\n<td style=\"text-align:left\">用于指示特殊键盘功能的扩展扫描码。</td>\n</tr>\n</tbody>\n</table>\n<p><code>Reserved</code></p>\n<p>保留供操作系统使用。</p>\n<p><code>ExtraInformation</code></p>\n<p>指定与键盘事件关联的设备特定信息。</p>\n<hr />\n<p>至于有多少个这样的结构，则取决于输入缓冲区到底有多长。实际上，这种结构的个数应该为：</p>\n<p><code>keys = (irp-&gt;IoStatus.Information) / sizeof(KEYBOARD_INPUT_DATA);</code></p>\n<h4 id=\"读完成函数完整代码\"><a class=\"anchor\" href=\"#读完成函数完整代码\">#</a> 读完成函数完整代码</h4>\n<p>此外，再没有其他的事情需要完成了。所以相关代码比较简单，大致如下：</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>NTSTATUS <span class=\"token function\">myReadComplete</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>\tIN PDEVICE_OBJECT pDevice<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>\tIN PIRP irp<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>\tIN PVOID Context</pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>\tNTSTATUS status<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>\tPIO_STACK_LOCATION pIrpStack<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\tULONG  keys<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\tULONG buf_len <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>\tPKEYBOARD_INPUT_DATA pKeyBoardData<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>\t<span class=\"token comment\">// 获取 IRP 堆栈</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>\tpIrpStack <span class=\"token operator\">=</span> <span class=\"token function\">IoGetCurrentIrpStackLocation</span><span class=\"token punctuation\">(</span>irp<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>\t<span class=\"token comment\">// 判断这个 IRP 是否成功</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">NT_SUCCESS</span><span class=\"token punctuation\">(</span>irp<span class=\"token operator\">-></span>IoStatus<span class=\"token punctuation\">.</span>Status<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>\t\t<span class=\"token comment\">// 获取读请求完成后的输出缓冲区</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>\t\tpKeyBoardData <span class=\"token operator\">=</span> irp<span class=\"token operator\">-></span>AssociatedIrp<span class=\"token punctuation\">.</span>SystemBuffer<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>\t\t<span class=\"token comment\">//irp->IoStatus.Information 其实就是完成信息的大小。得到了按下的键的数量</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>\t\tkeys <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>irp<span class=\"token operator\">-></span>IoStatus<span class=\"token punctuation\">.</span>Information<span class=\"token punctuation\">)</span> <span class=\"token operator\">/</span> <span class=\"token keyword\">sizeof</span><span class=\"token punctuation\">(</span>KEYBOARD_INPUT_DATA<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>\t\t<span class=\"token function\">DbgPrint</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"keys:%d\\t\\n\"</span><span class=\"token punctuation\">,</span> keys<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>\t\t<span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span>size_t i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> keys<span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>\t\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>\t\t\t<span class=\"token function\">DbgPrint</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"numkey:%u\\t\\n\"</span><span class=\"token punctuation\">,</span> keys<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>\t\t\t<span class=\"token comment\">// 按键码不等于字符</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>\t\t\t<span class=\"token function\">DbgPrint</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"sancode:%x\\t\\n\"</span><span class=\"token punctuation\">,</span> pKeyBoardData<span class=\"token operator\">-></span>MakeCode<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>\t\t\t<span class=\"token function\">DbgPrint</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"%s\\t\\n\"</span><span class=\"token punctuation\">,</span> pKeyBoardData<span class=\"token operator\">-></span>Flags <span class=\"token operator\">?</span> <span class=\"token string\">\"Up\"</span> <span class=\"token operator\">:</span> <span class=\"token string\">\"Down\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>\t\t\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>pKeyBoardData<span class=\"token operator\">-></span>MakeCode <span class=\"token operator\">==</span> <span class=\"token number\">0x1f</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>\t\t\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>\t\t\t\t<span class=\"token comment\">// 过滤按键，修改为 0x20 </span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>\t\t\t\t<span class=\"token comment\">// 这里也可以做其他的许多事情：键盘记录等等</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>\t\t\t\tpKeyBoardData<span class=\"token operator\">-></span>MakeCode <span class=\"token operator\">=</span> <span class=\"token number\">0x20</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>\t\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>\t\t\t</pre></td></tr><tr><td data-num=\"37\"></td><td><pre>\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>\tgC2pKeyCount<span class=\"token operator\">--</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>irp<span class=\"token operator\">-></span>PendingReturned<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>\t\t<span class=\"token function\">IoMarkIrpPending</span><span class=\"token punctuation\">(</span>irp<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>\t<span class=\"token keyword\">return</span> irp<span class=\"token operator\">-></span>IoStatus<span class=\"token punctuation\">.</span>Status<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>这里的读完成函数我们只是简单的打印了<strong>对应每次按键信息</strong>的结构体 <code>KEYBOARD_INPUT_DATA</code>  中的成员，并且把所有 <code>MakeCode</code>  值为 <code>0x1f</code>  修改为了 <code>0x20</code> , 这样当按下 <code>s</code>  键时会替换成为  <code>d</code>  键。</p>\n<h4 id=\"从makecode到实际字符\"><a class=\"anchor\" href=\"#从makecode到实际字符\">#</a> 从 MakeCode 到实际字符</h4>\n<p>接下来我们将尽力地把按键显示成可以显示的字符。虽然这并不总是可行的（比如按下 <code>Shift</code>  键然后弹起，显然密码框里不会因此被输入一个字符），这涉及扫描码和实际字符是如何对应的。</p>\n<p>所谓的实际字符就是 <code>ASCII</code>  码。大家都知道大写 / 小写字符的 ASCII 码并不相同，但是键是同一个（就是说扫描码是相同的），具体是哪个取决于几个键的状态（包括 <code>Shift</code>  键、 <code>Caps Lock</code>  键）。因此，这个模块在过滤按键的同时，也必须把这几个控制键的状态保存下来。</p>\n<p>请注意 <code>Shift</code>  键和 <code>Caps Lock</code>  键的不同： <code>Shift</code>  键是按下生效，释放则无效了；而 <code>Caps Lock</code>  键是按一次生效，再按一次无效了。因此过滤的方法也不<br />\n一样。</p>\n<p>具体实现见代码。</p>\n<h1 id=\"运行结果\"><a class=\"anchor\" href=\"#运行结果\">#</a> 运行结果</h1>\n<p>代码放在 github 了， <span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL09yMGtpdC9GbHRlcjAy\">https://github.com/Or0kit/Flter02</span></p>\n<p><img data-src=\"image002.png\" alt=\"\" /></p>\n",
            "tags": [
                "键盘过滤",
                "PDO",
                "Windows中从击键到内核的过程",
                "KEYBOARD_INPUT_DATA结构",
                "IRP完成回调函数"
            ]
        },
        {
            "id": "https://or0kit.github.io/Bin/Core/Drive-Development/%E4%B8%B2%E5%8F%A3%E7%9A%84%E8%BF%87%E6%BB%A4/",
            "url": "https://or0kit.github.io/Bin/Core/Drive-Development/%E4%B8%B2%E5%8F%A3%E7%9A%84%E8%BF%87%E6%BB%A4/",
            "title": "过滤驱动-串口的过滤",
            "date_published": "2022-07-05T20:10:32.000Z",
            "content_html": "<h1 id=\"过滤filter的概念\"><a class=\"anchor\" href=\"#过滤filter的概念\">#</a> 过滤（Filter）的概念</h1>\n<p>过滤是及其重要的一个概念，过滤是在不影响上层和下层解耦你的情况下，在 Windows 系统内核中加入新的层，从而不需要修改上层软件或者下层的真实驱动程序，就加入了新的功能。</p>\n<p>例如：实时监控的反病毒软件。</p>\n<p>反病毒软件需要在不改变文件系统上层和下层接口的情况下，在中间层加入一个过滤层，这样就可以在上次软件读取文件、下层驱动提供数据时，对这些数据进行扫描，看其中是否含有某个病毒的特征码。</p>\n<p>这是一个典型的过滤过程。</p>\n<h1 id=\"串口过滤\"><a class=\"anchor\" href=\"#串口过滤\">#</a> 串口过滤</h1>\n<p>串行接口，简称串口，也就是 COM 接口，是采用串行通信协议的扩展接口。<br />\n串口的出现是在 1980 年前后，数据传输率是 115kbps～230kbps，串口一般用来连接鼠标和外置 Modem 以及老式摄像头和写字板等设备，目前部分新主板已开始取消该接口。</p>\n<p>现在 USB 取代了串口，可是给串口留下了后路。没有串口的电脑上，只需要接上一个 USB 转串口的转换器就可以了。具体可以上淘宝、天猫查看实物图。</p>\n<p>串口的过滤很简单，在安全开发中意义也不大，只是作为学习，为之后的键盘过滤和文件系统过滤等打基础。</p>\n<p>在 Windows 中串口设备是有固定名字的。<br />\n第一个串口名字为  <code>\\Device\\Serial0</code>  ，第二个串口的名字为  <code>\\Device\\Serial1</code>  ，以此类推。注意 C 语言中的 <code>\\</code>  要写成 <code>\\\\</code> 。</p>\n<h2 id=\"设备绑定的内核api\"><a class=\"anchor\" href=\"#设备绑定的内核api\">#</a> 设备绑定的内核 API</h2>\n<p>进行过滤的最主要方法是对一个设备对象（Device Object）进行绑定。通过编程生成一个虚拟设备，并 “绑定”（Attach）在一个真实的设备上。一旦绑定，则本来操作系统发送给真实设备的请求，就会首先发送的这个虚拟设备。</p>\n<p>我们可以首先认为：一个正是的设备对应一个设备对象（虽然实际的对应关系可能复杂的多）。</p>\n<p>在 WDK 中，有多个内核 API 能实现绑定功能。</p>\n<h3 id=\"ioattachdevice\"><a class=\"anchor\" href=\"#ioattachdevice\">#</a> IoAttachDevice</h3>\n<p>下面是其中一个函数的原型：</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>NTSTATUS   </pre></td></tr><tr><td data-num=\"2\"></td><td><pre>   <span class=\"token function\">IoAttachDevice</span><span class=\"token punctuation\">(</span>  </pre></td></tr><tr><td data-num=\"3\"></td><td><pre>           IN PDEVICE_OBJECT SourceDevice<span class=\"token punctuation\">,</span>  </pre></td></tr><tr><td data-num=\"4\"></td><td><pre>           IN PUNICODE_STRING TargetDevice<span class=\"token punctuation\">,</span>  </pre></td></tr><tr><td data-num=\"5\"></td><td><pre>           OUT PDEVICE_OBJECT <span class=\"token operator\">*</span>AttachedDevice  </pre></td></tr><tr><td data-num=\"6\"></td><td><pre>          <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>参数：</p>\n<p><code>SourceDevice</code>  是调用者生成的用来过滤的虚拟设备。<br />\n <code>TargetDevice</code>  是要被绑定的目标设备。<strong>注意此参数的类型是  <code>PUNICODE_STRING</code>  是一个字符串，这个字符串是被绑定的设备的名字</strong>。<br />\n <code>AttachedDevice</code>  是荣来返回的二级指针。</p>\n<p><strong>注意：</strong></p>\n<p>Windows 中并不是所有的设备对象都有名字，只有有名字的设备，才能用这个内核 API 绑定。</p>\n<h3 id=\"设备栈\"><a class=\"anchor\" href=\"#设备栈\">#</a> 设备栈</h3>\n<p>绑定设备这里还有一个疑问：</p>\n<p>假设使用这个函数绑定一个名字所对应的设备，那么如果这个设备已经被其他设备绑定了，会怎样呢？</p>\n<p>如果一个设备被其他设备绑定了，它们在一起的一组设备，被称为设备栈（详细可以参考<span class=\"exturl\" data-url=\"aHR0cDovL3d3dy5wbnBvbi5jb20vYXJ0aWNsZS9kZXRhaWwtMjE1Lmh0bWw=\"> http://www.pnpon.com/article/detail-215.html</span>）。</p>\n<p><strong>实际上，  <code>IoAttachDevice</code>  总是会绑定设备栈上最顶层的那个设备。</strong></p>\n<h3 id=\"ioattachdevicetodevicestack和ioattachdevicetodevicestacksafe\"><a class=\"anchor\" href=\"#ioattachdevicetodevicestack和ioattachdevicetodevicestacksafe\">#</a> IoAttachDeviceToDeviceStack 和 IoAttachDeviceToDeviceStackSafe</h3>\n<p>并不是所有的设备都有名字，所以依靠 <code>IoAttachDevice</code>  无法绑定没有名字的设备。另外还有两个 API：一个是  <code>IoAttachDeviceToDeviceStack</code>  ，另一个是  <code>IoAttachDeviceToDeviceStackSafe</code>  。这两个函数的功能一样，都是根据设备对象的指针（而不是名字）进行绑定；区别是  <code>IoAttachDeviceToDeviceStackSafe</code>  更加安全，而且只有在  <code>Windows 2000 SP4</code>  和  <code>Windows XP</code>  以上的系统中才有用。  <code>一般都使用IoAttachDeviceToDeviceStackSafe</code>  ，但是当试图兼容较低版本的 <code>Windows 2000</code>  时，应该使用 <code>IoAttachDeviceToDeviceStack</code> 。</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>NTSTATUS</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token function\">IoAttachDeviceToDeviceStackSafe</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    _In_  PDEVICE_OBJECT SourceDevice<span class=\"token punctuation\">,</span>                <span class=\"token comment\">// 过滤设备</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    _In_  PDEVICE_OBJECT TargetDevice<span class=\"token punctuation\">,</span>                <span class=\"token comment\">// 要被绑定的设备栈中的设备</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    _Outptr_ PDEVICE_OBJECT <span class=\"token operator\">*</span>AttachedToDeviceObject   <span class=\"token comment\">// 返回最终被绑定的设备</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>PDEVICE_OBJECT</pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token function\">IoAttachDeviceToDeviceStack</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    _In_ PDEVICE_OBJECT SourceDevice<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    _In_ PDEVICE_OBJECT TargetDevice</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p><code>IoAttachDeviceToDeviceStackSafe</code>  和第一个 API 类似，只是  <code>TargetDevice</code>  换成了一个指针。另外， <code>AttachedToDeviceObject</code>  同样也是返回最终被绑定的设备，实际上也就是绑定之前设备栈上最顶端的那个设备。</p>\n<p>在 <code>Windows 2000</code>  下应该使用另外一个函数  <code>IoAttachDeviceToDeviceStack</code> ，这个函数除了缺少最后一个参数（实际上放到返回值里了），其他的和 <code>IoAttachDeviceToDeviceStackSafe</code>  函数相同。 <code>IoAttachDeviceToDeviceStack</code>  函数返回了最终被绑定的设备指针，这也就导致了它不能返<br />\n回一个明确的错误码。但是如果为 NULL，则表示绑定失败了。</p>\n<h2 id=\"生成过滤设备并绑定\"><a class=\"anchor\" href=\"#生成过滤设备并绑定\">#</a> 生成过滤设备并绑定</h2>\n<p>在绑定一个设备之前，先要知道如何生成一个用于过滤的设备。函数 <code>IoCreateDevice</code>  被用于生成过滤设备：</p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>NTSTATUS <span class=\"token function\">IoCreateDevice</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    _In_  PDRIVER_OBJECT DriverObject<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    _In_  ULONG DeviceExtensionSize<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    _In_opt_ PUNICODE_STRING DeviceName<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    _In_  DEVICE_TYPE DeviceType<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    _In_  ULONG DeviceCharacteristics<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    _In_  BOOLEAN Exclusive<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    PDEVICE_OBJECT <span class=\"token operator\">*</span>DeviceObject  <span class=\"token comment\">// 二级指针</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>这个函数之前学习 3 环 0 环通信的时候，用过。</p>\n<p><code>DeviceExtensionSize</code>  是设备扩展，先简单地传入 0。<br />\n <code>DeviceName是</code> 设备名字。有一个规则是：过滤设备一般不需要名称，所以传入 NULL 即可。<br />\n <code>DeviceType</code>  是设备类型，保持和被绑定的设备类型一致即可。<br />\n <code>DeviceCharacteristics</code>  是设备特征，在生成设备对象时可以直接填 0，然后看是否排斥，选择 FALSE。</p>\n<p>值得注意的是，在绑定一个设备之前，应该把这个设备对象的多个子域设置成和要绑定的目标对象一致，包括标志和特征。下面是一个示例的函数，这个函数可以生成一个设备，然后绑定在另一个设备上。</p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>NTSTATUS <span class=\"token function\">ccpAttachDevice</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>\tPDRIVER_OBJECT driver<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>\tPDEVICE_OBJECT oldobj<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>\tPDEVICE_OBJECT<span class=\"token operator\">*</span> fltobj<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>\tPDEVICE_OBJECT<span class=\"token operator\">*</span> next</pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>\tNTSTATUS status<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\tPDEVICE_OBJECT topdev <span class=\"token operator\">=</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>\t<span class=\"token comment\">// 生成设备，然后绑定</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>\tstatus <span class=\"token operator\">=</span> <span class=\"token function\">IoCreateDevice</span><span class=\"token punctuation\">(</span>driver<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>\t\t<span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>\t\toldobj<span class=\"token operator\">-></span>DeviceType<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>\t\t<span class=\"token number\">0</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>\t\tFALSE<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>\t\tfltobj<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>status<span class=\"token operator\">!=</span> STATUS_SUCCESS<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>\t\t<span class=\"token keyword\">return</span> status<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>\t<span class=\"token comment\">// 拷贝重要标志位</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>oldobj<span class=\"token operator\">-></span>Flags <span class=\"token operator\">&amp;</span> DO_BUFFERED_IO<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>\t\t<span class=\"token punctuation\">(</span><span class=\"token operator\">*</span>fltobj<span class=\"token punctuation\">)</span><span class=\"token operator\">-></span>Flags <span class=\"token operator\">|=</span> DO_BUFFERED_IO<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>oldobj<span class=\"token operator\">-></span>Flags <span class=\"token operator\">&amp;</span> DO_DIRECT_IO<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>\t\t<span class=\"token punctuation\">(</span><span class=\"token operator\">*</span>fltobj<span class=\"token punctuation\">)</span><span class=\"token operator\">-></span>Flags <span class=\"token operator\">|=</span> DO_DIRECT_IO<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>oldobj<span class=\"token operator\">-></span>Characteristics <span class=\"token operator\">&amp;</span> FILE_DEVICE_SECURE_OPEN<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>\t\t<span class=\"token punctuation\">(</span><span class=\"token operator\">*</span>fltobj<span class=\"token punctuation\">)</span><span class=\"token operator\">-></span>Characteristics <span class=\"token operator\">|=</span> FILE_DEVICE_SECURE_OPEN<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>\t<span class=\"token punctuation\">(</span><span class=\"token operator\">*</span>fltobj<span class=\"token punctuation\">)</span><span class=\"token operator\">-></span>Flags <span class=\"token operator\">|=</span> DO_POWER_PAGABLE<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>\t<span class=\"token comment\">// 将一个设备绑定到另一个设备上</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>\tstatus <span class=\"token operator\">=</span> <span class=\"token function\">IoAttachDeviceToDeviceStackSafe</span><span class=\"token punctuation\">(</span><span class=\"token operator\">*</span>fltobj<span class=\"token punctuation\">,</span> oldobj<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>topdev<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>\t<span class=\"token comment\">// topdev = IoAttachDeviceToDeviceStack(*fltobj, oldobj);</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"47\"></td><td><pre>\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>status <span class=\"token operator\">!=</span> STATUS_SUCCESS<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>\t\t<span class=\"token comment\">// 如果绑定失败，销毁设备，返回错误</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>\t\t<span class=\"token function\">IoDeleteDevice</span><span class=\"token punctuation\">(</span><span class=\"token operator\">*</span>fltobj<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>\t\t<span class=\"token operator\">*</span>fltobj <span class=\"token operator\">=</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre>\t\t<span class=\"token keyword\">return</span> status<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre></pre></td></tr><tr><td data-num=\"55\"></td><td><pre>\t<span class=\"token operator\">*</span>next <span class=\"token operator\">=</span> topdev<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre></pre></td></tr><tr><td data-num=\"57\"></td><td><pre>\t<span class=\"token comment\">// 设置这个设备已经启动</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre>\t<span class=\"token punctuation\">(</span><span class=\"token operator\">*</span>fltobj<span class=\"token punctuation\">)</span><span class=\"token operator\">-></span>Flags <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">*</span>fltobj<span class=\"token punctuation\">)</span><span class=\"token operator\">-></span>Flags <span class=\"token operator\">&amp;</span> <span class=\"token operator\">~</span>DO_DEVICE_INITIALIZING<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"59\"></td><td><pre></pre></td></tr><tr><td data-num=\"60\"></td><td><pre>\t<span class=\"token keyword\">return</span> STATUS_SUCCESS<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"61\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h2 id=\"从名字获得设备对象\"><a class=\"anchor\" href=\"#从名字获得设备对象\">#</a> 从名字获得设备对象</h2>\n<p>在知道一个设备名字的情况下，使用函数  <code>IoGetDeviceObjectPointer</code>  可以获得这个设备对象的指针。</p>\n<p>函数原型如下：</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>NTSTATUS</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token function\">IoGetDeviceObjectPointer</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    _In_  PUNICODE_STRING ObjectName<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    _In_  ACCESS_MASK DesiredAccess<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    _Out_ PFILE_OBJECT <span class=\"token operator\">*</span>FileObject<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    _Out_ PDEVICE_OBJECT <span class=\"token operator\">*</span>DeviceObject</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p><code>ObjectName</code>  就是设备的名字。<br />\n <code>DesiredAccess</code>  是期望访问的权限。在实际使用可以不顾忌那么多，直接填写  <code>FILE_ALL_ACCESS</code>  即可。<br />\n <code>FileObject</code>  是一个返回参数，即在获得这个设备对象的同时会得到一个文件对象（File Object）。<br />\n要得到的设备对象就返回在参数  <code>DeviceObject</code>  中了。<br />\n就打开串口设备这件事而言，这个文件对象并没有什么用处。但是必须注意，在使用该函数之后必须把这个文件对象 “解除引用”；否则会引起内存泄漏。</p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">// 因为用到了 RtlStringCchPrintfW，所以必须包含头文件 ntstrsafe.h</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\">// 定义 NTSTRSAFE_LIB 是为了使用 ntstrsafe 静态库，这样才能兼容 Windows 2000</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\">// #define NTSTRSAFE_LIB</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span><span class=\"token string\">&lt;ntstrsafe.h></span></span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token comment\">// 打开一个端口设备</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>PDEVICE_OBJECT <span class=\"token function\">ccpOpenCom</span><span class=\"token punctuation\">(</span>ULONG id<span class=\"token punctuation\">,</span> NTSTATUS <span class=\"token operator\">*</span>status<span class=\"token punctuation\">)</span> </pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\t<span class=\"token comment\">// 外面输入的是串口 id，这里改写成字符串的形式</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>\tUNICODE_STRING name_str<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>\t<span class=\"token keyword\">static</span> WCHAR name<span class=\"token punctuation\">[</span><span class=\"token number\">32</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span> <span class=\"token number\">0</span> <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>\tPFILE_OBJECT fileobj <span class=\"token operator\">=</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>\tPDEVICE_OBJECT devobj <span class=\"token operator\">=</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>\t<span class=\"token comment\">// 输入字符串</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>\t<span class=\"token function\">memset</span><span class=\"token punctuation\">(</span>name<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">sizeof</span><span class=\"token punctuation\">(</span>WCHAR<span class=\"token punctuation\">)</span> <span class=\"token operator\">*</span> <span class=\"token number\">32</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>\t<span class=\"token function\">RtlStringCchPrintfW</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>\t\tname<span class=\"token punctuation\">,</span> <span class=\"token number\">32</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>\t\tL<span class=\"token string\">\"\\\\Device\\\\Serial%d\"</span><span class=\"token punctuation\">,</span> id<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>\t<span class=\"token function\">RtlInitUnicodeString</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>name_str<span class=\"token punctuation\">,</span> name<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>\t<span class=\"token comment\">// 打开设备对象</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>\t<span class=\"token operator\">*</span>status <span class=\"token operator\">=</span> <span class=\"token function\">IoGetDeviceObjectPointer</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>name_str<span class=\"token punctuation\">,</span> FILE_ALL_ACCESS<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>fileobj<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>devobj<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">*</span>status <span class=\"token operator\">==</span> STATUS_SUCCESS<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>\t\t<span class=\"token comment\">// 没有用到文件对象，解除对其引用</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>\t\t<span class=\"token function\">ObDereferenceObject</span><span class=\"token punctuation\">(</span>fileobj<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>\t<span class=\"token keyword\">return</span> devobj<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre></pre></td></tr><tr><td data-num=\"33\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h2 id=\"绑定所有串口\"><a class=\"anchor\" href=\"#绑定所有串口\">#</a> 绑定所有串口</h2>\n<p>为了后面的过滤，这里必须把过滤设备和被绑定的设备（后面暂且称为真实设备吧，虽然这些设备未必真实）的设备对象指针保存起来。下面的代码使用两个数组保存。数组应该多大，取决于一台计算机上最多能有多少个串口。读者应该去查阅 IBM PC 标准，这里随意地写一个自认为足够大的数字。</p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">// 设置最大的串口数</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">CCP_MAX_COM_ID</span> <span class=\"token expression\"><span class=\"token number\">32</span></span></span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token comment\">// 保存所有的过滤设备指针</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token keyword\">static</span> PDEVICE_OBJECT s_fltobj<span class=\"token punctuation\">[</span>CCP_MAX_COM_ID<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span> <span class=\"token number\">0</span> <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token comment\">// 保存所有真实设备的指针</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token keyword\">static</span> PDEVICE_OBJECT s_nextobj<span class=\"token punctuation\">[</span>CCP_MAX_COM_ID<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span> <span class=\"token number\">0</span> <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token comment\">// 这个函数绑定所有的串口</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token keyword\">void</span> <span class=\"token function\">ccpAttachAllComs</span><span class=\"token punctuation\">(</span>PDRIVER_OBJECT driver<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>\tUSHORT i<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>\tPDEVICE_OBJECT com_ob<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>\tNTSTATUS status<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>\t<span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span> i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> CCP_MAX_COM_ID<span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>\t\t<span class=\"token comment\">// 获得串口对象引用</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>\t\tcom_ob <span class=\"token operator\">=</span> <span class=\"token function\">ccpOpenCom</span><span class=\"token punctuation\">(</span>i<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>status<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>\t\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>com_ob<span class=\"token operator\">==</span><span class=\"token constant\">NULL</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>\t\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>\t\t\t<span class=\"token keyword\">continue</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>\t\t</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>\t\t<span class=\"token comment\">// 在这里绑定。并不管绑定是否成功。</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>\t\t<span class=\"token function\">ccpAttachDevice</span><span class=\"token punctuation\">(</span>driver<span class=\"token punctuation\">,</span> com_ob<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>s_fltobj<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>s_nextobj<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span> </pre></td></tr><tr><td data-num=\"29\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>没有必要关心这个绑定是否成功，就算失败了，看一下  <code>s_fltobj</code>  即可。在这个数组中不为 <code>NULL</code>  的成员表示已经绑定了，为 <code>NULL</code>  的成员则是没有绑定或者绑定失败的。这个函数需要一个 <code>DRIVER_OBJECT</code>  的指针，这是本驱动的驱动对象，是系统在 <code>DriverEntry</code>  中传入的。</p>\n<h2 id=\"获取实际数据\"><a class=\"anchor\" href=\"#获取实际数据\">#</a> 获取实际数据</h2>\n<p>我们一直都在开发一个可以捕获串口上的数据的过滤程序。现在虚拟设备已经绑定了真正的串口设备，那么如何从虚拟设备得到串口上流过的数据呢？</p>\n<p>答案是根据 “请求”。</p>\n<p><strong>操作系统将请求发送给串口设备，请求中就含有要发送的数据，请求的回答中则含有要接收的数据。</strong></p>\n<p>下面分析这些 “请求”，以便得到实际的串口数据流。</p>\n<h3 id=\"请求的区分\"><a class=\"anchor\" href=\"#请求的区分\">#</a> 请求的区分</h3>\n<p>Windows 内核的开发者确定了很多数据结构，目前已经与 <code>DEVICE_OBJECT</code> （设备对象）、 <code>FILE_OBJECT</code> （文件对象）和 <code>DRIVER_OBJECT</code> （驱动对象）见了面。</p>\n<p>我们还需知道以下几点内容：</p>\n<ol>\n<li>每个驱动程序只有一个驱动对象。</li>\n<li>每个程序可以生成若干个设备对象，这些设备对象从属与一个驱动对象。</li>\n<li>若干个设备（它们可以属于不同的驱动）依次绑定形成一个设备栈，总是最顶端的设备先接受到请求。</li>\n</ol>\n<p><strong>需要注意的是：</strong>  <code>IRP</code>  是上层设备之间传递请求的常见数据结构，但绝对不是唯一的数据结构。传递请求还有很多其他的方法，不同的设备也可能使用不同的结构来传递请求。</p>\n<blockquote>\n<p>串口设备接收到的请求都是 IRP，因此只要对所有的 IRP 进行过滤，就可以得到串口上流过的所有数据。</p>\n<blockquote>\n<p>串口过滤时只需要关心两种请求：读请求和写请求。</p>\n<blockquote>\n<p>对于串口而言，读指的是接收数据，而写指的是发出数据。</p>\n</blockquote>\n</blockquote>\n</blockquote>\n<blockquote>\n<p>串口也还有其他的请求，比如打开和关闭、设置波特率等。<br />\n但是我们的目标只是获得串口上流过的数据，而不关心打开 / 关闭和波特率是多少这样的问题，所以一概无视这类问题。</p>\n</blockquote>\n<p>请求可以通过 IRP 的<strong>主功能号</strong>进行区分。</p>\n<p>IRP 的<strong>主功能号</strong>是保存在 IRP 栈空间中的一个字节，用来标识这个 IRP 的功能大类。相应地，还有一个<strong>次功能号</strong>来标识这个 IRP 的功能细分小类。</p>\n<p>读请求的<strong>主功能号</strong>为 <code>IRP_MJ_READ</code> ，而写请求的<strong>主功能号</strong>为 <code>IRP_MJ_WRITE</code> 。</p>\n<p>下面的方法用于从一个 IRP 指针得到<strong>主功能号</strong>（这里的变量 irp 是一个 PIRP，也就是 IRP 的指针）。</p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">// 这里的 irpsp 称为 IRP 的栈空间，IoGetCurrentIrpStackLocation 用来获取当前栈空间</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\">// 栈空间是非常重要的数据结构</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>PIO_STACK_LOCATION irpsp <span class=\"token operator\">=</span> <span class=\"token function\">IoGetCurrentIrpStackLocation</span><span class=\"token punctuation\">(</span>irp<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>irpsp<span class=\"token operator\">-></span>MajorFunction <span class=\"token operator\">==</span> IRP_MJ_WRITE<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  <span class=\"token comment\">// 如果是写请求……</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>irpsp<span class=\"token operator\">-></span>MajorFunction <span class=\"token operator\">==</span> IRP_MJ_READ<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  <span class=\"token comment\">// 如果是读请求……</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h3 id=\"请求的结局\"><a class=\"anchor\" href=\"#请求的结局\">#</a> 请求的结局</h3>\n<p>对请求的过滤，最终的结局有三种。</p>\n<ol>\n<li>请求被允许通过了。</li>\n</ol>\n<p>过滤不做任何事情，或者简单地获取请求的一些信息。但是请求本身不受干扰，这样系统行为不会有变化。</p>\n<ol start=\"2\">\n<li>请求直接被否决了。</li>\n</ol>\n<p>过滤禁止这个请求通过，这个请求被返回了错误，下层驱动程序根本收不到这个请求。这样系统行为就变了，后果是常常看见上层应用程序弹出错误框提示权限错误或者读取文件失败之类的信息。</p>\n<ol start=\"3\">\n<li>过滤完成了这个请求。</li>\n</ol>\n<p>有时有这样的需求，比如一个读请求，我们想记录读到了什么。如果读请求还没有完成，那么如何知道到底会读到什么呢？只有让这个请求先完成再去记录。过滤完成这个请求时不一定要原封不动地完成，这个请求的参数可以被修改（比如把数据都加密）。</p>\n<hr />\n<p>当过滤了一个请求时，就必须把这个请求按照上面三种方法之一进行处理。</p>\n<p>当然，这些代码会写在一个处理函数中。这里先介绍这些处理方法的代码应该怎么写。</p>\n<p><em><strong>串口过滤要捕获两种数据：一种是发送出的数据（也就是写请求中的数据）；另一种是接收的数据（也就是读请求中的数据）。</strong></em></p>\n<p>为了简单起见，我们只捕获发送出的数据，这样，只需要采取第一种处理方法即可。</p>\n<p>这种处理最简单。</p>\n<p>首先调用  <code>IoSkipCurrentIrpStackLocation</code>  跳过当前栈空间；然后调用  <code>IoCallDriver</code>  把这个请求发送给真实的设备。</p>\n<p>请注意，因为真实的设备已经被过滤设备绑定，所以首先接收到 IRP 的是过滤设备的对象。</p>\n<p>代码如下（irp 是过滤到的请求）：</p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">// 跳过当前栈空间</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>\t<span class=\"token function\">IoSkipCurrentIrpStackLocation</span><span class=\"token punctuation\">(</span>irp<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>\t<span class=\"token comment\">// 将请求发送到对应的真实设备。我们起起那么把真实设备都保存在了 s_nextobj</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>\t<span class=\"token comment\">// 数组中。那么这里 i 应该是多少？这取决于现在的 IRP 发送到了那个过滤设备上。</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>\tstatus <span class=\"token operator\">=</span> <span class=\"token function\">IoCallDriver</span><span class=\"token punctuation\">(</span>s_nextobj<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> irp<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><h3 id=\"写请求的数据\"><a class=\"anchor\" href=\"#写请求的数据\">#</a> 写请求的数据</h3>\n<p>一个写请求（也就是串口一次发送出的数据）保存在哪里呢？我们要获取写数据的请求，自然要知道其是怎么保存的。</p>\n<p>关于 IRP 结构的描述，一共有三个地方可以描述缓冲区： <code>irp→MDLAddress</code>  、  <code>irp→UserBuffer</code>  和  <code>irp→AssociatedIrp.SystemBuffer</code> 。</p>\n<p>不同的 IO 类别，IRP 的缓冲区不同。<br />\n <code>SystemBuffer</code>  是一般用于比较简单且不追求效率情况的解决方案：把应用层（R3 层）内存空间中的缓冲数据拷贝到内核空间。</p>\n<p><code>UserBuffer</code>  则是最追求效率的解决方案。应用层的缓冲区地址直接放在 <code>UserBuffer</code>  里，在内核空间中访问。在当前进程和发送请求进程一致的情况下，内核访问应用层的内存空间当然是没错的。但是一旦内核进程已经切换，这个访问就结束了，访问 <code>UserBuffer</code>  当然是跳到其他进程空间中了。</p>\n<p>一个更简单的解决方案是把应用层的地址空间映射到内核空间，这需要在页表中增加一个映射。</p>\n<p>当然不需要编程者手工去修改页表，通过构造 <code>MDL</code>  就能实现这个功能。</p>\n<p><code>MDL</code>  可以翻译为 “内存描述符链”，但是按照业界传统习惯一律称之为 <code>MDL</code> 。</p>\n<p>IRP 中的 <code>MDLAddress</code>  域是一个 <code>MDL</code>  的指针，从这个 <code>MDL</code>  中可以读出一个内核空间的虚拟地址。这就弥补了 UserBuffer 的不足，同时比 SystemBuffer 的完全拷贝方法要轻量，因为这个内存实际上还是在老地方，没有拷贝。</p>\n<p><strong>回到串口的问题上，那么串口写请求到底用的是哪种方式呢？ 我们并不需要去知道是哪种方式。用下面的编码方式，无论采用哪种方式，都可以把数据正确地读出来</strong></p>\n<p>此外是缓冲区有多长的问题。对于一个写操作而言，长度可以通过如下方式获得： <code>ULONG len = irpsp-&gt;Parameters.Write.Length;</code></p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">// 如果是写，先获得长度</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>ULONG len <span class=\"token operator\">=</span> irpsp<span class=\"token operator\">-></span>Parameters<span class=\"token punctuation\">.</span>Write<span class=\"token punctuation\">.</span>Length<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\">// 然后获得缓冲区</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>PUCHAR buffer <span class=\"token operator\">=</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>irp<span class=\"token operator\">-></span>MdlAddress <span class=\"token operator\">!=</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  buffer <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>PUCHAR<span class=\"token punctuation\">)</span><span class=\"token function\">MmGetSystemAddressForMdlSafe</span><span class=\"token punctuation\">(</span>irp<span class=\"token operator\">-></span>MdlAddress<span class=\"token punctuation\">,</span> NormalPagePriority<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token keyword\">else</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  buffer <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>PUCHAR<span class=\"token punctuation\">)</span>irp<span class=\"token operator\">-></span>UserBuffer<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>buffer <span class=\"token operator\">==</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  buffer <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>PUCHAR<span class=\"token punctuation\">)</span>irp<span class=\"token operator\">-></span>AssociatedIrp<span class=\"token punctuation\">.</span>SystemBuffer<span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>涉及了  <code>MmGetSystemAddressForMdlSafe</code>  函数，可以查看 WDK 文档: <span class=\"exturl\" data-url=\"aHR0cHM6Ly9kb2NzLm1pY3Jvc29mdC5jb20vemgtY24vd2luZG93cy1oYXJkd2FyZS9kcml2ZXJzL2RkaS93ZG0vbmYtd2RtLW1tZ2V0c3lzdGVtYWRkcmVzc2Zvcm1kbHNhZmU=\">https://docs.microsoft.com/zh-cn/windows-hardware/drivers/ddi/wdm/nf-wdm-mmgetsystemaddressformdlsafe</span></p>\n<h2 id=\"完整的代码\"><a class=\"anchor\" href=\"#完整的代码\">#</a> 完整的代码</h2>\n<p>接下来编写完整的串口过滤代码。</p>\n<h3 id=\"完整的分发函数\"><a class=\"anchor\" href=\"#完整的分发函数\">#</a> 完整的分发函数</h3>\n<p>基于前面的描述，我们来编写完整的分发函数。</p>\n<p>这个函数处理所有串口的写请求，所有从串口输出的数据都用 <code>DbgPrint</code>  打印出来。也就是说，读者打开 <code>DbgView.exe</code> ，就可以看到串口的输出数据了。</p>\n<p>这当然不如一些比较专业的串口嗅探软件，可以以这个例子为基础开发更专业的工具。</p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>NTSTATUS <span class=\"token function\">ccpDispatch</span><span class=\"token punctuation\">(</span>PDEVICE_OBJECT device<span class=\"token punctuation\">,</span> PIRP irp<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>\t<span class=\"token comment\">// 这里的 irpsp 称为 IRP 的栈空间，IoGetCurrentIrpStackLocation 用来获取当前栈空间</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>\t<span class=\"token comment\">// 栈空间是非常重要的数据结构</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>\tPIO_STACK_LOCATION irpsp <span class=\"token operator\">=</span> <span class=\"token function\">IoGetCurrentIrpStackLocation</span><span class=\"token punctuation\">(</span>irp<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>\tNTSTATUS status<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>\tULONG i<span class=\"token punctuation\">,</span> j<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\t<span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span> i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> CCP_MAX_COM_ID<span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>\t\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>s_fltobj<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span> <span class=\"token operator\">==</span> device<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>\t\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>\t\t\t<span class=\"token comment\">// 所有电源操作，全部直接放过</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>\t\t\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>irpsp<span class=\"token operator\">-></span>MajorFunction <span class=\"token operator\">==</span> IRP_MJ_POWER<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>\t\t\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>\t\t\t\t<span class=\"token comment\">// 直接发送，然后返回说已经被处理了</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>\t\t\t\t<span class=\"token function\">PoStartNextPowerIrp</span><span class=\"token punctuation\">(</span>irp<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>\t\t\t\t<span class=\"token function\">IoSkipCurrentIrpStackLocation</span><span class=\"token punctuation\">(</span>irp<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>\t\t\t\t<span class=\"token keyword\">return</span> <span class=\"token function\">PoCallDriver</span><span class=\"token punctuation\">(</span>s_nextobj<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> irp<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>\t\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>\t\t\t<span class=\"token comment\">// 我们只过滤写请求。</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>\t\t\t<span class=\"token comment\">// 写请求，获得缓冲区及其长度，然后打印。</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>\t\t\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>irpsp<span class=\"token operator\">-></span>MajorFunction <span class=\"token operator\">==</span> IRP_MJ_WRITE<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>\t\t\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>\t\t\t\t<span class=\"token comment\">// 如果是写请求……</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>\t\t\t\t<span class=\"token comment\">// 如果是写，先获得长度</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>\t\t\t\tULONG len <span class=\"token operator\">=</span> irpsp<span class=\"token operator\">-></span>Parameters<span class=\"token punctuation\">.</span>Write<span class=\"token punctuation\">.</span>Length<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>\t\t\t\t<span class=\"token comment\">// 然后获得缓冲区</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>\t\t\t\tPUCHAR buffer <span class=\"token operator\">=</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>\t\t\t\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>irp<span class=\"token operator\">-></span>MdlAddress <span class=\"token operator\">!=</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>\t\t\t\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>\t\t\t\t\tbuffer <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>PUCHAR<span class=\"token punctuation\">)</span><span class=\"token function\">MmGetSystemAddressForMdlSafe</span><span class=\"token punctuation\">(</span>irp<span class=\"token operator\">-></span>MdlAddress<span class=\"token punctuation\">,</span> NormalPagePriority<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>\t\t\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>\t\t\t\t<span class=\"token keyword\">else</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>\t\t\t\t\tbuffer <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>PUCHAR<span class=\"token punctuation\">)</span>irp<span class=\"token operator\">-></span>UserBuffer<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>\t\t\t\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>buffer <span class=\"token operator\">==</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>\t\t\t\t\tbuffer <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>PUCHAR<span class=\"token punctuation\">)</span>irp<span class=\"token operator\">-></span>AssociatedIrp<span class=\"token punctuation\">.</span>SystemBuffer<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>\t\t\t\t<span class=\"token comment\">// 打印内容</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>\t\t\t\t<span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span>j <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> j <span class=\"token operator\">&lt;</span> len<span class=\"token punctuation\">;</span> j<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>\t\t\t\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>\t\t\t\t\t<span class=\"token function\">DbgPrint</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"comcap:Send Data:%2x\\r\\n\"</span><span class=\"token punctuation\">,</span> buffer<span class=\"token punctuation\">[</span>j<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>\t\t\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>\t\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>\t\t\t<span class=\"token comment\">//else if (irpsp->MajorFunction == IRP_MJ_READ)</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>\t\t\t<span class=\"token comment\">//&#123;</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>\t\t\t<span class=\"token comment\">//\t// 如果是读请求……</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>\t\t\t<span class=\"token comment\">//&#125;</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>\t\t\t<span class=\"token comment\">// 这些请求直接下发执行即可。我们并不禁止或者改变它。</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre></pre></td></tr><tr><td data-num=\"55\"></td><td><pre>\t\t\t<span class=\"token function\">IoSkipCurrentIrpStackLocation</span><span class=\"token punctuation\">(</span>irp<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>\t\t\t<span class=\"token keyword\">return</span> <span class=\"token function\">IoCallDriver</span><span class=\"token punctuation\">(</span>s_nextobj<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> irp<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre>\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"59\"></td><td><pre></pre></td></tr><tr><td data-num=\"60\"></td><td><pre>\t<span class=\"token comment\">// 如果根本就不在被绑定的设备中，那是有问题的，直接返回参数错误。</span></pre></td></tr><tr><td data-num=\"61\"></td><td><pre>\tirp<span class=\"token operator\">-></span>IoStatus<span class=\"token punctuation\">.</span>Information <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"62\"></td><td><pre>\tirp<span class=\"token operator\">-></span>IoStatus<span class=\"token punctuation\">.</span>Status <span class=\"token operator\">=</span> STATUS_INVALID_PARAMETER<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"63\"></td><td><pre>\t<span class=\"token function\">IoCompleteRequest</span><span class=\"token punctuation\">(</span>irp<span class=\"token punctuation\">,</span> IO_NO_INCREMENT<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"64\"></td><td><pre>\t<span class=\"token keyword\">return</span> STATUS_SUCCESS<span class=\"token punctuation\">;</span>\t</pre></td></tr><tr><td data-num=\"65\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h3 id=\"卸载函数\"><a class=\"anchor\" href=\"#卸载函数\">#</a> 卸载函数</h3>\n<p>我们应该在卸载函数中完成解除绑定的功能，否则，一旦卸载就会蓝屏。</p>\n<p>这里涉及三个内核 API：</p>\n<p><code>IoDetachDevice</code>  ，负责将绑定的设备 解 除 绑 定 ；<br />\n <code>IoDeleteDevice</code>  ， 负责把我们前面用  <code>IoCreateDevice</code>  生成的设备删除以回收内存；<br />\n <code>KeDelayExecutionThread</code>  ，纯粹负责延时。</p>\n<p>这三个函数的参数相对简单，这里就不详细介绍了。</p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span>  <span class=\"token macro-name\">DELAY_ONE_MICROSECOND</span>  <span class=\"token expression\"><span class=\"token punctuation\">(</span><span class=\"token operator\">-</span><span class=\"token number\">10</span><span class=\"token punctuation\">)</span></span></span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span>  <span class=\"token macro-name\">DELAY_ONE_MILLISECOND</span> <span class=\"token expression\"><span class=\"token punctuation\">(</span>DELAY_ONE_MICROSECOND<span class=\"token operator\">*</span><span class=\"token number\">1000</span><span class=\"token punctuation\">)</span></span></span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span>  <span class=\"token macro-name\">DELAY_ONE_SECOND</span> <span class=\"token expression\"><span class=\"token punctuation\">(</span>DELAY_ONE_MILLISECOND<span class=\"token operator\">*</span><span class=\"token number\">1000</span><span class=\"token punctuation\">)</span></span></span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>VOID <span class=\"token function\">DriverUnload</span><span class=\"token punctuation\">(</span>PDRIVER_OBJECT pDriver<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>\t<span class=\"token function\">DbgPrint</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"我是驱动，我卸载了\\t\\n\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\tULONG i<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\tLARGE_INTEGER interval<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>\t<span class=\"token comment\">// 首先解除绑定</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>\t<span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span>i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> CCP_MAX_COM_ID<span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>\t\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>s_nextobj<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span> <span class=\"token operator\">!=</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>\t\t\t<span class=\"token function\">IoDetachDevice</span><span class=\"token punctuation\">(</span>s_nextobj<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>\t<span class=\"token comment\">// 睡眠 5 秒。等待所有 irp 处理结束</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>\tinterval<span class=\"token punctuation\">.</span>QuadPart <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token number\">5</span> <span class=\"token operator\">*</span> <span class=\"token number\">1000</span> <span class=\"token operator\">*</span> DELAY_ONE_MILLISECOND<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>\t<span class=\"token function\">KeDelayExecutionThread</span><span class=\"token punctuation\">(</span>KernelMode<span class=\"token punctuation\">,</span> FALSE<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>interval<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>\t<span class=\"token comment\">// 删除这些设备</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>\t<span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span>i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> CCP_MAX_COM_ID<span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>\t\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>s_fltobj<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span> <span class=\"token operator\">!=</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>\t\t\t<span class=\"token function\">IoDeleteDevice</span><span class=\"token punctuation\">(</span>s_fltobj<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h3 id=\"驱动入口函数\"><a class=\"anchor\" href=\"#驱动入口函数\">#</a> 驱动入口函数</h3>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>NTSTATUS <span class=\"token function\">DriverEntry</span><span class=\"token punctuation\">(</span>PDRIVER_OBJECT pDriver<span class=\"token punctuation\">,</span> PUNICODE_STRING pRegPath<span class=\"token punctuation\">)</span> </pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>\t<span class=\"token comment\">// 卸载函数</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>\tpDriver<span class=\"token operator\">-></span>DriverUnload <span class=\"token operator\">=</span> DriverUnload<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>\t<span class=\"token function\">DbgPrint</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"我是驱动,我运行了\\t\\n\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>\t<span class=\"token class-name\">size_t</span> i<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\t<span class=\"token comment\">// 所有的分发函数都设置成一样的。</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\t<span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span>i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> IRP_MJ_MAXIMUM_FUNCTION<span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span> </pre></td></tr><tr><td data-num=\"11\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>\t\tpDriver<span class=\"token operator\">-></span>MajorFunction<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> ccpDispatch<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>\t<span class=\"token comment\">// 绑定所有串口</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>\t<span class=\"token function\">ccpAttachAllComs</span><span class=\"token punctuation\">(</span>pDriver<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"17\"></td><td><pre></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>\t<span class=\"token keyword\">return</span> STATUS_SUCCESS<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h2 id=\"全部代码\"><a class=\"anchor\" href=\"#全部代码\">#</a> 全部代码</h2>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span><span class=\"token string\">&lt;ntddk.h></span></span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\">// 因为用到了 RtlStringCchPrintfW，所以必须包含头文件 ntstrsafe.h</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\">// 定义 NTSTRSAFE_LIB 是为了使用 ntstrsafe 静态库，这样才能兼容 Windows 2000</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token comment\">// #define NTSTRSAFE_LIB</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span><span class=\"token string\">&lt;ntstrsafe.h></span></span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>NTSTATUS <span class=\"token function\">ccpAttachDevice</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\tPDRIVER_OBJECT driver<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\tPDEVICE_OBJECT oldobj<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>\tPDEVICE_OBJECT<span class=\"token operator\">*</span> fltobj<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>\tPDEVICE_OBJECT<span class=\"token operator\">*</span> next</pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>\tNTSTATUS status<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>\tPDEVICE_OBJECT topdev <span class=\"token operator\">=</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>\t<span class=\"token comment\">// 生成设备，然后绑定</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>\tstatus <span class=\"token operator\">=</span> <span class=\"token function\">IoCreateDevice</span><span class=\"token punctuation\">(</span>driver<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>\t\t<span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>\t\toldobj<span class=\"token operator\">-></span>DeviceType<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>\t\t<span class=\"token number\">0</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>\t\tFALSE<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>\t\tfltobj<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>status<span class=\"token operator\">!=</span> STATUS_SUCCESS<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>\t\t<span class=\"token keyword\">return</span> status<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>\t<span class=\"token comment\">// 拷贝重要标志位</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>oldobj<span class=\"token operator\">-></span>Flags <span class=\"token operator\">&amp;</span> DO_BUFFERED_IO<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>\t\t<span class=\"token punctuation\">(</span><span class=\"token operator\">*</span>fltobj<span class=\"token punctuation\">)</span><span class=\"token operator\">-></span>Flags <span class=\"token operator\">|=</span> DO_BUFFERED_IO<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>oldobj<span class=\"token operator\">-></span>Flags <span class=\"token operator\">&amp;</span> DO_DIRECT_IO<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>\t\t<span class=\"token punctuation\">(</span><span class=\"token operator\">*</span>fltobj<span class=\"token punctuation\">)</span><span class=\"token operator\">-></span>Flags <span class=\"token operator\">|=</span> DO_DIRECT_IO<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>oldobj<span class=\"token operator\">-></span>Characteristics <span class=\"token operator\">&amp;</span> FILE_DEVICE_SECURE_OPEN<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>\t\t<span class=\"token punctuation\">(</span><span class=\"token operator\">*</span>fltobj<span class=\"token punctuation\">)</span><span class=\"token operator\">-></span>Characteristics <span class=\"token operator\">|=</span> FILE_DEVICE_SECURE_OPEN<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>\t<span class=\"token punctuation\">(</span><span class=\"token operator\">*</span>fltobj<span class=\"token punctuation\">)</span><span class=\"token operator\">-></span>Flags <span class=\"token operator\">|=</span> DO_POWER_PAGABLE<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>\t<span class=\"token comment\">// 将一个设备绑定到另一个设备上</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>\tstatus <span class=\"token operator\">=</span> <span class=\"token function\">IoAttachDeviceToDeviceStackSafe</span><span class=\"token punctuation\">(</span><span class=\"token operator\">*</span>fltobj<span class=\"token punctuation\">,</span> oldobj<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>topdev<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre>\t<span class=\"token comment\">// topdev = IoAttachDeviceToDeviceStack(*fltobj, oldobj);</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"54\"></td><td><pre>\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>status <span class=\"token operator\">!=</span> STATUS_SUCCESS<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>\t\t<span class=\"token comment\">// 如果绑定失败，销毁设备，返回错误</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre>\t\t<span class=\"token function\">IoDeleteDevice</span><span class=\"token punctuation\">(</span><span class=\"token operator\">*</span>fltobj<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre>\t\t<span class=\"token operator\">*</span>fltobj <span class=\"token operator\">=</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"59\"></td><td><pre>\t\t<span class=\"token keyword\">return</span> status<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"61\"></td><td><pre></pre></td></tr><tr><td data-num=\"62\"></td><td><pre>\t<span class=\"token operator\">*</span>next <span class=\"token operator\">=</span> topdev<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"63\"></td><td><pre></pre></td></tr><tr><td data-num=\"64\"></td><td><pre>\t<span class=\"token comment\">// 设置这个设备已经启动</span></pre></td></tr><tr><td data-num=\"65\"></td><td><pre>\t<span class=\"token punctuation\">(</span><span class=\"token operator\">*</span>fltobj<span class=\"token punctuation\">)</span><span class=\"token operator\">-></span>Flags <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">*</span>fltobj<span class=\"token punctuation\">)</span><span class=\"token operator\">-></span>Flags <span class=\"token operator\">&amp;</span> <span class=\"token operator\">~</span>DO_DEVICE_INITIALIZING<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"66\"></td><td><pre></pre></td></tr><tr><td data-num=\"67\"></td><td><pre>\t<span class=\"token keyword\">return</span> STATUS_SUCCESS<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"68\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"69\"></td><td><pre></pre></td></tr><tr><td data-num=\"70\"></td><td><pre></pre></td></tr><tr><td data-num=\"71\"></td><td><pre><span class=\"token comment\">// 打开一个端口设备</span></pre></td></tr><tr><td data-num=\"72\"></td><td><pre>PDEVICE_OBJECT <span class=\"token function\">ccpOpenCom</span><span class=\"token punctuation\">(</span>ULONG id<span class=\"token punctuation\">,</span> NTSTATUS <span class=\"token operator\">*</span>status<span class=\"token punctuation\">)</span> </pre></td></tr><tr><td data-num=\"73\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"74\"></td><td><pre>\t<span class=\"token comment\">// 外面输入的是串口 id，这里改写成字符串的形式</span></pre></td></tr><tr><td data-num=\"75\"></td><td><pre>\tUNICODE_STRING name_str<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"76\"></td><td><pre>\t<span class=\"token keyword\">static</span> WCHAR name<span class=\"token punctuation\">[</span><span class=\"token number\">32</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span> <span class=\"token number\">0</span> <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"77\"></td><td><pre>\tPFILE_OBJECT fileobj <span class=\"token operator\">=</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"78\"></td><td><pre>\tPDEVICE_OBJECT devobj <span class=\"token operator\">=</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"79\"></td><td><pre></pre></td></tr><tr><td data-num=\"80\"></td><td><pre>\t<span class=\"token comment\">// 输入字符串</span></pre></td></tr><tr><td data-num=\"81\"></td><td><pre>\t<span class=\"token function\">memset</span><span class=\"token punctuation\">(</span>name<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">sizeof</span><span class=\"token punctuation\">(</span>WCHAR<span class=\"token punctuation\">)</span> <span class=\"token operator\">*</span> <span class=\"token number\">32</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"82\"></td><td><pre>\t<span class=\"token function\">RtlStringCchPrintfW</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"83\"></td><td><pre>\t\tname<span class=\"token punctuation\">,</span> <span class=\"token number\">32</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"84\"></td><td><pre>\t\tL<span class=\"token string\">\"\\\\Device\\\\Serial%d\"</span><span class=\"token punctuation\">,</span> id<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"85\"></td><td><pre>\t<span class=\"token function\">RtlInitUnicodeString</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>name_str<span class=\"token punctuation\">,</span> name<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"86\"></td><td><pre></pre></td></tr><tr><td data-num=\"87\"></td><td><pre>\t<span class=\"token comment\">// 打开设备对象</span></pre></td></tr><tr><td data-num=\"88\"></td><td><pre>\t<span class=\"token operator\">*</span>status <span class=\"token operator\">=</span> <span class=\"token function\">IoGetDeviceObjectPointer</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>name_str<span class=\"token punctuation\">,</span> FILE_ALL_ACCESS<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>fileobj<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>devobj<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"89\"></td><td><pre>\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">*</span>status <span class=\"token operator\">==</span> STATUS_SUCCESS<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"90\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"91\"></td><td><pre>\t\t<span class=\"token comment\">// 没有用到文件对象，解除对其引用</span></pre></td></tr><tr><td data-num=\"92\"></td><td><pre>\t\t<span class=\"token function\">ObDereferenceObject</span><span class=\"token punctuation\">(</span>fileobj<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"93\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"94\"></td><td><pre></pre></td></tr><tr><td data-num=\"95\"></td><td><pre>\t<span class=\"token keyword\">return</span> devobj<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"96\"></td><td><pre></pre></td></tr><tr><td data-num=\"97\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"98\"></td><td><pre></pre></td></tr><tr><td data-num=\"99\"></td><td><pre></pre></td></tr><tr><td data-num=\"100\"></td><td><pre><span class=\"token comment\">// 设置最大的串口数</span></pre></td></tr><tr><td data-num=\"101\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">CCP_MAX_COM_ID</span> <span class=\"token expression\"><span class=\"token number\">32</span></span></span></pre></td></tr><tr><td data-num=\"102\"></td><td><pre></pre></td></tr><tr><td data-num=\"103\"></td><td><pre><span class=\"token comment\">// 保存所有的过滤设备指针</span></pre></td></tr><tr><td data-num=\"104\"></td><td><pre><span class=\"token keyword\">static</span> PDEVICE_OBJECT s_fltobj<span class=\"token punctuation\">[</span>CCP_MAX_COM_ID<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span> <span class=\"token number\">0</span> <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"105\"></td><td><pre></pre></td></tr><tr><td data-num=\"106\"></td><td><pre><span class=\"token comment\">// 保存所有真实设备的指针</span></pre></td></tr><tr><td data-num=\"107\"></td><td><pre><span class=\"token keyword\">static</span> PDEVICE_OBJECT s_nextobj<span class=\"token punctuation\">[</span>CCP_MAX_COM_ID<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span> <span class=\"token number\">0</span> <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"108\"></td><td><pre></pre></td></tr><tr><td data-num=\"109\"></td><td><pre><span class=\"token comment\">// 这个函数绑定所有的串口</span></pre></td></tr><tr><td data-num=\"110\"></td><td><pre></pre></td></tr><tr><td data-num=\"111\"></td><td><pre><span class=\"token keyword\">void</span> <span class=\"token function\">ccpAttachAllComs</span><span class=\"token punctuation\">(</span>PDRIVER_OBJECT driver<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"112\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"113\"></td><td><pre>\tUSHORT i<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"114\"></td><td><pre>\tPDEVICE_OBJECT com_ob<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"115\"></td><td><pre>\tNTSTATUS status<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"116\"></td><td><pre>\t<span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span> i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> CCP_MAX_COM_ID<span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"117\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"118\"></td><td><pre>\t\t<span class=\"token comment\">// 获得串口对象引用</span></pre></td></tr><tr><td data-num=\"119\"></td><td><pre>\t\tcom_ob <span class=\"token operator\">=</span> <span class=\"token function\">ccpOpenCom</span><span class=\"token punctuation\">(</span>i<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>status<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"120\"></td><td><pre>\t\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>com_ob<span class=\"token operator\">==</span><span class=\"token constant\">NULL</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"121\"></td><td><pre>\t\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"122\"></td><td><pre>\t\t\t<span class=\"token keyword\">continue</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"123\"></td><td><pre>\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"124\"></td><td><pre>\t\t</pre></td></tr><tr><td data-num=\"125\"></td><td><pre>\t\t<span class=\"token comment\">// 在这里绑定。并不管绑定是否成功。</span></pre></td></tr><tr><td data-num=\"126\"></td><td><pre>\t\t<span class=\"token function\">ccpAttachDevice</span><span class=\"token punctuation\">(</span>driver<span class=\"token punctuation\">,</span> com_ob<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>s_fltobj<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>s_nextobj<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"127\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span> </pre></td></tr><tr><td data-num=\"128\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"129\"></td><td><pre></pre></td></tr><tr><td data-num=\"130\"></td><td><pre></pre></td></tr><tr><td data-num=\"131\"></td><td><pre>NTSTATUS <span class=\"token function\">ccpDispatch</span><span class=\"token punctuation\">(</span>PDEVICE_OBJECT device<span class=\"token punctuation\">,</span> PIRP irp<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"132\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"133\"></td><td><pre>\t<span class=\"token comment\">// 这里的 irpsp 称为 IRP 的栈空间，IoGetCurrentIrpStackLocation 用来获取当前栈空间</span></pre></td></tr><tr><td data-num=\"134\"></td><td><pre>\t<span class=\"token comment\">// 栈空间是非常重要的数据结构</span></pre></td></tr><tr><td data-num=\"135\"></td><td><pre>\tPIO_STACK_LOCATION irpsp <span class=\"token operator\">=</span> <span class=\"token function\">IoGetCurrentIrpStackLocation</span><span class=\"token punctuation\">(</span>irp<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"136\"></td><td><pre>\tNTSTATUS status<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"137\"></td><td><pre>\tULONG i<span class=\"token punctuation\">,</span> j<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"138\"></td><td><pre></pre></td></tr><tr><td data-num=\"139\"></td><td><pre>\t<span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span> i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> CCP_MAX_COM_ID<span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"140\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"141\"></td><td><pre>\t\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>s_fltobj<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span> <span class=\"token operator\">==</span> device<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"142\"></td><td><pre>\t\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"143\"></td><td><pre>\t\t\t<span class=\"token comment\">// 所有电源操作，全部直接放过</span></pre></td></tr><tr><td data-num=\"144\"></td><td><pre>\t\t\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>irpsp<span class=\"token operator\">-></span>MajorFunction <span class=\"token operator\">==</span> IRP_MJ_POWER<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"145\"></td><td><pre>\t\t\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"146\"></td><td><pre>\t\t\t\t<span class=\"token comment\">// 直接发送，然后返回说已经被处理了</span></pre></td></tr><tr><td data-num=\"147\"></td><td><pre>\t\t\t\t<span class=\"token function\">PoStartNextPowerIrp</span><span class=\"token punctuation\">(</span>irp<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"148\"></td><td><pre>\t\t\t\t<span class=\"token function\">IoSkipCurrentIrpStackLocation</span><span class=\"token punctuation\">(</span>irp<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"149\"></td><td><pre>\t\t\t\t<span class=\"token keyword\">return</span> <span class=\"token function\">PoCallDriver</span><span class=\"token punctuation\">(</span>s_nextobj<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> irp<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"150\"></td><td><pre>\t\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"151\"></td><td><pre></pre></td></tr><tr><td data-num=\"152\"></td><td><pre>\t\t\t<span class=\"token comment\">// 我们只过滤写请求。</span></pre></td></tr><tr><td data-num=\"153\"></td><td><pre></pre></td></tr><tr><td data-num=\"154\"></td><td><pre>\t\t\t<span class=\"token comment\">// 写请求，获得缓冲区及其长度，然后打印。</span></pre></td></tr><tr><td data-num=\"155\"></td><td><pre>\t\t\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>irpsp<span class=\"token operator\">-></span>MajorFunction <span class=\"token operator\">==</span> IRP_MJ_WRITE<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"156\"></td><td><pre>\t\t\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"157\"></td><td><pre>\t\t\t\t<span class=\"token comment\">// 如果是写请求……</span></pre></td></tr><tr><td data-num=\"158\"></td><td><pre>\t\t\t\t<span class=\"token comment\">// 如果是写，先获得长度</span></pre></td></tr><tr><td data-num=\"159\"></td><td><pre>\t\t\t\tULONG len <span class=\"token operator\">=</span> irpsp<span class=\"token operator\">-></span>Parameters<span class=\"token punctuation\">.</span>Write<span class=\"token punctuation\">.</span>Length<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"160\"></td><td><pre>\t\t\t\t<span class=\"token comment\">// 然后获得缓冲区</span></pre></td></tr><tr><td data-num=\"161\"></td><td><pre>\t\t\t\tPUCHAR buffer <span class=\"token operator\">=</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"162\"></td><td><pre>\t\t\t\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>irp<span class=\"token operator\">-></span>MdlAddress <span class=\"token operator\">!=</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"163\"></td><td><pre>\t\t\t\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"164\"></td><td><pre>\t\t\t\t\tbuffer <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>PUCHAR<span class=\"token punctuation\">)</span><span class=\"token function\">MmGetSystemAddressForMdlSafe</span><span class=\"token punctuation\">(</span>irp<span class=\"token operator\">-></span>MdlAddress<span class=\"token punctuation\">,</span> NormalPagePriority<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"165\"></td><td><pre>\t\t\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"166\"></td><td><pre>\t\t\t\t<span class=\"token keyword\">else</span></pre></td></tr><tr><td data-num=\"167\"></td><td><pre>\t\t\t\t\tbuffer <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>PUCHAR<span class=\"token punctuation\">)</span>irp<span class=\"token operator\">-></span>UserBuffer<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"168\"></td><td><pre>\t\t\t\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>buffer <span class=\"token operator\">==</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"169\"></td><td><pre>\t\t\t\t\tbuffer <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>PUCHAR<span class=\"token punctuation\">)</span>irp<span class=\"token operator\">-></span>AssociatedIrp<span class=\"token punctuation\">.</span>SystemBuffer<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"170\"></td><td><pre></pre></td></tr><tr><td data-num=\"171\"></td><td><pre>\t\t\t\t<span class=\"token comment\">// 打印内容</span></pre></td></tr><tr><td data-num=\"172\"></td><td><pre>\t\t\t\t<span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span>j <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> j <span class=\"token operator\">&lt;</span> len<span class=\"token punctuation\">;</span> j<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"173\"></td><td><pre>\t\t\t\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"174\"></td><td><pre>\t\t\t\t\t<span class=\"token function\">DbgPrint</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"comcap:Send Data:%2x\\r\\n\"</span><span class=\"token punctuation\">,</span> buffer<span class=\"token punctuation\">[</span>j<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"175\"></td><td><pre>\t\t\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"176\"></td><td><pre>\t\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"177\"></td><td><pre></pre></td></tr><tr><td data-num=\"178\"></td><td><pre>\t\t\t<span class=\"token comment\">//else if (irpsp->MajorFunction == IRP_MJ_READ)</span></pre></td></tr><tr><td data-num=\"179\"></td><td><pre>\t\t\t<span class=\"token comment\">//&#123;</span></pre></td></tr><tr><td data-num=\"180\"></td><td><pre>\t\t\t<span class=\"token comment\">//\t// 如果是读请求……</span></pre></td></tr><tr><td data-num=\"181\"></td><td><pre>\t\t\t<span class=\"token comment\">//&#125;</span></pre></td></tr><tr><td data-num=\"182\"></td><td><pre></pre></td></tr><tr><td data-num=\"183\"></td><td><pre>\t\t\t<span class=\"token comment\">// 这些请求直接下发执行即可。我们并不禁止或者改变它。</span></pre></td></tr><tr><td data-num=\"184\"></td><td><pre></pre></td></tr><tr><td data-num=\"185\"></td><td><pre>\t\t\t<span class=\"token function\">IoSkipCurrentIrpStackLocation</span><span class=\"token punctuation\">(</span>irp<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"186\"></td><td><pre>\t\t\t<span class=\"token keyword\">return</span> <span class=\"token function\">IoCallDriver</span><span class=\"token punctuation\">(</span>s_nextobj<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> irp<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"187\"></td><td><pre>\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"188\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"189\"></td><td><pre></pre></td></tr><tr><td data-num=\"190\"></td><td><pre>\t<span class=\"token comment\">// 如果根本就不在被绑定的设备中，那是有问题的，直接返回参数错误。</span></pre></td></tr><tr><td data-num=\"191\"></td><td><pre>\tirp<span class=\"token operator\">-></span>IoStatus<span class=\"token punctuation\">.</span>Information <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"192\"></td><td><pre>\tirp<span class=\"token operator\">-></span>IoStatus<span class=\"token punctuation\">.</span>Status <span class=\"token operator\">=</span> STATUS_INVALID_PARAMETER<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"193\"></td><td><pre>\t<span class=\"token function\">IoCompleteRequest</span><span class=\"token punctuation\">(</span>irp<span class=\"token punctuation\">,</span> IO_NO_INCREMENT<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"194\"></td><td><pre>\t<span class=\"token keyword\">return</span> STATUS_SUCCESS<span class=\"token punctuation\">;</span>\t</pre></td></tr><tr><td data-num=\"195\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"196\"></td><td><pre></pre></td></tr><tr><td data-num=\"197\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span>  <span class=\"token macro-name\">DELAY_ONE_MICROSECOND</span>  <span class=\"token expression\"><span class=\"token punctuation\">(</span><span class=\"token operator\">-</span><span class=\"token number\">10</span><span class=\"token punctuation\">)</span></span></span></pre></td></tr><tr><td data-num=\"198\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span>  <span class=\"token macro-name\">DELAY_ONE_MILLISECOND</span> <span class=\"token expression\"><span class=\"token punctuation\">(</span>DELAY_ONE_MICROSECOND<span class=\"token operator\">*</span><span class=\"token number\">1000</span><span class=\"token punctuation\">)</span></span></span></pre></td></tr><tr><td data-num=\"199\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span>  <span class=\"token macro-name\">DELAY_ONE_SECOND</span> <span class=\"token expression\"><span class=\"token punctuation\">(</span>DELAY_ONE_MILLISECOND<span class=\"token operator\">*</span><span class=\"token number\">1000</span><span class=\"token punctuation\">)</span></span></span></pre></td></tr><tr><td data-num=\"200\"></td><td><pre></pre></td></tr><tr><td data-num=\"201\"></td><td><pre>VOID <span class=\"token function\">DriverUnload</span><span class=\"token punctuation\">(</span>PDRIVER_OBJECT pDriver<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"202\"></td><td><pre></pre></td></tr><tr><td data-num=\"203\"></td><td><pre>\t<span class=\"token function\">DbgPrint</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"我是驱动，我卸载了\\t\\n\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"204\"></td><td><pre></pre></td></tr><tr><td data-num=\"205\"></td><td><pre>\tULONG i<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"206\"></td><td><pre>\tLARGE_INTEGER interval<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"207\"></td><td><pre></pre></td></tr><tr><td data-num=\"208\"></td><td><pre>\t<span class=\"token comment\">// 首先解除绑定</span></pre></td></tr><tr><td data-num=\"209\"></td><td><pre>\t<span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span>i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> CCP_MAX_COM_ID<span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"210\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"211\"></td><td><pre>\t\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>s_nextobj<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span> <span class=\"token operator\">!=</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"212\"></td><td><pre>\t\t\t<span class=\"token function\">IoDetachDevice</span><span class=\"token punctuation\">(</span>s_nextobj<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"213\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"214\"></td><td><pre></pre></td></tr><tr><td data-num=\"215\"></td><td><pre>\t<span class=\"token comment\">// 睡眠 5 秒。等待所有 irp 处理结束</span></pre></td></tr><tr><td data-num=\"216\"></td><td><pre>\tinterval<span class=\"token punctuation\">.</span>QuadPart <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token number\">5</span> <span class=\"token operator\">*</span> <span class=\"token number\">1000</span> <span class=\"token operator\">*</span> DELAY_ONE_MILLISECOND<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"217\"></td><td><pre>\t<span class=\"token function\">KeDelayExecutionThread</span><span class=\"token punctuation\">(</span>KernelMode<span class=\"token punctuation\">,</span> FALSE<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>interval<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"218\"></td><td><pre></pre></td></tr><tr><td data-num=\"219\"></td><td><pre>\t<span class=\"token comment\">// 删除这些设备</span></pre></td></tr><tr><td data-num=\"220\"></td><td><pre>\t<span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span>i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> CCP_MAX_COM_ID<span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"221\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"222\"></td><td><pre>\t\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>s_fltobj<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span> <span class=\"token operator\">!=</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"223\"></td><td><pre>\t\t\t<span class=\"token function\">IoDeleteDevice</span><span class=\"token punctuation\">(</span>s_fltobj<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"224\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"225\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"226\"></td><td><pre></pre></td></tr><tr><td data-num=\"227\"></td><td><pre></pre></td></tr><tr><td data-num=\"228\"></td><td><pre></pre></td></tr><tr><td data-num=\"229\"></td><td><pre></pre></td></tr><tr><td data-num=\"230\"></td><td><pre>NTSTATUS <span class=\"token function\">DriverEntry</span><span class=\"token punctuation\">(</span>PDRIVER_OBJECT pDriver<span class=\"token punctuation\">,</span> PUNICODE_STRING pRegPath<span class=\"token punctuation\">)</span> </pre></td></tr><tr><td data-num=\"231\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"232\"></td><td><pre>\t<span class=\"token comment\">// 卸载函数</span></pre></td></tr><tr><td data-num=\"233\"></td><td><pre>\tpDriver<span class=\"token operator\">-></span>DriverUnload <span class=\"token operator\">=</span> DriverUnload<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"234\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"235\"></td><td><pre>\t<span class=\"token function\">DbgBreakPoint</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"236\"></td><td><pre>\t<span class=\"token function\">DbgPrint</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"我是驱动,我运行了\\t\\n\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"237\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"238\"></td><td><pre>\t<span class=\"token class-name\">size_t</span> i<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"239\"></td><td><pre>\t<span class=\"token comment\">// 所有的分发函数都设置成一样的。</span></pre></td></tr><tr><td data-num=\"240\"></td><td><pre>\t<span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span>i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> IRP_MJ_MAXIMUM_FUNCTION<span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span> </pre></td></tr><tr><td data-num=\"241\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"242\"></td><td><pre>\t\tpDriver<span class=\"token operator\">-></span>MajorFunction<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> ccpDispatch<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"243\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"244\"></td><td><pre>\t<span class=\"token comment\">// 绑定所有串口</span></pre></td></tr><tr><td data-num=\"245\"></td><td><pre>\t<span class=\"token function\">ccpAttachAllComs</span><span class=\"token punctuation\">(</span>pDriver<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"246\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"247\"></td><td><pre></pre></td></tr><tr><td data-num=\"248\"></td><td><pre>\t<span class=\"token keyword\">return</span> STATUS_SUCCESS<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"249\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure>",
            "tags": [
                "串口",
                "过滤"
            ]
        },
        {
            "id": "https://or0kit.github.io/Bin/Core/WindowsXp/MessageMechanism/%E6%B6%88%E6%81%AF%E6%9C%BA%E5%88%B6-05%E5%86%85%E6%A0%B8%E5%9B%9E%E8%B0%83%E6%9C%BA%E5%88%B6/",
            "url": "https://or0kit.github.io/Bin/Core/WindowsXp/MessageMechanism/%E6%B6%88%E6%81%AF%E6%9C%BA%E5%88%B6-05%E5%86%85%E6%A0%B8%E5%9B%9E%E8%B0%83%E6%9C%BA%E5%88%B6/",
            "title": "消息机制-05内核回调机制",
            "date_published": "2022-04-25T07:17:22.000Z",
            "content_html": "<h1 id=\"pass\"><a class=\"anchor\" href=\"#pass\">#</a> Pass</h1>\n<p>挖坑</p>\n",
            "tags": []
        },
        {
            "id": "https://or0kit.github.io/Bin/Core/WindowsXp/MessageMechanism/%E6%B6%88%E6%81%AF%E6%9C%BA%E5%88%B6-04%E6%B6%88%E6%81%AF%E7%9A%84%E5%88%86%E5%8F%91/",
            "url": "https://or0kit.github.io/Bin/Core/WindowsXp/MessageMechanism/%E6%B6%88%E6%81%AF%E6%9C%BA%E5%88%B6-04%E6%B6%88%E6%81%AF%E7%9A%84%E5%88%86%E5%8F%91/",
            "title": "消息机制-04消息的分发",
            "date_published": "2022-04-22T07:17:15.000Z",
            "content_html": "<h1 id=\"pass\"><a class=\"anchor\" href=\"#pass\">#</a> Pass</h1>\n<p>挖坑</p>\n",
            "tags": []
        },
        {
            "id": "https://or0kit.github.io/Bin/Core/WindowsXp/MessageMechanism/%E6%B6%88%E6%81%AF%E6%9C%BA%E5%88%B6-03%E6%B6%88%E6%81%AF%E7%9A%84%E6%8E%A5%E6%94%B6/",
            "url": "https://or0kit.github.io/Bin/Core/WindowsXp/MessageMechanism/%E6%B6%88%E6%81%AF%E6%9C%BA%E5%88%B6-03%E6%B6%88%E6%81%AF%E7%9A%84%E6%8E%A5%E6%94%B6/",
            "title": "消息机制-03消息的接收",
            "date_published": "2022-04-22T07:17:12.000Z",
            "content_html": "<h1 id=\"楔子\"><a class=\"anchor\" href=\"#楔子\">#</a> 楔子</h1>\n<p>在前面我们分析了：</p>\n<p>一个 GUI 线程有一个消息队列</p>\n<p>普通线程\tGUI 线程\t <code>THREAD.W32THREAD</code> \t <code>THREADINFO</code>         消息队列</p>\n<p>一个线程可以有多个窗口，所有窗口共享一个消息队列</p>\n<p><code>WND</code>      // 窗口结构<br />\n <code>PTHREADINFO pti</code>                // 所属线程<br />\n <code>WNDPROC_PWND  lpfnWndProc</code> ;  \t// 窗口过程 (窗口回调函数)</p>\n<h1 id=\"窗口程序的创建\"><a class=\"anchor\" href=\"#窗口程序的创建\">#</a> 窗口程序的创建</h1>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span><span class=\"token string\">&lt;stdio.h></span></span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span><span class=\"token string\">&lt;Windows.h></span></span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">WIN32_LEAN_AND_MEAN</span></span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token comment\">// 声明回调函数</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>LRESULT CALLBACK <span class=\"token function\">WindowProc</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    HWND hwnd<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    UINT uMsg<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    WPARAM wParam<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    LPARAM lParam</pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token keyword\">int</span> WINAPI <span class=\"token function\">WinMain</span><span class=\"token punctuation\">(</span>HINSTANCE hInstance<span class=\"token punctuation\">,</span> HINSTANCE hPrevInstance<span class=\"token punctuation\">,</span> LPSTR lpCmdLine<span class=\"token punctuation\">,</span> <span class=\"token keyword\">int</span> nCmdShow<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    <span class=\"token comment\">// 保存 GetLastError 的返回值</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>    TCHAR szOutBuff<span class=\"token punctuation\">[</span><span class=\"token number\">0x80</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    <span class=\"token comment\">// 创建窗口类</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>    <span class=\"token comment\">// 初始化</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>    WNDCLASSEX mywnd        <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span> <span class=\"token number\">0</span> <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>    mywnd<span class=\"token punctuation\">.</span>cbSize            <span class=\"token operator\">=</span> <span class=\"token keyword\">sizeof</span><span class=\"token punctuation\">(</span>WNDCLASSEX<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>    mywnd<span class=\"token punctuation\">.</span>style             <span class=\"token operator\">=</span> CS_HREDRAW <span class=\"token operator\">|</span> CS_VREDRAW<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>    <span class=\"token comment\">// 窗口类名</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>    TCHAR wndname<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>         <span class=\"token operator\">=</span> <span class=\"token function\">TEXT</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"第一个窗口\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>    mywnd<span class=\"token punctuation\">.</span>lpszClassName     <span class=\"token operator\">=</span> wndname<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>    <span class=\"token comment\">// 回调函数</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>    mywnd<span class=\"token punctuation\">.</span>lpfnWndProc       <span class=\"token operator\">=</span> WindowProc<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>    <span class=\"token comment\">// 标志该窗口所在实例</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>    mywnd<span class=\"token punctuation\">.</span>hInstance         <span class=\"token operator\">=</span> hInstance<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>    <span class=\"token comment\">// 设置画刷</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>    mywnd<span class=\"token punctuation\">.</span>hbrBackground     <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>HBRUSH<span class=\"token punctuation\">)</span><span class=\"token function\">GetStockObject</span><span class=\"token punctuation\">(</span>WHITE_BRUSH<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre></pre></td></tr><tr><td data-num=\"36\"></td><td><pre></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>    <span class=\"token comment\">// 注册窗口类</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>    <span class=\"token function\">RegisterClassEx</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>mywnd<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>    <span class=\"token comment\">// 创建窗口</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>    HWND hwnd <span class=\"token operator\">=</span> <span class=\"token function\">CreateWindow</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>        wndname<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>        <span class=\"token function\">TEXT</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"My First Window!\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>        WS_OVERLAPPEDWINDOW<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>        <span class=\"token number\">0</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>        <span class=\"token number\">0</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>        <span class=\"token number\">500</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>        <span class=\"token number\">500</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>        <span class=\"token constant\">NULL</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>        <span class=\"token constant\">NULL</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>        hInstance<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre>        <span class=\"token constant\">NULL</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>    <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre></pre></td></tr><tr><td data-num=\"55\"></td><td><pre>    <span class=\"token comment\">// 判断是否创建成功</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>    <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>hwnd<span class=\"token operator\">==</span><span class=\"token constant\">NULL</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre>        TCHAR str<span class=\"token punctuation\">[</span><span class=\"token number\">30</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span> <span class=\"token constant\">NULL</span> <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"59\"></td><td><pre>        <span class=\"token function\">wsprintf</span><span class=\"token punctuation\">(</span>str<span class=\"token punctuation\">,</span> L<span class=\"token string\">\"%s\"</span><span class=\"token punctuation\">,</span> L<span class=\"token string\">\"CreateWindow Error!!\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre>        <span class=\"token function\">OutputDebugString</span><span class=\"token punctuation\">(</span>str<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"61\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"62\"></td><td><pre>    </pre></td></tr><tr><td data-num=\"63\"></td><td><pre>    <span class=\"token comment\">// 显示窗口</span></pre></td></tr><tr><td data-num=\"64\"></td><td><pre>    <span class=\"token function\">ShowWindow</span><span class=\"token punctuation\">(</span>hwnd<span class=\"token punctuation\">,</span> nCmdShow<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"65\"></td><td><pre>    <span class=\"token function\">UpdateWindow</span><span class=\"token punctuation\">(</span>hwnd<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"66\"></td><td><pre></pre></td></tr><tr><td data-num=\"67\"></td><td><pre>    <span class=\"token comment\">// 消息循环</span></pre></td></tr><tr><td data-num=\"68\"></td><td><pre></pre></td></tr><tr><td data-num=\"69\"></td><td><pre>    MSG msg<span class=\"token punctuation\">;</span> </pre></td></tr><tr><td data-num=\"70\"></td><td><pre>    BOOL bRet<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"71\"></td><td><pre></pre></td></tr><tr><td data-num=\"72\"></td><td><pre>  <span class=\"token comment\">// 我们的窗口回调.</span></pre></td></tr><tr><td data-num=\"73\"></td><td><pre>    <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>bRet <span class=\"token operator\">=</span> <span class=\"token function\">GetMessage</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>msg<span class=\"token punctuation\">,</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"74\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"75\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>bRet <span class=\"token operator\">==</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"76\"></td><td><pre>        <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"77\"></td><td><pre>            <span class=\"token comment\">// handle the error and possibly exit</span></pre></td></tr><tr><td data-num=\"78\"></td><td><pre>            <span class=\"token function\">wsprintf</span><span class=\"token punctuation\">(</span>szOutBuff<span class=\"token punctuation\">,</span> <span class=\"token function\">TEXT</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Error: %d\\n\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token function\">GetLastError</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"79\"></td><td><pre>            <span class=\"token function\">OutputDebugString</span><span class=\"token punctuation\">(</span>szOutBuff<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"80\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"81\"></td><td><pre>        <span class=\"token keyword\">else</span></pre></td></tr><tr><td data-num=\"82\"></td><td><pre>        <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"83\"></td><td><pre>            <span class=\"token function\">TranslateMessage</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>msg<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>      <span class=\"token comment\">// 键盘消息转换为小写.</span></pre></td></tr><tr><td data-num=\"84\"></td><td><pre>            <span class=\"token function\">DispatchMessage</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>msg<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>      <span class=\"token comment\">// 分发消息。将我们的消息传递给我们的回调函数处理 重要函数。此消息会将 Windows 的消息。发送给我们 定义窗口类的时候给的回调函数。这样我们就可以根据消息执行我们代码了.</span></pre></td></tr><tr><td data-num=\"85\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"86\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"87\"></td><td><pre></pre></td></tr><tr><td data-num=\"88\"></td><td><pre>    <span class=\"token keyword\">return</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"89\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"90\"></td><td><pre><span class=\"token comment\">//   我们的窗口回调</span></pre></td></tr><tr><td data-num=\"91\"></td><td><pre>LRESULT CALLBACK <span class=\"token function\">WindowProc</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"92\"></td><td><pre>    HWND hWnd<span class=\"token punctuation\">,</span> </pre></td></tr><tr><td data-num=\"93\"></td><td><pre>    UINT message<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"94\"></td><td><pre>    WPARAM wParam<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"95\"></td><td><pre>    LPARAM lParam</pre></td></tr><tr><td data-num=\"96\"></td><td><pre><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"97\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"98\"></td><td><pre>    <span class=\"token keyword\">switch</span> <span class=\"token punctuation\">(</span>message<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"99\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"100\"></td><td><pre>    <span class=\"token keyword\">case</span> WM_CREATE<span class=\"token operator\">:</span>                             </pre></td></tr><tr><td data-num=\"101\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"102\"></td><td><pre>        <span class=\"token keyword\">return</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"103\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"104\"></td><td><pre>    </pre></td></tr><tr><td data-num=\"105\"></td><td><pre>    <span class=\"token comment\">// 当窗口开始绘制的时候</span></pre></td></tr><tr><td data-num=\"106\"></td><td><pre>    <span class=\"token keyword\">case</span> WM_PAINT<span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"107\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"108\"></td><td><pre>        PAINTSTRUCT ps<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"109\"></td><td><pre>        RECT rect<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"110\"></td><td><pre>        HDC hdc <span class=\"token operator\">=</span> <span class=\"token function\">BeginPaint</span><span class=\"token punctuation\">(</span>hWnd<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>ps<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"111\"></td><td><pre></pre></td></tr><tr><td data-num=\"112\"></td><td><pre>        <span class=\"token function\">GetClientRect</span><span class=\"token punctuation\">(</span>hWnd<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>rect<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"113\"></td><td><pre>        <span class=\"token function\">DrawText</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"114\"></td><td><pre>            hdc<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"115\"></td><td><pre>            <span class=\"token function\">TEXT</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"hello window!\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"116\"></td><td><pre>            <span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> </pre></td></tr><tr><td data-num=\"117\"></td><td><pre>            <span class=\"token operator\">&amp;</span>rect<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"118\"></td><td><pre>            DT_SINGLELINE <span class=\"token operator\">|</span> DT_CENTER <span class=\"token operator\">|</span> DT_VCENTER</pre></td></tr><tr><td data-num=\"119\"></td><td><pre>        <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"120\"></td><td><pre></pre></td></tr><tr><td data-num=\"121\"></td><td><pre>        <span class=\"token function\">EndPaint</span><span class=\"token punctuation\">(</span>hWnd<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>ps<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"122\"></td><td><pre>        <span class=\"token keyword\">return</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"123\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"124\"></td><td><pre>    <span class=\"token comment\">// 打印</span></pre></td></tr><tr><td data-num=\"125\"></td><td><pre>    <span class=\"token keyword\">case</span> WM_CHAR<span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"126\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"127\"></td><td><pre>        TCHAR szOutBuffer<span class=\"token punctuation\">[</span><span class=\"token number\">0x10</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"128\"></td><td><pre>        <span class=\"token function\">wsprintf</span><span class=\"token punctuation\">(</span>szOutBuffer<span class=\"token punctuation\">,</span> L<span class=\"token string\">\"%c\\n\"</span><span class=\"token punctuation\">,</span> wParam<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"129\"></td><td><pre>        <span class=\"token function\">OutputDebugString</span><span class=\"token punctuation\">(</span>szOutBuffer<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"130\"></td><td><pre>        <span class=\"token keyword\">return</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"131\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"132\"></td><td><pre>    </pre></td></tr><tr><td data-num=\"133\"></td><td><pre>    <span class=\"token keyword\">case</span> WM_DESTROY<span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"134\"></td><td><pre>        <span class=\"token function\">PostQuitMessage</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"135\"></td><td><pre>        <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"136\"></td><td><pre>    <span class=\"token keyword\">default</span><span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"137\"></td><td><pre>        <span class=\"token keyword\">return</span> <span class=\"token function\">DefWindowProc</span><span class=\"token punctuation\">(</span>hWnd<span class=\"token punctuation\">,</span> message<span class=\"token punctuation\">,</span> wParam<span class=\"token punctuation\">,</span> lParam<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"138\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"139\"></td><td><pre>    <span class=\"token keyword\">return</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"140\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p><img data-src=\"image001.png\" alt=\"\" /></p>\n<p>我们要创建一个简单的窗口就要有这么多的步骤，为什么要这么写呢？</p>\n<p><img data-src=\"image002.png\" alt=\"\" /></p>\n<p>我们在 3 环写主要是向 0 环传递这些信心，以便在 0 环创建一个窗口的结构体。</p>\n<p>我们看到的只是一个窗口，看不到的是在内核中那些结构体，因为调用了 GUI 函数，此时我们也是一个 GUI 线程了，有消息队列了，接着向后面看，有一个循环不停的取往消息队列中取消息，然后加工、分发消息。</p>\n<p>很多人只知道代码要这样写，并不清楚为什么这样写，就是不了解在 0 环做了什么事情，消息机制绝大部分的实现就是在 0 环做的，如果不了解消息机制在 0 环做了什么事情，就不会知道 3 环的代码为什么要这样写。</p>\n<p>接下来我们了解消息循环。</p>\n<h1 id=\"消息循环\"><a class=\"anchor\" href=\"#消息循环\">#</a> 消息循环</h1>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>MSG msg<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">while</span><span class=\"token punctuation\">(</span><span class=\"token function\">GetMessage</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>msg<span class=\"token punctuation\">,</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\t<span class=\"token comment\">// 从消息队列中取出消息</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>\t<span class=\"token function\">TranslateMessage</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>msg<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\t<span class=\"token comment\">// 加工消息</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>\t<span class=\"token function\">DispatchMessage</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>msg<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\t<span class=\"token comment\">// 分发消息</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>使用 SendMessage 与 PostMessage 发送的消息位于同一组队列中吗？</p>\n<p>不同类型的消息被置于不同队列。(这如何在 Windows 中实现的？)</p>\n<h2 id=\"消息的接收\"><a class=\"anchor\" href=\"#消息的接收\">#</a> 消息的接收</h2>\n<p><code>GetMessage</code></p>\n<p>描述：从消息队列中取出消息</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>BOOL WINAPI <span class=\"token function\">GetMessage</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>\tLPMSG lpMsg<span class=\"token punctuation\">,</span>\t<span class=\"token comment\">// 返回从队列中取出的消息</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>\tHWND hWnd<span class=\"token punctuation\">,</span>\t\t<span class=\"token comment\">// 过滤条件一：窗口句柄</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>\tUINT wMsgFilterMin<span class=\"token punctuation\">,</span>\t<span class=\"token comment\">// 过滤条件二：最小值</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>\tUINT wMsgFilterMax\t<span class=\"token comment\">// 过滤条件三：最大值</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>主要功能：循环判断是否存在属于该窗口的消息，若存在，则将消息存储到 MSG 指定的结构中，并将消息从列表中删除。</p>\n<p><code>GetMessage --&gt; NtUserGetMessage --&gt; xxxGetMessage（这是一个宏，也就是 xxxInternalGetMessage 函数） --&gt; xxxRealInternalGetMessage</code></p>\n<p>注意：事实上，GetMessage 还做了一件很重要的事情，即在接收消息时，将 SentMessagesListHead 中的消息进行处理</p>\n<p>有关消息发送，可以通过  <code>SendMessage</code>  或者  <code>PostMessage</code>  进行发送，它们有所不同，前者是同步的，后者是异步的，我们可以做一个实验验证:</p>\n",
            "tags": [
                "窗口程序的创建",
                "消息循环"
            ]
        },
        {
            "id": "https://or0kit.github.io/Bin/Core/WindowsXp/MessageMechanism/%E6%B6%88%E6%81%AF%E6%9C%BA%E5%88%B6-02%E7%AA%97%E5%8F%A3%E4%B8%8E%E7%BA%BF%E7%A8%8B/",
            "url": "https://or0kit.github.io/Bin/Core/WindowsXp/MessageMechanism/%E6%B6%88%E6%81%AF%E6%9C%BA%E5%88%B6-02%E7%AA%97%E5%8F%A3%E4%B8%8E%E7%BA%BF%E7%A8%8B/",
            "title": "消息机制-02窗口与线程",
            "date_published": "2022-04-21T07:17:09.000Z",
            "content_html": "<h1 id=\"楔子\"><a class=\"anchor\" href=\"#楔子\">#</a> 楔子</h1>\n<p>在上一节中我们弄清楚了消息队列与线程的关系：</p>\n<p><strong>一个 GUI 线程对应着一个消息队列</strong></p>\n<p>本节要解决的问题：</p>\n<p>1、消息从哪里来？</p>\n<p>2、消息到哪里去？</p>\n<p>3、谁来做这些事情？</p>\n<h1 id=\"消息从哪里来\"><a class=\"anchor\" href=\"#消息从哪里来\">#</a> 消息从哪里来？</h1>\n<p>首先我们编写一个简单的窗口程序：</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;windows.h></span></span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>LRESULT CALLBACK <span class=\"token function\">WindowProc</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>\tIN HWND hwnd<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>\tIN UINT uMsg<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>\tIN WPARAM wParam<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>\tIN LPARAM lParam</pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\t<span class=\"token keyword\">return</span> <span class=\"token function\">DefWindowProc</span><span class=\"token punctuation\">(</span>hwnd<span class=\"token punctuation\">,</span> uMsg<span class=\"token punctuation\">,</span> wParam<span class=\"token punctuation\">,</span> lParam<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre></pre></td></tr><tr><td data-num=\"13\"></td><td><pre></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token keyword\">int</span> APIENTRY <span class=\"token function\">WinMain</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>\tHINSTANCE hInstance<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>\tHINSTANCE hPrevInstance<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>\tLPSTR lpCmdLine<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>\t<span class=\"token keyword\">int</span> nShowCmd</pre></td></tr><tr><td data-num=\"19\"></td><td><pre><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>\t<span class=\"token comment\">// 窗口的类名</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>\tTCHAR className<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token string\">\"My First Window\"</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>\t<span class=\"token comment\">// 创建一个自己的窗口</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>\tWNDCLASS wndclass <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span><span class=\"token number\">0</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>\twndclass<span class=\"token punctuation\">.</span>hbrBackground <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>HBRUSH<span class=\"token punctuation\">)</span>COLOR_MENU<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>\twndclass<span class=\"token punctuation\">.</span>lpfnWndProc <span class=\"token operator\">=</span> WindowProc<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>\twndclass<span class=\"token punctuation\">.</span>lpszClassName <span class=\"token operator\">=</span> className<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>\twndclass<span class=\"token punctuation\">.</span>hInstance <span class=\"token operator\">=</span> hInstance<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>\t<span class=\"token comment\">// 注册</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>\t<span class=\"token function\">RegisterClass</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>wndclass<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>\t<span class=\"token comment\">// 创建窗口</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>\tHWND hwnd <span class=\"token operator\">=</span> <span class=\"token function\">CreateWindow</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>\t\tclassName<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>\t\t<span class=\"token function\">TEXT</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"我的第一个窗口\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>\t\tWS_OVERLAPPEDWINDOW<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>\t\t<span class=\"token number\">10</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>\t\t<span class=\"token number\">10</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>\t\t<span class=\"token number\">600</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>\t\t<span class=\"token number\">300</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>\t\t<span class=\"token constant\">NULL</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>\t\t<span class=\"token constant\">NULL</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>\t\thInstance<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>\t\t<span class=\"token constant\">NULL</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>\t<span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>hwnd <span class=\"token operator\">==</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>\t\t<span class=\"token keyword\">return</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>\t<span class=\"token comment\">// 显示窗口</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>\t<span class=\"token function\">ShowWindow</span><span class=\"token punctuation\">(</span>hwnd<span class=\"token punctuation\">,</span> SW_SHOW<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>\t<span class=\"token comment\">// 消息循环</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre>\tMSG msg<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre>\t<span class=\"token keyword\">while</span><span class=\"token punctuation\">(</span><span class=\"token function\">GetMessage</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>msg<span class=\"token punctuation\">,</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre>\t\t<span class=\"token function\">TranslateMessage</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>msg<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre>\t\t<span class=\"token function\">DispatchMessage</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>msg<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"59\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre></pre></td></tr><tr><td data-num=\"61\"></td><td><pre>\t<span class=\"token keyword\">return</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"62\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>然后用 VC6 自带的工具 Spy++ 捕捉消息。</p>\n<p>按以下步骤捕获消息：</p>\n<p><img data-src=\"image001.png\" alt=\"\" /></p>\n<p><img data-src=\"image002.png\" alt=\"\" /></p>\n<p>如图我们动一下鼠标键盘就会 产生许多消息。</p>\n<p><img data-src=\"image003.png\" alt=\"\" /></p>\n<p>接下来用代码演示，程序发送消息：</p>\n<p>一个进程执行以下代码：</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;windows.h></span></span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>LRESULT CALLBACK <span class=\"token function\">WindowProc</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>\tIN HWND hwnd<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>\tIN UINT uMsg<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>\tIN WPARAM wParam<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>\tIN LPARAM lParam</pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\t<span class=\"token keyword\">switch</span><span class=\"token punctuation\">(</span>uMsg<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>\t<span class=\"token keyword\">case</span> <span class=\"token number\">0x401</span><span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>\t\t<span class=\"token function\">MessageBoxA</span><span class=\"token punctuation\">(</span><span class=\"token constant\">NULL</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"接收到消息\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"新消息\"</span><span class=\"token punctuation\">,</span> MB_OK<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>\t\t<span class=\"token keyword\">return</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>\t<span class=\"token keyword\">return</span> <span class=\"token function\">DefWindowProc</span><span class=\"token punctuation\">(</span>hwnd<span class=\"token punctuation\">,</span> uMsg<span class=\"token punctuation\">,</span> wParam<span class=\"token punctuation\">,</span> lParam<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre></pre></td></tr><tr><td data-num=\"19\"></td><td><pre></pre></td></tr><tr><td data-num=\"20\"></td><td><pre><span class=\"token keyword\">int</span> APIENTRY <span class=\"token function\">WinMain</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>\tHINSTANCE hInstance<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>\tHINSTANCE hPrevInstance<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>\tLPSTR lpCmdLine<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>\t<span class=\"token keyword\">int</span> nShowCmd</pre></td></tr><tr><td data-num=\"25\"></td><td><pre><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>\t<span class=\"token comment\">// 窗口的类名</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>\tTCHAR className<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token string\">\"My First Window\"</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>\t<span class=\"token comment\">// 创建一个自己的窗口</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>\tWNDCLASS wndclass <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span><span class=\"token number\">0</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>\twndclass<span class=\"token punctuation\">.</span>hbrBackground <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>HBRUSH<span class=\"token punctuation\">)</span>COLOR_MENU<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>\twndclass<span class=\"token punctuation\">.</span>lpfnWndProc <span class=\"token operator\">=</span> WindowProc<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>\twndclass<span class=\"token punctuation\">.</span>lpszClassName <span class=\"token operator\">=</span> className<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>\twndclass<span class=\"token punctuation\">.</span>hInstance <span class=\"token operator\">=</span> hInstance<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>\t<span class=\"token comment\">// 注册</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>\t<span class=\"token function\">RegisterClass</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>wndclass<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>\t<span class=\"token comment\">// 创建窗口</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>\tHWND hwnd <span class=\"token operator\">=</span> <span class=\"token function\">CreateWindow</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>\t\tclassName<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>\t\t<span class=\"token function\">TEXT</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"我的第一个窗口\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>\t\tWS_OVERLAPPEDWINDOW<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>\t\t<span class=\"token number\">10</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>\t\t<span class=\"token number\">10</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>\t\t<span class=\"token number\">600</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>\t\t<span class=\"token number\">300</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>\t\t<span class=\"token constant\">NULL</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>\t\t<span class=\"token constant\">NULL</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>\t\thInstance<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>\t\t<span class=\"token constant\">NULL</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>\t<span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>hwnd <span class=\"token operator\">==</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre>\t\t<span class=\"token keyword\">return</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>\t<span class=\"token comment\">// 显示窗口</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre>\t<span class=\"token function\">ShowWindow</span><span class=\"token punctuation\">(</span>hwnd<span class=\"token punctuation\">,</span> SW_SHOW<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre></pre></td></tr><tr><td data-num=\"59\"></td><td><pre>\t<span class=\"token comment\">// 消息循环</span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre>\tMSG msg<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"61\"></td><td><pre>\t<span class=\"token keyword\">while</span><span class=\"token punctuation\">(</span><span class=\"token function\">GetMessage</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>msg<span class=\"token punctuation\">,</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"62\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"63\"></td><td><pre>\t\t<span class=\"token function\">TranslateMessage</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>msg<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"64\"></td><td><pre>\t\t<span class=\"token function\">DispatchMessage</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>msg<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"65\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"66\"></td><td><pre></pre></td></tr><tr><td data-num=\"67\"></td><td><pre>\t<span class=\"token keyword\">return</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"68\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>另一个进程执行以下代码：</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;stdio.h></span></span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;windows.h></span></span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">int</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>\tHWND hwnd <span class=\"token operator\">=</span> <span class=\"token function\">FindWindow</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"My First Window\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"我的第一个窗口\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>\t<span class=\"token function\">SendMessage</span><span class=\"token punctuation\">(</span>hwnd<span class=\"token punctuation\">,</span> <span class=\"token number\">0x401</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\t<span class=\"token keyword\">return</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>结果：</p>\n<p><img data-src=\"image004.png\" alt=\"\" /></p>\n<h1 id=\"消息到哪里去了\"><a class=\"anchor\" href=\"#消息到哪里去了\">#</a> 消息到哪里去了</h1>\n<p><strong>最终去这个消息所对应的那个线程的消息队列。</strong></p>\n<ol>\n<li>当我们使用鼠标某个窗口进行点击与滑动时，都会产生一个消息，消息会进入当前窗口对应线程的消息队列中</li>\n<li>当我们编写程序时，并不会去特地启动两个线程去监控鼠标和键盘，w32k.sys 负责了这个事情</li>\n</ol>\n<p><img data-src=\"image005.png\" alt=\"\" /></p>\n<p>以下内容参考自 ReactOS 源码：</p>\n<blockquote>\n<p>当初始化  <code>win32k.sys</code>  这个模块时，会调用一个叫做  <code>InitInputImpl</code>  的函数<br />\n这个函数会启动两个线程，分别用来监控鼠标和键盘，这两个线程都是 0 环的线程<br />\n平时我们的电脑遭遇 “死机” 时，常常是屏幕动不了，鼠标还能动，这正式由于鼠标是有一个独立的线程在监控它的行动</p>\n</blockquote>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">//FROM ReactOS v3.12</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token function\">InitInputImpl</span><span class=\"token punctuation\">(</span>VOID<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>   <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>   Status <span class=\"token operator\">=</span> <span class=\"token function\">PsCreateSystemThread</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>RawInputThreadHandle<span class=\"token punctuation\">,</span>\t\t<span class=\"token comment\">// 监控鼠标</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>                                 THREAD_ALL_ACCESS<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>                                 <span class=\"token constant\">NULL</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>                                 <span class=\"token constant\">NULL</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>                                 <span class=\"token operator\">&amp;</span>RawInputThreadId<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>                                 RawInputThreadMain<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>                                 <span class=\"token constant\">NULL</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>   <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token function\">NT_SUCCESS</span><span class=\"token punctuation\">(</span>Status<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>   <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>      <span class=\"token function\">DPRINT1</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Win32K: Failed to create raw thread.\\n\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>   <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>   Status <span class=\"token operator\">=</span> <span class=\"token function\">PsCreateSystemThread</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>KeyboardThreadHandle<span class=\"token punctuation\">,</span>\t\t<span class=\"token comment\">// 监控键盘</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>                                 THREAD_ALL_ACCESS<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>                                 <span class=\"token constant\">NULL</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>                                 <span class=\"token constant\">NULL</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>                                 <span class=\"token operator\">&amp;</span>KeyboardThreadId<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>                                 KeyboardThreadMain<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>                                 <span class=\"token constant\">NULL</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>   <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token function\">NT_SUCCESS</span><span class=\"token punctuation\">(</span>Status<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>   <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>      <span class=\"token function\">DPRINT1</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Win32K: Failed to create keyboard thread.\\n\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>   <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>   <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>我在 xp 源码中并未找到。。</p>\n<h1 id=\"如何通过窗口找到消息队列\"><a class=\"anchor\" href=\"#如何通过窗口找到消息队列\">#</a> 如何通过窗口找到消息队列</h1>\n<p>如下图： 我们发现有十几个窗口，当我们在一个窗口上点击的时候，负责鼠标消息的这个线程是如何知道我们点击的是哪一个窗口呢？<br />\n换句话说就是，它是如何通过这个窗口找到对应的线程的呢？</p>\n<p><img data-src=\"image006.png\" alt=\"\" /></p>\n<p>我们想解决这些问题，首先要明白窗口是谁画的，窗口在哪里？</p>\n<h2 id=\"窗口是谁画的\"><a class=\"anchor\" href=\"#窗口是谁画的\">#</a> 窗口是谁画的？</h2>\n<p>分析：  <code>CreateWindow</code></p>\n<p>当调用 CreateWindow 时，该函数实际上是一个宏，其 CreateWindowA 实际对应 CreateWindowExA 函数，CreateWindowW 对应 CreateWindowExW 函数。</p>\n<p>在 VS 中查看：</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name function\">CreateWindowA</span><span class=\"token expression\"><span class=\"token punctuation\">(</span>lpClassName<span class=\"token punctuation\">,</span> lpWindowName<span class=\"token punctuation\">,</span> dwStyle<span class=\"token punctuation\">,</span> x<span class=\"token punctuation\">,</span> y<span class=\"token punctuation\">,</span></span><span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token expression\">nWidth<span class=\"token punctuation\">,</span> nHeight<span class=\"token punctuation\">,</span> hWndParent<span class=\"token punctuation\">,</span> hMenu<span class=\"token punctuation\">,</span> hInstance<span class=\"token punctuation\">,</span> lpParam<span class=\"token punctuation\">)</span></span><span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token expression\"><span class=\"token function\">CreateWindowExA</span><span class=\"token punctuation\">(</span><span class=\"token number\">0L</span><span class=\"token punctuation\">,</span> lpClassName<span class=\"token punctuation\">,</span> lpWindowName<span class=\"token punctuation\">,</span> dwStyle<span class=\"token punctuation\">,</span> x<span class=\"token punctuation\">,</span> y<span class=\"token punctuation\">,</span></span><span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token expression\">nWidth<span class=\"token punctuation\">,</span> nHeight<span class=\"token punctuation\">,</span> hWndParent<span class=\"token punctuation\">,</span> hMenu<span class=\"token punctuation\">,</span> hInstance<span class=\"token punctuation\">,</span> lpParam<span class=\"token punctuation\">)</span></span></span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name function\">CreateWindowW</span><span class=\"token expression\"><span class=\"token punctuation\">(</span>lpClassName<span class=\"token punctuation\">,</span> lpWindowName<span class=\"token punctuation\">,</span> dwStyle<span class=\"token punctuation\">,</span> x<span class=\"token punctuation\">,</span> y<span class=\"token punctuation\">,</span></span><span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token expression\">nWidth<span class=\"token punctuation\">,</span> nHeight<span class=\"token punctuation\">,</span> hWndParent<span class=\"token punctuation\">,</span> hMenu<span class=\"token punctuation\">,</span> hInstance<span class=\"token punctuation\">,</span> lpParam<span class=\"token punctuation\">)</span></span><span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token expression\"><span class=\"token function\">CreateWindowExW</span><span class=\"token punctuation\">(</span><span class=\"token number\">0L</span><span class=\"token punctuation\">,</span> lpClassName<span class=\"token punctuation\">,</span> lpWindowName<span class=\"token punctuation\">,</span> dwStyle<span class=\"token punctuation\">,</span> x<span class=\"token punctuation\">,</span> y<span class=\"token punctuation\">,</span></span><span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token expression\">nWidth<span class=\"token punctuation\">,</span> nHeight<span class=\"token punctuation\">,</span> hWndParent<span class=\"token punctuation\">,</span> hMenu<span class=\"token punctuation\">,</span> hInstance<span class=\"token punctuation\">,</span> lpParam<span class=\"token punctuation\">)</span></span></span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">ifdef</span> <span class=\"token expression\">UNICODE</span></span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">CreateWindow</span>  <span class=\"token expression\">CreateWindowW</span></span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">else</span></span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">CreateWindow</span>  <span class=\"token expression\">CreateWindowA</span></span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">endif</span> <span class=\"token comment\">// !UNICODE</span></span></pre></td></tr></table></figure><p>在 IDA 中查看:</p>\n<p>发现不管是  <code>CreateWindowExA</code>  还是  <code>CreateWindowExW</code>  都是直接调用了  <code>__CreateWindowEx</code></p>\n<figure class=\"highlight raw\"><figcaption data-lang=\"\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>text:77D2E4A9 ; HWND __stdcall CreateWindowExA(DWORD dwExStyle, LPCSTR lpClassName, LPCSTR lpWindowName, DWORD dwStyle, int X, int Y, int nWidth, int nHeight, HWND hWndParent, HMENU hMenu, HINSTANCE hInstance, LPVOID lpParam)</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>.text:77D2E4A9                 public _CreateWindowExA@48</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>.text:77D2E4A9 _CreateWindowExA@48 proc near           ; CODE XREF: DefMDIChildProcWorker(x,x,x,x,x)-3EA↓p</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>.text:77D2E4A9                                         ; CreateMDIWindowA(x,x,x,x,x,x,x,x,x,x)+27↓p ...</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>.text:77D2E4A9</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>.text:77D2E4A9 dwExStyle       &#x3D; dword ptr  8</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>.text:77D2E4A9 lpClassName     &#x3D; dword ptr  0Ch</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>.text:77D2E4A9 lpWindowName    &#x3D; dword ptr  10h</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>.text:77D2E4A9 dwStyle         &#x3D; dword ptr  14h</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>.text:77D2E4A9 X               &#x3D; dword ptr  18h</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>.text:77D2E4A9 Y               &#x3D; dword ptr  1Ch</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>.text:77D2E4A9 nWidth          &#x3D; dword ptr  20h</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>.text:77D2E4A9 nHeight         &#x3D; dword ptr  24h</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>.text:77D2E4A9 hWndParent      &#x3D; dword ptr  28h</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>.text:77D2E4A9 hMenu           &#x3D; dword ptr  2Ch</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>.text:77D2E4A9 hInstance       &#x3D; dword ptr  30h</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>.text:77D2E4A9 lpParam         &#x3D; dword ptr  34h</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>.text:77D2E4A9</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>.text:77D2E4A9                 mov     edi, edi</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>.text:77D2E4AB                 push    ebp</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>.text:77D2E4AC                 mov     ebp, esp</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>.text:77D2E4AE                 push    40000001h       ; int</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>.text:77D2E4B3                 push    [ebp+lpParam]   ; int</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>.text:77D2E4B6                 push    [ebp+hInstance] ; int</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>.text:77D2E4B9                 push    [ebp+hMenu]     ; int</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>.text:77D2E4BC                 push    [ebp+hWndParent] ; int</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>.text:77D2E4BF                 push    [ebp+nHeight]   ; int</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>.text:77D2E4C2                 push    [ebp+nWidth]    ; int</pre></td></tr><tr><td data-num=\"29\"></td><td><pre>.text:77D2E4C5                 push    [ebp+Y]         ; int</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>.text:77D2E4C8                 push    [ebp+X]         ; int</pre></td></tr><tr><td data-num=\"31\"></td><td><pre>.text:77D2E4CB                 push    [ebp+dwStyle]   ; int</pre></td></tr><tr><td data-num=\"32\"></td><td><pre>.text:77D2E4CE                 push    [ebp+lpWindowName] ; String</pre></td></tr><tr><td data-num=\"33\"></td><td><pre>.text:77D2E4D1                 push    [ebp+lpClassName] ; MultiByteString</pre></td></tr><tr><td data-num=\"34\"></td><td><pre>.text:77D2E4D4                 push    [ebp+dwExStyle] ; char</pre></td></tr><tr><td data-num=\"35\"></td><td><pre>.text:77D2E4D7                 call    __CreateWindowEx@52 ; _CreateWindowEx(x,x,x,x,x,x,x,x,x,x,x,x,x)</pre></td></tr><tr><td data-num=\"36\"></td><td><pre>.text:77D2E4DC                 pop     ebp</pre></td></tr><tr><td data-num=\"37\"></td><td><pre>.text:77D2E4DD                 retn    30h ; &#39;0&#39;</pre></td></tr><tr><td data-num=\"38\"></td><td><pre>.text:77D2E4DD _CreateWindowExA@48 endp</pre></td></tr></table></figure><figure class=\"highlight raw\"><figcaption data-lang=\"\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>.text:77D2D0A3 ; HWND __stdcall CreateWindowExW(DWORD dwExStyle, LPCWSTR lpClassName, LPCWSTR lpWindowName, DWORD dwStyle, int X, int Y, int nWidth, int nHeight, HWND hWndParent, HMENU hMenu, HINSTANCE hInstance, LPVOID lpParam)</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>.text:77D2D0A3                 public _CreateWindowExW@48</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>.text:77D2D0A3 _CreateWindowExW@48 proc near           ; CODE XREF: DefMDIChildProcWorker(x,x,x,x,x):loc_77D30688↓p</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>.text:77D2D0A3                                         ; CreateMDIWindowW(x,x,x,x,x,x,x,x,x,x)+27↓p ...</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>.text:77D2D0A3</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>.text:77D2D0A3 dwExStyle       &#x3D; dword ptr  8</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>.text:77D2D0A3 lpClassName     &#x3D; dword ptr  0Ch</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>.text:77D2D0A3 lpWindowName    &#x3D; dword ptr  10h</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>.text:77D2D0A3 dwStyle         &#x3D; dword ptr  14h</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>.text:77D2D0A3 X               &#x3D; dword ptr  18h</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>.text:77D2D0A3 Y               &#x3D; dword ptr  1Ch</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>.text:77D2D0A3 nWidth          &#x3D; dword ptr  20h</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>.text:77D2D0A3 nHeight         &#x3D; dword ptr  24h</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>.text:77D2D0A3 hWndParent      &#x3D; dword ptr  28h</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>.text:77D2D0A3 hMenu           &#x3D; dword ptr  2Ch</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>.text:77D2D0A3 hInstance       &#x3D; dword ptr  30h</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>.text:77D2D0A3 lpParam         &#x3D; dword ptr  34h</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>.text:77D2D0A3</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>.text:77D2D0A3                 mov     edi, edi</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>.text:77D2D0A5                 push    ebp</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>.text:77D2D0A6                 mov     ebp, esp</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>.text:77D2D0A8                 push    40000000h       ; int</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>.text:77D2D0AD                 push    [ebp+lpParam]   ; int</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>.text:77D2D0B0                 push    [ebp+hInstance] ; int</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>.text:77D2D0B3                 push    [ebp+hMenu]     ; int</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>.text:77D2D0B6                 push    [ebp+hWndParent] ; int</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>.text:77D2D0B9                 push    [ebp+nHeight]   ; int</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>.text:77D2D0BC                 push    [ebp+nWidth]    ; int</pre></td></tr><tr><td data-num=\"29\"></td><td><pre>.text:77D2D0BF                 push    [ebp+Y]         ; int</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>.text:77D2D0C2                 push    [ebp+X]         ; int</pre></td></tr><tr><td data-num=\"31\"></td><td><pre>.text:77D2D0C5                 push    [ebp+dwStyle]   ; int</pre></td></tr><tr><td data-num=\"32\"></td><td><pre>.text:77D2D0C8                 push    [ebp+lpWindowName] ; String</pre></td></tr><tr><td data-num=\"33\"></td><td><pre>.text:77D2D0CB                 push    [ebp+lpClassName] ; MultiByteString</pre></td></tr><tr><td data-num=\"34\"></td><td><pre>.text:77D2D0CE                 push    [ebp+dwExStyle] ; char</pre></td></tr><tr><td data-num=\"35\"></td><td><pre>.text:77D2D0D1                 call    __CreateWindowEx@52 ; _CreateWindowEx(x,x,x,x,x,x,x,x,x,x,x,x,x)</pre></td></tr><tr><td data-num=\"36\"></td><td><pre>.text:77D2D0D6                 pop     ebp</pre></td></tr><tr><td data-num=\"37\"></td><td><pre>.text:77D2D0D7                 retn    30h ; &#39;0&#39;</pre></td></tr><tr><td data-num=\"38\"></td><td><pre>.text:77D2D0D7 _CreateWindowExW@48 endp</pre></td></tr></table></figure><p>查看  <code>__CreateWindowEx</code> :</p>\n<p><img data-src=\"image007.png\" alt=\"\" /></p>\n<p>发现其主要调用了  <code>VerNtUserCreateWindowEx</code></p>\n<p>接着查看：</p>\n<p><img data-src=\"image008.png\" alt=\"\" /></p>\n<p>发现其主要调用了  <code>NtUserCreateWindowEx</code></p>\n<p>查看  <code>NtUserCreateWindowEx</code>  发现其通过系统调用进 0 环了</p>\n<figure class=\"highlight raw\"><figcaption data-lang=\"\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>.text:77D2E37D ; __stdcall NtUserCreateWindowEx(x, x, x, x, x, x, x, x, x, x, x, x, x, x, x)</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>.text:77D2E37D _NtUserCreateWindowEx@60 proc near      ; CODE XREF: VerNtUserCreateWindowEx(x,x,x,x,x,x,x,x,x,x,x,x,x)+158↑p</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>.text:77D2E37D                 mov     eax, 1157h</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>.text:77D2E382                 mov     edx, 7FFE0300h</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>.text:77D2E387                 call    dword ptr [edx]</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>.text:77D2E389                 retn    3Ch ; &#39;&lt;&#39;</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>.text:77D2E389 _NtUserCreateWindowEx@60 endp</pre></td></tr></table></figure><p>所以窗口是 0 环画的。</p>\n<h2 id=\"窗口对象\"><a class=\"anchor\" href=\"#窗口对象\">#</a> 窗口对象</h2>\n<p>窗口在内核同样也有一个对应的结构。</p>\n<p>通过分析 XP 的源码观察  <code>CreateWindow</code>  窗口的创建过程，发现其涉及了好多结构体。</p>\n<p>以下是我在 XP 源码中的发现：<br />\n从此函数开始：</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>PTHREADINFO <span class=\"token function\">PtiCurrent</span><span class=\"token punctuation\">(</span>VOID<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token function\">ConnectIfNecessary</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span>PTHREADINFO<span class=\"token punctuation\">)</span><span class=\"token function\">NtCurrentTebShared</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">-></span>Win32ThreadInfo<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">typedef</span> <span class=\"token keyword\">struct</span> <span class=\"token class-name\">tagTHREADINFO</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    W32THREAD<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token comment\">//***************************************** begin: USER specific fields</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    PTL             ptl<span class=\"token punctuation\">;</span>                <span class=\"token comment\">// Listhead for thread lock list</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    PPROCESSINFO    ppi<span class=\"token punctuation\">;</span>                <span class=\"token comment\">// process info struct for this thread</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    PQ              pq<span class=\"token punctuation\">;</span>                 <span class=\"token comment\">// keyboard and mouse input queue</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    PKL             spklActive<span class=\"token punctuation\">;</span>         <span class=\"token comment\">// active keyboard layout for this thread</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    PCLIENTTHREADINFO pcti<span class=\"token punctuation\">;</span>             <span class=\"token comment\">// Info that must be visible from client</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    PDESKTOP        rpdesk<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    PDESKTOPINFO    pDeskInfo<span class=\"token punctuation\">;</span>          <span class=\"token comment\">// Desktop info visible to client</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>    PCLIENTINFO     pClientInfo<span class=\"token punctuation\">;</span>        <span class=\"token comment\">// Client info stored in TEB</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>    DWORD           TIF_flags<span class=\"token punctuation\">;</span>          <span class=\"token comment\">// TIF_ flags go here.</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>    PUNICODE_STRING pstrAppName<span class=\"token punctuation\">;</span>        <span class=\"token comment\">// Application module name.</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>    PSMS            psmsSent<span class=\"token punctuation\">;</span>           <span class=\"token comment\">// Most recent SMS this thread has sent</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>    PSMS            psmsCurrent<span class=\"token punctuation\">;</span>        <span class=\"token comment\">// Received SMS this thread is currently processing</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>    PSMS            psmsReceiveList<span class=\"token punctuation\">;</span>    <span class=\"token comment\">// SMSs to be processed</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>    LONG            timeLast<span class=\"token punctuation\">;</span>           <span class=\"token comment\">// Time and ID of last message</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>    ULONG_PTR       idLast<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>    <span class=\"token keyword\">int</span>             exitCode<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>    HDESK           hdesk<span class=\"token punctuation\">;</span>              <span class=\"token comment\">// Desktop handle</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>    <span class=\"token keyword\">int</span>             cPaintsReady<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>    UINT            cTimersReady<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>    PMENUSTATE      pMenuState<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>    <span class=\"token keyword\">union</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>        PTDB            ptdb<span class=\"token punctuation\">;</span>           <span class=\"token comment\">// Win16Task Schedule data for WOW thread</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>        PWINDOWSTATION  pwinsta<span class=\"token punctuation\">;</span>        <span class=\"token comment\">// Window station for SYSTEM thread</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>    PSVR_INSTANCE_INFO psiiList<span class=\"token punctuation\">;</span>        <span class=\"token comment\">// thread DDEML instance list</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>    DWORD           dwExpWinVer<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>    DWORD           dwCompatFlags<span class=\"token punctuation\">;</span>      <span class=\"token comment\">// The Win 3.1 Compat flags</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>    DWORD           dwCompatFlags2<span class=\"token punctuation\">;</span>     <span class=\"token comment\">// new DWORD to extend compat flags for NT5+ features</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>    PQ              pqAttach<span class=\"token punctuation\">;</span>           <span class=\"token comment\">// calculation variabled used in</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>                                        <span class=\"token comment\">// zzzAttachThreadInput()</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre></pre></td></tr><tr><td data-num=\"52\"></td><td><pre>    PTHREADINFO     ptiSibling<span class=\"token punctuation\">;</span>         <span class=\"token comment\">// pointer to sibling thread info</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre></pre></td></tr><tr><td data-num=\"54\"></td><td><pre>    PMOVESIZEDATA   pmsd<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>    DWORD           fsHooks<span class=\"token punctuation\">;</span>                <span class=\"token comment\">// WHF_ Flags for which hooks are installed</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre>    PHOOK           sphkCurrent<span class=\"token punctuation\">;</span>            <span class=\"token comment\">// Hook this thread is currently processing</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre></pre></td></tr><tr><td data-num=\"59\"></td><td><pre>    PSBTRACK        pSBTrack<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre></pre></td></tr><tr><td data-num=\"61\"></td><td><pre>    HANDLE          hEventQueueClient<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"62\"></td><td><pre>    PKEVENT         pEventQueueServer<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"63\"></td><td><pre>    LIST_ENTRY      PtiLink<span class=\"token punctuation\">;</span>            <span class=\"token comment\">// Link to other threads on desktop</span></pre></td></tr><tr><td data-num=\"64\"></td><td><pre>    <span class=\"token keyword\">int</span>             iCursorLevel<span class=\"token punctuation\">;</span>       <span class=\"token comment\">// keep track of each thread's level</span></pre></td></tr><tr><td data-num=\"65\"></td><td><pre>    POINT           ptLast<span class=\"token punctuation\">;</span>             <span class=\"token comment\">// Position of last message</span></pre></td></tr><tr><td data-num=\"66\"></td><td><pre></pre></td></tr><tr><td data-num=\"67\"></td><td><pre>    PWND            spwndDefaultIme<span class=\"token punctuation\">;</span>    <span class=\"token comment\">// Default IME Window for this thread</span></pre></td></tr><tr><td data-num=\"68\"></td><td><pre>    PIMC            spDefaultImc<span class=\"token punctuation\">;</span>       <span class=\"token comment\">// Default input context for this thread</span></pre></td></tr><tr><td data-num=\"69\"></td><td><pre>    HKL             hklPrev<span class=\"token punctuation\">;</span>            <span class=\"token comment\">// Previous active keyboard layout</span></pre></td></tr><tr><td data-num=\"70\"></td><td><pre>    <span class=\"token keyword\">int</span>             cEnterCount<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"71\"></td><td><pre>    MLIST           mlPost<span class=\"token punctuation\">;</span>             <span class=\"token comment\">// posted message list.</span></pre></td></tr><tr><td data-num=\"72\"></td><td><pre>    USHORT          fsChangeBitsRemoved<span class=\"token punctuation\">;</span><span class=\"token comment\">// Bits removed during PeekMessage</span></pre></td></tr><tr><td data-num=\"73\"></td><td><pre>    WCHAR           wchInjected<span class=\"token punctuation\">;</span>        <span class=\"token comment\">// character from last VK_PACKET</span></pre></td></tr><tr><td data-num=\"74\"></td><td><pre>    DWORD           fsReserveKeys<span class=\"token punctuation\">;</span>      <span class=\"token comment\">// Keys that must be sent to the active</span></pre></td></tr><tr><td data-num=\"75\"></td><td><pre>                                        <span class=\"token comment\">// active console window.</span></pre></td></tr><tr><td data-num=\"76\"></td><td><pre>    PKEVENT        <span class=\"token operator\">*</span>apEvent<span class=\"token punctuation\">;</span>            <span class=\"token comment\">// Wait array for xxxPollAndWaitForSingleObject</span></pre></td></tr><tr><td data-num=\"77\"></td><td><pre>    ACCESS_MASK     amdesk<span class=\"token punctuation\">;</span>             <span class=\"token comment\">// Granted desktop access</span></pre></td></tr><tr><td data-num=\"78\"></td><td><pre>    UINT            cWindows<span class=\"token punctuation\">;</span>           <span class=\"token comment\">// Number of windows owned by this thread</span></pre></td></tr><tr><td data-num=\"79\"></td><td><pre>    UINT            cVisWindows<span class=\"token punctuation\">;</span>        <span class=\"token comment\">// Number of visible windows on this thread</span></pre></td></tr><tr><td data-num=\"80\"></td><td><pre></pre></td></tr><tr><td data-num=\"81\"></td><td><pre>    PHOOK           aphkStart<span class=\"token punctuation\">[</span>CWINHOOKS<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>   <span class=\"token comment\">// Hooks registered for this thread</span></pre></td></tr><tr><td data-num=\"82\"></td><td><pre>    CLIENTTHREADINFO  cti<span class=\"token punctuation\">;</span>              <span class=\"token comment\">// Use this when no desktop is available</span></pre></td></tr><tr><td data-num=\"83\"></td><td><pre></pre></td></tr><tr><td data-num=\"84\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">ifdef</span> <span class=\"token expression\">GENERIC_INPUT</span></span></pre></td></tr><tr><td data-num=\"85\"></td><td><pre>    HANDLE          hPrevHidData<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"86\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">endif</span></span></pre></td></tr><tr><td data-num=\"87\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">if</span> <span class=\"token expression\">DBG</span></span></pre></td></tr><tr><td data-num=\"88\"></td><td><pre>    UINT            cNestedCalls<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"89\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">endif</span></span></pre></td></tr><tr><td data-num=\"90\"></td><td><pre><span class=\"token punctuation\">&#125;</span> THREADINFO<span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>其中  <code>W32THREAD</code></p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\">// This is the header shared info for W32 threads.  It is followed by the</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\">// NtUser per thread information.</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token keyword\">typedef</span> <span class=\"token keyword\">struct</span> <span class=\"token class-name\">_W32THREAD</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    PETHREAD        pEThread<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    ULONG           RefCount<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    PTL             ptlW32<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    KERNEL_PVOID    pgdiDcattr<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    KERNEL_PVOID    pgdiBrushAttr<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    KERNEL_PVOID    pUMPDObjs<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    KERNEL_PVOID    pUMPDHeap<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    ULONG           dwEngAcquireCount<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    KERNEL_PVOID    pSemTable<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    KERNEL_PVOID    pUMPDObj<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">if</span> <span class=\"token expression\"><span class=\"token function\">defined</span><span class=\"token punctuation\">(</span>_WIN64<span class=\"token punctuation\">)</span></span></span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>    KERNEL_PVOID    pProxyPort<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    KERNEL_PVOID    pClientID<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">endif</span></span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre><span class=\"token punctuation\">&#125;</span> W32THREAD<span class=\"token punctuation\">,</span> <span class=\"token operator\">*</span> KPTR_MODIFIER PW32THREAD<span class=\"token punctuation\">;</span></pre></td></tr></table></figure><figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">/*</pre></td></tr><tr><td data-num=\"2\"></td><td><pre> * Extended structures for message thunking.</pre></td></tr><tr><td data-num=\"3\"></td><td><pre> */</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">typedef</span> <span class=\"token keyword\">struct</span> <span class=\"token class-name\">_CREATESTRUCTEX</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    CREATESTRUCT cs<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    LARGE_STRING strName<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    LARGE_STRING strClass<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token punctuation\">&#125;</span> CREATESTRUCTEX<span class=\"token punctuation\">,</span> <span class=\"token operator\">*</span>PCREATESTRUCTEX<span class=\"token punctuation\">;</span></pre></td></tr></table></figure><figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">/* WM_CREATE/WM_NCCREATE lParam struct */</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">typedef</span> <span class=\"token keyword\">struct</span> <span class=\"token class-name\">tagCREATESTRUCT</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token keyword\">void</span> FAR<span class=\"token operator\">*</span> lpCreateParams<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    HINSTANCE hInstance<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    HMENU     hMenu<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    HWND      hwndParent<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token keyword\">int</span>       cy<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token keyword\">int</span>       cx<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    <span class=\"token keyword\">int</span>       y<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    <span class=\"token keyword\">int</span>       x<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    LONG      style<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    LPCSTR    lpszName<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    LPCSTR    lpszClass<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    DWORD     dwExStyle<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token punctuation\">&#125;</span> CREATESTRUCT<span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>通过分析  <code>xxxCreateWindowEx</code>  函数，最终发现窗口实例结构：</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">/*</pre></td></tr><tr><td data-num=\"2\"></td><td><pre> * sizeof(THROBJHEAD) must be equal to sizeof(PROCOBJHEAD)</pre></td></tr><tr><td data-num=\"3\"></td><td><pre> * This is to make sure that DESKHEAD fields are always at the same offset.</pre></td></tr><tr><td data-num=\"4\"></td><td><pre> */</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token keyword\">typedef</span> <span class=\"token keyword\">struct</span> <span class=\"token class-name\">_THROBJHEAD</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    HEAD<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    PTHREADINFO pti<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token punctuation\">&#125;</span> THROBJHEAD<span class=\"token punctuation\">,</span> <span class=\"token operator\">*</span> KPTR_MODIFIER PTHROBJHEAD<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token keyword\">typedef</span> <span class=\"token keyword\">struct</span> <span class=\"token class-name\">_THRDESKHEAD</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    THROBJHEAD<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    DESKHEAD<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token punctuation\">&#125;</span> THRDESKHEAD<span class=\"token punctuation\">,</span> <span class=\"token operator\">*</span>PTHRDESKHEAD<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token keyword\">typedef</span> <span class=\"token keyword\">struct</span> <span class=\"token class-name\">tagWND</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    THRDESKHEAD   head<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>    WW<span class=\"token punctuation\">;</span>         <span class=\"token comment\">// WOW-USER common fields. Defined in wowuserp.h</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>                <span class=\"token comment\">// The presence of \"state\" at the start of this structure is</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>                <span class=\"token comment\">// assumed by the STATEOFFSET macro.</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>    PWND                 spwndNext<span class=\"token punctuation\">;</span>    <span class=\"token comment\">// Handle to the next window</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>    PWND                 spwndPrev<span class=\"token punctuation\">;</span>    <span class=\"token comment\">// Handle to the previous window</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>    PWND                 spwndParent<span class=\"token punctuation\">;</span>  <span class=\"token comment\">// Backpointer to the parent window.</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>    PWND                 spwndChild<span class=\"token punctuation\">;</span>   <span class=\"token comment\">// Handle to child</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>    PWND                 spwndOwner<span class=\"token punctuation\">;</span>   <span class=\"token comment\">// Popup window owner field</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>    RECT                 rcWindow<span class=\"token punctuation\">;</span>     <span class=\"token comment\">// Window outer rectangle</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>    RECT                 rcClient<span class=\"token punctuation\">;</span>     <span class=\"token comment\">// Client rectangle</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>    WNDPROC_PWND         lpfnWndProc<span class=\"token punctuation\">;</span>  <span class=\"token comment\">// Can be WOW address or standard address</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>    PCLS                 pcls<span class=\"token punctuation\">;</span>         <span class=\"token comment\">// Pointer to window class</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>    KHRGN                hrgnUpdate<span class=\"token punctuation\">;</span>   <span class=\"token comment\">// Accumulated paint region</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>    PPROPLIST            ppropList<span class=\"token punctuation\">;</span>    <span class=\"token comment\">// Pointer to property list</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>    PSBINFO              pSBInfo<span class=\"token punctuation\">;</span>      <span class=\"token comment\">// Words used for scrolling</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>    PMENU                spmenuSys<span class=\"token punctuation\">;</span>    <span class=\"token comment\">// Handle to system menu</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>    PMENU                spmenu<span class=\"token punctuation\">;</span>       <span class=\"token comment\">// Menu handle or ID</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>    KHRGN                hrgnClip<span class=\"token punctuation\">;</span>     <span class=\"token comment\">// Clipping region for this window</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>    LARGE_UNICODE_STRING strName<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>    <span class=\"token keyword\">int</span>                  cbwndExtra<span class=\"token punctuation\">;</span>   <span class=\"token comment\">// Extra bytes in window</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>    PWND                 spwndLastActive<span class=\"token punctuation\">;</span> <span class=\"token comment\">// Last active in owner/ownee list</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>    KHIMC                hImc<span class=\"token punctuation\">;</span>         <span class=\"token comment\">// Associated input context handle</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>    KERNEL_ULONG_PTR     dwUserData<span class=\"token punctuation\">;</span>   <span class=\"token comment\">// Reserved for random application data</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>    <span class=\"token keyword\">struct</span> <span class=\"token class-name\">_ACTIVATION_CONTEXT</span>  <span class=\"token operator\">*</span> KPTR_MODIFIER pActCtx<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">ifdef</span> <span class=\"token expression\">LAME_BUTTON</span></span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre>    KERNEL_PVOID    pStackTrace<span class=\"token punctuation\">;</span>       <span class=\"token comment\">// Creation stack trace; used by lame</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>                                       <span class=\"token comment\">// button.</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">endif</span> <span class=\"token comment\">// LAME_BUTTON</span></span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre><span class=\"token punctuation\">&#125;</span> WND<span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>这个就是窗口在内核对应的结构体</p>\n<h2 id=\"消息进入窗口消息队列的过程\"><a class=\"anchor\" href=\"#消息进入窗口消息队列的过程\">#</a> 消息进入窗口消息队列的过程</h2>\n<ol>\n<li>当使用鼠标在某个窗口上点击时，鼠标监控线程检测到点击的窗口对象</li>\n<li>根据窗口对象成员，找到窗口对应线程</li>\n<li>将消息放入该线程的消息队列中</li>\n</ol>\n<h1 id=\"总结\"><a class=\"anchor\" href=\"#总结\">#</a> 总结</h1>\n<ol>\n<li>窗口在 0 环创建</li>\n<li>窗口句柄是全局的</li>\n<li>一个线程可以使用多个窗口，但每个窗口只能属于一个线程</li>\n</ol>\n<h1 id=\"reference\"><a class=\"anchor\" href=\"#reference\">#</a> Reference</h1>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQxOTg4NDQ4L2FydGljbGUvZGV0YWlscy8xMTI4Mjc4MjI=\">https://blog.csdn.net/qq_41988448/article/details/112827822</span></p>\n",
            "tags": [
                "消息队列与线程"
            ]
        },
        {
            "id": "https://or0kit.github.io/Bin/Core/WindowsXp/MessageMechanism/%E6%B6%88%E6%81%AF%E6%9C%BA%E5%88%B6-01%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97%E5%9C%A8%E5%93%AA/",
            "url": "https://or0kit.github.io/Bin/Core/WindowsXp/MessageMechanism/%E6%B6%88%E6%81%AF%E6%9C%BA%E5%88%B6-01%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97%E5%9C%A8%E5%93%AA/",
            "title": "消息机制-01消息队列在哪",
            "date_published": "2022-04-20T07:17:06.000Z",
            "content_html": "<h1 id=\"楔子\"><a class=\"anchor\" href=\"#楔子\">#</a> 楔子</h1>\n<p>接触过编程的人，或多或少用到过消息机制，但大多数人（包括我自己）只是知道相关 API 的基本用法，却不知道它是如何实现的</p>\n<p>从本章起，我们将带着以下几个问题一起来学习消息机制：</p>\n<ol>\n<li>什么是窗口句柄？在哪里？有什么用？</li>\n<li>什么是消息？什么是消息队列？消息队列在哪？</li>\n<li>什么是窗口过程？窗口过程是谁调用的？没有消息循环窗口过程会执行吗？</li>\n<li>为什么要有 w32k.sys 这个模块？</li>\n<li>为什么只有使用图形界面的程序才可以访问 KeServiceDescriptorTableShadow?</li>\n<li>界面 &quot;卡死&quot; 的时候为什么鼠标还可以动？</li>\n</ol>\n<h1 id=\"画一个简单的窗口\"><a class=\"anchor\" href=\"#画一个简单的窗口\">#</a> 画一个简单的窗口</h1>\n<p>从设计层面理解 Windows 的消息机制是怎么来的。</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;stdio.h></span></span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">_WIN32_WINNT</span> <span class=\"token expression\"><span class=\"token number\">0x500</span></span></span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;windows.h></span></span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token keyword\">typedef</span> <span class=\"token keyword\">struct</span> <span class=\"token class-name\">_Color</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>\tDWORD r<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>\tDWORD g<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\tDWORD b<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token punctuation\">&#125;</span>Color<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token keyword\">typedef</span> <span class=\"token keyword\">struct</span> <span class=\"token class-name\">_WindowClass</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>\tDWORD x<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>\tDWORD y<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>\tDWORD width<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>\tDWORD height<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>\tColor color<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre><span class=\"token punctuation\">&#125;</span>WindowClass<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre></pre></td></tr><tr><td data-num=\"21\"></td><td><pre><span class=\"token comment\">// 按照 WindowClass 的参数，将 hdc 中的数据打印到指定设备</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre><span class=\"token keyword\">void</span> <span class=\"token function\">PaintWindows</span><span class=\"token punctuation\">(</span>HDC hdc<span class=\"token punctuation\">,</span> WindowClass <span class=\"token operator\">*</span>p<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>\tHBRUSH hBrush<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>\thBrush <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>HBRUSH<span class=\"token punctuation\">)</span><span class=\"token function\">GetStockObject</span><span class=\"token punctuation\">(</span>DC_BRUSH<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>\t<span class=\"token function\">SelectObject</span><span class=\"token punctuation\">(</span>hdc<span class=\"token punctuation\">,</span> hBrush<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\t\t\t<span class=\"token comment\">// 画刷</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>\t<span class=\"token function\">SetDCBrushColor</span><span class=\"token punctuation\">(</span>hdc<span class=\"token punctuation\">,</span> <span class=\"token function\">RGB</span><span class=\"token punctuation\">(</span>p<span class=\"token operator\">-></span>color<span class=\"token punctuation\">.</span>r<span class=\"token punctuation\">,</span> p<span class=\"token operator\">-></span>color<span class=\"token punctuation\">.</span>g<span class=\"token punctuation\">,</span> p<span class=\"token operator\">-></span>color<span class=\"token punctuation\">.</span>b<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>\t<span class=\"token function\">MoveToEx</span><span class=\"token punctuation\">(</span>hdc<span class=\"token punctuation\">,</span> p<span class=\"token operator\">-></span>x<span class=\"token punctuation\">,</span> p<span class=\"token operator\">-></span>y<span class=\"token punctuation\">,</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>\t<span class=\"token function\">LineTo</span><span class=\"token punctuation\">(</span>hdc<span class=\"token punctuation\">,</span> p<span class=\"token operator\">-></span>x<span class=\"token operator\">+</span>p<span class=\"token operator\">-></span>width<span class=\"token punctuation\">,</span> p<span class=\"token operator\">-></span>y<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>\t<span class=\"token function\">LineTo</span><span class=\"token punctuation\">(</span>hdc<span class=\"token punctuation\">,</span> p<span class=\"token operator\">-></span>x<span class=\"token operator\">+</span>p<span class=\"token operator\">-></span>width<span class=\"token punctuation\">,</span> p<span class=\"token operator\">-></span>y<span class=\"token operator\">+</span>p<span class=\"token operator\">-></span>height<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>\t<span class=\"token function\">LineTo</span><span class=\"token punctuation\">(</span>hdc<span class=\"token punctuation\">,</span> p<span class=\"token operator\">-></span>x<span class=\"token punctuation\">,</span> p<span class=\"token operator\">-></span>y<span class=\"token operator\">+</span>p<span class=\"token operator\">-></span>height<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>\t<span class=\"token function\">LineTo</span><span class=\"token punctuation\">(</span>hdc<span class=\"token punctuation\">,</span> p<span class=\"token operator\">-></span>x<span class=\"token punctuation\">,</span> p<span class=\"token operator\">-></span>y<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>\t<span class=\"token function\">Rectangle</span><span class=\"token punctuation\">(</span>hdc<span class=\"token punctuation\">,</span> p<span class=\"token operator\">-></span>x<span class=\"token punctuation\">,</span> p<span class=\"token operator\">-></span>y<span class=\"token punctuation\">,</span> p<span class=\"token operator\">-></span>width<span class=\"token punctuation\">,</span> p<span class=\"token operator\">-></span>height<span class=\"token operator\">+</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>\t<span class=\"token function\">DeleteObject</span><span class=\"token punctuation\">(</span>hBrush<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre></pre></td></tr><tr><td data-num=\"40\"></td><td><pre><span class=\"token keyword\">int</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>\t<span class=\"token keyword\">char</span> cMessage<span class=\"token punctuation\">;</span>\t\t<span class=\"token comment\">// 消息</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>\tHWND hwnd<span class=\"token punctuation\">;</span>\t\t\t<span class=\"token comment\">// 画在哪</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>\tHDC hdc<span class=\"token punctuation\">;</span>\t\t\t<span class=\"token comment\">// 显卡缓存</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>\t<span class=\"token comment\">// 设置窗口参数，长宽高之类的</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>\tWindowClass wClass<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>\twClass<span class=\"token punctuation\">.</span>x <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>\twClass<span class=\"token punctuation\">.</span>y <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>\twClass<span class=\"token punctuation\">.</span>width <span class=\"token operator\">=</span> <span class=\"token number\">800</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>\twClass<span class=\"token punctuation\">.</span>height <span class=\"token operator\">=</span> <span class=\"token number\">400</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre>\twClass<span class=\"token punctuation\">.</span>color<span class=\"token punctuation\">.</span>r <span class=\"token operator\">=</span> <span class=\"token number\">0xEF</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>\twClass<span class=\"token punctuation\">.</span>color<span class=\"token punctuation\">.</span>g <span class=\"token operator\">=</span> <span class=\"token number\">0xEB</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre>\twClass<span class=\"token punctuation\">.</span>color<span class=\"token punctuation\">.</span>b <span class=\"token operator\">=</span> <span class=\"token number\">0xDE</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>\t<span class=\"token comment\">// 画在哪</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre>\thwnd <span class=\"token operator\">=</span> <span class=\"token function\">GetDesktopWindow</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre>\t<span class=\"token comment\">//hwnd = FindWindow(\"dbgviewClass\", NULL);</span></pre></td></tr><tr><td data-num=\"59\"></td><td><pre></pre></td></tr><tr><td data-num=\"60\"></td><td><pre>\t<span class=\"token comment\">// 获取 DC 设备句柄：可以把 DC 理解成显卡缓存</span></pre></td></tr><tr><td data-num=\"61\"></td><td><pre>\thdc <span class=\"token operator\">=</span> <span class=\"token function\">GetWindowDC</span><span class=\"token punctuation\">(</span>hwnd<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"62\"></td><td><pre></pre></td></tr><tr><td data-num=\"63\"></td><td><pre>\t<span class=\"token keyword\">for</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">;</span><span class=\"token punctuation\">;</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"64\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"65\"></td><td><pre>\t\t<span class=\"token comment\">// 画窗口</span></pre></td></tr><tr><td data-num=\"66\"></td><td><pre>\t\t<span class=\"token function\">PaintWindows</span><span class=\"token punctuation\">(</span>hdc<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>wClass<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"67\"></td><td><pre></pre></td></tr><tr><td data-num=\"68\"></td><td><pre>\t\tcMessage <span class=\"token operator\">=</span> <span class=\"token function\">getchar</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"69\"></td><td><pre>\t\t<span class=\"token keyword\">switch</span><span class=\"token punctuation\">(</span>cMessage<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"70\"></td><td><pre>\t\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"71\"></td><td><pre>\t\t<span class=\"token keyword\">case</span> <span class=\"token string\">'a'</span><span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"72\"></td><td><pre>\t\t\twClass<span class=\"token punctuation\">.</span>color<span class=\"token punctuation\">.</span>r <span class=\"token operator\">+=</span> <span class=\"token number\">0x10</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"73\"></td><td><pre>\t\t\twClass<span class=\"token punctuation\">.</span>color<span class=\"token punctuation\">.</span>g <span class=\"token operator\">+=</span> <span class=\"token number\">0x10</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"74\"></td><td><pre>\t\t\twClass<span class=\"token punctuation\">.</span>color<span class=\"token punctuation\">.</span>b <span class=\"token operator\">+=</span> <span class=\"token number\">0x10</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"75\"></td><td><pre>\t\t\t<span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"76\"></td><td><pre>\t\t<span class=\"token keyword\">case</span> <span class=\"token string\">'b'</span><span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"77\"></td><td><pre>\t\t\twClass<span class=\"token punctuation\">.</span>color<span class=\"token punctuation\">.</span>r <span class=\"token operator\">-=</span> <span class=\"token number\">0x10</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"78\"></td><td><pre>\t\t\twClass<span class=\"token punctuation\">.</span>color<span class=\"token punctuation\">.</span>g <span class=\"token operator\">-=</span> <span class=\"token number\">0x10</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"79\"></td><td><pre>\t\t\twClass<span class=\"token punctuation\">.</span>color<span class=\"token punctuation\">.</span>b <span class=\"token operator\">-=</span> <span class=\"token number\">0x10</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"80\"></td><td><pre>\t\t\t<span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"81\"></td><td><pre>\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"82\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"83\"></td><td><pre></pre></td></tr><tr><td data-num=\"84\"></td><td><pre>\t<span class=\"token keyword\">return</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"85\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>运行结果：</p>\n<p><img data-src=\"image001.png\" alt=\"\" /></p>\n<p>我们发现我们画的这个傻瓜窗口：</p>\n<ol>\n<li>被其它窗口覆盖后就消失了</li>\n<li>只能接收键盘发送的消息</li>\n</ol>\n<p>那么如何使窗口能够接收所有消息呢？</p>\n<p>答案：将所有消息放入一块内存中，这块内存被称之为 “消息队列”</p>\n<h1 id=\"消息队列\"><a class=\"anchor\" href=\"#消息队列\">#</a> 消息队列</h1>\n<p>描述：本质上是一种数据结构，当对象接收到消息时，将接收到的所有消息放入消息队列中，等待对象进行处理<br />\n规则：先进先出</p>\n<p><img data-src=\"image002.png\" alt=\"\" /></p>\n<h2 id=\"消息队列在哪\"><a class=\"anchor\" href=\"#消息队列在哪\">#</a> 消息队列在哪？</h2>\n<p>我们假设把消息队列放到用户空间，那么就要有一个专用进程去把这些消息放到各个进程的消息队列中，这就涉及了跨进程通信的问题，因为是这个专用进程负责监听消息，它首先能得到这些消息，然后在分发给其他进程的消息队列，这样的话就会有大量的时间花费在跨进程通信上，Windows 并没有采用这种解决方案，Linux 采用的是这种解决方案。</p>\n<p>在 Linux 中：专用进程</p>\n<ol>\n<li>使用专用进程捕获所有消息</li>\n<li>判断消息所属进程，进行分发，将消息分配到目标进程的消息队列中</li>\n</ol>\n<p><img data-src=\"image003.png\" alt=\"\" /></p>\n<p><strong>微软的解决方案：GUI 线程</strong></p>\n<p>注意 GUI 和 GDI 的区别。</p>\n<p>&lt;1&gt; 当线程刚创建的时候，都是普通线程：<br />\n <code>Thread.ServiceTable-&gt; KeServiceDescriptorTable</code></p>\n<p>&lt;2&gt; 当线程第一次调用  <code>Win32k.sys</code>  时，会调用一个函数：  <code>PsConvertToGuiThread</code></p>\n<p>主要做几件事：<br />\na. 扩充内核栈，必须换成 64KB 的大内核栈，因为普通内核栈只有 12KB 大小。<br />\nb. 创建一个包含消息队列的结构体，并挂到 KTHREAD 上。<br />\nc.  <code>Thread.ServiceTable-&gt; KeServiceDescriptorTableShadow</code> <br />\nd. 把需要的内存数据映射到本进程空间</p>\n<p>Windows 把消息队列存到了 0 环。</p>\n<h2 id=\"如何查找消息队列\"><a class=\"anchor\" href=\"#如何查找消息队列\">#</a> 如何查找消息队列</h2>\n<p>////////<strong> 那么在内核中可以借此判断线程是窗口程序还是控制台程序呢？</strong><br />\n在  <code>KTHREAD</code>  中有一个成员  <code>+0x130 Win32Thread      : Ptr32 Void</code> ，若当前程序使用了图形界面相关的 API，这个成员就指向一个结构体 <code>THREADINFO</code> ，其成员 <code>PQ  pq;</code>  包含了当前线程的消息队列。</p>\n<p>以下是我在 XP 源码中的发现：<br />\n从此函数开始：</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>PTHREADINFO <span class=\"token function\">PtiCurrent</span><span class=\"token punctuation\">(</span>VOID<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token function\">ConnectIfNecessary</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span>PTHREADINFO<span class=\"token punctuation\">)</span><span class=\"token function\">NtCurrentTebShared</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">-></span>Win32ThreadInfo<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">typedef</span> <span class=\"token keyword\">struct</span> <span class=\"token class-name\">tagTHREADINFO</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    W32THREAD<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token comment\">//***************************************** begin: USER specific fields</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    PTL             ptl<span class=\"token punctuation\">;</span>                <span class=\"token comment\">// Listhead for thread lock list</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    PPROCESSINFO    ppi<span class=\"token punctuation\">;</span>                <span class=\"token comment\">// process info struct for this thread</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    PQ              pq<span class=\"token punctuation\">;</span>                 <span class=\"token comment\">// keyboard and mouse input queue</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>……</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>……</pre></td></tr></table></figure><p>下面是结构体 <code>Q</code>  或者说 <code>tagQ</code>  的结构：</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">/*</pre></td></tr><tr><td data-num=\"2\"></td><td><pre> * Structure definition for messages as they exist on a Q. Same as MSG</pre></td></tr><tr><td data-num=\"3\"></td><td><pre> * structure except for the link-pointer and flags at the end.</pre></td></tr><tr><td data-num=\"4\"></td><td><pre> */</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token keyword\">typedef</span> <span class=\"token keyword\">struct</span> <span class=\"token class-name\">tagQMSG</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    PQMSG           pqmsgNext<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    PQMSG           pqmsgPrev<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    MSG             msg<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    LONG_PTR        ExtraInfo<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    DWORD           dwQEvent<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    PTHREADINFO     pti<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token punctuation\">&#125;</span> QMSG<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token keyword\">typedef</span> <span class=\"token keyword\">struct</span> <span class=\"token class-name\">tagMLIST</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    PQMSG pqmsgRead<span class=\"token punctuation\">;</span>        <span class=\"token comment\">// next message to be read. This is a FIFO queue</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    PQMSG pqmsgWriteLast<span class=\"token punctuation\">;</span>   <span class=\"token comment\">// last message  added to the queue. Used mainly for coalescing</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    DWORD cMsgs<span class=\"token punctuation\">;</span>            <span class=\"token comment\">// Count of messages. Used for optimizations and to enforce a max.</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre><span class=\"token punctuation\">&#125;</span> MLIST<span class=\"token punctuation\">,</span> <span class=\"token operator\">*</span>PMLIST<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre></pre></td></tr><tr><td data-num=\"20\"></td><td><pre><span class=\"token comment\">/*</pre></td></tr><tr><td data-num=\"21\"></td><td><pre> * Message Queue structure.</pre></td></tr><tr><td data-num=\"22\"></td><td><pre> *</pre></td></tr><tr><td data-num=\"23\"></td><td><pre> * Note, if you need to add a WORD sized value,</pre></td></tr><tr><td data-num=\"24\"></td><td><pre> * do so after xbtnDblClk.</pre></td></tr><tr><td data-num=\"25\"></td><td><pre> */</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre><span class=\"token keyword\">typedef</span> <span class=\"token keyword\">struct</span> <span class=\"token class-name\">tagQ</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>    MLIST       mlInput<span class=\"token punctuation\">;</span>            <span class=\"token comment\">// raw mouse and key message list.</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>    PTHREADINFO ptiSysLock<span class=\"token punctuation\">;</span>         <span class=\"token comment\">// Thread currently allowed to process input</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>    ULONG_PTR    idSysLock<span class=\"token punctuation\">;</span>          <span class=\"token comment\">// Last message removed or to be removed before unlocking</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>    ULONG_PTR    idSysPeek<span class=\"token punctuation\">;</span>          <span class=\"token comment\">// Last message peeked</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>    PTHREADINFO ptiMouse<span class=\"token punctuation\">;</span>           <span class=\"token comment\">// Last thread to get mouse msg.</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>    PTHREADINFO ptiKeyboard<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>    PWND        spwndCapture<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>    PWND        spwndFocus<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>    PWND        spwndActive<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>    PWND        spwndActivePrev<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>    UINT        codeCapture<span class=\"token punctuation\">;</span>        <span class=\"token comment\">// type of captue. See *_CAP* defines in this file</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>    UINT        msgDblClk<span class=\"token punctuation\">;</span>          <span class=\"token comment\">// last mouse down message removed</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>    WORD        xbtnDblClk<span class=\"token punctuation\">;</span>         <span class=\"token comment\">// last xbutton down</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>    DWORD       timeDblClk<span class=\"token punctuation\">;</span>         <span class=\"token comment\">// max time for next button down to be taken as double click</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>    HWND        hwndDblClk<span class=\"token punctuation\">;</span>         <span class=\"token comment\">// window that got last button down</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>    POINT       ptDblClk<span class=\"token punctuation\">;</span>           <span class=\"token comment\">// last button down position. See SYSMET(C?DOUBLECLK)</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>    BYTE        afKeyRecentDown<span class=\"token punctuation\">[</span>CBKEYSTATERECENTDOWN<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>    BYTE        afKeyState<span class=\"token punctuation\">[</span>CBKEYSTATE<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>    CARET       caret<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>    PCURSOR     spcurCurrent<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre>    <span class=\"token keyword\">int</span>         iCursorLevel<span class=\"token punctuation\">;</span>       <span class=\"token comment\">// show/hide count. &lt; 0 if the cursor is not visible</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>    DWORD       QF_flags<span class=\"token punctuation\">;</span>            <span class=\"token comment\">// QF_ flags go here</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre></pre></td></tr><tr><td data-num=\"58\"></td><td><pre>    USHORT      cThreads<span class=\"token punctuation\">;</span>            <span class=\"token comment\">// Count of threads using this queue</span></pre></td></tr><tr><td data-num=\"59\"></td><td><pre>    USHORT      cLockCount<span class=\"token punctuation\">;</span>          <span class=\"token comment\">// Count of threads that don't want this queue freed</span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre></pre></td></tr><tr><td data-num=\"61\"></td><td><pre>    UINT        msgJournal<span class=\"token punctuation\">;</span>         <span class=\"token comment\">// See SetJournalTimer. Journal message to be delivered when timer goes off</span></pre></td></tr><tr><td data-num=\"62\"></td><td><pre>    LONG_PTR    ExtraInfo<span class=\"token punctuation\">;</span>          <span class=\"token comment\">// Extra info for last qmsg read. See GetMessageExtraInfo</span></pre></td></tr><tr><td data-num=\"63\"></td><td><pre><span class=\"token punctuation\">&#125;</span> Q<span class=\"token punctuation\">;</span></pre></td></tr></table></figure><h1 id=\"总结\"><a class=\"anchor\" href=\"#总结\">#</a> 总结</h1>\n<p>&lt;1&gt; 消息队列存储在 0 环，通过 KTHREAD.Win32Thread 可以找到</p>\n<p>&lt;2&gt; 并不是所有线程都要消息队列，只有 GUI 线程才有消息队列</p>\n<p>&lt;3&gt; 一个 GUI 线程对应 1 个消息队列</p>\n<h1 id=\"reference\"><a class=\"anchor\" href=\"#reference\">#</a> Reference</h1>\n<p>滴水课件</p>\n",
            "tags": [
                "消息队列",
                "PsConvertToGuiThread",
                "win32k.sys",
                "GUI线程"
            ]
        },
        {
            "id": "https://or0kit.github.io/Bin/Core/WindowsXp/MemoryManagement/%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86-05%E6%97%A0%E5%A4%84%E4%B8%8D%E5%9C%A8%E7%9A%84%E7%BC%BA%E9%A1%B5%E5%BC%82%E5%B8%B8/",
            "url": "https://or0kit.github.io/Bin/Core/WindowsXp/MemoryManagement/%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86-05%E6%97%A0%E5%A4%84%E4%B8%8D%E5%9C%A8%E7%9A%84%E7%BC%BA%E9%A1%B5%E5%BC%82%E5%B8%B8/",
            "title": "内存管理-05无处不在的缺页异常",
            "date_published": "2022-04-16T07:17:03.000Z",
            "content_html": "<h1 id=\"缺页异常的由来\"><a class=\"anchor\" href=\"#缺页异常的由来\">#</a> 缺页异常的由来</h1>\n<p>先来复习一下 PTE：</p>\n<p><img data-src=\"image001.png\" alt=\"\" /></p>\n<p>P 位  代表当前页面是否有效。</p>\n<p>当 CPU 访问一个地址，其 PTE 的 P 位为 0，此时会产生缺页异常；</p>\n<p>在 windows 中，缺页异常是时刻在发生的。</p>\n<p>Windows 利用缺页异常机制让我们更加有效的访问内存。</p>\n<p>海哥原话：当我们的物理内存大小只有 2MB 时，当我们需要用到某个物理页的时候，将对应物理页的 P 位置 1，当我们不再需要使用该物理页时，再将其 P 位置 0，这样的内存使用效率是非常低的。</p>\n<p>因此 windows 不是这样设计的 —— 只有正在使用的线性地址，才会被挂上物理页，当物理页在一段时间内不被使用或不够用的情况下，操作系统会将当前物理页中的数据拷贝至硬盘中，然后将当前物理页供给 “别人” 使用，当需要再次用到该物理页的数据时，则将 “别人” 的数据再拷贝出来，将 “自己 &quot; 的数据从硬盘中拷回，被拷至硬盘中的物理页数据会被写入到一个文件中，也就是我们平时常说的<strong>虚拟内存</strong></p>\n<p>也就是 C 盘中的  <code>pagefile.sys</code>  文件。</p>\n<p>当物理页占用情况较为紧张时，这个文件用于存放物理页的临时数据作为备份。</p>\n<h1 id=\"virtualalloc-函数\"><a class=\"anchor\" href=\"#virtualalloc-函数\">#</a> VirtualAlloc 函数</h1>\n<p>保留与提交的误区</p>\n<p>还是这个函数，前面我们已经验证过了。</p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>LPVOID VirtualAlloc<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>\tLPVOID lpAddress<span class=\"token punctuation\">,</span> \t<span class=\"token comment\">// 要分配的内存区域的地址</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>\tDWORD dwSize<span class=\"token punctuation\">,</span> \t\t<span class=\"token comment\">// 分配的大小</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>\tDWORD flAllocationType<span class=\"token punctuation\">,</span> \t<span class=\"token comment\">// 类型：MEM_RESERVE MEM_COMMIT</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>\tDWORD flProtect \t<span class=\"token comment\">// 该内存的初始保护属性</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>MEM_RESERVE：保留线性地址</p>\n<p>MEM_COMMIT：可以有物理页，但不是立即有或者一直有</p>\n<h1 id=\"无处不在的缺页\"><a class=\"anchor\" href=\"#无处不在的缺页\">#</a> 无处不在的缺页</h1>\n<p><img data-src=\"image002.png\" alt=\"\" /></p>\n<ol>\n<li>当物理页被放入页面文件时，PTE 结构如图 a 所示</li>\n<li>当该进程再次读取该物理页对应的线性地址时，由于 P 位为 0，因此会触发缺页异常处理程序</li>\n<li>在 windows xp 中，缺页异常处理程序位于 IDT [0xE]</li>\n<li>此时，缺页异常处理程序会再次查询当前 PTE 的属性，若 1-4 位，5-9 位，12-31 位都有值，说明当前 PTE 是有效的，但是物理页被存放到了页面文件中</li>\n<li>然后，缺页异常处理程序根据 PTE 中得到的值去查询 pagefile.sys，将原来的物理页的内容挂入新的物理页，然后将 P 位置 1，再将新的物理页的物理地址挂入 PTE 的第 12-31 位</li>\n<li>在用户看来，两次读取同一个线性地址，中间这一系列复杂过程是透明的，而只能观察到两次都成功读取了同一个值</li>\n</ol>\n<h1 id=\"execute_writecopy写拷贝\"><a class=\"anchor\" href=\"#execute_writecopy写拷贝\">#</a> EXECUTE_WRITECOPY（写拷贝）</h1>\n<p>描述：当程序正常加载一个 EXE 或者 DLL 时，其 VadRoot 中的内存属性为 Mapped EXE，权限为 EXECUTE_WRITECOPY，当试图对其某一内容进行修改时，无法对其它进程中的同一个模块产生影响</p>\n<p>原理：</p>\n<p>当试图对其某一内容进行修改时，系统会检查其线性地址对应的物理页的 PTE 属性，若 R/W 属性为 0 时，触发缺页异常<br />\n缺页异常处理程序检查 VadRoot 中对应线性地址所在空间的 MMVAD_FLAGS 中的 Protection 成员，若值位 0x111 时，表示权限为 EXECUTE_WRITECOPY<br />\n 此时，缺页异常处理程序将当前线性地址对应的物理页内容进行拷贝，将其写入一个新的物理页，然后将当前进程需要修改的线性地址挂入新的物理页上，然后对需要修改的内容进行写入</p>\n<p>解决方法：可通过编写驱动程序先将需要修改的线性地址对应的物理页的 PTE 的 R/W 位置为 1，再对需要修改的地方进行修改。</p>\n<p>以前写过过写拷贝全局监控函数的。</p>\n<h1 id=\"reference\"><a class=\"anchor\" href=\"#reference\">#</a> Reference</h1>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQxOTg4NDQ4L2FydGljbGUvZGV0YWlscy8xMTI2NDczODg=\">https://blog.csdn.net/qq_41988448/article/details/112647388</span></p>\n",
            "tags": [
                "缺页异常"
            ]
        },
        {
            "id": "https://or0kit.github.io/Bin/Core/WindowsXp/MemoryManagement/%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86-04%E7%89%A9%E7%90%86%E5%86%85%E5%AD%98%E7%9A%84%E7%AE%A1%E7%90%86/",
            "url": "https://or0kit.github.io/Bin/Core/WindowsXp/MemoryManagement/%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86-04%E7%89%A9%E7%90%86%E5%86%85%E5%AD%98%E7%9A%84%E7%AE%A1%E7%90%86/",
            "title": "内存管理-04物理内存的管理",
            "date_published": "2022-04-16T07:17:01.000Z",
            "content_html": "<h1 id=\"物理内存\"><a class=\"anchor\" href=\"#物理内存\">#</a> 物理内存</h1>\n<p>&lt;1&gt; 最大物理内存</p>\n<pre><code>10-10-12分页  最多识别物理内存为4GB\n\n2-9-9-12分页  最多识别物理内存为64GB\n</code></pre>\n<p>&lt;2&gt; 操作系统限制</p>\n<p>为什么在 xp 中，明明是 2-9-9-12 分页，单仍然无法超越 4GB 呢？</p>\n<p>具体可以分析  <code>MmAddPhysicalMemoryEx</code>  函数。存粹是操作系统限制。</p>\n<p>&lt;3&gt; 实际物理内存</p>\n<p><code>MmNumberOfPhysicalPages</code>  * 4 = 物理内存  (页为单位)</p>\n<h1 id=\"物理内存如何管理\"><a class=\"anchor\" href=\"#物理内存如何管理\">#</a> 物理内存如何管理</h1>\n<p>在 XP 上一个物理页的大小是 4096 BYTE = 0x1000 BYTE = 4 KB  = 4 * 1024B</p>\n<p>查看 XP 上的物理页：</p>\n<p><img data-src=\"image001.png\" alt=\"\" /></p>\n<p>对于物理内存，操作系统采用帧管理数据库的模式。<br />\n一个物理页就是一帧，被称之为帧数据库：</p>\n<p>其实就是数组，数组的指针： <code>_MMPFN* MmPfnDatabase</code>  而数组的长度是：  <code>MmNumberOfPhysicalPages</code></p>\n<p>而数组成员都是  <code>_MMPFN</code>  结构</p>\n<p>在 windbg 中查看：</p>\n<figure class=\"highlight raw\"><figcaption data-lang=\"\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>kd&gt; dt _MMPFN</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>nt!_MMPFN</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>   +0x000 u1               : __unnamed</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>   +0x004 PteAddress       : Ptr32 _MMPTE</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>   +0x008 u2               : __unnamed</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>   +0x00c u3               : __unnamed</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>   +0x010 OriginalPte      : _MMPTE</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>   +0x018 u4               : __unnamed</pre></td></tr></table></figure><p>在 xp 源码中查看：</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">typedef</span> <span class=\"token keyword\">struct</span> <span class=\"token class-name\">_MMPFN</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token keyword\">union</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>        PFN_NUMBER Flink<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>        WSLE_NUMBER WsIndex<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>        PKEVENT Event<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>        NTSTATUS ReadStatus<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>        SINGLE_LIST_ENTRY NextStackPfn<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span> u1<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    PMMPTE PteAddress<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    <span class=\"token keyword\">union</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>        PFN_NUMBER Blink<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>        ULONG_PTR ShareCount<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span> u2<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    <span class=\"token keyword\">union</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>        MMPFNENTRY e1<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>        <span class=\"token keyword\">struct</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>            USHORT ShortFlags<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>            USHORT ReferenceCount<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span> e2<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span> u3<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">if</span> <span class=\"token expression\"><span class=\"token function\">defined</span> <span class=\"token punctuation\">(</span>_WIN64<span class=\"token punctuation\">)</span></span></span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>    ULONG UsedPageTableEntries<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">endif</span></span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>    MMPTE OriginalPte<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>    <span class=\"token keyword\">union</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>        ULONG_PTR EntireFrame<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>        <span class=\"token keyword\">struct</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">if</span> <span class=\"token expression\"><span class=\"token function\">defined</span> <span class=\"token punctuation\">(</span>_WIN64<span class=\"token punctuation\">)</span></span></span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>            ULONG_PTR PteFrame<span class=\"token operator\">:</span> <span class=\"token number\">58</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">else</span></span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>            ULONG_PTR PteFrame<span class=\"token operator\">:</span> <span class=\"token number\">26</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">endif</span></span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>            ULONG_PTR InPageError <span class=\"token operator\">:</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>            ULONG_PTR VerifierAllocation <span class=\"token operator\">:</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>            ULONG_PTR AweAllocation <span class=\"token operator\">:</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>            ULONG_PTR LockCharged <span class=\"token operator\">:</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span>      <span class=\"token comment\">// maintained for DBG only</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>            ULONG_PTR KernelStack <span class=\"token operator\">:</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span>      <span class=\"token comment\">// only for valid (not trans) pages</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>            ULONG_PTR Reserved <span class=\"token operator\">:</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span> u4<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre></pre></td></tr><tr><td data-num=\"42\"></td><td><pre><span class=\"token punctuation\">&#125;</span> MMPFN<span class=\"token punctuation\">,</span> <span class=\"token operator\">*</span>PMMPFN<span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>可以发现这个结构体  <code>_MMPFN</code>  的大小是 0x1C。</p>\n<p>在 XP 中查看帧结构数组的基址：</p>\n<figure class=\"highlight raw\"><figcaption data-lang=\"\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>kd&gt; dd MmPfnDatabase l1</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>805630c8  80e00000</pre></td></tr></table></figure><p><code>80e00000+0x1C</code>  就是第二个物理页的帧结构数组，那么我们如何知道这个数组对应的物理页呢？</p>\n<p>这里操作系统的设计非常巧妙，帧结构数组的索引对应着相应的物理页，如果索引为  <code>0</code>  则对应的物理页地址为  <code>0 * 4kB</code>  ；如果索引为  <code>1</code>  则对应的物理页地址为  <code>1 * 4kB</code>  。</p>\n<h2 id=\"总结\"><a class=\"anchor\" href=\"#总结\">#</a> 总结：</h2>\n<p>物理页的数量是由  <code>MmNumberOfPhysicalPages</code>  决定的<br />\n物理页如何管理：每一个物理页都对应一个  <code>MMPFN</code>  的结构<br />\n如何通过帧数组找物理页和如何通过物理页找帧数组都已经知道了。</p>\n<h1 id=\"物理页的状态\"><a class=\"anchor\" href=\"#物理页的状态\">#</a> 物理页的状态</h1>\n<p>物理页有着不同的状态，正在被使用的和没有被使用的，又分为好多状态。</p>\n<p><code>_MMPFN</code>  结构体成员  <code>u3</code>  ：</p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">union</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    MMPFNENTRY e1<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token keyword\">struct</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>        USHORT ShortFlags<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>        USHORT ReferenceCount<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span> e2<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token punctuation\">&#125;</span> u3<span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>我们查看其成员  <code>e1</code>  的结构：</p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">typedef</span> <span class=\"token keyword\">struct</span> <span class=\"token class-name\">_MMPFNENTRY</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    ULONG Modified <span class=\"token operator\">:</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    ULONG ReadInProgress <span class=\"token operator\">:</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    ULONG WriteInProgress <span class=\"token operator\">:</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    ULONG PrototypePte<span class=\"token operator\">:</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    ULONG PageColor <span class=\"token operator\">:</span> <span class=\"token number\">3</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    ULONG ParityError <span class=\"token operator\">:</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    ULONG PageLocation <span class=\"token operator\">:</span> <span class=\"token number\">3</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    ULONG RemovalRequested <span class=\"token operator\">:</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    ULONG CacheAttribute <span class=\"token operator\">:</span> <span class=\"token number\">2</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    ULONG Rom <span class=\"token operator\">:</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    ULONG LockCharged <span class=\"token operator\">:</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    ULONG DontUse <span class=\"token operator\">:</span> <span class=\"token number\">16</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">//overlays USHORT for reference count field.</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token punctuation\">&#125;</span> MMPFNENTRY<span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>其中的  <code>ULONG PageLocation : 3;</code>  成员就决定了当前物理页处于什么状态。</p>\n<p>以下是没有被使用的几种状态：</p>\n<figure class=\"highlight raw\"><figcaption data-lang=\"\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>0：MmZeroedPageListHead</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>1：MmFreePageListHead</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>2：MmStandbyPageListHead</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>3：MmModifiedPageListHead</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>4：MmModifiedNoWritePageListHead</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>5：MmBadPageListHead</pre></td></tr></table></figure><h2 id=\"操作系统的6个链表\"><a class=\"anchor\" href=\"#操作系统的6个链表\">#</a> 操作系统的 6 个链表</h2>\n<p>&lt;1&gt; MmBadPageListHead<br />\n 坏链</p>\n<p>&lt;2&gt; MmZeroedPageListHead<br />\n 零化链表（是系统在空闲的时候进行零化的，不是程序自己清零的那种）</p>\n<p>&lt;3&gt; MmFreePageListHead<br />\n 空闲链表（物理页是周转使用的，刚被释放的物理页是没有清 0，系统空闲的时候有专门的线程从这个队列摘取物理页，加以清 0 后再挂入 MmZeroedPageListHead）</p>\n<p>&lt;4&gt; MmStandbyPageListHead<br />\n 备用链表（当系统内存不够的时候，操作系统会把物理内存中的数据交换到硬盘上，此时页面不是直接挂到空闲链表上去，而是挂到备用链表上，虽然我释放了，但里边的内容还是有意义的）</p>\n<p>&lt;5&gt; MmModifiedPageListHead</p>\n<p>&lt;6&gt; MmModifiedNoWritePageListHead</p>\n<p>具体可以参考 《Windows 内核原理与实现》</p>\n<p>我们看一下这些链表的结构：</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">typedef</span> <span class=\"token keyword\">struct</span> <span class=\"token class-name\">_MMPFNLIST</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    PFN_NUMBER Total<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    MMLISTS ListName<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    PFN_NUMBER Flink<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    PFN_NUMBER Blink<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">&#125;</span> MMPFNLIST<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>MMPFNLIST MmZeroedPageListHead <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>                    <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// Total</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>                    ZeroedPageList<span class=\"token punctuation\">,</span> <span class=\"token comment\">// ListName</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>                    MM_EMPTY_LIST<span class=\"token punctuation\">,</span> <span class=\"token comment\">//Flink</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>                    MM_EMPTY_LIST  <span class=\"token comment\">// Blink</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>                    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>MMPFNLIST MmFreePageListHead <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>                    <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// Total</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>                    FreePageList<span class=\"token punctuation\">,</span> <span class=\"token comment\">// ListName</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>                    MM_EMPTY_LIST<span class=\"token punctuation\">,</span> <span class=\"token comment\">//Flink</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>                    MM_EMPTY_LIST  <span class=\"token comment\">// Blink</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>                    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>MMPFNLIST MmStandbyPageListHead <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>                    <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// Total</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>                    StandbyPageList<span class=\"token punctuation\">,</span> <span class=\"token comment\">// ListName</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>                    MM_EMPTY_LIST<span class=\"token punctuation\">,</span> <span class=\"token comment\">//Flink</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>                    MM_EMPTY_LIST  <span class=\"token comment\">// Blink</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>                    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>MMPFNLIST MmModifiedPageListHead <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>                    <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// Total</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>                    ModifiedPageList<span class=\"token punctuation\">,</span> <span class=\"token comment\">// ListName</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>                    MM_EMPTY_LIST<span class=\"token punctuation\">,</span> <span class=\"token comment\">//Flink</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>                    MM_EMPTY_LIST  <span class=\"token comment\">// Blink</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>                    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>MMPFNLIST MmModifiedNoWritePageListHead <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>                    <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// Total</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>                    ModifiedNoWritePageList<span class=\"token punctuation\">,</span> <span class=\"token comment\">// ListName</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>                    MM_EMPTY_LIST<span class=\"token punctuation\">,</span> <span class=\"token comment\">//Flink</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>                    MM_EMPTY_LIST  <span class=\"token comment\">// Blink</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>                    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>MMPFNLIST MmBadPageListHead <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>                    <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// Total</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>                    BadPageList<span class=\"token punctuation\">,</span> <span class=\"token comment\">// ListName</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>                    MM_EMPTY_LIST<span class=\"token punctuation\">,</span> <span class=\"token comment\">//Flink</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>                    MM_EMPTY_LIST  <span class=\"token comment\">// Blink</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>                    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre></pre></td></tr><tr><td data-num=\"51\"></td><td><pre><span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre><span class=\"token comment\">// Note the ROM page listhead is deliberately not in the set</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre><span class=\"token comment\">// of MmPageLocationList ranges.</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre><span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>MMPFNLIST MmRomPageListHead <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre>                    <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// Total</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre>                    StandbyPageList<span class=\"token punctuation\">,</span> <span class=\"token comment\">// ListName</span></pre></td></tr><tr><td data-num=\"59\"></td><td><pre>                    MM_EMPTY_LIST<span class=\"token punctuation\">,</span> <span class=\"token comment\">//Flink</span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre>                    MM_EMPTY_LIST  <span class=\"token comment\">// Blink</span></pre></td></tr><tr><td data-num=\"61\"></td><td><pre>                    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"62\"></td><td><pre></pre></td></tr><tr><td data-num=\"63\"></td><td><pre></pre></td></tr><tr><td data-num=\"64\"></td><td><pre>PMMPFNLIST MmPageLocationList<span class=\"token punctuation\">[</span>NUMBER_OF_PAGE_LISTS<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"65\"></td><td><pre>                                      <span class=\"token operator\">&amp;</span>MmZeroedPageListHead<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"66\"></td><td><pre>                                      <span class=\"token operator\">&amp;</span>MmFreePageListHead<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"67\"></td><td><pre>                                      <span class=\"token operator\">&amp;</span>MmStandbyPageListHead<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"68\"></td><td><pre>                                      <span class=\"token operator\">&amp;</span>MmModifiedPageListHead<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"69\"></td><td><pre>                                      <span class=\"token operator\">&amp;</span>MmModifiedNoWritePageListHead<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"70\"></td><td><pre>                                      <span class=\"token operator\">&amp;</span>MmBadPageListHead<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"71\"></td><td><pre>                                      <span class=\"token constant\">NULL</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"72\"></td><td><pre>                                      <span class=\"token constant\">NULL</span> <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>那我们该如何把这些串起来呢？<br />\n先来看一张表：</p>\n<p><img data-src=\"image002.png\" alt=\"\" /></p>\n<p>理解这六个链表是如何和 MMPFN 结构串起来的。</p>\n<p>在 Windbg 中查看一下  <code>MmZeroedPageListHead</code>  链表：</p>\n<figure class=\"highlight raw\"><figcaption data-lang=\"\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>kd&gt; dd MmZeroedPageListHead l4</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>805528e8  0008ed15 00000000 0005a628 00039e07</pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>kd&gt; dt _MMPFNLIST 805528e8</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>nt!_MMPFNLIST</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>   +0x000 Total            : 0x8ed15</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>   +0x004 ListName         : 0 ( ZeroedPageList )</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>   +0x008 Flink            : 0x5a628</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>   +0x00c Blink            : 0x39e07</pre></td></tr></table></figure><figure class=\"highlight raw\"><figcaption data-lang=\"\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>kd&gt; dd 80e00000 + 0x5a628*0x1C</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>817e2c60  000363b8 c058a679 ffffffff 00003000</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>kd&gt; dd 80e00000 + 000363b8*0x1C</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>813ee820  000902a8 c0006d01 0005a628 00003000</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>kd&gt; dd 80e00000 + 000902a8*0x1C</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>81dc4a60  0007fdb8 c0710af1 000363b8 00003000</pre></td></tr></table></figure><h2 id=\"正在使用中的内存\"><a class=\"anchor\" href=\"#正在使用中的内存\">#</a> 正在使用中的内存</h2>\n<p>查看一个进程所占用的所有物理页：</p>\n<p>这里以  <code>DbgView</code>  为例:</p>\n<p>在 Windbg 中查看 <code>DbgView</code>  的  <code>EPROCESS</code>  结构体：</p>\n<figure class=\"highlight raw\"><figcaption data-lang=\"\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>kd&gt; dt _EPROCESS 89e21830</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>nt!_EPROCESS</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  ……</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  ……</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  +0x1f8 Vm               : _MMSUPPORT</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  ……</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  ……</pre></td></tr></table></figure><figure class=\"highlight raw\"><figcaption data-lang=\"\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>kd&gt; dt _MMSUPPORT 89e21830+0x1f8</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>nt!_MMSUPPORT</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>   +0x000 LastTrimTime     : _LARGE_INTEGER 0x01d86059&#96;8f011bc0</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>   +0x008 Flags            : _MMSUPPORT_FLAGS</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>   +0x00c PageFaultCount   : 0x41b</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>   +0x010 PeakWorkingSetSize : 0x3da</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>   +0x014 WorkingSetSize   : 0x3d5</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>   +0x018 MinimumWorkingSetSize : 0x32</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>   +0x01c MaximumWorkingSetSize : 0x159</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>   +0x020 VmWorkingSetList : 0xc0883000 _MMWSL</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>   +0x024 WorkingSetExpansionLinks : _LIST_ENTRY [ 0x8a063dd4 - 0x89d34ee4 ]</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>   +0x02c Claim            : 0</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>   +0x030 NextEstimationSlot : 0</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>   +0x034 NextAgingSlot    : 0</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>   +0x038 EstimatedAvailable : 0</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>   +0x03c GrowthSinceLastEstimate : 0x41b</pre></td></tr></table></figure>",
            "tags": [
                "物理内存",
                "MmAddPhysicalMemoryEx"
            ]
        },
        {
            "id": "https://or0kit.github.io/Bin/Core/WindowsXp/MemoryManagement/%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86-03Mapped%20Memory/",
            "url": "https://or0kit.github.io/Bin/Core/WindowsXp/MemoryManagement/%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86-03Mapped%20Memory/",
            "title": "内存管理-03Mapped Memory",
            "date_published": "2022-04-15T07:16:58.000Z",
            "content_html": "<h1 id=\"mapped-memory\"><a class=\"anchor\" href=\"#mapped-memory\">#</a> Mapped Memory</h1>\n<p>前面了解了私有内存，接下来认识一下映射内存，这种内存的好处是可以跟其他进程共享物理页。</p>\n<p>在前面的用 <code>!vad</code>  查看内存结构中，可以发现后面有文件路径的就是映射内存。</p>\n<p>可以共享一个物理页，也可以共享一份文件。</p>\n<h2 id=\"实验演示\"><a class=\"anchor\" href=\"#实验演示\">#</a> 实验演示</h2>\n<h3 id=\"共享物理页\"><a class=\"anchor\" href=\"#共享物理页\">#</a> 共享物理页</h3>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span><span class=\"token string\">&lt;stdio.h></span></span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span><span class=\"token string\">&lt;Windows.h></span></span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">BUFSIZ</span> <span class=\"token expression\"><span class=\"token number\">0x200</span></span></span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">MapFileName</span> <span class=\"token string\">\"SharedMemory\"</span></span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token keyword\">int</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> argc<span class=\"token punctuation\">,</span> <span class=\"token keyword\">char</span><span class=\"token operator\">*</span> argv<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\t<span class=\"token comment\">// 内核对象：1、物理页  2、文件</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\tHANDLE g_hMapFile <span class=\"token operator\">=</span> <span class=\"token function\">CreateFileMapping</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>\t\tINVALID_HANDLE_VALUE<span class=\"token punctuation\">,</span><span class=\"token constant\">NULL</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>\t\tPAGE_READWRITE<span class=\"token punctuation\">,</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span>BUFSIZ<span class=\"token punctuation\">,</span>MapFileName<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>\t<span class=\"token comment\">// 将物理页与线性地址进行映射</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>\tLPTSTR g_lpBuff <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>LPTSTR<span class=\"token punctuation\">)</span><span class=\"token function\">MapViewOfFile</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>\t\tg_hMapFile<span class=\"token punctuation\">,</span>FILE_MAP_ALL_ACCESS<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>\t\t<span class=\"token number\">0</span><span class=\"token punctuation\">,</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span>BUFSIZ<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>\t<span class=\"token operator\">*</span><span class=\"token punctuation\">(</span>PDWORD<span class=\"token punctuation\">)</span>g_lpBuff <span class=\"token operator\">=</span> <span class=\"token number\">0x12345678</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>\t<span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"A进程写入地址：%p，内容：%x\\t\\n\"</span><span class=\"token punctuation\">,</span>g_lpBuff<span class=\"token punctuation\">,</span><span class=\"token punctuation\">(</span><span class=\"token operator\">*</span><span class=\"token punctuation\">(</span>PDWORD<span class=\"token punctuation\">)</span>g_lpBuff<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>\t<span class=\"token function\">getchar</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>\t<span class=\"token keyword\">return</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p><img data-src=\"image001.png\" alt=\"\" /></p>\n<p>接下来我们观察内存结构</p>\n<figure class=\"highlight raw\"><figcaption data-lang=\"\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>kd&gt; !vad 0x8a098e90</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>VAD   Level     Start       End Commit</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>……</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>……</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>89acf150  8       3a0       3a0      0 Mapped       READWRITE          Pagefile section, shared commit 0x1</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>……</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>……</pre></td></tr></table></figure><p>可以看到是一个页的大小。所以映射内存也是以页为单位的。</p>\n<p>接下来在 B 进程中读取一下共享内存</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span><span class=\"token string\">&lt;stdio.h></span></span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span><span class=\"token string\">&lt;Windows.h></span></span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">BUFSIZ</span> <span class=\"token expression\"><span class=\"token number\">0x200</span></span></span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">MapFileName</span> <span class=\"token string\">\"SharedMemory\"</span></span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token keyword\">int</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> argc<span class=\"token punctuation\">,</span> <span class=\"token keyword\">char</span><span class=\"token operator\">*</span> argv<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\t<span class=\"token comment\">// 内核对象：1、物理页  2、文件</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\tHANDLE g_hMapFile <span class=\"token operator\">=</span> <span class=\"token function\">OpenFileMapping</span><span class=\"token punctuation\">(</span>FILE_MAP_ALL_ACCESS<span class=\"token punctuation\">,</span>FALSE<span class=\"token punctuation\">,</span>MapFileName<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>\t<span class=\"token comment\">// 将物理页与线性地址进行映射</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>\tLPTSTR g_lpBuff <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>LPTSTR<span class=\"token punctuation\">)</span><span class=\"token function\">MapViewOfFile</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>\t\tg_hMapFile<span class=\"token punctuation\">,</span>FILE_MAP_ALL_ACCESS<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>\t\t<span class=\"token number\">0</span><span class=\"token punctuation\">,</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span>BUFSIZ<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>\t<span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"B进程读地址：%p，内容：%x\\t\\n\"</span><span class=\"token punctuation\">,</span>g_lpBuff<span class=\"token punctuation\">,</span><span class=\"token punctuation\">(</span><span class=\"token operator\">*</span><span class=\"token punctuation\">(</span>PDWORD<span class=\"token punctuation\">)</span>g_lpBuff<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>\t<span class=\"token function\">getchar</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>\t<span class=\"token keyword\">return</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p><img data-src=\"image002.png\" alt=\"\" /></p>\n<p>查看 B 进程的内存结构：</p>\n<figure class=\"highlight raw\"><figcaption data-lang=\"\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>kd&gt; !vad 0x8a05b8b8</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>VAD   Level     Start       End Commit</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>……</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>……</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>8a0ff3b0  8       3a0       3a0      0 Mapped       READWRITE          Pagefile section, shared commit 0x1</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>……</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>……</pre></td></tr></table></figure><p>可以看到也是一个页的大小。</p>\n<h3 id=\"共享文件\"><a class=\"anchor\" href=\"#共享文件\">#</a> 共享文件</h3>\n<p>文件映射进内存</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span><span class=\"token string\">&lt;stdio.h></span></span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span><span class=\"token string\">&lt;Windows.h></span></span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">MapFileName</span> <span class=\"token string\">\"SharedMemory\"</span></span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token keyword\">int</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> argc<span class=\"token punctuation\">,</span> <span class=\"token keyword\">char</span><span class=\"token operator\">*</span> argv<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>\tHANDLE g_hFile <span class=\"token operator\">=</span> <span class=\"token function\">CreateFile</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\t\t<span class=\"token string\">\"C:\\\\Hello.exe\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\t\tGENERIC_READ<span class=\"token operator\">|</span>GENERIC_WRITE<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>\t\tFILE_SHARE_READ<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>\t\t<span class=\"token constant\">NULL</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>\t\tOPEN_ALWAYS<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>\t\tFILE_ATTRIBUTE_NORMAL<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>\t\t<span class=\"token constant\">NULL</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>\tHANDLE g_hMapFile <span class=\"token operator\">=</span> <span class=\"token function\">CreateFileMapping</span><span class=\"token punctuation\">(</span>g_hFile<span class=\"token punctuation\">,</span><span class=\"token constant\">NULL</span><span class=\"token punctuation\">,</span>PAGE_READWRITE<span class=\"token punctuation\">,</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span> BUFSIZ<span class=\"token punctuation\">,</span><span class=\"token constant\">NULL</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>\t<span class=\"token keyword\">void</span><span class=\"token operator\">*</span> g_lpBuff <span class=\"token operator\">=</span> <span class=\"token function\">MapViewOfFile</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>\t\tg_hMapFile<span class=\"token punctuation\">,</span>FILE_MAP_ALL_ACCESS<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>\t\t<span class=\"token number\">0</span><span class=\"token punctuation\">,</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span>BUFSIZ<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>\t<span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"共享内存地址：%p\\t\\n\"</span><span class=\"token punctuation\">,</span>g_lpBuff<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>\t<span class=\"token function\">getchar</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>\t<span class=\"token keyword\">return</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p><img data-src=\"image003.png\" alt=\"\" /></p>\n<p>观察内存结构:</p>\n<figure class=\"highlight raw\"><figcaption data-lang=\"\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>kd&gt; !vad 0x8a0a6b00</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>VAD   Level     Start       End Commit</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>……</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>……</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>89ad82d8  8       3a0       3a0      0 Mapped       READWRITE          \\Hello.exe</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>……</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>89ac3e88  3     7c800     7c91d      6 Mapped  Exe  EXECUTE_WRITECOPY  \\WINDOWS\\system32\\kernel32.dll</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>89e0fbc0  2     7c920     7c9b2      5 Mapped  Exe  EXECUTE_WRITECOPY  \\WINDOWS\\system32\\ntdll.dll</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>……</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>……</pre></td></tr></table></figure><p>可以看到在我们映射的  <code>Hello.exe</code>  文件。这种共享文件特别适合那种大的文件。</p>\n<p>** 细心的人可能发现了。** 我们的文件是  <code>READWRITE</code>  而有的是  <code>EXECUTE_WRITECOPY</code> ?</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span><span class=\"token string\">&lt;stdio.h></span></span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span><span class=\"token string\">&lt;Windows.h></span></span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">int</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> argc<span class=\"token punctuation\">,</span> <span class=\"token keyword\">char</span><span class=\"token operator\">*</span> argv<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>\t<span class=\"token function\">LoadLibrary</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"C:\\\\Hello.exe\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>\t<span class=\"token function\">system</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"pause\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>\t<span class=\"token keyword\">return</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>观察内存结构:</p>\n<figure class=\"highlight raw\"><figcaption data-lang=\"\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>kd&gt; !vad 0x89ad1e98</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>VAD   Level     Start       End Commit</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>……</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>……</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>89ac98d0  8       3a0       3aa      4 Mapped  Exe  EXECUTE_WRITECOPY  \\Hello.exe</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>……</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>……</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>89d0ec98  8     77fc0     77fd0      2 Mapped  Exe  EXECUTE_WRITECOPY  \\WINDOWS\\system32\\secur32.dll</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>89ad18c8  3     7c800     7c91d      6 Mapped  Exe  EXECUTE_WRITECOPY  \\WINDOWS\\system32\\kernel32.dll</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>8a15c988  2     7c920     7c9b2      5 Mapped  Exe  EXECUTE_WRITECOPY  \\WINDOWS\\system32\\ntdll.dll</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>……</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>……</pre></td></tr></table></figure><p>通过这些我们应该明白了什么是  <code>LoadLibrary</code>  。跟映射文件唯一的区别就是属性， <code>LoadLibrary</code>  的属性只有一种就是  <code>EXECUTE_WRITECOPY</code> 。</p>\n<p>当了解这些后我们对内存就会了如指掌，如果想模块隐藏只能申请一块私有内存然后在里面填写数据，拉伸、抹去 PE 指纹，这样想要检测就很难了。</p>\n",
            "tags": [
                "共享物理页",
                "共享文件",
                "LoadLibrary的本质"
            ]
        },
        {
            "id": "https://or0kit.github.io/Bin/Core/WindowsXp/MemoryManagement/%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86-02Private%20Memory/",
            "url": "https://or0kit.github.io/Bin/Core/WindowsXp/MemoryManagement/%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86-02Private%20Memory/",
            "title": "内存管理-02Private Memory",
            "date_published": "2022-04-15T07:16:55.000Z",
            "content_html": "<h1 id=\"申请内存的两种方式\"><a class=\"anchor\" href=\"#申请内存的两种方式\">#</a> 申请内存的两种方式</h1>\n<p>&lt;1&gt; 通过  <code>VirtualAlloc</code>  /  <code>VirtualAllocEx</code>  申请的：Private Memory</p>\n<p>&lt;2&gt; 通过  <code>CreateFileMapping</code>  映射的：Mapped Memory</p>\n<h2 id=\"验证内存种类\"><a class=\"anchor\" href=\"#验证内存种类\">#</a> 验证内存种类</h2>\n<p>接下来写代码去验证上面的两种内存种类。</p>\n<p>在复习一下  <code>VirtualAlloc</code>  函数：</p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>LPVOID VirtualAlloc<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>\tLPVOID lpAddress<span class=\"token punctuation\">,</span> \t<span class=\"token comment\">// 要分配的内存区域的地址</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>\tDWORD dwSize<span class=\"token punctuation\">,</span> \t\t<span class=\"token comment\">// 分配的大小</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>\tDWORD flAllocationType<span class=\"token punctuation\">,</span> \t<span class=\"token comment\">// 分配的类型</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>\tDWORD flProtect \t<span class=\"token comment\">// 该内存的初始保护属性</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>参数介绍：</p>\n<p>申请内存的地址。可以指定地址，但是物理页我们不知道哪里的地址是否可用，所以一般为 NULL 。<br />\n申请内存的大小。一般以页的整数倍进行申请，如：两页 0x1000*2 。<br />\n申请内存的类型。<br />\n常用的有两种类型：<br />\n <code>MEM_RESERVE</code>  : 先申请线性内存，但不占用物理内存<br />\n <code>MEM_COMMIT</code>  : 占用线性内存和物理内存。<strong>一会就打破这个认知！</strong><br />\n内存的状态。可读、可写、可执行。</p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span><span class=\"token string\">&lt;stdio.h></span></span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span><span class=\"token string\">&lt;Windows.h></span></span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">int</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> argc<span class=\"token punctuation\">,</span> <span class=\"token keyword\">char</span><span class=\"token operator\">*</span> argv<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>\t<span class=\"token keyword\">void</span><span class=\"token operator\">*</span> p<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>\t<span class=\"token function\">system</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"pause\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>\tp <span class=\"token operator\">=</span> <span class=\"token function\">VirtualAlloc</span><span class=\"token punctuation\">(</span><span class=\"token constant\">NULL</span><span class=\"token punctuation\">,</span><span class=\"token number\">0x1000</span><span class=\"token punctuation\">,</span>MEM_COMMIT<span class=\"token punctuation\">,</span>PAGE_READWRITE<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>\t<span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"p:%p\\t\\n\"</span><span class=\"token punctuation\">,</span>p<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\t<span class=\"token function\">system</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"pause\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  <span class=\"token function\">VirtualFree</span><span class=\"token punctuation\">(</span>p<span class=\"token punctuation\">,</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span>MEM_FREE<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>\t<span class=\"token keyword\">return</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>先运行，不申请内存，查看此进程的内存结构：</p>\n<p><img data-src=\"image001.png\" alt=\"\" /></p>\n<p>申请后：</p>\n<p><img data-src=\"image002.png\" alt=\"\" /></p>\n<h2 id=\"验证-mem_reserve-与-mem_commit\"><a class=\"anchor\" href=\"#验证-mem_reserve-与-mem_commit\">#</a> 验证 MEM_RESERVE 与 MEM_COMMIT</h2>\n<p>我们使用 VirtualAlloc 这个函数的时候，第三个参数要传分配的类型，常见的一个是  <code>MEM_COMMIT</code>  ，另一个是  <code>MEM_RESERVE</code>  。</p>\n<p>前者申请后就会提供一个物理页，而后者会有记录但不会给你物理页，真的是这样的吗？</p>\n<p>之前的代码里我们传递的参数是 <code>MEM_COMMIT</code> ，但我们并没有给申请的地址赋值，我们来查看一下是否有物理页：</p>\n<p><img data-src=\"image003.png\" alt=\"\" /></p>\n<p>可以看到并没有 PTE，也就是没有挂物理页。</p>\n<p>更改上面的代码，给申请的地址赋值：</p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span><span class=\"token string\">&lt;stdio.h></span></span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span><span class=\"token string\">&lt;Windows.h></span></span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">int</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> argc<span class=\"token punctuation\">,</span> <span class=\"token keyword\">char</span><span class=\"token operator\">*</span> argv<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>\t<span class=\"token keyword\">void</span><span class=\"token operator\">*</span> p<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>\t<span class=\"token function\">system</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"pause\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>\tp <span class=\"token operator\">=</span> <span class=\"token function\">VirtualAlloc</span><span class=\"token punctuation\">(</span><span class=\"token constant\">NULL</span><span class=\"token punctuation\">,</span><span class=\"token number\">0x1000</span><span class=\"token punctuation\">,</span>MEM_COMMIT<span class=\"token punctuation\">,</span>PAGE_READWRITE<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>\t<span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"p:%p\\t\\n\"</span><span class=\"token punctuation\">,</span>p<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\t<span class=\"token function\">system</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"pause\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\t<span class=\"token operator\">*</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span><span class=\"token operator\">*</span><span class=\"token punctuation\">)</span>p<span class=\"token operator\">=</span><span class=\"token number\">666</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  <span class=\"token function\">system</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"pause\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  <span class=\"token function\">VirtualFree</span><span class=\"token punctuation\">(</span>p<span class=\"token punctuation\">,</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span>MEM_FREE<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>\t<span class=\"token keyword\">return</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>可以看到：</p>\n<figure class=\"highlight raw\"><figcaption data-lang=\"\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>kd&gt; !vtop 0aac01e0 0x3c0000</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>X86VtoP: Virt 00000000003c0000, pagedir 000000000aac01e0</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>X86VtoP: PAE PDPE 000000000aac01e0 - 000000004e48a801</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>X86VtoP: PAE PDE 000000004e48a008 - 000000004e723867</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>X86VtoP: PAE PTE 000000004e723e00 - 800000004ea37867</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>X86VtoP: PAE Mapped phys 000000004ea37000</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>Virtual address 3c0000 translates to physical address 4ea37000.</pre></td></tr></table></figure><p>可以看到挂上物理页了。也就是说，就算使用 MEM_COMMIT 参数，如果不用的话，物理页也不会给你的。</p>\n<h1 id=\"堆与栈\"><a class=\"anchor\" href=\"#堆与栈\">#</a> 堆与栈</h1>\n<p>一个由 C/C++ 编译的程序占用的内存分为以下几个部分</p>\n<ol>\n<li>栈区（stack）: 由编译器自动分配释放 ，存放函数的参数值，局部变量的值等。其操作方式类似于数据结构中的栈</li>\n<li>堆区（heap）: 一般由程序员分配释放， 若程序员不释放，程序结束时可能由 OS 回收 。注意它与数据结构中的堆是两回事，分配方式倒是类似于链表。</li>\n<li>全局区（静态区）（static）: 全局变量和静态变量的存储是放在一块的，初始化的全局变量和静态变量在一块区域， 未初始化的全局变量和未初始化的静态变量在相邻的另一块区域。  程序结束后有系统释放</li>\n<li>文字常量区：常量字符串就是放在这里的。 程序结束后由系统释放</li>\n<li>程序代码区：存放函数体的二进制代码。</li>\n</ol>\n<h2 id=\"堆内存与-malloc-分析\"><a class=\"anchor\" href=\"#堆内存与-malloc-分析\">#</a> 堆内存与 malloc 分析</h2>\n<p>在 c 程序中我们经常用 malloc 来 “申请内存”。<br />\n但它不是真正申请内存，它的底层实现是  <code>HeapAlloc</code>  ，就是申请堆内存，而这堆内存是进程创建好后操作系统就分配好了的。<br />\n我们来做个实验验证一下：</p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span><span class=\"token string\">&lt;stdio.h></span></span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span><span class=\"token string\">&lt;Windows.h></span></span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">int</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> argc<span class=\"token punctuation\">,</span> <span class=\"token keyword\">char</span><span class=\"token operator\">*</span> argv<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">&#123;</span> </pre></td></tr><tr><td data-num=\"6\"></td><td><pre>\tLPVOID p<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>\t<span class=\"token function\">system</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"pause\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    p <span class=\"token operator\">=</span> <span class=\"token function\">malloc</span><span class=\"token punctuation\">(</span><span class=\"token number\">4</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"p: 0x%X\\n\"</span><span class=\"token punctuation\">,</span>p<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    <span class=\"token function\">system</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"pause\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    <span class=\"token function\">free</span><span class=\"token punctuation\">(</span>p<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    <span class=\"token keyword\">return</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>在没执行 malloc 前看一下进程的内存结构：</p>\n<figure class=\"highlight raw\"><figcaption data-lang=\"\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>kd&gt; !vad 0x8a0fdfc0</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>VAD   Level     Start       End Commit</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>8a1ce638  1        10        10      1 Private      READWRITE          </pre></td></tr><tr><td data-num=\"4\"></td><td><pre>8a056258  2        20        20      1 Private      READWRITE          </pre></td></tr><tr><td data-num=\"5\"></td><td><pre>8a0fdfc0  0        30       12f      4 Private      READWRITE          </pre></td></tr><tr><td data-num=\"6\"></td><td><pre>8a074aa0  3       130       132      0 Mapped       READONLY           Pagefile section, shared commit 0x3</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>89d0eb38  2       140       23f      9 Private      READWRITE          </pre></td></tr><tr><td data-num=\"8\"></td><td><pre>89e05778  4       240       24f      6 Private      READWRITE          </pre></td></tr><tr><td data-num=\"9\"></td><td><pre>8a0dfa00  3       250       25f      0 Mapped       READWRITE          Pagefile section, shared commit 0x3</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>89ace2a8  5       260       275      0 Mapped       READONLY           \\WINDOWS\\system32\\unicode.nls</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>8a09a2e8  4       280       2c0      0 Mapped       READONLY           \\WINDOWS\\system32\\locale.nls</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>8a112a20  6       2d0       310      0 Mapped       READONLY           \\WINDOWS\\system32\\sortkey.nls</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>89ad4380  5       320       325      0 Mapped       READONLY           \\WINDOWS\\system32\\sorttbls.nls</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>89d1bcb8  7       330       370      0 Mapped       READONLY           Pagefile section, shared commit 0x41</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>8a09be68  6       380       38f      3 Private      READWRITE          </pre></td></tr><tr><td data-num=\"16\"></td><td><pre>8a167bd0  7       390       392      0 Mapped       READONLY           \\WINDOWS\\system32\\ctype.nls</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>89d91d08  8       3a0       3ad      0 Mapped       READWRITE          Pagefile section, shared commit 0xe</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>8a04df30  9       3b0       3b0      1 Private      READWRITE          </pre></td></tr><tr><td data-num=\"19\"></td><td><pre>89ac7148  1       400       42d      7 Mapped  Exe  EXECUTE_WRITECOPY  \\Documents and Settings\\Administrator\\My Documents\\TestHeapAndStack\\Debug\\TestHeapAndStack.exe</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>8a1f8b78  4     76d70     76d91      2 Mapped  Exe  EXECUTE_WRITECOPY  \\WINDOWS\\system32\\apphelp.dll</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>89ad66a8  5     77bd0     77bd7      2 Mapped  Exe  EXECUTE_WRITECOPY  \\WINDOWS\\system32\\version.dll</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>8a19ad48  6     77da0     77e48      6 Mapped  Exe  EXECUTE_WRITECOPY  \\WINDOWS\\system32\\advapi32.dll</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>8a16f5b8  7     77e50     77ee2      2 Mapped  Exe  EXECUTE_WRITECOPY  \\WINDOWS\\system32\\rpcrt4.dll</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>89ad5388  8     77fc0     77fd0      2 Mapped  Exe  EXECUTE_WRITECOPY  \\WINDOWS\\system32\\secur32.dll</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>89dbbc00  3     7c800     7c91d      6 Mapped  Exe  EXECUTE_WRITECOPY  \\WINDOWS\\system32\\kernel32.dll</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>89d11fd8  2     7c920     7c9b2      5 Mapped  Exe  EXECUTE_WRITECOPY  \\WINDOWS\\system32\\ntdll.dll</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>89ad1d20  4     7f6f0     7f7ef      0 Mapped       EXECUTE_READ       Pagefile section, shared commit 0x7</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>8a175400  3     7ffa0     7ffd2      0 Mapped       READONLY           Pagefile section, shared commit 0x33</pre></td></tr><tr><td data-num=\"29\"></td><td><pre>8a0a5dc8  4     7ffdd     7ffdd      1 Private      READWRITE          </pre></td></tr><tr><td data-num=\"30\"></td><td><pre>89d18918  5     7ffdf     7ffdf      1 Private      READWRITE</pre></td></tr></table></figure><p>执行 malloc 后，程序打印出的地址为： <code>p: 003807A8</code> ，此时再看内存结构：</p>\n<figure class=\"highlight raw\"><figcaption data-lang=\"\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>kd&gt; !vad 0x8a0fdfc0</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>VAD   Level     Start       End Commit</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>8a1ce638  1        10        10      1 Private      READWRITE          </pre></td></tr><tr><td data-num=\"4\"></td><td><pre>8a056258  2        20        20      1 Private      READWRITE          </pre></td></tr><tr><td data-num=\"5\"></td><td><pre>8a0fdfc0  0        30       12f      4 Private      READWRITE          </pre></td></tr><tr><td data-num=\"6\"></td><td><pre>8a074aa0  3       130       132      0 Mapped       READONLY           Pagefile section, shared commit 0x3</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>89d0eb38  2       140       23f      9 Private      READWRITE          </pre></td></tr><tr><td data-num=\"8\"></td><td><pre>89e05778  4       240       24f      6 Private      READWRITE          </pre></td></tr><tr><td data-num=\"9\"></td><td><pre>8a0dfa00  3       250       25f      0 Mapped       READWRITE          Pagefile section, shared commit 0x3</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>89ace2a8  5       260       275      0 Mapped       READONLY           \\WINDOWS\\system32\\unicode.nls</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>8a09a2e8  4       280       2c0      0 Mapped       READONLY           \\WINDOWS\\system32\\locale.nls</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>8a112a20  6       2d0       310      0 Mapped       READONLY           \\WINDOWS\\system32\\sortkey.nls</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>89ad4380  5       320       325      0 Mapped       READONLY           \\WINDOWS\\system32\\sorttbls.nls</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>89d1bcb8  7       330       370      0 Mapped       READONLY           Pagefile section, shared commit 0x41</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>8a09be68  6       380       38f      5 Private      READWRITE          </pre></td></tr><tr><td data-num=\"16\"></td><td><pre>8a167bd0  7       390       392      0 Mapped       READONLY           \\WINDOWS\\system32\\ctype.nls</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>89d91d08  8       3a0       3ad      0 Mapped       READWRITE          Pagefile section, shared commit 0xe</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>8a04df30  9       3b0       3b0      1 Private      READWRITE          </pre></td></tr><tr><td data-num=\"19\"></td><td><pre>89ac7148  1       400       42d      7 Mapped  Exe  EXECUTE_WRITECOPY  \\Documents and Settings\\Administrator\\My Documents\\TestHeapAndStack\\Debug\\TestHeapAndStack.exe</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>8a1f8b78  4     76d70     76d91      2 Mapped  Exe  EXECUTE_WRITECOPY  \\WINDOWS\\system32\\apphelp.dll</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>89ad66a8  5     77bd0     77bd7      2 Mapped  Exe  EXECUTE_WRITECOPY  \\WINDOWS\\system32\\version.dll</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>8a19ad48  6     77da0     77e48      6 Mapped  Exe  EXECUTE_WRITECOPY  \\WINDOWS\\system32\\advapi32.dll</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>8a16f5b8  7     77e50     77ee2      2 Mapped  Exe  EXECUTE_WRITECOPY  \\WINDOWS\\system32\\rpcrt4.dll</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>89ad5388  8     77fc0     77fd0      2 Mapped  Exe  EXECUTE_WRITECOPY  \\WINDOWS\\system32\\secur32.dll</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>89dbbc00  3     7c800     7c91d      6 Mapped  Exe  EXECUTE_WRITECOPY  \\WINDOWS\\system32\\kernel32.dll</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>89d11fd8  2     7c920     7c9b2      5 Mapped  Exe  EXECUTE_WRITECOPY  \\WINDOWS\\system32\\ntdll.dll</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>89ad1d20  4     7f6f0     7f7ef      0 Mapped       EXECUTE_READ       Pagefile section, shared commit 0x7</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>8a175400  3     7ffa0     7ffd2      0 Mapped       READONLY           Pagefile section, shared commit 0x33</pre></td></tr><tr><td data-num=\"29\"></td><td><pre>8a0a5dc8  4     7ffdd     7ffdd      1 Private      READWRITE          </pre></td></tr><tr><td data-num=\"30\"></td><td><pre>89d18918  5     7ffdf     7ffdf      1 Private      READWRITE</pre></td></tr></table></figure><p><code>8a09be68  6       380       38f      5 Private      READWRITE </code>  这个线性地址早已存在。<br />\n所以 malloc 就是从已经分配好的线性地址也就是堆内存中取出地址来用。</p>\n<h2 id=\"栈内存与全局变量区的内存\"><a class=\"anchor\" href=\"#栈内存与全局变量区的内存\">#</a> 栈内存与全局变量区的内存</h2>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span><span class=\"token string\">&lt;stdio.h></span></span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span><span class=\"token string\">&lt;Windows.h></span></span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">int</span> x<span class=\"token operator\">=</span><span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token keyword\">int</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> argc<span class=\"token punctuation\">,</span> <span class=\"token keyword\">char</span><span class=\"token operator\">*</span> argv<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>\t<span class=\"token function\">system</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"pause\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\t<span class=\"token keyword\">int</span> y <span class=\"token operator\">=</span> <span class=\"token number\">0x12345678</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>\t<span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"x:%x y:%x \\n\"</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>x<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>y<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>\t<span class=\"token function\">getchar</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>\t<span class=\"token keyword\">return</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>在运行前 (可以下断点) 查看进程的内存结构：</p>\n<figure class=\"highlight raw\"><figcaption data-lang=\"\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>VAD   Level     Start       End Commit</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>8a108ef0  1        10        10      1 Private      READWRITE</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>89d0f8e8  2        20        20      1 Private      READWRITE</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>8a1d4360  0        30       12f      4 Private      READWRITE</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>89d1ef10  3       130       132      0 Mapped       READONLY           Pagefile section, shared commit 0x3</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>89e01950  2       140       23f      8 Private      READWRITE          </pre></td></tr><tr><td data-num=\"7\"></td><td><pre>8a056258  4       240       24f      6 Private      READWRITE          </pre></td></tr><tr><td data-num=\"8\"></td><td><pre>8a19ef10  3       250       25f      0 Mapped       READWRITE          Pagefile section, shared commit 0x3</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>8a16f160  5       260       275      0 Mapped       READONLY           \\WINDOWS\\system32\\unicode.nls</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>89d19408  4       280       2c0      0 Mapped       READONLY           \\WINDOWS\\system32\\locale.nls</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>89dabd28  6       2d0       310      0 Mapped       READONLY           \\WINDOWS\\system32\\sortkey.nls</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>89ad47b8  5       320       325      0 Mapped       READONLY           \\WINDOWS\\system32\\sorttbls.nls</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>8a12e820  7       330       370      0 Mapped       READONLY           Pagefile section, shared commit 0x41</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>89d79bc8  6       380       38f      3 Private      READWRITE          </pre></td></tr><tr><td data-num=\"15\"></td><td><pre>8a062d58  7       390       392      0 Mapped       READONLY           \\WINDOWS\\system32\\ctype.nls</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>89d9a2a8  8       3a0       3ad      0 Mapped       READWRITE          Pagefile section, shared commit 0xe</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>89d0eb38  9       3b0       3b0      1 Private      READWRITE          </pre></td></tr><tr><td data-num=\"18\"></td><td><pre>8a0348b8  1       400       42e      8 Mapped  Exe  EXECUTE_WRITECOPY  \\Documents and Settings\\Administrator\\My Documents\\TestHeapAndStack\\Debug\\TestHeapAndStack.exe</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>8a065420  4     76d70     76d91      2 Mapped  Exe  EXECUTE_WRITECOPY  \\WINDOWS\\system32\\apphelp.dll</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>89d1ad68  5     77bd0     77bd7      2 Mapped  Exe  EXECUTE_WRITECOPY  \\WINDOWS\\system32\\version.dll</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>8a034a78  6     77da0     77e48      6 Mapped  Exe  EXECUTE_WRITECOPY  \\WINDOWS\\system32\\advapi32.dll</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>89d03940  7     77e50     77ee2      2 Mapped  Exe  EXECUTE_WRITECOPY  \\WINDOWS\\system32\\rpcrt4.dll</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>89dbc488  8     77fc0     77fd0      2 Mapped  Exe  EXECUTE_WRITECOPY  \\WINDOWS\\system32\\secur32.dll</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>89cf8798  3     7c800     7c91d      6 Mapped  Exe  EXECUTE_WRITECOPY  \\WINDOWS\\system32\\kernel32.dll</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>8a0348e8  2     7c920     7c9b2      5 Mapped  Exe  EXECUTE_WRITECOPY  \\WINDOWS\\system32\\ntdll.dll</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>89cf87c8  4     7f6f0     7f7ef      0 Mapped       EXECUTE_READ       Pagefile section, shared commit 0x7</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>89ad22e8  3     7ffa0     7ffd2      0 Mapped       READONLY           Pagefile section, shared commit 0x33</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>8a072a00  4     7ffdb     7ffdb      1 Private      READWRITE          </pre></td></tr><tr><td data-num=\"29\"></td><td><pre>89da64c0  5     7ffdf     7ffdf      1 Private      READWRITE</pre></td></tr></table></figure><p>运行后打印信息如下： <code>x:0042AC50 y:0012FF7C</code>  其内存结构如下：</p>\n<figure class=\"highlight raw\"><figcaption data-lang=\"\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>8a108ef0  1        10        10      1 Private      READWRITE</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>89d0f8e8  2        20        20      1 Private      READWRITE</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>8a1d4360  0        30       12f      4 Private      READWRITE</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>89d1ef10  3       130       132      0 Mapped       READONLY           Pagefile section, shared commit 0x3</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>89e01950  2       140       23f      8 Private      READWRITE          </pre></td></tr><tr><td data-num=\"6\"></td><td><pre>8a056258  4       240       24f      6 Private      READWRITE          </pre></td></tr><tr><td data-num=\"7\"></td><td><pre>8a19ef10  3       250       25f      0 Mapped       READWRITE          Pagefile section, shared commit 0x3</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>8a16f160  5       260       275      0 Mapped       READONLY           \\WINDOWS\\system32\\unicode.nls</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>89d19408  4       280       2c0      0 Mapped       READONLY           \\WINDOWS\\system32\\locale.nls</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>89dabd28  6       2d0       310      0 Mapped       READONLY           \\WINDOWS\\system32\\sortkey.nls</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>89ad47b8  5       320       325      0 Mapped       READONLY           \\WINDOWS\\system32\\sorttbls.nls</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>8a12e820  7       330       370      0 Mapped       READONLY           Pagefile section, shared commit 0x41</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>89d79bc8  6       380       38f      5 Private      READWRITE          </pre></td></tr><tr><td data-num=\"14\"></td><td><pre>8a062d58  7       390       392      0 Mapped       READONLY           \\WINDOWS\\system32\\ctype.nls</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>89d9a2a8  8       3a0       3ad      0 Mapped       READWRITE          Pagefile section, shared commit 0xe</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>89d0eb38  9       3b0       3b0      1 Private      READWRITE          </pre></td></tr><tr><td data-num=\"17\"></td><td><pre>8a0348b8  1       400       42e      8 Mapped  Exe  EXECUTE_WRITECOPY  \\Documents and Settings\\Administrator\\My Documents\\TestHeapAndStack\\Debug\\TestHeapAndStack.exe</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>8a065420  4     76d70     76d91      2 Mapped  Exe  EXECUTE_WRITECOPY  \\WINDOWS\\system32\\apphelp.dll</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>89d1ad68  5     77bd0     77bd7      2 Mapped  Exe  EXECUTE_WRITECOPY  \\WINDOWS\\system32\\version.dll</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>8a034a78  6     77da0     77e48      6 Mapped  Exe  EXECUTE_WRITECOPY  \\WINDOWS\\system32\\advapi32.dll</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>89d03940  7     77e50     77ee2      2 Mapped  Exe  EXECUTE_WRITECOPY  \\WINDOWS\\system32\\rpcrt4.dll</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>89dbc488  8     77fc0     77fd0      2 Mapped  Exe  EXECUTE_WRITECOPY  \\WINDOWS\\system32\\secur32.dll</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>89cf8798  3     7c800     7c91d      6 Mapped  Exe  EXECUTE_WRITECOPY  \\WINDOWS\\system32\\kernel32.dll</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>8a0348e8  2     7c920     7c9b2      5 Mapped  Exe  EXECUTE_WRITECOPY  \\WINDOWS\\system32\\ntdll.dll</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>89cf87c8  4     7f6f0     7f7ef      0 Mapped       EXECUTE_READ       Pagefile section, shared commit 0x7</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>89ad22e8  3     7ffa0     7ffd2      0 Mapped       READONLY           Pagefile section, shared commit 0x33</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>8a072a00  4     7ffdb     7ffdb      1 Private      READWRITE          </pre></td></tr><tr><td data-num=\"28\"></td><td><pre>89da64c0  5     7ffdf     7ffdf      1 Private      READWRITE</pre></td></tr></table></figure><p>可以发现这两处内存地址也是提前申请好的。</p>\n<p>至此结束。</p>\n",
            "tags": [
                "VirtualAlloc",
                "MEM_COMMIT与MEM_RESERVE",
                "malloc",
                "堆内存",
                "栈内存",
                "全局区内存"
            ]
        },
        {
            "id": "https://or0kit.github.io/Bin/Core/WindowsXp/MemoryManagement/%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86-01%E7%BA%BF%E6%80%A7%E5%9C%B0%E5%9D%80%E7%9A%84%E7%AE%A1%E7%90%86/",
            "url": "https://or0kit.github.io/Bin/Core/WindowsXp/MemoryManagement/%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86-01%E7%BA%BF%E6%80%A7%E5%9C%B0%E5%9D%80%E7%9A%84%E7%AE%A1%E7%90%86/",
            "title": "内存管理-01线性地址的管理",
            "date_published": "2022-04-14T07:16:52.000Z",
            "content_html": "<h1 id=\"楔子\"><a class=\"anchor\" href=\"#楔子\">#</a> 楔子</h1>\n<p>Windows 的内存管理是非常复杂的，目前仅学习其线性地址、私有内存、映射内存、物理内存是如何管理的。</p>\n<h1 id=\"线性地址的管理\"><a class=\"anchor\" href=\"#线性地址的管理\">#</a> 线性地址的管理</h1>\n<p>进程空间地址的划分：</p>\n<table>\n<thead>\n<tr>\n<th style=\"text-align:left\">分区</th>\n<th style=\"text-align:left\">x86 32 位 Windows</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td style=\"text-align:left\">空指针赋值区</td>\n<td style=\"text-align:left\">0x00000000 - 0x0000FFFF</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">用户模式区</td>\n<td style=\"text-align:left\">0x00010000 - 0x7FFEFFFF</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">64KB 禁入区</td>\n<td style=\"text-align:left\">0x7FFF0000 - 0x7FFFFFFF</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">内核</td>\n<td style=\"text-align:left\">0x80000000 - 0xFFFFFFFF</td>\n</tr>\n</tbody>\n</table>\n<p>进程虽然名义上有 4G 的虚拟内存空间，但只有低 2G 才是属于自己的，高 2G 是共享的内核空间。</p>\n<p>学过之前的知识，上面那些不能访问的地址，只要挂上一个物理页，我们也是可以访问的。</p>\n<p>但是在应用层我们必须得知道哪些地址可以访问哪些地址不能访问，以及哪些地址已经申请了线性地址，所以这就需要记录了。<br />\n记录哪些线性地址分配了，那些线性地址没有分配，无论是内核空间还是用户空间都需要记录。</p>\n<p>下图是 Windows 20003 SP1 的内核空间内存结构图：</p>\n<p><img data-src=\"image001.png\" alt=\"\" /></p>\n<p>详细的内容在《Windows 内核原理与实现》一书中有。</p>\n<p>下面学习用户空间是如何记录的。</p>\n<p>当你在一个进程空间中申请内存的时候，系统会查哪一个线性地址没有被占用。</p>\n<p>那么 Windows 是查询什么呢？学过数据结构的都知道，树的查询效率是要比链表高的，所以 Windows 在用户空间设计了一个二叉树，这上面记录着进程中线性地址的使用情况。</p>\n<p>而这个二叉树结构在进程结构体  <code>EPROCESS</code>  上:</p>\n<figure class=\"highlight raw\"><figcaption data-lang=\"\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>EPROCESS</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>\t...</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>\t+0x11c VadRoot</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>\t...</pre></td></tr></table></figure><p>结构体说明：</p>\n<figure class=\"highlight raw\"><figcaption data-lang=\"\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>kd&gt; dt _MMVAD</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>nt!_MMVAD</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>   +0x000 StartingVpn      : Uint4B        &#x2F;&#x2F; 线性地址开始位置 (页为单位)</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>   +0x004 EndingVpn        : Uint4B        &#x2F;&#x2F; 线性地址结束位置 (页为单位)</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>   +0x008 Parent           : Ptr32 _MMVAD  &#x2F;&#x2F; 父节点</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>   +0x00c LeftChild        : Ptr32 _MMVAD  &#x2F;&#x2F; 左子树</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>   +0x010 RightChild       : Ptr32 _MMVAD  &#x2F;&#x2F; 右子树</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>   +0x014 u                : __unnamed</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>   +0x018 ControlArea      : Ptr32 _CONTROL_AREA</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>   +0x01c FirstPrototypePte : Ptr32 _MMPTE</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>   +0x020 LastContiguousPte : Ptr32 _MMPTE</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>   +0x024 u2               : __unnamed</pre></td></tr></table></figure><p>Windows XP 的源码中的定义为：</p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">typedef</span> <span class=\"token keyword\">struct</span> <span class=\"token class-name\">_MMVAD</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    ULONG_PTR StartingVpn<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    ULONG_PTR EndingVpn<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token keyword\">struct</span> <span class=\"token class-name\">_MMVAD</span> <span class=\"token operator\">*</span>Parent<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token keyword\">struct</span> <span class=\"token class-name\">_MMVAD</span> <span class=\"token operator\">*</span>LeftChild<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token keyword\">struct</span> <span class=\"token class-name\">_MMVAD</span> <span class=\"token operator\">*</span>RightChild<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token keyword\">union</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>        ULONG_PTR LongFlags<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>        MMVAD_FLAGS VadFlags<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span> u<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    PCONTROL_AREA ControlArea<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    PMMPTE FirstPrototypePte<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    PMMPTE LastContiguousPte<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    <span class=\"token keyword\">union</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>        ULONG LongFlags2<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>        MMVAD_FLAGS2 VadFlags2<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span> u2<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre><span class=\"token punctuation\">&#125;</span> MMVAD<span class=\"token punctuation\">,</span> <span class=\"token operator\">*</span>PMMVAD<span class=\"token punctuation\">;</span></pre></td></tr></table></figure><h2 id=\"实验验证\"><a class=\"anchor\" href=\"#实验验证\">#</a> 实验验证</h2>\n<p>在虚拟机中我打开了 DbgView.exe 进程，接下来查看其  <code>EPROCESS</code>  结构体，看看其  <code>+0x11c</code>  的位置:</p>\n<figure class=\"highlight raw\"><figcaption data-lang=\"\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>kd&gt; !process 0 0</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>**** NT ACTIVE PROCESS DUMP ****</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>……</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>……</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>Failed to get VadRoot</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>PROCESS 89e21830  SessionId: 0  Cid: 0758    Peb: 7ffdd000  ParentCid: 043c</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    DirBase: 0aac01a0  ObjectTable: e3365a28  HandleCount:  56.</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    Image: Dbgview.exe</pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>kd&gt; dt _EPROCESS 89e21830</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>nt!_EPROCESS</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  ……</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>  ……</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>   +0x11c VadRoot          : 0x8a173990 Void</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>   +0x120 VadHint          : 0x89d23eb0 Void</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>   +0x124 CloneRoot        : (null) </pre></td></tr><tr><td data-num=\"17\"></td><td><pre>   +0x128 NumberOfPrivatePages : 0xbb</pre></td></tr></table></figure><p>查看  <code>VadRoot</code>  的结构：</p>\n<figure class=\"highlight raw\"><figcaption data-lang=\"\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>kd&gt; dt _MMVAD 0x8a173990</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>nt!_MMVAD</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>   +0x000 StartingVpn      : 0x9e0</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>   +0x004 EndingVpn        : 0xadf</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>   +0x008 Parent           : (null) </pre></td></tr><tr><td data-num=\"6\"></td><td><pre>   +0x00c LeftChild        : 0x89dac868 _MMVAD</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>   +0x010 RightChild       : 0x89d23eb0 _MMVAD</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>   +0x014 u                : __unnamed</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>   +0x018 ControlArea      : 0x0a080004 _CONTROL_AREA</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>   +0x01c FirstPrototypePte : 0x7266744e _MMPTE</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>   +0x020 LastContiguousPte : 0x89cf0f28 _MMPTE</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>   +0x024 u2               : __unnamed</pre></td></tr></table></figure><p>我们遍历其右分支：</p>\n<figure class=\"highlight raw\"><figcaption data-lang=\"\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>kd&gt; dt 0x89d23eb0 _MMVAD</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>nt!_MMVAD</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>   +0x000 StartingVpn      : 0x7c800</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>   +0x004 EndingVpn        : 0x7c91d</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>   +0x008 Parent           : 0x8a173990 _MMVAD</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>   +0x00c LeftChild        : 0x89d12ae8 _MMVAD</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>   +0x010 RightChild       : 0x8a164b48 _MMVAD</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>   +0x014 u                : __unnamed</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>   +0x018 ControlArea      : 0x8a076430 _CONTROL_AREA</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>   +0x01c FirstPrototypePte : 0xe158d6e0 _MMPTE</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>   +0x020 LastContiguousPte : 0xfffffffc _MMPTE</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>   +0x024 u2               : __unnamed</pre></td></tr></table></figure><p>我们可以看到从  <code>0x7c800</code>  到  <code>0x7c91d</code>  (以页为单位) 都是被占用的，那么我们如何查看是被谁占用的呢？</p>\n<h3 id=\"查看是谁占用的内存\"><a class=\"anchor\" href=\"#查看是谁占用的内存\">#</a> 查看是谁占用的内存</h3>\n<p>注意  <code>MMVAD</code>  中的  <code>   +0x018 ControlArea      : 0x8a076430 _CONTROL_AREA</code></p>\n<p>我们在 Windbg 中查看：</p>\n<figure class=\"highlight raw\"><figcaption data-lang=\"\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>kd&gt; dt _CONTROL_AREA 0x8a076430</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>nt!_CONTROL_AREA</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>   +0x000 Segment          : 0xe158d6a0 _SEGMENT</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>   +0x004 DereferenceList  : _LIST_ENTRY [ 0x0 - 0x0 ]</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>   +0x00c NumberOfSectionReferences : 1</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>   +0x010 NumberOfPfnReferences : 0xa6</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>   +0x014 NumberOfMappedViews : 0x15</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>   +0x018 NumberOfSubsections : 5</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>   +0x01a FlushInProgressCount : 0</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>   +0x01c NumberOfUserReferences : 0x16</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>   +0x020 u                : __unnamed</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>   +0x024 FilePointer      : 0x8a0763b8 _FILE_OBJECT</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>   +0x028 WaitingForDeletion : (null) </pre></td></tr><tr><td data-num=\"14\"></td><td><pre>   +0x02c ModifiedWriteCount : 0</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>   +0x02e NumberOfSystemCacheViews : 0</pre></td></tr></table></figure><p>观察到其  <code>+0x024 FilePointer      : 0x8a0763b8 _FILE_OBJECT</code></p>\n<p>接着查看：</p>\n<figure class=\"highlight raw\"><figcaption data-lang=\"\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>kd&gt; dt _FILE_OBJECT 0x8a0763b8</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>nt!_FILE_OBJECT</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>   +0x000 Type             : 0n5</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>   +0x002 Size             : 0n112</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>   +0x004 DeviceObject     : 0x89d68030 _DEVICE_OBJECT</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>   +0x008 Vpb              : 0x8a0cb298 _VPB</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>   +0x00c FsContext        : 0xe15415c8 Void</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>   +0x010 FsContext2       : 0xe1541720 Void</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>   +0x014 SectionObjectPointer : 0x8a076314 _SECTION_OBJECT_POINTERS</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>   +0x018 PrivateCacheMap  : (null) </pre></td></tr><tr><td data-num=\"11\"></td><td><pre>   +0x01c FinalStatus      : 0n0</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>   +0x020 RelatedFileObject : 0x8a198770 _FILE_OBJECT</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>   +0x024 LockOperation    : 0 &#39;&#39;</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>   +0x025 DeletePending    : 0 &#39;&#39;</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>   +0x026 ReadAccess       : 0x1 &#39;&#39;</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>   +0x027 WriteAccess      : 0 &#39;&#39;</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>   +0x028 DeleteAccess     : 0 &#39;&#39;</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>   +0x029 SharedRead       : 0x1 &#39;&#39;</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>   +0x02a SharedWrite      : 0 &#39;&#39;</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>   +0x02b SharedDelete     : 0x1 &#39;&#39;</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>   +0x02c Flags            : 0x44042</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>   +0x030 FileName         : _UNICODE_STRING &quot;\\WINDOWS\\system32\\kernel32.dll&quot;</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>   +0x038 CurrentByteOffset : _LARGE_INTEGER 0x0</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>   +0x040 Waiters          : 0</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>   +0x044 Busy             : 0</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>   +0x048 LastLock         : (null) </pre></td></tr><tr><td data-num=\"27\"></td><td><pre>   +0x04c Lock             : _KEVENT</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>   +0x05c Event            : _KEVENT</pre></td></tr><tr><td data-num=\"29\"></td><td><pre>   +0x06c CompletionContext : (null)</pre></td></tr></table></figure><p>可以发现是  <code>+0x030 FileName         : _UNICODE_STRING &quot;\\WINDOWS\\system32\\kernel32.dll&quot;</code> 。</p>\n<p>如果  <code>_CONTROL_AREA</code>  指向的地址是空的，那么线性地址被真正的物理页占用着。<br />\n既所有的内存都可以分为两类，一类是 VirtualAllocate 申请的私有内存，一类是映射的内存。</p>\n<h3 id=\"遍历进程的内存结构\"><a class=\"anchor\" href=\"#遍历进程的内存结构\">#</a> 遍历进程的内存结构</h3>\n<p>这个时候我们已经可以遍历进程的整个内存结构了，但是一个一个手动遍历非常麻烦，所以 Windows 提供了  <code>!vad</code>  命令：</p>\n<figure class=\"highlight raw\"><figcaption data-lang=\"\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>kd&gt; !vad 0x8a173990</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>VAD   Level     Start       End Commit</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>8a180608  3        10        10      1 Private      READWRITE          </pre></td></tr><tr><td data-num=\"4\"></td><td><pre>8a03c0a8  4        20        20      1 Private      READWRITE          </pre></td></tr><tr><td data-num=\"5\"></td><td><pre>89cf1438  2        30       12f      6 Private      READWRITE          </pre></td></tr><tr><td data-num=\"6\"></td><td><pre>8a15c740  4       130       132      0 Mapped       READONLY           Pagefile section, shared commit 0x3</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>89d06a70  3       140       141      0 Mapped       READONLY           Pagefile section, shared commit 0x2</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>89d27138  5       150       24f     21 Private      READWRITE          </pre></td></tr><tr><td data-num=\"9\"></td><td><pre>8a0e5cd8  4       250       25f      6 Private      READWRITE          </pre></td></tr><tr><td data-num=\"10\"></td><td><pre>8a15eb50  6       260       26f      0 Mapped       READWRITE          Pagefile section, shared commit 0x3</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>8a1314d8  5       270       285      0 Mapped       READONLY           \\WINDOWS\\system32\\unicode.nls</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>8a1d19c8  7       290       2d0      0 Mapped       READONLY           \\WINDOWS\\system32\\locale.nls</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>8a1c0890  6       2e0       320      0 Mapped       READONLY           \\WINDOWS\\system32\\sortkey.nls</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>89d12b78  8       330       335      0 Mapped       READONLY           \\WINDOWS\\system32\\sorttbls.nls</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>89db5160  7       340       380      0 Mapped       READONLY           Pagefile section, shared commit 0x41</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>8a170c98  8       390       39f      4 Private      READWRITE          </pre></td></tr><tr><td data-num=\"17\"></td><td><pre>8a0fdb70  9       3a0       3a2      0 Mapped       READONLY           \\WINDOWS\\system32\\ctype.nls</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>89cf23c8 10       3b0       3bf      8 Private      READWRITE          </pre></td></tr><tr><td data-num=\"19\"></td><td><pre>8a02d2f0 11       3c0       3c0      1 Private      READWRITE          </pre></td></tr><tr><td data-num=\"20\"></td><td><pre>89dac8a8 12       3d0       3d0      1 Private      READWRITE          </pre></td></tr><tr><td data-num=\"21\"></td><td><pre>8a1c0830 14       3e0       3e1      0 Mapped       READONLY           Pagefile section, shared commit 0x2</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>8a16b8d0 13       3f0       3f1      0 Mapped       READONLY           Pagefile section, shared commit 0x2</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>89dac868  1       400       486     25 Mapped  Exe  EXECUTE_WRITECOPY  \\Documents and Settings\\Administrator\\ 桌面 \\Dbgview.exe</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>89da6cb8  3       490       557      0 Mapped       EXECUTE_READ       Pagefile section, shared commit 0x8</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>8a04e768  2       560       662      0 Mapped       READONLY           Pagefile section, shared commit 0x103</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>8a15c658  4       670       96f      0 Mapped       EXECUTE_READ       Pagefile section, shared commit 0x2b</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>8a110a50  5       970       97f      6 Private      READWRITE          </pre></td></tr><tr><td data-num=\"28\"></td><td><pre>8a0e2a58  3       980       980      0 Mapped       READWRITE          Pagefile section, shared commit 0x1</pre></td></tr><tr><td data-num=\"29\"></td><td><pre>8a02f590  5       990       9cf      0 Mapped       READWRITE          Pagefile section, shared commit 0x10</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>8a02f528  4       9d0       9dd      0 Mapped       READWRITE          Pagefile section, shared commit 0xe</pre></td></tr><tr><td data-num=\"31\"></td><td><pre>8a173990  0       9e0       adf    106 Private      READWRITE          </pre></td></tr><tr><td data-num=\"32\"></td><td><pre>89d0d8d0  5       ae0       ae0      1 Private      READWRITE          </pre></td></tr><tr><td data-num=\"33\"></td><td><pre>89d0de90  7       af0       af0      0 Private Phys READWRITE          </pre></td></tr><tr><td data-num=\"34\"></td><td><pre>8a02f5f8  6       b00       b00      0 Mapped       READWRITE          Pagefile section, shared commit 0x1</pre></td></tr><tr><td data-num=\"35\"></td><td><pre>89d912a8  7       b10       b13      0 Mapped       READWRITE          Pagefile section, shared commit 0x4</pre></td></tr><tr><td data-num=\"36\"></td><td><pre>89cf14f0  4       b30       baf      1 Private      READWRITE          </pre></td></tr><tr><td data-num=\"37\"></td><td><pre>8a10fa30  7       bb0       caf      2 Private      READWRITE          </pre></td></tr><tr><td data-num=\"38\"></td><td><pre>89da4e90  6       cc0       cc7      8 Private      READWRITE          </pre></td></tr><tr><td data-num=\"39\"></td><td><pre>8a0df250  7       cd0       d4f      0 Mapped       READWRITE          Pagefile section, shared commit 0x6</pre></td></tr><tr><td data-num=\"40\"></td><td><pre>89da6b20  5     5adc0     5adf6      2 Mapped  Exe  EXECUTE_WRITECOPY  \\WINDOWS\\system32\\uxtheme.dll</pre></td></tr><tr><td data-num=\"41\"></td><td><pre>89e1c140  3     62c20     62c28      2 Mapped  Exe  EXECUTE_WRITECOPY  \\WINDOWS\\system32\\lpk.dll</pre></td></tr><tr><td data-num=\"42\"></td><td><pre>89d12ae8  2     71a10     71a17      2 Mapped  Exe  EXECUTE_WRITECOPY  \\WINDOWS\\system32\\ws2help.dll</pre></td></tr><tr><td data-num=\"43\"></td><td><pre>89e055d0  3     71a20     71a36      2 Mapped  Exe  EXECUTE_WRITECOPY  \\WINDOWS\\system32\\ws2_32.dll</pre></td></tr><tr><td data-num=\"44\"></td><td><pre>89dbbb80  6     71a90     71aa1      2 Mapped  Exe  EXECUTE_WRITECOPY  \\WINDOWS\\system32\\mpr.dll</pre></td></tr><tr><td data-num=\"45\"></td><td><pre>8a039b30 11     73640     7366d      2 Mapped  Exe  EXECUTE_WRITECOPY  \\WINDOWS\\system32\\MSCTFIME.IME</pre></td></tr><tr><td data-num=\"46\"></td><td><pre>8a04c6e0 10     73fa0     7400a     17 Mapped  Exe  EXECUTE_WRITECOPY  \\WINDOWS\\system32\\usp10.dll</pre></td></tr><tr><td data-num=\"47\"></td><td><pre>89d27178 11     74680     746cb      3 Mapped  Exe  EXECUTE_WRITECOPY  \\WINDOWS\\system32\\MSCTF.dll</pre></td></tr><tr><td data-num=\"48\"></td><td><pre>8a12bb30  9     76300     7631c      2 Mapped  Exe  EXECUTE_WRITECOPY  \\WINDOWS\\system32\\imm32.dll</pre></td></tr><tr><td data-num=\"49\"></td><td><pre>89da6c88  8     76320     76366      5 Mapped  Exe  EXECUTE_WRITECOPY  \\WINDOWS\\system32\\comdlg32.dll</pre></td></tr><tr><td data-num=\"50\"></td><td><pre>8a039ac8  9     76990     76acd      8 Mapped  Exe  EXECUTE_WRITECOPY  \\WINDOWS\\system32\\ole32.dll</pre></td></tr><tr><td data-num=\"51\"></td><td><pre>8a106bf8  7     77180     77282      2 Mapped  Exe  EXECUTE_WRITECOPY  \\WINDOWS\\WinSxS\\x86_Microsoft.Windows.Common-Controls_6595b64144ccf1df_6.0.2600.6028_x-ww_61e65202\\comctl32.dll</pre></td></tr><tr><td data-num=\"52\"></td><td><pre>8a1314a8  5     77be0     77c37      8 Mapped  Exe  EXECUTE_WRITECOPY  \\WINDOWS\\system32\\msvcrt.dll</pre></td></tr><tr><td data-num=\"53\"></td><td><pre>8a0df9b0  6     77d10     77d9f      3 Mapped  Exe  EXECUTE_WRITECOPY  \\WINDOWS\\system32\\user32.dll</pre></td></tr><tr><td data-num=\"54\"></td><td><pre>8a1368c8  4     77da0     77e48      6 Mapped  Exe  EXECUTE_WRITECOPY  \\WINDOWS\\system32\\advapi32.dll</pre></td></tr><tr><td data-num=\"55\"></td><td><pre>89db5190  5     77e50     77ee2      2 Mapped  Exe  EXECUTE_WRITECOPY  \\WINDOWS\\system32\\rpcrt4.dll</pre></td></tr><tr><td data-num=\"56\"></td><td><pre>8a164a88  7     77ef0     77f39      3 Mapped  Exe  EXECUTE_WRITECOPY  \\WINDOWS\\system32\\gdi32.dll</pre></td></tr><tr><td data-num=\"57\"></td><td><pre>89da6c58  8     77f40     77fb5      2 Mapped  Exe  EXECUTE_WRITECOPY  \\WINDOWS\\system32\\shlwapi.dll</pre></td></tr><tr><td data-num=\"58\"></td><td><pre>89da7650  6     77fc0     77fd0      2 Mapped  Exe  EXECUTE_WRITECOPY  \\WINDOWS\\system32\\secur32.dll</pre></td></tr><tr><td data-num=\"59\"></td><td><pre>89d23eb0  1     7c800     7c91d      6 Mapped  Exe  EXECUTE_WRITECOPY  \\WINDOWS\\system32\\kernel32.dll</pre></td></tr><tr><td data-num=\"60\"></td><td><pre>8a164b48  2     7c920     7c9b2      5 Mapped  Exe  EXECUTE_WRITECOPY  \\WINDOWS\\system32\\ntdll.dll</pre></td></tr><tr><td data-num=\"61\"></td><td><pre>89da6d50  5     7d590     7dd83     31 Mapped  Exe  EXECUTE_WRITECOPY  \\WINDOWS\\system32\\shell32.dll</pre></td></tr><tr><td data-num=\"62\"></td><td><pre>8a1c0860  4     7f6f0     7f7ef      0 Mapped       EXECUTE_READ       Pagefile section, shared commit 0x7</pre></td></tr><tr><td data-num=\"63\"></td><td><pre>8a164ab8  3     7ffa0     7ffd2      0 Mapped       READONLY           Pagefile section, shared commit 0x33</pre></td></tr><tr><td data-num=\"64\"></td><td><pre>8a02eae0  4     7ffdd     7ffdd      1 Private      READWRITE          </pre></td></tr><tr><td data-num=\"65\"></td><td><pre>8a128ab0  6     7ffde     7ffde      1 Private      READWRITE          </pre></td></tr><tr><td data-num=\"66\"></td><td><pre>89dd5830  5     7ffdf     7ffdf      1 Private      READWRITE          </pre></td></tr><tr><td data-num=\"67\"></td><td><pre></pre></td></tr><tr><td data-num=\"68\"></td><td><pre>Total VADs: 64, average level: 6, maximum depth: 14</pre></td></tr><tr><td data-num=\"69\"></td><td><pre>Total private commit: 0x13e pages (1272 KB)</pre></td></tr><tr><td data-num=\"70\"></td><td><pre>Total shared commit:  0x1e7 pages (1948 KB)</pre></td></tr></table></figure><p>这个时候进程所有的内存使用情况都显现出来了。</p>\n<p>这个可以用于对抗模块隐藏，就算在三环断掉了那几条链也没用，在这里仍然可以看得到，如果把这里也抹去了，操作系统分配线性地址的时候可能会出现错误，在已经被占用地址上有分配了。</p>\n<h3 id=\"内存属性\"><a class=\"anchor\" href=\"#内存属性\">#</a> 内存属性</h3>\n<p>在前面的 MMVAD 中的  <code>+0x014 u                : __unnamed</code>  ， 其实它是一个联合体：</p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">union</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>        ULONG_PTR LongFlags<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>        MMVAD_FLAGS VadFlags<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span> u<span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>在 Windbg 中查看；</p>\n<figure class=\"highlight raw\"><figcaption data-lang=\"\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>kd&gt; dt _MMVAD_FLAGS</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>nt!_MMVAD_FLAGS</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>   +0x000 CommitCharge     : Pos 0, 19 Bits</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>   +0x000 PhysicalMapping  : Pos 19, 1 Bit</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>   +0x000 ImageMap         : Pos 20, 1 Bit</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>   +0x000 UserPhysicalPages : Pos 21, 1 Bit</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>   +0x000 NoChange         : Pos 22, 1 Bit</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>   +0x000 WriteWatch       : Pos 23, 1 Bit</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>   +0x000 Protection       : Pos 24, 5 Bits</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>   +0x000 LargePages       : Pos 29, 1 Bit</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>   +0x000 MemCommit        : Pos 30, 1 Bit</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>   +0x000 PrivateMemory    : Pos 31, 1 Bit</pre></td></tr><tr><td data-num=\"13\"></td><td><pre></pre></td></tr><tr><td data-num=\"14\"></td><td><pre></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>kd&gt; dt _MMVAD_FLAGS 0x8a173990+0x14</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>nt!_MMVAD_FLAGS</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>   +0x000 CommitCharge     : 0y0000000000001101010 (0x6a)</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>   +0x000 PhysicalMapping  : 0y0</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>   +0x000 ImageMap         : 0y0</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>   +0x000 UserPhysicalPages : 0y0</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>   +0x000 NoChange         : 0y0</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>   +0x000 WriteWatch       : 0y0</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>   +0x000 Protection       : 0y00100 (0x4)</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>   +0x000 LargePages       : 0y0</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>   +0x000 MemCommit        : 0y0</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>   +0x000 PrivateMemory    : 0y1</pre></td></tr></table></figure><p>在 XP 源码中查看：</p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">if</span> <span class=\"token expression\"><span class=\"token function\">defined</span> <span class=\"token punctuation\">(</span>_WIN64<span class=\"token punctuation\">)</span></span></span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">COMMIT_SIZE</span> <span class=\"token expression\"><span class=\"token number\">51</span></span></span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">else</span></span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">COMMIT_SIZE</span> <span class=\"token expression\"><span class=\"token number\">19</span></span></span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">endif</span></span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token keyword\">typedef</span> <span class=\"token keyword\">struct</span> <span class=\"token class-name\">_MMVAD_FLAGS</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    ULONG_PTR CommitCharge <span class=\"token operator\">:</span> COMMIT_SIZE<span class=\"token punctuation\">;</span> <span class=\"token comment\">//limits system to 4k pages or bigger!</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    ULONG_PTR PhysicalMapping <span class=\"token operator\">:</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    ULONG_PTR ImageMap <span class=\"token operator\">:</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    ULONG_PTR UserPhysicalPages <span class=\"token operator\">:</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    ULONG_PTR NoChange <span class=\"token operator\">:</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    ULONG_PTR WriteWatch <span class=\"token operator\">:</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    ULONG_PTR Protection <span class=\"token operator\">:</span> <span class=\"token number\">5</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    ULONG_PTR LargePages <span class=\"token operator\">:</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    ULONG_PTR MemCommit<span class=\"token operator\">:</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    ULONG_PTR PrivateMemory <span class=\"token operator\">:</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span>    <span class=\"token comment\">//used to tell VAD from VAD_SHORT</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre><span class=\"token punctuation\">&#125;</span> MMVAD_FLAGS<span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>认识其重要的几个成员:</p>\n<figure class=\"highlight raw\"><figcaption data-lang=\"\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>nt!_MMVAD_FLAGS</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>   +0x000 CommitCharge</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>   +0x000 PhysicalMapping</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>   +0x000 ImageMap        &#x2F;&#x2F; 1 镜像文件  0 其他</pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>   +0x000 Protection      &#x2F;&#x2F; 保护属性： 1 READONLY  2  EXECUTE  3  EXECUTE _READ  4 READWITER 5 WRITECOPY  6  EXECUTE _READWITER   7 EXECUTE_WRITECOPY  </pre></td></tr><tr><td data-num=\"7\"></td><td><pre>   +0x000 PrivateMemory \t&#x2F;&#x2F; 标识当前的内存状态 1 PrivateMemory  0 Map</pre></td></tr></table></figure><p>如果想实现模块隐藏这一块是必须要绕过去的。</p>\n",
            "tags": [
                "线性地址的管理",
                "VAD树",
                "_MMVAD",
                "_MMVAD_FLAGS"
            ]
        },
        {
            "id": "https://or0kit.github.io/Bin/Core/Drive-Development/%E9%A9%B1%E5%8A%A8%E5%BC%80%E5%8F%91-%E5%86%85%E6%A0%B8%E9%87%8D%E8%BD%BD/",
            "url": "https://or0kit.github.io/Bin/Core/Drive-Development/%E9%A9%B1%E5%8A%A8%E5%BC%80%E5%8F%91-%E5%86%85%E6%A0%B8%E9%87%8D%E8%BD%BD/",
            "title": "驱动开发-内核重载",
            "date_published": "2022-03-30T02:18:07.000Z",
            "content_html": "<h1 id=\"重载内核解决什么问题\"><a class=\"anchor\" href=\"#重载内核解决什么问题\">#</a> 重载内核解决什么问题？</h1>\n<p>内核中的很多函数被层层 HOOK，重载一份内核可以绕过这些 HOOK。</p>\n<h1 id=\"重载内核的步骤\"><a class=\"anchor\" href=\"#重载内核的步骤\">#</a> 重载内核的步骤</h1>\n<p>&lt;1&gt; 申请内存，按内存对齐展开</p>\n<p>&lt;2&gt; 根据重定位表修复全局变量</p>\n<p>&lt;3&gt; 修复 IAT 表</p>\n<p>这些都是 PE 的知识，这样内核文件在高 2G 内存中就又加载了一份。</p>\n<p>但如何让操作系统走我们新内核文件的函数呢？</p>\n<p>&lt;1&gt; 找到新加载的内核的系统服务表，并且填充</p>\n<p>&lt;2&gt; Hook KiFastCallEntry 让系统调用走我们的系统服务表。</p>\n<p>KiFastCallEntry 中有一行汇编指令是查找系统服务表。</p>\n<h1 id=\"重载内核的弊端\"><a class=\"anchor\" href=\"#重载内核的弊端\">#</a> 重载内核的弊端</h1>\n<p>&lt;1&gt; 改动太大，即使抹去 PE 指纹也无法完全隐形。</p>\n<p>&lt;2&gt; 最好的办法不是重载内核，而是需要什么函数自己来实现。</p>\n<h1 id=\"代码实现重载xp的内核\"><a class=\"anchor\" href=\"#代码实现重载xp的内核\">#</a> 代码实现重载 xp 的内核。</h1>\n<p>使用内核函数操作文件、内存。</p>\n<p>写的时候网上冲浪发现了一篇博客：<span class=\"exturl\" data-url=\"aHR0cHM6Ly9iYnMucGVkaXkuY29tL3RocmVhZC0yNTM0MjUuaHRt\">https://bbs.pediy.com/thread-253425.htm</span>，这个博主说了一些关于重定位的事情：</p>\n<p>关键难点是重定位，<strong>由于我们自己重载的新内核没有执行 DriverEntry, 数据都没有初始化</strong>，所以在重定位的时候凡是指向数据的地址都要重定位到老内核，是代码的地址就正常重定位到新内核。</p>\n<p>重载后可能会不稳定，导致蓝屏。</p>\n<h2 id=\"第一步内核文件的全路径\"><a class=\"anchor\" href=\"#第一步内核文件的全路径\">#</a> 第一步：内核文件的全路径</h2>\n<p>遍历内核模块，找到内核文件。</p>\n<p>这里我遇到了一个问题：</p>\n<p>通过内核模块遍历获取内核文件的全路径，发现前面没根路径，于是就把根路径添加上了，一直调用  <code>ZwCreateFile</code>  失败。<br />\n先贴在这里了。</p>\n<p>信息如下:</p>\n<figure class=\"highlight raw\"><figcaption data-lang=\"\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>我是驱动，我运行了 </pre></td></tr><tr><td data-num=\"2\"></td><td><pre>\\??\\C:\\WINDOWS\\system32\\ntkrnlpa.exe </pre></td></tr><tr><td data-num=\"3\"></td><td><pre>打开文件失败</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>0 </pre></td></tr><tr><td data-num=\"5\"></td><td><pre>C0000033 </pre></td></tr><tr><td data-num=\"6\"></td><td><pre>0</pre></td></tr></table></figure><p>一直报  <code>C0000033</code>   <code>STATUS_OBJECT_NAME_INVALID</code>  错误，好像是路径有问题？</p>\n<p>解决不了就直接把路径写死了，不这样获取了。</p>\n<h2 id=\"第二步-修复重定位表和iat\"><a class=\"anchor\" href=\"#第二步-修复重定位表和iat\">#</a> 第二步： 修复重定位表和 IAT</h2>\n<p>下面就要修复重定位表和 IAT 了。</p>\n<p>修复重定位表这里我也学着看雪的那个博主的判断一下要修复的地址是否在可执行的节中，如果不在则不管这个地址了，让其仍然去老内核中。</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>BOOLEAN <span class=\"token function\">AddressIsExecuteable</span><span class=\"token punctuation\">(</span>IN ULONG pAddress<span class=\"token punctuation\">,</span> IN PIMAGE_SECTION_HEADER pSectionHeader<span class=\"token punctuation\">,</span> IN ULONG ulSectionNum<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>\tBOOLEAN bFlag <span class=\"token operator\">=</span> FALSE<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>\t<span class=\"token comment\">// 循环判断数据在哪个节中</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>\t<span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> t <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> t <span class=\"token operator\">&lt;</span> ulSectionNum<span class=\"token punctuation\">;</span> t<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span>\t\t</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\t\t<span class=\"token comment\">// 节的起始和结束位置</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>\t\tULONG Begin <span class=\"token operator\">=</span> pSectionHeader<span class=\"token punctuation\">[</span>t<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>VirtualAddress<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>\t\tULONG End <span class=\"token operator\">=</span> pSectionHeader<span class=\"token punctuation\">[</span>t<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>VirtualAddress <span class=\"token operator\">+</span> pSectionHeader<span class=\"token punctuation\">[</span>t<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>Misc<span class=\"token punctuation\">.</span>VirtualSize<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>\t\t<span class=\"token comment\">//DbgPrint(\"pSectionHeader:[%X]\\t\\n\", pSectionHeader);</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>\t\t<span class=\"token comment\">//DbgPrint(\"Begin:[%X]\\t\\n\", Begin);</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>\t\t<span class=\"token comment\">//DbgPrint(\"End:[%X]\\t\\n\", End);</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>\t\t<span class=\"token comment\">//DbgPrint(\"pSectionHeader[t].Characteristics:[%X]\\t\\n\", pSectionHeader[t].Characteristics);</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>\t\t<span class=\"token comment\">//__asm int 3;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>\t\t<span class=\"token comment\">// 判断</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>\t\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>pAddress <span class=\"token operator\">>=</span> Begin <span class=\"token operator\">&amp;&amp;</span> pAddress <span class=\"token operator\">&lt;=</span> End<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>\t\t<span class=\"token punctuation\">&#123;</span>\t</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>\t\t\t<span class=\"token comment\">// 只修复 .text 节区</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>\t\t\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">strcmp</span><span class=\"token punctuation\">(</span>pSectionHeader<span class=\"token punctuation\">[</span>t<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>Name<span class=\"token punctuation\">,</span> <span class=\"token string\">\".text\"</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>\t\t\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>\t\t\t\t<span class=\"token comment\">//DbgPrint(\"pSectionHeader[t].Name:[%s]\\t\\n\", pSectionHeader[t].Name);</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>\t\t\t\t<span class=\"token comment\">//__asm int 3;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>\t\t\t\t<span class=\"token keyword\">return</span> TRUE<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>\t\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>\t\t\t<span class=\"token comment\">// bFlag = ((pSectionHeader[t].Characteristics &amp; 0x20000020) == 0x20000020) ? TRUE : FALSE;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>\t\t\t<span class=\"token keyword\">return</span> bFlag<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>\t<span class=\"token comment\">//DbgPrint(\"pAddress:[%X] not in the section \\t\\n\", pAddress);</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>\t<span class=\"token keyword\">return</span> bFlag<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><hr />\n<p><strong>后来实验的时候发现这样判断节区属性来进行修复也是不行的，内核文件有很多节区，并且有太多没有被初始化的数据。</strong></p>\n<p>即使重定位完成了，但是重定位后的地址也是没有数据的，因为我们的内核文件并没有执行初始化，所以我就<strong>把新内核中需要重定位的数据，指向了老内核中</strong>，于是就这样变相的完成了重定位。修改后的代码在 Github 中。</p>\n<h3 id=\"修复重定位表\"><a class=\"anchor\" href=\"#修复重定位表\">#</a> 修复重定位表</h3>\n<blockquote>\n<p><strong>这里我碰到了一个坑，我在用  <code>LDR_DATA_TABLE_ENTRY</code>  结构体中的遍历内核文件时，也顺便把其中记录的内核加载基址，也获取了一下，我以为这个就是内核文件的 ImageBase，可是并不是，内核在启动的时候加载基址也是变化的。内核文件的 ImageBase 也是 0x400000。重定位时需要注意！</strong></p>\n</blockquote>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>NTSTATUS <span class=\"token function\">RepairRelocation</span><span class=\"token punctuation\">(</span>IN OUT PVOID pKernelImageBuffer<span class=\"token punctuation\">,</span> IN ULONG KernelBase<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>\t<span class=\"token keyword\">typedef</span> <span class=\"token keyword\">struct</span> <span class=\"token class-name\">_TYPE</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>\t\tUSHORT Offset <span class=\"token operator\">:</span> <span class=\"token number\">12</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>\t\tUSHORT Type <span class=\"token operator\">:</span> <span class=\"token number\">4</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span>TypeOffset<span class=\"token punctuation\">,</span> <span class=\"token operator\">*</span> PTypeOffset<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>\tNTSTATUS status <span class=\"token operator\">=</span> STATUS_SUCCESS<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\t<span class=\"token comment\">// PE 头 查找重定位表</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>\tPIMAGE_DOS_HEADER pDosHeader <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>PIMAGE_DOS_HEADER<span class=\"token punctuation\">)</span>pKernelImageBuffer<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>\tPIMAGE_NT_HEADERS pNtHeader <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>PIMAGE_NT_HEADERS<span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span>pDosHeader<span class=\"token operator\">-></span>e_lfanew <span class=\"token operator\">+</span> <span class=\"token punctuation\">(</span>ULONG<span class=\"token punctuation\">)</span>pKernelImageBuffer<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>\tPIMAGE_FILE_HEADER pFileHeader <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>PIMAGE_FILE_HEADER<span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>ULONG<span class=\"token punctuation\">)</span>pNtHeader <span class=\"token operator\">+</span> <span class=\"token number\">4</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>\tPIMAGE_OPTIONAL_HEADER pOptionHeader <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>PIMAGE_OPTIONAL_HEADER<span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>ULONG<span class=\"token punctuation\">)</span>pFileHeader <span class=\"token operator\">+</span> <span class=\"token punctuation\">(</span>ULONG<span class=\"token punctuation\">)</span>IMAGE_SIZEOF_FILE_HEADER<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>\tPIMAGE_SECTION_HEADER pSectionHeader <span class=\"token operator\">=</span> <span class=\"token function\">IMAGE_FIRST_SECTION</span><span class=\"token punctuation\">(</span>pNtHeader<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>\tPIMAGE_BASE_RELOCATION pReloc <span class=\"token operator\">=</span> pOptionHeader<span class=\"token operator\">-></span>DataDirectory<span class=\"token punctuation\">[</span>IMAGE_DIRECTORY_ENTRY_BASERELOC<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>VirtualAddress <span class=\"token operator\">+</span> <span class=\"token punctuation\">(</span>ULONG<span class=\"token punctuation\">)</span>pDosHeader<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>\t<span class=\"token comment\">// ULONG Items = 0, Items1 = 0, Items2 = 0;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>\t<span class=\"token comment\">//  遍历重定位表，并对目标代码进行重定位</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>\t<span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span>pReloc<span class=\"token operator\">-></span>SizeOfBlock <span class=\"token operator\">&amp;&amp;</span> pReloc<span class=\"token operator\">-></span>VirtualAddress<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>\t\t<span class=\"token comment\">// 重定位项数目</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>\t\tULONG ulCount <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>pReloc<span class=\"token operator\">-></span>SizeOfBlock <span class=\"token operator\">-</span> <span class=\"token number\">8</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">/</span> <span class=\"token number\">2</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>\t\t<span class=\"token comment\">// 需要定位数据的起始 RVA</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>\t\tULONG ulRva <span class=\"token operator\">=</span> pReloc<span class=\"token operator\">-></span>VirtualAddress<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>\t\t<span class=\"token comment\">// 解析需要重定位的项数</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>\t\tPTypeOffset pRelocationArray <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>PTypeOffset<span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span>pReloc <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>\t\t<span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> ulCount<span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>\t\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>\t\t\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>pRelocationArray<span class=\"token operator\">-></span>Type <span class=\"token operator\">==</span> <span class=\"token number\">3</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>\t\t\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>\t\t\t\t<span class=\"token comment\">// 需要重定位的数据 RVA = VirtualAddress + TypeOffset 低 12 位</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>\t\t\t\t<span class=\"token comment\">// 获取要修改的地址的 RVA</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>\t\t\t\tULONG RepairAddrOffset <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>ulRva <span class=\"token operator\">+</span> pRelocationArray<span class=\"token operator\">-></span>Offset<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>\t\t\t\tPULONG pRepairAddr <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>PULONG<span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span>RepairAddrOffset <span class=\"token operator\">+</span> <span class=\"token punctuation\">(</span>ULONG<span class=\"token punctuation\">)</span>pKernelImageBuffer<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>\t\t\t\t<span class=\"token comment\">// 判断要修复的地址是否在</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>\t\t\t\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">AddressIsExecuteable</span><span class=\"token punctuation\">(</span>RepairAddrOffset<span class=\"token punctuation\">,</span> pSectionHeader<span class=\"token punctuation\">,</span> pFileHeader<span class=\"token operator\">-></span>NumberOfSections<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>\t\t\t\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>\t\t\t\t\t</pre></td></tr><tr><td data-num=\"44\"></td><td><pre>\t\t\t\t\t<span class=\"token comment\">// 修正需要重定位项的在新内核中的值</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>\t\t\t\t\t<span class=\"token operator\">*</span>pRepairAddr <span class=\"token operator\">+=</span> <span class=\"token punctuation\">(</span>ULONG<span class=\"token punctuation\">)</span>pKernelImageBuffer <span class=\"token operator\">-</span> pOptionHeader<span class=\"token operator\">-></span>ImageBase<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>\t\t\t\t\t<span class=\"token comment\">//Items++;</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>\t\t\t\t\t<span class=\"token comment\">//Items1++;</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>\t\t\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>\t\t\t\t<span class=\"token keyword\">else</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>\t\t\t\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre>\t\t\t\t\t<span class=\"token comment\">// 不需要修复的值。 什么都不做就行。</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>\t\t\t\t\t<span class=\"token comment\">//DbgPrint(\"FixAddress to Old Kernel:[%X]\\t\\n\", *pRepairAddr);</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre>\t\t\t\t\t<span class=\"token operator\">*</span>pRepairAddr <span class=\"token operator\">+=</span> KernelBase <span class=\"token operator\">-</span> pOptionHeader<span class=\"token operator\">-></span>ImageBase<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre>\t\t\t\t\t<span class=\"token comment\">//Items++;</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>\t\t\t\t\t<span class=\"token comment\">//Items2++;</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre>\t\t\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre></pre></td></tr><tr><td data-num=\"59\"></td><td><pre>\t\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre>\t\t\tpRelocationArray<span class=\"token operator\">++</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"61\"></td><td><pre>\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"62\"></td><td><pre>\t\tpReloc <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>PIMAGE_BASE_RELOCATION<span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>ULONG<span class=\"token punctuation\">)</span>pReloc <span class=\"token operator\">+</span> pReloc<span class=\"token operator\">-></span>SizeOfBlock<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"63\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"64\"></td><td><pre>\t<span class=\"token comment\">//DbgPrint(\"Items: [%X],Items1: [%X], Items2: [%X]\\t\\n\", Items, Items1, Items2);</span></pre></td></tr><tr><td data-num=\"65\"></td><td><pre>\t<span class=\"token keyword\">return</span> status<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"66\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h3 id=\"修复iat\"><a class=\"anchor\" href=\"#修复iat\">#</a> 修复 IAT</h3>\n<p>在内核中获取模块基址，还是通过  <code>LDR_DATA_TABLE_ENTRY</code>  结构体遍历获取，这里我直接搬运了一位大佬的代码，设计的太好了。</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">typedef</span> <span class=\"token keyword\">struct</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>\t<span class=\"token keyword\">union</span> OD_OR_NAME</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>\t\tCHAR<span class=\"token operator\">*</span> Name<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>\t\tUSHORT Od<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token punctuation\">&#125;</span>EXP_FUN_NAME<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token comment\">//API 导出模式</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token keyword\">typedef</span> <span class=\"token keyword\">enum</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>\tNameFlag <span class=\"token operator\">=</span> <span class=\"token number\">0x1</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>\tOrderFlag <span class=\"token operator\">=</span> <span class=\"token number\">0x2</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token punctuation\">&#125;</span>EXP_FUN_MODE<span class=\"token punctuation\">;</span></pre></td></tr></table></figure><hr />\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>NTSTATUS <span class=\"token function\">GetFunAddrOfModule</span><span class=\"token punctuation\">(</span>IN PVOID pModule<span class=\"token punctuation\">,</span> IN EXP_FUN_NAME unFuntionName<span class=\"token punctuation\">,</span> IN EXP_FUN_MODE eMode<span class=\"token punctuation\">,</span> OUT PULONG FuncAddress<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>\t<span class=\"token comment\">//__asm int 3;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>\tNTSTATUS status <span class=\"token operator\">=</span> STATUS_SUCCESS<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>\t<span class=\"token comment\">// PE 查找导出表</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>\tPIMAGE_DOS_HEADER pDosHeader <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>PIMAGE_DOS_HEADER<span class=\"token punctuation\">)</span>pModule<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>\t<span class=\"token comment\">//DbgPrint(\"pDosHeader:%X\\t\\n\", pDosHeader);</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\tPIMAGE_NT_HEADERS pNtHeader <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>PIMAGE_NT_HEADERS<span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span>pDosHeader<span class=\"token operator\">-></span>e_lfanew <span class=\"token operator\">+</span> <span class=\"token punctuation\">(</span>ULONG<span class=\"token punctuation\">)</span>pModule<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\t<span class=\"token comment\">//DbgPrint(\"pNtHeader:%X\\t\\n\", pNtHeader);</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>\tPIMAGE_FILE_HEADER pFileHeader <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>PIMAGE_FILE_HEADER<span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>ULONG<span class=\"token punctuation\">)</span>pNtHeader <span class=\"token operator\">+</span> <span class=\"token number\">4</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>\t<span class=\"token comment\">//DbgPrint(\"pFileHeader:%X\\t\\n\", pFileHeader);</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>\tPIMAGE_OPTIONAL_HEADER pOptionHeader <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>PIMAGE_OPTIONAL_HEADER<span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>ULONG<span class=\"token punctuation\">)</span>pFileHeader <span class=\"token operator\">+</span> <span class=\"token punctuation\">(</span>ULONG<span class=\"token punctuation\">)</span>IMAGE_SIZEOF_FILE_HEADER<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>\t<span class=\"token comment\">//DbgPrint(\"pOptionHeader:%X\\t\\n\", pOptionHeader);</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>\tPIMAGE_DATA_DIRECTORY pDirectory <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>PIMAGE_DATA_DIRECTORY<span class=\"token punctuation\">)</span>pOptionHeader<span class=\"token operator\">-></span>DataDirectory<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>\t<span class=\"token comment\">//DbgPrint(\"pDirectory:%X\\t\\n\", pDirectory);</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>\tPIMAGE_EXPORT_DIRECTORY pExportTabel <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>PIMAGE_EXPORT_DIRECTORY<span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>ULONG<span class=\"token punctuation\">)</span>pModule <span class=\"token operator\">+</span> pOptionHeader<span class=\"token operator\">-></span>DataDirectory<span class=\"token punctuation\">[</span>IMAGE_DIRECTORY_ENTRY_EXPORT<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>VirtualAddress<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>\t<span class=\"token comment\">//DbgPrint(\"pExportTabel:%X\\t\\n\", pExportTabel);</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre></pre></td></tr><tr><td data-num=\"20\"></td><td><pre></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>\t<span class=\"token comment\">//__asm int 3;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>\tPULONG dwNameTable <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>PULONG<span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>ULONG<span class=\"token punctuation\">)</span>pModule <span class=\"token operator\">+</span> <span class=\"token punctuation\">(</span>pExportTabel<span class=\"token operator\">-></span>AddressOfNames<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>\tPUSHORT wOrdinalsTable <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>PUSHORT<span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>ULONG<span class=\"token punctuation\">)</span>pModule <span class=\"token operator\">+</span> <span class=\"token punctuation\">(</span>pExportTabel<span class=\"token operator\">-></span>AddressOfNameOrdinals<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>\tPULONG dwAddressTable <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>PULONG<span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>ULONG<span class=\"token punctuation\">)</span>pModule <span class=\"token operator\">+</span> <span class=\"token punctuation\">(</span>pExportTabel<span class=\"token operator\">-></span>AddressOfFunctions<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"29\"></td><td><pre>\t<span class=\"token keyword\">int</span> i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>eMode <span class=\"token operator\">==</span> NameFlag<span class=\"token punctuation\">)</span><span class=\"token comment\">// 按名称导出</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>\t\t<span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span>i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span>pExportTabel<span class=\"token operator\">-></span>NumberOfNames<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token operator\">++</span>i<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>\t\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>\t\t\tCHAR<span class=\"token operator\">*</span> cImportName <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>CHAR<span class=\"token operator\">*</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>ULONG<span class=\"token punctuation\">)</span>pModule <span class=\"token operator\">+</span> dwNameTable<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>\t\t\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">strcmp</span><span class=\"token punctuation\">(</span>cImportName<span class=\"token punctuation\">,</span> unFuntionName<span class=\"token punctuation\">.</span>Name<span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>\t\t\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>\t\t\t\t<span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>\t\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>\t\t<span class=\"token operator\">*</span>FuncAddress <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>ULONG<span class=\"token punctuation\">)</span>pModule <span class=\"token operator\">+</span> dwAddressTable<span class=\"token punctuation\">[</span>wOrdinalsTable<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>\t<span class=\"token keyword\">else</span><span class=\"token comment\">// 按序号导出</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>\t\t<span class=\"token operator\">*</span>FuncAddress <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>ULONG<span class=\"token punctuation\">)</span>pModule <span class=\"token operator\">+</span> dwAddressTable<span class=\"token punctuation\">[</span><span class=\"token punctuation\">(</span>unFuntionName<span class=\"token punctuation\">.</span>Od<span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span> <span class=\"token punctuation\">(</span>pExportTabel<span class=\"token operator\">-></span>Base<span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">*</span>FuncAddress <span class=\"token operator\">!=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre>\t\t<span class=\"token keyword\">return</span> STATUS_SUCCESS<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre>\t<span class=\"token keyword\">else</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>\t\t<span class=\"token keyword\">return</span> STATUS_UNSUCCESSFUL<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><hr />\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>NTSTATUS <span class=\"token function\">RepairIAT</span><span class=\"token punctuation\">(</span>IN PDRIVER_OBJECT pDriver<span class=\"token punctuation\">,</span> IN OUT PVOID pKernelImageBuffer<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>\tNTSTATUS status <span class=\"token operator\">=</span> STATUS_SUCCESS<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>\t<span class=\"token comment\">// PE 头 定位大导入表  IAT 表</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>\tPIMAGE_DOS_HEADER pDosHeader <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>PIMAGE_DOS_HEADER<span class=\"token punctuation\">)</span>pKernelImageBuffer<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>\tPIMAGE_NT_HEADERS pNtHeader <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>PIMAGE_NT_HEADERS<span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span>pDosHeader<span class=\"token operator\">-></span>e_lfanew <span class=\"token operator\">+</span> <span class=\"token punctuation\">(</span>ULONG<span class=\"token punctuation\">)</span>pDosHeader<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>\tPIMAGE_OPTIONAL_HEADER pOptionHeader <span class=\"token operator\">=</span> <span class=\"token operator\">&amp;</span>pNtHeader<span class=\"token operator\">-></span>OptionalHeader<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\tPIMAGE_IMPORT_DESCRIPTOR pImportTable <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>PIMAGE_IMPORT_DESCRIPTOR<span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>ULONG<span class=\"token punctuation\">)</span>pDosHeader <span class=\"token operator\">+</span> pOptionHeader<span class=\"token operator\">-></span>DataDirectory<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>VirtualAddress<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>\t\t</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>\t<span class=\"token comment\">// 遍历 INT 表</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>\t<span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span>pImportTable<span class=\"token operator\">-></span>OriginalFirstThunk <span class=\"token operator\">||</span> pImportTable<span class=\"token operator\">-></span>FirstThunk<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>\t\t<span class=\"token comment\">// 在里面定义，变量的值每次都会重新设置为空</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>\t\t<span class=\"token comment\">// 模块基址</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>\t\tPVOID pModuleBase <span class=\"token operator\">=</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>\t\t<span class=\"token comment\">// 模块名字</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>\t\tCHAR szName<span class=\"token punctuation\">[</span><span class=\"token number\">0x50</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span> <span class=\"token number\">0</span> <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>\t\tANSI_STRING asName <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span> <span class=\"token number\">0</span> <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>\t\tUNICODE_STRING usName <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span> <span class=\"token number\">0</span> <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre></pre></td></tr><tr><td data-num=\"24\"></td><td><pre></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>\t\t<span class=\"token comment\">// 获取模块名，由模块名字获取模块基址</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>\t\tPCHAR MdName <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>PCHAR<span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span>pImportTable<span class=\"token operator\">-></span>Name <span class=\"token operator\">+</span> <span class=\"token punctuation\">(</span>ULONG<span class=\"token punctuation\">)</span>pDosHeader<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>\t\t<span class=\"token function\">memcpy</span><span class=\"token punctuation\">(</span>szName<span class=\"token punctuation\">,</span> MdName<span class=\"token punctuation\">,</span> <span class=\"token function\">strlen</span><span class=\"token punctuation\">(</span>MdName<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>\t\t<span class=\"token function\">RtlInitAnsiString</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>asName<span class=\"token punctuation\">,</span> szName<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>\t\tstatus <span class=\"token operator\">=</span> <span class=\"token function\">RtlAnsiStringToUnicodeString</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>usName<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>asName<span class=\"token punctuation\">,</span> TRUE<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>\t\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token function\">NT_SUCCESS</span><span class=\"token punctuation\">(</span>status<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>\t\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>\t\t\t<span class=\"token function\">DbgPrint</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"RtlAnsiStringToUnicodeString failed!\\t\\n\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>\t\t\t<span class=\"token keyword\">return</span> status<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>\t\t<span class=\"token comment\">//DbgPrint(\"usName:%ws\\t\\n\", usName.Buffer);</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>\t\t<span class=\"token comment\">// 获取模块基址</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>\t\tstatus <span class=\"token operator\">=</span> <span class=\"token function\">GetModuleBase</span><span class=\"token punctuation\">(</span>pDriver<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>usName<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>pModuleBase<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>\t\t</pre></td></tr><tr><td data-num=\"41\"></td><td><pre>\t\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token function\">NT_SUCCESS</span><span class=\"token punctuation\">(</span>status<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>\t\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>\t\t\t<span class=\"token function\">RtlFreeUnicodeString</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>usName<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>\t\t\t<span class=\"token function\">DbgPrint</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"GetModuleBase failed!\\t\\n\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>\t\t\t<span class=\"token keyword\">return</span> status<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>\t\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token constant\">NULL</span> <span class=\"token operator\">==</span> pModuleBase<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>\t\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>\t\t\t<span class=\"token function\">RtlFreeUnicodeString</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>usName<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>\t\t\t<span class=\"token function\">DbgPrint</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"ModuleBase = 0 !\\t\\n\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre>\t\t\t<span class=\"token keyword\">return</span> STATUS_UNSUCCESSFUL<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre></pre></td></tr><tr><td data-num=\"55\"></td><td><pre>\t\t<span class=\"token comment\">// 修复 IAT 表</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre></pre></td></tr><tr><td data-num=\"57\"></td><td><pre>\t\tPIMAGE_THUNK_DATA32 pThunkData <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>PIMAGE_THUNK_DATA32<span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>ULONG<span class=\"token punctuation\">)</span>pKernelImageBuffer <span class=\"token operator\">+</span> pImportTable<span class=\"token operator\">-></span>FirstThunk<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre></pre></td></tr><tr><td data-num=\"59\"></td><td><pre>\t\t<span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">*</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>PULONG<span class=\"token punctuation\">)</span>pThunkData<span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre>\t\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"61\"></td><td><pre>\t\t\tEXP_FUN_NAME emFunName <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span> <span class=\"token number\">0</span> <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"62\"></td><td><pre>\t\t\tULONG dwProcAddress <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"63\"></td><td><pre></pre></td></tr><tr><td data-num=\"64\"></td><td><pre>\t\t\t<span class=\"token comment\">//__asm int 3;</span></pre></td></tr><tr><td data-num=\"65\"></td><td><pre>\t\t\t<span class=\"token comment\">// IMAGE_THUNK_DATA32 是一个 4 字节数据</span></pre></td></tr><tr><td data-num=\"66\"></td><td><pre>\t\t\t<span class=\"token comment\">// 如果最高位是 1，那么除去最高位就是导出序号</span></pre></td></tr><tr><td data-num=\"67\"></td><td><pre>\t\t\t<span class=\"token comment\">// 如果最高位是 0，那么这个值是 RVA 指向 IMAGE_IMPORT_BY_NAME</span></pre></td></tr><tr><td data-num=\"68\"></td><td><pre>\t\t\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token operator\">*</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>PULONG<span class=\"token punctuation\">)</span>pThunkData<span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;</span> <span class=\"token number\">0x80000000</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> <span class=\"token number\">0x80000000</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"69\"></td><td><pre>\t\t\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"70\"></td><td><pre>\t\t\t\temFunName<span class=\"token punctuation\">.</span>Od <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">*</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>PULONG<span class=\"token punctuation\">)</span>pThunkData<span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;</span> <span class=\"token number\">0x7FFFFFFF</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"71\"></td><td><pre>\t\t\t\tstatus <span class=\"token operator\">=</span> <span class=\"token function\">GetFunAddrOfModule</span><span class=\"token punctuation\">(</span>pModuleBase<span class=\"token punctuation\">,</span> emFunName<span class=\"token punctuation\">,</span> OrderFlag<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>dwProcAddress<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"72\"></td><td><pre>\t\t\t\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token function\">NT_SUCCESS</span><span class=\"token punctuation\">(</span>status<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"73\"></td><td><pre>\t\t\t\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"74\"></td><td><pre>\t\t\t\t\t<span class=\"token function\">RtlFreeUnicodeString</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>usName<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"75\"></td><td><pre>\t\t\t\t\t<span class=\"token function\">DbgPrint</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"1 GetFunAddrOfModule failed !\\t\\n\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"76\"></td><td><pre>\t\t\t\t\t<span class=\"token keyword\">return</span> STATUS_UNSUCCESSFUL<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"77\"></td><td><pre>\t\t\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"78\"></td><td><pre>\t\t\t\t<span class=\"token comment\">//DbgPrint(\"1 dwProcAddress:%X\\t\\n\", dwProcAddress);</span></pre></td></tr><tr><td data-num=\"79\"></td><td><pre>\t\t\t\t<span class=\"token operator\">*</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>PULONG<span class=\"token punctuation\">)</span>pThunkData<span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span> dwProcAddress<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"80\"></td><td><pre>\t\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"81\"></td><td><pre>\t\t\t<span class=\"token keyword\">else</span></pre></td></tr><tr><td data-num=\"82\"></td><td><pre>\t\t\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"83\"></td><td><pre>\t\t\t\tPIMAGE_IMPORT_BY_NAME pIBN <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>PIMAGE_IMPORT_BY_NAME<span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span><span class=\"token operator\">*</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>PULONG<span class=\"token punctuation\">)</span>pThunkData<span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> <span class=\"token punctuation\">(</span>ULONG<span class=\"token punctuation\">)</span>pKernelImageBuffer<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"84\"></td><td><pre></pre></td></tr><tr><td data-num=\"85\"></td><td><pre>\t\t\t\t<span class=\"token comment\">// 按名字导入</span></pre></td></tr><tr><td data-num=\"86\"></td><td><pre></pre></td></tr><tr><td data-num=\"87\"></td><td><pre>\t\t\t\temFunName<span class=\"token punctuation\">.</span>Name <span class=\"token operator\">=</span> pIBN<span class=\"token operator\">-></span>Name<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"88\"></td><td><pre>\t\t\t\tstatus <span class=\"token operator\">=</span> <span class=\"token function\">GetFunAddrOfModule</span><span class=\"token punctuation\">(</span>pModuleBase<span class=\"token punctuation\">,</span> emFunName<span class=\"token punctuation\">,</span> NameFlag<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>dwProcAddress<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"89\"></td><td><pre>\t\t\t\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token function\">NT_SUCCESS</span><span class=\"token punctuation\">(</span>status<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"90\"></td><td><pre>\t\t\t\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"91\"></td><td><pre>\t\t\t\t\t<span class=\"token function\">RtlFreeUnicodeString</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>usName<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"92\"></td><td><pre>\t\t\t\t\t<span class=\"token function\">DbgPrint</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"2 GetFunAddrOfModule failed !\\t\\n\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"93\"></td><td><pre>\t\t\t\t\t<span class=\"token keyword\">return</span> STATUS_UNSUCCESSFUL<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"94\"></td><td><pre>\t\t\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"95\"></td><td><pre>\t\t\t\t<span class=\"token comment\">//DbgPrint(\"2 dwProcAddress:%X\\t\\n\", dwProcAddress);</span></pre></td></tr><tr><td data-num=\"96\"></td><td><pre>\t\t\t\t<span class=\"token operator\">*</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>PULONG<span class=\"token punctuation\">)</span>pThunkData<span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span> dwProcAddress<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"97\"></td><td><pre>\t\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"98\"></td><td><pre>\t\t\tpThunkData<span class=\"token operator\">++</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"99\"></td><td><pre>\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"100\"></td><td><pre>\t\tpImportTable <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>PIMAGE_IMPORT_DESCRIPTOR<span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>ULONG<span class=\"token punctuation\">)</span>pImportTable <span class=\"token operator\">+</span> <span class=\"token keyword\">sizeof</span><span class=\"token punctuation\">(</span>IMAGE_IMPORT_DESCRIPTOR<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"101\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"102\"></td><td><pre></pre></td></tr><tr><td data-num=\"103\"></td><td><pre>\t<span class=\"token keyword\">return</span> status<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"104\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h2 id=\"第三步让操作系统走我们新内核文件的函数\"><a class=\"anchor\" href=\"#第三步让操作系统走我们新内核文件的函数\">#</a> 第三步：让操作系统走我们新内核文件的函数</h2>\n<p>初始化新加载的内核的系统服务表</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>PKSYSTEM_SERVICE_TABLE <span class=\"token function\">InitNewSSDT</span><span class=\"token punctuation\">(</span>IN PVOID pKernelImageBuffer<span class=\"token punctuation\">,</span> IN ULONG uKernelOldBase<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>\t<span class=\"token comment\">// 新内核地址 - 老内核地址，得到相对偏移</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>\tULONG uNewKernelInc <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>ULONG<span class=\"token punctuation\">)</span>pKernelImageBuffer <span class=\"token operator\">-</span> uKernelOldBase<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>\t<span class=\"token comment\">//DbgPrint(\"KeServiceDescriptorTable: [%X]\\r\\n\", KeServiceDescriptorTable);</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>\t<span class=\"token comment\">//DbgPrint(\"pKernelImageBuffer: [%X]\\r\\n\", pKernelImageBuffer);</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>\t<span class=\"token comment\">//DbgPrint(\"uKernelOldBase: [%X]\\r\\n\", uKernelOldBase);</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\t<span class=\"token comment\">//DbgPrint(\"uNewKernelInc: [%X]\\r\\n\", uNewKernelInc);</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\t<span class=\"token comment\">// __asm int 3;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre></pre></td></tr><tr><td data-num=\"12\"></td><td><pre></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>\t<span class=\"token comment\">// 老内核的 ssdt 指针加上相对偏移，得到新内核的 ssdt 指针</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>\tPKSYSTEM_SERVICE_TABLE pNewSSDT <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>PKSYSTEM_SERVICE_TABLE<span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>ULONG<span class=\"token punctuation\">)</span>KeServiceDescriptorTable <span class=\"token operator\">+</span> uNewKernelInc<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre></pre></td></tr><tr><td data-num=\"17\"></td><td><pre></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token function\">MmIsAddressValid</span><span class=\"token punctuation\">(</span>pNewSSDT<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>\t\t<span class=\"token function\">DbgPrint</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"pNewSSDT is unaviable!\\r\\n\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>\t\t<span class=\"token keyword\">return</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre></pre></td></tr><tr><td data-num=\"24\"></td><td><pre></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>\t<span class=\"token comment\">// 修正新的 SSDT 成员</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>\t<span class=\"token comment\">// 函数地址表</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>\tpNewSSDT<span class=\"token operator\">-></span>ServiceTableBase <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>PULONG<span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>ULONG<span class=\"token punctuation\">)</span>pKernelImageBuffer <span class=\"token operator\">+</span> <span class=\"token punctuation\">(</span>ULONG<span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span>KeServiceDescriptorTable<span class=\"token operator\">-></span>ServiceTableBase<span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span> uKernelOldBase <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>\t<span class=\"token comment\">// 依次遍历修改</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>\t<span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span>ULONG uIndex <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> uIndex <span class=\"token operator\">&lt;</span> KeServiceDescriptorTable<span class=\"token operator\">-></span>NumberOfServices<span class=\"token punctuation\">;</span> uIndex<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>\t\t<span class=\"token comment\">// 函数地址再加上相对加载地址，得到新的的 ssdt 函数地址</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>\t\tpNewSSDT<span class=\"token operator\">-></span>ServiceTableBase<span class=\"token punctuation\">[</span>uIndex<span class=\"token punctuation\">]</span> <span class=\"token operator\">+=</span> uNewKernelInc<span class=\"token punctuation\">;</span>\t\t</pre></td></tr><tr><td data-num=\"35\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token function\">MmIsAddressValid</span><span class=\"token punctuation\">(</span>pNewSSDT<span class=\"token operator\">-></span>ServiceTableBase<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>\t\t<span class=\"token function\">DbgPrint</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"pNewSSDT->ServiceTableBase: %X\\r\\n\"</span><span class=\"token punctuation\">,</span> pNewSSDT<span class=\"token operator\">-></span>ServiceTableBase<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>\t\t<span class=\"token keyword\">return</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>\t<span class=\"token comment\">// 函数数量</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>\tpNewSSDT<span class=\"token operator\">-></span>NumberOfServices <span class=\"token operator\">=</span> KeServiceDescriptorTable<span class=\"token operator\">-></span>NumberOfServices<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>\t<span class=\"token comment\">// 计算相对函数参数地址表的偏移</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>\tULONG uOffset2 <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>ULONG<span class=\"token punctuation\">)</span>KeServiceDescriptorTable<span class=\"token operator\">-></span>ParamTableBase <span class=\"token operator\">-</span> uKernelOldBase<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"49\"></td><td><pre>\t<span class=\"token comment\">// 函数参数表</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>\tpNewSSDT<span class=\"token operator\">-></span>ParamTableBase <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>PULONG<span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>ULONG<span class=\"token punctuation\">)</span>pKernelImageBuffer <span class=\"token operator\">+</span> uOffset2<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre></pre></td></tr><tr><td data-num=\"52\"></td><td><pre>\t<span class=\"token comment\">//DbgPrint(\"pNewSSDT->ServiceTableBase: %X\\r\\n\", pNewSSDT->ServiceTableBase);</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>\t<span class=\"token comment\">//DbgPrint(\"pNewSSDT->NumberOfServices: %X\\r\\n\", pNewSSDT->NumberOfServices);</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre>\t<span class=\"token comment\">//DbgPrint(\"pNewSSDT->ParamTableBase: %X\\r\\n\", pNewSSDT->ParamTableBase);</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>\t<span class=\"token comment\">//__asm int 3;</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre>\t<span class=\"token keyword\">return</span> pNewSSDT<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>Hook KiFastCallEntry 让系统调用走我们的系统服务表。</p>\n<p>代码懒得放了，附上 Github 的链接： <span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL09yMGtpdC9YcEtlcm5lbE92ZXJsb2Fk\">https://github.com/Or0kit/XpKernelOverload</span></p>\n<h2 id=\"验证是否成功\"><a class=\"anchor\" href=\"#验证是否成功\">#</a> 验证是否成功</h2>\n<p>我在  <code>SSDTFilter</code>  函数中下了断点，并且验证了是否是  <code>NtOpenProcess</code>  函数</p>\n<p><img data-src=\"image001.png\" alt=\"\" /></p>\n<p>可以发现已经过滤了其他函数，我们只让这个函数走我们新内核中的代码。</p>\n<p><strong>一定得注意，不同的 Windows 它们 SSDT 中的函数的序号是不一样的！在 XP sp3 中  <code>NtOpenProcess</code>  是 0x7A。</strong></p>\n<p>然后我们在 Windbg 中找到我们内核的  <code>NtOpenProcess</code>  函数的地址，然后给这个函数下断点，以此验证是否执行到新内核中：</p>\n<p><img data-src=\"image002.png\" alt=\"\" /></p>\n<p>如图，已经断下来了！</p>\n<p>接下来我们在验证一下是否能过所有 Hook:</p>\n<p>我这里先加载了一个 Hook 了  <code>NtOpenProcess</code>  的驱动，其作用是一直打印  <code>NtOpenProcess</code>  的参数：</p>\n<p><img data-src=\"image003.png\" alt=\"\" /></p>\n<p>然后我们加载重载内核的代码（我在其中下了断点）,</p>\n<p>先看一下 Hook  <code>NtOpenProcess</code>  的代码：</p>\n<p><img data-src=\"image004.png\" alt=\"\" /></p>\n<p>这是断下来时打印的信息：</p>\n<p><img data-src=\"image005.png\" alt=\"\" /></p>\n<p>很明显当调用号是 0x7A 时 系统回去执行我们的 HOOK 函数。</p>\n<p>但是我们重载了内核后，就可以过滤掉这些 HOOK 了！</p>\n<p><img data-src=\"image006.png\" alt=\"\" /></p>\n<p>接着验证一下 OpenProcess 函数的正常使用：</p>\n<p><img data-src=\"image007.png\" alt=\"\" /></p>\n<p>我用 OD 附加了记事本，用 StudyPE+ 载入了进程中的记事本文件，均正常！</p>\n<p>至此内核重载完成。</p>\n<h1 id=\"reference\"><a class=\"anchor\" href=\"#reference\">#</a> Reference</h1>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9iYnMucGVkaXkuY29tL3RocmVhZC0yNTM0MjUuaHRt\">https://bbs.pediy.com/thread-253425.htm</span><br />\n<span class=\"exturl\" data-url=\"aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3doYXRkYXkvYXJ0aWNsZS9kZXRhaWxzLzE0MTYwODc1\">https://blog.csdn.net/whatday/article/details/14160875</span></p>\n",
            "tags": [
                "内核重载"
            ]
        },
        {
            "id": "https://or0kit.github.io/Bin/Core/WindowsXp/MultiCoreSynchronization/%E5%A4%9A%E6%A0%B8%E5%90%8C%E6%AD%A5-01%E4%B8%B4%E7%95%8C%E5%8C%BA%E4%B8%8E%E8%87%AA%E6%97%8B%E9%94%81/",
            "url": "https://or0kit.github.io/Bin/Core/WindowsXp/MultiCoreSynchronization/%E5%A4%9A%E6%A0%B8%E5%90%8C%E6%AD%A5-01%E4%B8%B4%E7%95%8C%E5%8C%BA%E4%B8%8E%E8%87%AA%E6%97%8B%E9%94%81/",
            "title": "多核同步-01临界区与自旋锁",
            "date_published": "2022-03-13T12:35:28.000Z",
            "content_html": "<h1 id=\"楔子\"><a class=\"anchor\" href=\"#楔子\">#</a> 楔子</h1>\n<p>并发执行的定义是，多个程序在一段重叠的时间段中开始、运行与结束，但这些程序并没有在任何一个时刻同时在执行。<br />\n并行执行，则意味着在同一个时刻，存在两个以上任务在同时运行。</p>\n<p>单核（是分时执行，不是真正的同时）</p>\n<p>多核（在某一个时刻，会同时有多个线程再执行）</p>\n<p>同步则是保证在并发执行的环境中各个线程可以有序的执行为了实现</p>\n<p><strong>只要提到并发就是多个线程操纵同一个资源的问题。</strong><br />\n有些指令是可以在多核下执行的，并不会影响什么，如读的操作，但是写就不行了，必须得保证有序。</p>\n<p>疑问：单核同步与多核同步一样吗？</p>\n<h1 id=\"临界区\"><a class=\"anchor\" href=\"#临界区\">#</a> 临界区</h1>\n<p>为什么要引入临界区呢？看一下以下代码</p>\n<h2 id=\"演示代码\"><a class=\"anchor\" href=\"#演示代码\">#</a> 演示代码</h2>\n<p><code>DWORD  dwVal = 0;</code> \t// 全局变量</p>\n<p>线程中的代码：</p>\n<p><code>dwVal ++;</code> \t// 只有一行  安全吗？</p>\n<p>因为 CPU 执行的是汇编指令，以上高级语言对应的汇编代码如下：</p>\n<figure class=\"highlight raw\"><figcaption data-lang=\"\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>mov\teax,[0x12345678]</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>add\teax,1</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>mov\t[0x12345678],eax</pre></td></tr></table></figure><p>这些汇编代码是不安全的。不论是单核还是多核，在多线程下，不同的线程抢占时间片，以上代码就会出现执行顺序的错乱。</p>\n<h2 id=\"原子操作\"><a class=\"anchor\" href=\"#原子操作\">#</a> 原子操作</h2>\n<p><strong>所谓原子操作是指不会被线程调度机制打断的操作；</strong><br />\n<strong>这种操作一旦开始，就一直运行到结束，中间不会有任何 context switch （切换到另一个线程）。</strong></p>\n<p>LOCK 指令可以将将指令转换为原子指令。</p>\n<p><code>INC DWORD PTR DS:[0x12345678]</code> \t一行汇编代码，安全吗？</p>\n<p>这样一行指令在单核下是安全的，在多核下并不安全。</p>\n<p>改成</p>\n<p><code>LOCK INC DWORD PTR DS:[0x12345678]</code></p>\n<p>这样，这行指令就变成的原子指令，当一个核正在读取这个指令时其他核就不能读取这条指令了。</p>\n<p>查看 kernel32 中的  <code>InterlockedIncrement</code></p>\n<figure class=\"highlight raw\"><figcaption data-lang=\"\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>LONG __stdcall InterlockedIncrement (volatile LONG *lpAddend)</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>public _InterlockedIncrement@4</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>_InterlockedIncrement@4 proc near       ; </pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>lpAddend        &#x3D; dword ptr  4</pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>mov     ecx, [esp+lpAddend] ; 获取加数变量的指针</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>mov     eax, 1          ; 设置增量值</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>lock xadd [ecx], eax    ; interlocked increment    联锁增量</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>inc     eax             ; 调整返回值</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>retn    4</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>_InterlockedIncrement@4 endp</pre></td></tr></table></figure><p><strong>xadd 指令将第一个操作数 (目标操作数) 与第二个操作数 (源操作数) 交换，然后将两个值的和加载到目标操作数中，该指令可以与 LOCK 前缀一起使用，允许该指令以原子方式执行。</strong></p>\n<p>原子操作相关的 API：</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>InterlockedIncrement</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>InterlockedExchangeAdd</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>InterlockedDecrement</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>InterlockedFlushSList</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>InterlockedExchange</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>InterlockedPopEntrySList</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>InterlockedCompareExchange</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>InterlockedPushEntrySList</pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span></pre></td></tr></table></figure><p><strong>什么时候加锁：我们只有一行代码是担心多核同时访问的，其他的代码多核访问并不影响！</strong></p>\n<h2 id=\"自己实现临界区\"><a class=\"anchor\" href=\"#自己实现临界区\">#</a> 自己实现临界区</h2>\n<p>如果执行多行原子指令安全吗？如下的场景：</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>关键代码A\t<span class=\"token comment\">//N 行代码要求原子操作</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>关键代码B\t<span class=\"token comment\">// 单独加 LOCK 可以吗？</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>关键代码C</pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span></pre></td></tr></table></figure><p>其实也不安全，当执行完第一行指令后，线程是可以被切换的，还是无法保证其执行的顺序。</p>\n<p>如何保证执行完这些代码后才让其他核继续执行呢？</p>\n<p>这就要设计一个临界区了。</p>\n<p><strong>临界区：一次只允许一个线程进入直到离开。</strong></p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>DWORD dwFlag <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\t<span class=\"token comment\">// 实现临界区的方式就是加锁</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>                  <span class=\"token comment\">// 锁：全局变量  进去加一 出去减一</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>dwFlag  <span class=\"token operator\">==</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span>\t\t<span class=\"token comment\">// 进入临界区\t</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">&#123;</span>\t</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>\tdwFlag   <span class=\"token operator\">=</span> <span class=\"token number\">1</span>\t</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>\t<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>\t<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\t<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\t\t</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>\tdwFlag   <span class=\"token operator\">=</span> <span class=\"token number\">0</span>\t<span class=\"token comment\">// 离开临界区</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>这样设计也不是安全的，因为是先判断再修改的 dwFlag ，进入临界区后在还没有修改 dwflag 为 1 时线程被切走了，就不行了，另一个线程也可以进入临界区了等等，会造成一些列问题。</p>\n<p>之前利用互斥体、事件、信号量等等在多核的情况下也是安全的因为把线程都挂起了，只是效率不高罢了。</p>\n<p>临界区是只要保证一次就只有一个线程进入就行，怎么实现的都行！</p>\n<p>在单核的情况下实现临界区：</p>\n<figure class=\"highlight raw\"><figcaption data-lang=\"\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>全局变量：Flag &#x3D; 0</pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>进入临界区：\t\t</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>Lab：</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>\tmov eax,1</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>\txadd [Flag],eax</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>\tcmp eax,0</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>\tjz endLab</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\tdec [Flag]</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\t&#x2F;&#x2F; 线程等待 Sleep..</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>endLab:</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>\tret</pre></td></tr><tr><td data-num=\"13\"></td><td><pre></pre></td></tr><tr><td data-num=\"14\"></td><td><pre></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>离开临界区：</pre></td></tr><tr><td data-num=\"16\"></td><td><pre></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>dec [Flag]</pre></td></tr></table></figure><p>以上代码在单核下是安全的，想要在多核下也是安全的，就要加 lock 指令了：</p>\n<figure class=\"highlight raw\"><figcaption data-lang=\"\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>全局变量：Flag &#x3D; 0</pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>进入临界区：\t\t</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>Lab：</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>\tmov eax,1</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>\tlock xadd [Flag],eax</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>\tcmp eax,0</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>\tjz endLab</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\tdec [Flag]</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\t&#x2F;&#x2F; 线程等待 Sleep..</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>endLab:</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>\tret</pre></td></tr><tr><td data-num=\"13\"></td><td><pre></pre></td></tr><tr><td data-num=\"14\"></td><td><pre></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>离开临界区：</pre></td></tr><tr><td data-num=\"16\"></td><td><pre></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>lock dec [Flag]</pre></td></tr></table></figure><h2 id=\"代码实现临界区\"><a class=\"anchor\" href=\"#代码实现临界区\">#</a> 代码实现临界区</h2>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span><span class=\"token string\">&lt;stdio.h></span></span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span><span class=\"token string\">&lt;Windows.h></span></span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">int</span> x <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token comment\">// 实现临界区</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token keyword\">bool</span> g_lock <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token keyword\">void</span> <span class=\"token function\">__declspec</span><span class=\"token punctuation\">(</span>naked<span class=\"token punctuation\">)</span> __fastcall <span class=\"token function\">Enter</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">bool</span><span class=\"token operator\">*</span> Lock<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\t__asm <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>\t__Start<span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>\t\tmov eax<span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>\t\tlock xadd dword ptr <span class=\"token punctuation\">[</span>ecx<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> eax<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>\t\tcmp eax<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>\t\tjnz __Waiting<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>\t\tretn<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>\t__Waiting<span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>\t\tlock dec <span class=\"token punctuation\">[</span>ecx<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>\t\tpush ecx<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>\t\tpush <span class=\"token number\">1</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>\t\tpush <span class=\"token number\">1</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>\t\tcall SleepEx<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>\t\tpop ecx<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>\t\tjmp __Start<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre></pre></td></tr><tr><td data-num=\"29\"></td><td><pre><span class=\"token keyword\">void</span> <span class=\"token function\">__declspec</span><span class=\"token punctuation\">(</span>naked<span class=\"token punctuation\">)</span> __fastcall <span class=\"token function\">Leave</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">bool</span><span class=\"token operator\">*</span> Lock<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>\t__asm <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>\t\tlock dec <span class=\"token punctuation\">[</span>ecx<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>\t\tretn<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre></pre></td></tr><tr><td data-num=\"36\"></td><td><pre><span class=\"token keyword\">void</span> <span class=\"token function\">Func1</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>\t<span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span>size_t i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> <span class=\"token number\">1000000</span><span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>\t\t<span class=\"token function\">Enter</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>g_lock<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>\t\tx<span class=\"token operator\">++</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>\t\t<span class=\"token function\">Leave</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>g_lock<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span>\t</pre></td></tr><tr><td data-num=\"43\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre></pre></td></tr><tr><td data-num=\"45\"></td><td><pre><span class=\"token keyword\">void</span> <span class=\"token function\">Func2</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>\t<span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span>size_t i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> <span class=\"token number\">1000000</span><span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>\t\t<span class=\"token function\">Enter</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>g_lock<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>\t\tx<span class=\"token operator\">++</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>\t\t<span class=\"token function\">Leave</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>g_lock<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre> </pre></td></tr><tr><td data-num=\"54\"></td><td><pre><span class=\"token keyword\">int</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> argc<span class=\"token punctuation\">,</span> <span class=\"token keyword\">char</span><span class=\"token operator\">*</span> argv<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>\t<span class=\"token function\">CreateThread</span><span class=\"token punctuation\">(</span><span class=\"token constant\">NULL</span><span class=\"token punctuation\">,</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span>LPTHREAD_START_ROUTINE<span class=\"token punctuation\">)</span>Func1<span class=\"token punctuation\">,</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">,</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">,</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre>\t<span class=\"token function\">CreateThread</span><span class=\"token punctuation\">(</span><span class=\"token constant\">NULL</span><span class=\"token punctuation\">,</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span>LPTHREAD_START_ROUTINE<span class=\"token punctuation\">)</span>Func2<span class=\"token punctuation\">,</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">,</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">,</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre>\t<span class=\"token function\">system</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"pause\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"59\"></td><td><pre>\t<span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"%d\"</span><span class=\"token punctuation\">,</span> x<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"61\"></td><td><pre>\t<span class=\"token keyword\">return</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"62\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>不加临界区：</p>\n<p><img data-src=\"image001.png\" alt=\"\" /></p>\n<p>加临界区：</p>\n<p><img data-src=\"image002.png\" alt=\"\" /></p>\n<p>这个临界区的设计还是有问题的，就是如果我们执行完 SleepEx 后，进入临界区的线程还没有出来就有问题了。</p>\n<h2 id=\"总结\"><a class=\"anchor\" href=\"#总结\">#</a> 总结</h2>\n<p>xadd 这种指令解决了我们哪些问题？</p>\n<p>为什么要这样设计？</p>\n<p>如果我们用</p>\n<p>LOCK INC DWORD PTR DS:[Flag]<br />\ncmp [Flag],0</p>\n<p>这样是不行了，如果在执行完 inc 后被线程被切换，另一个线程又执行了一遍，，我们是无法保证只有一个线程访问临界区的。</p>\n<p>但如果我们用上面的代码：</p>\n<p>一个线程进来了执行了  <code>xadd</code>  后  <code>eax=0</code>   <code>flag=1</code>  ，假设这个时候被切走了，又一个线程执行这段代码，再次执行  <code>xadd</code>  这时  <code>eax=1</code>  ，也就无法执行后面的代码了，只能在临界区中等待，保证了只有一个线程进入临界区。</p>\n<p>这个等待时间我们自己设置，那么等待多久好呢？等待结束后，还是进不去临界区怎么办呢？或者在等待期间，临界区已经可以进入了，但我们仍处于等待阶段怎么办呢？</p>\n<p>这些问题学完后面的知识就可以解决了。</p>\n<h1 id=\"自旋锁\"><a class=\"anchor\" href=\"#自旋锁\">#</a> 自旋锁</h1>\n<p>上面我们确保临界区的方法是把其他的线程休眠，也就是线程切换，我们了解过线程切换的本质，线程切换是不是太浪费效率了呢？有没有一种轻量级的实现方法呢？</p>\n<p>Windows 设计了自旋锁，查看其 API：</p>\n<figure class=\"highlight raw\"><figcaption data-lang=\"\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>__fastcall KiAcquireSpinLock (x)</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>        public @KiAcquireSpinLock@4</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>        lock bts dword ptr [ecx], 0 ; ecx &#x3D; 参数</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>                                    ; bts 指令：</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>                                    ; 取 [ecx] 二进制比特位的第 0 位，存在 cf 标志位中</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>                                    ; 将 [ecx] 二进制比特位的第 0 位设置为 1</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>        jb      short loc_469B98 ; cf&#x3D;1 时跳转</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>        retn</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>loc_469B98:  </pre></td></tr><tr><td data-num=\"10\"></td><td><pre>        test    dword ptr [ecx], 1 ; 判断参数是否又为 0 了，既判断进入了临界区的线程是否离开了临界区。</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>        jz      short @KiAcquireSpinLock@4 </pre></td></tr><tr><td data-num=\"12\"></td><td><pre>        pause</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>        jmp     short loc_469B98</pre></td></tr></table></figure><p>模拟一下其流程：</p>\n<p><strong>注意是 fastcall 传参。</strong><br />\n<strong>线程第一次执行这个函数时，假设参数是 0，那么执行完  <code>bts</code>  指令后，  <code>CF = 0</code>   参数  <code>x=1</code>  不会跳转，然后线程进入临界。</strong><br />\n<strong>如果在这个线程进入临界区后，其他核的线程又开始执行这个函数，那么此时这个参数就是 1（因为是全局变量），这个时候再执行  <code>bts</code>  指令后  <code>CF=1</code>   <code>x=1</code>  这时会跳转，然后判断参数是否又为 0 了，既判断进入了临界区的线程是否离开了临界区，如果离开了临界区则重新调用该函数，如果没有则执行  <code>pause</code>  指令，该指令会让 cpu 空转一会儿，具体是多少我没找到相关资料，在滴水的视频中，有人说是 20 纳秒，然后就循环判断了，直到可以进入临界区。</strong></p>\n<h2 id=\"自旋锁的优点和缺点\"><a class=\"anchor\" href=\"#自旋锁的优点和缺点\">#</a> 自旋锁的优点和缺点</h2>\n<p>在多核的环境中效率很高，但在单核的环境中不行。</p>\n<h2 id=\"作业\"><a class=\"anchor\" href=\"#作业\">#</a> 作业</h2>\n<p><strong>在内核环境下如何对一个高并发的函数进行 HOOK 而不会出错？</strong></p>\n<p>这个问题的关键是，hook 后一般是 e8 /e9 后跟 4 字节，总共 5 字节，但没办法一次性改 5 个字节，可能改了第一个字节，正要改后 4 个字节时，别的线程进来了，就会出错。</p>\n<p>之前学习的  <code>INLINE HOOK</code>  修改字节的方法是使用  <code>memcpy</code>  这样在内核中 HOOK 一个高并发的函数有很大的几率出错，可能会直接蓝屏。</p>\n<p>在网上看到三种办法：</p>\n<ol>\n<li>短跳中转 利用  <code>EB</code>  指令修改前 2 字节跳到某个长跳的方式。</li>\n<li>中断门 中断门也是只用改两个字节，需要先构造中断门。</li>\n<li>找一条一次性修改 8 字节的指令，这个指令就是  <code>cmpxchg8b</code>  。</li>\n</ol>\n<p>代码实现  <code>INLINE Hook</code>  线程交换的函数  <code>SwapContext</code>  ：</p>\n<p>在  <code>Windbg</code>  中  <code>u SwapContext</code>  得到  <code>SwapContext</code>  函数的地址是   <code>80546bc0</code></p>\n<p>本次 Hook 要用  <code>cmpxchg8b</code>  指令一次性修改 8 个字节，而  <code>SwapContext</code>  函数的前 8 个字节为：</p>\n<figure class=\"highlight raw\"><figcaption data-lang=\"\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>0: kd&gt; u SwapContext</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>nt!SwapContext:</pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>80546bc0 0ac9            or      cl,cl</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>80546bc2 26c6462d02      mov     byte ptr es:[esi+2Dh],2</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>80546bc7 9c              pushfd</pre></td></tr></table></figure><p>既：  <code>0a c9 26 c6 46 2d 02 9c</code></p>\n<p>而我们要使其改为  <code>jmp xxxxxxxx</code>  --&gt;   <code>E9 xxxxxxxx</code></p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">/**</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>**  在多核的环境下 Hook xp sp3 的 SwapContext 函数</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>**/</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span><span class=\"token string\">&lt;ntddk.h></span></span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre> </pre></td></tr><tr><td data-num=\"8\"></td><td><pre>ULONG SwapContextAddress <span class=\"token operator\">=</span> <span class=\"token number\">0x80546bc0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>ULONG NextAddress <span class=\"token operator\">=</span> <span class=\"token number\">0x80546bc8</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>ULONG OldCode<span class=\"token punctuation\">[</span><span class=\"token number\">2</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span> <span class=\"token number\">0</span> <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre></pre></td></tr><tr><td data-num=\"12\"></td><td><pre></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token comment\">// 关闭内存页写入保护</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token keyword\">void</span> <span class=\"token function\">_declspec</span><span class=\"token punctuation\">(</span>naked<span class=\"token punctuation\">)</span> <span class=\"token function\">disablePageWriteProtect</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    _asm</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>        push eax<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>        mov eax<span class=\"token punctuation\">,</span> cr0<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>        <span class=\"token operator\">and</span> eax<span class=\"token punctuation\">,</span> <span class=\"token operator\">~</span><span class=\"token number\">0x10000</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>        mov cr0<span class=\"token punctuation\">,</span> eax<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>        pop eax<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>        ret<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre></pre></td></tr><tr><td data-num=\"27\"></td><td><pre><span class=\"token comment\">// 开启内存页写入保护</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre><span class=\"token keyword\">void</span> <span class=\"token function\">_declspec</span><span class=\"token punctuation\">(</span>naked<span class=\"token punctuation\">)</span> <span class=\"token function\">enablePageWriteProtect</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>    _asm</pre></td></tr><tr><td data-num=\"31\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>        push eax<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>        mov eax<span class=\"token punctuation\">,</span> cr0<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>        <span class=\"token operator\">or</span> eax<span class=\"token punctuation\">,</span> <span class=\"token number\">0x10000</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>        mov cr0<span class=\"token punctuation\">,</span> eax<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>        pop eax<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>        ret<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre></pre></td></tr><tr><td data-num=\"41\"></td><td><pre><span class=\"token comment\">// 打印新线程和老线程的 ETHREAD </span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre><span class=\"token comment\">// </span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>VOID <span class=\"token function\">__declspec</span><span class=\"token punctuation\">(</span>naked<span class=\"token punctuation\">)</span> <span class=\"token function\">MySwapContext</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"45\"></td><td><pre>\t__asm sub esp<span class=\"token punctuation\">,</span> <span class=\"token number\">0x50</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// 提升堆栈，提高容错性。</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"47\"></td><td><pre>\tULONG NewThread<span class=\"token punctuation\">,</span> OldThread<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>\t__asm <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>\t\tmov NewThread<span class=\"token punctuation\">,</span> esi<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>\t\tmov OldThread<span class=\"token punctuation\">,</span> edi<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>NewThread <span class=\"token operator\">!=</span> <span class=\"token constant\">NULL</span> <span class=\"token operator\">||</span> OldThread <span class=\"token operator\">!=</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre>        <span class=\"token function\">DbgPrint</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"New Thread ETHREAD Address:%X,Old Thread ETHREAD Address:%X\\t\\n\"</span><span class=\"token punctuation\">,</span> NewThread<span class=\"token punctuation\">,</span> OldThread<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre></pre></td></tr><tr><td data-num=\"57\"></td><td><pre>\t__asm add esp<span class=\"token punctuation\">,</span> <span class=\"token number\">0x50</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre></pre></td></tr><tr><td data-num=\"59\"></td><td><pre>\t<span class=\"token comment\">// 执行被覆盖的 SwapContext 的代码</span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre>\t__asm <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"61\"></td><td><pre>\t\t<span class=\"token operator\">or</span> cl<span class=\"token punctuation\">,</span> cl<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"62\"></td><td><pre>\t\tmov  byte ptr es <span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>esi <span class=\"token operator\">+</span> <span class=\"token number\">0x2D</span><span class=\"token punctuation\">]</span> <span class=\"token punctuation\">,</span> <span class=\"token number\">2</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"63\"></td><td><pre>\t\tpushfd<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"64\"></td><td><pre>\t\tjmp NextAddress<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"65\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"66\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"67\"></td><td><pre></pre></td></tr><tr><td data-num=\"68\"></td><td><pre></pre></td></tr><tr><td data-num=\"69\"></td><td><pre>VOID <span class=\"token function\">DriverUnload</span><span class=\"token punctuation\">(</span>PDRIVER_OBJECT pDriver<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"70\"></td><td><pre></pre></td></tr><tr><td data-num=\"71\"></td><td><pre>    <span class=\"token comment\">// 0a c9 26 c6 46 2d 02 9c</span></pre></td></tr><tr><td data-num=\"72\"></td><td><pre></pre></td></tr><tr><td data-num=\"73\"></td><td><pre>    OldCode<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token number\">0xC626C90A</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"74\"></td><td><pre>    OldCode<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token number\">0x9C022D46</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"75\"></td><td><pre>    <span class=\"token function\">disablePageWriteProtect</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"76\"></td><td><pre>    _asm <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"77\"></td><td><pre>        pushad<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"78\"></td><td><pre>        pushfd<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"79\"></td><td><pre>        mov esi<span class=\"token punctuation\">,</span> <span class=\"token number\">0x805428E0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"80\"></td><td><pre>        mov edx<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span>esi<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"81\"></td><td><pre>        mov eax<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span>esi <span class=\"token operator\">+</span> <span class=\"token number\">4</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"82\"></td><td><pre>        mov ebx<span class=\"token punctuation\">,</span> OldCode<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"83\"></td><td><pre>        mov ecx<span class=\"token punctuation\">,</span> OldCode<span class=\"token punctuation\">[</span><span class=\"token number\">4</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span><span class=\"token comment\">// 这个必须得填 4</span></pre></td></tr><tr><td data-num=\"84\"></td><td><pre>        lock CMPXCHG8B<span class=\"token punctuation\">[</span>esi<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"85\"></td><td><pre>        popfd<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"86\"></td><td><pre>        popad<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"87\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"88\"></td><td><pre>    <span class=\"token function\">enablePageWriteProtect</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"89\"></td><td><pre>\t<span class=\"token function\">DbgPrint</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"我是驱动，我卸载了\\t\\n\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"90\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"91\"></td><td><pre></pre></td></tr><tr><td data-num=\"92\"></td><td><pre>NTSTATUS <span class=\"token function\">DriverEntry</span><span class=\"token punctuation\">(</span>PDRIVER_OBJECT pDriver<span class=\"token punctuation\">,</span> PUNICODE_STRING pRegPath<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"93\"></td><td><pre>\tpDriver<span class=\"token operator\">-></span>DriverUnload <span class=\"token operator\">=</span> DriverUnload<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"94\"></td><td><pre>\t<span class=\"token function\">DbgPrint</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"我是驱动,我运行了\\t\\n\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"95\"></td><td><pre></pre></td></tr><tr><td data-num=\"96\"></td><td><pre>\t<span class=\"token comment\">// 在 Windbg 中 u SwapContext 得到 SwapContext 函数的地址是  80546bc0</span></pre></td></tr><tr><td data-num=\"97\"></td><td><pre>\t<span class=\"token comment\">//jmpCode  =  目标地址 - 当前地址 - 当前指令长度</span></pre></td></tr><tr><td data-num=\"98\"></td><td><pre>    </pre></td></tr><tr><td data-num=\"99\"></td><td><pre>    <span class=\"token function\">DbgPrint</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"HookSwapContext:%p\\n\"</span><span class=\"token punctuation\">,</span> MySwapContext<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"100\"></td><td><pre></pre></td></tr><tr><td data-num=\"101\"></td><td><pre>    ULONG JmpCode <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>ULONG<span class=\"token punctuation\">)</span>MySwapContext <span class=\"token operator\">-</span> SwapContextAddress <span class=\"token operator\">-</span> <span class=\"token number\">5</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"102\"></td><td><pre>    </pre></td></tr><tr><td data-num=\"103\"></td><td><pre>    <span class=\"token function\">DbgPrint</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"JmpCode:%X\\n\"</span><span class=\"token punctuation\">,</span> JmpCode<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"104\"></td><td><pre>    ULONG Code<span class=\"token punctuation\">[</span><span class=\"token number\">2</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span> <span class=\"token number\">0xE9</span> <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"105\"></td><td><pre></pre></td></tr><tr><td data-num=\"106\"></td><td><pre> </pre></td></tr><tr><td data-num=\"107\"></td><td><pre>    PUCHAR pCode <span class=\"token operator\">=</span> Code<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"108\"></td><td><pre>    <span class=\"token function\">memset</span><span class=\"token punctuation\">(</span>pCode<span class=\"token operator\">+</span><span class=\"token number\">5</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x90</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"109\"></td><td><pre>    <span class=\"token operator\">*</span><span class=\"token punctuation\">(</span>ULONG<span class=\"token operator\">*</span><span class=\"token punctuation\">)</span><span class=\"token operator\">&amp;</span>pCode<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> JmpCode<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"110\"></td><td><pre></pre></td></tr><tr><td data-num=\"111\"></td><td><pre>    <span class=\"token function\">DbgPrint</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Code[0]:%X\\n\"</span><span class=\"token punctuation\">,</span> Code<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"112\"></td><td><pre>    <span class=\"token function\">DbgPrint</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Code[1]:%X\\n\"</span><span class=\"token punctuation\">,</span> Code<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"113\"></td><td><pre></pre></td></tr><tr><td data-num=\"114\"></td><td><pre>    <span class=\"token function\">disablePageWriteProtect</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"115\"></td><td><pre>    __asm <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"116\"></td><td><pre>        pushad<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"117\"></td><td><pre>        pushfd<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"118\"></td><td><pre>        mov esi<span class=\"token punctuation\">,</span> SwapContextAddress<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"119\"></td><td><pre>        mov eax<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span>esi<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"120\"></td><td><pre>        mov edx<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span>esi <span class=\"token operator\">+</span> <span class=\"token number\">4</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"121\"></td><td><pre>        mov ebx<span class=\"token punctuation\">,</span> Code<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"122\"></td><td><pre>        mov ecx<span class=\"token punctuation\">,</span> Code<span class=\"token punctuation\">[</span><span class=\"token number\">4</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// 这个必须得填 4</span></pre></td></tr><tr><td data-num=\"123\"></td><td><pre>        <span class=\"token keyword\">int</span> <span class=\"token number\">3</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"124\"></td><td><pre>        lock CMPXCHG8B<span class=\"token punctuation\">[</span>esi<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"125\"></td><td><pre>        <span class=\"token comment\">/* CMPXCHG8B 的用法</pre></td></tr><tr><td data-num=\"126\"></td><td><pre>        该指令判断指定内存中的 8 字节内容和 EDX:EAX （edx 高 32 位，eax, 低 32 位）中的 64 字节内容是否相同，</pre></td></tr><tr><td data-num=\"127\"></td><td><pre>        如果相同，就把 ECX : EBX（ecx 高 32 位，ebx, 低 32 位）中的内容替换到指定内存。</pre></td></tr><tr><td data-num=\"128\"></td><td><pre>        如果不相同，就把指定内存中的值替换到 ECX : EBX 中。</pre></td></tr><tr><td data-num=\"129\"></td><td><pre>        */</span></pre></td></tr><tr><td data-num=\"130\"></td><td><pre>        popfd<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"131\"></td><td><pre>        popad<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"132\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"133\"></td><td><pre>    <span class=\"token function\">enablePageWriteProtect</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"134\"></td><td><pre>    <span class=\"token function\">DbgPrint</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"高并发HOOK成功!\\n\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"135\"></td><td><pre>\t<span class=\"token keyword\">return</span> STATUS_SUCCESS<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"136\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>在 Windbg 中查看：</p>\n<p><img data-src=\"image003.png\" alt=\"\" /></p>\n<p>如果打印的话虚拟机就会卡住，winbdg 中会一直显示打印系信息。</p>\n<p>一步步调试查看是否修改成功。</p>\n<p><img data-src=\"image004.png\" alt=\"\" /></p>\n<p><img data-src=\"image005.png\" alt=\"\" /></p>\n<p>没问题！</p>\n<h1 id=\"reference\"><a class=\"anchor\" href=\"#reference\">#</a> Reference</h1>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQxNDkwODczL2FydGljbGUvZGV0YWlscy8xMDU4ODIyNjg=\">https://blog.csdn.net/qq_41490873/article/details/105882268</span><br />\n<span class=\"exturl\" data-url=\"aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3NoYXJlbmZpc2gvYXJ0aWNsZS9kZXRhaWxzLzEyMTYyNTEwNg==\">https://blog.csdn.net/sharenfish/article/details/121625106</span><br />\n<span class=\"exturl\" data-url=\"aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L0t3YW5zeS9hcnRpY2xlL2RldGFpbHMvMTA5OTk1MTk2\">https://blog.csdn.net/Kwansy/article/details/109995196</span></p>\n",
            "tags": [
                "自旋锁",
                "临界区"
            ]
        },
        {
            "id": "https://or0kit.github.io/Bin/Core/WindowsXp/SystemCall/%E7%B3%BB%E7%BB%9F%E8%B0%83%E7%94%A8-%E6%80%BB%E7%BB%93/",
            "url": "https://or0kit.github.io/Bin/Core/WindowsXp/SystemCall/%E7%B3%BB%E7%BB%9F%E8%B0%83%E7%94%A8-%E6%80%BB%E7%BB%93/",
            "title": "系统调用-总结",
            "date_published": "2022-03-13T06:37:38.000Z",
            "content_html": "<h1 id=\"楔子\"><a class=\"anchor\" href=\"#楔子\">#</a> 楔子</h1>\n<p>学完 APC 后，梳理一下学到的知识，看看能不能从 3 环进 0 环再回 3 环来。</p>\n<h1 id=\"流程梳理\"><a class=\"anchor\" href=\"#流程梳理\">#</a> 流程梳理</h1>\n<p>以 R3 函数  <code>ReadProcessMemory</code>  为例</p>\n<p>先分析函数调用流程</p>\n<p><code>ReadProcessMemory</code>  调用了从 ntdll 中 导入的函数  <code>NtReadVirtualMemory</code></p>\n<p>在  <code>ntdll</code>  中查看 此函数</p>\n<figure class=\"highlight raw\"><figcaption data-lang=\"\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>_NtReadVirtualMemory@20 proc near    \t\t\t\t</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>mov     eax, 0BAh       ; NtReadVirtualMemory\t\t\t\t</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>mov     edx, 7FFE0300h\t\t\t\t</pre></td></tr><tr><td data-num=\"4\"></td><td><pre> call    dword ptr [edx]\t\t\t\t</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>retn    14h</pre></td></tr></table></figure><p>可以看到这个函数只有短短几行汇编代码：给 eax 赋个值，然后给 edx 个地址，然后 call 一下 edx 指向的地址，然后就平栈（由于 STDCALL 调用约定）返回了。</p>\n<p>首先我们要知道 这里调用的是什么函数</p>\n<p>在 0x7FFE0000 的位置是一个名为  <code>KUSER_SHARED_DATA</code>  的结构体，这个结构体与 0 环 FFDF0000 存储的数据一模一样，是由同一个物理页映射的。\t\t\t\t\t\t\t\t\t\t\t\t\t<br />\n在其偏移 0x300 的位置有一个成员其存储的就是调用方式，如今的 CPU 都支持快速调用了，所以一般存储的是 ntdll 中的 KiFastSystemCall 函数</p>\n<p>查看这个函数</p>\n<figure class=\"highlight raw\"><figcaption data-lang=\"\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>_KiFastSystemCall@0 proc near \t\t\t\t\t\t\t\t\t\t\t\t\t</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>mov edx, esp\t\t\t\t\t\t\t\t\t\t\t\t\t</pre></td></tr><tr><td data-num=\"3\"></td><td><pre> sysenter</pre></td></tr></table></figure><p>将 esp 存储在 edx 中后就执行了 sysenter 指令</p>\n<p>sysenter 指令就是取出了存储在 MSR 寄存器中的 CS、ESP、EIP，这是提升权限所必须的</p>\n<p>这个时候 EIP 改变了，在我的计算机上 MSR [176] 中存储的地址是内核文件中的 KiFastCallEntry 函数</p>\n<p>快速调用进 0 环后，0 环的堆栈指向 TrapFrame+0x78 的位置，接下来的\t\t\t\t\t\t<br />\n就是填充这个结构了。\t\t\t\t\t\t<br />\n填充完毕后，也就是保存好 3 环的堆栈和寄存器环境后\t\t\t\t\t\t<br />\n准备调用 0 环的函数。\t\t\t\t\t\t<br />\n调用完函数后 ebp 和 esp 又指向了 TrapFrame</p>\n<p>判断 ETHREAD 是否有用户 APC 需要处理，如果有就处理 APC，一直到没有用户 APC 需要处理，这里是一个循环。<br />\n没有用户 APC 需要处理后就跳出了循环</p>\n<p>后面的一些汇编代码我在内核中跟了一下。</p>\n<p>如下：</p>\n<p><img data-src=\"image001.png\" alt=\"\" /></p>\n<p>以上汇编代码只有在最后跳到了 KiSystemCallExit2 中 其他判断都没跳。</p>\n",
            "tags": [
                "API进出内核"
            ]
        },
        {
            "id": "https://or0kit.github.io/Bin/Core/WindowsXp/Apc/APC%E6%9C%BA%E5%88%B6-04APC%E7%9A%84%E6%89%A7%E8%A1%8C%E8%BF%87%E7%A8%8B/",
            "url": "https://or0kit.github.io/Bin/Core/WindowsXp/Apc/APC%E6%9C%BA%E5%88%B6-04APC%E7%9A%84%E6%89%A7%E8%A1%8C%E8%BF%87%E7%A8%8B/",
            "title": "APC机制-04APC的执行过程",
            "date_published": "2022-03-06T07:34:20.000Z",
            "content_html": "<h1 id=\"楔子\"><a class=\"anchor\" href=\"#楔子\">#</a> 楔子</h1>\n<p>APC 函数的执行与插入并不是同一个线程，具体点说：</p>\n<p>在 A 线程中向 B 线程插入一个 APC，插入的动作是在 A 线程中完成的，但什么时候执行则由 B 线程决定！，所以叫 “异步过程调用”。</p>\n<p>内核 APC 函数与用户 APC 函数的执行时间和执行方式也有区别的。</p>\n<h1 id=\"apc的执行过程\"><a class=\"anchor\" href=\"#apc的执行过程\">#</a> APC 的执行过程</h1>\n<p>首先研究一下内核 APC 函数在什么时候执行。</p>\n<h2 id=\"线程切换\"><a class=\"anchor\" href=\"#线程切换\">#</a> 线程切换</h2>\n<p><code>SwapContext</code> \t<strong>判断是否有内核 APC</strong> -&gt;  <code>KiSwapThread</code>  -&gt;  <code>KiDeliverApc</code> \t执行内核 APC 函数。</p>\n<p><img data-src=\"image001.png\" alt=\"\" /></p>\n<p><img data-src=\"image002.png\" alt=\"\" /></p>\n<h2 id=\"系统调用-中断或异常\"><a class=\"anchor\" href=\"#系统调用-中断或异常\">#</a> 系统调用、中断或异常</h2>\n<p>由 0 环返回 3 环的时候。这个执行点的条件是有用户 APC 需要执行，如果没有用户 APC 需要执行就直接返回了。</p>\n<p>在单核 ntoskrnl.exe 中是  <code>_KiServiceExit</code>  函数 在多核 ntkrnlpa.exe 中是在函数  <code>KiFastCallEntry</code>  的下面。</p>\n<p><img data-src=\"image003.png\" alt=\"\" /></p>\n<h2 id=\"分析-kideliverapc-函数\"><a class=\"anchor\" href=\"#分析-kideliverapc-函数\">#</a> 分析 KiDeliverApc 函数</h2>\n<p>无论有用户 APC 还是内核 APC 需要执行都会调用这个函数。</p>\n<p><strong>在 IDA 中分析完毕后，发现关于执行内核 APC 有两种情况，既  <code>NormalRoutine</code>  为空和不为空，先执行特殊的。<br />\n在执行用户 APC 时也是一样，分为  <code>NormalRoutine</code>  为空和不为空，若是不为空就调用了  <code>KiInitializeUserApc</code>  函数。若是为空就执行  <code>KeTestAlertThread</code>  函数，这里调用这个函数又判断了用户 APC 列表是否是空表，如果不为空把   <code>Thread-&gt;ApcState.UserApcPending = TRUE;</code>  后就返回了。</strong></p>\n<p><img data-src=\"image004.png\" alt=\"\" /></p>\n<p>对于其中的一些关键操作，分为处理内核 APC 和用户 APC 分别进行讨论。</p>\n<h3 id=\"kideliverapc中处理内核apc的流程\"><a class=\"anchor\" href=\"#kideliverapc中处理内核apc的流程\">#</a> KiDeliverApc 中处理内核 APC 的流程</h3>\n<details class=\"info\"><summary>处理普通内核APC (点击展开)</summary><div>\n<ol>\n<li>\n<p>判断第一个链表是否为空</p>\n</li>\n<li>\n<p>判断 KTHREAD.ApcState.KernelApcInProgress 是否为 1</p>\n</li>\n<li>\n<p>判断是否禁用内核 APC (KTHREAD.KernelApcDisable 是否为 1)</p>\n</li>\n<li>\n<p>将当前 KAPC 结构体从链表中摘除</p>\n</li>\n<li>\n<p>执行 KAPC.KernelRoutine 指定的函数 释放 KAPC 结构体占用的空间</p>\n</li>\n<li>\n<p>将 KTHREAD.ApcState.KernelApcInProgress 设置为 1 标识正在执行内核 APC</p>\n</li>\n<li>\n<p>执行真正的内核 APC 函数 (KAPC.NormalRoutine)</p>\n</li>\n<li>\n<p>执行完毕 将 KernelApcInProgress 改为 0</p>\n</li>\n<li>\n<p>循环</p>\n</li>\n</ol>\n</div></details>\n<p>总结：</p>\n<ol>\n<li>内核 APC 在线程切换的时候就会执行，这也就意味着，只要插入内核 APC 很快就会执行。</li>\n<li>在执行用户 APC 之前会先执行内核 APC。</li>\n<li>内核 APC 在内核空间执行，不需要换栈，一个循环全部执行完毕。</li>\n</ol>\n<h3 id=\"kideliverapc中处理用户apc的流程\"><a class=\"anchor\" href=\"#kideliverapc中处理用户apc的流程\">#</a> KiDeliverApc 中处理用户 APC 的流程</h3>\n<p><strong>执行用户 APC 时的堆栈操作</strong></p>\n<p>处理用户 APC 要比内核 APC 复杂的多，因为，用户 APC 函数要在用户空间执行的，这里涉及到大量换栈的操作：</p>\n<p>当线程从用户层进入内核层时，要保留原来的运行环境，比如各种寄存器，栈的位置等等  (_Trap_Frame)，然后切换成内核的堆栈，如果正常返回，恢复堆栈环境即可。</p>\n<p>但如果有用户 APC 要执行的话，就意味着线程要提前返回到用户空间去执行，而且返回的位置不是线程进入内核时的位置，而是返回到其他的位置，每处理一个用户 APC 都会涉及到：  <code>内核--&gt;用户空间--&gt;再回到内核空间</code></p>\n<p>堆栈的操作比较复杂，如果不了解堆栈的操作细节不可能理解用户 APC 是如何执行的！</p>\n<details class=\"info\"><summary>处理用户APC流程 （点击展开）</summary><div>\n<ol>\n<li>\n<p>判断用户 APC 链表是否为空</p>\n</li>\n<li>\n<p>判断第一个参数是为 1</p>\n</li>\n<li>\n<p>判断 ApcState.UserApcPending 是否为 1</p>\n</li>\n<li>\n<p>将 ApcState.UserApcPending 设置为 0</p>\n</li>\n<li>\n<p>链表操作 将当前 APC 从用户队列中拆除</p>\n</li>\n<li>\n<p>调用函数 (KAPC.KernelRoutine) 释放 KAPC 结构体内存空间</p>\n</li>\n<li>\n<p>调用 KiInitializeUserApc 函数</p>\n</li>\n</ol>\n</div></details>\n<p><strong>想要继续了解处理用户 APC 时是如何处理堆栈问题的就要接着分析  <code>KiInitializeUserApc</code>  函数了。</strong></p>\n<h2 id=\"分析-kiinitializeuserapc-函数\"><a class=\"anchor\" href=\"#分析-kiinitializeuserapc-函数\">#</a> 分析 KiInitializeUserApc 函数</h2>\n<p>线程进 0 环时，原来的运行环境 (寄存器栈顶等) 保存到  <code>_Trap_Frame</code>  结构体中，如果要提前返回 3 环去处理用户 APC，就必须要修改  <code>_Trap_Frame</code>  结构体：</p>\n<p>比如：进 0 环时的位置存储在 EIP 中，现在要提前返回，而且返回的并不是原来的位置，那就意味着必须要修改 EIP 为新的返回位置。还有堆栈 ESP, 也要修改为处理 APC 需要的堆栈。那原来的值怎么办呢？处理完 APC 后该如何返回原来的位置呢？</p>\n<p><code>KiInitializeUserApc</code>  要做的第一件事就是备份：</p>\n<p>将原来  <code>_Trap_Frame</code>  里的值备份到一个新的结构体中 (CONTEXT)，这个功能由其子函数  <code>KeContextFromKframes</code>  来完成。</p>\n<p>在 IDA 中查看其汇编。</p>\n<p><img data-src=\"image005.png\" alt=\"\" /></p>\n<p>也可结合其源码分析，有整个流程的详细注释。</p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>VOID</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token function\">KiInitializeUserApc</span> <span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    IN PKEXCEPTION_FRAME ExceptionFrame<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    IN PKTRAP_FRAME TrapFrame<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    IN PKNORMAL_ROUTINE NormalRoutine<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    IN PVOID NormalContext<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    IN PVOID SystemArgument1<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    IN PVOID SystemArgument2</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token comment\">/*++</pre></td></tr><tr><td data-num=\"12\"></td><td><pre></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>Routine Description:</pre></td></tr><tr><td data-num=\"14\"></td><td><pre></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    This function is called to initialize the context for a user mode APC.</pre></td></tr><tr><td data-num=\"16\"></td><td><pre></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>Arguments:</pre></td></tr><tr><td data-num=\"18\"></td><td><pre></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    ExceptionFrame - Supplies a pointer to an exception frame.</pre></td></tr><tr><td data-num=\"20\"></td><td><pre></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>    TrapFrame - Supplies a pointer to a trap frame.</pre></td></tr><tr><td data-num=\"22\"></td><td><pre></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>    NormalRoutine - Supplies a pointer to the user mode APC routine.</pre></td></tr><tr><td data-num=\"24\"></td><td><pre></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>    NormalContext - Supplies a pointer to the user context for the APC</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>        routine.</pre></td></tr><tr><td data-num=\"27\"></td><td><pre></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>    SystemArgument1 - Supplies the first system supplied value.</pre></td></tr><tr><td data-num=\"29\"></td><td><pre></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>    SystemArgument2 - Supplies the second system supplied value.</pre></td></tr><tr><td data-num=\"31\"></td><td><pre></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>Return Value:</pre></td></tr><tr><td data-num=\"33\"></td><td><pre></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>    None.</pre></td></tr><tr><td data-num=\"35\"></td><td><pre></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>--*/</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre></pre></td></tr><tr><td data-num=\"38\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>    EXCEPTION_RECORD ExceptionRecord<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>    CONTEXT ContextFrame<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>    LONG Length<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>    ULONG UserStack<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre></pre></td></tr><tr><td data-num=\"45\"></td><td><pre></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>    <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>    <span class=\"token comment\">// APCs are not defined for V86 mode; however, it is possible a</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>    <span class=\"token comment\">// thread is trying to set it's context to V86 mode - this isn't</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>    <span class=\"token comment\">// going to work, but we don't want to crash the system so we</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>    <span class=\"token comment\">// check for the possibility before hand.</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre></pre></td></tr><tr><td data-num=\"52\"></td><td><pre>    <span class=\"token comment\">// APCs 没有在虚拟 86 模式下定义；然而，线程可能试图将它的 context 设置为虚拟 86 模式</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>    <span class=\"token comment\">// 这将不会工作，但我们不想崩溃系统，所以我们检查之前的可能性。</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre></pre></td></tr><tr><td data-num=\"55\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>TrapFrame<span class=\"token operator\">-></span>EFlags <span class=\"token operator\">&amp;</span> EFLAGS_V86_MASK<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>        <span class=\"token keyword\">return</span> <span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre></pre></td></tr><tr><td data-num=\"59\"></td><td><pre>    <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre>    <span class=\"token comment\">// Move machine state from trap and exception frames to the context frame.</span></pre></td></tr><tr><td data-num=\"61\"></td><td><pre>    <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"62\"></td><td><pre></pre></td></tr><tr><td data-num=\"63\"></td><td><pre>    ContextFrame<span class=\"token punctuation\">.</span>ContextFlags <span class=\"token operator\">=</span> CONTEXT_FULL <span class=\"token operator\">|</span> CONTEXT_DEBUG_REGISTERS<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"64\"></td><td><pre>    <span class=\"token function\">KeContextFromKframes</span><span class=\"token punctuation\">(</span>TrapFrame<span class=\"token punctuation\">,</span> ExceptionFrame<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>ContextFrame<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"65\"></td><td><pre></pre></td></tr><tr><td data-num=\"66\"></td><td><pre>    <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"67\"></td><td><pre>    <span class=\"token comment\">// Transfer the context information to the user stack, initialize the</span></pre></td></tr><tr><td data-num=\"68\"></td><td><pre>    <span class=\"token comment\">// APC routine parameters, and modify the trap frame so execution will</span></pre></td></tr><tr><td data-num=\"69\"></td><td><pre>    <span class=\"token comment\">// continue in user mode at the user mode APC dispatch routine.</span></pre></td></tr><tr><td data-num=\"70\"></td><td><pre>    <span class=\"token comment\">// 将上下文信息传递给用户栈，初始化 APC 例程参数，并修改 trap frame，以便在用户模式下继续执行 APC 调度例程。</span></pre></td></tr><tr><td data-num=\"71\"></td><td><pre></pre></td></tr><tr><td data-num=\"72\"></td><td><pre></pre></td></tr><tr><td data-num=\"73\"></td><td><pre>    try <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"74\"></td><td><pre>        <span class=\"token function\">ASSERT</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>TrapFrame<span class=\"token operator\">-></span>SegCs <span class=\"token operator\">&amp;</span> MODE_MASK<span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> KernelMode<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// Assert usermode frame</span></pre></td></tr><tr><td data-num=\"75\"></td><td><pre></pre></td></tr><tr><td data-num=\"76\"></td><td><pre>        <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"77\"></td><td><pre>        <span class=\"token comment\">// Compute length of context record and new aligned user stack pointer.</span></pre></td></tr><tr><td data-num=\"78\"></td><td><pre>        <span class=\"token comment\">// 计算 context record 的长度 并提升堆栈 且设置用户堆栈指针的对齐。</span></pre></td></tr><tr><td data-num=\"79\"></td><td><pre></pre></td></tr><tr><td data-num=\"80\"></td><td><pre>        Length <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">sizeof</span><span class=\"token punctuation\">(</span>CONTEXT<span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> CONTEXT_ROUND<span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;</span></pre></td></tr><tr><td data-num=\"81\"></td><td><pre>                    <span class=\"token operator\">~</span>CONTEXT_ROUND<span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> <span class=\"token keyword\">sizeof</span><span class=\"token punctuation\">(</span>KAPC_RECORD<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"82\"></td><td><pre>        UserStack <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>ContextFrame<span class=\"token punctuation\">.</span>Esp <span class=\"token operator\">&amp;</span> <span class=\"token operator\">~</span>CONTEXT_ROUND<span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span> Length<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"83\"></td><td><pre></pre></td></tr><tr><td data-num=\"84\"></td><td><pre>        <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"85\"></td><td><pre>        <span class=\"token comment\">// Probe user stack area for writability and then transfer the</span></pre></td></tr><tr><td data-num=\"86\"></td><td><pre>        <span class=\"token comment\">// context record to the user stack.</span></pre></td></tr><tr><td data-num=\"87\"></td><td><pre>        <span class=\"token comment\">// 探测用户堆栈区域的可写性，然后将上下文记录传输到用户堆栈。</span></pre></td></tr><tr><td data-num=\"88\"></td><td><pre></pre></td></tr><tr><td data-num=\"89\"></td><td><pre>        <span class=\"token function\">ProbeForWrite</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>PCHAR<span class=\"token punctuation\">)</span>UserStack<span class=\"token punctuation\">,</span> Length<span class=\"token punctuation\">,</span> CONTEXT_ALIGN<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"90\"></td><td><pre>        <span class=\"token function\">RtlCopyMemory</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>PULONG<span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span>UserStack <span class=\"token operator\">+</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">sizeof</span><span class=\"token punctuation\">(</span>KAPC_RECORD<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"91\"></td><td><pre>                     <span class=\"token operator\">&amp;</span>ContextFrame<span class=\"token punctuation\">,</span> <span class=\"token keyword\">sizeof</span><span class=\"token punctuation\">(</span>CONTEXT<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"92\"></td><td><pre></pre></td></tr><tr><td data-num=\"93\"></td><td><pre>        <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"94\"></td><td><pre>        <span class=\"token comment\">// Force correct R3 selectors into TrapFrame.</span></pre></td></tr><tr><td data-num=\"95\"></td><td><pre>        <span class=\"token comment\">// 在 TrapFrame 中直接修正 R3 的段选择子</span></pre></td></tr><tr><td data-num=\"96\"></td><td><pre></pre></td></tr><tr><td data-num=\"97\"></td><td><pre>        TrapFrame<span class=\"token operator\">-></span>SegCs <span class=\"token operator\">=</span> <span class=\"token function\">SANITIZE_SEG</span><span class=\"token punctuation\">(</span>KGDT_R3_CODE<span class=\"token punctuation\">,</span> UserMode<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"98\"></td><td><pre>        TrapFrame<span class=\"token operator\">-></span>HardwareSegSs <span class=\"token operator\">=</span> <span class=\"token function\">SANITIZE_SEG</span><span class=\"token punctuation\">(</span>KGDT_R3_DATA<span class=\"token punctuation\">,</span> UserMode<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"99\"></td><td><pre>        TrapFrame<span class=\"token operator\">-></span>SegDs <span class=\"token operator\">=</span> <span class=\"token function\">SANITIZE_SEG</span><span class=\"token punctuation\">(</span>KGDT_R3_DATA<span class=\"token punctuation\">,</span> UserMode<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"100\"></td><td><pre>        TrapFrame<span class=\"token operator\">-></span>SegEs <span class=\"token operator\">=</span> <span class=\"token function\">SANITIZE_SEG</span><span class=\"token punctuation\">(</span>KGDT_R3_DATA<span class=\"token punctuation\">,</span> UserMode<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"101\"></td><td><pre>        TrapFrame<span class=\"token operator\">-></span>SegFs <span class=\"token operator\">=</span> <span class=\"token function\">SANITIZE_SEG</span><span class=\"token punctuation\">(</span>KGDT_R3_TEB<span class=\"token punctuation\">,</span> UserMode<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"102\"></td><td><pre>        TrapFrame<span class=\"token operator\">-></span>SegGs <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"103\"></td><td><pre>        TrapFrame<span class=\"token operator\">-></span>EFlags <span class=\"token operator\">=</span> <span class=\"token function\">SANITIZE_FLAGS</span><span class=\"token punctuation\">(</span> ContextFrame<span class=\"token punctuation\">.</span>EFlags<span class=\"token punctuation\">,</span> UserMode <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"104\"></td><td><pre></pre></td></tr><tr><td data-num=\"105\"></td><td><pre>        <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"106\"></td><td><pre>        <span class=\"token comment\">// If thread is supposed to have IOPL, then force it on in eflags</span></pre></td></tr><tr><td data-num=\"107\"></td><td><pre>        <span class=\"token comment\">// 如果线程应该有 IOPL，那么直接把它赋给 eflags</span></pre></td></tr><tr><td data-num=\"108\"></td><td><pre></pre></td></tr><tr><td data-num=\"109\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">KeGetCurrentThread</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">-></span>Iopl<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"110\"></td><td><pre>            TrapFrame<span class=\"token operator\">-></span>EFlags <span class=\"token operator\">|=</span> <span class=\"token punctuation\">(</span>EFLAGS_IOPL_MASK <span class=\"token operator\">&amp;</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  <span class=\"token comment\">// IOPL = 3</span></pre></td></tr><tr><td data-num=\"111\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"112\"></td><td><pre></pre></td></tr><tr><td data-num=\"113\"></td><td><pre>        <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"114\"></td><td><pre>        <span class=\"token comment\">// Set the address of the user APC routine, the APC parameters, the</span></pre></td></tr><tr><td data-num=\"115\"></td><td><pre>        <span class=\"token comment\">// new frame pointer, and the new stack pointer in the current trap</span></pre></td></tr><tr><td data-num=\"116\"></td><td><pre>        <span class=\"token comment\">// frame. Set the continuation address so control will be transferred</span></pre></td></tr><tr><td data-num=\"117\"></td><td><pre>        <span class=\"token comment\">// to the user APC dispatcher.</span></pre></td></tr><tr><td data-num=\"118\"></td><td><pre>        <span class=\"token comment\">// 设置当前 trap frame 中用户 APC 例程地址、APC 参数、新的帧指针和新的栈指针。</span></pre></td></tr><tr><td data-num=\"119\"></td><td><pre>        <span class=\"token comment\">// 设置延续地址，这样控制将被转移到用户 APC 调度程序。</span></pre></td></tr><tr><td data-num=\"120\"></td><td><pre></pre></td></tr><tr><td data-num=\"121\"></td><td><pre>        TrapFrame<span class=\"token operator\">-></span>HardwareEsp <span class=\"token operator\">=</span> UserStack<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"122\"></td><td><pre>        TrapFrame<span class=\"token operator\">-></span>Eip <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>ULONG<span class=\"token punctuation\">)</span>KeUserApcDispatcher<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"123\"></td><td><pre>        TrapFrame<span class=\"token operator\">-></span>ErrCode <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"124\"></td><td><pre>        <span class=\"token operator\">*</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>PULONG<span class=\"token punctuation\">)</span>UserStack<span class=\"token punctuation\">)</span><span class=\"token operator\">++</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>ULONG<span class=\"token punctuation\">)</span>NormalRoutine<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"125\"></td><td><pre>        <span class=\"token operator\">*</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>PULONG<span class=\"token punctuation\">)</span>UserStack<span class=\"token punctuation\">)</span><span class=\"token operator\">++</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>ULONG<span class=\"token punctuation\">)</span>NormalContext<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"126\"></td><td><pre>        <span class=\"token operator\">*</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>PULONG<span class=\"token punctuation\">)</span>UserStack<span class=\"token punctuation\">)</span><span class=\"token operator\">++</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>ULONG<span class=\"token punctuation\">)</span>SystemArgument1<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"127\"></td><td><pre>        <span class=\"token operator\">*</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>PULONG<span class=\"token punctuation\">)</span>UserStack<span class=\"token punctuation\">)</span><span class=\"token operator\">++</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>ULONG<span class=\"token punctuation\">)</span>SystemArgument2<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"128\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span> <span class=\"token function\">except</span> <span class=\"token punctuation\">(</span><span class=\"token function\">KiCopyInformation</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>ExceptionRecord<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"129\"></td><td><pre>                                <span class=\"token punctuation\">(</span><span class=\"token function\">GetExceptionInformation</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token operator\">-></span>ExceptionRecord<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"130\"></td><td><pre></pre></td></tr><tr><td data-num=\"131\"></td><td><pre>        <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"132\"></td><td><pre>        <span class=\"token comment\">// Set the address of the exception to the current program address</span></pre></td></tr><tr><td data-num=\"133\"></td><td><pre>        <span class=\"token comment\">// and raise the exception by calling the exception dispatcher.</span></pre></td></tr><tr><td data-num=\"134\"></td><td><pre>        <span class=\"token comment\">// 将异常的地址设置为当前程序的地址，并通过调用异常调度程序引发异常。</span></pre></td></tr><tr><td data-num=\"135\"></td><td><pre></pre></td></tr><tr><td data-num=\"136\"></td><td><pre>        ExceptionRecord<span class=\"token punctuation\">.</span>ExceptionAddress <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>PVOID<span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span>TrapFrame<span class=\"token operator\">-></span>Eip<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"137\"></td><td><pre>        <span class=\"token function\">KiDispatchException</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>ExceptionRecord<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"138\"></td><td><pre>                            ExceptionFrame<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"139\"></td><td><pre>                            TrapFrame<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"140\"></td><td><pre>                            UserMode<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"141\"></td><td><pre>                            TRUE<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"142\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"143\"></td><td><pre>    <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"144\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h2 id=\"kiinitializeuserapc-函数流程\"><a class=\"anchor\" href=\"#kiinitializeuserapc-函数流程\">#</a> KiInitializeUserApc 函数流程</h2>\n<ol>\n<li>判断是否是虚拟 8086 模式，如果是函数直接返回。</li>\n<li>设置 ContextFlags 并调用 KeContextFromKframes  将 trap 和 exception frames 移动到 context frame。</li>\n<li>判断帧栈是否是用户模式</li>\n<li>计算 context record 的长度 并提升堆栈 且设置用户堆栈指针的对齐。</li>\n<li>探测用户堆栈区域的可写性，然后将上下文记录传输到用户堆栈。</li>\n<li>在 TrapFrame 中直接修正 R3 的段选择子，如果线程应该有 IOPL，那么直接把它赋给 eflags</li>\n<li>设置当前 trap frame 中用户 APC 例程地址、APC 参数、新的帧指针和新的栈指针。设置延续地址，这样控制将被转移到用户 APC 调度程序</li>\n<li>如果在步骤 3 至 7 中出现异常，则会将异常的地址设置为当前程序的地址，并通过调用异常调度程序引发异常。</li>\n</ol>\n<h3 id=\"如何在3环执行用户apc\"><a class=\"anchor\" href=\"#如何在3环执行用户apc\">#</a> 如何在 3 环执行用户 APC</h3>\n<p>可以观察到修改了  <code>TrapFrame</code>  中存储的 EIP 的值，将其改为了  <code>KeUserApcDispatcher</code>  这是一个函数，在 ntdll 中是  <code>KiUserApcDispatcher</code>  函数。</p>\n<p>在  <code>ntdll.dll</code>  当中，我们用 IDA 打开看看：</p>\n<figure class=\"highlight raw\"><figcaption data-lang=\"\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>.text:7C92E430 ; __stdcall KiUserApcDispatcher(x, x, x, x, x)</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>.text:7C92E430                 public _KiUserApcDispatcher@20</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>.text:7C92E430 _KiUserApcDispatcher@20 proc near       ; DATA XREF: .text:off_7C923428↑o</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>.text:7C92E430</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>.text:7C92E430 arg_C           &#x3D; byte ptr  10h</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>.text:7C92E430</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>.text:7C92E430                 lea     edi, [esp+arg_C] ;  (edi)-&gt;context frame</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>.text:7C92E434                 pop     eax             ; (eax)-&gt;specified function</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>.text:7C92E435                 call    eax</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>.text:7C92E437                 push    1</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>.text:7C92E439                 push    edi</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>.text:7C92E43A                 call    _ZwContinue@8   ; stdCall   _ZwContinue, &lt;edi, 1&gt;</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>.text:7C92E43A                                         ;</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>.text:7C92E43A                                         ; 1 - set alert argument true</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>.text:7C92E43A                                         ; ebp - addr of context frame</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>.text:7C92E43A                                         ; execute system service to continue</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>.text:7C92E43F                 nop</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>.text:7C92E43F _KiUserApcDispatcher@20</pre></td></tr></table></figure><p>这里需要对着堆栈图进行分析了。</p>\n<p><img data-src=\"image006.png\" alt=\"\" /></p>\n<p>当用户在 3 环调用 QueueUserAPC 函数来插入 APC 时，不需要提供  <code>NormalRoutine</code>  ，这个参数是在 QueueUserAPC 内部指定的：  <code>BaseDispatchAPC</code></p>\n<p><code>BaseDispatchAPC</code>  的源码如下，主要调用了 APC 函数。</p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>VOID</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token function\">BaseDispatchAPC</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    LPVOID lpApcArgument1<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    LPVOID lpApcArgument2<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    LPVOID lpApcArgument3</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    PAPCFUNC pfnAPC<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    ULONG_PTR dwData<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    PACTIVATION_CONTEXT ActivationContext<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    NTSTATUS Status<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    RTL_CALLER_ALLOCATED_ACTIVATION_CONTEXT_STACK_FRAME ActivationFrame <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span> <span class=\"token keyword\">sizeof</span><span class=\"token punctuation\">(</span>ActivationFrame<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> RTL_CALLER_ALLOCATED_ACTIVATION_CONTEXT_STACK_FRAME_FORMAT_WHISTLER <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    pfnAPC <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>PAPCFUNC<span class=\"token punctuation\">)</span> lpApcArgument1<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    dwData <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>ULONG_PTR<span class=\"token punctuation\">)</span> lpApcArgument2<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    ActivationContext <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>PACTIVATION_CONTEXT<span class=\"token punctuation\">)</span> lpApcArgument3<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>ActivationContext <span class=\"token operator\">==</span> INVALID_ACTIVATION_CONTEXT<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>        <span class=\"token punctuation\">(</span><span class=\"token operator\">*</span>pfnAPC<span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span>dwData<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>        <span class=\"token function\">RtlActivateActivationContextUnsafeFast</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>ActivationFrame<span class=\"token punctuation\">,</span> ActivationContext<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>        __try <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>            <span class=\"token punctuation\">(</span><span class=\"token operator\">*</span>pfnAPC<span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span>dwData<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span> __finally <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>            <span class=\"token function\">RtlDeactivateActivationContextUnsafeFast</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>ActivationFrame<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>            <span class=\"token function\">RtlReleaseActivationContext</span><span class=\"token punctuation\">(</span>ActivationContext<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>三环的  <code>APC</code>  执行完毕后就回来 执行 ntdll 中的  <code>ZwContinue</code>  了。</p>\n<figure class=\"highlight raw\"><figcaption data-lang=\"\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>.text:7C92D040 ; __stdcall ZwContinue(x, x)</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>.text:7C92D040                 public _ZwContinue@8</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>.text:7C92D040 _ZwContinue@8   proc near               ; CODE XREF: KiUserApcDispatcher(x,x,x,x,x)+A↓p</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>.text:7C92D040                                         ; KiUserExceptionDispatcher(x,x)+17↓p ...</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>.text:7C92D040                 mov     eax, 20h ; &#39; &#39;  ; NtContinue</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>.text:7C92D045                 mov     edx, 7FFE0300h</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>.text:7C92D04A                 call    dword ptr [edx]</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>.text:7C92D04C                 retn    8</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>.text:7C92D04C _ZwContinue@8   endp</pre></td></tr></table></figure><p>通过快速调用进 0 环后调用了内核函数  <code>NtContinue</code> 。</p>\n<p><code>NtContinue</code>  又调用了  <code>KiContinue</code>  函数。</p>\n<p><code>ZwContinue</code>  函数的意义：</p>\n<ol>\n<li>\n<p>返回内核，如果还有用户 APC，重复上面的执行过程。</p>\n</li>\n<li>\n<p>如果没有需要执行的用户 APC，会将 CONTEXT 赋值给 Trap_Frame 结构体。就像从来没有修改过一样。ZwContinue 后面的代码不会执行，线程从哪里进 0 环仍然会从哪里回去。</p>\n</li>\n</ol>\n<h1 id=\"reference\"><a class=\"anchor\" href=\"#reference\">#</a> Reference</h1>\n<p>滴水课件</p>\n",
            "tags": [
                "APC"
            ]
        },
        {
            "id": "https://or0kit.github.io/Bin/Core/WindowsXp/Apc/APC%E6%9C%BA%E5%88%B6-03APC%E7%9A%84%E6%8C%82%E5%85%A5%E8%BF%87%E7%A8%8B/",
            "url": "https://or0kit.github.io/Bin/Core/WindowsXp/Apc/APC%E6%9C%BA%E5%88%B6-03APC%E7%9A%84%E6%8C%82%E5%85%A5%E8%BF%87%E7%A8%8B/",
            "title": "APC机制-03APC的挂入过程",
            "date_published": "2022-02-25T11:23:40.000Z",
            "content_html": "<h1 id=\"楔子\"><a class=\"anchor\" href=\"#楔子\">#</a> 楔子</h1>\n<p>无论是正常状态还是挂靠状态，都有两个 APC 队列，一个内核队列，一个用户队列。</p>\n<p>每当要挂入一个 APC 函数时，不管是内核 APC 还是用户 APC，内核都要准备一个  <code>KAPC</code>  的数据结构，并且将这个  <code>KAPC</code>  结构挂到相应的 APC 队列中。</p>\n<h1 id=\"kapc-结构\"><a class=\"anchor\" href=\"#kapc-结构\">#</a> KAPC 结构</h1>\n<pre><code>kd&gt; dt _KAPC\nnt!_KAPC\n   +0x000 Type\t\t        //类型  APC类型为0x12\n   +0x002 Size\t\t        //本结构体的大小  0x30\n   +0x004 Spare0    \t    //未使用                             \n   +0x008 Thread \t\t    //目标线程                                  \n   +0x00c ApcListEntry\t    //APC队列挂的位置\n   +0x014 KernelRoutine\t    //指向一个函数(释放APC)\n   +0x018 RundownRoutine    //略 \n   +0x01c NormalRoutine\t    //用户APC总入口  或者 真正的内核apc函数\n   +0x020 NormalContext\t    //内核APC：NULL  用户APC：真正的APC函数\n   +0x024 SystemArgument1   //APC函数的参数\t\n   +0x028 SystemArgument2   //APC函数的参数\n   +0x02c ApcStateIndex\t    //挂哪个队列，有四个值：0 1 2 3\n   +0x02d ApcMode\t        //内核APC 用户APC\n   +0x02e Inserted\t        //表示本apc是否已挂入队列 挂入前：0  挂入后  1\n</code></pre>\n<h1 id=\"apcstateindex\"><a class=\"anchor\" href=\"#apcstateindex\">#</a> ApcStateIndex</h1>\n<p>与 KTHREAD (+0x165) 的属性同名，但含义不一样：</p>\n<p>ApcStateIndex 有四个值：<br />\n0 原始环境 1 挂靠环境 2 当前环境 3 插入 APC 时的当前环境</p>\n<p>正常情况下：<br />\nApcStatePointer [0]  指向 ApcState<br />\nApcStatePointer [1]  指向 SavedApcState<br />\n 挂靠情况下：<br />\nApcStatePointer [0]  指向 SavedApcState<br />\nApcStatePointer [1]  指向 ApcState</p>\n<p>2 初始化的时候，当前线程的 ApcState，不管挂靠还是没挂靠，我只选当前的 APC 状态。 判断是否为  <code>2</code>  的状态可以在  <code>KeInitializeApc</code>  中观察到。</p>\n<p>3 插入的时候，当前线程的 ApcState，如果在初始化的时候还没有挂靠，在准备插入的时候线程挂靠了，如果值为 3 就会使 KAPC 中的 ApcStateIndex 与 KTHREAD 中的 ApcStateIndex 一样。 判断是否为 <code>3</code>  的状态可以在  <code>KiInsertQueueApc</code>  中观察到。</p>\n<h1 id=\"alertable属性说明是否运行被apc吵醒\"><a class=\"anchor\" href=\"#alertable属性说明是否运行被apc吵醒\">#</a> Alertable 属性说明 (是否运行被 APC 吵醒)</h1>\n<p>结合  <code>KiInsertQueueApc</code>  函数</p>\n<pre><code>kd&gt; dt _KTHREAD\nntdll!_KTHREAD\n   ...\n   +0x164 Alertable        : UChar\n   ...\n\nDWORD SleepEx(\n  DWORD dwMilliseconds, // time-out interval\n  BOOL bAlertable        \t// early completion option\n);\nDWORD WaitForSingleObjectEx(\n  HANDLE hHandle,        \t// handle to object\n  DWORD dwMilliseconds, // time-out interval\n  BOOL bAlertable        \t// alertable option\n);\n</code></pre>\n<p>总结:</p>\n<p>1、 <code>Alertable=0</code>  当前插入的 APC 函数未必有机会执行： <code>UserApcPending = 0</code></p>\n<p>2、 <code>Alertable=1  UserApcPending = 1</code>  将目标线程唤醒 (从等待链表中摘出来，并挂到调度链表)</p>\n<h1 id=\"挂入流程\"><a class=\"anchor\" href=\"#挂入流程\">#</a> 挂入流程</h1>\n<p>从 R3 到 R0 的调用流程</p>\n<p>用户层调用：QueueUserAPC (kernel32.dll) -&gt; NtQueueApcThread (ntkrnlpa.exe)  -&gt;  内核层调用 KeInitializeApc (分配空间 初始化 KAPC 结构体) -&gt; KeInsertQueueApc -&gt; KiInsertQueueApc (将 KAPC 插入指定 APC 队列)</p>\n<h2 id=\"各层函数分析\"><a class=\"anchor\" href=\"#各层函数分析\">#</a> 各层函数分析</h2>\n<p>分析一下各层的函数的都做了什么事情。</p>\n<h3 id=\"queueuserapckernel32dll\"><a class=\"anchor\" href=\"#queueuserapckernel32dll\">#</a> QueueUserAPC(kernel32.dll)</h3>\n<p>首先了解一下这个函数</p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>WINBASEAPI</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>DWORD</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>WINAPI</pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token function\">QueueUserAPC</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    PAPCFUNC pfnAPC<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    HANDLE hThread<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    ULONG_PTR dwData</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token comment\">/*++</pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>Routine Description:</pre></td></tr><tr><td data-num=\"12\"></td><td><pre></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    这个函数用于将用户模式的 APC 队列到指定的线程。当指定的线程执行 alertable 等待时，APC 将被触发。</pre></td></tr><tr><td data-num=\"14\"></td><td><pre></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>Arguments:</pre></td></tr><tr><td data-num=\"16\"></td><td><pre></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    pfnAPC - 提供 APC 例程的地址，以便在 APC 触发时执行。</pre></td></tr><tr><td data-num=\"18\"></td><td><pre></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    hHandle - 为线程对象提供一个句柄。调用者必须具有对该线程的线程设置上下文访问权限。</pre></td></tr><tr><td data-num=\"20\"></td><td><pre></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>    dwData - 提供一个 DWORD 传递给 APC</pre></td></tr><tr><td data-num=\"22\"></td><td><pre></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>Return Value:</pre></td></tr><tr><td data-num=\"24\"></td><td><pre></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>    TRUE - The operations was successful</pre></td></tr><tr><td data-num=\"26\"></td><td><pre></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>    FALSE - The operation failed. GetLastError () is not defined.</pre></td></tr><tr><td data-num=\"28\"></td><td><pre></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>--*/</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>    NTSTATUS Status<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>    PVOID Argument1 <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>PVOID<span class=\"token punctuation\">)</span> pfnAPC<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>    PVOID Argument2 <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>PVOID<span class=\"token punctuation\">)</span> dwData<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>    PVOID Argument3 <span class=\"token operator\">=</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>    ACTIVATION_CONTEXT_BASIC_INFORMATION acbi <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span> <span class=\"token number\">0</span> <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>    Status <span class=\"token operator\">=</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>        <span class=\"token function\">RtlQueryInformationActivationContext</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>            RTL_QUERY_INFORMATION_ACTIVATION_CONTEXT_FLAG_USE_ACTIVE_ACTIVATION_CONTEXT<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>            <span class=\"token constant\">NULL</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>            <span class=\"token number\">0</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>            ActivationContextBasicInformation<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>            <span class=\"token operator\">&amp;</span>acbi<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>            <span class=\"token keyword\">sizeof</span><span class=\"token punctuation\">(</span>acbi<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>            <span class=\"token constant\">NULL</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token function\">NT_SUCCESS</span><span class=\"token punctuation\">(</span>Status<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>        <span class=\"token function\">DbgPrint</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"SXS: %s failing because RtlQueryInformationActivationContext() returned status %08lx\\n\"</span><span class=\"token punctuation\">,</span> __FUNCTION__<span class=\"token punctuation\">,</span> Status<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>        <span class=\"token keyword\">return</span> FALSE<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>    Argument3 <span class=\"token operator\">=</span> acbi<span class=\"token punctuation\">.</span>ActivationContext<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>acbi<span class=\"token punctuation\">.</span>Flags <span class=\"token operator\">&amp;</span> ACTIVATION_CONTEXT_FLAG_NO_INHERIT<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre>        <span class=\"token comment\">// We're not supposed to propogate the activation context; set it to a value to indicate such.</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre>        Argument3 <span class=\"token operator\">=</span> INVALID_ACTIVATION_CONTEXT<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre></pre></td></tr><tr><td data-num=\"58\"></td><td><pre>    Status <span class=\"token operator\">=</span> <span class=\"token function\">NtQueueApcThread</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"59\"></td><td><pre>                hThread<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre>                <span class=\"token operator\">&amp;</span>BaseDispatchAPC<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"61\"></td><td><pre>                Argument1<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"62\"></td><td><pre>                Argument2<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"63\"></td><td><pre>                Argument3</pre></td></tr><tr><td data-num=\"64\"></td><td><pre>                <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"65\"></td><td><pre></pre></td></tr><tr><td data-num=\"66\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span> <span class=\"token operator\">!</span><span class=\"token function\">NT_SUCCESS</span><span class=\"token punctuation\">(</span>Status<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"67\"></td><td><pre>        <span class=\"token keyword\">return</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"68\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"69\"></td><td><pre>    <span class=\"token keyword\">return</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"70\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>其中的  <code>RtlQueryInformationActivationContext</code>  函数也不知道有什么用，暂时不管，我们先分析主线，此函数又调用了  <code>NtQueueApcThread</code>  了</p>\n<h3 id=\"ntqueueapcthreadntkrnlpaexe\"><a class=\"anchor\" href=\"#ntqueueapcthreadntkrnlpaexe\">#</a> NtQueueApcThread(ntkrnlpa.exe)</h3>\n<p>在 Ntdll 中也有一个同名的函数，会通过快速调用，调用 ntkrnlpa 中的这个函数。这里就直接介绍这个函数了。</p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>NTSYSAPI</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>NTSTATUS</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>NTAPI</pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token function\">NtQueueApcThread</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    IN HANDLE ThreadHandle<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    IN PPS_APC_ROUTINE ApcRoutine<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    IN PVOID ApcArgument1<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    IN PVOID ApcArgument2<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    IN PVOID ApcArgument3</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token comment\">/*++</pre></td></tr><tr><td data-num=\"13\"></td><td><pre></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>Routine Description:</pre></td></tr><tr><td data-num=\"15\"></td><td><pre></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    This function is used to queue a user-mode APC to the specified thread. The APC</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    will fire when the specified thread does an alertable wait</pre></td></tr><tr><td data-num=\"18\"></td><td><pre></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>Arguments:</pre></td></tr><tr><td data-num=\"20\"></td><td><pre></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>    ThreadHandle - Supplies a handle to a thread object.  The caller</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>        must have THREAD_SET_CONTEXT access to the thread.</pre></td></tr><tr><td data-num=\"23\"></td><td><pre></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>    ApcRoutine - Supplies the address of the APC routine to execute when the</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>        APC fires.</pre></td></tr><tr><td data-num=\"26\"></td><td><pre></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>    ApcArgument1 - Supplies the first PVOID passed to the APC</pre></td></tr><tr><td data-num=\"28\"></td><td><pre></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>    ApcArgument2 - Supplies the second PVOID passed to the APC</pre></td></tr><tr><td data-num=\"30\"></td><td><pre></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>    ApcArgument3 - Supplies the third PVOID passed to the APC</pre></td></tr><tr><td data-num=\"32\"></td><td><pre></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>Return Value:</pre></td></tr><tr><td data-num=\"34\"></td><td><pre></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>    Returns an NT Status code indicating success or failure of the API</pre></td></tr><tr><td data-num=\"36\"></td><td><pre></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>--*/</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre></pre></td></tr><tr><td data-num=\"39\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>    PETHREAD Thread<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>    NTSTATUS st<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>    KPROCESSOR_MODE Mode<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>    PKAPC Apc<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>    <span class=\"token function\">PAGED_CODE</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>    Mode <span class=\"token operator\">=</span> <span class=\"token function\">KeGetPreviousMode</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>    st <span class=\"token operator\">=</span> <span class=\"token function\">ObReferenceObjectByHandle</span> <span class=\"token punctuation\">(</span>ThreadHandle<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>                                    THREAD_SET_CONTEXT<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>                                    PsThreadType<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre>                                    Mode<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>                                    <span class=\"token operator\">&amp;</span>Thread<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre>                                    <span class=\"token constant\">NULL</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">NT_SUCCESS</span> <span class=\"token punctuation\">(</span>st<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>        st <span class=\"token operator\">=</span> STATUS_SUCCESS<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">IS_SYSTEM_THREAD</span> <span class=\"token punctuation\">(</span>Thread<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre>            st <span class=\"token operator\">=</span> STATUS_INVALID_HANDLE<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"59\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre>            Apc <span class=\"token operator\">=</span> <span class=\"token function\">ExAllocatePoolWithQuotaTag</span> <span class=\"token punctuation\">(</span>NonPagedPool <span class=\"token operator\">|</span> POOL_QUOTA_FAIL_INSTEAD_OF_RAISE<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"61\"></td><td><pre>                                              <span class=\"token keyword\">sizeof</span><span class=\"token punctuation\">(</span><span class=\"token operator\">*</span>Apc<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"62\"></td><td><pre>                                              <span class=\"token string\">'pasP'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"63\"></td><td><pre></pre></td></tr><tr><td data-num=\"64\"></td><td><pre>            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>Apc <span class=\"token operator\">==</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"65\"></td><td><pre>                st <span class=\"token operator\">=</span> STATUS_NO_MEMORY<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"66\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"67\"></td><td><pre>                <span class=\"token function\">KeInitializeApc</span> <span class=\"token punctuation\">(</span>Apc<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"68\"></td><td><pre>                                 <span class=\"token operator\">&amp;</span>Thread<span class=\"token operator\">-></span>Tcb<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"69\"></td><td><pre>                                 OriginalApcEnvironment<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"70\"></td><td><pre>                                 PspQueueApcSpecialApc<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"71\"></td><td><pre>                                 <span class=\"token constant\">NULL</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"72\"></td><td><pre>                                 <span class=\"token punctuation\">(</span>PKNORMAL_ROUTINE<span class=\"token punctuation\">)</span>ApcRoutine<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"73\"></td><td><pre>                                 UserMode<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"74\"></td><td><pre>                                 ApcArgument1<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"75\"></td><td><pre></pre></td></tr><tr><td data-num=\"76\"></td><td><pre>                <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token function\">KeInsertQueueApc</span> <span class=\"token punctuation\">(</span>Apc<span class=\"token punctuation\">,</span> ApcArgument2<span class=\"token punctuation\">,</span> ApcArgument3<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"77\"></td><td><pre>                    <span class=\"token function\">ExFreePool</span> <span class=\"token punctuation\">(</span>Apc<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"78\"></td><td><pre>                    st <span class=\"token operator\">=</span> STATUS_UNSUCCESSFUL<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"79\"></td><td><pre>                <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"80\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"81\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"82\"></td><td><pre>        <span class=\"token function\">ObDereferenceObject</span> <span class=\"token punctuation\">(</span>Thread<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"83\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"84\"></td><td><pre></pre></td></tr><tr><td data-num=\"85\"></td><td><pre>    <span class=\"token keyword\">return</span> st<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"86\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>可以观察到，先申请了一块  <code>KAPC</code>  大小的内存，然后调用  <code>KeInitializeApc</code>  给 KAPC 初始化 ，初始化完成后，调用了  <code>KeInsertQueueApc</code>  插入了。</p>\n<p>注意这里有个细节：</p>\n<p><strong>验证了是否是系统进程，这是一个宏定义：  <code>#define IS_SYSTEM_THREAD(Thread)  (((Thread)-&gt;CrossThreadFlags&amp;PS_CROSS_THREAD_FLAGS_SYSTEM) != 0)</code>   利用这个特点，如果想要防止用户 APC 注入，可以更改线程标志。</strong></p>\n<h3 id=\"keinitializeapc初始化kapc结构体\"><a class=\"anchor\" href=\"#keinitializeapc初始化kapc结构体\">#</a> KeInitializeApc (初始化 KAPC 结构体)</h3>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>VOID <span class=\"token function\">KeInitializeApc</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  IN PKAPC Apc<span class=\"token punctuation\">,</span><span class=\"token comment\">//KAPC 指针</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  IN PKTHREAD Thread<span class=\"token punctuation\">,</span><span class=\"token comment\">// 目标线程</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  IN KAPC_ENVIRONMENT TargetEnvironment<span class=\"token punctuation\">,</span><span class=\"token comment\">//0 1 2 3 四种状态</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  IN PKKERNEL_ROUTINE KernelRoutine<span class=\"token punctuation\">,</span><span class=\"token comment\">// 销毁 KAPC 的函数地址</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  IN PKRUNDOWN_ROUTINE RundownRoutine OPTIONAL<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  IN PKNORMAL_ROUTINE NormalRoutine<span class=\"token punctuation\">,</span><span class=\"token comment\">// 用户 APC 总入口或者内核 apc 函数</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  IN KPROCESSOR_MODE Mode<span class=\"token punctuation\">,</span><span class=\"token comment\">// 要插入用户 apc 队列还是内核 apc 队列</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  IN PVOID NormalContext<span class=\"token comment\">// 内核 APC：NULL  用户 APC：真正的 APC 函数</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token punctuation\">)</span> </pre></td></tr><tr><td data-num=\"12\"></td><td><pre></pre></td></tr><tr><td data-num=\"13\"></td><td><pre></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token comment\">/*++</pre></td></tr><tr><td data-num=\"15\"></td><td><pre></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>Routine Description:</pre></td></tr><tr><td data-num=\"17\"></td><td><pre></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>这个函数初始化一个内核 APC 对象。 线程、内核例程和可选的常规例程、处理器模式和常规上下文参数都存储在 APC 对象中。 </pre></td></tr><tr><td data-num=\"19\"></td><td><pre></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>Arguments:</pre></td></tr><tr><td data-num=\"21\"></td><td><pre></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>    Apc - 提供一个指向 APC 类型控制对象的指针。</pre></td></tr><tr><td data-num=\"23\"></td><td><pre></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>    Thread - 提供一个指向线程类型的调度程序对象的指针。</pre></td></tr><tr><td data-num=\"25\"></td><td><pre></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>    Environment - 有效值为：OriginalApcEnvironment、attacheapcenvironment、CurrentApcEnvironment 或 InsertApcEnvironment。枚举类型 0 1 2 3</pre></td></tr><tr><td data-num=\"27\"></td><td><pre></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>    KernelRoutine - 提供一个指向在内核模式下 IRQL APC_LEVEL 执行的函数的指针。 </pre></td></tr><tr><td data-num=\"29\"></td><td><pre></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>    RundownRoutine - 提供一个可选的函数指针，当线程终止时，如果 APC 在线程的 APC 队列中，这个函数将被调用。</pre></td></tr><tr><td data-num=\"31\"></td><td><pre></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>    NormalRoutine - 提供一个指向函数的可选指针，该函数将在 IRQL 0 中以指定的处理器模式执行。 如果没有指定这个参数，则忽略 ProcessorMode 和 NormalContext 参数。</pre></td></tr><tr><td data-num=\"33\"></td><td><pre></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>    ApcMode - 提供处理器模式，在这种模式下，NormalRoutine 参数指定的函数将被执行。  </pre></td></tr><tr><td data-num=\"35\"></td><td><pre></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>    NormalContext - 提供指向任意数据结构的指针，该数据结构将被传递给 NormalRoutine 参数指定的函数。</pre></td></tr><tr><td data-num=\"37\"></td><td><pre></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>Return Value:</pre></td></tr><tr><td data-num=\"39\"></td><td><pre></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>    None.</pre></td></tr><tr><td data-num=\"41\"></td><td><pre></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>--*/</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre></pre></td></tr><tr><td data-num=\"44\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>    <span class=\"token function\">ASSERT</span><span class=\"token punctuation\">(</span>Environment <span class=\"token operator\">&lt;=</span> InsertApcEnvironment<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>    <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>    <span class=\"token comment\">// Initialize standard control object header.</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>    <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre></pre></td></tr><tr><td data-num=\"52\"></td><td><pre>    Apc<span class=\"token operator\">-></span>Type <span class=\"token operator\">=</span> ApcObject<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>    Apc<span class=\"token operator\">-></span>Size <span class=\"token operator\">=</span> <span class=\"token keyword\">sizeof</span><span class=\"token punctuation\">(</span>KAPC<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre></pre></td></tr><tr><td data-num=\"55\"></td><td><pre>    <span class=\"token comment\">/* </pre></td></tr><tr><td data-num=\"56\"></td><td><pre>    初始化 APC 环境、线程地址、内核例程地址、运行例程地址、普通例程地址、处理器模式和正常上下文参数。</pre></td></tr><tr><td data-num=\"57\"></td><td><pre>    如果正常的例程地址为 NULL，则处理器模式默认为 KernelMode，而 APC 是一个特殊的 APC。</pre></td></tr><tr><td data-num=\"58\"></td><td><pre>    否则，将从参数列表中提取处理器模式。</pre></td></tr><tr><td data-num=\"59\"></td><td><pre>    */</span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre></pre></td></tr><tr><td data-num=\"61\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>Environment <span class=\"token operator\">==</span> CurrentApcEnvironment<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"62\"></td><td><pre>        Apc<span class=\"token operator\">-></span>ApcStateIndex <span class=\"token operator\">=</span> Thread<span class=\"token operator\">-></span>ApcStateIndex<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"63\"></td><td><pre></pre></td></tr><tr><td data-num=\"64\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"65\"></td><td><pre></pre></td></tr><tr><td data-num=\"66\"></td><td><pre>        <span class=\"token function\">ASSERT</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>Environment <span class=\"token operator\">&lt;=</span> Thread<span class=\"token operator\">-></span>ApcStateIndex<span class=\"token punctuation\">)</span> <span class=\"token operator\">||</span> <span class=\"token punctuation\">(</span>Environment <span class=\"token operator\">==</span> InsertApcEnvironment<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"67\"></td><td><pre></pre></td></tr><tr><td data-num=\"68\"></td><td><pre>        Apc<span class=\"token operator\">-></span>ApcStateIndex <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>CCHAR<span class=\"token punctuation\">)</span>Environment<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"69\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"70\"></td><td><pre></pre></td></tr><tr><td data-num=\"71\"></td><td><pre>    Apc<span class=\"token operator\">-></span>Thread <span class=\"token operator\">=</span> Thread<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"72\"></td><td><pre>    Apc<span class=\"token operator\">-></span>KernelRoutine <span class=\"token operator\">=</span> KernelRoutine<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"73\"></td><td><pre>    Apc<span class=\"token operator\">-></span>RundownRoutine <span class=\"token operator\">=</span> RundownRoutine<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"74\"></td><td><pre>    Apc<span class=\"token operator\">-></span>NormalRoutine <span class=\"token operator\">=</span> NormalRoutine<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"75\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">ARGUMENT_PRESENT</span><span class=\"token punctuation\">(</span>NormalRoutine<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"76\"></td><td><pre>        Apc<span class=\"token operator\">-></span>ApcMode <span class=\"token operator\">=</span> ApcMode<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"77\"></td><td><pre>        Apc<span class=\"token operator\">-></span>NormalContext <span class=\"token operator\">=</span> NormalContext<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"78\"></td><td><pre></pre></td></tr><tr><td data-num=\"79\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"80\"></td><td><pre>        Apc<span class=\"token operator\">-></span>ApcMode <span class=\"token operator\">=</span> KernelMode<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"81\"></td><td><pre>        Apc<span class=\"token operator\">-></span>NormalContext <span class=\"token operator\">=</span> NIL<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"82\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"83\"></td><td><pre></pre></td></tr><tr><td data-num=\"84\"></td><td><pre>    Apc<span class=\"token operator\">-></span>Inserted <span class=\"token operator\">=</span> FALSE<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"85\"></td><td><pre>    <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"86\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h3 id=\"keinsertqueueapc\"><a class=\"anchor\" href=\"#keinsertqueueapc\">#</a> KeInsertQueueApc</h3>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>BOOLEAN</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token function\">KeInsertQueueApc</span> <span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    IN PRKAPC Apc<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    IN PVOID SystemArgument1<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    IN PVOID SystemArgument2<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    IN KPRIORITY Increment</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token comment\">/*++</pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>Routine Description:</pre></td></tr><tr><td data-num=\"12\"></td><td><pre></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>  这个函数将一个 APC 对象插入到 APC 队列中，该队列由 APC 对象的线程和处理器模式字段指定。</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>  如果 APC 对象已经在 APC 队列中或 APC 队列被禁用，则不执行任何操作。 </pre></td></tr><tr><td data-num=\"15\"></td><td><pre>  否则，APC 对象被插入到指定的队列中，并做出适当的调度决策。  </pre></td></tr><tr><td data-num=\"16\"></td><td><pre></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>Arguments:</pre></td></tr><tr><td data-num=\"18\"></td><td><pre></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    Apc - 提供一个指向 APC 类型控制对象的指针。  </pre></td></tr><tr><td data-num=\"20\"></td><td><pre></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>    SystemArgument1, SystemArgument2 - 提供一组包含执行程序提供的非类型化数据的两个参数。  </pre></td></tr><tr><td data-num=\"22\"></td><td><pre></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>    Increment - 提供优先级增量，如果排队的 APC 导致一个线程等待满足。  </pre></td></tr><tr><td data-num=\"24\"></td><td><pre></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>Return Value:</pre></td></tr><tr><td data-num=\"26\"></td><td><pre></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>    如果 APC 对象已经在 APC 队列中，或者禁用 APC 队列，则返回 false 值。否则，将返回一个 TRUE 的值。</pre></td></tr><tr><td data-num=\"28\"></td><td><pre></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>--*/</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre></pre></td></tr><tr><td data-num=\"31\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>    BOOLEAN Inserted<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>    KLOCK_QUEUE_HANDLE LockHandle<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>    KIRQL OldIrql<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>    PRKTHREAD Thread<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>    <span class=\"token function\">ASSERT_APC</span><span class=\"token punctuation\">(</span>Apc<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>    <span class=\"token function\">ASSERT</span><span class=\"token punctuation\">(</span><span class=\"token function\">KeGetCurrentIrql</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;=</span> DISPATCH_LEVEL<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>    <span class=\"token comment\">// 将 IROL 提升到 SYNCH_LEVEL _ level，获取线程 APC 队列锁，并锁定调度程序数据库。</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>    Thread <span class=\"token operator\">=</span> Apc<span class=\"token operator\">-></span>Thread<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>    <span class=\"token function\">KeAcquireInStackQueuedSpinLockRaiseToSynch</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>Thread<span class=\"token operator\">-></span>ApcQueueLock<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>LockHandle<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>    <span class=\"token function\">KiLockDispatcherDatabaseAtSynchLevel</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>    <span class=\"token comment\">// 如果 Apc 队列被禁用，则将 inserted 设置为 FALSE。否则，将系统参数值保存在 APC 对象中，并尝试对 APC 进行排队。</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>Thread<span class=\"token operator\">-></span>ApcQueueable <span class=\"token operator\">==</span> FALSE<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>        Inserted <span class=\"token operator\">=</span> FALSE<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre></pre></td></tr><tr><td data-num=\"52\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>        Apc<span class=\"token operator\">-></span>SystemArgument1 <span class=\"token operator\">=</span> SystemArgument1<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre>        Apc<span class=\"token operator\">-></span>SystemArgument2 <span class=\"token operator\">=</span> SystemArgument2<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre>        Inserted <span class=\"token operator\">=</span> <span class=\"token function\">KiInsertQueueApc</span><span class=\"token punctuation\">(</span>Apc<span class=\"token punctuation\">,</span> Increment<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre></pre></td></tr><tr><td data-num=\"58\"></td><td><pre>    <span class=\"token comment\">// 从同步级别解锁调度程序数据库，将线程 APC 队列锁和较低的 IRQL 解锁到其先前的值，并返回是否插入了 APC。</span></pre></td></tr><tr><td data-num=\"59\"></td><td><pre></pre></td></tr><tr><td data-num=\"60\"></td><td><pre>    <span class=\"token function\">KiUnlockDispatcherDatabaseFromSynchLevel</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"61\"></td><td><pre>    <span class=\"token function\">KeReleaseInStackQueuedSpinLock</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>LockHandle<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"62\"></td><td><pre>    <span class=\"token keyword\">return</span> Inserted<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"63\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>此函数又调用  <code>KiInsertQueueApc</code>  函数</p>\n<h3 id=\"kiinsertqueueapc\"><a class=\"anchor\" href=\"#kiinsertqueueapc\">#</a> KiInsertQueueApc</h3>\n<p>KiInsertQueueApc 说明：</p>\n<ol>\n<li>\n<p>根据 KAPC 结构中的 ApcStateIndex 找到对应的 APC 队列</p>\n</li>\n<li>\n<p>再根据 KAPC 结构中的 ApcMode 确定是用户队列还是内核队列</p>\n</li>\n<li>\n<p>将 KAPC 挂到对应的队列中 (挂到 KAPC 的 ApcListEntry 处)</p>\n</li>\n<li>\n<p>再根据 KAPC 结构中的 Inserted 置 1，标识当前的 KAPC 为已插入状态</p>\n</li>\n<li>\n<p>修改 KAPC_STATE 结构中的 KernelApcPending/UserApcPending</p>\n</li>\n</ol>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>BOOLEAN</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>FASTCALL</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token function\">KiInsertQueueApc</span> <span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    IN PKAPC Apc<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    IN KPRIORITY Increment</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token comment\">/*++</pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>Routine Description:</pre></td></tr><tr><td data-num=\"11\"></td><td><pre></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    此函数将 APC 对象插入到线程的 APC 队列中。</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    线程对象的地址、APC 队列和 APC 的类型都是从 APC 对象派生出来的。</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    如果 APC 对象已经在 APC 队列中，则不执行操作并返回函数值 False。</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    如果将 APC 插入到指定的 APC 队列中，则将其插入状态设置为 true，并返回函数值 true。</pre></td></tr><tr><td data-num=\"16\"></td><td><pre></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    N.B. 在调用此例程时，必须保持线程 APC 队列锁和调度程序数据库锁定。</pre></td></tr><tr><td data-num=\"18\"></td><td><pre></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>Arguments:</pre></td></tr><tr><td data-num=\"20\"></td><td><pre></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>    Apc - Supplies a pointer to a control object of type APC.</pre></td></tr><tr><td data-num=\"22\"></td><td><pre></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>    Increment - Supplies the priority increment that is to be applied if</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>        queuing the APC causes a thread wait to be satisfied.</pre></td></tr><tr><td data-num=\"25\"></td><td><pre></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>Return Value:</pre></td></tr><tr><td data-num=\"27\"></td><td><pre></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>    If the APC object is already in an APC queue, then a value of FALSE is</pre></td></tr><tr><td data-num=\"29\"></td><td><pre>    returned. Else a value of TRUE is returned.</pre></td></tr><tr><td data-num=\"30\"></td><td><pre></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>--*/</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre></pre></td></tr><tr><td data-num=\"33\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>    KPROCESSOR_MODE ApcMode<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>    PKAPC ApcEntry<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>    PKAPC_STATE ApcState<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>    BOOLEAN Inserted<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>    PLIST_ENTRY ListEntry<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>    PKTHREAD Thread<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>    <span class=\"token comment\">// 如果 APC 对象已经在 APC 队列中，则将插入设置为 FALSE。</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>    <span class=\"token comment\">// 否则将 APC 对象插入到适当的队列中，将 APC 插入状态设置为 TRUE，检查 APC 是否应该立即交付，并将插入状态设置为 TRUE。 </span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>    <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>    <span class=\"token comment\">// For multiprocessor performance, the following code utilizes the fact</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>    <span class=\"token comment\">// that kernel APC disable count is incremented before checking whether</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>    <span class=\"token comment\">// the kernel APC queue is nonempty.</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>    <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>    <span class=\"token comment\">// See KeLeaveCriticalRegion().</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>    <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre></pre></td></tr><tr><td data-num=\"52\"></td><td><pre>    Thread <span class=\"token operator\">=</span> Apc<span class=\"token operator\">-></span>Thread<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>Apc<span class=\"token operator\">-></span>Inserted<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre>        Inserted <span class=\"token operator\">=</span> FALSE<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>Apc<span class=\"token operator\">-></span>ApcStateIndex <span class=\"token operator\">==</span> InsertApcEnvironment<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre>            Apc<span class=\"token operator\">-></span>ApcStateIndex <span class=\"token operator\">=</span> Thread<span class=\"token operator\">-></span>ApcStateIndex<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"59\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre></pre></td></tr><tr><td data-num=\"61\"></td><td><pre>        ApcState <span class=\"token operator\">=</span> Thread<span class=\"token operator\">-></span>ApcStatePointer<span class=\"token punctuation\">[</span>Apc<span class=\"token operator\">-></span>ApcStateIndex<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"62\"></td><td><pre></pre></td></tr><tr><td data-num=\"63\"></td><td><pre>        <span class=\"token comment\">// 如果 NormalRoutine 值为 NULL，【则在处理器模式选择的所有其他特殊 APC 项之后插入 APC】。  </span></pre></td></tr><tr><td data-num=\"64\"></td><td><pre>        <span class=\"token comment\">// 否则，将 APC 对象插入处理器模式选择的 APC 队列的尾部，除非 APC 模式是用户模式，</span></pre></td></tr><tr><td data-num=\"65\"></td><td><pre>        <span class=\"token comment\">// 特殊的 APC 例程的地址是退出线程，在这种情况下，将 APC 插入到列表的前面，并设置用户 APC 挂起。  </span></pre></td></tr><tr><td data-num=\"66\"></td><td><pre></pre></td></tr><tr><td data-num=\"67\"></td><td><pre></pre></td></tr><tr><td data-num=\"68\"></td><td><pre>        ApcMode <span class=\"token operator\">=</span> Apc<span class=\"token operator\">-></span>ApcMode<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"69\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>Apc<span class=\"token operator\">-></span>NormalRoutine <span class=\"token operator\">!=</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"70\"></td><td><pre>            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>ApcMode <span class=\"token operator\">!=</span> KernelMode<span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token punctuation\">(</span>Apc<span class=\"token operator\">-></span>KernelRoutine <span class=\"token operator\">==</span> PsExitSpecialApc<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"71\"></td><td><pre>                Thread<span class=\"token operator\">-></span>ApcState<span class=\"token punctuation\">.</span>UserApcPending <span class=\"token operator\">=</span> TRUE<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"72\"></td><td><pre>                <span class=\"token function\">InsertHeadList</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>ApcState<span class=\"token operator\">-></span>ApcListHead<span class=\"token punctuation\">[</span>ApcMode<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"73\"></td><td><pre>                               <span class=\"token operator\">&amp;</span>Apc<span class=\"token operator\">-></span>ApcListEntry<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"74\"></td><td><pre></pre></td></tr><tr><td data-num=\"75\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"76\"></td><td><pre>                <span class=\"token comment\">// 内核模式</span></pre></td></tr><tr><td data-num=\"77\"></td><td><pre>                <span class=\"token function\">InsertTailList</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>ApcState<span class=\"token operator\">-></span>ApcListHead<span class=\"token punctuation\">[</span>ApcMode<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"78\"></td><td><pre>                               <span class=\"token operator\">&amp;</span>Apc<span class=\"token operator\">-></span>ApcListEntry<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"79\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"80\"></td><td><pre></pre></td></tr><tr><td data-num=\"81\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"82\"></td><td><pre>            ListEntry <span class=\"token operator\">=</span> ApcState<span class=\"token operator\">-></span>ApcListHead<span class=\"token punctuation\">[</span>ApcMode<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>Blink<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"83\"></td><td><pre>            <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span>ListEntry <span class=\"token operator\">!=</span> <span class=\"token operator\">&amp;</span>ApcState<span class=\"token operator\">-></span>ApcListHead<span class=\"token punctuation\">[</span>ApcMode<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"84\"></td><td><pre>                ApcEntry <span class=\"token operator\">=</span> <span class=\"token function\">CONTAINING_RECORD</span><span class=\"token punctuation\">(</span>ListEntry<span class=\"token punctuation\">,</span> KAPC<span class=\"token punctuation\">,</span> ApcListEntry<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"85\"></td><td><pre>                <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>ApcEntry<span class=\"token operator\">-></span>NormalRoutine <span class=\"token operator\">==</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"86\"></td><td><pre>                    <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"87\"></td><td><pre>                <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"88\"></td><td><pre></pre></td></tr><tr><td data-num=\"89\"></td><td><pre>                ListEntry <span class=\"token operator\">=</span> ListEntry<span class=\"token operator\">-></span>Blink<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"90\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"91\"></td><td><pre></pre></td></tr><tr><td data-num=\"92\"></td><td><pre>            <span class=\"token function\">InsertHeadList</span><span class=\"token punctuation\">(</span>ListEntry<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>Apc<span class=\"token operator\">-></span>ApcListEntry<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"93\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"94\"></td><td><pre></pre></td></tr><tr><td data-num=\"95\"></td><td><pre>        Apc<span class=\"token operator\">-></span>Inserted <span class=\"token operator\">=</span> TRUE<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"96\"></td><td><pre></pre></td></tr><tr><td data-num=\"97\"></td><td><pre>        <span class=\"token comment\">// 如果 APC 对象的 APC 索引与线程的 APC 索引相匹配，那么检查 APC 是否应该中断线程执行，或者让线程进入等待状态。</span></pre></td></tr><tr><td data-num=\"98\"></td><td><pre></pre></td></tr><tr><td data-num=\"99\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>Apc<span class=\"token operator\">-></span>ApcStateIndex <span class=\"token operator\">==</span> Thread<span class=\"token operator\">-></span>ApcStateIndex<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"100\"></td><td><pre></pre></td></tr><tr><td data-num=\"101\"></td><td><pre>            <span class=\"token comment\">// 如果 APC 的处理器模式是内核模式，那么检查 APC 是否应该中断线程或使线程脱离等待状态。 </span></pre></td></tr><tr><td data-num=\"102\"></td><td><pre>            <span class=\"token comment\">// 否则检查 APC 是否应该对线程进行排序，使其脱离可提醒的等待状态。  </span></pre></td></tr><tr><td data-num=\"103\"></td><td><pre></pre></td></tr><tr><td data-num=\"104\"></td><td><pre>            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>ApcMode <span class=\"token operator\">==</span> KernelMode<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"105\"></td><td><pre>                Thread<span class=\"token operator\">-></span>ApcState<span class=\"token punctuation\">.</span>KernelApcPending <span class=\"token operator\">=</span> TRUE<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"106\"></td><td><pre>                <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>Thread<span class=\"token operator\">-></span>State <span class=\"token operator\">==</span> Running<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"107\"></td><td><pre>                    <span class=\"token comment\">// 这个函数会获取  APC_LEVEL 等级的 IRQL</span></pre></td></tr><tr><td data-num=\"108\"></td><td><pre>                    <span class=\"token function\">KiRequestApcInterrupt</span><span class=\"token punctuation\">(</span>Thread<span class=\"token operator\">-></span>NextProcessor<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"109\"></td><td><pre></pre></td></tr><tr><td data-num=\"110\"></td><td><pre>                <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>Thread<span class=\"token operator\">-></span>State <span class=\"token operator\">==</span> Waiting<span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;&amp;</span></pre></td></tr><tr><td data-num=\"111\"></td><td><pre>                          <span class=\"token punctuation\">(</span>Thread<span class=\"token operator\">-></span>WaitIrql <span class=\"token operator\">==</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;&amp;</span></pre></td></tr><tr><td data-num=\"112\"></td><td><pre>                          <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>Apc<span class=\"token operator\">-></span>NormalRoutine <span class=\"token operator\">==</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">||</span></pre></td></tr><tr><td data-num=\"113\"></td><td><pre>                          <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>Thread<span class=\"token operator\">-></span>KernelApcDisable <span class=\"token operator\">==</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;&amp;</span></pre></td></tr><tr><td data-num=\"114\"></td><td><pre>                          <span class=\"token punctuation\">(</span>Thread<span class=\"token operator\">-></span>ApcState<span class=\"token punctuation\">.</span>KernelApcInProgress <span class=\"token operator\">==</span> FALSE<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"115\"></td><td><pre>                    <span class=\"token comment\">// 唤醒线程 使其从等待队列中移除</span></pre></td></tr><tr><td data-num=\"116\"></td><td><pre>                    <span class=\"token function\">KiUnwaitThread</span><span class=\"token punctuation\">(</span>Thread<span class=\"token punctuation\">,</span> STATUS_KERNEL_APC<span class=\"token punctuation\">,</span> Increment<span class=\"token punctuation\">,</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"117\"></td><td><pre>                <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"118\"></td><td><pre>            <span class=\"token comment\">// 如果不是内核模式那么</span></pre></td></tr><tr><td data-num=\"119\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>Thread<span class=\"token operator\">-></span>State <span class=\"token operator\">==</span> Waiting<span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;&amp;</span></pre></td></tr><tr><td data-num=\"120\"></td><td><pre>                      <span class=\"token punctuation\">(</span>Thread<span class=\"token operator\">-></span>WaitMode <span class=\"token operator\">==</span> UserMode<span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;&amp;</span></pre></td></tr><tr><td data-num=\"121\"></td><td><pre>                      <span class=\"token punctuation\">(</span>Thread<span class=\"token operator\">-></span>Alertable <span class=\"token operator\">||</span> Thread<span class=\"token operator\">-></span>ApcState<span class=\"token punctuation\">.</span>UserApcPending<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"122\"></td><td><pre></pre></td></tr><tr><td data-num=\"123\"></td><td><pre>                Thread<span class=\"token operator\">-></span>ApcState<span class=\"token punctuation\">.</span>UserApcPending <span class=\"token operator\">=</span> TRUE<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"124\"></td><td><pre>                <span class=\"token function\">KiUnwaitThread</span><span class=\"token punctuation\">(</span>Thread<span class=\"token punctuation\">,</span> STATUS_USER_APC<span class=\"token punctuation\">,</span> Increment<span class=\"token punctuation\">,</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"125\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"126\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"127\"></td><td><pre></pre></td></tr><tr><td data-num=\"128\"></td><td><pre>        Inserted <span class=\"token operator\">=</span> TRUE<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"129\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"130\"></td><td><pre></pre></td></tr><tr><td data-num=\"131\"></td><td><pre>    <span class=\"token comment\">// 返回 APC 对象是否插入到 APC 队列中。</span></pre></td></tr><tr><td data-num=\"132\"></td><td><pre></pre></td></tr><tr><td data-num=\"133\"></td><td><pre>    <span class=\"token keyword\">return</span> Inserted<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"134\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h1 id=\"作业\"><a class=\"anchor\" href=\"#作业\">#</a> 作业</h1>\n<ol>\n<li>\n<p>创建一个进程，使用 Sleep () 函数让其处于等待状态，然后向其 APC 队列插入 APC, 观蔡是否执行。</p>\n</li>\n<li>\n<p>如何让上题中的 APC 函数执行？</p>\n</li>\n</ol>\n<p>代码：</p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">_WIN32_WINNT</span> <span class=\"token expression\"><span class=\"token number\">0x0400</span></span></span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span><span class=\"token string\">&lt;windows.h></span></span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span><span class=\"token string\">&lt;stdio.h></span></span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>DWORD WINAPI <span class=\"token function\">ThreadProc</span><span class=\"token punctuation\">(</span>LPVOID pM<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>\t<span class=\"token comment\">//SleepEx(3000,TRUE);</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\t<span class=\"token function\">Sleep</span><span class=\"token punctuation\">(</span><span class=\"token number\">10000</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\t<span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> <span class=\"token number\">100</span><span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>\t\t<span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"ThreadProc执行了 %d\\n\"</span><span class=\"token punctuation\">,</span> i<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>\t<span class=\"token function\">SleepEx</span><span class=\"token punctuation\">(</span><span class=\"token number\">3000</span><span class=\"token punctuation\">,</span> TRUE<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>\t<span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> k <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> k <span class=\"token operator\">&lt;</span> <span class=\"token number\">100</span><span class=\"token punctuation\">;</span> k<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>\t\t<span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"ThreadProc执行了-%d\\n\"</span><span class=\"token punctuation\">,</span> k<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>\t<span class=\"token keyword\">return</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre><span class=\"token keyword\">void</span> WINAPI <span class=\"token function\">ApcProc</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">unsigned</span> <span class=\"token keyword\">long</span> para<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>\t<span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"ApcProc执行了-------!\\n\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre><span class=\"token keyword\">void</span> WINAPI <span class=\"token function\">ApcProc2</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">unsigned</span> <span class=\"token keyword\">long</span> para<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>\t<span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"ApcProc2执行了-------!\\n\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre><span class=\"token keyword\">int</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> argc<span class=\"token punctuation\">,</span> <span class=\"token keyword\">char</span><span class=\"token operator\">*</span> argv<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>\tDWORD dwRet<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>\tHANDLE handle <span class=\"token operator\">=</span> <span class=\"token function\">CreateThread</span><span class=\"token punctuation\">(</span><span class=\"token constant\">NULL</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> ThreadProc<span class=\"token punctuation\">,</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>\t<span class=\"token comment\">// 注入 APC </span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>\t<span class=\"token function\">Sleep</span><span class=\"token punctuation\">(</span><span class=\"token number\">3000</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>\tdwRet <span class=\"token operator\">=</span> <span class=\"token function\">QueueUserAPC</span><span class=\"token punctuation\">(</span>ApcProc<span class=\"token punctuation\">,</span> handle<span class=\"token punctuation\">,</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>dwRet<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>\t\t<span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Apc1插入成功！\\n\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>\t\tdwRet <span class=\"token operator\">=</span> <span class=\"token function\">QueueUserAPC</span><span class=\"token punctuation\">(</span>ApcProc2<span class=\"token punctuation\">,</span> handle<span class=\"token punctuation\">,</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>\t\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>dwRet<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>\t\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>\t\t\t<span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Apc2插入成功！\\n\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>\t<span class=\"token function\">getchar</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre></pre></td></tr><tr><td data-num=\"48\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>当 APC 被唤醒的时候两个 APC 一起执行了。</p>\n<p><img data-src=\"image001.png\" alt=\"\" /></p>\n<p>设置为可被唤醒状态时</p>\n<p><img data-src=\"image002.png\" alt=\"\" /></p>\n",
            "tags": [
                "KAPC",
                "QueueUserAPC",
                "NtQueueApcThread",
                "KeInitializeApc",
                "KeInsertQueueApc",
                "KiInsertQueueApc"
            ]
        },
        {
            "id": "https://or0kit.github.io/Bin/Core/WindowsXp/Apc/APC%E6%9C%BA%E5%88%B6-02APC%E7%9A%84%E5%A4%87%E7%94%A8%E9%98%9F%E5%88%97/",
            "url": "https://or0kit.github.io/Bin/Core/WindowsXp/Apc/APC%E6%9C%BA%E5%88%B6-02APC%E7%9A%84%E5%A4%87%E7%94%A8%E9%98%9F%E5%88%97/",
            "title": "APC机制-02APC的备用队列",
            "date_published": "2022-02-25T11:22:59.000Z",
            "content_html": "<h1 id=\"楔子\"><a class=\"anchor\" href=\"#楔子\">#</a> 楔子</h1>\n<p>要点回顾：在上一节中我们讲过，如果想让线程做什么事情，就给它的 APC 队列里面挂一个 APC。</p>\n<p>发现在  <code>KTHREAD</code>  结构体中除了  <code>ApcState</code>  还有其他与 APC 相关的成员</p>\n<figure class=\"highlight raw\"><figcaption data-lang=\"\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>kd&gt; dt _KTHREAD</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>nt!_KTHREAD</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>   ...</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>   +0x034 ApcState         : _KAPC_STATE</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>   ...</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>   +0x138 ApcStatePointer  : [2] Ptr32 _KAPC_STATE</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  ...</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>   +0x14c SavedApcState    : _KAPC_STATE</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  ...</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>   +0x165 ApcStateIndex    : UChar</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>   +0x166 ApcQueueable     : UChar</pre></td></tr></table></figure><p>以下内容就是为了弄清楚这些成员的作用。</p>\n<h2 id=\"savedapcstate的意义\"><a class=\"anchor\" href=\"#savedapcstate的意义\">#</a> SavedApcState 的意义</h2>\n<p>线程 APC 队列中的 APC 函数都是与进程相关联的，具体点说：A 进程的 T 线程中的所有 APC 函数，要访问的内存地址都是 A 进程的。</p>\n<p>但线程是可以挂靠到其他的进程：比如 A 进程的线程 T，通过修改 Cr3 (改为 B 进程的页目录基址)，就可以访问 B 进程地址空间，即所谓 “进程挂靠”。</p>\n<p>当 T 线程挂靠 B 进程后，APC 队列中存储的却仍然是原来的 APC！具体点说，比如某个 APC 函数要读取一个地址为 0x12345678 的数据，如果此时进行读取，读到的将是 B 进程的地址空间，这样逻辑就错误了！</p>\n<p>为了避免混乱，在 T 线程挂靠 B 进程时，会将 ApcState 中的值暂时存储到 SavedApcState 中，等回到原进程 A 时，再将 APC 队列恢复。</p>\n<p>所以，  <code>SavedApcState</code>  又称为备用 APC 队列。</p>\n<h2 id=\"挂靠环境下apcstate的意义\"><a class=\"anchor\" href=\"#挂靠环境下apcstate的意义\">#</a> 挂靠环境下 ApcState 的意义</h2>\n<p>在挂靠的环境下，也是可以向线程 APC 队列插入 APC 的，那这种情况下，使用的是哪个 APC 队列呢？</p>\n<p>当 A 进程的 T 线程挂靠 B 进程时，A 是 T 的所属进程，B 是 T 的挂靠进程。</p>\n<p><code>ApcState</code>     \tB 进程相关的 APC 函数</p>\n<p><code>SavedApcState</code> \tA 进程相关的 APC 函数</p>\n<p>在正常情况下，当前进程就是所属进程 A，如果是挂靠情况下，当前进程就是挂靠进程 B。</p>\n<p>当前进程与当前线程，有相关的 API 获取，查看这些函数，可以发现他们的本质都是取 fs:[0x124] 接着又取 0x44 。</p>\n<h2 id=\"apcstatepointer\"><a class=\"anchor\" href=\"#apcstatepointer\">#</a> ApcStatePointer</h2>\n<p>为了操作方便，_KTHREAD 结构体中定义了一个指针数组  <code>ApcStatePointer</code>  ，长度为 2。</p>\n<p>正常情况下</p>\n<div class=\"note primary no-icon\">\n<p>ApcStatePointer [0]  指向  <code>ApcState</code> <br />\nApcStatePointer [1]  指向  <code>SavedApcState</code></p>\n</div>\n<p>挂靠情况下：</p>\n<div class=\"note primary no-icon\">\n<p>ApcStatePointer [0]  指向  <code>SavedApcState</code> <br />\nApcStatePointer [1]  指向  <code>ApcState</code></p>\n</div>\n<h2 id=\"apcstateindex\"><a class=\"anchor\" href=\"#apcstateindex\">#</a> ApcStateIndex</h2>\n<p>ApcStateIndex 用来标识当前线程处于什么状态：</p>\n<p><code>0</code>  正常状态<br />\n <code>1</code>  挂靠状态</p>\n<h2 id=\"apcstatepointer-与-apcstateindex组合寻址\"><a class=\"anchor\" href=\"#apcstatepointer-与-apcstateindex组合寻址\">#</a> ApcStatePointer 与 ApcStateIndex 组合寻址</h2>\n<p>正常情况下，向 ApcState 队列中插入 APC 时：</p>\n<p>ApcStatePointer [0]  指向  <code>ApcState</code>  此时 ApcStateIndex 的值为 0<br />\nApcStatePointer [ApcStateIndex]  指向  <code>ApcState</code></p>\n<p>挂靠情况下，向 ApcState 队列中插入 APC 时：<br />\nApcStatePointer [1]  指向  <code>ApcState</code>  此时 ApcStateIndex 的值为 1<br />\nApcStatePointer [ApcStateIndex]  指向  <code>ApcState</code></p>\n<p>总结：<br />\n无论什么环境下，ApcStatePointer [ApcStateIndex] 指向的都是  <code>ApcState</code>  。<br />\n <code>ApcState</code>  则总是表示线程<strong>当前</strong>使用的 apc 状态。</p>\n<h2 id=\"apcqueueable\"><a class=\"anchor\" href=\"#apcqueueable\">#</a> ApcQueueable</h2>\n<p><strong>ApcQueueable 用于表示是否可以向线程的 APC 队列中插入 APC。</strong></p>\n<p>当线程正在执行退出的代码时，会将这个值设置为 0 ，如果此时执行插入 APC 的代码 (KeInsertQueueApc 后面会讲), 在插入函数中会判断这个值的状态，如果为 0，则插入失败。</p>\n<h2 id=\"作业\"><a class=\"anchor\" href=\"#作业\">#</a> 作业</h2>\n<p>分析 API  <code>NtReadVirtualMemory</code>  。<br />\n目的是了解挂靠到底做了什么、APC 是如何备份的、什么时候备份、什么时候还原的。</p>\n<p>回去写进程的挂靠和跨进程读写内存了。</p>\n<p><a href=\"https://or0kit.github.io/%E8%BF%9B%E7%A8%8B%E4%B8%8E%E7%BA%BF%E7%A8%8B-%E8%BF%9B%E7%A8%8B%E6%8C%82%E9%9D%A0%E5%92%8C%E8%B7%A8%E8%BF%9B%E7%A8%8B%E8%AF%BB%E5%86%99%E5%86%85%E5%AD%98/\">https://or0kit.github.io/ 进程与线程 - 进程挂靠和跨进程读写内存 /</a></p>\n",
            "tags": [
                "APC的备用队列"
            ]
        },
        {
            "id": "https://or0kit.github.io/Bin/Core/WindowsXp/Apc/APC%E6%9C%BA%E5%88%B6-01%E5%88%9D%E8%AF%86APC/",
            "url": "https://or0kit.github.io/Bin/Core/WindowsXp/Apc/APC%E6%9C%BA%E5%88%B6-01%E5%88%9D%E8%AF%86APC/",
            "title": "APC机制-01初识APC",
            "date_published": "2022-02-24T06:35:12.000Z",
            "content_html": "<h1 id=\"楔子\"><a class=\"anchor\" href=\"#楔子\">#</a> 楔子</h1>\n<p>线程是不能被 “杀掉”、“挂起” 和 “恢复” 的，线程在执行的时候自己占据着 CPU，无论多核还是单核，线程都是自己做的这些事，那么其他线程如何控制它呢？如何改变一个线程的行为？可以给他提供一个函数，让它自己去调用，这个函数就是 APC (Asyncroneus Procedure Call)，即异步过程调用。</p>\n<p>首先有以下疑问：</p>\n<blockquote>\n<p>至于为什么会执行 APC，上述已说。<br />\n谁插入的 APC？<br />\n插入到哪里？<br />\n谁执行的 APC？<br />\n什么时候执行 APC？</p>\n</blockquote>\n<h2 id=\"apc-队列\"><a class=\"anchor\" href=\"#apc-队列\">#</a> APC 队列</h2>\n<figure class=\"highlight raw\"><figcaption data-lang=\"\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>kd&gt; dt _KTHREAD</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>nt!_KTHREAD</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>\t...</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>\t   +0x034 ApcState         : _KAPC_STATE</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>\t...</pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>kd&gt; dt _KAPC_STATE</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>nt!_KAPC_STATE</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>   +0x000 ApcListHead\t&#x2F;&#x2F;2 个 APC 队列 用户 APC 和内核 APC </pre></td></tr><tr><td data-num=\"10\"></td><td><pre>   +0x010 Process\t\t&#x2F;&#x2F; 线程所属或者所挂靠的进程</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>   +0x014 KernelApcInProgress\t&#x2F;&#x2F; 内核 APC 是否正在执行</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>   +0x015 KernelApcPending\t&#x2F;&#x2F; 是否有正在等待执行的内核 APC</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>   +0x016 UserApcPending\t&#x2F;&#x2F; 是否有正在等待执行的用户 APC</pre></td></tr></table></figure><p>用户 APC：APC 函数地址位于用户空间，在用户空间执行.<br />\n 内核 APC：APC 函数地址位于内核空间，在内核空间执行.</p>\n<h2 id=\"apc-结构\"><a class=\"anchor\" href=\"#apc-结构\">#</a> APC 结构</h2>\n<figure class=\"highlight raw\"><figcaption data-lang=\"\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>kd&gt; dt _KAPC</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>nt!_KAPC</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>   +0x000 Type</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>   +0x002 Size</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>   +0x004 Spare0                                 </pre></td></tr><tr><td data-num=\"6\"></td><td><pre>   +0x008 Thread                                 </pre></td></tr><tr><td data-num=\"7\"></td><td><pre>   +0x00c ApcListEntry</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>   +0x014 KernelRoutine</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>   +0x018 RundownRoutine</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>   +0x01c NormalRoutine   &#x2F;&#x2F; 找到你提供的 APC 函数，并不完全等于 APC 函数的地址，后面会讲。</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>   +0x020 NormalContext</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>   +0x024 SystemArgument1</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>   +0x028 SystemArgument2</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>   +0x02c ApcStateIndex</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>   +0x02d ApcMode</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>   +0x02e Inserted</pre></td></tr></table></figure><h2 id=\"apc函数何时被执行\"><a class=\"anchor\" href=\"#apc函数何时被执行\">#</a> APC 函数何时被执行？</h2>\n<p><code>KiServiceExit</code>  函数：这个函数是系统调用、异常或中断返回用户空间的必经之路。</p>\n<p><code>KiDeliverApc</code>  函数：负责执行 APC 函数。</p>\n<h2 id=\"分析-terminatethread-和-suspendthread-函数\"><a class=\"anchor\" href=\"#分析-terminatethread-和-suspendthread-函数\">#</a> 分析 TerminateThread 和 SuspendThread 函数</h2>\n<p>分析  <code>TerminateThread</code>  /  <code>SuspendThread</code>  是如何实现的（从 3 环开始分析）以此证明控制别的线程就是通过 APC 实现的。</p>\n<p>分析流程为：</p>\n<ol>\n<li><code>TerminateThread -&gt; NtTerminateThread -&gt; PspTerminateThreadByPointer -&gt; KeInitializeApc、KeInsertQueueApc</code></li>\n<li><code>SuspendThread -&gt; NtSuspendThread -&gt; PsSuspendThread -&gt; KeSuspendThread -&gt; KiInsertQueueApc</code></li>\n</ol>\n<p>可以发现函数调用到最后都是通过 APC 控制的。</p>\n<h2 id=\"自己编写代码向某个线程插入一个用户apc\"><a class=\"anchor\" href=\"#自己编写代码向某个线程插入一个用户apc\">#</a> 自己编写代码向某个线程插入一个用户 APC</h2>\n<p>使用现成的 API 就可以，目的是体会什么是 APC。</p>\n<p>这里最简单的办法就是，自己给自己插入 APC，自己创建一个线程一直打印一句话，然后主线程给这个线程插入 APC，打印另一句话。</p>\n<p>代码如下：</p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">// TestQueueUserAPC.cpp : 此文件包含 \"main\" 函数。程序执行将在此处开始并结束。</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;stdio.h></span></span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;Windows.h></span></span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token comment\">// 注意是 stdcall 编译器可能会默认位 cdcall</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token keyword\">void</span> __stdcall <span class=\"token function\">TestAPC</span><span class=\"token punctuation\">(</span>ULONG_PTR Parameter<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>\t<span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"I am APC!!!\\n\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token keyword\">void</span> __stdcall <span class=\"token function\">childThread</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>\t<span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span>true<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>\t\t<span class=\"token comment\">// 后面会知道为什么用这个函数</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>\t\t<span class=\"token function\">SleepEx</span><span class=\"token punctuation\">(</span><span class=\"token number\">1000</span><span class=\"token punctuation\">,</span> TRUE<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>\t\t<span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"1\\n\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre></pre></td></tr><tr><td data-num=\"24\"></td><td><pre></pre></td></tr><tr><td data-num=\"25\"></td><td><pre></pre></td></tr><tr><td data-num=\"26\"></td><td><pre></pre></td></tr><tr><td data-num=\"27\"></td><td><pre><span class=\"token keyword\">int</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>\t<span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Hello World!\\n\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>\t<span class=\"token comment\">// 创建一个子线程，每 1 秒打印一次</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>\tHANDLE hThread <span class=\"token operator\">=</span> <span class=\"token function\">CreateThread</span><span class=\"token punctuation\">(</span><span class=\"token constant\">NULL</span><span class=\"token punctuation\">,</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span>LPTHREAD_START_ROUTINE<span class=\"token punctuation\">)</span>childThread<span class=\"token punctuation\">,</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">,</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">,</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>hThread<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>\t\t<span class=\"token keyword\">return</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>\t<span class=\"token function\">QueueUserAPC</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>PAPCFUNC<span class=\"token punctuation\">)</span>TestAPC<span class=\"token punctuation\">,</span> hThread<span class=\"token punctuation\">,</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre></pre></td></tr><tr><td data-num=\"41\"></td><td><pre></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>\t<span class=\"token function\">system</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"pause\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>结果如下：</p>\n<p><img data-src=\"image001.png\" alt=\"\" /></p>\n",
            "tags": [
                "APC的本质"
            ]
        },
        {
            "id": "https://or0kit.github.io/Bin/Core/WindowsXp/Process-Thread/%E8%BF%9B%E7%A8%8B%E4%B8%8E%E7%BA%BF%E7%A8%8B-%E5%BB%B6%E8%BF%9F%E8%BF%87%E7%A8%8B%E8%B0%83%E7%94%A8-DPC/",
            "url": "https://or0kit.github.io/Bin/Core/WindowsXp/Process-Thread/%E8%BF%9B%E7%A8%8B%E4%B8%8E%E7%BA%BF%E7%A8%8B-%E5%BB%B6%E8%BF%9F%E8%BF%87%E7%A8%8B%E8%B0%83%E7%94%A8-DPC/",
            "title": "进程与线程-延迟过程调用(DPC)",
            "date_published": "2022-02-21T07:30:24.000Z",
            "content_html": "<h1 id=\"楔子\"><a class=\"anchor\" href=\"#楔子\">#</a> 楔子</h1>\n<p>这是中断相关的知识，先了解中断请求级别（IRQL）</p>\n<div class=\"note primary\">\n<p><strong>软件 IRQL (Software IRQL)</strong></p>\n<p>PASSIVE_LEVEL 0 // Passive release level<br />\nLOW_LEVEL 0 // Lowest interrupt level<br />\nAPC_LEVEL 1 // APC interrupt level<br />\nDISPATCH_LEVEL 2 // Dispatch level</p>\n<p><strong>硬件 IRQL (Hardware IRQL)</strong></p>\n<p>DIRQL: from 3 to 26 for device ISR<br />\nPROFILE_LEVEL 27, 0x1B // Timer used for profiling.<br />\nCLOCK1_LEVEL 28, 0x1C // Interval clock 1 level - not used on x86<br />\nCLOCK2_LEVEL 28, 0x1C // Interval clock 2 level<br />\nSYNCH_LEVEL 28, 0x1C // Synchronization level<br />\nIPI_LEVEL 29, 0x1D // Interprocessor interrupt level<br />\nPOWER_LEVEL 30, 0x1E // Power failure level<br />\nHIGH_LEVEL 31, 0x1F // Highest interrupt level</p>\n</div>\n<p>数值越大代表其 IRQL 的优先级越高。</p>\n<h1 id=\"延迟过程调用dpc\"><a class=\"anchor\" href=\"#延迟过程调用dpc\">#</a> 延迟过程调用（DPC）</h1>\n<p>DPC 是 &quot;Deferred Procedure Call&quot; 的缩写。<br />\n简单介绍一下 DPC：DPC 是为了减少处于高  <code>IRQL</code>  的硬件中断处理的时间。<br />\n由于低  <code>IRQL</code>  的硬件中断不能中断高  <code>IRQL</code>  的硬件中断处理。而可能<strong>有些硬件的中断处理代码量比较大，花的时间比较多，会造成其他硬件中断的响应会等的时间比较长</strong>。</p>\n<div class=\"note primary\">\n<p>DPC 运行在  <code>DISPATCH_LEVEL</code>  上，低于任何一个硬件中断的  <code>IRQL</code>  ，所以 DPC 在执行的时候不会屏蔽任何硬件中断，但由于它高于或等于任何软件中断的  <code>IRQL</code>  ，所以它有优于任何线程的执行，也屏蔽了线程调度。可以说，DPC 是介于硬件中断和线程调度之间的一个 <code>IRQL</code> ，他可以打断当前线程的执行，凌驾于线程调度器纸上，但又不屏蔽任何硬件中断。</p>\n</div>\n<h2 id=\"dpc-队列\"><a class=\"anchor\" href=\"#dpc-队列\">#</a> DPC 队列</h2>\n<p>对单 cpu 的系统，整个系统只有一个 DPC 队列，对于多 cpu 系统有可能是一个 cpu 一个，这里我把 xp 虚拟机设置为了多核，查看了其每个核的  <code>KPRCB</code>  中  <code>+0x860 DpcListHead      : _LIST_ENTRY</code>  处的值，都不一样。</p>\n<p>所有的 DPC 都链在这个链上，这个队列是个  <code>LIST_ENTRY</code>  链表。</p>\n<p>链上的每项都是个  <code>KDPC</code>  结构。</p>\n<figure class=\"highlight raw\"><figcaption data-lang=\"\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>kd&gt; dt _KDPC</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>nt!_KDPC</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>   +0x000 Type             : Int2B</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>   +0x002 Number           : UChar  &#x2F;&#x2F; 优先级也可以称为紧迫程度分别为 0 1 2</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>   +0x003 Importance       : UChar  &#x2F;&#x2F; 指明目标处理器</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>   +0x004 DpcListEntry     : _LIST_ENTRY  &#x2F;&#x2F; 当前结构体在 DPC 请求队列中的链表节点</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>   +0x00c DeferredRoutine  : Ptr32 void   &#x2F;&#x2F; 指向具体的 DPC 函数</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>   +0x010 DeferredContext  : Ptr32 Void   &#x2F;&#x2F; 执行 DPC 函数时的上下文</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>   +0x014 SystemArgument1  : Ptr32 Void   &#x2F;&#x2F; 执行 DPC 函数时的参数</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>   +0x018 SystemArgument2  : Ptr32 Void</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>   +0x01c Lock             : Ptr32 Uint4B &#x2F;&#x2F;DPC 的锁</pre></td></tr></table></figure><p>在  <code>KPRCB</code>  中挂着，等待触发时机。其中的  <code>DeferredRoutine</code>  是必须的，有没有上下文和参数都可以。具体的应该逆向函数。</p>\n<h2 id=\"dpc-的初始化\"><a class=\"anchor\" href=\"#dpc-的初始化\">#</a> DPC 的初始化</h2>\n<p>在 IDA 中查看  <code>KeInitializeDpc</code>  函数:</p>\n<figure class=\"highlight raw\"><figcaption data-lang=\"\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>; void __stdcall KeInitializeDpc(PRKDPC Dpc, PKDEFERRED_ROUTINE DeferredRoutine, PVOID DeferredContext)</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>.text:00422EEE                 public _KeInitializeDpc@12</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>.text:00422EEE _KeInitializeDpc@12 proc near           ; CODE XREF: IopInitializeIrpStackProfiler()+29↑p</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>.text:00422EEE                                         ; VdmpDelayInterrupt(x)+26B↓p ...</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>.text:00422EEE</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>.text:00422EEE Dpc             &#x3D; dword ptr  8</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>.text:00422EEE DeferredRoutine &#x3D; dword ptr  0Ch</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>.text:00422EEE DeferredContext &#x3D; dword ptr  10h</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>.text:00422EEE</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>.text:00422EEE                 mov     edi, edi</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>.text:00422EF0                 push    ebp</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>.text:00422EF1                 mov     ebp, esp</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>.text:00422EF3                 mov     eax, [ebp+Dpc]</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>.text:00422EF6                 mov     ecx, [ebp+DeferredRoutine]</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>.text:00422EF9                 and     [eax+_KDPC.Lock], 0</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>.text:00422EFD                 mov     [eax+_KDPC.DeferredRoutine], ecx</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>.text:00422F00                 mov     ecx, [ebp+DeferredContext]</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>.text:00422F03                 mov     [eax+_KDPC.Type], 13h</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>.text:00422F08                 mov     [eax+_KDPC.Number], 0</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>.text:00422F0C                 mov     [eax+_KDPC.Importance], 1</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>.text:00422F10                 mov     [eax+_KDPC.DeferredContext], ecx</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>.text:00422F13                 pop     ebp</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>.text:00422F14                 retn    0Ch</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>.text:00422F14 _KeInitializeDpc@12 endp</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>.text:00422F14</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>.text:00422F14 ; ---------------------------------------------------------------------------</pre></td></tr></table></figure><p>就是填充结构体。</p>\n<p>参考以下代码：</p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>VOID</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token function\">KeInitializeDpc</span> <span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    IN PRKDPC Dpc<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    IN PKDEFERRED_ROUTINE DeferredRoutine<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    IN PVOID DeferredContext</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token comment\">/*++</pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>Routine Description:</pre></td></tr><tr><td data-num=\"11\"></td><td><pre></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    This function initializes a kernel DPC object. The deferred routine</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    and context parameter are stored in the DPC object.</pre></td></tr><tr><td data-num=\"14\"></td><td><pre></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>Arguments:</pre></td></tr><tr><td data-num=\"16\"></td><td><pre></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    Dpc - Supplies a pointer to a control object of type DPC.</pre></td></tr><tr><td data-num=\"18\"></td><td><pre></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    DeferredRoutine - Supplies a pointer to a function that is called when</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>        the DPC object is removed from the current processor's DPC queue.</pre></td></tr><tr><td data-num=\"21\"></td><td><pre></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>    DeferredContext - Supplies a pointer to an arbitrary data structure which is</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>        to be passed to the function specified by the DeferredRoutine parameter.</pre></td></tr><tr><td data-num=\"24\"></td><td><pre></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>Return Value:</pre></td></tr><tr><td data-num=\"26\"></td><td><pre></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>    None.</pre></td></tr><tr><td data-num=\"28\"></td><td><pre></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>--*/</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre></pre></td></tr><tr><td data-num=\"31\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>    <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>    <span class=\"token comment\">// Initialize standard control object header.</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>    <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>    Dpc<span class=\"token operator\">-></span>Type <span class=\"token operator\">=</span> DpcObject<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>    Dpc<span class=\"token operator\">-></span>Number <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>    Dpc<span class=\"token operator\">-></span>Importance <span class=\"token operator\">=</span> MediumImportance<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>    <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>    <span class=\"token comment\">// Initialize deferred routine address and deferred context parameter.</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>    <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>    Dpc<span class=\"token operator\">-></span>DeferredRoutine <span class=\"token operator\">=</span> DeferredRoutine<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>    Dpc<span class=\"token operator\">-></span>DeferredContext <span class=\"token operator\">=</span> DeferredContext<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>    Dpc<span class=\"token operator\">-></span>Lock <span class=\"token operator\">=</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>    <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h2 id=\"dpc-队列的插入\"><a class=\"anchor\" href=\"#dpc-队列的插入\">#</a> DPC 队列的插入</h2>\n<p>逆向分析  <code>KeInsertQueueDpc</code>  函数</p>\n<figure class=\"highlight raw\"><figcaption data-lang=\"\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>.text:00422F5A ; BOOLEAN __stdcall KeInsertQueueDpc (PRKDPC Dpc, PVOID SystemArgument1, PVOID SystemArgument2)</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>.text:00422F5A                 public _KeInsertQueueDpc@12</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>.text:00422F5A _KeInsertQueueDpc@12 proc near          ; CODE XREF: KeSetTimerEx (x,x,x,x,x)+7F↑p</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>.text:00422F5A                                         ; KiCalibrateTimeAdjustment (x)+52↓p ...</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>.text:00422F5A</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>.text:00422F5A var_8           &#x3D; dword ptr -8</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>.text:00422F5A NewIrql         &#x3D; byte ptr -1</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>.text:00422F5A Dpc             &#x3D; dword ptr  8</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>.text:00422F5A SystemArgument1 &#x3D; dword ptr  0Ch</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>.text:00422F5A SystemArgument2 &#x3D; dword ptr  10h</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>.text:00422F5A</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>.text:00422F5A                 mov     edi, edi</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>.text:00422F5C                 push    ebp</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>.text:00422F5D                 mov     ebp, esp</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>.text:00422F5F                 push    ecx</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>.text:00422F60                 push    ecx</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>.text:00422F61                 push    esi</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>.text:00422F62                 push    edi             ; 保存寄存器环境</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>.text:00422F63                 mov     cl, 1Fh         ; 提升 IRQL 等级。提升到了 31 了，谁也不能打断了</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>.text:00422F65                 call    ds:__imp_@KfRaiseIrql@4 ; KfRaiseIrql (x)</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>.text:00422F6B                 mov     [ebp+NewIrql], al</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>.text:00422F6E                 db      3Eh             ; eax 存储这 KPRCB 的地址</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>.text:00422F6E                 mov     eax, ds:0FFDFF020h</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>.text:00422F74                 mov     edi, [ebp+Dpc]  ; edi 指向 KDPC 结构</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>.text:00422F77                 mov     esi, eax</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>.text:00422F79                 lea     eax, [esi+_KPRCB.DpcLock]</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>.text:00422F7F                 mov     [ebp-8], eax    ; ebp-8 的位置存储着 _KPRCB.DpcLock</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>.text:00422F82                 lea     eax, [edi+_KDPC.Lock]</pre></td></tr><tr><td data-num=\"29\"></td><td><pre>.text:00422F85                 mov     [ebp+8], eax    ; ebp + 8 存储着 _KDPC.Lock</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>.text:00422F88                 mov     eax, 0</pre></td></tr><tr><td data-num=\"31\"></td><td><pre>.text:00422F8D                 mov     ecx, [ebp+8]    ; ecx 存储着 _KDPC.Lock</pre></td></tr><tr><td data-num=\"32\"></td><td><pre>.text:00422F90                 mov     edx, [ebp-8]    ; edx 存储着 _KPRCB.DpcLock</pre></td></tr><tr><td data-num=\"33\"></td><td><pre>.text:00422F93                 cmpxchg [ecx], edx      ; cmpxchg 指令介绍：</pre></td></tr><tr><td data-num=\"34\"></td><td><pre>.text:00422F93                                         ; 将 AL、AX、EAX 或 RAX 寄存器中的值与第一个操作数（目标操作数）进行比较。</pre></td></tr><tr><td data-num=\"35\"></td><td><pre>.text:00422F93                                         ; 如果这两个值相等，则将第二个操作数（源操作数）加载到目标操作数中。</pre></td></tr><tr><td data-num=\"36\"></td><td><pre>.text:00422F93                                         ; 否则，目标操作数将被加载到 AL、AX、EAX 或 RAX 寄存器中。</pre></td></tr><tr><td data-num=\"37\"></td><td><pre>.text:00422F93                                         ;</pre></td></tr><tr><td data-num=\"38\"></td><td><pre>.text:00422F93                                         ; 如果 ecx &#x3D; 0 则 ecx &#x3D; edx</pre></td></tr><tr><td data-num=\"39\"></td><td><pre>.text:00422F93                                         ; 如果 ecx !&#x3D; 0 则 eax &#x3D; edx</pre></td></tr><tr><td data-num=\"40\"></td><td><pre>.text:00422F93                                         ; ----------</pre></td></tr><tr><td data-num=\"41\"></td><td><pre>.text:00422F96                 test    eax, eax        ; 判断 eax 是否为 0</pre></td></tr><tr><td data-num=\"42\"></td><td><pre>.text:00422F98                 mov     [ebp+8], eax</pre></td></tr><tr><td data-num=\"43\"></td><td><pre>.text:00422F9B                 jnz     loc_42302A      ; 如果不等于 0 程序结束。</pre></td></tr><tr><td data-num=\"44\"></td><td><pre>.text:00422F9B                                         ; 所以上面 cmpxchg 指令的目的就是使_KDPC.Lock &#x3D; _KPRCB.DpcLock</pre></td></tr><tr><td data-num=\"45\"></td><td><pre>.text:00422FA1                 inc     [esi+_KPRCB.DpcCount]</pre></td></tr><tr><td data-num=\"46\"></td><td><pre>.text:00422FA7                 add     [esi+_KPRCB.DpcQueueDepth], 1</pre></td></tr><tr><td data-num=\"47\"></td><td><pre>.text:00422FAE                 cmp     [edi+_KDPC.Importance], 2 ; 查看优先级是否是最高级</pre></td></tr><tr><td data-num=\"48\"></td><td><pre>.text:00422FB2                 mov     eax, [ebp+SystemArgument1]</pre></td></tr><tr><td data-num=\"49\"></td><td><pre>.text:00422FB5                 mov     [edi+_KDPC.SystemArgument1], eax ; 填充 KDPC 结构体的参数成员</pre></td></tr><tr><td data-num=\"50\"></td><td><pre>.text:00422FB8                 mov     eax, [ebp+SystemArgument2]</pre></td></tr><tr><td data-num=\"51\"></td><td><pre>.text:00422FBB                 mov     [edi+_KDPC.SystemArgument2], eax</pre></td></tr><tr><td data-num=\"52\"></td><td><pre>.text:00422FBE                 lea     ecx, [esi+_KPRCB.DpcListHead] ; ecx &#x3D; DpcListHead</pre></td></tr><tr><td data-num=\"53\"></td><td><pre>.text:00422FC4                 lea     eax, [edi+_KDPC.DpcListEntry] ; eax &#x3D; 当前结构体在 DPC 请求队列中的链表节点</pre></td></tr><tr><td data-num=\"54\"></td><td><pre>.text:00422FC7                 jnz     short loc_422FD7 ; 如果优先级不是最高则跳转</pre></td></tr><tr><td data-num=\"55\"></td><td><pre>.text:00422FC7                                         ;</pre></td></tr><tr><td data-num=\"56\"></td><td><pre>.text:00422FC7                                         ; 以下是链表操作，加到队头</pre></td></tr><tr><td data-num=\"57\"></td><td><pre>.text:00422FC9                 mov     edx, [ecx+_LIST_ENTRY.Flink] ; edx &#x3D; DpcListHead</pre></td></tr><tr><td data-num=\"58\"></td><td><pre>.text:00422FCB                 mov     [eax+_LIST_ENTRY.Flink], edx ; 把当前节点的前面指向链表的首部</pre></td></tr><tr><td data-num=\"59\"></td><td><pre>.text:00422FCD                 mov     [eax+_LIST_ENTRY.Blink], ecx ; 把当前节点的后一个指向链表首部的前一个</pre></td></tr><tr><td data-num=\"60\"></td><td><pre>.text:00422FD0                 mov     [edx+_LIST_ENTRY.Blink], eax ; edx &#x3D; 当前节点的 后一个_LIST_ENTRY.Blink</pre></td></tr><tr><td data-num=\"61\"></td><td><pre>.text:00422FD3                 mov     [ecx+_LIST_ENTRY.Flink], eax ; 更新_KPRCB.DpcListHead 的值</pre></td></tr><tr><td data-num=\"62\"></td><td><pre>.text:00422FD5                 jmp     short loc_422FE4 ; 判断当前有没有要执行的 DPC</pre></td></tr><tr><td data-num=\"63\"></td><td><pre>.text:00422FD7 ; ---------------------------------------------------------------------------</pre></td></tr><tr><td data-num=\"64\"></td><td><pre>.text:00422FD7</pre></td></tr><tr><td data-num=\"65\"></td><td><pre>.text:00422FD7 loc_422FD7:                             ; CODE XREF: KeInsertQueueDpc (x,x,x)+6D↑j</pre></td></tr><tr><td data-num=\"66\"></td><td><pre>.text:00422FD7                 mov     edx, [ecx+4]    ; 以下是链表操作，加到队尾</pre></td></tr><tr><td data-num=\"67\"></td><td><pre>.text:00422FDA                 mov     [eax], ecx</pre></td></tr><tr><td data-num=\"68\"></td><td><pre>.text:00422FDC                 mov     [eax+4], edx</pre></td></tr><tr><td data-num=\"69\"></td><td><pre>.text:00422FDF                 mov     [edx], eax</pre></td></tr><tr><td data-num=\"70\"></td><td><pre>.text:00422FE1                 mov     [ecx+4], eax</pre></td></tr><tr><td data-num=\"71\"></td><td><pre>.text:00422FE4</pre></td></tr><tr><td data-num=\"72\"></td><td><pre>.text:00422FE4 loc_422FE4:                             ; CODE XREF: KeInsertQueueDpc (x,x,x)+7B↑j</pre></td></tr><tr><td data-num=\"73\"></td><td><pre>.text:00422FE4                 cmp     [esi+_KPRCB.DpcRoutineActive], 0 ; 判断当前有没有要执行的 DPC</pre></td></tr><tr><td data-num=\"74\"></td><td><pre>.text:00422FEB                 jnz     short loc_42302A ; 有的话就退出了，不插入队列</pre></td></tr><tr><td data-num=\"75\"></td><td><pre>.text:00422FED                 cmp     [esi+_KPRCB.DpcInterruptRequested], 0 ; 判断有没有中断的 DPC</pre></td></tr><tr><td data-num=\"76\"></td><td><pre>.text:00422FF4                 jnz     short loc_42302A</pre></td></tr><tr><td data-num=\"77\"></td><td><pre>.text:00422FF6                 cmp     [edi+_KDPC.Importance], 0 ; 查看优先级是否为 0</pre></td></tr><tr><td data-num=\"78\"></td><td><pre>.text:00422FFA                 jnz     short loc_423018 ; 优先级不为 0 则跳转开始触发 DPC</pre></td></tr><tr><td data-num=\"79\"></td><td><pre>.text:00422FFC                 mov     eax, [esi+_KPRCB.DpcQueueDepth]</pre></td></tr><tr><td data-num=\"80\"></td><td><pre>.text:00423002                 cmp     eax, [esi+_KPRCB.MaximumDpcQueueDepth] ; 比较 DPC 队列深度是否小于最大队列深度</pre></td></tr><tr><td data-num=\"81\"></td><td><pre>.text:00423008                 jnb     short loc_423018 ; 如果不小于则跳转</pre></td></tr><tr><td data-num=\"82\"></td><td><pre>.text:0042300A                 mov     eax, [esi+_KPRCB.DpcRequestRate]</pre></td></tr><tr><td data-num=\"83\"></td><td><pre>.text:00423010                 cmp     eax, [esi+_KPRCB.MinimumDpcRate]</pre></td></tr><tr><td data-num=\"84\"></td><td><pre>.text:00423016                 jnb     short loc_42302A ; 如果不小于则直接返回。</pre></td></tr><tr><td data-num=\"85\"></td><td><pre>.text:00423018</pre></td></tr><tr><td data-num=\"86\"></td><td><pre>.text:00423018 loc_423018:                             ; CODE XREF: KeInsertQueueDpc (x,x,x)+A0↑j</pre></td></tr><tr><td data-num=\"87\"></td><td><pre>.text:00423018                                         ; KeInsertQueueDpc (x,x,x)+AE↑j</pre></td></tr><tr><td data-num=\"88\"></td><td><pre>.text:00423018                 mov     cl, 2           ; 设置中断等级为 2</pre></td></tr><tr><td data-num=\"89\"></td><td><pre>.text:0042301A                 mov     [esi+_KPRCB.DpcInterruptRequested], 1</pre></td></tr><tr><td data-num=\"90\"></td><td><pre>.text:00423024                 call    ds:__imp_@HalRequestSoftwareInterrupt@4 ; 请求软件中断</pre></td></tr><tr><td data-num=\"91\"></td><td><pre>.text:0042302A</pre></td></tr><tr><td data-num=\"92\"></td><td><pre>.text:0042302A loc_42302A:                             ; CODE XREF: KeInsertQueueDpc (x,x,x)+41↑j</pre></td></tr><tr><td data-num=\"93\"></td><td><pre>.text:0042302A                                         ; KeInsertQueueDpc (x,x,x)+91↑j ...</pre></td></tr><tr><td data-num=\"94\"></td><td><pre>.text:0042302A                 mov     cl, [ebp+NewIrql] ; 把原来的 IRQL 还原</pre></td></tr><tr><td data-num=\"95\"></td><td><pre>.text:0042302D                 call    ds:__imp_@KfLowerIrql@4 ; KfLowerIrql (x)</pre></td></tr><tr><td data-num=\"96\"></td><td><pre>.text:00423033                 xor     eax, eax</pre></td></tr><tr><td data-num=\"97\"></td><td><pre>.text:00423035                 cmp     [ebp+8], eax</pre></td></tr><tr><td data-num=\"98\"></td><td><pre>.text:00423038                 pop     edi</pre></td></tr><tr><td data-num=\"99\"></td><td><pre>.text:00423039                 setz    al              ; 汇编指令 SETZ (SETE) SETNZ (SETNE)</pre></td></tr><tr><td data-num=\"100\"></td><td><pre>.text:00423039                                         ; 取标志寄存器中 ZF 的值，放到 AL 中。</pre></td></tr><tr><td data-num=\"101\"></td><td><pre>.text:00423039                                         ; SETNE 取得 ZF 值后，取反，再放到 AL 中。</pre></td></tr><tr><td data-num=\"102\"></td><td><pre>.text:0042303C                 pop     esi</pre></td></tr><tr><td data-num=\"103\"></td><td><pre>.text:0042303D                 leave</pre></td></tr><tr><td data-num=\"104\"></td><td><pre>.text:0042303E                 retn    0Ch</pre></td></tr><tr><td data-num=\"105\"></td><td><pre>.text:0042303E _KeInsertQueueDpc@12 endp</pre></td></tr><tr><td data-num=\"106\"></td><td><pre>.text:0042303E</pre></td></tr><tr><td data-num=\"107\"></td><td><pre>.text:0042303E ; ---------------------------------------------------------------------------</pre></td></tr></table></figure><p>参考以下代码：</p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name function\">ASSERT_DPC</span><span class=\"token expression\"><span class=\"token punctuation\">(</span>E<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>             </span><span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token expression\"><span class=\"token function\">ASSERT</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>E<span class=\"token punctuation\">)</span><span class=\"token operator\">-></span>Type <span class=\"token operator\">==</span> DpcObject<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> </span><span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token expression\"><span class=\"token punctuation\">&#125;</span></span></span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>BOOLEAN</pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token function\">KeInsertQueueDpc</span> <span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    IN PRKDPC Dpc<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    IN PVOID SystemArgument1<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    IN PVOID SystemArgument2</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token comment\">/*++</pre></td></tr><tr><td data-num=\"13\"></td><td><pre></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>Routine Description:</pre></td></tr><tr><td data-num=\"15\"></td><td><pre></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    This function inserts a DPC object into the DPC queue. If the DPC object</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    is already in the DPC queue, then no operation is performed. Otherwise,</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>    the DPC object is inserted in the DPC queue and a dispatch interrupt is</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    requested.</pre></td></tr><tr><td data-num=\"20\"></td><td><pre></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>Arguments:</pre></td></tr><tr><td data-num=\"22\"></td><td><pre></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>    Dpc - Supplies a pointer to a control object of type DPC.</pre></td></tr><tr><td data-num=\"24\"></td><td><pre></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>    SystemArgument1, SystemArgument2  - Supply a set of two arguments that</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>        contain untyped data provided by the executive.</pre></td></tr><tr><td data-num=\"27\"></td><td><pre></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>Return Value:</pre></td></tr><tr><td data-num=\"29\"></td><td><pre></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>    If the DPC object is already in a DPC queue, then a value of FALSE is</pre></td></tr><tr><td data-num=\"31\"></td><td><pre>    returned. Otherwise a value of TRUE is returned.</pre></td></tr><tr><td data-num=\"32\"></td><td><pre></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>--*/</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre></pre></td></tr><tr><td data-num=\"35\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>    ULONG Index<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>    PKSPIN_LOCK Lock<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>    KIRQL OldIrql<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>    PKPRCB Prcb<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>    ULONG Processor<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>    <span class=\"token function\">ASSERT_DPC</span><span class=\"token punctuation\">(</span>Dpc<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>    <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>    <span class=\"token comment\">// Disable interrupts.</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>    <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>    <span class=\"token function\">KeRaiseIrql</span><span class=\"token punctuation\">(</span>HIGH_LEVEL<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>OldIrql<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>    <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre>    <span class=\"token comment\">// Acquire the DPC queue lock for the specified target processor.</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>    <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre></pre></td></tr><tr><td data-num=\"55\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">if</span> <span class=\"token expression\"><span class=\"token operator\">!</span><span class=\"token function\">defined</span><span class=\"token punctuation\">(</span>NT_UP<span class=\"token punctuation\">)</span></span></span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre></pre></td></tr><tr><td data-num=\"57\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>Dpc<span class=\"token operator\">-></span>Number <span class=\"token operator\">>=</span> MAXIMUM_PROCESSORS<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre>        Processor <span class=\"token operator\">=</span> Dpc<span class=\"token operator\">-></span>Number <span class=\"token operator\">-</span> MAXIMUM_PROCESSORS<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"59\"></td><td><pre>        Prcb <span class=\"token operator\">=</span> KiProcessorBlock<span class=\"token punctuation\">[</span>Processor<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre></pre></td></tr><tr><td data-num=\"61\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"62\"></td><td><pre>        Prcb <span class=\"token operator\">=</span> <span class=\"token function\">KeGetCurrentPrcb</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"63\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"64\"></td><td><pre></pre></td></tr><tr><td data-num=\"65\"></td><td><pre>    <span class=\"token function\">KiAcquireSpinLock</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>Prcb<span class=\"token operator\">-></span>DpcLock<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"66\"></td><td><pre></pre></td></tr><tr><td data-num=\"67\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">else</span></span></pre></td></tr><tr><td data-num=\"68\"></td><td><pre></pre></td></tr><tr><td data-num=\"69\"></td><td><pre>    Prcb <span class=\"token operator\">=</span> <span class=\"token function\">KeGetCurrentPrcb</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"70\"></td><td><pre></pre></td></tr><tr><td data-num=\"71\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">endif</span></span></pre></td></tr><tr><td data-num=\"72\"></td><td><pre></pre></td></tr><tr><td data-num=\"73\"></td><td><pre>    <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"74\"></td><td><pre>    <span class=\"token comment\">// If the DPC object is not in a DPC queue, then store the system</span></pre></td></tr><tr><td data-num=\"75\"></td><td><pre>    <span class=\"token comment\">// arguments, insert the DPC object in the DPC queue, increment the</span></pre></td></tr><tr><td data-num=\"76\"></td><td><pre>    <span class=\"token comment\">// number of DPCs queued to the target processor, increment the DPC</span></pre></td></tr><tr><td data-num=\"77\"></td><td><pre>    <span class=\"token comment\">// queue depth, set the address of the DPC target DPC spinlock, and</span></pre></td></tr><tr><td data-num=\"78\"></td><td><pre>    <span class=\"token comment\">// request a dispatch interrupt if appropriate.</span></pre></td></tr><tr><td data-num=\"79\"></td><td><pre>    <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"80\"></td><td><pre></pre></td></tr><tr><td data-num=\"81\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>Lock <span class=\"token operator\">=</span> <span class=\"token function\">InterlockedCompareExchangePointer</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>Dpc<span class=\"token operator\">-></span>Lock<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>Prcb<span class=\"token operator\">-></span>DpcLock<span class=\"token punctuation\">,</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"82\"></td><td><pre>        Prcb<span class=\"token operator\">-></span>DpcCount <span class=\"token operator\">+=</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"83\"></td><td><pre>        Prcb<span class=\"token operator\">-></span>DpcQueueDepth <span class=\"token operator\">+=</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"84\"></td><td><pre>        Dpc<span class=\"token operator\">-></span>SystemArgument1 <span class=\"token operator\">=</span> SystemArgument1<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"85\"></td><td><pre>        Dpc<span class=\"token operator\">-></span>SystemArgument2 <span class=\"token operator\">=</span> SystemArgument2<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"86\"></td><td><pre></pre></td></tr><tr><td data-num=\"87\"></td><td><pre>        <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"88\"></td><td><pre>        <span class=\"token comment\">// If the DPC is of high importance, then insert the DPC at the</span></pre></td></tr><tr><td data-num=\"89\"></td><td><pre>        <span class=\"token comment\">// head of the DPC queue. Otherwise, insert the DPC at the end</span></pre></td></tr><tr><td data-num=\"90\"></td><td><pre>        <span class=\"token comment\">// of the DPC queue.</span></pre></td></tr><tr><td data-num=\"91\"></td><td><pre>        <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"92\"></td><td><pre></pre></td></tr><tr><td data-num=\"93\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>Dpc<span class=\"token operator\">-></span>Importance <span class=\"token operator\">==</span> HighImportance<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"94\"></td><td><pre>            <span class=\"token function\">InsertHeadList</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>Prcb<span class=\"token operator\">-></span>DpcListHead<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>Dpc<span class=\"token operator\">-></span>DpcListEntry<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"95\"></td><td><pre></pre></td></tr><tr><td data-num=\"96\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"97\"></td><td><pre>            <span class=\"token function\">InsertTailList</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>Prcb<span class=\"token operator\">-></span>DpcListHead<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>Dpc<span class=\"token operator\">-></span>DpcListEntry<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"98\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"99\"></td><td><pre>        <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"100\"></td><td><pre>        <span class=\"token comment\">// A memory barrier is required here to synchronize with retire DPC</span></pre></td></tr><tr><td data-num=\"101\"></td><td><pre>        <span class=\"token comment\">// list, which clears DpcRoutineActive and DpcInterruptRequested</span></pre></td></tr><tr><td data-num=\"102\"></td><td><pre>        <span class=\"token comment\">// without owning the dispatcher lock.</span></pre></td></tr><tr><td data-num=\"103\"></td><td><pre>        <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"104\"></td><td><pre></pre></td></tr><tr><td data-num=\"105\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">if</span> <span class=\"token expression\"><span class=\"token function\">defined</span><span class=\"token punctuation\">(</span>_ALPHA_<span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token operator\">!</span><span class=\"token function\">defined</span><span class=\"token punctuation\">(</span>NT_UP<span class=\"token punctuation\">)</span></span></span></pre></td></tr><tr><td data-num=\"106\"></td><td><pre></pre></td></tr><tr><td data-num=\"107\"></td><td><pre>        <span class=\"token function\">__MB</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"108\"></td><td><pre></pre></td></tr><tr><td data-num=\"109\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">endif</span></span></pre></td></tr><tr><td data-num=\"110\"></td><td><pre></pre></td></tr><tr><td data-num=\"111\"></td><td><pre>        <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"112\"></td><td><pre>        <span class=\"token comment\">// If a DPC routine is not active on the target processor, then</span></pre></td></tr><tr><td data-num=\"113\"></td><td><pre>        <span class=\"token comment\">// request a dispatch interrupt if appropriate.</span></pre></td></tr><tr><td data-num=\"114\"></td><td><pre>        <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"115\"></td><td><pre></pre></td></tr><tr><td data-num=\"116\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>Prcb<span class=\"token operator\">-></span>DpcRoutineActive <span class=\"token operator\">==</span> FALSE<span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;&amp;</span></pre></td></tr><tr><td data-num=\"117\"></td><td><pre>            <span class=\"token punctuation\">(</span>Prcb<span class=\"token operator\">-></span>DpcInterruptRequested <span class=\"token operator\">==</span> FALSE<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"118\"></td><td><pre></pre></td></tr><tr><td data-num=\"119\"></td><td><pre>            <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"120\"></td><td><pre>            <span class=\"token comment\">// Request a dispatch interrupt on the current processor if</span></pre></td></tr><tr><td data-num=\"121\"></td><td><pre>            <span class=\"token comment\">// the DPC is not of low importance, the length of the DPC</span></pre></td></tr><tr><td data-num=\"122\"></td><td><pre>            <span class=\"token comment\">// queue has exceeded the maximum threshold, or if the DPC</span></pre></td></tr><tr><td data-num=\"123\"></td><td><pre>            <span class=\"token comment\">// request rate is below the minimum threshold.</span></pre></td></tr><tr><td data-num=\"124\"></td><td><pre>            <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"125\"></td><td><pre></pre></td></tr><tr><td data-num=\"126\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">if</span> <span class=\"token expression\"><span class=\"token function\">defined</span><span class=\"token punctuation\">(</span>NT_UP<span class=\"token punctuation\">)</span></span></span></pre></td></tr><tr><td data-num=\"127\"></td><td><pre></pre></td></tr><tr><td data-num=\"128\"></td><td><pre>            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>Dpc<span class=\"token operator\">-></span>Importance <span class=\"token operator\">!=</span> LowImportance<span class=\"token punctuation\">)</span> <span class=\"token operator\">||</span></pre></td></tr><tr><td data-num=\"129\"></td><td><pre>                <span class=\"token punctuation\">(</span>Prcb<span class=\"token operator\">-></span>DpcQueueDepth <span class=\"token operator\">>=</span> Prcb<span class=\"token operator\">-></span>MaximumDpcQueueDepth<span class=\"token punctuation\">)</span> <span class=\"token operator\">||</span></pre></td></tr><tr><td data-num=\"130\"></td><td><pre>                <span class=\"token punctuation\">(</span>Prcb<span class=\"token operator\">-></span>DpcRequestRate <span class=\"token operator\">&lt;</span> Prcb<span class=\"token operator\">-></span>MinimumDpcRate<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"131\"></td><td><pre>                Prcb<span class=\"token operator\">-></span>DpcInterruptRequested <span class=\"token operator\">=</span> TRUE<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"132\"></td><td><pre>                <span class=\"token function\">KiRequestSoftwareInterrupt</span><span class=\"token punctuation\">(</span>DISPATCH_LEVEL<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"133\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"134\"></td><td><pre></pre></td></tr><tr><td data-num=\"135\"></td><td><pre>            <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"136\"></td><td><pre>            <span class=\"token comment\">// If the DPC is being queued to another processor and the</span></pre></td></tr><tr><td data-num=\"137\"></td><td><pre>            <span class=\"token comment\">// DPC is of high importance, or the length of the other</span></pre></td></tr><tr><td data-num=\"138\"></td><td><pre>            <span class=\"token comment\">// processor's DPC queue has exceeded the maximum threshold,</span></pre></td></tr><tr><td data-num=\"139\"></td><td><pre>            <span class=\"token comment\">// then request a dispatch interrupt.</span></pre></td></tr><tr><td data-num=\"140\"></td><td><pre>            <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"141\"></td><td><pre></pre></td></tr><tr><td data-num=\"142\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">else</span></span></pre></td></tr><tr><td data-num=\"143\"></td><td><pre></pre></td></tr><tr><td data-num=\"144\"></td><td><pre>            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>Prcb <span class=\"token operator\">!=</span> <span class=\"token function\">KeGetCurrentPrcb</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"145\"></td><td><pre>                <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>Dpc<span class=\"token operator\">-></span>Importance <span class=\"token operator\">==</span> HighImportance<span class=\"token punctuation\">)</span> <span class=\"token operator\">||</span></pre></td></tr><tr><td data-num=\"146\"></td><td><pre>                     <span class=\"token punctuation\">(</span>Prcb<span class=\"token operator\">-></span>DpcQueueDepth <span class=\"token operator\">>=</span> Prcb<span class=\"token operator\">-></span>MaximumDpcQueueDepth<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"147\"></td><td><pre>                    Prcb<span class=\"token operator\">-></span>DpcInterruptRequested <span class=\"token operator\">=</span> TRUE<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"148\"></td><td><pre>                    <span class=\"token function\">KiIpiSend</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>KAFFINITY<span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span> <span class=\"token operator\">&lt;&lt;</span> Processor<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> IPI_DPC<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"149\"></td><td><pre>                <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"150\"></td><td><pre></pre></td></tr><tr><td data-num=\"151\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"152\"></td><td><pre></pre></td></tr><tr><td data-num=\"153\"></td><td><pre>                <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"154\"></td><td><pre>                <span class=\"token comment\">// Request a dispatch interrupt on the current processor if</span></pre></td></tr><tr><td data-num=\"155\"></td><td><pre>                <span class=\"token comment\">// the DPC is not of low importance, the length of the DPC</span></pre></td></tr><tr><td data-num=\"156\"></td><td><pre>                <span class=\"token comment\">// queue has exceeded the maximum threshold, or if the DPC</span></pre></td></tr><tr><td data-num=\"157\"></td><td><pre>                <span class=\"token comment\">// request rate is below the minimum threshold.</span></pre></td></tr><tr><td data-num=\"158\"></td><td><pre>                <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"159\"></td><td><pre></pre></td></tr><tr><td data-num=\"160\"></td><td><pre>                <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>Dpc<span class=\"token operator\">-></span>Importance <span class=\"token operator\">!=</span> LowImportance<span class=\"token punctuation\">)</span> <span class=\"token operator\">||</span></pre></td></tr><tr><td data-num=\"161\"></td><td><pre>                    <span class=\"token punctuation\">(</span>Prcb<span class=\"token operator\">-></span>DpcQueueDepth <span class=\"token operator\">>=</span> Prcb<span class=\"token operator\">-></span>MaximumDpcQueueDepth<span class=\"token punctuation\">)</span> <span class=\"token operator\">||</span></pre></td></tr><tr><td data-num=\"162\"></td><td><pre>                    <span class=\"token punctuation\">(</span>Prcb<span class=\"token operator\">-></span>DpcRequestRate <span class=\"token operator\">&lt;</span> Prcb<span class=\"token operator\">-></span>MinimumDpcRate<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"163\"></td><td><pre>                    Prcb<span class=\"token operator\">-></span>DpcInterruptRequested <span class=\"token operator\">=</span> TRUE<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"164\"></td><td><pre>                    <span class=\"token function\">KiRequestSoftwareInterrupt</span><span class=\"token punctuation\">(</span>DISPATCH_LEVEL<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"165\"></td><td><pre>                <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"166\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"167\"></td><td><pre></pre></td></tr><tr><td data-num=\"168\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">endif</span></span></pre></td></tr><tr><td data-num=\"169\"></td><td><pre></pre></td></tr><tr><td data-num=\"170\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"171\"></td><td><pre>     <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"172\"></td><td><pre></pre></td></tr><tr><td data-num=\"173\"></td><td><pre>     <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"174\"></td><td><pre>     <span class=\"token comment\">// Release the DPC lock, enable interrupts, and return whether the</span></pre></td></tr><tr><td data-num=\"175\"></td><td><pre>     <span class=\"token comment\">// DPC was queued or not.</span></pre></td></tr><tr><td data-num=\"176\"></td><td><pre>     <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"177\"></td><td><pre></pre></td></tr><tr><td data-num=\"178\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">if</span> <span class=\"token expression\"><span class=\"token operator\">!</span><span class=\"token function\">defined</span><span class=\"token punctuation\">(</span>NT_UP<span class=\"token punctuation\">)</span></span></span></pre></td></tr><tr><td data-num=\"179\"></td><td><pre></pre></td></tr><tr><td data-num=\"180\"></td><td><pre>     <span class=\"token function\">KiReleaseSpinLock</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>Prcb<span class=\"token operator\">-></span>DpcLock<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"181\"></td><td><pre></pre></td></tr><tr><td data-num=\"182\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">endif</span></span></pre></td></tr><tr><td data-num=\"183\"></td><td><pre></pre></td></tr><tr><td data-num=\"184\"></td><td><pre>     <span class=\"token function\">KeLowerIrql</span><span class=\"token punctuation\">(</span>OldIrql<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"185\"></td><td><pre>     <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span>Lock <span class=\"token operator\">==</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"186\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h2 id=\"dpc-移除队列\"><a class=\"anchor\" href=\"#dpc-移除队列\">#</a> DPC 移除队列</h2>\n<p>逆向  <code>KeRemoveQueueDpc</code></p>\n<figure class=\"highlight raw\"><figcaption data-lang=\"\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>.text:00424954 ; BOOLEAN __stdcall KeRemoveQueueDpc (PRKDPC Dpc)</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>.text:00424954                 public _KeRemoveQueueDpc@4</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>.text:00424954 _KeRemoveQueueDpc@4 proc near           ; CODE XREF: ExTimerRundown ()+90↓p</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>.text:00424954                                         ; NtCancelTimer (x,x)+AD↓p ...</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>.text:00424954</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>.text:00424954 Dpc             &#x3D; dword ptr  8</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>.text:00424954</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>.text:00424954                 mov     edi, edi</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>.text:00424956                 push    ebp</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>.text:00424957                 mov     ebp, esp</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>.text:00424959                 push    esi</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>.text:0042495A                 push    edi</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>.text:0042495B                 cli</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>.text:0042495C                 mov     esi, [ebp+Dpc]</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>.text:0042495F                 mov     edi, [esi+_KDPC.Lock]</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>.text:00424962                 test    edi, edi</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>.text:00424964                 jz      short loc_42498C</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>.text:00424966                 mov     ecx, edi</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>.text:00424968                 call    @KiAcquireSpinLock@4 ; KiAcquireSpinLock (x)</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>.text:0042496D                 cmp     edi, [esi+_KDPC.Lock]</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>.text:00424970                 jnz     short loc_424985</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>.text:00424972                 sub     dword ptr [edi-30h], 1</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>.text:00424976                 mov     eax, [esi+_KDPC.DpcListEntry.Flink] ; 链表操作，从队列中移除</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>.text:00424979                 mov     ecx, [esi+_KDPC.DpcListEntry.Blink]</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>.text:0042497C                 mov     [ecx+_LIST_ENTRY.Flink], eax</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>.text:0042497E                 mov     [eax+_LIST_ENTRY.Blink], ecx</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>.text:00424981                 and     [esi+_KDPC.Lock], 0 ; Lock &#x3D; 0</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>.text:00424985</pre></td></tr><tr><td data-num=\"29\"></td><td><pre>.text:00424985 loc_424985:                             ; CODE XREF: KeRemoveQueueDpc (x)+1C↑j</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>.text:00424985                 mov     ecx, edi</pre></td></tr><tr><td data-num=\"31\"></td><td><pre>.text:00424987                 call    @KiReleaseSpinLock@4 ; KiReleaseSpinLock (x)</pre></td></tr><tr><td data-num=\"32\"></td><td><pre>.text:0042498C</pre></td></tr><tr><td data-num=\"33\"></td><td><pre>.text:0042498C loc_42498C:                             ; CODE XREF: KeRemoveQueueDpc (x)+10↑j</pre></td></tr><tr><td data-num=\"34\"></td><td><pre>.text:0042498C                 sti</pre></td></tr><tr><td data-num=\"35\"></td><td><pre>.text:0042498D                 xor     eax, eax</pre></td></tr><tr><td data-num=\"36\"></td><td><pre>.text:0042498F                 test    edi, edi</pre></td></tr><tr><td data-num=\"37\"></td><td><pre>.text:00424991                 pop     edi</pre></td></tr><tr><td data-num=\"38\"></td><td><pre>.text:00424992                 setnz   al</pre></td></tr><tr><td data-num=\"39\"></td><td><pre>.text:00424995                 pop     esi</pre></td></tr><tr><td data-num=\"40\"></td><td><pre>.text:00424996                 pop     ebp</pre></td></tr><tr><td data-num=\"41\"></td><td><pre>.text:00424997                 retn    4</pre></td></tr><tr><td data-num=\"42\"></td><td><pre>.text:00424997 _KeRemoveQueueDpc@4 endp</pre></td></tr><tr><td data-num=\"43\"></td><td><pre>.text:00424997</pre></td></tr><tr><td data-num=\"44\"></td><td><pre>.text:00424997 ; ---------------------------------------------------------------------------</pre></td></tr></table></figure><p>参考以下代码：</p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name function\">ASSERT_DPC</span><span class=\"token expression\"><span class=\"token punctuation\">(</span>E<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>             </span><span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token expression\"><span class=\"token function\">ASSERT</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>E<span class=\"token punctuation\">)</span><span class=\"token operator\">-></span>Type <span class=\"token operator\">==</span> DpcObject<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> </span><span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token expression\"><span class=\"token punctuation\">&#125;</span></span></span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>BOOLEAN</pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token function\">KeRemoveQueueDpc</span> <span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    IN PRKDPC Dpc</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token comment\">/*++</pre></td></tr><tr><td data-num=\"11\"></td><td><pre></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>Routine Description:</pre></td></tr><tr><td data-num=\"13\"></td><td><pre></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    This function removes a DPC object from the DPC queue. If the DPC object</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    is not in the DPC queue, then no operation is performed. Otherwise, the</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    DPC object is removed from the DPC queue and its inserted state is set</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    FALSE.</pre></td></tr><tr><td data-num=\"18\"></td><td><pre></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>Arguments:</pre></td></tr><tr><td data-num=\"20\"></td><td><pre></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>    Dpc - Supplies a pointer to a control object of type DPC.</pre></td></tr><tr><td data-num=\"22\"></td><td><pre></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>Return Value:</pre></td></tr><tr><td data-num=\"24\"></td><td><pre></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>    If the DPC object is not in the DPC queue, then a value of FALSE is</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>    returned. Otherwise a value of TRUE is returned.</pre></td></tr><tr><td data-num=\"27\"></td><td><pre></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>--*/</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre></pre></td></tr><tr><td data-num=\"30\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>    PKSPIN_LOCK Lock<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>    PKPRCB Prcb<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>    <span class=\"token function\">ASSERT_DPC</span><span class=\"token punctuation\">(</span>Dpc<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>    <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>    <span class=\"token comment\">// If the DPC object is in the DPC queue, then remove it from the queue</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>    <span class=\"token comment\">// and set its inserted state to FALSE.</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>    <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>    <span class=\"token function\">_disable</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>    Lock <span class=\"token operator\">=</span> Dpc<span class=\"token operator\">-></span>Lock<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>Lock <span class=\"token operator\">!=</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>        <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>        <span class=\"token comment\">// Acquire the DPC lock of the target processor.</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>        <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre></pre></td></tr><tr><td data-num=\"50\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">if</span> <span class=\"token expression\"><span class=\"token operator\">!</span><span class=\"token function\">defined</span><span class=\"token punctuation\">(</span>NT_UP<span class=\"token punctuation\">)</span></span></span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre></pre></td></tr><tr><td data-num=\"52\"></td><td><pre>        <span class=\"token function\">KiAcquireSpinLock</span><span class=\"token punctuation\">(</span>Lock<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre></pre></td></tr><tr><td data-num=\"54\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">endif</span></span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>        <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre>        <span class=\"token comment\">// If the specified DPC is still in the DPC queue, then remove</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre>        <span class=\"token comment\">// it.</span></pre></td></tr><tr><td data-num=\"59\"></td><td><pre>        <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre>        <span class=\"token comment\">// N.B. It is possible for specified DPC to be removed from the</span></pre></td></tr><tr><td data-num=\"61\"></td><td><pre>        <span class=\"token comment\">//      specified DPC queue before the DPC lock is obtained.</span></pre></td></tr><tr><td data-num=\"62\"></td><td><pre>        <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"63\"></td><td><pre>        <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"64\"></td><td><pre></pre></td></tr><tr><td data-num=\"65\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>Lock <span class=\"token operator\">==</span> Dpc<span class=\"token operator\">-></span>Lock<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"66\"></td><td><pre>            Prcb <span class=\"token operator\">=</span> <span class=\"token function\">CONTAINING_RECORD</span><span class=\"token punctuation\">(</span>Lock<span class=\"token punctuation\">,</span> KPRCB<span class=\"token punctuation\">,</span> DpcLock<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"67\"></td><td><pre>            Prcb<span class=\"token operator\">-></span>DpcQueueDepth <span class=\"token operator\">-=</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"68\"></td><td><pre>            <span class=\"token function\">RemoveEntryList</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>Dpc<span class=\"token operator\">-></span>DpcListEntry<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"69\"></td><td><pre></pre></td></tr><tr><td data-num=\"70\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">if</span> <span class=\"token expression\"><span class=\"token function\">defined</span><span class=\"token punctuation\">(</span>_ALPHA_<span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token operator\">!</span><span class=\"token function\">defined</span><span class=\"token punctuation\">(</span>NT_UP<span class=\"token punctuation\">)</span></span></span></pre></td></tr><tr><td data-num=\"71\"></td><td><pre></pre></td></tr><tr><td data-num=\"72\"></td><td><pre>            <span class=\"token function\">__MB</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"73\"></td><td><pre></pre></td></tr><tr><td data-num=\"74\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">endif</span></span></pre></td></tr><tr><td data-num=\"75\"></td><td><pre></pre></td></tr><tr><td data-num=\"76\"></td><td><pre>            Dpc<span class=\"token operator\">-></span>Lock <span class=\"token operator\">=</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"77\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"78\"></td><td><pre></pre></td></tr><tr><td data-num=\"79\"></td><td><pre>        <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"80\"></td><td><pre>        <span class=\"token comment\">// Release the DPC lock of the target processor.</span></pre></td></tr><tr><td data-num=\"81\"></td><td><pre>        <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"82\"></td><td><pre></pre></td></tr><tr><td data-num=\"83\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">if</span> <span class=\"token expression\"><span class=\"token operator\">!</span><span class=\"token function\">defined</span><span class=\"token punctuation\">(</span>NT_UP<span class=\"token punctuation\">)</span></span></span></pre></td></tr><tr><td data-num=\"84\"></td><td><pre></pre></td></tr><tr><td data-num=\"85\"></td><td><pre>        <span class=\"token function\">KiReleaseSpinLock</span><span class=\"token punctuation\">(</span>Lock<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"86\"></td><td><pre></pre></td></tr><tr><td data-num=\"87\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">endif</span></span></pre></td></tr><tr><td data-num=\"88\"></td><td><pre></pre></td></tr><tr><td data-num=\"89\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"90\"></td><td><pre></pre></td></tr><tr><td data-num=\"91\"></td><td><pre>    <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"92\"></td><td><pre>    <span class=\"token comment\">// Enable interrupts and return whether the DPC was removed from a DPC</span></pre></td></tr><tr><td data-num=\"93\"></td><td><pre>    <span class=\"token comment\">// queue.</span></pre></td></tr><tr><td data-num=\"94\"></td><td><pre>    <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"95\"></td><td><pre></pre></td></tr><tr><td data-num=\"96\"></td><td><pre>    <span class=\"token function\">_enable</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"97\"></td><td><pre>    <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span>Lock <span class=\"token operator\">!=</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"98\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h2 id=\"dpc的执行\"><a class=\"anchor\" href=\"#dpc的执行\">#</a> DPC 的执行</h2>\n<p>之前分析的  <code>KiDispatchInterrupt</code>  函数的开头，就有处理 DPC 的片段。</p>\n<figure class=\"highlight raw\"><figcaption data-lang=\"\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>.text:0046EAE0 _KiDispatchInterrupt@0 proc near</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>.text:0046EAE0</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>.text:0046EAE0 var_C           &#x3D; dword ptr -0Ch</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>.text:0046EAE0 var_8           &#x3D; dword ptr -8</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>.text:0046EAE0 var_4           &#x3D; dword ptr -4</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>.text:0046EAE0</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>.text:0046EAE0                 mov     ebx, large fs:1Ch ; ebx: KPCR</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>.text:0046EAE7</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>.text:0046EAE7 loc_46EAE7:                             ; CODE XREF: KiDispatchInterrupt ()+B9↓j</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>.text:0046EAE7                 lea     eax, [ebx+_KPCR.PrcbData.DpcListHead]</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>.text:0046EAED                 cli                     ; 屏蔽中断</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>.text:0046EAEE                 cmp     eax, [eax]      ; check if DPC List is empty</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>.text:0046EAF0                 jz      short loc_46EB0F ;  if eq, list is empty</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>.text:0046EAF2                 push    ebp             ;  save register</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>.text:0046EAF3                 push    [ebx+_KPCR.NtTib.ExceptionList] ; DPC 中发生的异常与中断线程中的任何异常处理程序无关。</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>.text:0046EAF5                 mov     [ebx+_KPCR.NtTib.ExceptionList], 0FFFFFFFFh ; 终止异常列表。</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>.text:0046EAFB                 mov     edx, esp</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>.text:0046EAFD                 mov     esp, [ebx+_KPCR.PrcbData.DpcStack] ; 切换到此处理器的 DPC 堆栈。</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>.text:0046EB03                 push    edx</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>.text:0046EB04                 mov     ebp, eax        ; 设置 DPC Listhead 的地址</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>.text:0046EB06                 call    KiRetireDpcList ; 处理当前 DPC 列表</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>.text:0046EB0B                 pop     esp             ; 切换回当前线程堆栈，恢复异常列表和保存的 EBP。</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>.text:0046EB0C                 pop     dword ptr [ebx]</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>.text:0046EB0E                 pop     ebp</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>.text:0046EB0F</pre></td></tr></table></figure><p>可以看到  <code>KiDispatchInterrupt</code>  调用了  <code>KiRetireDpcList</code>  来处理 DPC 队列。</p>\n<figure class=\"highlight raw\"><figcaption data-lang=\"\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>.text:0046EF3E ; &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D; S U B R O U T I N E &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>.text:0046EF3E</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>.text:0046EF3E</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>.text:0046EF3E KiRetireDpcList proc near               ; CODE XREF: KiDispatchInterrupt ()+26↑p</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>.text:0046EF3E                                         ; KiIdleLoop ()+23↑p</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>.text:0046EF3E</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>.text:0046EF3E var_24          &#x3D; dword ptr -24h</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>.text:0046EF3E var_14          &#x3D; dword ptr -14h</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>.text:0046EF3E var_10          &#x3D; dword ptr -10h</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>.text:0046EF3E var_C           &#x3D; dword ptr -0Ch</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>.text:0046EF3E var_8           &#x3D; dword ptr -8</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>.text:0046EF3E</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>.text:0046EF3E                 push    esi</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>.text:0046EF3F                 lea     esi, [ebx+_KPCR.PrcbData.DpcLock] ; get DPC lock address</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>.text:0046EF45                 push    0</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>.text:0046EF47                 sub     esp, 0Ch</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>.text:0046EF4A                 cmp     ds:_PPerfGlobalGroupMask, 0</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>.text:0046EF51                 jnz     loc_46EFDC</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>.text:0046EF57</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>.text:0046EF57 loc_46EF57:                             ; CODE XREF: KiRetireDpcList+85↓j</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>.text:0046EF57                                         ; KiRetireDpcList+A6↓j ...</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>.text:0046EF57                 mov     large fs:_KPCR.PrcbData.DpcRoutineActive, esp ; 设置 DPC 例程激活</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>.text:0046EF5E</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>.text:0046EF5E loc_46EF5E:                             ; CODE XREF: KiRetireDpcList+6C↓j</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>.text:0046EF5E                 lock bts dword ptr [esi], 0 ; BTS 指令的作用：</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>.text:0046EF5E                                         ; 两件事:</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>.text:0046EF5E                                         ; 一、</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>.text:0046EF5E                                         ;  取 esi 比特位的第 0 位存在 CF 标志位中。</pre></td></tr><tr><td data-num=\"29\"></td><td><pre>.text:0046EF5E                                         ; 二、</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>.text:0046EF5E                                         ;  lock bts dword ptr [esi],0</pre></td></tr><tr><td data-num=\"31\"></td><td><pre>.text:0046EF5E                                         ;  将 dword ptr [esi] 指向的内存地址的第 0 位置 1</pre></td></tr><tr><td data-num=\"32\"></td><td><pre>.text:0046EF63                 jb      short loc_46EFCF ; CF &#x3D; 1 则跳转</pre></td></tr><tr><td data-num=\"33\"></td><td><pre>.text:0046EF65                 cmp     ebp, [ebp+_LIST_ENTRY.Flink] ; check if DPC list is empty</pre></td></tr><tr><td data-num=\"34\"></td><td><pre>.text:0046EF68                 jz      short loc_46EFCA ; DPC 的锁置为 0</pre></td></tr><tr><td data-num=\"35\"></td><td><pre>.text:0046EF6A                 mov     edx, [ebp+_LIST_ENTRY.Flink]</pre></td></tr><tr><td data-num=\"36\"></td><td><pre>.text:0046EF6D                 mov     ecx, [edx+_LIST_ENTRY.Flink]</pre></td></tr><tr><td data-num=\"37\"></td><td><pre>.text:0046EF6F                 mov     [ebp+_LIST_ENTRY.Flink], ecx</pre></td></tr><tr><td data-num=\"38\"></td><td><pre>.text:0046EF72                 mov     [ecx+_LIST_ENTRY.Blink], ebp</pre></td></tr><tr><td data-num=\"39\"></td><td><pre>.text:0046EF75                 sub     edx, 4          ; -0x4 获得 DPC 对象 KDPC 结构的首地址</pre></td></tr><tr><td data-num=\"40\"></td><td><pre>.text:0046EF78                 mov     ecx, [edx+_KDPC.DeferredRoutine]</pre></td></tr><tr><td data-num=\"41\"></td><td><pre>.text:0046EF7B                 push    [edx+_KDPC.SystemArgument2]</pre></td></tr><tr><td data-num=\"42\"></td><td><pre>.text:0046EF7E                 push    [edx+_KDPC.SystemArgument1]</pre></td></tr><tr><td data-num=\"43\"></td><td><pre>.text:0046EF81                 push    [edx+_KDPC.DeferredContext]</pre></td></tr><tr><td data-num=\"44\"></td><td><pre>.text:0046EF84                 push    edx</pre></td></tr><tr><td data-num=\"45\"></td><td><pre>.text:0046EF85                 mov     [edx+_KDPC.Lock], 0 ; 清除 DPC 插入状态</pre></td></tr><tr><td data-num=\"46\"></td><td><pre>.text:0046EF8C                 dec     [ebx+_KPCR.PrcbData.DpcQueueDepth] ; 递减深度</pre></td></tr><tr><td data-num=\"47\"></td><td><pre>.text:0046EF92                 mov     byte ptr [esi], 0 ; 释放 DPC 锁</pre></td></tr><tr><td data-num=\"48\"></td><td><pre>.text:0046EF95                 sti                     ; enable interrupts</pre></td></tr><tr><td data-num=\"49\"></td><td><pre>.text:0046EF96                 cmp     dword ptr [esp+1Ch], 0 ; 这里有待调试分析</pre></td></tr><tr><td data-num=\"50\"></td><td><pre>.text:0046EF9B                 jnz     short loc_46F004</pre></td></tr><tr><td data-num=\"51\"></td><td><pre>.text:0046EF9D</pre></td></tr><tr><td data-num=\"52\"></td><td><pre>.text:0046EF9D loc_46EF9D:                             ; CODE XREF: KiRetireDpcList+DD↓j</pre></td></tr><tr><td data-num=\"53\"></td><td><pre>.text:0046EF9D                 call    ecx</pre></td></tr><tr><td data-num=\"54\"></td><td><pre>.text:0046EF9F                 cmp     [esp+14h+var_8], 0 ; 若不为 0 会分析 log 相关的</pre></td></tr><tr><td data-num=\"55\"></td><td><pre>.text:0046EFA4                 jnz     short loc_46F01D</pre></td></tr><tr><td data-num=\"56\"></td><td><pre>.text:0046EFA6</pre></td></tr><tr><td data-num=\"57\"></td><td><pre>.text:0046EFA6 loc_46EFA6:                             ; CODE XREF: KiRetireDpcList+98↓j</pre></td></tr><tr><td data-num=\"58\"></td><td><pre>.text:0046EFA6                                         ; KiRetireDpcList+F1↓j</pre></td></tr><tr><td data-num=\"59\"></td><td><pre>.text:0046EFA6                 cli</pre></td></tr><tr><td data-num=\"60\"></td><td><pre>.text:0046EFA7                 cmp     ebp, [ebp+_LIST_ENTRY.Flink] ; check if DPC list is empty</pre></td></tr><tr><td data-num=\"61\"></td><td><pre>.text:0046EFAA                 jnz     short loc_46EF5E ; BTS 指令的作用：</pre></td></tr><tr><td data-num=\"62\"></td><td><pre>.text:0046EFAA                                         ; 两件事:</pre></td></tr><tr><td data-num=\"63\"></td><td><pre>.text:0046EFAA                                         ; 一、</pre></td></tr><tr><td data-num=\"64\"></td><td><pre>.text:0046EFAA                                         ;  取 esi 比特位的第 0 位存在 CF 标志位中。</pre></td></tr><tr><td data-num=\"65\"></td><td><pre>.text:0046EFAA                                         ; 二、</pre></td></tr><tr><td data-num=\"66\"></td><td><pre>.text:0046EFAA                                         ;  lock bts dword ptr [esi],0</pre></td></tr><tr><td data-num=\"67\"></td><td><pre>.text:0046EFAA                                         ;  将 dword ptr [esi] 指向的内存地址的第 0 位置 1</pre></td></tr><tr><td data-num=\"68\"></td><td><pre>.text:0046EFAC</pre></td></tr><tr><td data-num=\"69\"></td><td><pre>.text:0046EFAC loc_46EFAC:                             ; CODE XREF: KiRetireDpcList+8F↓j</pre></td></tr><tr><td data-num=\"70\"></td><td><pre>.text:0046EFAC                 mov     [ebx+_KPCR.PrcbData.DpcRoutineActive], 0</pre></td></tr><tr><td data-num=\"71\"></td><td><pre>.text:0046EFB6                 mov     [ebx+_KPCR.PrcbData.DpcInterruptRequested], 0</pre></td></tr><tr><td data-num=\"72\"></td><td><pre>.text:0046EFC0                 cmp     ebp, [ebp+_LIST_ENTRY.Flink] ; check if DPC list is empty</pre></td></tr><tr><td data-num=\"73\"></td><td><pre>.text:0046EFC3                 jnz     short loc_46EF57 ; DPC 列表不为空，则继续执行 DPC</pre></td></tr><tr><td data-num=\"74\"></td><td><pre>.text:0046EFC5                 add     esp, 10h</pre></td></tr><tr><td data-num=\"75\"></td><td><pre>.text:0046EFC8                 pop     esi</pre></td></tr><tr><td data-num=\"76\"></td><td><pre>.text:0046EFC9                 retn</pre></td></tr><tr><td data-num=\"77\"></td><td><pre>.text:0046EFCA ; ---------------------------------------------------------------------------</pre></td></tr><tr><td data-num=\"78\"></td><td><pre>.text:0046EFCA</pre></td></tr><tr><td data-num=\"79\"></td><td><pre>.text:0046EFCA loc_46EFCA:                             ; CODE XREF: KiRetireDpcList+2A↑j</pre></td></tr><tr><td data-num=\"80\"></td><td><pre>.text:0046EFCA                 mov     byte ptr [esi], 0 ; DPC 的锁置为 0</pre></td></tr><tr><td data-num=\"81\"></td><td><pre>.text:0046EFCD                 jmp     short loc_46EFAC ; 返回</pre></td></tr><tr><td data-num=\"82\"></td><td><pre>.text:0046EFCF ; ---------------------------------------------------------------------------</pre></td></tr><tr><td data-num=\"83\"></td><td><pre>.text:0046EFCF</pre></td></tr><tr><td data-num=\"84\"></td><td><pre>.text:0046EFCF loc_46EFCF:                             ; CODE XREF: KiRetireDpcList+25↑j</pre></td></tr><tr><td data-num=\"85\"></td><td><pre>.text:0046EFCF                 sti</pre></td></tr><tr><td data-num=\"86\"></td><td><pre>.text:0046EFD0</pre></td></tr><tr><td data-num=\"87\"></td><td><pre>.text:0046EFD0 loc_46EFD0:                             ; CODE XREF: KiRetireDpcList+9C↓j</pre></td></tr><tr><td data-num=\"88\"></td><td><pre>.text:0046EFD0                 test    dword ptr [esi], 1</pre></td></tr><tr><td data-num=\"89\"></td><td><pre>.text:0046EFD6                 jz      short loc_46EFA6</pre></td></tr><tr><td data-num=\"90\"></td><td><pre>.text:0046EFD8                 pause</pre></td></tr><tr><td data-num=\"91\"></td><td><pre>.text:0046EFDA                 jmp     short loc_46EFD0</pre></td></tr><tr><td data-num=\"92\"></td><td><pre>.text:0046EFDC ; ---------------------------------------------------------------------------</pre></td></tr><tr><td data-num=\"93\"></td><td><pre>.text:0046EFDC</pre></td></tr><tr><td data-num=\"94\"></td><td><pre>.text:0046EFDC loc_46EFDC:                             ; CODE XREF: KiRetireDpcList+13↑j</pre></td></tr><tr><td data-num=\"95\"></td><td><pre>.text:0046EFDC                 mov     eax, ds:_PPerfGlobalGroupMask</pre></td></tr><tr><td data-num=\"96\"></td><td><pre>.text:0046EFE1                 cmp     eax, 0</pre></td></tr><tr><td data-num=\"97\"></td><td><pre>.text:0046EFE4                 jz      loc_46EF57      ; 设置 DPC 例程激活</pre></td></tr><tr><td data-num=\"98\"></td><td><pre>.text:0046EFEA                 test    dword ptr [eax+4], 80h</pre></td></tr><tr><td data-num=\"99\"></td><td><pre>.text:0046EFF1                 jz      loc_46EF57      ; 设置 DPC 例程激活</pre></td></tr><tr><td data-num=\"100\"></td><td><pre>.text:0046EFF7                 mov     [esp+14h+var_8], 1</pre></td></tr><tr><td data-num=\"101\"></td><td><pre>.text:0046EFFF                 jmp     loc_46EF57      ; 设置 DPC 例程激活</pre></td></tr><tr><td data-num=\"102\"></td><td><pre>.text:0046F004 ; ---------------------------------------------------------------------------</pre></td></tr><tr><td data-num=\"103\"></td><td><pre>.text:0046F004</pre></td></tr><tr><td data-num=\"104\"></td><td><pre>.text:0046F004 loc_46F004:                             ; CODE XREF: KiRetireDpcList+5D↑j</pre></td></tr><tr><td data-num=\"105\"></td><td><pre>.text:0046F004                 push    ecx</pre></td></tr><tr><td data-num=\"106\"></td><td><pre>.text:0046F005                 call    ds:_WmiGetCpuClock ; WmipGetSystemTime ()</pre></td></tr><tr><td data-num=\"107\"></td><td><pre>.text:0046F00B                 pop     ecx</pre></td></tr><tr><td data-num=\"108\"></td><td><pre>.text:0046F00C                 mov     [esp+24h+var_14], eax</pre></td></tr><tr><td data-num=\"109\"></td><td><pre>.text:0046F010                 mov     [esp+24h+var_10], edx</pre></td></tr><tr><td data-num=\"110\"></td><td><pre>.text:0046F014                 mov     edx, [esp+24h+var_24]</pre></td></tr><tr><td data-num=\"111\"></td><td><pre>.text:0046F017                 mov     [esp+24h+var_C], ecx</pre></td></tr><tr><td data-num=\"112\"></td><td><pre>.text:0046F01B                 jmp     short loc_46EF9D</pre></td></tr><tr><td data-num=\"113\"></td><td><pre>.text:0046F01D ; ---------------------------------------------------------------------------</pre></td></tr><tr><td data-num=\"114\"></td><td><pre>.text:0046F01D</pre></td></tr><tr><td data-num=\"115\"></td><td><pre>.text:0046F01D loc_46F01D:                             ; CODE XREF: KiRetireDpcList+66↑j</pre></td></tr><tr><td data-num=\"116\"></td><td><pre>.text:0046F01D                 mov     eax, [esp+14h+var_14]</pre></td></tr><tr><td data-num=\"117\"></td><td><pre>.text:0046F020                 mov     edx, [esp+14h+var_10]</pre></td></tr><tr><td data-num=\"118\"></td><td><pre>.text:0046F024                 push    edx</pre></td></tr><tr><td data-num=\"119\"></td><td><pre>.text:0046F025                 push    eax</pre></td></tr><tr><td data-num=\"120\"></td><td><pre>.text:0046F026                 mov     ecx, [esp+1Ch+var_C]</pre></td></tr><tr><td data-num=\"121\"></td><td><pre>.text:0046F02A                 call    @PerfInfoLogDpc@12 ; PerfInfoLogDpc (x,x,x)</pre></td></tr><tr><td data-num=\"122\"></td><td><pre>.text:0046F02F                 jmp     loc_46EFA6</pre></td></tr><tr><td data-num=\"123\"></td><td><pre>.text:0046F02F KiRetireDpcList endp</pre></td></tr><tr><td data-num=\"124\"></td><td><pre>.text:0046F02F</pre></td></tr><tr><td data-num=\"125\"></td><td><pre>.text:0046F034</pre></td></tr><tr><td data-num=\"126\"></td><td><pre>.text:0046F034 ; &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D; S U B R O U T I N E &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;</pre></td></tr></table></figure><p>可以参考以下代码：</p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>VOID</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token function\">KiRetireDpcList</span> <span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    PKPRCB Prcb</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token comment\">/*++</pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>Routine Description:</pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    This function processes the DPC list for the specified processor.</pre></td></tr><tr><td data-num=\"11\"></td><td><pre></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    N.B. This function is entered with interrupts disabled and exits with</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>         interrupts disabled.</pre></td></tr><tr><td data-num=\"14\"></td><td><pre></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>Arguments:</pre></td></tr><tr><td data-num=\"16\"></td><td><pre></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    Prcb - Supplies the address of the processor block.</pre></td></tr><tr><td data-num=\"18\"></td><td><pre></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>Return Value:</pre></td></tr><tr><td data-num=\"20\"></td><td><pre></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>    None.</pre></td></tr><tr><td data-num=\"22\"></td><td><pre></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>--*/</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre></pre></td></tr><tr><td data-num=\"25\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>    PKDPC Dpc<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>    PVOID DeferredContext<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>    PKDEFERRED_ROUTINE DeferredRoutine<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>    PLIST_ENTRY Entry<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>    PLIST_ENTRY ListHead<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>    PVOID SystemArgument1<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>    PVOID SystemArgument2<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>    ULONG TimerHand<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>    <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>    <span class=\"token comment\">// Loop processing DPC list entries until the specified DPC list is empty.</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>    <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>    <span class=\"token comment\">// N.B. This following code appears to have a redundant loop, but it does</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>    <span class=\"token comment\">//      not. The point of this code is to avoid as many dispatch interrupts</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>    <span class=\"token comment\">//      as possible.</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>    <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>    ListHead <span class=\"token operator\">=</span> <span class=\"token operator\">&amp;</span>Prcb<span class=\"token operator\">-></span>DpcListHead<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>    <span class=\"token keyword\">do</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>        Prcb<span class=\"token operator\">-></span>DpcRoutineActive <span class=\"token operator\">=</span> TRUE<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>        <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>        <span class=\"token comment\">// If the timer hand value is nonzero, then process expired timers.</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>        <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre></pre></td></tr><tr><td data-num=\"52\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>TimerHand <span class=\"token operator\">=</span> Prcb<span class=\"token operator\">-></span>TimerHand<span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>            Prcb<span class=\"token operator\">-></span>TimerHand <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre>            <span class=\"token function\">_enable</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre>            <span class=\"token function\">KiTimerExpiration</span><span class=\"token punctuation\">(</span><span class=\"token constant\">NULL</span><span class=\"token punctuation\">,</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">,</span> <span class=\"token function\">UlongToHandle</span><span class=\"token punctuation\">(</span>TimerHand <span class=\"token operator\">-</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>            <span class=\"token function\">_disable</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre></pre></td></tr><tr><td data-num=\"59\"></td><td><pre>        <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre>        <span class=\"token comment\">// If the DPC list is not empty, then process the DPC list.</span></pre></td></tr><tr><td data-num=\"61\"></td><td><pre>        <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"62\"></td><td><pre></pre></td></tr><tr><td data-num=\"63\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>Prcb<span class=\"token operator\">-></span>DpcQueueDepth <span class=\"token operator\">!=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"64\"></td><td><pre></pre></td></tr><tr><td data-num=\"65\"></td><td><pre>            <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"66\"></td><td><pre>            <span class=\"token comment\">// Acquire the DPC lock for the current processor and check if</span></pre></td></tr><tr><td data-num=\"67\"></td><td><pre>            <span class=\"token comment\">// the DPC list is empty. If the DPC list is not empty, then</span></pre></td></tr><tr><td data-num=\"68\"></td><td><pre>            <span class=\"token comment\">// remove the first entry from the DPC list, capture the DPC</span></pre></td></tr><tr><td data-num=\"69\"></td><td><pre>            <span class=\"token comment\">// parameters, set the DPC inserted state false, decrement the</span></pre></td></tr><tr><td data-num=\"70\"></td><td><pre>            <span class=\"token comment\">// DPC queue depth, release the DPC lock, enable interrupts, and</span></pre></td></tr><tr><td data-num=\"71\"></td><td><pre>            <span class=\"token comment\">// call the specified DPC routine. Otherwise, release the DPC</span></pre></td></tr><tr><td data-num=\"72\"></td><td><pre>            <span class=\"token comment\">// lock and enable interrupts.</span></pre></td></tr><tr><td data-num=\"73\"></td><td><pre>            <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"74\"></td><td><pre></pre></td></tr><tr><td data-num=\"75\"></td><td><pre>            <span class=\"token keyword\">do</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"76\"></td><td><pre>                <span class=\"token function\">KeAcquireSpinLockAtDpcLevel</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>Prcb<span class=\"token operator\">-></span>DpcLock<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"77\"></td><td><pre>                Entry <span class=\"token operator\">=</span> Prcb<span class=\"token operator\">-></span>DpcListHead<span class=\"token punctuation\">.</span>Flink<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"78\"></td><td><pre>                <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>Entry <span class=\"token operator\">!=</span> ListHead<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"79\"></td><td><pre>                    <span class=\"token function\">RemoveEntryList</span><span class=\"token punctuation\">(</span>Entry<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"80\"></td><td><pre>                    Dpc <span class=\"token operator\">=</span> <span class=\"token function\">CONTAINING_RECORD</span><span class=\"token punctuation\">(</span>Entry<span class=\"token punctuation\">,</span> KDPC<span class=\"token punctuation\">,</span> DpcListEntry<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"81\"></td><td><pre>                    DeferredRoutine <span class=\"token operator\">=</span> Dpc<span class=\"token operator\">-></span>DeferredRoutine<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"82\"></td><td><pre>                    DeferredContext <span class=\"token operator\">=</span> Dpc<span class=\"token operator\">-></span>DeferredContext<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"83\"></td><td><pre>                    SystemArgument1 <span class=\"token operator\">=</span> Dpc<span class=\"token operator\">-></span>SystemArgument1<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"84\"></td><td><pre>                    SystemArgument2 <span class=\"token operator\">=</span> Dpc<span class=\"token operator\">-></span>SystemArgument2<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"85\"></td><td><pre>                    Dpc<span class=\"token operator\">-></span>Lock <span class=\"token operator\">=</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"86\"></td><td><pre>                    Prcb<span class=\"token operator\">-></span>DpcQueueDepth <span class=\"token operator\">-=</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"87\"></td><td><pre>                    <span class=\"token function\">KeReleaseSpinLockFromDpcLevel</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>Prcb<span class=\"token operator\">-></span>DpcLock<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"88\"></td><td><pre>                    <span class=\"token function\">_enable</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"89\"></td><td><pre>                    <span class=\"token punctuation\">(</span>DeferredRoutine<span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span>Dpc<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"90\"></td><td><pre>                                      DeferredContext<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"91\"></td><td><pre>                                      SystemArgument1<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"92\"></td><td><pre>                                      SystemArgument2<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"93\"></td><td><pre></pre></td></tr><tr><td data-num=\"94\"></td><td><pre>                    <span class=\"token function\">ASSERT</span><span class=\"token punctuation\">(</span><span class=\"token function\">KeGetCurrentIrql</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> DISPATCH_LEVEL<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"95\"></td><td><pre></pre></td></tr><tr><td data-num=\"96\"></td><td><pre>                    <span class=\"token function\">_disable</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"97\"></td><td><pre></pre></td></tr><tr><td data-num=\"98\"></td><td><pre>                <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"99\"></td><td><pre></pre></td></tr><tr><td data-num=\"100\"></td><td><pre>                    <span class=\"token function\">ASSERT</span><span class=\"token punctuation\">(</span>Prcb<span class=\"token operator\">-></span>DpcQueueDepth <span class=\"token operator\">==</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"101\"></td><td><pre></pre></td></tr><tr><td data-num=\"102\"></td><td><pre>                    <span class=\"token function\">KeReleaseSpinLockFromDpcLevel</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>Prcb<span class=\"token operator\">-></span>DpcLock<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"103\"></td><td><pre>                <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"104\"></td><td><pre></pre></td></tr><tr><td data-num=\"105\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span>ListHead <span class=\"token operator\">!=</span> <span class=\"token operator\">*</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>PLIST_ENTRY <span class=\"token keyword\">volatile</span> <span class=\"token operator\">*</span><span class=\"token punctuation\">)</span><span class=\"token operator\">&amp;</span>ListHead<span class=\"token operator\">-></span>Flink<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"106\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"107\"></td><td><pre></pre></td></tr><tr><td data-num=\"108\"></td><td><pre>        Prcb<span class=\"token operator\">-></span>DpcRoutineActive <span class=\"token operator\">=</span> FALSE<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"109\"></td><td><pre>        Prcb<span class=\"token operator\">-></span>DpcInterruptRequested <span class=\"token operator\">=</span> FALSE<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"110\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span>ListHead <span class=\"token operator\">!=</span> <span class=\"token operator\">*</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>PLIST_ENTRY <span class=\"token keyword\">volatile</span> <span class=\"token operator\">*</span><span class=\"token punctuation\">)</span><span class=\"token operator\">&amp;</span>ListHead<span class=\"token operator\">-></span>Flink<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"111\"></td><td><pre></pre></td></tr><tr><td data-num=\"112\"></td><td><pre>    <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"113\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h2 id=\"总结\"><a class=\"anchor\" href=\"#总结\">#</a> 总结</h2>\n<p>从上述的逆向分析可以得知，DPC 优先于线程切换，必须得先把 DPC 执行完，才能执行线程。验证了上述概念。</p>\n<h2 id=\"写代码验证dpc\"><a class=\"anchor\" href=\"#写代码验证dpc\">#</a> 写代码验证 DPC</h2>\n<p>代码很简单：</p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span><span class=\"token string\">&lt;ntddk.h></span></span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>KDPC dpc <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span> <span class=\"token number\">0</span> <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>VOID <span class=\"token function\">DriverUnload</span><span class=\"token punctuation\">(</span>PDRIVER_OBJECT pDriver<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>\t<span class=\"token function\">DbgPrint</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"我是驱动，我卸载了\\t\\n\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>VOID <span class=\"token function\">dpcCall</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>\t<span class=\"token comment\">//_In_ struct _KDPC* Dpc,</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>\t_In_opt_ PVOID DeferredContext<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>\t_In_opt_ PVOID SystemArgument1<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>\t_In_opt_ PVOID SystemArgument2</pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>\t<span class=\"token function\">DbgPrint</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Dpc执行了\\t\\n\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>NTSTATUS <span class=\"token function\">DriverEntry</span><span class=\"token punctuation\">(</span>PDRIVER_OBJECT pDriver<span class=\"token punctuation\">,</span> PUNICODE_STRING pRegPath<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>\tpDriver<span class=\"token operator\">-></span>DriverUnload <span class=\"token operator\">=</span> DriverUnload<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>\t<span class=\"token function\">DbgPrint</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"我是驱动,我运行了\\t\\n\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>\t<span class=\"token function\">KeInitializeDpc</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>dpc<span class=\"token punctuation\">,</span> dpcCall<span class=\"token punctuation\">,</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>\t<span class=\"token function\">KeInsertQueueDpc</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>dpc<span class=\"token punctuation\">,</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">,</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>\t<span class=\"token keyword\">return</span> STATUS_SUCCESS<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>截图：</p>\n<p><img data-src=\"image001.png\" alt=\"\" /></p>\n<h1 id=\"reference\"><a class=\"anchor\" href=\"#reference\">#</a> Reference</h1>\n<p>windows 泄露的源码<br />\n《Windows 内核原理与实现》<br />\n<span class=\"exturl\" data-url=\"aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2ltcXVlc3Rpb24vYXJ0aWNsZS9kZXRhaWxzLzEyODY2NDE=\">https://blog.csdn.net/imquestion/article/details/1286641</span></p>\n",
            "tags": [
                "延迟过程调用"
            ]
        },
        {
            "id": "https://or0kit.github.io/Bin/Core/WindowsXp/HadleTable/%E5%8F%A5%E6%9F%84%E8%A1%A8/",
            "url": "https://or0kit.github.io/Bin/Core/WindowsXp/HadleTable/%E5%8F%A5%E6%9F%84%E8%A1%A8/",
            "title": "句柄表",
            "date_published": "2022-01-28T13:44:50.000Z",
            "content_html": "<h1 id=\"楔子\"><a class=\"anchor\" href=\"#楔子\">#</a> 楔子</h1>\n<p>句柄表份分为进程句柄表和全局句柄表两种。</p>\n<p>当一个线程使用 OpenProcess 函数去获得另一个进程的句柄时，首先会进入 R0，根据 PID 查找全局句柄表，找到这个进程的结构体对象后，插入到自己的进程句柄表中，然后把这个对象在自己的进程句柄表中的索引作为返回值返回。</p>\n<h2 id=\"句柄的由来\"><a class=\"anchor\" href=\"#句柄的由来\">#</a> 句柄的由来</h2>\n<p>出自《Windows 内核原理与实现》129 页。</p>\n<p>Windows 执行体实现了一套对象机制来管理各种资源或实体。每种对象都有一个类型对象，类型对象定义了该类对象的一些特性和方法。对象管理器也定义了一个全局名字空间，提供了根据名称来解析对象的同一机制。类型对象通过提供自定义的 Parse 方法可以扩展此名字空间。对象管理器中的对象是执行体对象，它位于系统空间，考虑到安全性，在进程空间不能直接通过地址来引用它们。</p>\n<p>在 Windows 系统中需要使用到句柄 (handle) 来管理进程中的对象引用。当一个进程利用名称来创建或打开一个对象时，将获得一个句柄，该句柄指向所创建或打开的对象。以后，该进程无须使用名称来引用对象，使用此句柄即可访问。这样即保证了安全性，也提高了引用对象的效率。当两个应用程序以共享方式打开了同一个文件，那么，它们将分别得到各种的句柄，且都可以通过句柄操作该文件。尽管两个应用程序得到的句柄的值并不相同，但是这两个句柄所指的文件却是同一个。因此，句柄只是一个对象引用，同一个对象在不同的环境下可能有不同的引用（句柄）值。</p>\n<p>在 Windows 系统中，句柄是进程范围内的对象引用，换句话说，句柄仅在一个进程范围内才有效。一个进程的句柄传递给另一个进程后，句柄值将不再有效。</p>\n<h2 id=\"进程句柄表\"><a class=\"anchor\" href=\"#进程句柄表\">#</a> 进程句柄表</h2>\n<h3 id=\"什么是句柄内核对象\"><a class=\"anchor\" href=\"#什么是句柄内核对象\">#</a> 什么是句柄（内核对象）</h3>\n<p>当一个进程创建或打开一个内核对象时，将获得一个而句柄，通过这个句柄可以访问内核对象。</p>\n<p>如：</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>HANDLE g_hMutex <span class=\"token operator\">=</span> <span class=\"token operator\">::</span><span class=\"token function\">CreateMutex</span><span class=\"token punctuation\">(</span><span class=\"token constant\">NULL</span><span class=\"token punctuation\">,</span>FALSE<span class=\"token punctuation\">,</span> <span class=\"token string\">\"XYZ\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>HANDLE g_hMutex <span class=\"token operator\">=</span> <span class=\"token operator\">::</span><span class=\"token function\">OpenMutex</span><span class=\"token punctuation\">(</span>MUTEX_ALL_ACCESS<span class=\"token punctuation\">,</span>FALSE<span class=\"token punctuation\">,</span> <span class=\"token string\">\"XYZ\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>HANDLE g_hEvent <span class=\"token operator\">=</span> <span class=\"token operator\">::</span><span class=\"token function\">CreateEvent</span><span class=\"token punctuation\">(</span><span class=\"token constant\">NULL</span><span class=\"token punctuation\">,</span> TRUE<span class=\"token punctuation\">,</span> FALSE<span class=\"token punctuation\">,</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>HANDLE g_hThread <span class=\"token operator\">=</span> <span class=\"token operator\">::</span><span class=\"token function\">CreateThread</span><span class=\"token punctuation\">(</span><span class=\"token constant\">NULL</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> Proc<span class=\"token punctuation\">,</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>这些内核对象是指创建时需要指定  <code>LPSECURITY_ATTRIBUTES</code>  参数的对象。</p>\n<p><strong>注意：</strong></p>\n<ol>\n<li>窗口、字体、笔刷等，是用户句柄，并不是内核句柄，与本章所学句柄不一样。</li>\n<li>创建句柄不等同于打开句柄，当创建的时候，操作系统会在零环为内核对象分配一个结构体（例如 CreateEvent），如果自己或他人打开了这个内核对象（例如 OpenProcess），那么将不会再次为这个内核对象分配一个结构体，而是返回一个句柄的索引值。</li>\n<li>若同一个内核对象被引用了 100 次，那么在句柄表中就会存储 100 个内核对象的地址。</li>\n</ol>\n<h3 id=\"为什么要有句柄\"><a class=\"anchor\" href=\"#为什么要有句柄\">#</a> 为什么要有句柄</h3>\n<p>句柄存在的目的是为了避免在应用层直接修改内核对象。</p>\n<p>如果直接返回内核对象的地址，那么就意味着我们可以在应用层修改这个地址，在内核层面一旦出错就会蓝屏，很不安全，所以微软设计了句柄（HANDLE）给 3 环使用。</p>\n<p>Windows 的设计句柄表的理念：</p>\n<ol>\n<li>隐藏内核对象指针</li>\n<li>句柄就是索引</li>\n</ol>\n<h3 id=\"句柄表在哪\"><a class=\"anchor\" href=\"#句柄表在哪\">#</a> 句柄表在哪</h3>\n<p>在当前进程的 <code>EPROCESS</code>  结构体的 0xc4 的位置</p>\n<figure class=\"highlight raw\"><figcaption data-lang=\"\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>kd&gt; dt _EPROCESS\t\t\t\t\t\t</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>   +0x0c4 ObjectTable      : _HANDLE_TABLE\t\t</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>...</pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>kd&gt; dt _HANDLE_TABLE </pre></td></tr><tr><td data-num=\"6\"></td><td><pre>nt!_HANDLE_TABLE\t\t\t\t</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>   +0x000 TableCode  &#x2F;&#x2F;   句柄表</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>   +0x004 QuotaProcess</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>   +0x008 UniqueProcessId</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>   +0x00c HandleTableLock</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>   +0x01c HandleTableList\t\t</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>   ...</pre></td></tr></table></figure><p>下面详细介绍句柄表的结构。</p>\n<h3 id=\"句柄表的结构\"><a class=\"anchor\" href=\"#句柄表的结构\">#</a> 句柄表的结构</h3>\n<p>句柄表是一个多层结构。<br />\n <code>EPROCESS</code>  数据结构的  <code>ObjectTable</code>  域指向进程的句柄表。一个进程的句柄表包含了所有已被该进程打开的那些对象的指针。</p>\n<p><code>ObjectTable</code>  的类型为  <code>_HANDLE_TABLE</code> ，每个句柄项的而结构为  <code>HANDLE_TABLE_ENTRY</code> 。<br />\n <code>HANDLE_TABLE_ENTRY</code>  的大小为 8B，而 Windows 执行体在分配句柄表内存时按页面（4KB 大小）来申请内存。因此，执行体每申请一个新的页面来存放句柄项，则句柄表的容量增加 512。</p>\n<p>下面看一下  <code>_HANDLE_TABLE</code>  结构体，这是《Windows 内核原理与实现》一书中的，也可以参见 WRK 源码的英文介绍。</p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">typedef</span> <span class=\"token keyword\">struct</span> <span class=\"token class-name\">_HANDLE_TABLE</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>   ULONG_PTR TableCode<span class=\"token punctuation\">;</span> <span class=\"token comment\">// 指向句柄表的存储结构</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>   <span class=\"token keyword\">struct</span> <span class=\"token class-name\">_EPROCESS</span> <span class=\"token operator\">*</span>QuotaProcess<span class=\"token punctuation\">;</span> <span class=\"token comment\">// 句柄表的内存资源记录在此进程中</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>   HANDLE UniqueProcessId<span class=\"token punctuation\">;</span> <span class=\"token comment\">// 创建进程的 ID，用于回调函数</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">HANDLE_TABLE_LOCKS</span> <span class=\"token expression\"><span class=\"token number\">4</span></span></span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>   EX_PUSH_LOCK HandleTableLock<span class=\"token punctuation\">[</span>HANDLE_TABLE_LOCKS<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// 句柄表锁，仅在句柄表扩展时使用 </span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre></pre></td></tr><tr><td data-num=\"13\"></td><td><pre></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>   LIST_ENTRY HandleTableList<span class=\"token punctuation\">;</span> <span class=\"token comment\">// 所有的句柄表形成一个链表</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>                               <span class=\"token comment\">// 链表头为全局变量 HandleTableListHead  </span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>   EX_PUSH_LOCK HandleContentionEvent<span class=\"token punctuation\">;</span> <span class=\"token comment\">// 若在反问句柄时发生竞争，则在此推锁上等待</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>   PHANDLE_TRACE_DEBUG_INFO DebugInfo<span class=\"token punctuation\">;</span> <span class=\"token comment\">// 调试信息，仅当调试句柄时才有意义</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>   LONG ExtraInfoPages<span class=\"token punctuation\">;</span> <span class=\"token comment\">// 审计信息所</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre></pre></td></tr><tr><td data-num=\"23\"></td><td><pre></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>   ULONG FirstFree<span class=\"token punctuation\">;</span> <span class=\"token comment\">// 空闲链表表头的句柄索引</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>   ULONG LastFree<span class=\"token punctuation\">;</span> <span class=\"token comment\">// 最近被释放的句柄索引，用于 FIFO 类型空闲链表</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>   ULONG NextHandleNeedingPool<span class=\"token punctuation\">;</span> <span class=\"token comment\">// 下一次句柄表扩展的起始句柄索引</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>   LONG HandleCount<span class=\"token punctuation\">;</span> <span class=\"token comment\">// 正在使用的句柄表项的数量</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>   <span class=\"token keyword\">union</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>      ULONG Flags<span class=\"token punctuation\">;</span> <span class=\"token comment\">// 标志域</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>      BOOLEAN StrictFIFO <span class=\"token operator\">:</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// 是否使用 FIFO 风格的重用，即先释放先重用</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>   <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre></pre></td></tr><tr><td data-num=\"37\"></td><td><pre><span class=\"token punctuation\">&#125;</span> HANDLE_TABLE<span class=\"token punctuation\">,</span> <span class=\"token operator\">*</span>PHANDLE_TABLE<span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>HADNLE_TEBLE 中的 TableCode 域是一个指针，指向句柄表的最高层表项页面，它的低 2 位的值代表了当前句柄表的层数。<br />\n句柄表只有一层，该进程句柄表组多只能容纳 512 个句柄；<br />\n句柄表有两层，该进程句柄表组多只能容纳 512*1024 个句柄；<br />\n句柄表有三层，该进程句柄表组多只能容纳 512*1024*1024 个句柄；<br />\n但 Windows 执行体限定每个进程的句柄数不得超过 2 的 24 次方 也就是 16777216 个。</p>\n<p><img data-src=\"image001.png\" alt=\"\" /></p>\n<p><code>TableCode</code>  指向句柄表，但每个<strong>句柄表项</strong>是有结构的，下面我们来看看它的结构：</p>\n<p><img data-src=\"image003.png\" alt=\"\" /></p>\n<p>①：这一块共计两个字节，高位字节是给 SetHandleInformation 这个函数用的，比如写成如下形式，那么这个位置将被写入 0x02：</p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">SetHandleInformation</span><span class=\"token punctuation\">(</span>Handle<span class=\"token punctuation\">,</span>HANDLE_FLAG_PROTECT_FROM_CLOSE<span class=\"token punctuation\">,</span>HANDLE_FLAG_PROTECT_FROM_CLOSE<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p><code>HANDLE_FLAG_PROTECT_FROM_CLOSE</code>  宏的值为  <code>0x00000002</code>  ，取最低字节，最终 ① 这块是  <code>0x0200</code>  。<br />\n②：这块是访问掩码，是给  <code>OpenProcess</code>  这个函数用的，具体的存的值就是这个函数的第一个参数的值。<br />\n③ 和 ④ 这两个块共计四个字节，其中  <code>bit0-bit2</code>  存的是这个句柄的属性，其中  <code>bit2</code>  和  <code>bit0</code>  默认为  <code>0</code>  和  <code>1</code> ;  <code>bit1</code>  表示的函数是该句柄是否可继承，  <code>OpenProcess</code>  的第二个参数与  <code>bit1</code>  有关，31-3 位加上第三位清零存储的是内核对象的地址。低 3 位是属性，2 位默认是 0；1 位表示该句柄是否可继承；0 位默认为 1。</p>\n<div class=\"note warning\">\n<p>上述句柄的结构没有官方公开化文档，是经过逆向分析得到，可以根据自己的需要进行逆向分析。</p>\n</div>\n<p>执行体在创建进程是，首先为新进程分配一个单层句柄表。句柄表的创建工作是通过调用  <code>ExCreateHandleTable</code>  函数来完成的，该函数调用  <code>ExpAllocateHanleTable</code>  来构造出事的句柄表。随着进程中句柄数量的增加，单层句柄表被扩展为二层句柄表，再进一步被扩展为三层句柄表。句柄表的扩展时由函数  <code>ExpAllocateHandleTableEntrySlow</code>  来实现的。</p>\n<div class=\"note info\">\n<p>在句柄表  <code>HANDLE_TABLE</code>  结构中，  <code>FirstFree</code>  域记录了当前句柄表中的空闲句柄链，这是一个单链表，但并非通过指针链接起来，而是用句柄索引值来链接。句柄索引值按  <code>HANDLE_VALUE_INC</code>  逐个递增，这还是一个宏定义，其值为 4。</p>\n<p><code>FirstFree</code>  域指示了链表头的索引值，  <code>HANDLE_TABLE_ENTRY</code>  结构中的  <code>NextFreeTableEntry</code>  成员等于下一个空闲句柄的句柄索引值。因此当进程在执行过程中需要创建新的句柄时，执行体可以直接从空闲句柄链表头得到一个句柄，新的链表头编程原来链表头的  <code>NextFreeTableEntry</code> ，参见  <code>ExpAllocateHandleTableEntry</code>  函数的代码；而当释放句柄时，将待释放的句柄索引赋给  <code>FristFree</code> ，且该句柄项的  <code>NextFreeTableEntry</code>  赋为原来的  <code>FirstFree</code>  参见  <code>ExpFreeHandleTableEntry</code>  函数的代码。</p>\n<p>另外，  <code>HANDLE_TABLE</code>  结构的  <code>NextHandleNeedingPool</code>  域记录了下一次句柄表扩展的其实句柄索引，相当于当前句柄表中所有已分配页面都满了以后下一个页面的起始句柄索引。</p>\n</div>\n<p>理解了 Windows 进程句柄表的结构以后，我们看一下句柄表项的内容和句柄本身。</p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">typedef</span> <span class=\"token keyword\">struct</span> <span class=\"token class-name\">_HANDLE_TABLE_ENTRY</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token comment\">//  The pointer to the object overloaded with three ob attributes bits in</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token comment\">//  the lower order and the high bit to denote locked or unlocked entries</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token keyword\">union</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>        PVOID Object<span class=\"token punctuation\">;</span>  <span class=\"token comment\">// 指向句柄所代表的的对象</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>        ULONG ObAttributes<span class=\"token punctuation\">;</span> <span class=\"token comment\">// 最低三位有特别含义</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>        PHANDLE_TABLE_ENTRY_INFO InfoTable<span class=\"token punctuation\">;</span> <span class=\"token comment\">// 各个句柄表页面的第一个表项，使用此成员指向一张表</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>        ULONG_PTR Value<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>    <span class=\"token comment\">//  This field either contains the granted access mask for the handle or an</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>    <span class=\"token comment\">//  ob variation that also stores the same information.  Or in the case of</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>    <span class=\"token comment\">//  a free entry the field stores the index for the next free entry in the</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>    <span class=\"token comment\">//  free list.  This is like a FAT chain, and is used instead of pointers</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>    <span class=\"token comment\">//  to make table duplication easier, because the entries can just be</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>    <span class=\"token comment\">//  copied without needing to modify pointers.</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>    <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>    <span class=\"token keyword\">union</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>        <span class=\"token keyword\">union</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>            ACCESS_MASK GrantedAccess<span class=\"token punctuation\">;</span> <span class=\"token comment\">// 访问掩码</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>            <span class=\"token keyword\">struct</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>                USHORT GrantedAccessIndex<span class=\"token punctuation\">;</span> </pre></td></tr><tr><td data-num=\"37\"></td><td><pre>                USHORT CreatorBackTraceIndex<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>        LONG NextFreeTableEntry<span class=\"token punctuation\">;</span> <span class=\"token comment\">// 空闲时表示下一个空闲句柄索引</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre></pre></td></tr><tr><td data-num=\"44\"></td><td><pre><span class=\"token punctuation\">&#125;</span> HANDLE_TABLE_ENTRY<span class=\"token punctuation\">,</span> <span class=\"token operator\">*</span>PHANDLE_TABLE_ENTRY<span class=\"token punctuation\">;</span></pre></td></tr></table></figure><div class=\"note info\">\n<p>Object 指针所指的就是句柄所代表的内核对象，它的最低 3 位有特殊的含义</p>\n<table>\n<thead>\n<tr>\n<th><strong>位数</strong></th>\n<th><strong>名称</strong></th>\n<th><strong>含义</strong></th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>第 0 位</td>\n<td>OBJ_PROTECT_CLOSE</td>\n<td>表示调用者是否允许关闭该句柄</td>\n</tr>\n<tr>\n<td>第 1 位</td>\n<td>OBJ_INHERIT</td>\n<td>指示该进程所创建的子进程是否可以继承该句柄</td>\n</tr>\n<tr>\n<td>第 2 位</td>\n<td>OBJ_AUDIT_OBJECT_CLOSE</td>\n<td>指示关闭该对象时是否产生一个审计事件</td>\n</tr>\n</tbody>\n</table>\n<p>因此，想要获得句柄对象的地址需要将 Object 的低 3 位清 0，但是此时所得到的对象地址指向的是对象头，偏移 0x18 的地址才是对象的真正地址。</p>\n<p>在第二个 union 中，如果句柄表项指向一个有效的对象，那么，  <code>GranteAccess</code>  成员记录了该句柄的访问掩码；如果是一个空闲的句柄表现，那么，  <code>NextFreeTableEntry</code>  成员将加入到句柄表的空闲单链表中。</p>\n</div>\n<h3 id=\"多层句柄表的解析方法\"><a class=\"anchor\" href=\"#多层句柄表的解析方法\">#</a> 多层句柄表的解析方法</h3>\n<p>第一层<br />\n ID /4 *8</p>\n<p>第二层<br />\n ID/4 /512 计算是那个目录<br />\n ID/4%512 *8</p>\n<p>第三层<br />\n ID/4/512/1024<br />\nID/4/512<br />\nID/4%512 *8</p>\n<p>具体要逆向内核函数  <code>ExpLookupHandleTableEntry</code>  。WRK 中有这个函数。</p>\n<h3 id=\"实验观察进程的句柄表\"><a class=\"anchor\" href=\"#实验观察进程的句柄表\">#</a> 实验：观察进程的句柄表</h3>\n<p>我们得到的句柄值是一个索引，它的值除以 4 是句柄表的下标，通过下标能找到存储在句柄表里的句柄表项，每个占 8 字节。应该是微软考虑兼容的问题。</p>\n<details class=\"info\"><summary>写个for循环，连续打开100和1000次某个内核对象（点击展开）</summary><div>\n<p>代码如下：</p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span><span class=\"token string\">&lt;stdio.h></span></span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span><span class=\"token string\">&lt;Windows.h></span></span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">void</span> <span class=\"token function\">Test</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>\t<span class=\"token keyword\">int</span> i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>\tDWORD dwPid <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>\tHANDLE hPro <span class=\"token operator\">=</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>\tHWND hWnd <span class=\"token operator\">=</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\thWnd <span class=\"token operator\">=</span> <span class=\"token function\">FindWindow</span><span class=\"token punctuation\">(</span><span class=\"token constant\">NULL</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"计算器\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\t<span class=\"token function\">GetWindowThreadProcessId</span><span class=\"token punctuation\">(</span>hWnd<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>dwPid<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>\t<span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"PID:%d\\n\"</span><span class=\"token punctuation\">,</span> dwPid<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>\t<span class=\"token function\">system</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"pause\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>\t<span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> <span class=\"token number\">100</span><span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>\t\thPro <span class=\"token operator\">=</span> <span class=\"token function\">OpenProcess</span><span class=\"token punctuation\">(</span>PROCESS_ALL_ACCESS<span class=\"token punctuation\">,</span> TRUE<span class=\"token punctuation\">,</span> dwPid<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>\t\t<span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"句柄：%#X\\t\\n\"</span><span class=\"token punctuation\">,</span> hPro<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre></pre></td></tr><tr><td data-num=\"19\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre></pre></td></tr><tr><td data-num=\"21\"></td><td><pre><span class=\"token keyword\">int</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> argc<span class=\"token punctuation\">,</span> <span class=\"token keyword\">char</span><span class=\"token operator\">*</span> argv<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>\t<span class=\"token function\">Test</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>\t<span class=\"token function\">system</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"pause\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>\t<span class=\"token keyword\">return</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>执行结果如下：</p>\n<p><img data-src=\"image002.png\" alt=\"\" /></p>\n</div></details>\n<details class=\"info\"><summary>在Windbg中查看句柄表</summary><div>\n<ol>\n<li>打开一个进程，本次实验就选择计算器了（calc.exe）</li>\n<li>执行上面的代码</li>\n<li>在 WinDbg 中定位句柄表</li>\n</ol>\n<p>首先在 windbg 查看所有进程  <code>!process 0 0</code> ，找到执行上面代码的进程，查看进程的  <code>EPROCESS</code>  结构体的 0xc4 的位置</p>\n<figure class=\"highlight raw\"><figcaption data-lang=\"\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>kd&gt; dt _EPROCESS 89d2b020</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>nt!_EPROCESS</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>   +0x000 Pcb              : _KPROCESS</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>   +0x06c ProcessLock      : _EX_PUSH_LOCK</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>   +0x070 CreateTime       : _LARGE_INTEGER 0x01d81906&#96;e28e540a</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>   +0x078 ExitTime         : _LARGE_INTEGER 0x0</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>   +0x080 RundownProtect   : _EX_RUNDOWN_REF</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>   +0x084 UniqueProcessId  : 0x0000013c Void</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>   +0x088 ActiveProcessLinks : _LIST_ENTRY [0x89e890a8 - 0x89d31ba8]</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>   +0x090 QuotaUsage       : [3] 0x618</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>   +0x09c QuotaPeak        : [3] 0x808</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>   +0x0a8 CommitCharge     : 0x72</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>   +0x0ac PeakVirtualSize  : 0xf8f000</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>   +0x0b0 VirtualSize      : 0xdf7000</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>   +0x0b4 SessionProcessLinks : _LIST_ENTRY [ 0x89e890d4 - 0x89d31bd4 ]</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>   +0x0bc DebugPort        : 0x89e8ba88 Void</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>   +0x0c0 ExceptionPort    : 0xe15d5aa0 Void</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>   +0x0c4 ObjectTable      : 0xe31af420 _HANDLE_TABLE &#x2F;&#x2F; 这里</pre></td></tr></table></figure><p>查看进程的句柄表：</p>\n<figure class=\"highlight raw\"><figcaption data-lang=\"\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>kd&gt; dt _HANDLE_TABLE 0xe31af420</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>ntdll!_HANDLE_TABLE</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    [+0x000] TableCode        : 0xe179b000 [Type: unsigned long] &#x2F;&#x2F; 这个地址便是表示句柄表在哪里</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    [+0x004] QuotaProcess     : 0x89d2b020 [Type: _EPROCESS *]</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    [+0x008] UniqueProcessId  : 0x13c [Type: void *]</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    [+0x00c] HandleTableLock  [Type: _EX_PUSH_LOCK [4]]</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    [+0x01c] HandleTableList  [Type: _LIST_ENTRY]</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    [+0x024] HandleContentionEvent [Type: _EX_PUSH_LOCK]</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    [+0x028] DebugInfo        : 0x0 [Type: _HANDLE_TRACE_DEBUG_INFO *]</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    [+0x02c] ExtraInfoPages   : 0 [Type: long]</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    [+0x030] FirstFree        : 0x638 [Type: unsigned long]</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    [+0x034] LastFree         : 0x0 [Type: unsigned long]</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    [+0x038] NextHandleNeedingPool : 0x800 [Type: unsigned long]</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    [+0x03c] HandleCount      : 121 [Type: long]</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    [+0x040] Flags            : 0x0 [Type: unsigned long]</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    [+0x040 ( 0: 0)] StrictFIFO       : 0x0 [Type: unsigned char]</pre></td></tr></table></figure><p>我们以 0x7CC 这个句柄值举例，来弄清楚这个句柄值所代表的的含义。</p>\n<p>首先让这个句柄值除以 4 得到句柄表的下标，再乘以 8（可以直接用句柄值乘以 2）得到相对于句柄表首地址的偏移，这个值加上  <code>TableCode</code>  的值就是这个句柄值在句柄表中所代表的句柄项，剩下的就是分析其结构了。</p>\n<p>我们由上可知  <code>TableCode</code>  的值为： <code>0xe179b000</code> 。</p>\n<p>在 windbg 中查看：</p>\n<figure class=\"highlight raw\"><figcaption data-lang=\"\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>kd&gt; dq 0xe179b000 + 0x7CC * 2</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>e179bf98  001f0fff&#96;89d31b0b 000f01ff&#96;89d71981</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>e179bfa8  000f037f&#96;89f10899 021f0003&#96;89efdf79</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>e179bfb8  020f003f&#96;e3302691 000f037f&#96;89f10899</pre></td></tr></table></figure><p>那么这个  <code>001f0fff`89d31b0b</code>  就是句柄  <code>0x7cc</code>  在句柄表中所对应的句柄项。</p>\n<p>若要根据句柄查找对应的结构体地址，我们还要对  <code>89d31b0b</code>  处理一下，由上面句柄表项的结构，我们知道后三比特位是属性，所以我们把后三比特位清零， <code>b</code>  的二进制为  <code>1011</code>  , 清空后为  <code>1000</code>  既为  <code>8</code> 。</p>\n<p>所以  <code>89d31b0b</code>  处理后为  <code>89d31b08</code>  ，但是，这个地址指向的仍然不是  <code>EPROCESS</code>  ，而是  <code>_OBJECT_HEADER</code>  结构体，这个是每一个内核对象都有的，被称为对象头：</p>\n<figure class=\"highlight raw\"><figcaption data-lang=\"\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>kd&gt; dt _OBJECT_HEADER</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>nt!_OBJECT_HEADER</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>   +0x000 PointerCount     : Int4B</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>   +0x004 HandleCount      : Int4B</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>   +0x004 NextToFree       : Ptr32 Void</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>   +0x008 Type             : Ptr32 _OBJECT_TYPE</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>   +0x00c NameInfoOffset   : UChar</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>   +0x00d HandleInfoOffset : UChar</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>   +0x00e QuotaInfoOffset  : UChar</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>   +0x00f Flags            : UChar</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>   +0x010 ObjectCreateInfo : Ptr32 _OBJECT_CREATE_INFORMATION</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>   +0x010 QuotaBlockCharged : Ptr32 Void</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>   +0x014 SecurityDescriptor : Ptr32 Void</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>   +0x018 Body             : _QUAD</pre></td></tr></table></figure><p>而  <code>89d31b08</code>  指向的是一个完整的内核结构，而一个完整的内核结构一定是以  <code>_OBJECT_HEADER</code>  开头的。不管是  <code>EPROCESS</code>  还是  <code>ETHREAD</code>  结构体，都是在  <code>_OBJECT_HEADER</code>  的  <code> +0x018 Body</code>  位置开始的。所以  <code>89d31b08</code>  加上 0x18 才是计算器的  <code>EPROCESS</code>  结构体。</p>\n<p>在 windbg 中查看：</p>\n<figure class=\"highlight raw\"><figcaption data-lang=\"\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>kd&gt; dt _Eprocess 89d31b08 +0x18</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>nt!_EPROCESS</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>   +0x000 Pcb              : _KPROCESS</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>   +0x06c ProcessLock      : _EX_PUSH_LOCK</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>   ……</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>   ……</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>   ……</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>   ……</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>   ……</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>   +0x174 ImageFileName    : [16]  &quot;calc.exe&quot; &#x2F;&#x2F; 可以确定我们找到了</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>   +0x184 JobLinks         : _LIST_ENTRY [ 0x0 - 0x0 ]</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>   +0x18c LockedPagesList  : (null) </pre></td></tr><tr><td data-num=\"13\"></td><td><pre>   ……</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>   ……</pre></td></tr></table></figure></div></details>\n<details class=\"info\"><summary>总结</summary><div>\n<ol>\n<li>一个进程可以创建、打开很多内核对象，这些内核对象的地址存储在当前进程的句柄表中。我们在应用层得到的句柄值，实际上就是当前进程句柄表的索引。</li>\n<li>同一个内核对象可以被不同的进程所引用，但句柄的值可能一样也可能不一样。</li>\n<li>如果有进程被其他进程打开（使用 OpenProcess）, 那么这个进程的句柄表中就会有痕迹。</li>\n</ol>\n</div></details>\n<h3 id=\"作业\"><a class=\"anchor\" href=\"#作业\">#</a> 作业</h3>\n<details class=\"info\"><summary>遍历（解析）某个进程的句柄表</summary><div>\n<p>代码如下：</p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span><span class=\"token string\">&lt;ntddk.h></span></span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">typedef</span> <span class=\"token keyword\">struct</span> <span class=\"token class-name\">_HANDLE_TABLE_ENTRY_INFO</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>\t<span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>\t<span class=\"token comment\">//  The following field contains the audit mask for the handle if one</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\t<span class=\"token comment\">//  exists.  The purpose of the audit mask is to record all of the accesses</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\t<span class=\"token comment\">//  that may have been audited when the handle was opened in order to</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>\t<span class=\"token comment\">//  support \"per operation\" based auditing.  It is computed by walking the</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>\t<span class=\"token comment\">//  SACL of the object being opened and keeping a record of all of the audit</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>\t<span class=\"token comment\">//  ACEs that apply to the open operation going on.  Each set bit corresponds</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>\t<span class=\"token comment\">//  to an access that would be audited.  As each operation takes place, its</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>\t<span class=\"token comment\">//  corresponding access bit is removed from this mask.</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>\t<span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>\tACCESS_MASK AuditMask<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre></pre></td></tr><tr><td data-num=\"20\"></td><td><pre><span class=\"token punctuation\">&#125;</span> HANDLE_TABLE_ENTRY_INFO<span class=\"token punctuation\">,</span> <span class=\"token operator\">*</span> PHANDLE_TABLE_ENTRY_INFO<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre></pre></td></tr><tr><td data-num=\"22\"></td><td><pre><span class=\"token keyword\">typedef</span> <span class=\"token keyword\">struct</span> <span class=\"token class-name\">_HANDLE_TABLE_ENTRY</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>\t<span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>\t<span class=\"token comment\">//  The pointer to the object overloaded with three ob attributes bits in</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>\t<span class=\"token comment\">//  the lower order and the high bit to denote locked or unlocked entries</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>\t<span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>\t<span class=\"token keyword\">union</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>\t\tPVOID Object<span class=\"token punctuation\">;</span>  <span class=\"token comment\">// 指向句柄所代表的的对象</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>\t\tULONG ObAttributes<span class=\"token punctuation\">;</span> <span class=\"token comment\">// 最低三位有特别含义</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>\t\tPHANDLE_TABLE_ENTRY_INFO InfoTable<span class=\"token punctuation\">;</span> <span class=\"token comment\">// 各个句柄表页面的第一个表项，使用此成员指向一张表</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>\t\tULONG_PTR Value<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>\t<span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>\t<span class=\"token comment\">//  This field either contains the granted access mask for the handle or an</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>\t<span class=\"token comment\">//  ob variation that also stores the same information.  Or in the case of</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>\t<span class=\"token comment\">//  a free entry the field stores the index for the next free entry in the</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>\t<span class=\"token comment\">//  free list.  This is like a FAT chain, and is used instead of pointers</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>\t<span class=\"token comment\">//  to make table duplication easier, because the entries can just be</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>\t<span class=\"token comment\">//  copied without needing to modify pointers.</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>\t<span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>\t<span class=\"token keyword\">union</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>\t\t<span class=\"token keyword\">union</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>\t\t\tACCESS_MASK GrantedAccess<span class=\"token punctuation\">;</span> <span class=\"token comment\">// 访问掩码</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre></pre></td></tr><tr><td data-num=\"55\"></td><td><pre>\t\t\t<span class=\"token keyword\">struct</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre></pre></td></tr><tr><td data-num=\"57\"></td><td><pre>\t\t\t\tUSHORT GrantedAccessIndex<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre>\t\t\t\tUSHORT CreatorBackTraceIndex<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"59\"></td><td><pre>\t\t\t<span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre>\t\t<span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"61\"></td><td><pre></pre></td></tr><tr><td data-num=\"62\"></td><td><pre>\t\tLONG NextFreeTableEntry<span class=\"token punctuation\">;</span> <span class=\"token comment\">// 空闲时表示下一个空闲句柄索引</span></pre></td></tr><tr><td data-num=\"63\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"64\"></td><td><pre></pre></td></tr><tr><td data-num=\"65\"></td><td><pre><span class=\"token punctuation\">&#125;</span> HANDLE_TABLE_ENTRY<span class=\"token punctuation\">,</span> <span class=\"token operator\">*</span> PHANDLE_TABLE_ENTRY<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"66\"></td><td><pre></pre></td></tr><tr><td data-num=\"67\"></td><td><pre><span class=\"token comment\">// 从 WRK 源码中复制的宏定义</span></pre></td></tr><tr><td data-num=\"68\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">TABLE_PAGE_SIZE</span> <span class=\"token expression\">PAGE_SIZE</span></span></pre></td></tr><tr><td data-num=\"69\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">LOWLEVEL_COUNT</span> <span class=\"token expression\"><span class=\"token punctuation\">(</span>TABLE_PAGE_SIZE <span class=\"token operator\">/</span> <span class=\"token keyword\">sizeof</span><span class=\"token punctuation\">(</span>HANDLE_TABLE_ENTRY<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></span></span></pre></td></tr><tr><td data-num=\"70\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">MIDLEVEL_COUNT</span> <span class=\"token expression\"><span class=\"token punctuation\">(</span>PAGE_SIZE <span class=\"token operator\">/</span> <span class=\"token keyword\">sizeof</span><span class=\"token punctuation\">(</span>PHANDLE_TABLE_ENTRY<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></span></span></pre></td></tr><tr><td data-num=\"71\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">LOWLEVEL_THRESHOLD</span> <span class=\"token expression\">LOWLEVEL_COUNT</span></span></pre></td></tr><tr><td data-num=\"72\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">MIDLEVEL_THRESHOLD</span> <span class=\"token expression\"><span class=\"token punctuation\">(</span>MIDLEVEL_COUNT <span class=\"token operator\">*</span> LOWLEVEL_COUNT<span class=\"token punctuation\">)</span></span></span></pre></td></tr><tr><td data-num=\"73\"></td><td><pre></pre></td></tr><tr><td data-num=\"74\"></td><td><pre>VOID <span class=\"token function\">DriverUnload</span><span class=\"token punctuation\">(</span>PDRIVER_OBJECT pDriver<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"75\"></td><td><pre></pre></td></tr><tr><td data-num=\"76\"></td><td><pre>\t<span class=\"token function\">DbgPrint</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"我是驱动，我卸载了\\t\\n\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"77\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"78\"></td><td><pre></pre></td></tr><tr><td data-num=\"79\"></td><td><pre>VOID <span class=\"token function\">Func</span><span class=\"token punctuation\">(</span>PUCHAR pName<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"80\"></td><td><pre>\t<span class=\"token comment\">//VOID Func(ULONG uPid) &#123;</span></pre></td></tr><tr><td data-num=\"81\"></td><td><pre>\tULONG Pro<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"82\"></td><td><pre>\t__asm <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"83\"></td><td><pre>\t\tmov eax<span class=\"token punctuation\">,</span> fs<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token number\">0x124</span><span class=\"token punctuation\">]</span> <span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"84\"></td><td><pre>\t\tmov eax<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span>eax <span class=\"token operator\">+</span> <span class=\"token number\">0x44</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"85\"></td><td><pre>\t\tmov Pro<span class=\"token punctuation\">,</span> eax<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"86\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"87\"></td><td><pre>\t<span class=\"token comment\">// 进程结构体 EPROCESS +0x88 的位置是一个链接所有进程的双向链表</span></pre></td></tr><tr><td data-num=\"88\"></td><td><pre>\tPLIST_ENTRY pListProcess <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>PLIST_ENTRY<span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span>Pro <span class=\"token operator\">+</span> <span class=\"token number\">0x88</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"89\"></td><td><pre>\t<span class=\"token comment\">// 遍历进程</span></pre></td></tr><tr><td data-num=\"90\"></td><td><pre>\t<span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span>pListProcess<span class=\"token operator\">-></span>Flink <span class=\"token operator\">!=</span> <span class=\"token punctuation\">(</span>PLIST_ENTRY<span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span>Pro <span class=\"token operator\">+</span> <span class=\"token number\">0x88</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"91\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"92\"></td><td><pre>\t\t<span class=\"token comment\">//EPROCESS 结构体</span></pre></td></tr><tr><td data-num=\"93\"></td><td><pre>\t\tULONG NextProcess <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>ULONG<span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span>pListProcess<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span> <span class=\"token number\">0x88</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"94\"></td><td><pre>\t\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">strcmp</span><span class=\"token punctuation\">(</span>pName<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span>PUCHAR<span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span>NextProcess <span class=\"token operator\">+</span> <span class=\"token number\">0x174</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"95\"></td><td><pre>\t\t\t<span class=\"token comment\">//if (uPid == *(PULONG)(NextProcess + 0x84))</span></pre></td></tr><tr><td data-num=\"96\"></td><td><pre>\t\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"97\"></td><td><pre>\t\t\t<span class=\"token function\">DbgPrint</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Eprocess:%#X\\t\\n\"</span><span class=\"token punctuation\">,</span> NextProcess<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"98\"></td><td><pre></pre></td></tr><tr><td data-num=\"99\"></td><td><pre>\t\t\t<span class=\"token comment\">// 遍历句柄表</span></pre></td></tr><tr><td data-num=\"100\"></td><td><pre>\t\t\t<span class=\"token comment\">// 取进程 0xc4 的地址</span></pre></td></tr><tr><td data-num=\"101\"></td><td><pre>\t\t\tPULONG ObjectTable <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>PULONG<span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span><span class=\"token operator\">*</span><span class=\"token punctuation\">(</span>PULONG<span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span>NextProcess <span class=\"token operator\">+</span> <span class=\"token number\">0xC4</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"102\"></td><td><pre>\t\t\t<span class=\"token function\">DbgPrint</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"ObjectTable:%#X\\t\\n\"</span><span class=\"token punctuation\">,</span> ObjectTable<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"103\"></td><td><pre></pre></td></tr><tr><td data-num=\"104\"></td><td><pre>\t\t\tPULONG TableCode <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>PULONG<span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span><span class=\"token operator\">*</span>ObjectTable<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"105\"></td><td><pre>\t\t\t<span class=\"token function\">DbgPrint</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"TableCode:%#X\\t\\n\"</span><span class=\"token punctuation\">,</span> TableCode<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"106\"></td><td><pre></pre></td></tr><tr><td data-num=\"107\"></td><td><pre>\t\t\t<span class=\"token comment\">// 判断有进程句柄表的层数</span></pre></td></tr><tr><td data-num=\"108\"></td><td><pre>\t\t\t<span class=\"token comment\">// 取最后两 bit 位</span></pre></td></tr><tr><td data-num=\"109\"></td><td><pre>\t\t\t<span class=\"token keyword\">switch</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">*</span>TableCode <span class=\"token operator\">&amp;</span> <span class=\"token number\">0x3</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"110\"></td><td><pre>\t\t\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"111\"></td><td><pre>\t\t\t<span class=\"token keyword\">case</span> <span class=\"token number\">0</span><span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"112\"></td><td><pre>\t\t\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"113\"></td><td><pre>            PHANDLE_TABLE_ENTRY pTableCode <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>PHANDLE_TABLE_ENTRY<span class=\"token punctuation\">)</span>TableCode<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"114\"></td><td><pre>            <span class=\"token function\">DbgPrint</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"pTableCode:%#X\\t\\n\"</span><span class=\"token punctuation\">,</span> pTableCode<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"115\"></td><td><pre>\t\t\t\t<span class=\"token comment\">// 开始遍历句柄表，大小时一个页</span></pre></td></tr><tr><td data-num=\"116\"></td><td><pre>\t\t\t\t<span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">size_t</span> i <span class=\"token operator\">=</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> LOWLEVEL_THRESHOLD <span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"117\"></td><td><pre>\t\t\t\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"118\"></td><td><pre>\t\t\t\t\t<span class=\"token function\">DbgPrint</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"[*]>>-----【第%d项】-----&lt;&lt;[*]\"</span><span class=\"token punctuation\">,</span> i<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"119\"></td><td><pre>\t\t\t\t\t<span class=\"token function\">DbgPrint</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Object:%#010x\\t\\n\"</span><span class=\"token punctuation\">,</span> pTableCode<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>Object<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"120\"></td><td><pre>\t\t\t\t\t<span class=\"token function\">DbgPrint</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"ObAttributes:%#010x\\t\\n\"</span><span class=\"token punctuation\">,</span> pTableCode<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>ObAttributes<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"121\"></td><td><pre>\t\t\t\t\t<span class=\"token function\">DbgPrint</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"InfoTable:%#010x\\t\\n\"</span><span class=\"token punctuation\">,</span> pTableCode<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>InfoTable<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"122\"></td><td><pre>\t\t\t\t\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>pTableCode<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>InfoTable <span class=\"token operator\">!=</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"123\"></td><td><pre>\t\t\t\t\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"124\"></td><td><pre>\t\t\t\t\t\t<span class=\"token function\">DbgPrint</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"InfoTable->AuditMask:%#010x\\t\\n\"</span><span class=\"token punctuation\">,</span> pTableCode<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>InfoTable<span class=\"token operator\">-></span>AuditMask<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"125\"></td><td><pre>\t\t\t\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"126\"></td><td><pre>\t\t\t\t\t<span class=\"token function\">DbgPrint</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Value:%#010x\\t\\n\"</span><span class=\"token punctuation\">,</span> pTableCode<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>Value<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"127\"></td><td><pre>\t\t\t\t\t<span class=\"token function\">DbgPrint</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"GrantedAccess:%#010x\\t\\n\"</span><span class=\"token punctuation\">,</span> pTableCode<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>GrantedAccess<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"128\"></td><td><pre>\t\t\t\t\t<span class=\"token function\">DbgPrint</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"GrantedAccessIndex:%#010x\\t\\n\"</span><span class=\"token punctuation\">,</span> pTableCode<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>GrantedAccessIndex<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"129\"></td><td><pre>\t\t\t\t\t<span class=\"token function\">DbgPrint</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"CreatorBackTraceIndex:%#010x\\t\\n\"</span><span class=\"token punctuation\">,</span> pTableCode<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>CreatorBackTraceIndex<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"130\"></td><td><pre>\t\t\t\t\t<span class=\"token function\">DbgPrint</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"NextFreeTableEntry:%#010x\\t\\n\"</span><span class=\"token punctuation\">,</span> pTableCode<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>NextFreeTableEntry<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"131\"></td><td><pre>\t\t\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"132\"></td><td><pre>\t\t\t\t<span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"133\"></td><td><pre>\t\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"134\"></td><td><pre>\t\t\t<span class=\"token keyword\">case</span> <span class=\"token number\">1</span><span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"135\"></td><td><pre>\t\t\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"136\"></td><td><pre>\t\t\t\t<span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"137\"></td><td><pre>\t\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"138\"></td><td><pre>\t\t\t<span class=\"token keyword\">case</span> <span class=\"token number\">2</span><span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"139\"></td><td><pre>\t\t\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"140\"></td><td><pre>\t\t\t\t<span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"141\"></td><td><pre>\t\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"142\"></td><td><pre>\t\t\t<span class=\"token keyword\">case</span> <span class=\"token number\">3</span><span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"143\"></td><td><pre>\t\t\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"144\"></td><td><pre>\t\t\t\t<span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"145\"></td><td><pre>\t\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"146\"></td><td><pre>\t\t\t<span class=\"token keyword\">default</span><span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"147\"></td><td><pre>\t\t\t\t<span class=\"token function\">DbgPrint</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"*HandleTable &amp; 0x3 = %d\"</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">*</span>TableCode <span class=\"token operator\">&amp;</span> <span class=\"token number\">0x3</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"148\"></td><td><pre>\t\t\t\t<span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"149\"></td><td><pre>\t\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"150\"></td><td><pre></pre></td></tr><tr><td data-num=\"151\"></td><td><pre>\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"152\"></td><td><pre>\t\tpListProcess <span class=\"token operator\">=</span> pListProcess<span class=\"token operator\">-></span>Flink<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"153\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"154\"></td><td><pre></pre></td></tr><tr><td data-num=\"155\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"156\"></td><td><pre></pre></td></tr><tr><td data-num=\"157\"></td><td><pre>NTSTATUS <span class=\"token function\">DriverEntry</span><span class=\"token punctuation\">(</span>PDRIVER_OBJECT pDriver<span class=\"token punctuation\">,</span> PUNICODE_STRING pRegPath<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"158\"></td><td><pre>\tpDriver<span class=\"token operator\">-></span>DriverUnload <span class=\"token operator\">=</span> DriverUnload<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"159\"></td><td><pre>\t<span class=\"token function\">DbgPrint</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"我是驱动,我运行了\\t\\n\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"160\"></td><td><pre>\t<span class=\"token comment\">// 遍历所有进程，遍历该进程的句柄表</span></pre></td></tr><tr><td data-num=\"161\"></td><td><pre>\t<span class=\"token function\">Func</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"calc.exe\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"162\"></td><td><pre>\t<span class=\"token keyword\">return</span> STATUS_SUCCESS<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"163\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>仅仅遍历了层数为 1 的句柄表。也可以遍历的更详细，遍历出每个句柄的类型。</p>\n<p><img data-src=\"image005.png\" alt=\"\" /></p>\n</div></details>\n<details class=\"info\"><summary>实现用句柄表反调试</summary><div>\n<p>思路：遍历所有其他进程句柄表，看哪个进程的句柄表中保护自己的进程，如果有，说明正在被调试。</p>\n<p>用一个驱动不停地遍历进程链表，然后遍历进程的句柄表，如果发现句柄表项和游戏 EPROCESS 相等，就意味着被 OpenProcess 了，就认为是被调试了。</p>\n<p>代码：</p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>暂时pass</pre></td></tr></table></figure></div></details>\n<h2 id=\"全局句柄表\"><a class=\"anchor\" href=\"#全局句柄表\">#</a> 全局句柄表</h2>\n<p>在进程中可以创建、打开很多内核对象，这些内核对象的地址都存储在当前进程的句柄表中。我们在应用层得到的句柄实际上就是句柄表的索引。进程的句柄表是私有的，每个进程都有一个自己的句柄表。除此之外，系统还有一个全局句柄表，其导出变量是： <code>PspCidTable</code></p>\n<p>所有的进程和线程无论无论是否打开，都在这个表中。<br />\n每个进程和线程都有一个唯一的编号： <code>PID</code>  和  <code>TID</code> ，这两个值其实就是全局句柄表中的索引，统称  <code>CID</code> 。进程和线程的查询，主要是以下三个函数，按照给定的  <code>PID</code>  或  <code>TID</code>  从  <code>PspCidTable</code>  从查找相应的进线程对象：</p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">PsLookupProcessThreadByCid</span><span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">,</span> x<span class=\"token punctuation\">,</span> x<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token function\">PsLookupProcessByProcessId</span><span class=\"token punctuation\">(</span>HANDLE ProcessId<span class=\"token punctuation\">,</span> PEPROCESS <span class=\"token operator\">*</span>Process<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token function\">PsLookupThreadByThreadId</span><span class=\"token punctuation\">(</span>HANDLE ThreadId<span class=\"token punctuation\">,</span> PETHREAD <span class=\"token operator\">*</span>Thread<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>全局句柄表的结构如下：</p>\n<p><img data-src=\"image004.png\" alt=\"\" /></p>\n<h3 id=\"观察全局句柄表\"><a class=\"anchor\" href=\"#观察全局句柄表\">#</a> 观察全局句柄表</h3>\n<p>在 Windbg 中查看：通过 PID 的值和  <code>PspCidTable</code>  找到内核对象。</p>\n<p>随便打开一个进程，查看其 PID，我打开的计算器的 PID 为 1212，转换为 16 进制为 0x4BC。</p>\n<figure class=\"highlight raw\"><figcaption data-lang=\"\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>kd&gt; dd PspCidTable</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>805649c0  e1003c58 00000002 00000000 00000000</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>805649d0  00000000 00000000 00000000 00000000</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>805649e0  00000000 00000000 00000000 00000000</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>805649f0  00000000 00000000 00000000 00000000</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>80564a00  00000000 00000000 00000000 00000000</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>80564a10  00000000 00000000 00000000 00000000</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>80564a20  00000000 00000000 00000000 00000000</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>80564a30  00000000 00000000 00000000 00000000</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>kd&gt; dt e1003c58 _HANDLE_TABLE</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>nt!_HANDLE_TABLE</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>   +0x000 TableCode        : 0xe1005000</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>   +0x004 QuotaProcess     : (null) </pre></td></tr><tr><td data-num=\"14\"></td><td><pre>   +0x008 UniqueProcessId  : (null) </pre></td></tr><tr><td data-num=\"15\"></td><td><pre>   +0x00c HandleTableLock  : [4] _EX_PUSH_LOCK</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>   +0x01c HandleTableList  : _LIST_ENTRY [ 0xe1003c74 - 0xe1003c74 ]</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>   +0x024 HandleContentionEvent : _EX_PUSH_LOCK</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>   +0x028 DebugInfo        : (null) </pre></td></tr><tr><td data-num=\"19\"></td><td><pre>   +0x02c ExtraInfoPages   : 0n0</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>   +0x030 FirstFree        : 0x39c</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>   +0x034 LastFree         : 0x770</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>   +0x038 NextHandleNeedingPool : 0x800</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>   +0x03c HandleCount      : 0n279</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>   +0x040 Flags            : 1</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>   +0x040 StrictFIFO       : 0y1</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>kd&gt; dq 0xe1005000 + 4BC * 2</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>e1005978  00000000&#96;89ee8021 0000055c&#96;00000000</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>e1005988  000000e8&#96;00000000 00000000&#96;89efe8a9</pre></td></tr><tr><td data-num=\"29\"></td><td><pre>e1005998  00000728&#96;00000000 0000070c&#96;00000000</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>e10059a8  00000000&#96;89d4e6a1 000004a0&#96;00000000</pre></td></tr><tr><td data-num=\"31\"></td><td><pre>e10059b8  00000000&#96;8a05c6a9 00000304&#96;00000000</pre></td></tr><tr><td data-num=\"32\"></td><td><pre>e10059c8  00000000&#96;8a0f1da1 00000000&#96;8a0f16c9</pre></td></tr><tr><td data-num=\"33\"></td><td><pre>e10059d8  00000000&#96;89cd7161 00000000&#96;8a08e661</pre></td></tr><tr><td data-num=\"34\"></td><td><pre>e10059e8  000003f8&#96;00000000 00000000&#96;8a19b021</pre></td></tr><tr><td data-num=\"35\"></td><td><pre>kd&gt; dt _EPROCESS 89ee8020 &#x2F;&#x2F; 去掉低三位的属性</pre></td></tr><tr><td data-num=\"36\"></td><td><pre>nt!_EPROCESS</pre></td></tr><tr><td data-num=\"37\"></td><td><pre>   +0x000 Pcb              : _KPROCESS</pre></td></tr><tr><td data-num=\"38\"></td><td><pre>   ……</pre></td></tr><tr><td data-num=\"39\"></td><td><pre>   ……</pre></td></tr><tr><td data-num=\"40\"></td><td><pre>   +0x174 ImageFileName    : [16]  &quot;calc.exe&quot; &#x2F;&#x2F; 找到了</pre></td></tr><tr><td data-num=\"41\"></td><td><pre>   ……</pre></td></tr><tr><td data-num=\"42\"></td><td><pre>   ……</pre></td></tr></table></figure><h1 id=\"reference\"><a class=\"anchor\" href=\"#reference\">#</a> Reference</h1>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQxOTg4NDQ4L2FydGljbGUvZGV0YWlscy8xMDQ5NDUzMTE=\">https://blog.csdn.net/qq_41988448/article/details/104945311</span></p>\n<p>《Windows 内核原理与实现》</p>\n",
            "tags": [
                "进程句柄表",
                "全局句柄表"
            ]
        },
        {
            "id": "https://or0kit.github.io/Bin/Core/WindowsXp/Process-Thread/%E8%BF%9B%E7%A8%8B%E4%B8%8E%E7%BA%BF%E7%A8%8B-%E8%BF%9B%E7%A8%8B%E6%8C%82%E9%9D%A0%E5%92%8C%E8%B7%A8%E8%BF%9B%E7%A8%8B%E8%AF%BB%E5%86%99%E5%86%85%E5%AD%98/",
            "url": "https://or0kit.github.io/Bin/Core/WindowsXp/Process-Thread/%E8%BF%9B%E7%A8%8B%E4%B8%8E%E7%BA%BF%E7%A8%8B-%E8%BF%9B%E7%A8%8B%E6%8C%82%E9%9D%A0%E5%92%8C%E8%B7%A8%E8%BF%9B%E7%A8%8B%E8%AF%BB%E5%86%99%E5%86%85%E5%AD%98/",
            "title": "进程与线程-进程挂靠和跨进程读写内存",
            "date_published": "2022-01-23T16:55:34.000Z",
            "content_html": "<h1 id=\"楔子\"><a class=\"anchor\" href=\"#楔子\">#</a> 楔子</h1>\n<p>需要有 APC 的基础，学完句柄表和 APC 后再回来分析。</p>\n<p>额外小知识   <code>NUMA</code></p>\n<p>要点回顾：</p>\n<p>一个进程可以包含多个线程</p>\n<p>一个进程至少要有一个线程</p>\n<p>进程为线程提供资源，也就是提供 Cr3 的值，Cr3 中存储的是页目录表基址，Cr3 确定了，线程能访问的内存也就确定了。</p>\n<h1 id=\"进程挂靠\"><a class=\"anchor\" href=\"#进程挂靠\">#</a> 进程挂靠</h1>\n<p>首先要了解以下知识</p>\n<h2 id=\"进程与线程的关系\"><a class=\"anchor\" href=\"#进程与线程的关系\">#</a> 进程与线程的关系</h2>\n<p>线程代码：</p>\n<p>mov eax,dword ptr ds:[0x12345678]</p>\n<p>CPU 如何解析 0x12345678 这个地址呢？</p>\n<ol>\n<li>\n<p>CPU 解析线性地址时要通过页目录表来找对应的物理页，页目录表基址存在<br />\n Cr3 寄存器中。</p>\n</li>\n<li>\n<p>当前的 Cr3 的值来源于当前的进程 (_KPROCESS.DirectoryTableBase (+0x018))。</p>\n</li>\n</ol>\n<h2 id=\"线程与进程的关联\"><a class=\"anchor\" href=\"#线程与进程的关联\">#</a> 线程与进程的关联</h2>\n<p>线程是如何找到进程的呢？线程与进程是如何关联的呢？</p>\n<p>在线程的结构体中：</p>\n<figure class=\"highlight raw\"><figcaption data-lang=\"\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>+0x034 ApcState</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>\t\t+0x000 ApcListHead </pre></td></tr><tr><td data-num=\"3\"></td><td><pre>   \t\t+0x010 Process </pre></td></tr><tr><td data-num=\"4\"></td><td><pre>   \t\t+0x014 KernelApcInProgress</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>   \t\t+0x015 KernelApcPending</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>   \t\t+0x016 UserApcPending</pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>\t+0x220 ThreadsProcess</pre></td></tr></table></figure><p>有两处与进程相关的成员：  <code>Process</code>  与  <code>ThreadsProcess</code>  ，那么这两个成员与线程有什么关系呢？</p>\n<h2 id=\"0x044负责提供cr3\"><a class=\"anchor\" href=\"#0x044负责提供cr3\">#</a> 0x044 负责提供 Cr3</h2>\n<p>(分析 SwapContext 函数) 线程切换的时候，会比较_KTHREAD 结构体 0x044 处指定的 EPROCESS 是否为同一个，如果不是同一个，会将 0x044 处指定的 EPROCESS 的 DirectoryTableBase 的值取出，赋值给 Cr3。</p>\n<p>所以，线程需要的 Cr3 的值来源于 0x044 处偏移指定的 EPROCESS.</p>\n<p>可以得出以下结论：</p>\n<p>0x220 亲生父母：这个线程谁创建的<br />\n 0x044 养父母：谁在为这个线程提供资源 (也就是提供 Cr3)<br />\n 一般情况下，0x220 与 0x44 指向的是同一个进程</p>\n<p>那么 Cr3 的值可以随便改吗？</p>\n<h2 id=\"修改cr3的值\"><a class=\"anchor\" href=\"#修改cr3的值\">#</a> 修改 Cr3 的值</h2>\n<p>正常情况下，Cr3 的值是由养父母提供的，但 Cr3 的值也可以改成和当前线程毫不相干的其他进程的 DirectoryTableBase。</p>\n<p>线程代码：</p>\n<figure class=\"highlight raw\"><figcaption data-lang=\"\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>mov cr3,A.DirectoryTableBase</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>mov eax,dword ptr ds:[0x12345678]\t\t&#x2F;&#x2F;A 进程的 0x12345678 内存</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>mov cr3,B.DirectoryTableBase</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>mov eax,dword ptr ds:[0x12345678]\t\t&#x2F;&#x2F;B 进程的 0x12345678 内存</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>mov cr3,C.DirectoryTableBase</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>mov eax,dword ptr ds:[0x12345678]\t\t&#x2F;&#x2F;C 进程的 0x12345678 内存</pre></td></tr></table></figure><p>将当前 Cr3 的值改为其他进程，称为 “进程挂靠”。</p>\n<p>那可不可以只修改 Cr3 而不修改养父母？不可以，如果不修改养父母的值，一旦产生线程切换，就会变成自己读自己！</p>\n<p>如果我们自己来写这个代码，在切换 Cr3 后关闭中断，并且不调用会导致线程切换的 API，就可以不用修改养父母的值。</p>\n<h2 id=\"总结\"><a class=\"anchor\" href=\"#总结\">#</a> 总结</h2>\n<p>正常情况下，当前线程使用的 Cr3 是由其所属进程提供的 (ETHREAD 0x44 偏移处指定的 EPROCESS)，正是因为如此，A 进程中的线程只能访问 A 的内存。</p>\n<p>如果要让 A 进程中的线程能够访问 B 进程的内存，就必须要修改 Cr3 的值为 B 进程的页目录表基址 (B.DirectoryTableBase)，这就是所谓的 “进程挂靠”。</p>\n<h1 id=\"跨进程读写内存\"><a class=\"anchor\" href=\"#跨进程读写内存\">#</a> 跨进程读写内存</h1>\n<p>跨进程的本质是 “进程挂靠”，正常情况下，A 进程的线程只能访问 A 进程的地址空间，如果 A 进程的线程想访问 B 进程的地址空间，就要修改当前的 Cr3 的值为 B 进程的页目录表基值 (KPROCESS.DirectoryTableBase)。<br />\n即： <code>mov cr3,B.DirectoryTableBase</code></p>\n<h2 id=\"跨进程操作\"><a class=\"anchor\" href=\"#跨进程操作\">#</a> 跨进程操作</h2>\n<p>A 进制中的线程代码：</p>\n<figure class=\"highlight raw\"><figcaption data-lang=\"\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>mov cr3,B.DirectoryTableBase\t\t&#x2F;&#x2F; 切换 Cr3 的值为 B 进程</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>mov eax,dword ptr ds:[0x12345678]\t\t&#x2F;&#x2F; 将进程 B 0x12345678 的值存的 eax 中</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>mov dword ptr ds:[0x00401234],eax\t\t&#x2F;&#x2F; 将数据存储到 0x00401234 中</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>mov cr3,A.DirectoryTableBase\t\t&#x2F;&#x2F; 切换回 Cr3 的值</pre></td></tr></table></figure><p>此时  <code>0x00401234</code>  中的数据还有吗？如何将数据传递给 A 进程的变量呢？</p>\n<h2 id=\"ntreadvirtualmemory-流程解析\"><a class=\"anchor\" href=\"#ntreadvirtualmemory-流程解析\">#</a> NtReadVirtualMemory 流程解析</h2>\n<p>一些关键函数的声明为：</p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>NTSTATUS</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token function\">NtReadVirtualMemory</span> <span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>     IN HANDLE ProcessHandle<span class=\"token punctuation\">,</span> <span class=\"token comment\">// 为进程对象提供一个打开的句柄。</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>     IN PVOID BaseAddress<span class=\"token punctuation\">,</span><span class=\"token comment\">// 提供要读取的指定进程中的基址。</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>     OUT PVOID Buffer<span class=\"token punctuation\">,</span><span class=\"token comment\">// 提供缓冲区的地址，该缓冲区接收来自指定进程地址空间的内容。</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>     IN SIZE_T BufferSize<span class=\"token punctuation\">,</span><span class=\"token comment\">// 提供要从指定进程读取的请求字节数。</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>     OUT PSIZE_T NumberOfBytesRead OPTIONAL <span class=\"token comment\">// 接收传输到指定缓冲区的实际字节数。</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>     <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>NTSTATUS</pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token function\">MmCopyVirtualMemory</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    IN PEPROCESS FromProcess<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    IN CONST VOID <span class=\"token operator\">*</span>FromAddress<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    IN PEPROCESS ToProcess<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    OUT PVOID ToAddress<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    IN SIZE_T BufferSize<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    IN KPROCESSOR_MODE PreviousMode<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>    OUT PSIZE_T NumberOfBytesCopied</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>NTSTATUS</pre></td></tr><tr><td data-num=\"22\"></td><td><pre><span class=\"token function\">MiDoMappedCopy</span> <span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>     IN PEPROCESS FromProcess<span class=\"token punctuation\">,</span><span class=\"token comment\">// 为进程对象提供一个打开的句柄。</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>     IN CONST VOID <span class=\"token operator\">*</span>FromAddress<span class=\"token punctuation\">,</span><span class=\"token comment\">// 提供要读取的指定进程中的基址。</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>     IN PEPROCESS ToProcess<span class=\"token punctuation\">,</span><span class=\"token comment\">// 为进程对象提供一个打开的句柄。</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>     OUT PVOID ToAddress<span class=\"token punctuation\">,</span><span class=\"token comment\">// 提供缓冲区的地址，该缓冲区接收来自指定进程地址空间的内容。</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>     IN SIZE_T BufferSize<span class=\"token punctuation\">,</span><span class=\"token comment\">// 提供要从指定进程读取的请求字节数。</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>     IN KPROCESSOR_MODE PreviousMode<span class=\"token punctuation\">,</span><span class=\"token comment\">// 提供以前的处理器模式。</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>     OUT PSIZE_T NumberOfBytesRead<span class=\"token comment\">// 接收传输到指定缓冲区的实际字节数。</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>    <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>NTSTATUS</pre></td></tr><tr><td data-num=\"33\"></td><td><pre><span class=\"token function\">MiDoPoolCopy</span> <span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>     IN PEPROCESS FromProcess<span class=\"token punctuation\">,</span><span class=\"token comment\">// 为进程对象提供一个打开的句柄。</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>     IN CONST VOID <span class=\"token operator\">*</span>FromAddress<span class=\"token punctuation\">,</span><span class=\"token comment\">// 提供要读取的指定进程中的基址。</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>     IN PEPROCESS ToProcess<span class=\"token punctuation\">,</span><span class=\"token comment\">// 为进程对象提供一个打开的句柄。</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>     OUT PVOID ToAddress<span class=\"token punctuation\">,</span><span class=\"token comment\">// 提供缓冲区的地址，该缓冲区接收来自指定进程地址空间的内容。</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>     IN SIZE_T BufferSize<span class=\"token punctuation\">,</span><span class=\"token comment\">// 提供要从指定进程读取的请求字节数。</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>     IN KPROCESSOR_MODE PreviousMode<span class=\"token punctuation\">,</span><span class=\"token comment\">// 提供以前的处理器模式。</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>     OUT PSIZE_T NumberOfBytesRead<span class=\"token comment\">// 接收传输到指定缓冲区的实际字节数。</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>     <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre></pre></td></tr><tr><td data-num=\"43\"></td><td><pre><span class=\"token comment\">/*-- 这个函数将一个线程附加到目标进程的地址空间，并返回上一个附加进程前的 APC 状态信息。--*/</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>VOID</pre></td></tr><tr><td data-num=\"45\"></td><td><pre><span class=\"token function\">KeStackAttachProcess</span> <span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>    IN PRKPROCESS Process<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>    OUT PRKAPC_STATE ApcState</pre></td></tr><tr><td data-num=\"48\"></td><td><pre>    <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre><span class=\"token comment\">/*-- 这个函数将一个线程从另一个进程的地址空间中分离出来，并恢复之前的连接状态。--*/</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>VOID</pre></td></tr><tr><td data-num=\"51\"></td><td><pre><span class=\"token function\">KeUnstackDetachProcess</span> <span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre>    IN PRKAPC_STATE ApcState <span class=\"token comment\">// 提供一个指向 APC 状态结构的指针，该结构是由之前对堆栈附加进程的调用返回的。</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>    <span class=\"token punctuation\">)</span></pre></td></tr></table></figure><h3 id=\"逆向分析-ntreadvirtualmemory\"><a class=\"anchor\" href=\"#逆向分析-ntreadvirtualmemory\">#</a> 逆向分析 NtReadVirtualMemory</h3>\n<details class=\"primary\"><summary>NtReadVirtualMemory 逆向分析  （点击展开）</summary><div>\n<pre><code>; NTSTATUS __stdcall NtReadVirtualMemory(HANDLE ProcessHandle, PVOID BaseAddress, PVOID Buffer, SIZE_T NumberOfBytesToRead, PSIZE_T NumberOfBytesRead)\nPAGE:004DD2F6 _NtReadVirtualMemory@20 proc near       ; DATA XREF: .text:0042D858↑o\nPAGE:004DD2F6\nPAGE:004DD2F6 var_2C          = dword ptr -2Ch\nPAGE:004DD2F6 var_28          = dword ptr -28h\nPAGE:004DD2F6 Object          = dword ptr -24h\nPAGE:004DD2F6 AccessMode      = byte ptr -20h\nPAGE:004DD2F6 var_1C          = dword ptr -1Ch\nPAGE:004DD2F6 ms_exc          = CPPEH_RECORD ptr -18h\nPAGE:004DD2F6 ProcessHandle   = dword ptr  8\nPAGE:004DD2F6 BaseAddress     = dword ptr  0Ch\nPAGE:004DD2F6 Buffer          = dword ptr  10h\nPAGE:004DD2F6 NumberOfBytesToRead= dword ptr  14h\nPAGE:004DD2F6 NumberOfBytesRead= dword ptr  18h\nPAGE:004DD2F6\nPAGE:004DD2F6 ; __unwind &#123; // __SEH_prolog\nPAGE:004DD2F6                 push    1Ch\nPAGE:004DD2F8                 push    offset stru_402EF0\nPAGE:004DD2FD                 call    __SEH_prolog\nPAGE:004DD302                 mov     eax, large fs:124h ; eax = 当前的KTHREAD\nPAGE:004DD308                 mov     edi, eax        ; edi = eax\nPAGE:004DD30A                 mov     al, [edi+_KTHREAD.PreviousMode]\nPAGE:004DD310                 mov     [ebp+AccessMode], al\nPAGE:004DD313                 mov     esi, [ebp+NumberOfBytesToRead]\nPAGE:004DD316                 test    al, al          ; 如果不是内核模式 （KernelMode = 0） 则对参数做一系列的验证。\nPAGE:004DD318                 jz      short loc_4DD380\nPAGE:004DD31A                 mov     eax, [ebp+BaseAddress]\nPAGE:004DD31D                 lea     edx, [eax+esi]\nPAGE:004DD320                 cmp     edx, eax\nPAGE:004DD322                 jb      short loc_4DD379\nPAGE:004DD324                 mov     eax, [ebp+Buffer]\nPAGE:004DD327                 lea     ecx, [eax+esi]\nPAGE:004DD32A                 cmp     ecx, eax\nPAGE:004DD32C                 jb      short loc_4DD379\nPAGE:004DD32E                 mov     eax, _MmHighestUserAddress ; MmHighestUserAddress = 0x7FFEFFFF  最高的用户层地址\nPAGE:004DD333                 cmp     edx, eax\nPAGE:004DD335                 ja      short loc_4DD379\nPAGE:004DD337                 cmp     ecx, eax\nPAGE:004DD339                 ja      short loc_4DD379\nPAGE:004DD33B                 mov     ebx, [ebp+NumberOfBytesRead] ; 判断 NumberOfBytesRead 参数是否存在（是否为NULL）\nPAGE:004DD33B                                         ;\nPAGE:004DD33B                                         ; if(NumberOfBytesRead)（是否为NULL）&#123;\nPAGE:004DD33B                                         ;\nPAGE:004DD33B                                         ; ……………………\nPAGE:004DD33B                                         ; &#125;\nPAGE:004DD33B                                         ; 不为NULL 执行 jz 跳走\nPAGE:004DD33E                 test    ebx, ebx\nPAGE:004DD340                 jz      short loc_4DD383\nPAGE:004DD342                 and     [ebp+ms_exc.registration.TryLevel], 0\nPAGE:004DD346                 mov     eax, _MmUserProbeAddress ; _MmUserProbeAddress = 0x7FFF0000 保护页的起始地址\nPAGE:004DD34B                 cmp     ebx, eax\nPAGE:004DD34D                 jb      short loc_4DD355\nPAGE:004DD34F                 mov     dword ptr [eax], 0\nPAGE:004DD355\nPAGE:004DD355 loc_4DD355:                             ; CODE XREF: NtReadVirtualMemory(x,x,x,x,x)+57↑j\nPAGE:004DD355                 mov     eax, [ebx]\nPAGE:004DD357                 mov     [ebx], eax\nPAGE:004DD359                 or      [ebp+ms_exc.registration.TryLevel], 0FFFFFFFFh\nPAGE:004DD35D                 jmp     short loc_4DD383\nPAGE:004DD35F ; ---------------------------------------------------------------------------\nPAGE:004DD35F\nPAGE:004DD35F loc_4DD35F:                             ; DATA XREF: .text:stru_402EF0↑o\nPAGE:004DD35F                 mov     eax, [ebp+ms_exc.exc_ptr]\nPAGE:004DD362                 mov     eax, [eax]\nPAGE:004DD364                 mov     eax, [eax]\nPAGE:004DD366                 mov     [ebp+var_2C], eax\nPAGE:004DD369                 xor     eax, eax\nPAGE:004DD36B                 inc     eax\nPAGE:004DD36C                 retn\nPAGE:004DD36D ; ---------------------------------------------------------------------------\nPAGE:004DD36D\nPAGE:004DD36D loc_4DD36D:                             ; DATA XREF: .text:stru_402EF0↑o\nPAGE:004DD36D                 mov     esp, [ebp+ms_exc.old_esp]\nPAGE:004DD370                 or      [ebp+ms_exc.registration.TryLevel], 0FFFFFFFFh\nPAGE:004DD374                 mov     eax, [ebp+var_2C]\nPAGE:004DD377                 jmp     short loc_4DD3F2\nPAGE:004DD379 ; ---------------------------------------------------------------------------\nPAGE:004DD379\nPAGE:004DD379 loc_4DD379:                             ; CODE XREF: NtReadVirtualMemory(x,x,x,x,x)+2C↑j\nPAGE:004DD379                                         ; NtReadVirtualMemory(x,x,x,x,x)+36↑j ...\nPAGE:004DD379                 mov     eax, 0C0000005h\nPAGE:004DD37E                 jmp     short loc_4DD3F2\nPAGE:004DD380 ; ---------------------------------------------------------------------------\nPAGE:004DD380\nPAGE:004DD380 loc_4DD380:                             ; CODE XREF: NtReadVirtualMemory(x,x,x,x,x)+22↑j\nPAGE:004DD380                 mov     ebx, [ebp+NumberOfBytesRead] ; ebx = NumberOfBytesRead\nPAGE:004DD383\nPAGE:004DD383 loc_4DD383:                             ; CODE XREF: NtReadVirtualMemory(x,x,x,x,x)+4A↑j\nPAGE:004DD383                                         ; NtReadVirtualMemory(x,x,x,x,x)+67↑j\nPAGE:004DD383                 xor     eax, eax\nPAGE:004DD385                 mov     [ebp+var_28], eax ; [ebp+var_28] = 0\nPAGE:004DD388                 mov     [ebp+var_1C], eax\nPAGE:004DD38B                 cmp     esi, eax\nPAGE:004DD38D                 jz      short loc_4DD3D2 ; ebx = NumberOfBytesRead\nPAGE:004DD38F                 push    eax             ; HandleInformation\nPAGE:004DD390                 lea     eax, [ebp+Object] ; eax = [ebp+Object] 的地址\nPAGE:004DD390                                         ;\nPAGE:004DD390                                         ; 函数执行成功后[ebp+Object]会指向一个对象体。\nPAGE:004DD390                                         ; 此处返回的是 进程结构体 EPROCESS\nPAGE:004DD393                 push    eax             ; Object\nPAGE:004DD394                 push    dword ptr [ebp+AccessMode] ; AccessMode\nPAGE:004DD397                 push    _PsProcessType  ; ObjectType\nPAGE:004DD39D                 push    10h             ; DesiredAccess\nPAGE:004DD39F                 push    [ebp+ProcessHandle] ; Handle\nPAGE:004DD3A2                 call    _ObReferenceObjectByHandle@24 ; ObReferenceObjectByHandle(x,x,x,x,x,x)\nPAGE:004DD3A7                 mov     [ebp+var_1C], eax\nPAGE:004DD3AA                 test    eax, eax\nPAGE:004DD3AC                 jnz     short loc_4DD3D2 ; ebx = NumberOfBytesRead\nPAGE:004DD3AE                 lea     eax, [ebp+var_28] ; 取临时变量的地址\nPAGE:004DD3B1                 push    eax             ; 从右向左 压入第一个参数 其值是一个地址 。\nPAGE:004DD3B2                 push    dword ptr [ebp+AccessMode] ; 其值为 CPU的工作模式\nPAGE:004DD3B5                 push    esi             ; 压入 NumberOfBytesToRead 也就是从指定进程读取的请求字节数\nPAGE:004DD3B5                                         ;\nPAGE:004DD3B5                                         ; 注意区分 NumberOfBytesRead  和 NumberOfBytesToRead\nPAGE:004DD3B6                 push    [ebp+Buffer]    ; Address\nPAGE:004DD3B9                 push    [edi+_KTHREAD.ApcState.Process] ; 当前线程的进程KPROCESS\nPAGE:004DD3BC                 push    [ebp+BaseAddress] ; int\nPAGE:004DD3BF                 push    [ebp+Object]    ; 目标进程的KPROCESS\nPAGE:004DD3C2                 call    _MmCopyVirtualMemory@28 ; NTSTATUS\nPAGE:004DD3C2                                         ; MmCopyVirtualMemory(\nPAGE:004DD3C2                                         ;     IN PEPROCESS FromProcess,\nPAGE:004DD3C2                                         ;     IN CONST VOID *FromAddress,\nPAGE:004DD3C2                                         ;     IN PEPROCESS ToProcess,\nPAGE:004DD3C2                                         ;     OUT PVOID ToAddress,\nPAGE:004DD3C2                                         ;     IN SIZE_T BufferSize,\nPAGE:004DD3C2                                         ;     IN KPROCESSOR_MODE PreviousMode,\nPAGE:004DD3C2                                         ;     OUT PSIZE_T NumberOfBytesCopied\nPAGE:004DD3C2                                         ;     )\nPAGE:004DD3C7                 mov     [ebp+var_1C], eax ; 如果成功的话返回值为0 var_1C = 0\nPAGE:004DD3CA                 mov     ecx, [ebp+Object] ; Object\nPAGE:004DD3CD                 call    @ObfDereferenceObject@4 ; 这个例程减少指定对象的引用计数，如果计数变为0，则执行 任何(whatever) 清除操作。\nPAGE:004DD3D2\nPAGE:004DD3D2 loc_4DD3D2:                             ; CODE XREF: NtReadVirtualMemory(x,x,x,x,x)+97↑j\nPAGE:004DD3D2                                         ; NtReadVirtualMemory(x,x,x,x,x)+B6↑j\nPAGE:004DD3D2                 test    ebx, ebx        ; ebx = NumberOfBytesRead\nPAGE:004DD3D4                 jz      short loc_4DD3EF\nPAGE:004DD3D6                 mov     [ebp+ms_exc.registration.TryLevel], 1\nPAGE:004DD3DD                 mov     eax, [ebp+var_28] ; var_28 指向了 传输到指定缓冲区的实际字节数。\nPAGE:004DD3E0                 mov     [ebx], eax      ; 传输到指定缓冲区的实际字节数 赋给 NumberOfBytesRead\nPAGE:004DD3E2                 jmp     short loc_4DD3EB\nPAGE:004DD3E4 ; ---------------------------------------------------------------------------\nPAGE:004DD3E4\nPAGE:004DD3E4 loc_4DD3E4:                             ; DATA XREF: .text:stru_402EF0↑o\nPAGE:004DD3E4                 xor     eax, eax\nPAGE:004DD3E6                 inc     eax\nPAGE:004DD3E7                 retn\nPAGE:004DD3E8 ; ---------------------------------------------------------------------------\nPAGE:004DD3E8\nPAGE:004DD3E8 loc_4DD3E8:                             ; DATA XREF: .text:stru_402EF0↑o\nPAGE:004DD3E8                 mov     esp, [ebp+ms_exc.old_esp]\nPAGE:004DD3EB\nPAGE:004DD3EB loc_4DD3EB:                             ; CODE XREF: NtReadVirtualMemory(x,x,x,x,x)+EC↑j\nPAGE:004DD3EB                 or      [ebp+ms_exc.registration.TryLevel], 0FFFFFFFFh\nPAGE:004DD3EF\nPAGE:004DD3EF loc_4DD3EF:                             ; CODE XREF: NtReadVirtualMemory(x,x,x,x,x)+DE↑j\nPAGE:004DD3EF                 mov     eax, [ebp+var_1C] ; 一切正常执行的话 eax = 0 既宏定义 STATUS_SUCCESS\nPAGE:004DD3F2\nPAGE:004DD3F2 loc_4DD3F2:                             ; CODE XREF: NtReadVirtualMemory(x,x,x,x,x)+81↑j\nPAGE:004DD3F2                                         ; NtReadVirtualMemory(x,x,x,x,x)+88↑j\nPAGE:004DD3F2                 call    __SEH_epilog\nPAGE:004DD3F7                 retn    14h\nPAGE:004DD3F7 ; &#125; // starts at 4DD2F6\nPAGE:004DD3F7 _NtReadVirtualMemory@20 endp\nPAGE:004DD3F7\nPAGE:004DD3F7 ; ---------------------------------------------------------------------------\n</code></pre>\n</div></details>\n<p>主要调用了 MmCopyVirtualMemory 函数。</p>\n<h3 id=\"逆向分析-mmcopyvirtualmemory\"><a class=\"anchor\" href=\"#逆向分析-mmcopyvirtualmemory\">#</a> 逆向分析 MmCopyVirtualMemory</h3>\n<details class=\"primary\"><summary>MmCopyVirtualMemory (点击展开)</summary><div>\n<pre><code>; int __stdcall MmCopyVirtualMemory(PEX_RUNDOWN_REF FromProcess, int, PRKPROCESS, volatile void *Address, SIZE_T Length, KPROCESSOR_MODE AccessMode, int NumberOfBytesRead)\nPAGE:004DD258 _MmCopyVirtualMemory@28 proc near       ; CODE XREF: IopCheckHardErrorsDisabled(x)+73↑p\nPAGE:004DD258                                         ; LpcpCopyRequestData(x,x,x,x,x,x,x):loc_4CEE57↑p ...\nPAGE:004DD258\nPAGE:004DD258 FromProcess     = dword ptr  8\nPAGE:004DD258 FromAddress     = dword ptr  0Ch\nPAGE:004DD258 ToProcess       = dword ptr  10h\nPAGE:004DD258 Address         = dword ptr  14h\nPAGE:004DD258 Length          = dword ptr  18h\nPAGE:004DD258 AccessMode      = byte ptr  1Ch\nPAGE:004DD258 NumberOfBytesRead= dword ptr  20h\nPAGE:004DD258\nPAGE:004DD258                 mov     edi, edi\nPAGE:004DD25A                 push    ebp\nPAGE:004DD25B                 mov     ebp, esp\nPAGE:004DD25D                 cmp     [ebp+Length], 0 ; NumberOfBytesToRead 判断  从指定进程读取的请求字节数，是否为0\nPAGE:004DD261                 jnz     short loc_4DD26A\nPAGE:004DD263                 xor     eax, eax\nPAGE:004DD265                 jmp     loc_4DD2ED      ;  为 0 就直接返回了\nPAGE:004DD26A ; ---------------------------------------------------------------------------\nPAGE:004DD26A\nPAGE:004DD26A loc_4DD26A:                             ; CODE XREF: MmCopyVirtualMemory(x,x,x,x,x,x,x)+9↑j\nPAGE:004DD26A                 push    ebx\nPAGE:004DD26B                 mov     ebx, [ebp+FromProcess] ; ebx = 要读取的进程的 EPROCESS 结构体。\nPAGE:004DD26E                 mov     ecx, ebx\nPAGE:004DD270                 mov     eax, large fs:124h\nPAGE:004DD276                 cmp     ebx, [eax+_KTHREAD.ApcState.Process] ; 判断要读取的进程 是否是当前进程\nPAGE:004DD279                 jnz     short loc_4DD27E\nPAGE:004DD27B                 mov     ecx, [ebp+ToProcess]\nPAGE:004DD27E\nPAGE:004DD27E loc_4DD27E:                             ; CODE XREF: MmCopyVirtualMemory(x,x,x,x,x,x,x)+21↑j\nPAGE:004DD27E                 add     ecx, 80h ; '€'  ; 取 目标EPROCESS 的 RundownProtect 成员的值\nPAGE:004DD284                 mov     [ebp+FromProcess], ecx\nPAGE:004DD287                 call    @ExAcquireRundownProtection@4 ; 获得rundown保护\nPAGE:004DD28C                 test    al, al          ; 判断是否成功\nPAGE:004DD28E                 jnz     short loc_4DD297 ; 如果成功就跳走\nPAGE:004DD290                 mov     eax, 0C000010Ah ; 返回  STATUS_PROCESS_IS_TERMINATING\nPAGE:004DD295                 jmp     short loc_4DD2EC ; 如果失败，函数执行失败 返回\nPAGE:004DD297 ; ---------------------------------------------------------------------------\nPAGE:004DD297\nPAGE:004DD297 loc_4DD297:                             ; CODE XREF: MmCopyVirtualMemory(x,x,x,x,x,x,x)+36↑j\nPAGE:004DD297                 cmp     [ebp+Length], 1FFh ; 判读要读取的字节大小是否超过0x1FF\nPAGE:004DD29E                 push    esi\nPAGE:004DD29F                 push    edi\nPAGE:004DD2A0                 mov     edi, [ebp+NumberOfBytesRead] ; edi =  指向NumberOfBytesRead的地址\nPAGE:004DD2A0                                         ;\nPAGE:004DD2A0                                         ; 在 NtReadVirtualMemory  中传来的此值是一个地址。\nPAGE:004DD2A0                                         ; 应该是返回用的\nPAGE:004DD2A3                 jbe     short loc_4DD2C8 ; 小于等于则跳转\nPAGE:004DD2A5                 push    edi             ; 压入 指向NumberOfBytesRead的地址\nPAGE:004DD2A6                 push    dword ptr [ebp+AccessMode] ; AccessMode\nPAGE:004DD2A9                 push    [ebp+Length]    ; Length\nPAGE:004DD2AC                 push    [ebp+Address]   ; ToAddress\nPAGE:004DD2AF                 push    [ebp+ToProcess] ; ToProcess\nPAGE:004DD2B2                 push    [ebp+FromAddress] ; FromAddress\nPAGE:004DD2B5                 push    ebx             ; FromProcess\nPAGE:004DD2B6                 call    _MiDoMappedCopy@28 ; NTSTATUS\nPAGE:004DD2B6                                         ; MiDoMappedCopy (\nPAGE:004DD2B6                                         ;     IN PEPROCESS FromProcess,\nPAGE:004DD2B6                                         ;     IN CONST VOID *FromAddress,\nPAGE:004DD2B6                                         ;     IN PEPROCESS ToProcess,\nPAGE:004DD2B6                                         ;     OUT PVOID ToAddress,\nPAGE:004DD2B6                                         ;     IN SIZE_T BufferSize,\nPAGE:004DD2B6                                         ;     IN KPROCESSOR_MODE PreviousMode,\nPAGE:004DD2B6                                         ;     OUT PSIZE_T NumberOfBytesRead\nPAGE:004DD2B6                                         ;     )\nPAGE:004DD2BB                 mov     esi, eax\nPAGE:004DD2BD                 cmp     esi, 0C00000A1h\nPAGE:004DD2C3                 jnz     short loc_4DD2E0\nPAGE:004DD2C5                 and     dword ptr [edi], 0\nPAGE:004DD2C8\nPAGE:004DD2C8 loc_4DD2C8:                             ; CODE XREF: MmCopyVirtualMemory(x,x,x,x,x,x,x)+4B↑j\nPAGE:004DD2C8                 push    edi             ; 压入 指向NumberOfBytesRead的地址\nPAGE:004DD2C9                 push    dword ptr [ebp+AccessMode] ; AccessMode\nPAGE:004DD2CC                 push    [ebp+Length]    ; Length\nPAGE:004DD2CF                 push    [ebp+Address]   ; ToAddress\nPAGE:004DD2D2                 push    [ebp+ToProcess] ; ToProcess\nPAGE:004DD2D5                 push    [ebp+FromAddress] ; FromAddress\nPAGE:004DD2D8                 push    ebx             ; FromProcess\nPAGE:004DD2D9                 call    _MiDoPoolCopy@28 ; NTSTATUS\nPAGE:004DD2D9                                         ; MiDoPoolCopy (\nPAGE:004DD2D9                                         ;      IN PEPROCESS FromProcess,\nPAGE:004DD2D9                                         ;      IN CONST VOID *FromAddress,\nPAGE:004DD2D9                                         ;      IN PEPROCESS ToProcess,\nPAGE:004DD2D9                                         ;      OUT PVOID ToAddress,\nPAGE:004DD2D9                                         ;      IN SIZE_T BufferSize,\nPAGE:004DD2D9                                         ;      IN KPROCESSOR_MODE PreviousMode,\nPAGE:004DD2D9                                         ;      OUT PSIZE_T NumberOfBytesRead\nPAGE:004DD2D9                                         ;      )\nPAGE:004DD2DE                 mov     esi, eax\nPAGE:004DD2E0\nPAGE:004DD2E0 loc_4DD2E0:                             ; CODE XREF: MmCopyVirtualMemory(x,x,x,x,x,x,x)+6B↑j\nPAGE:004DD2E0                 mov     ecx, [ebp+FromProcess] ; RunRef\nPAGE:004DD2E3                 call    @ExReleaseRundownProtection@4 ; ExReleaseRundownProtection(x)\nPAGE:004DD2E8                 pop     edi\nPAGE:004DD2E9                 mov     eax, esi\nPAGE:004DD2EB                 pop     esi\nPAGE:004DD2EC\nPAGE:004DD2EC loc_4DD2EC:                             ; CODE XREF: MmCopyVirtualMemory(x,x,x,x,x,x,x)+3D↑j\nPAGE:004DD2EC                 pop     ebx\nPAGE:004DD2ED\nPAGE:004DD2ED loc_4DD2ED:                             ; CODE XREF: MmCopyVirtualMemory(x,x,x,x,x,x,x)+D↑j\nPAGE:004DD2ED                 pop     ebp\nPAGE:004DD2EE                 retn    1Ch\nPAGE:004DD2EE _MmCopyVirtualMemory@28 endp\n</code></pre>\n</div></details>\n<p>这个函数会  <code>cmp     [ebp+Length], 1FFh </code> ; 判读要读取的字节大小是否超过 0x1FF，如果没有超过就会调用  <code>_MiDoPoolCopy</code>  函数，超过的话就会调用  <code>_MiDoMappedCopy</code> 。</p>\n<p><code>_MiDoMappedCopy</code>  有些地方没逆懂，但关键地方都一样。详细看  <code>_MiDoPoolCopy</code>  了。</p>\n<h3 id=\"逆向分析-_midopoolcopy\"><a class=\"anchor\" href=\"#逆向分析-_midopoolcopy\">#</a> 逆向分析 _MiDoPoolCopy</h3>\n<details class=\"primary\"><summary>_MiDoPoolCopy (点击展开)</summary><div>\n<p><img data-src=\"image004.png\" alt=\"\" /></p>\n</div></details>\n<h3 id=\"逆向分析-kestackattachprocess\"><a class=\"anchor\" href=\"#逆向分析-kestackattachprocess\">#</a> 逆向分析 KeStackAttachProcess</h3>\n<details class=\"primary\"><summary>KeStackAttachProcess (点击展开)</summary><div>\n<p><img data-src=\"image003.png\" alt=\"\" /></p>\n</div></details>\n<h3 id=\"逆向分析-kiattachprocess\"><a class=\"anchor\" href=\"#逆向分析-kiattachprocess\">#</a> 逆向分析 KiAttachProcess</h3>\n<details class=\"primary\"><summary>KiAttachProcess (点击展开)</summary><div>\n<p><img data-src=\"image002.png\" alt=\"\" /></p>\n</div></details>\n<h3 id=\"逆向分析-kiswapprocess\"><a class=\"anchor\" href=\"#逆向分析-kiswapprocess\">#</a> 逆向分析 KiSwapProcess</h3>\n<details class=\"primary\"><summary>KiSwapProcess (点击展开)</summary><div>\n<p><img data-src=\"image001.png\" alt=\"\" /></p>\n</div></details>\n<h3 id=\"函数调用流程中的各个函数总结\"><a class=\"anchor\" href=\"#函数调用流程中的各个函数总结\">#</a> 函数调用流程中的各个函数总结</h3>\n<details class=\"info\"><summary>NtReadVirtualMemory实现路径 (点击展开)</summary><div>\n<ol>\n<li>\n<p><code>NtReadVirtualMemory</code>  做了一些验证后调用了  <code>MmCopyVirtualMemory</code></p>\n</li>\n<li>\n<p><code>MmCopyVirtualMemory</code>  在这个函数中判断了缓冲区的大小，如果缓冲区大小大于池移动阈值，则尝试通过直接映射写入内存。这里根据情况调用  <code>MiDoMappedCopy</code>  和  <code>MiDoPoolCopy</code> 。</p>\n</li>\n<li>\n<p><code>MiDoMappedCopy</code>  函数有很多结构体还没学，暂时逆不懂，先逆  <code>MiDoPoolCopy</code>  了。  <code>MiDoPoolCopy</code>  函数在读取内存的方法是先在内核层申请一份和要读取的字节大小一样的内存，然后调用了  <code>KeStackAttachProcess</code>  函数。</p>\n<ul>\n<li>这里先说  <code>KeStackAttachProcess</code>  函数了，这个函数首先判断了要附加的进程是不是当前进程，然后又判断当前线程是不是已经处于挂靠状态了，如果处于挂靠状态的话，把原来的 APC 状态保存到 ApcState 变量中，否则的话就把原来的 APC 状态保存到线程结构体的 KTHREAD 的  <code>SavedApcState</code>  成员中。  这里是判断之后调用  <code>KiAttachProcess </code> 函数时传递的参数不一样来实现的。</li>\n</ul>\n<p>如下：</p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>Thread<span class=\"token operator\">-></span>ApcStateIndex <span class=\"token operator\">!=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span><span class=\"token comment\">// 已经处于挂靠状态</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>            <span class=\"token function\">KiAttachProcess</span><span class=\"token punctuation\">(</span>Thread<span class=\"token punctuation\">,</span> Process<span class=\"token punctuation\">,</span> OldIrql<span class=\"token punctuation\">,</span> ApcState<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// 会把原来的 APC 状态赋给 ApcState 变量，是上层函数返回的变量。</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">&#123;</span> <span class=\"token comment\">// 没有处于挂靠状态</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>            <span class=\"token function\">KiAttachProcess</span><span class=\"token punctuation\">(</span>Thread<span class=\"token punctuation\">,</span> Process<span class=\"token punctuation\">,</span> OldIrql<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>Thread<span class=\"token operator\">-></span>SavedApcState<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><span class=\"token comment\">// 传递当前线程的 SavedApcState，用它来接收以前的 APC 状态。</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>            ApcState<span class=\"token operator\">-></span>Process <span class=\"token operator\">=</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// 标识一下，在 KeStackAttachProcess 中会判断</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><ul>\n<li>\n<p>在 <code>KiAttachProcess </code> 函数中，先把当前线程 KTEHREAD 的 ApcState 成员保存了一份赋值给了一个指针变量 ，这个指针变量是这个函数的参数，如果线程已将处于挂靠状态，那么这个指针变量就是上层函数的临时变量，如果没有处于挂靠状态那么这个指针变量就是当前线程 KTHREAD 的 <code>SavedApcState</code>  成员。<br />\n然后把当前线程 KTHREAD 的  <code>ApcState</code>  保存到了这个指针变量中，<strong>这一步既保存了没挂靠前的 APC 状态</strong>，之后初始化新的线程 KTHREAD 的  <code>ApcState</code>  成员。<br />\n然后判断目标进程的状态是否在内存中，如果在内存中，就把所有处于 ready 状态的线程，移动到全局就绪链表中，然后调用了  <code>KiSwapProcess</code>  函数后就返回了。<br />\n如果进程的状态不是在内存中，则判断其状态是不是 ProcessOutOfMemory 既不在内存中，如果是则设置其状态为正在转移，然后把进程 KPROCESS 的  <code>SwapListEntry</code>  成员挂入到  <code>KiProcessInSwapListHead</code>  中。<br />\n<strong> <code>SwapListEntry</code>  成员在《Windows 内核原理与实现》一书中有介绍：  <code>KiProcessInSwapListHead</code>  这是等待被插入的进程链表，它是一个单链表。当一个进程要被换出内存时，通过此成员加入到以  <code>KiProcessOutSwapListHead</code>  为链头的单链表中；当一个进程要被换入内存时，通过此成员加入到以  <code>KiProcessInSwapListHead</code>  为链头的单链表中。</strong><br />\n如果状态不是 ProcessOutOfMemory 的话，会直接执行这一步： 清除前一个进程中的活动处理器位，并设置被附加进程中的活动处理器位。<br />\n绕后调用了  <code>KiSwapThread</code>  函数</p>\n<ul>\n<li>调用  <code>KiSwapProcess</code>  函数：这个函数主要更新了 GDT 中的 LDT 描述符和 IDT 中的 int 2h, 并交换 CR3 来将地址空间交换到另一个进程。 它还将 I/O 权限映射交换到新进程。</li>\n<li>调用  <code>KiSwapThread</code> ，主动调用线程切换，既把目标进程的线程激活，使其在内存中，直到线程切换切回来，因为 APC 的状态已经更换成了目标进程，而 Cr3 是取线程的 APC 状态中的进程 KPROCESS 中的  <code>DirectoryTableBase</code>  成员， 所以切换回来后，线程的 Cr3 也就改了，至此挂靠完成了。真是巧妙呀。</li>\n</ul>\n</li>\n</ul>\n</li>\n<li>\n<p>挂靠后又回到了  <code>MiDoPoolCopy</code>  函数中，然后就开始复制内存了，把目标进程空间的内存，复制到了内核空间。然后调用了  <code>KeUnstackDetachProcess</code>  解除了挂靠状态， <code>KeUnstackDetachProcess</code>  最终也是调用了  <code>KiSwapProcess</code>  函数不在细说了。解除挂靠后又挂靠了回了原来的自己的进程，然后把在内核空间的内存数据复制到了，原来线程空间指定的缓存区中，然后就解除挂靠了，之后又释放了在内核空间申请的内存空间，统计了一下复制了多少字节数后返回了。</p>\n</li>\n</ol>\n</div></details>\n<h2 id=\"ntwritevirtualmemory-流程分析\"><a class=\"anchor\" href=\"#ntwritevirtualmemory-流程分析\">#</a> NtWriteVirtualMemory 流程分析</h2>\n<p>此函数的调用流程与  <code>NtReadVirtualMemory</code>  一样。</p>\n<p>NtReadVirtualMemory -&gt; MmCopyVirtualMemory -&gt; MiDoMappedCopy 或者 MiDoPoolCopy</p>\n<details class=\"info\"><summary>（点击展开）</summary><div>\n<figure class=\"highlight raw\"><figcaption data-lang=\"\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>PAGE:004DD400 ; NTSTATUS __stdcall NtWriteVirtualMemory (HANDLE ProcessHandle, PVOID BaseAddress, PVOID Buffer, SIZE_T NumberOfBytesToWrite, PSIZE_T NumberOfBytesWritten)</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>PAGE:004DD400 _NtWriteVirtualMemory@20 proc near      ; DATA XREF: .text:0042D9C4↑o</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>PAGE:004DD400</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>PAGE:004DD400 var_2C          &#x3D; dword ptr -2Ch</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>PAGE:004DD400 NumberOfBytesRead&#x3D; dword ptr -28h</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>PAGE:004DD400 Object          &#x3D; dword ptr -24h</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>PAGE:004DD400 AccessMode      &#x3D; byte ptr -20h</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>PAGE:004DD400 Status          &#x3D; dword ptr -1Ch</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>PAGE:004DD400 ms_exc          &#x3D; CPPEH_RECORD ptr -18h</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>PAGE:004DD400 ProcessHandle   &#x3D; dword ptr  8</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>PAGE:004DD400 BaseAddress     &#x3D; dword ptr  0Ch</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>PAGE:004DD400 Buffer          &#x3D; dword ptr  10h</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>PAGE:004DD400 NumberOfBytesToWrite&#x3D; dword ptr  14h</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>PAGE:004DD400 NumberOfBytesWritten&#x3D; dword ptr  18h</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>PAGE:004DD400</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>PAGE:004DD400 ; __unwind &#123; &#x2F;&#x2F;__SEH_prolog</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>PAGE:004DD400                 push    1Ch</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>PAGE:004DD402                 push    offset stru_402F08</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>PAGE:004DD407                 call    __SEH_prolog</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>PAGE:004DD40C                 mov     eax, large fs:124h</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>PAGE:004DD412                 mov     edi, eax        ; edi &#x3D; 当先线程的 KTHREAD</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>PAGE:004DD414                 mov     al, [edi+_KTHREAD.PreviousMode]</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>PAGE:004DD41A                 mov     [ebp+AccessMode], al</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>PAGE:004DD41D                 mov     esi, [ebp+NumberOfBytesToWrite] ; esi &#x3D; NumberOfBytesToWrite</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>PAGE:004DD420                 test    al, al          ; 与操作 判断 al 是否等于 0，既当前模式是否是内核模式</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>PAGE:004DD422                 jz      short loc_4DD48A</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>PAGE:004DD424                 mov     eax, [ebp+BaseAddress]</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>PAGE:004DD427                 lea     edx, [eax+esi]  ; edx &#x3D; BaseAddress + NuberOfBytesToWrite</pre></td></tr><tr><td data-num=\"29\"></td><td><pre>PAGE:004DD42A                 cmp     edx, eax</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>PAGE:004DD42C                 jb      short loc_4DD483</pre></td></tr><tr><td data-num=\"31\"></td><td><pre>PAGE:004DD42E                 mov     eax, [ebp+Buffer]</pre></td></tr><tr><td data-num=\"32\"></td><td><pre>PAGE:004DD431                 lea     ecx, [eax+esi]</pre></td></tr><tr><td data-num=\"33\"></td><td><pre>PAGE:004DD434                 cmp     ecx, eax</pre></td></tr><tr><td data-num=\"34\"></td><td><pre>PAGE:004DD436                 jb      short loc_4DD483</pre></td></tr><tr><td data-num=\"35\"></td><td><pre>PAGE:004DD438                 mov     eax, _MmHighestUserAddress</pre></td></tr><tr><td data-num=\"36\"></td><td><pre>PAGE:004DD43D                 cmp     edx, eax</pre></td></tr><tr><td data-num=\"37\"></td><td><pre>PAGE:004DD43F                 ja      short loc_4DD483</pre></td></tr><tr><td data-num=\"38\"></td><td><pre>PAGE:004DD441                 cmp     ecx, eax</pre></td></tr><tr><td data-num=\"39\"></td><td><pre>PAGE:004DD443                 ja      short loc_4DD483 ; if ( (BaseAddress + NuberOfBytesToWrite &gt; BaseAddress) ||</pre></td></tr><tr><td data-num=\"40\"></td><td><pre>PAGE:004DD443                                         ; (Buffer + NuberOfBytesToWrite &gt; Buffer) ||</pre></td></tr><tr><td data-num=\"41\"></td><td><pre>PAGE:004DD443                                         ; (BaseAddress + NuberOfBytesToWrite) &gt; MM_HIGHEST_USER_ADDRESS) ||</pre></td></tr><tr><td data-num=\"42\"></td><td><pre>PAGE:004DD443                                         ; (Buffer + NuberOfBytesToWrite) &gt; MM_HIGHEST_USER_ADDRESS))</pre></td></tr><tr><td data-num=\"43\"></td><td><pre>PAGE:004DD443                                         ;</pre></td></tr><tr><td data-num=\"44\"></td><td><pre>PAGE:004DD443                                         ; )&#123;</pre></td></tr><tr><td data-num=\"45\"></td><td><pre>PAGE:004DD443                                         ;    return ……</pre></td></tr><tr><td data-num=\"46\"></td><td><pre>PAGE:004DD443                                         ; &#125;</pre></td></tr><tr><td data-num=\"47\"></td><td><pre>PAGE:004DD445                 mov     ebx, [ebp+NumberOfBytesWritten]</pre></td></tr><tr><td data-num=\"48\"></td><td><pre>PAGE:004DD448                 test    ebx, ebx        ; 判断 NumberOfBytesWritten 是否为 空 因为是可选参数</pre></td></tr><tr><td data-num=\"49\"></td><td><pre>PAGE:004DD44A                 jz      short loc_4DD48D ; 如果为空就跳转</pre></td></tr><tr><td data-num=\"50\"></td><td><pre>PAGE:004DD44C                 and     [ebp+ms_exc.registration.TryLevel], 0</pre></td></tr><tr><td data-num=\"51\"></td><td><pre>PAGE:004DD450                 mov     eax, _MmUserProbeAddress ; _MmUserProbeAddress &#x3D; 0x7FFF0000 保护页的起始地址</pre></td></tr><tr><td data-num=\"52\"></td><td><pre>PAGE:004DD455                 cmp     ebx, eax        ; 比较一下</pre></td></tr><tr><td data-num=\"53\"></td><td><pre>PAGE:004DD457                 jb      short loc_4DD45F ; 小于就跳转</pre></td></tr><tr><td data-num=\"54\"></td><td><pre>PAGE:004DD459                 mov     dword ptr [eax], 0</pre></td></tr><tr><td data-num=\"55\"></td><td><pre>PAGE:004DD45F</pre></td></tr><tr><td data-num=\"56\"></td><td><pre>PAGE:004DD45F loc_4DD45F:                             ; CODE XREF: NtWriteVirtualMemory (x,x,x,x,x)+57↑j</pre></td></tr><tr><td data-num=\"57\"></td><td><pre>PAGE:004DD45F                 mov     eax, [ebx]      ; 判读一下这个值是否可读可写</pre></td></tr><tr><td data-num=\"58\"></td><td><pre>PAGE:004DD461                 mov     [ebx], eax      ; ProbeForWriteUlong_ptr (Address) &#123;</pre></td></tr><tr><td data-num=\"59\"></td><td><pre>PAGE:004DD461                                         ;     if ((Address) &gt;&#x3D; (ULONG_PTR * const) MM_USER_PROBE_ADDRESS) &#123;</pre></td></tr><tr><td data-num=\"60\"></td><td><pre>PAGE:004DD461                                         ;         *(volatile ULONG_PTR * const) MM_USER_PROBE_ADDRESS &#x3D; 0;</pre></td></tr><tr><td data-num=\"61\"></td><td><pre>PAGE:004DD461                                         ;     &#125;</pre></td></tr><tr><td data-num=\"62\"></td><td><pre>PAGE:004DD461                                         ;</pre></td></tr><tr><td data-num=\"63\"></td><td><pre>PAGE:004DD461                                         ;     *(volatile ULONG_PTR *)(Address) &#x3D; *(volatile ULONG_PTR *)(Address);</pre></td></tr><tr><td data-num=\"64\"></td><td><pre>PAGE:004DD461                                         ; &#125;</pre></td></tr><tr><td data-num=\"65\"></td><td><pre>PAGE:004DD463                 or      [ebp+ms_exc.registration.TryLevel], 0FFFFFFFFh</pre></td></tr><tr><td data-num=\"66\"></td><td><pre>PAGE:004DD467                 jmp     short loc_4DD48D</pre></td></tr><tr><td data-num=\"67\"></td><td><pre>PAGE:004DD469 ; ---------------------------------------------------------------------------</pre></td></tr><tr><td data-num=\"68\"></td><td><pre>PAGE:004DD469</pre></td></tr><tr><td data-num=\"69\"></td><td><pre>PAGE:004DD469 loc_4DD469:                             ; DATA XREF: .text:stru_402F08↑o</pre></td></tr><tr><td data-num=\"70\"></td><td><pre>PAGE:004DD469                 mov     eax, [ebp+ms_exc.exc_ptr]</pre></td></tr><tr><td data-num=\"71\"></td><td><pre>PAGE:004DD46C                 mov     eax, [eax]</pre></td></tr><tr><td data-num=\"72\"></td><td><pre>PAGE:004DD46E                 mov     eax, [eax]</pre></td></tr><tr><td data-num=\"73\"></td><td><pre>PAGE:004DD470                 mov     [ebp+var_2C], eax</pre></td></tr><tr><td data-num=\"74\"></td><td><pre>PAGE:004DD473                 xor     eax, eax</pre></td></tr><tr><td data-num=\"75\"></td><td><pre>PAGE:004DD475                 inc     eax</pre></td></tr><tr><td data-num=\"76\"></td><td><pre>PAGE:004DD476                 retn</pre></td></tr><tr><td data-num=\"77\"></td><td><pre>PAGE:004DD477 ; ---------------------------------------------------------------------------</pre></td></tr><tr><td data-num=\"78\"></td><td><pre>PAGE:004DD477</pre></td></tr><tr><td data-num=\"79\"></td><td><pre>PAGE:004DD477 loc_4DD477:                             ; DATA XREF: .text:stru_402F08↑o</pre></td></tr><tr><td data-num=\"80\"></td><td><pre>PAGE:004DD477                 mov     esp, [ebp+ms_exc.old_esp]</pre></td></tr><tr><td data-num=\"81\"></td><td><pre>PAGE:004DD47A                 or      [ebp+ms_exc.registration.TryLevel], 0FFFFFFFFh</pre></td></tr><tr><td data-num=\"82\"></td><td><pre>PAGE:004DD47E                 mov     eax, [ebp+var_2C]</pre></td></tr><tr><td data-num=\"83\"></td><td><pre>PAGE:004DD481                 jmp     short loc_4DD4FC</pre></td></tr><tr><td data-num=\"84\"></td><td><pre>PAGE:004DD483 ; ---------------------------------------------------------------------------</pre></td></tr><tr><td data-num=\"85\"></td><td><pre>PAGE:004DD483</pre></td></tr><tr><td data-num=\"86\"></td><td><pre>PAGE:004DD483 loc_4DD483:                             ; CODE XREF: NtWriteVirtualMemory (x,x,x,x,x)+2C↑j</pre></td></tr><tr><td data-num=\"87\"></td><td><pre>PAGE:004DD483                                         ; NtWriteVirtualMemory (x,x,x,x,x)+36↑j ...</pre></td></tr><tr><td data-num=\"88\"></td><td><pre>PAGE:004DD483                 mov     eax, 0C0000005h</pre></td></tr><tr><td data-num=\"89\"></td><td><pre>PAGE:004DD488                 jmp     short loc_4DD4FC</pre></td></tr><tr><td data-num=\"90\"></td><td><pre>PAGE:004DD48A ; ---------------------------------------------------------------------------</pre></td></tr><tr><td data-num=\"91\"></td><td><pre>PAGE:004DD48A</pre></td></tr><tr><td data-num=\"92\"></td><td><pre>PAGE:004DD48A loc_4DD48A:                             ; CODE XREF: NtWriteVirtualMemory (x,x,x,x,x)+22↑j</pre></td></tr><tr><td data-num=\"93\"></td><td><pre>PAGE:004DD48A                 mov     ebx, [ebp+NumberOfBytesWritten]</pre></td></tr><tr><td data-num=\"94\"></td><td><pre>PAGE:004DD48D</pre></td></tr><tr><td data-num=\"95\"></td><td><pre>PAGE:004DD48D loc_4DD48D:                             ; CODE XREF: NtWriteVirtualMemory (x,x,x,x,x)+4A↑j</pre></td></tr><tr><td data-num=\"96\"></td><td><pre>PAGE:004DD48D                                         ; NtWriteVirtualMemory (x,x,x,x,x)+67↑j</pre></td></tr><tr><td data-num=\"97\"></td><td><pre>PAGE:004DD48D                 xor     eax, eax</pre></td></tr><tr><td data-num=\"98\"></td><td><pre>PAGE:004DD48F                 mov     [ebp+NumberOfBytesRead], eax ; NumberOfBytesRead &#x3D; 0</pre></td></tr><tr><td data-num=\"99\"></td><td><pre>PAGE:004DD492                 mov     [ebp+Status], eax</pre></td></tr><tr><td data-num=\"100\"></td><td><pre>PAGE:004DD495                 cmp     esi, eax        ; esi &#x3D; NumberOfBytesToWrite</pre></td></tr><tr><td data-num=\"101\"></td><td><pre>PAGE:004DD495                                         ; 判断要写入的字节数是否为 0</pre></td></tr><tr><td data-num=\"102\"></td><td><pre>PAGE:004DD497                 jz      short loc_4DD4DC</pre></td></tr><tr><td data-num=\"103\"></td><td><pre>PAGE:004DD499                 push    eax             ; HandleInformation</pre></td></tr><tr><td data-num=\"104\"></td><td><pre>PAGE:004DD49A                 lea     eax, [ebp+Object]</pre></td></tr><tr><td data-num=\"105\"></td><td><pre>PAGE:004DD49D                 push    eax             ; Object</pre></td></tr><tr><td data-num=\"106\"></td><td><pre>PAGE:004DD49E                 push    dword ptr [ebp+AccessMode] ; AccessMode</pre></td></tr><tr><td data-num=\"107\"></td><td><pre>PAGE:004DD4A1                 push    _PsProcessType  ; ObjectType</pre></td></tr><tr><td data-num=\"108\"></td><td><pre>PAGE:004DD4A7                 push    20h ; &#39; &#39;       ; DesiredAccess</pre></td></tr><tr><td data-num=\"109\"></td><td><pre>PAGE:004DD4A9                 push    [ebp+ProcessHandle] ; Handle</pre></td></tr><tr><td data-num=\"110\"></td><td><pre>PAGE:004DD4AC                 call    _ObReferenceObjectByHandle@24 ; ObReferenceObjectByHandle (x,x,x,x,x,x)</pre></td></tr><tr><td data-num=\"111\"></td><td><pre>PAGE:004DD4B1                 mov     [ebp+Status], eax ; Status &#x3D; ObReferenceObjectByHandle (ProcessHandle,</pre></td></tr><tr><td data-num=\"112\"></td><td><pre>PAGE:004DD4B1                                         ;                                            PROCESS_VM_WRITE,</pre></td></tr><tr><td data-num=\"113\"></td><td><pre>PAGE:004DD4B1                                         ;                                            PsProcessType,</pre></td></tr><tr><td data-num=\"114\"></td><td><pre>PAGE:004DD4B1                                         ;                                            PreviousMode,</pre></td></tr><tr><td data-num=\"115\"></td><td><pre>PAGE:004DD4B1                                         ;                                            (PVOID *)&amp;Process,</pre></td></tr><tr><td data-num=\"116\"></td><td><pre>PAGE:004DD4B1                                         ;                                            NULL);</pre></td></tr><tr><td data-num=\"117\"></td><td><pre>PAGE:004DD4B4                 test    eax, eax        ; 判断是否执行成功</pre></td></tr><tr><td data-num=\"118\"></td><td><pre>PAGE:004DD4B6                 jnz     short loc_4DD4DC</pre></td></tr><tr><td data-num=\"119\"></td><td><pre>PAGE:004DD4B8                 lea     eax, [ebp+NumberOfBytesRead]</pre></td></tr><tr><td data-num=\"120\"></td><td><pre>PAGE:004DD4BB                 push    eax             ; NumberOfBytesRead</pre></td></tr><tr><td data-num=\"121\"></td><td><pre>PAGE:004DD4BC                 push    dword ptr [ebp+AccessMode] ; AccessMode</pre></td></tr><tr><td data-num=\"122\"></td><td><pre>PAGE:004DD4BF                 push    esi             ; Length</pre></td></tr><tr><td data-num=\"123\"></td><td><pre>PAGE:004DD4C0                 push    [ebp+BaseAddress] ; Address</pre></td></tr><tr><td data-num=\"124\"></td><td><pre>PAGE:004DD4C3                 push    [ebp+Object]    ; 目标进程 KPROCESS</pre></td></tr><tr><td data-num=\"125\"></td><td><pre>PAGE:004DD4C6                 push    [ebp+Buffer]    ; int</pre></td></tr><tr><td data-num=\"126\"></td><td><pre>PAGE:004DD4C9                 push    [edi+_KTHREAD.ApcState.Process] ; 当前线程的进程 KPROCESS</pre></td></tr><tr><td data-num=\"127\"></td><td><pre>PAGE:004DD4CC                 call    _MmCopyVirtualMemory@28 ; NTSTATUS</pre></td></tr><tr><td data-num=\"128\"></td><td><pre>PAGE:004DD4CC                                         ; MmCopyVirtualMemory (</pre></td></tr><tr><td data-num=\"129\"></td><td><pre>PAGE:004DD4CC                                         ;     IN PEPROCESS FromProcess,</pre></td></tr><tr><td data-num=\"130\"></td><td><pre>PAGE:004DD4CC                                         ;     IN CONST VOID *FromAddress,</pre></td></tr><tr><td data-num=\"131\"></td><td><pre>PAGE:004DD4CC                                         ;     IN PEPROCESS ToProcess,</pre></td></tr><tr><td data-num=\"132\"></td><td><pre>PAGE:004DD4CC                                         ;     OUT PVOID ToAddress,</pre></td></tr><tr><td data-num=\"133\"></td><td><pre>PAGE:004DD4CC                                         ;     IN SIZE_T BufferSize,</pre></td></tr><tr><td data-num=\"134\"></td><td><pre>PAGE:004DD4CC                                         ;     IN KPROCESSOR_MODE PreviousMode,</pre></td></tr><tr><td data-num=\"135\"></td><td><pre>PAGE:004DD4CC                                         ;     OUT PSIZE_T NumberOfBytesCopied</pre></td></tr><tr><td data-num=\"136\"></td><td><pre>PAGE:004DD4CC                                         ;     )</pre></td></tr><tr><td data-num=\"137\"></td><td><pre>PAGE:004DD4D1                 mov     [ebp+Status], eax</pre></td></tr><tr><td data-num=\"138\"></td><td><pre>PAGE:004DD4D4                 mov     ecx, [ebp+Object] ; Object</pre></td></tr><tr><td data-num=\"139\"></td><td><pre>PAGE:004DD4D7                 call    @ObfDereferenceObject@4 ; ObfDereferenceObject (x)</pre></td></tr><tr><td data-num=\"140\"></td><td><pre>PAGE:004DD4DC</pre></td></tr><tr><td data-num=\"141\"></td><td><pre>PAGE:004DD4DC loc_4DD4DC:                             ; CODE XREF: NtWriteVirtualMemory (x,x,x,x,x)+97↑j</pre></td></tr><tr><td data-num=\"142\"></td><td><pre>PAGE:004DD4DC                                         ; NtWriteVirtualMemory (x,x,x,x,x)+B6↑j</pre></td></tr><tr><td data-num=\"143\"></td><td><pre>PAGE:004DD4DC                 test    ebx, ebx</pre></td></tr><tr><td data-num=\"144\"></td><td><pre>PAGE:004DD4DE                 jz      short loc_4DD4F9</pre></td></tr><tr><td data-num=\"145\"></td><td><pre>PAGE:004DD4E0                 mov     [ebp+ms_exc.registration.TryLevel], 1</pre></td></tr><tr><td data-num=\"146\"></td><td><pre>PAGE:004DD4E7                 mov     eax, [ebp+NumberOfBytesRead]</pre></td></tr><tr><td data-num=\"147\"></td><td><pre>PAGE:004DD4EA                 mov     [ebx], eax</pre></td></tr><tr><td data-num=\"148\"></td><td><pre>PAGE:004DD4EC                 jmp     short loc_4DD4F5</pre></td></tr><tr><td data-num=\"149\"></td><td><pre>PAGE:004DD4EE ; ---------------------------------------------------------------------------</pre></td></tr><tr><td data-num=\"150\"></td><td><pre>PAGE:004DD4EE</pre></td></tr><tr><td data-num=\"151\"></td><td><pre>PAGE:004DD4EE loc_4DD4EE:                             ; DATA XREF: .text:stru_402F08↑o</pre></td></tr><tr><td data-num=\"152\"></td><td><pre>PAGE:004DD4EE                 xor     eax, eax</pre></td></tr><tr><td data-num=\"153\"></td><td><pre>PAGE:004DD4F0                 inc     eax</pre></td></tr><tr><td data-num=\"154\"></td><td><pre>PAGE:004DD4F1                 retn</pre></td></tr><tr><td data-num=\"155\"></td><td><pre>PAGE:004DD4F2 ; ---------------------------------------------------------------------------</pre></td></tr><tr><td data-num=\"156\"></td><td><pre>PAGE:004DD4F2</pre></td></tr><tr><td data-num=\"157\"></td><td><pre>PAGE:004DD4F2 loc_4DD4F2:                             ; DATA XREF: .text:stru_402F08↑o</pre></td></tr><tr><td data-num=\"158\"></td><td><pre>PAGE:004DD4F2                 mov     esp, [ebp+ms_exc.old_esp]</pre></td></tr><tr><td data-num=\"159\"></td><td><pre>PAGE:004DD4F5</pre></td></tr><tr><td data-num=\"160\"></td><td><pre>PAGE:004DD4F5 loc_4DD4F5:                             ; CODE XREF: NtWriteVirtualMemory (x,x,x,x,x)+EC↑j</pre></td></tr><tr><td data-num=\"161\"></td><td><pre>PAGE:004DD4F5                 or      [ebp+ms_exc.registration.TryLevel], 0FFFFFFFFh</pre></td></tr><tr><td data-num=\"162\"></td><td><pre>PAGE:004DD4F9</pre></td></tr><tr><td data-num=\"163\"></td><td><pre>PAGE:004DD4F9 loc_4DD4F9:                             ; CODE XREF: NtWriteVirtualMemory (x,x,x,x,x)+DE↑j</pre></td></tr><tr><td data-num=\"164\"></td><td><pre>PAGE:004DD4F9                 mov     eax, [ebp+Status]</pre></td></tr><tr><td data-num=\"165\"></td><td><pre>PAGE:004DD4FC</pre></td></tr><tr><td data-num=\"166\"></td><td><pre>PAGE:004DD4FC loc_4DD4FC:                             ; CODE XREF: NtWriteVirtualMemory (x,x,x,x,x)+81↑j</pre></td></tr><tr><td data-num=\"167\"></td><td><pre>PAGE:004DD4FC                                         ; NtWriteVirtualMemory (x,x,x,x,x)+88↑j</pre></td></tr><tr><td data-num=\"168\"></td><td><pre>PAGE:004DD4FC                 call    __SEH_epilog</pre></td></tr><tr><td data-num=\"169\"></td><td><pre>PAGE:004DD501                 retn    14h</pre></td></tr><tr><td data-num=\"170\"></td><td><pre>PAGE:004DD501 ; &#125; &#x2F;&#x2F;starts at 4DD400</pre></td></tr><tr><td data-num=\"171\"></td><td><pre>PAGE:004DD501 _NtWriteVirtualMemory@20 endp</pre></td></tr><tr><td data-num=\"172\"></td><td><pre>PAGE:004DD501</pre></td></tr><tr><td data-num=\"173\"></td><td><pre>PAGE:004DD501 ; ---------------------------------------------------------------------------</pre></td></tr></table></figure></div></details>\n<p>传递的参数不一样，就造成了不一样的效果。</p>\n<p>分完就会发现读写的操作完全是一个逆过程。</p>\n<h1 id=\"总结-2\"><a class=\"anchor\" href=\"#总结-2\">#</a> 总结</h1>\n<p>NtReadVirtualMemory 流程解析：</p>\n<p><img data-src=\"image005.png\" alt=\"\" /></p>\n<p>NtWriteVirtualMemory 流程解析：</p>\n<p><img data-src=\"image006.png\" alt=\"\" /></p>\n<p>分析其不同：<br />\nNtReadVirtualMemory</p>\n<p><img data-src=\"image007.png\" alt=\"\" /></p>\n<p>NtWriteVirtualMemory</p>\n<p><img data-src=\"image008.png\" alt=\"\" /></p>\n<h2 id=\"实践\"><a class=\"anchor\" href=\"#实践\">#</a> 实践</h2>\n<p>重写函数</p>\n<p>R0 R3 ?</p>\n",
            "tags": [
                "进程挂靠",
                "跨进程读写内存",
                "APC",
                "逆向分析NtReadVirtualMemory",
                "逆向分析NtWriteVIrtualMemory"
            ]
        },
        {
            "id": "https://or0kit.github.io/Bin/Core/WindowsXp/Process-Thread/%E8%BF%9B%E7%A8%8B%E4%B8%8E%E7%BA%BF%E7%A8%8B-Windows%E7%BA%BF%E7%A8%8B%E5%88%87%E6%8D%A2/",
            "url": "https://or0kit.github.io/Bin/Core/WindowsXp/Process-Thread/%E8%BF%9B%E7%A8%8B%E4%B8%8E%E7%BA%BF%E7%A8%8B-Windows%E7%BA%BF%E7%A8%8B%E5%88%87%E6%8D%A2/",
            "title": "进程与线程-Windows线程切换",
            "date_published": "2022-01-21T07:33:33.000Z",
            "content_html": "<h1 id=\"楔子\"><a class=\"anchor\" href=\"#楔子\">#</a> 楔子</h1>\n<p>线程切换是操作系统的核心内容，几乎所有的内核 API 都会调用切换线程的函数。</p>\n<blockquote>\n<p>我们要解决以下这些问题，带着问题去学习。</p>\n</blockquote>\n<ol>\n<li>SwapContext 有几个参数，分别是什么？</li>\n<li>SwapContext 在哪里实现了线程切换</li>\n<li>线程切换的时候，会切换 CR3 吗？切换 CR3 的条件是什么？</li>\n<li>中断门提权时，CPU 会从 TSS 得到 ESP0 和 SS0，TSS 中存储的一定是当前线程的 ESP0 和 SS0 吗？如何做到的？</li>\n<li>FS:[0] 在 3 环指向 TEB，但是线程有很多，FS:[0] 指向的是哪个线程的 TEB，如何做到的？</li>\n<li>0 环的 ExceptionList 在哪里备份的？</li>\n<li>IdleThread 是什么？什么时候执行？找到这个函数.</li>\n<li>如何找到下一个就绪线程？</li>\n<li>模拟线程切换与 Windows 线程切换有哪些区别？</li>\n</ol>\n<h1 id=\"windows线程切换\"><a class=\"anchor\" href=\"#windows线程切换\">#</a> Windows 线程切换</h1>\n<h2 id=\"主动切换切换\"><a class=\"anchor\" href=\"#主动切换切换\">#</a> 主动切换切换</h2>\n<p>在上一篇模模拟 Windows 线程切换 (ThreadSwitch) 中，有一个重要的函数： <code>SwitchContext</code>  只有调用这个函数，就会导致线程切换。<br />\nWindows 也有类似的函数： <code>KiSwapContext</code></p>\n<h3 id=\"kiswapcontext函数\"><a class=\"anchor\" href=\"#kiswapcontext函数\">#</a> KiSwapContext 函数</h3>\n<p>此函数在内核文件  <code>ntkrnlpa.exe</code> / <code>ntoskrnl.exe</code>  中。</p>\n<p>在 IDA 中查看其反汇编：</p>\n<figure class=\"highlight raw\"><figcaption data-lang=\"\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>.text:0046EA9C ; __fastcall KiSwapContext (x)</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>.text:0046EA9C @KiSwapContext@4 proc near              ; CODE XREF: KiSwapThread ()+85↑p</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>.text:0046EA9C</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>.text:0046EA9C var_10          &#x3D; dword ptr -10h</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>.text:0046EA9C var_C           &#x3D; dword ptr -0Ch</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>.text:0046EA9C var_8           &#x3D; dword ptr -8</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>.text:0046EA9C var_4           &#x3D; dword ptr -4</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>.text:0046EA9C</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>.text:0046EA9C                 sub     esp, 10h        ; 使用 fastcall 调用方式。</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>.text:0046EA9C                                         ; 寄存器传参，因此要将使用到的寄存器保存在堆栈中。</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>.text:0046EA9F                 mov     [esp+0Ch], ebx  ; 入栈</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>.text:0046EAA3                 mov     [esp+8], esi</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>.text:0046EAA7                 mov     [esp+4], edi</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>.text:0046EAAB                 mov     [esp], ebp</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>.text:0046EAAE                 mov     ebx, large fs:1Ch ; _KPCR.SelfPcr</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>.text:0046EAB5                 mov     esi, ecx        ; ecx: 新线程的_ETHREAD</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>.text:0046EAB7                 mov     edi, [ebx+124h] ; 取当前正在运行的线程的结构体</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>.text:0046EABD                 mov     [ebx+124h], esi ; 修改 KPCR，换成新线程的 ETHREAD 结构体</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>.text:0046EAC3                 mov     cl, [edi+58h]   ; _ETHREAD.Tcb.WaitIrql</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>.text:0046EAC6                 call    SwapContext</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>.text:0046EACB                 mov     ebp, [esp]      ; 恢复新线程各种寄存器</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>.text:0046EACE                 mov     edi, [esp+4]</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>.text:0046EAD2                 mov     esi, [esp+8]</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>.text:0046EAD6                 mov     ebx, [esp+0Ch]</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>.text:0046EADA                 add     esp, 10h</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>.text:0046EADD                 retn</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>.text:0046EADD @KiSwapContext@4 endp</pre></td></tr></table></figure><p>这个函数并不是真正的线程切换，只是更改了 KPCR 中的 ETHREAD 结构体。把要旧的结构体换成了新的。</p>\n<p>关于  <code>SwapContext</code>  函数，后面在详细对其逆向分析。</p>\n<h3 id=\"查看调用kiswapcontext的函数\"><a class=\"anchor\" href=\"#查看调用kiswapcontext的函数\">#</a> 查看调用 KiSwapContext 的函数</h3>\n<p>在 IDA 中使用交叉引用：</p>\n<table>\n<thead>\n<tr>\n<th style=\"text-align:left\">Direction</th>\n<th style=\"text-align:left\">Type</th>\n<th style=\"text-align:left\">Address</th>\n<th style=\"text-align:left\">Text</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td style=\"text-align:left\">Up</td>\n<td style=\"text-align:left\">p</td>\n<td style=\"text-align:left\">KiSwapThread()+85</td>\n<td style=\"text-align:left\">call    @KiSwapContext@4; KiSwapContext(x)</td>\n</tr>\n</tbody>\n</table>\n<p>发现 KiSwapThread 调用的 KiSwaoContext 。接着查看 KiSwapThread 的交叉引用：</p>\n<p><img data-src=\"image001.png\" alt=\"\" /></p>\n<p>发现有 7 个函数调用了 KiSwapThread 。我们再随便找一个函数，查看其交叉引用：</p>\n<p><img data-src=\"image002.png\" alt=\"\" /></p>\n<p>发现有 270 个函数，这就意味着我们调用了这里面的任何一个函数都会导致线程切换，而这些函数还有上层调用的它们的函数，所以我们可以得出一个结论：<strong>Windows 中绝大部分 API 都调用了 SwapContext 函数</strong>，也就是说，当前线程只要调用了 API，就会导致线程切换。</p>\n<h3 id=\"swapcontext-函数\"><a class=\"anchor\" href=\"#swapcontext-函数\">#</a> SwapContext 函数</h3>\n<p>这个函数目前我还不能完全理解。大部分是偷看海哥视频里的注释。</p>\n<p>在 IDA 中逆向分析如下：</p>\n<p><img data-src=\"image003.png\" alt=\"\" /></p>\n<figure class=\"highlight raw\"><figcaption data-lang=\"\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>.text:0046EBC0 SwapContext     proc near               ; CODE XREF: KiUnlockDispatcherDatabase (x)+99↑p</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>.text:0046EBC0                                         ; KiSwapContext (x)+2A↑p ...</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>.text:0046EBC0</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>.text:0046EBC0 ; FUNCTION CHUNK AT .text:0046ED48 SIZE 00000033 BYTES</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>.text:0046EBC0</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>.text:0046EBC0                 or      cl, cl</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>.text:0046EBC2                 mov     es:[esi+_ETHREAD.Tcb.State], 2 ; 1 就绪 2 运行 5 等待</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>.text:0046EBC7                 pushf</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>.text:0046EBC8                 lea     ecx, [ebx+540h]</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>.text:0046EBCE                 call    @KeAcquireQueuedSpinLockAtDpcLevel@4 ; KeAcquireQueuedSpinLockAtDpcLevel (x)</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>.text:0046EBD3                 lea     ecx, [ebx+_KPCR.PrcbData.LockQueue]</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>.text:0046EBD9                 call    @KeReleaseQueuedSpinLockFromDpcLevel@4 ; KeReleaseQueuedSpinLockFromDpcLevel (x)</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>.text:0046EBDE</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>.text:0046EBDE loc_46EBDE:                             ; CODE XREF: KiIdleLoop ()+7C↓j</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>.text:0046EBDE                 mov     ecx, [ebx+_KPCR.NtTib.ExceptionList] ; 保存本线程切换时的内核 SEH 链表</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>.text:0046EBE0                 cmp     [ebx+_KPCR.PrcbData.DpcRoutineActive], 0 ; 是否有 DPC 有就蓝屏</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>.text:0046EBE7                 push    ecx</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>.text:0046EBE8                 jnz     loc_46ED71</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>.text:0046EBEE                 cmp     ds:_PPerfGlobalGroupMask, 0 ; LOG 用的 Windows 自己调试用的 别的地方没有用</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>.text:0046EBF5                 jnz     loc_46ED48</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>.text:0046EBFB</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>.text:0046EBFB loc_46EBFB:                             ; CODE XREF: SwapContext+190↓j</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>.text:0046EBFB                                         ; SwapContext+1A1↓j ...</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>.text:0046EBFB                 mov     ebp, cr0        ; cr0 控制寄存器可以判断当前环境是实模式还是保护模式，是否开启分页模式，写保护</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>.text:0046EBFE                 mov     edx, ebp</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>.text:0046EC00                 cmp     [edi+_ETHREAD.Tcb.NpxState], 0 ; NpxState 与浮点处理器相关，运行浮点用这个，没运行就不用。</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>.text:0046EC04                 jz      loc_46ED23      ; cr0 寄存器相关的</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>.text:0046EC0A</pre></td></tr><tr><td data-num=\"29\"></td><td><pre>.text:0046EC0A loc_46EC0A:                             ; CODE XREF: _ScPatchFxe+E↓j</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>.text:0046EC0A                 mov     cl, [esi+_ETHREAD.Tcb.DebugActive]</pre></td></tr><tr><td data-num=\"31\"></td><td><pre>.text:0046EC0D                 mov     [ebx+_KPCR.DebugActive], cl ; 新的线程的调试状态，更新到 KPCR 中</pre></td></tr><tr><td data-num=\"32\"></td><td><pre>.text:0046EC10                 cli                     ; cli 不会被时钟中断了</pre></td></tr><tr><td data-num=\"33\"></td><td><pre>.text:0046EC11                 mov     [edi+_ETHREAD.Tcb.KernelStack], esp ; 把当前的 esp 存储到旧线程的 ETHREAD 中</pre></td></tr><tr><td data-num=\"34\"></td><td><pre>.text:0046EC14                 mov     eax, [esi+_ETHREAD.Tcb.InitialStack] ; 新线程的栈底</pre></td></tr><tr><td data-num=\"35\"></td><td><pre>.text:0046EC17                 mov     ecx, [esi+_ETHREAD.Tcb.StackLimit]</pre></td></tr><tr><td data-num=\"36\"></td><td><pre>.text:0046EC1A                 sub     eax, 210h       ; 减去 210H 就是将上面保存的浮点寄存器去掉 现在是真正的栈底了</pre></td></tr><tr><td data-num=\"37\"></td><td><pre>.text:0046EC1F                 mov     [ebx+_KPCR.NtTib.StackLimit], ecx ; 更新 KPCR</pre></td></tr><tr><td data-num=\"38\"></td><td><pre>.text:0046EC22                 mov     [ebx+_KPCR.NtTib.StackBase], eax ; 更新 KPCR</pre></td></tr><tr><td data-num=\"39\"></td><td><pre>.text:0046EC25                 xor     ecx, ecx</pre></td></tr><tr><td data-num=\"40\"></td><td><pre>.text:0046EC27                 mov     cl, [esi+_ETHREAD.Tcb.NpxState] ; 判断 NpxState 有没有浮点支持。</pre></td></tr><tr><td data-num=\"41\"></td><td><pre>.text:0046EC27                                         ; 如果上一个线程和要替换的线程对浮点支持是一样的那就不用换 CR0，不一样就要换。</pre></td></tr><tr><td data-num=\"42\"></td><td><pre>.text:0046EC2A                 and     edx, 0FFFFFFF1h</pre></td></tr><tr><td data-num=\"43\"></td><td><pre>.text:0046EC2D                 or      ecx, edx</pre></td></tr><tr><td data-num=\"44\"></td><td><pre>.text:0046EC2F                 or      ecx, [eax+20Ch]</pre></td></tr><tr><td data-num=\"45\"></td><td><pre>.text:0046EC35                 cmp     ebp, ecx</pre></td></tr><tr><td data-num=\"46\"></td><td><pre>.text:0046EC37                 jnz     loc_46ED1B</pre></td></tr><tr><td data-num=\"47\"></td><td><pre>.text:0046EC3D                 lea     ecx, [ecx+0]</pre></td></tr><tr><td data-num=\"48\"></td><td><pre>.text:0046EC40</pre></td></tr><tr><td data-num=\"49\"></td><td><pre>.text:0046EC40 loc_46EC40:                             ; CODE XREF: SwapContext+15E↓j</pre></td></tr><tr><td data-num=\"50\"></td><td><pre>.text:0046EC40                 test    dword ptr [eax-1Ch], 20000h ; 检查是否是虚拟 8086 模式，</pre></td></tr><tr><td data-num=\"51\"></td><td><pre>.text:0046EC40                                         ; 如果不是的话 eax-10h 也就是减掉_KTRAP_FRAME 中的</pre></td></tr><tr><td data-num=\"52\"></td><td><pre>.text:0046EC40                                         ; +0x07c V86Es            : Uint4B</pre></td></tr><tr><td data-num=\"53\"></td><td><pre>.text:0046EC40                                         ; +0x080 V86Ds            : Uint4B</pre></td></tr><tr><td data-num=\"54\"></td><td><pre>.text:0046EC40                                         ; +0x084 V86Fs            : Uint4B</pre></td></tr><tr><td data-num=\"55\"></td><td><pre>.text:0046EC40                                         ; +0x088 V86Gs            : Uint4B</pre></td></tr><tr><td data-num=\"56\"></td><td><pre>.text:0046EC40                                         ; 4 个成员。</pre></td></tr><tr><td data-num=\"57\"></td><td><pre>.text:0046EC40                                         ; 如果是那就不减。</pre></td></tr><tr><td data-num=\"58\"></td><td><pre>.text:0046EC47                 jnz     short loc_46EC4C ; 取 TSS（TSS 就是 3 环向 0 环切的时候，去 TSS 取 ESP0 和 SS0 别的没用）</pre></td></tr><tr><td data-num=\"59\"></td><td><pre>.text:0046EC49                 sub     eax, 10h</pre></td></tr><tr><td data-num=\"60\"></td><td><pre>.text:0046EC4C</pre></td></tr><tr><td data-num=\"61\"></td><td><pre>.text:0046EC4C loc_46EC4C:                             ; CODE XREF: SwapContext+87↑j</pre></td></tr><tr><td data-num=\"62\"></td><td><pre>.text:0046EC4C                 mov     ecx, [ebx+_KPCR.TSS] ; 取 TSS（TSS 就是 3 环向 0 环切的时候，去 TSS 取 ESP0 和 SS0 别的没用）</pre></td></tr><tr><td data-num=\"63\"></td><td><pre>.text:0046EC4F                 mov     [ecx+_KTSS.Esp0], eax ; 更新 TTS 中的 Esp0</pre></td></tr><tr><td data-num=\"64\"></td><td><pre>.text:0046EC52                 mov     esp, [esi+_ETHREAD.Tcb.KernelStack] ; 将新线程的 esp 存到当前的 esp 寄存器中</pre></td></tr><tr><td data-num=\"65\"></td><td><pre>.text:0046EC55                 mov     eax, [esi+_ETHREAD.Tcb.Teb] ; 当前线程有很多状态 一份在 ETHREAD 里面 还有一个备份在 FS 中</pre></td></tr><tr><td data-num=\"66\"></td><td><pre>.text:0046EC55                                         ; 这样的好处是 在 3 环可以通过 fs 获取当前线程的信息</pre></td></tr><tr><td data-num=\"67\"></td><td><pre>.text:0046EC58                 mov     [ebx+_KPCR.NtTib.Self], eax ; 临时存储新线程的 TEB</pre></td></tr><tr><td data-num=\"68\"></td><td><pre>.text:0046EC5B                 sti                     ; 开启时钟中断</pre></td></tr><tr><td data-num=\"69\"></td><td><pre>.text:0046EC5C                 mov     eax, [edi+_ETHREAD.Tcb.ApcState.Process]</pre></td></tr><tr><td data-num=\"70\"></td><td><pre>.text:0046EC5F                 cmp     eax, [esi+_ETHREAD.Tcb.ApcState.Process] ; 查看是否是同一个进程内的线程切换</pre></td></tr><tr><td data-num=\"71\"></td><td><pre>.text:0046EC62                 mov     [edi+_ETHREAD.Tcb.IdleSwapBlock], 0</pre></td></tr><tr><td data-num=\"72\"></td><td><pre>.text:0046EC66                 jz      short loc_46ECA8 ; 如果是一个进程内的线程切换，则跳转。</pre></td></tr><tr><td data-num=\"73\"></td><td><pre>.text:0046EC68                 mov     edi, [esi+_ETHREAD.Tcb.ApcState.Process] ; 如果不是一个进程，取出新线程的进程结构体</pre></td></tr><tr><td data-num=\"74\"></td><td><pre>.text:0046EC6B                 mov     ecx, [ebx+_KPCR.SetMember]</pre></td></tr><tr><td data-num=\"75\"></td><td><pre>.text:0046EC6E                 xor     [eax+34h], ecx</pre></td></tr><tr><td data-num=\"76\"></td><td><pre>.text:0046EC71                 xor     [edi+_EPROCESS.Pcb.ActiveProcessors], ecx ; ActiveProcessors 记录了当前进程正在哪些处理器上运行</pre></td></tr><tr><td data-num=\"77\"></td><td><pre>.text:0046EC74                 test    [edi+_EPROCESS.Pcb.LdtDescriptor.LimitLow], 0FFFFh ; 判断 LDT</pre></td></tr><tr><td data-num=\"78\"></td><td><pre>.text:0046EC7A                 jnz     short loc_46ECED</pre></td></tr><tr><td data-num=\"79\"></td><td><pre>.text:0046EC7C                 xor     eax, eax</pre></td></tr><tr><td data-num=\"80\"></td><td><pre>.text:0046EC7E</pre></td></tr><tr><td data-num=\"81\"></td><td><pre>.text:0046EC7E loc_46EC7E:                             ; CODE XREF: SwapContext+156↓j</pre></td></tr><tr><td data-num=\"82\"></td><td><pre>.text:0046EC7E                 lldt    ax              ; 修改 LDT 寄存器</pre></td></tr><tr><td data-num=\"83\"></td><td><pre>.text:0046EC81                 lea     ecx, [ebx+540h]</pre></td></tr><tr><td data-num=\"84\"></td><td><pre>.text:0046EC87                 call    @KeReleaseQueuedSpinLockFromDpcLevel@4 ; KeReleaseQueuedSpinLockFromDpcLevel (x)</pre></td></tr><tr><td data-num=\"85\"></td><td><pre>.text:0046EC8C                 xor     eax, eax</pre></td></tr><tr><td data-num=\"86\"></td><td><pre>.text:0046EC8E                 mov     gs, eax         ; GS 清零</pre></td></tr><tr><td data-num=\"87\"></td><td><pre>.text:0046EC90                 assume gs:nothing</pre></td></tr><tr><td data-num=\"88\"></td><td><pre>.text:0046EC90                 mov     eax, [edi+_EPROCESS.Pcb.DirectoryTableBase] ; 取新线程的 CR3</pre></td></tr><tr><td data-num=\"89\"></td><td><pre>.text:0046EC93                 mov     ebp, [ebx+_KPCR.TSS]</pre></td></tr><tr><td data-num=\"90\"></td><td><pre>.text:0046EC96                 mov     ecx, dword ptr [edi+_EPROCESS.Pcb.IopmOffset]</pre></td></tr><tr><td data-num=\"91\"></td><td><pre>.text:0046EC99                 mov     [ebp+_KTSS.CR3], eax</pre></td></tr><tr><td data-num=\"92\"></td><td><pre>.text:0046EC9C                 mov     cr3, eax        ; 切换 CR3</pre></td></tr><tr><td data-num=\"93\"></td><td><pre>.text:0046EC9F                 mov     [ebp+_KTSS.IoMapBase], cx  ; 存储 IO 权限位图到 TSS。当前线程的的 IO 权限位图 Windows 2000 以后不用了。</pre></td></tr><tr><td data-num=\"94\"></td><td><pre>.text:0046ECA3                 jmp     short loc_46ECB3</pre></td></tr><tr><td data-num=\"95\"></td><td><pre>.text:0046ECA3 ; ---------------------------------------------------------------------------</pre></td></tr><tr><td data-num=\"96\"></td><td><pre>.text:0046ECA5                 align 4</pre></td></tr><tr><td data-num=\"97\"></td><td><pre>.text:0046ECA8</pre></td></tr><tr><td data-num=\"98\"></td><td><pre>.text:0046ECA8 loc_46ECA8:                             ; CODE XREF: SwapContext+A6↑j</pre></td></tr><tr><td data-num=\"99\"></td><td><pre>.text:0046ECA8                 lea     ecx, [ebx+540h]</pre></td></tr><tr><td data-num=\"100\"></td><td><pre>.text:0046ECAE                 call    @KeReleaseQueuedSpinLockFromDpcLevel@4 ; KeReleaseQueuedSpinLockFromDpcLevel (x)</pre></td></tr><tr><td data-num=\"101\"></td><td><pre>.text:0046ECB3</pre></td></tr><tr><td data-num=\"102\"></td><td><pre>.text:0046ECB3 loc_46ECB3:                             ; CODE XREF: SwapContext+E3↑j</pre></td></tr><tr><td data-num=\"103\"></td><td><pre>.text:0046ECB3                 mov     eax, [ebx+_KPCR.NtTib.Self]</pre></td></tr><tr><td data-num=\"104\"></td><td><pre>.text:0046ECB6                 mov     ecx, [ebx+_KPCR.GDT] ;  假设 GDT 表在 0x8003f000</pre></td></tr><tr><td data-num=\"105\"></td><td><pre>.text:0046ECB6                                         ; ecx &#x3D; 0x8003f000</pre></td></tr><tr><td data-num=\"106\"></td><td><pre>.text:0046ECB6                                         ; 3 环 FS &#x3D; 0x3B</pre></td></tr><tr><td data-num=\"107\"></td><td><pre>.text:0046ECB6                                         ; 所以 FS 在 GDT 表里的地址是 0x8003f03B</pre></td></tr><tr><td data-num=\"108\"></td><td><pre>.text:0046ECB6                                         ; 下面的操作是修改 FS 的段描述符，这样 3 环 FS 就能找到 TEB 了</pre></td></tr><tr><td data-num=\"109\"></td><td><pre>.text:0046ECB9                 mov     [ecx+3Ah], ax</pre></td></tr><tr><td data-num=\"110\"></td><td><pre>.text:0046ECBD                 shr     eax, 10h</pre></td></tr><tr><td data-num=\"111\"></td><td><pre>.text:0046ECC0                 mov     [ecx+3Ch], al</pre></td></tr><tr><td data-num=\"112\"></td><td><pre>.text:0046ECC3                 mov     [ecx+3Fh], ah</pre></td></tr><tr><td data-num=\"113\"></td><td><pre>.text:0046ECC6                 inc     [esi+_ETHREAD.Tcb.ContextSwitches]</pre></td></tr><tr><td data-num=\"114\"></td><td><pre>.text:0046ECC9                 inc     [ebx+_KPCR.PrcbData.KeContextSwitches]</pre></td></tr><tr><td data-num=\"115\"></td><td><pre>.text:0046ECCF                 pop     ecx</pre></td></tr><tr><td data-num=\"116\"></td><td><pre>.text:0046ECD0                 mov     [ebx], ecx</pre></td></tr><tr><td data-num=\"117\"></td><td><pre>.text:0046ECD2                 cmp     byte ptr [esi+49h], 0</pre></td></tr><tr><td data-num=\"118\"></td><td><pre>.text:0046ECD6                 jnz     short loc_46ECDC</pre></td></tr><tr><td data-num=\"119\"></td><td><pre>.text:0046ECD8                 popf</pre></td></tr><tr><td data-num=\"120\"></td><td><pre>.text:0046ECD9                 xor     eax, eax</pre></td></tr><tr><td data-num=\"121\"></td><td><pre>.text:0046ECDB                 retn</pre></td></tr></table></figure><p>结合以下的两张图可以的更好理解 <code>SwapContext</code>  函数，关于这两张图，后面会详细说明。</p>\n<p><img data-src=\"image004.png\" alt=\"\" />   <img data-src=\"image005.png\" alt=\"\" /></p>\n<h3 id=\"总结\"><a class=\"anchor\" href=\"#总结\">#</a> 总结</h3>\n<ol>\n<li>Windows 中绝大部分 API 都调用了 SwapContext 函数</li>\n</ol>\n<p>也就是说，当线程只要调用了 API，就是导致线程切换。</p>\n<ol start=\"2\">\n<li>线程切换时会比较是否属于同一个进程，如果不是，切换 Cr3</li>\n</ol>\n<p>Cr3 换了，进程也就切换了。</p>\n<p>那么如果不调用 API，就可以一直占用 CPU 吗？</p>\n<h2 id=\"线程被动切换\"><a class=\"anchor\" href=\"#线程被动切换\">#</a> 线程被动切换</h2>\n<p>一个线程并不是必须自身调用 API 来实现线程切换，其他可以引起中断。</p>\n<p>两类：①异常 / 中断；②时钟中断。</p>\n<h3 id=\"时钟中断\"><a class=\"anchor\" href=\"#时钟中断\">#</a> 时钟中断</h3>\n<p>时钟中断走 0x30 号中断，系统每过 20ms 触发一次时钟中断来 (可能) 切换线程。</p>\n<p>如要获取当前的时钟间隔值，可使用 Win32 API： <code>GetSystemTimeAdjustment</code></p>\n<p>时钟中断的执行流程如下：</p>\n<p><img data-src=\"image006.png\" alt=\"\" /></p>\n<h4 id=\"总结-2\"><a class=\"anchor\" href=\"#总结-2\">#</a> 总结</h4>\n<p>线程切换的几种情况：</p>\n<ol>\n<li>主动调用 API 函数</li>\n<li>时钟中断</li>\n<li>异常处理</li>\n</ol>\n<p>如果一个线程不调用 API，在代码中屏蔽中断 (CLI 指令), 并且不会出现异常，那么当前线程将永久占有 CPU, 单核占有率 100%，2 核就是 50%。</p>\n<h3 id=\"时间片管理\"><a class=\"anchor\" href=\"#时间片管理\">#</a> 时间片管理</h3>\n<p>在上面我们知道时钟中断会导致线程进行切换，但并不是说只要有时钟中断就一定会切换线程，时钟中断时，两种情况会导致线程切换：</p>\n<p>1、当前的线程 CPU 时间片到期</p>\n<p>2、有备用线程 (KPCR.PrcbData.NextThread)</p>\n<h4 id=\"关于cpu时间片\"><a class=\"anchor\" href=\"#关于cpu时间片\">#</a> 关于 CPU 时间片</h4>\n<ol>\n<li>当一个新的线程开始执行时，初始化程序会在 <code>_KTHREAD.Quantum</code>  赋初始值，该值的大小由 <code>_KPROCESS.ThreadQuantum</code>  决定<br />\n (观察 <code>ThreadQuantum</code>  大小)</li>\n</ol>\n<p>这是属于某个进程的线程的  <code>Quantum</code>  的值</p>\n<p><img data-src=\"image007.png\" alt=\"\" /></p>\n<p>这是其进程的  <code>ThreadQuantum</code>  的值</p>\n<p><img data-src=\"image008.png\" alt=\"\" /></p>\n<ol start=\"2\">\n<li>每次时钟中断会调用 <code>KeUpdateRunTime</code>  函数，该函数每次将当前线程 <code>Quantum</code>  减少 3 个单位，如果减到 0，则将 <code>KPCR.PrcbData.QuantumEnd</code>  的值设置为非 0。</li>\n</ol>\n<p>在 IDA 中逆向分析  <code>KeUpdateRunTime</code>  函数：</p>\n<p><img data-src=\"image009.png\" alt=\"\" /></p>\n<p><code>KPCR.PrcbData.QuantumEnd</code>  的值代表着时间片是否用完，没有用完时它的值是 0 ，用完的话就是非 0 了。</p>\n<ol start=\"3\">\n<li><code>KiDispatchInterrupt</code>  判断时间片到期：</li>\n</ol>\n<p>调用 <code>KiQuantumEnd</code>  (重新设置时间片、找到要运行的线程)</p>\n<p>这是时钟中断最后要执行的函数。</p>\n<p>在 IDA 中逆向分析  <code>KiDispatchInterrupt</code>  函数：</p>\n<p><img data-src=\"image010.png\" alt=\"\" /></p>\n<p><code>KiQuantumEnd</code>  这个函数做的事情主要就是这个：</p>\n<p><img data-src=\"image011.png\" alt=\"\" /></p>\n<p>重新设置时间片：进程中原本是多少，还设置成多少。<br />\n之后会调用 <code>KiFindReadyThread</code>  切换线程的状态，然后执行  <code>SwapContext</code>  切换线程。</p>\n<p>在 IDA 中看 <code>KiFindReadyThread</code>  的关键操作：</p>\n<p><img data-src=\"image012.png\" alt=\"\" /></p>\n<p>从汇编的角度看双向链表的添加操作……</p>\n<h4 id=\"有备用线程的情况下\"><a class=\"anchor\" href=\"#有备用线程的情况下\">#</a> 有备用线程的情况下</h4>\n<p>分析 <code>KiDispatchInterrupt</code>  函数我们可以得知另一种情况，当时间片没有耗尽，但存在备用线程时，仍然会切换线程，若没有备用线程就直接返回了。</p>\n<p><img data-src=\"image013.png\" alt=\"\" /></p>\n<h2 id=\"线程切换的三种情况总述\"><a class=\"anchor\" href=\"#线程切换的三种情况总述\">#</a> 线程切换的三种情况总述</h2>\n<p>1)、当前线程主动调用 API：</p>\n<p>API 函数 ---&gt;  <code>KiSwapThread</code>   ---&gt;  <code>KiSwapContext</code>  ---&gt;  <code>SwapContext</code></p>\n<p>(2)、当前线程时间片到期：</p>\n<p><code>KiDispatchInterrupt</code>  ---&gt;  <code>KiQuantumEnd</code>  ---&gt;  <code>KiFindReadyThread</code>  ---&gt;  <code>SwapContext</code></p>\n<p>(3)、有备用线程 (KPCR.PrcbData.NextThread)</p>\n<p><code>KiDispatchInterrupt</code>  ---&gt;  <code>KiFindReadyThread</code>  ---&gt;  <code>SwapContext</code></p>\n<h2 id=\"线程切换与tss\"><a class=\"anchor\" href=\"#线程切换与tss\">#</a> 线程切换与 TSS</h2>\n<p><code>SwapContext</code>  这个函数是 Windows 线程切换的核心，无论是主动切换还是系统时钟导致的线程切换，最终都会调用这个函数。在这个函数中除了切换堆栈以外，还做了很多其他的事情，了解这些细节对我们学习操作系统至关重要。</p>\n<p>我们了解一下线程切换与 TSS 的关系。</p>\n<h3 id=\"内核堆栈\"><a class=\"anchor\" href=\"#内核堆栈\">#</a> 内核堆栈</h3>\n<p>在_KTHREAD 结构体中有三个成员：<br />\n <code>InitialStack</code>  栈底<br />\n <code>KernelStack</code>  栈顶<br />\n <code>StackLimit</code>  栈的边界</p>\n<p>由此我们可以大致了解内核堆栈信息：</p>\n<p><img data-src=\"image014.png\" alt=\"\" /></p>\n<h3 id=\"内核堆栈的结构\"><a class=\"anchor\" href=\"#内核堆栈的结构\">#</a> 内核堆栈的结构</h3>\n<p>对于内核堆栈的结构，在通过逆向 <code>SwapContext</code>  函数时，我们已经发现了一些端倪，如下：</p>\n<p><img data-src=\"image015.png\" alt=\"\" /></p>\n<p>也就是说从线程的 <code>InitialStack</code>  栈底开始往上 0x210 个字节 是存储着浮点寄存器的值，而后紧接着就是 <code>_Trap_Frame</code>  结构</p>\n<p><img data-src=\"image005.png\" alt=\"\" /></p>\n<p>之后又判断了是否处于虚拟 8086 模式，对 0 环栈底做了进一步的处理。附上 <code>_Trap_Frame</code>  结构图：</p>\n<p><img data-src=\"image016.png\" alt=\"\" /></p>\n<h3 id=\"调用api进0环\"><a class=\"anchor\" href=\"#调用api进0环\">#</a> 调用 API 进 0 环</h3>\n<p>普通调用：通过 <code>TSS.ESP0</code>  得到 0 环堆栈。---- 既中断门提权</p>\n<p>快速调用：从 MSR 得到一个临时 0 环栈，代码执行后仍然<br />\n通过 TSS.ESP0 得到当前线程 0 环堆栈。</p>\n<p><img data-src=\"image017.png\" alt=\"\" /></p>\n<h3 id=\"如何用tss保存所有线程的esp0\"><a class=\"anchor\" href=\"#如何用tss保存所有线程的esp0\">#</a> 如何用 TSS 保存所有线程的 ESP0</h3>\n<p>Intel 设计 TSS 的目的是为了任务切换 (线程切换), 但 Windows 与 Linux<br />\n 并没有使用。而是采用堆栈来保存线程的各种寄存器。</p>\n<p>一个 CPU 只有一个 TSS, 但是线程很多，如何用一个 TSS 来保存所有<br />\n线程的 ESP0 呢？</p>\n<p>在 <code>SwapContext</code>  函数中查找与 TTS 相关的代码（这里改了后面肯定是要用的）：</p>\n<p><img data-src=\"image018.png\" alt=\"\" /></p>\n<p>发现有三个位置与 TSS 有联系，其中第一处就是我们要找的答案，eax 存储的就是处理后的线程的 0 环 ESP。<br />\n<strong>每一次线程切换都会更新这个值，把对应线程的 0 环堆栈存储在 TTS.Esp0 的位置。</strong></p>\n<p>第二处是把当前线程所属进程的 CR3 也存储到了 TSS 中。<br />\n第三处是 IO 权限位图。</p>\n<h2 id=\"线程切换与fs\"><a class=\"anchor\" href=\"#线程切换与fs\">#</a> 线程切换与 FS</h2>\n<p>FS:[0] 寄存器在 3 环时指向 TEB, 进入 0 环后 FS:[0] 指向 KPCR。但系统中同时存在很多个线程，这就意味着 FS:[0] 在 3 环时指向的 TEB 要有多个 (每个线程一份)。</p>\n<p>但在实际的使用中我们发现，当我们在 3 环查看不同线程的 FS 寄存器时，FS 的段选择子都是相同的，那是如何实现通过一个 FS 寄存器指向多个 TEB 呢？</p>\n<p>我们还是分析 <code>SwapContext</code>  函数中查找与 FS 相关的代码：</p>\n<p><img data-src=\"image019.png\" alt=\"\" /></p>\n<p><strong>线程切换的时候每次都在 GDT 表中索引为 0x3B 的地址构建每个线程关于 TEB 的段描述符</strong></p>\n<p>附上段描述符的结构：</p>\n<p><img data-src=\"image020.png\" alt=\"\" /></p>\n<h2 id=\"线程切换与线程优先级\"><a class=\"anchor\" href=\"#线程切换与线程优先级\">#</a> 线程切换与线程优先级</h2>\n<p>在 <code>KiSwapThread</code>  与 <code>KiQuantumEnd</code>  函数中都是通过 <code>KiFindReadyThread</code>  来找下一个要切换的线程， <code>KiFindReadyThread</code>  是根据什么条件来选择下一个要执行的线程呢？</p>\n<h3 id=\"调度链表32个\"><a class=\"anchor\" href=\"#调度链表32个\">#</a> 调度链表（32 个）</h3>\n<figure class=\"highlight raw\"><figcaption data-lang=\"\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>kd&gt; dd KiDispatcherReadyListHead</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>8055bc20  8055bc20 8055bc20 8055bc28 8055bc28</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>8055bc30  8055bc30 8055bc30 8055bc38 8055bc38</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>8055bc40  8055bc40 8055bc40 8055bc48 8055bc48</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>8055bc50  8055bc50 8055bc50 8055bc58 8055bc58</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>8055bc60  8055bc60 8055bc60 8055bc68 8055bc68</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>8055bc70  8055bc70 8055bc70 8055bc78 8055bc78</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>8055bc80  8055bc80 8055bc80 8055bc88 8055bc88</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>8055bc90  8055bc90 8055bc90 8055bc98 8055bc98</pre></td></tr></table></figure><p><code>KiFindReadyThread</code>  查找方式：<br />\n按照优先级别进行查找：31..30..29..28.....</p>\n<p>也就是说，在<strong>本次查找</strong>中，如果级别 31 的链表里面有线程，那么就不会查找级别为 30 的链表！</p>\n<p>根据我学过的计算机操作系统的知识，由于调度算法，每次查找线程的时候，线程的优先级都会动态调整的。</p>\n<h3 id=\"如何高效查找\"><a class=\"anchor\" href=\"#如何高效查找\">#</a> 如何高效查找</h3>\n<p>调度链表有 32 个，每次都从头开始查找效率太低，所以 Windows 使用一个 DWORD 类型变量的变量来记录，利用其 32 个比特位的特性。<br />\n当向调度链表 (32 个) 中挂入或者摘除某个线程时，会判断当前级别的链表是否为空，为空将 DWORD 变量对应位置 0，否则置 1。</p>\n<p>如下图：</p>\n<p><img data-src=\"image021.png\" alt=\"\" /></p>\n<p>这个变量： <code>_kiReadySummary</code></p>\n<p>多 cpu 会随机寻找 <code>KiDispatcherReadyListHead</code>  指向的数组中的线程。线程可以绑定某个 cpu（使用 api： <code>setThreadAffinityMask</code> ）</p>\n<p>这里可以逆向分析一下 <code>KiFindReadyThread</code>  函数。详细见：<span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cuY25ibG9ncy5jb20vb25ldHJhaW5lZS9wLzEyNzUyMTgzLmh0bWw=\">https://www.cnblogs.com/onetrainee/p/12752183.html</span></p>\n<h3 id=\"如果没有就绪线程怎么办\"><a class=\"anchor\" href=\"#如果没有就绪线程怎么办\">#</a> 如果没有就绪线程怎么办？</h3>\n<p>PrcbData：</p>\n<p>+0x004 CurrentThread    : Ptr32 _KTHREAD<br />\n+0x008 NextThread       : Ptr32 _KTHREAD<br />\n+0x00c IdleThread       : Ptr32 _KTHREAD</p>\n<p><img data-src=\"image022.png\" alt=\"\" /></p>\n<p>并且还修改了  <code>_KiIdleSummary</code>  这个变量。</p>\n<p>那我们如何找这个空闲线程的函数呢？</p>\n<p>用 Windbg 下断后，查看当前的  <code>KPRCB</code>  结构体，找到  <code>IdleThread</code>  线程的  <code>ETHREAD</code>  结构体。</p>\n<figure class=\"highlight raw\"><figcaption data-lang=\"\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>kd&gt; dt _KPRCB 0xFFDFF120</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>nt!_KPRCB</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>   +0x000 MinorVersion     : 1</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>   +0x002 MajorVersion     : 1</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>   +0x004 CurrentThread    : 0x8055ce60 _KTHREAD</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>   +0x008 NextThread       : (null) </pre></td></tr><tr><td data-num=\"7\"></td><td><pre>   +0x00c IdleThread       : 0x8055ce60 _KTHREAD</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>   +0x010 Number           : 0 &#39;&#39;</pre></td></tr></table></figure><p>查看  <code>IdleThread</code>  线程的  <code>ETHREAD</code>  结构体。</p>\n<figure class=\"highlight raw\"><figcaption data-lang=\"\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>kd&gt; dt _ETHREAD 0x8055ce60 </pre></td></tr><tr><td data-num=\"2\"></td><td><pre>nt!_ETHREAD</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>   +0x000 Tcb              : _KTHREAD</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>   +0x1c0 CreateTime       : _LARGE_INTEGER 0x0</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>   +0x1c0 NestedFaultCount : 0y00</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>   +0x1c0 ApcNeeded        : 0y0</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>   +0x1c8 ExitTime         : _LARGE_INTEGER 0x0</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>   +0x1c8 LpcReplyChain    : _LIST_ENTRY [ 0x0 - 0x0 ]</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>   +0x1c8 KeyedWaitChain   : _LIST_ENTRY [ 0x0 - 0x0 ]</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>   +0x1d0 ExitStatus       : 0n0</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>   +0x1d0 OfsChain         : (null) </pre></td></tr><tr><td data-num=\"12\"></td><td><pre>   +0x1d4 PostBlockList    : _LIST_ENTRY [ 0x0 - 0x0 ]</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>   +0x1dc TerminationPort  : (null) </pre></td></tr><tr><td data-num=\"14\"></td><td><pre>   +0x1dc ReaperLink       : (null) </pre></td></tr><tr><td data-num=\"15\"></td><td><pre>   +0x1dc KeyedWaitValue   : (null) </pre></td></tr><tr><td data-num=\"16\"></td><td><pre>   +0x1e0 ActiveTimerListLock : 0</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>   +0x1e4 ActiveTimerListHead : _LIST_ENTRY [ 0x0 - 0x0 ]</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>   +0x1ec Cid              : _CLIENT_ID</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>   +0x1f4 LpcReplySemaphore : _KSEMAPHORE</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>   +0x1f4 KeyedWaitSemaphore : _KSEMAPHORE</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>   +0x208 LpcReplyMessage  : (null) </pre></td></tr><tr><td data-num=\"22\"></td><td><pre>   +0x208 LpcWaitingOnPort : (null) </pre></td></tr><tr><td data-num=\"23\"></td><td><pre>   +0x20c ImpersonationInfo : (null) </pre></td></tr><tr><td data-num=\"24\"></td><td><pre>   +0x210 IrpList          : _LIST_ENTRY [ 0x0 - 0x0 ]</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>   +0x218 TopLevelIrp      : 0</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>   +0x21c DeviceToVerify   : (null) </pre></td></tr><tr><td data-num=\"27\"></td><td><pre>   +0x220 ThreadsProcess   : (null) </pre></td></tr><tr><td data-num=\"28\"></td><td><pre>   +0x224 StartAddress     : (null) </pre></td></tr><tr><td data-num=\"29\"></td><td><pre>   +0x228 Win32StartAddress : (null) </pre></td></tr><tr><td data-num=\"30\"></td><td><pre>   +0x228 LpcReceivedMessageId : 0</pre></td></tr><tr><td data-num=\"31\"></td><td><pre>   +0x22c ThreadListEntry  : _LIST_ENTRY [ 0x0 - 0x0 ]</pre></td></tr><tr><td data-num=\"32\"></td><td><pre>   +0x234 RundownProtect   : _EX_RUNDOWN_REF</pre></td></tr><tr><td data-num=\"33\"></td><td><pre>   +0x238 ThreadLock       : _EX_PUSH_LOCK</pre></td></tr><tr><td data-num=\"34\"></td><td><pre>   +0x23c LpcReplyMessageId : 0</pre></td></tr><tr><td data-num=\"35\"></td><td><pre>   +0x240 ReadClusterSize  : 0</pre></td></tr><tr><td data-num=\"36\"></td><td><pre>   +0x244 GrantedAccess    : 0x1f03ff</pre></td></tr><tr><td data-num=\"37\"></td><td><pre>   +0x248 CrossThreadFlags : 0</pre></td></tr><tr><td data-num=\"38\"></td><td><pre>   +0x248 Terminated       : 0y0</pre></td></tr><tr><td data-num=\"39\"></td><td><pre>   +0x248 DeadThread       : 0y0</pre></td></tr><tr><td data-num=\"40\"></td><td><pre>   +0x248 HideFromDebugger : 0y0</pre></td></tr><tr><td data-num=\"41\"></td><td><pre>   +0x248 ActiveImpersonationInfo : 0y0</pre></td></tr><tr><td data-num=\"42\"></td><td><pre>   +0x248 SystemThread     : 0y0</pre></td></tr><tr><td data-num=\"43\"></td><td><pre>   +0x248 HardErrorsAreDisabled : 0y0</pre></td></tr><tr><td data-num=\"44\"></td><td><pre>   +0x248 BreakOnTermination : 0y0</pre></td></tr><tr><td data-num=\"45\"></td><td><pre>   +0x248 SkipCreationMsg  : 0y0</pre></td></tr><tr><td data-num=\"46\"></td><td><pre>   +0x248 SkipTerminationMsg : 0y0</pre></td></tr><tr><td data-num=\"47\"></td><td><pre>   +0x24c SameThreadPassiveFlags : 0</pre></td></tr><tr><td data-num=\"48\"></td><td><pre>   +0x24c ActiveExWorker   : 0y0</pre></td></tr><tr><td data-num=\"49\"></td><td><pre>   +0x24c ExWorkerCanWaitUser : 0y0</pre></td></tr><tr><td data-num=\"50\"></td><td><pre>   +0x24c MemoryMaker      : 0y0</pre></td></tr><tr><td data-num=\"51\"></td><td><pre>   +0x250 SameThreadApcFlags : 0</pre></td></tr><tr><td data-num=\"52\"></td><td><pre>   +0x250 LpcReceivedMsgIdValid : 0y0</pre></td></tr><tr><td data-num=\"53\"></td><td><pre>   +0x250 LpcExitThreadCalled : 0y0</pre></td></tr><tr><td data-num=\"54\"></td><td><pre>   +0x250 AddressSpaceOwner : 0y0</pre></td></tr><tr><td data-num=\"55\"></td><td><pre>   +0x254 ForwardClusterOnly : 0 &#39;&#39;</pre></td></tr><tr><td data-num=\"56\"></td><td><pre>   +0x255 DisablePageFaultClustering : 0 &#39;&#39;</pre></td></tr><tr><td data-num=\"57\"></td><td><pre>   +0x258 KernelStackReference : 0</pre></td></tr></table></figure><p>发现其  <code>+0x224 StartAddress     : (null)</code>  的值为空。找不到线程开始的地方。</p>\n<p>这里还是得逆向分析  <code>SwapContext</code>  函数：</p>\n<p>切换完 esp 后： <code>  mov     esp, [esi+_ETHREAD.Tcb.KernelStack] ; 将新线程的esp存到当前的esp寄存器中</code></p>\n<p>我们观察有几个出栈操作（pop、popf）</p>\n<figure class=\"highlight raw\"><figcaption data-lang=\"\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>.text:0046ECCF                 pop     ecx</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>.text:0046ECD0                 mov     [ebx], ecx</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>.text:0046ECD2                 cmp     byte ptr [esi+49h], 0</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>.text:0046ECD6                 jnz     short loc_46ECDC</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>.text:0046ECD8                 popf</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>.text:0046ECD9                 xor     eax, eax</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>.text:0046ECDB                 retn</pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>loc_46ECDC: </pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>.text:0046ECDC                 popf</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>.text:0046ECDD                 jnz     short loc_46ECE2</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>.text:0046ECDF                 mov     al, 1</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>.text:0046ECE1                 retn</pre></td></tr></table></figure><p><strong>发现总共执行了两次出栈操作</strong>，那我们直接去找 IdleThread 线程的 <code>_ETHREAD.Tcb.KernelStack</code>  的值</p>\n<p><code>[+0x028] KernelStack      : 0x8055244c [Type: void *]</code> <br />\n 在 windbg 中查看：</p>\n<figure class=\"highlight raw\"><figcaption data-lang=\"\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>kd&gt; dd 0x8055244c </pre></td></tr><tr><td data-num=\"2\"></td><td><pre>8055244c  00000000 ffdff980 80546e6c 00000000</pre></td></tr></table></figure><p>总共执行了两次出栈操作那么  <code>esp+8</code>  的位置就是  <code>retn</code>  返回  <code>eip</code>  要执行的地方。</p>\n<p>在本次实验中的值是  <code>80546e6c</code> ，在 windbg 中查看：</p>\n<figure class=\"highlight raw\"><figcaption data-lang=\"\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>kd&gt; u 80546e6c </pre></td></tr><tr><td data-num=\"2\"></td><td><pre>nt!KiIdleLoop+0x10:</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>80546e6c f390            pause</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>80546e6e fb              sti</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>80546e6f 90              nop</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>80546e70 90              nop</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>80546e71 fa              cli</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>80546e72 3b6d00          cmp     ebp,dword ptr [ebp]</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>80546e75 740d            je      nt!KiIdleLoop+0x28 (80546e84)</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>80546e77 b102            mov     cl,2</pre></td></tr></table></figure><p>发现执行的是  <code>KiIdleLoop+0x10</code>  的地方，所以  <code>KiIdleLoop</code>  就是我们要找的  <code>IdleThread</code>  线程的函数。</p>\n<p>可是这里我有个问题，执行了  <code>pop  ecx</code>  和  <code>popf</code>  ESP 的值不应该是加 6 吗？为什么去找 ESP 加 8 的位置呢？</p>\n<h1 id=\"总结-3\"><a class=\"anchor\" href=\"#总结-3\">#</a> 总结</h1>\n<ol>\n<li>SwapContext 有几个参数，分别是什么？</li>\n</ol>\n<p><img data-src=\"image023.png\" alt=\"\" /></p>\n<ol start=\"2\">\n<li>SwapContext 在哪里实现了线程切换</li>\n</ol>\n<p><img data-src=\"image024.png\" alt=\"\" /></p>\n<ol start=\"3\">\n<li>线程切换的时候，会切换 CR3 吗？切换 CR3 的条件是什么？</li>\n</ol>\n<p><img data-src=\"image025.png\" alt=\"\" /></p>\n<p>这里我们能够知道一个小知识：<strong>线程能读写地址，是由 0x44 位置的进程结构体的 CR3 决定的，并不是 0x220 的位置。</strong></p>\n<ol start=\"4\">\n<li>中断门提权时，CPU 会从 TSS 得到 ESP0 和 SS0，TSS 中存储的一定是当前线程的 ESP0 和 SS0 吗？如何做到的？</li>\n</ol>\n<p>上面已经详细解释了。<br />\n并没有存 SS0 的代码，因为所有线程的 SS0 的值是固定不变的，系统启动时已经填到 TSS 里，不需要在这里改了。</p>\n<p><img data-src=\"image026.png\" alt=\"\" /></p>\n<ol start=\"5\">\n<li>FS:[0] 在 3 环指向 TEB，但是线程有很多，FS:[0] 指向的是哪个线程的 TEB，如何做到的？</li>\n</ol>\n<p>上面已经详细解释了。<br />\n<strong>线程切换的时候每次都在 GDT 表中索引为 0x3B 的地址构建每个线程关于 TEB 的段描述符</strong></p>\n<p><img data-src=\"image019.png\" alt=\"\" /></p>\n<ol start=\"6\">\n<li>0 环的 ExceptionList 在哪里备份的？</li>\n</ol>\n<p><img data-src=\"image027.png\" alt=\"\" /></p>\n<ol start=\"7\">\n<li>IdleThread 是什么？什么时候执行？找到这个函数.</li>\n</ol>\n<p><img data-src=\"image022.png\" alt=\"\" /></p>\n<p>如何找到这个线程的函数上面也讲了。</p>\n<ol start=\"8\">\n<li>如何找到下一个就绪线程？</li>\n</ol>\n<p><code>KiFindReadyThread</code>  函数</p>\n<ol start=\"9\">\n<li>模拟线程切换与 Windows 线程切换有哪些区别？</li>\n</ol>\n<p>3 环与 0 环，真正的线程有两个栈，一个是 3 环的一个是 0 环的，模拟线程只有一个栈，还没用到异常链表、ss、TSS。</p>\n",
            "tags": [
                "Windows线程切换",
                "KiSwapContext",
                "SwapContext",
                "时钟中断",
                "时间片管理",
                "线程切换与TSS",
                "线程切换与FS",
                "线程切换与线程优先级"
            ]
        },
        {
            "id": "https://or0kit.github.io/Bin/Core/WindowsXp/Process-Thread/%E8%BF%9B%E7%A8%8B%E4%B8%8E%E7%BA%BF%E7%A8%8B-%E6%A8%A1%E6%8B%9F%E7%BA%BF%E7%A8%8B%E5%88%87%E6%8D%A2/",
            "url": "https://or0kit.github.io/Bin/Core/WindowsXp/Process-Thread/%E8%BF%9B%E7%A8%8B%E4%B8%8E%E7%BA%BF%E7%A8%8B-%E6%A8%A1%E6%8B%9F%E7%BA%BF%E7%A8%8B%E5%88%87%E6%8D%A2/",
            "title": "进程与线程-模拟线程切换",
            "date_published": "2022-01-17T06:46:30.000Z",
            "content_html": "<h1 id=\"模拟线程切换\"><a class=\"anchor\" href=\"#模拟线程切换\">#</a> 模拟线程切换</h1>\n<p>开始学习 Windows 的线程切换，线程切换比较复杂，为了更好的学习，我们要先读一份代码。</p>\n<p>关键结构体：</p>\n<p><img data-src=\"image001.png\" alt=\"\" /></p>\n<p>调度链表</p>\n<p><img data-src=\"image002.png\" alt=\"\" /></p>\n<p>创建结构体，挂到链表里，正在运行的线程在 KPCR 中，等待线程 与 33 个调度线程的，线程的状态，</p>\n<p>初始化线程的堆栈</p>\n<p><img data-src=\"image003.png\" alt=\"\" /></p>\n<h1 id=\"分析代码\"><a class=\"anchor\" href=\"#分析代码\">#</a> 分析代码</h1>\n<p>配合海哥的教程代码很好理解。</p>\n<h2 id=\"threadh\"><a class=\"anchor\" href=\"#threadh\">#</a> Thread.h</h2>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">pragma</span> <span class=\"token expression\">once</span></span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;windows.h></span></span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;stdio.h></span></span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token comment\">// 最大支持的线程数</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">MAXGMTHREAD</span> <span class=\"token expression\"><span class=\"token number\">100</span></span></span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token comment\">// 线程信息的结构</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token keyword\">typedef</span> <span class=\"token keyword\">struct</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>\t<span class=\"token keyword\">char</span><span class=\"token operator\">*</span> name<span class=\"token punctuation\">;</span>\t\t\t\t\t\t\t<span class=\"token comment\">// 线程名 相当于线程 ID</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>\t<span class=\"token keyword\">int</span> Flags<span class=\"token punctuation\">;</span>\t\t\t\t\t\t\t<span class=\"token comment\">// 线程状态</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>\t<span class=\"token keyword\">int</span> SleepMillsecondDot<span class=\"token punctuation\">;</span>\t\t\t\t<span class=\"token comment\">// 休眠时间</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>\t<span class=\"token keyword\">void</span><span class=\"token operator\">*</span> initialStack<span class=\"token punctuation\">;</span>\t\t\t\t\t<span class=\"token comment\">// 线程堆栈起始位置</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>\t<span class=\"token keyword\">void</span><span class=\"token operator\">*</span> StackLimit<span class=\"token punctuation\">;</span>\t\t\t\t\t<span class=\"token comment\">// 线程堆栈界限</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>\t<span class=\"token keyword\">void</span><span class=\"token operator\">*</span> KernelStack<span class=\"token punctuation\">;</span>\t\t\t\t\t<span class=\"token comment\">// 线程堆栈当前位置，也就是 ESP</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>\t<span class=\"token keyword\">void</span><span class=\"token operator\">*</span> lpParameter<span class=\"token punctuation\">;</span>\t\t\t\t\t<span class=\"token comment\">// 线程函数的参数</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>\t<span class=\"token keyword\">void</span><span class=\"token punctuation\">(</span><span class=\"token operator\">*</span>func<span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">void</span><span class=\"token operator\">*</span> lpParameter<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\t\t<span class=\"token comment\">// 线程函数</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre><span class=\"token punctuation\">&#125;</span>GMThread_t<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre></pre></td></tr><tr><td data-num=\"23\"></td><td><pre><span class=\"token keyword\">void</span> <span class=\"token function\">GMSleep</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> MilliSeconds<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre><span class=\"token keyword\">int</span> <span class=\"token function\">RegisterGMThread</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">char</span><span class=\"token operator\">*</span> name<span class=\"token punctuation\">,</span> <span class=\"token keyword\">void</span><span class=\"token punctuation\">(</span><span class=\"token operator\">*</span>func<span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">void</span><span class=\"token operator\">*</span> lpParameter<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">void</span><span class=\"token operator\">*</span> lpParameter<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre><span class=\"token keyword\">void</span> <span class=\"token function\">Scheduling</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>模拟线程结构体，其中的  <code>initialStack</code>   <code>StackLimit</code>   <code>KernelStack</code>  是线程切换过程中关键的的参数。</p>\n<h2 id=\"threadcorecpp\"><a class=\"anchor\" href=\"#threadcorecpp\">#</a> ThreadCore.cpp</h2>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">\"ThreadCore.h\"</span></span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token comment\">// 定义线程栈的大小</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">GMTHREADSTACKSIZE</span> <span class=\"token expression\"><span class=\"token number\">0x80000</span></span></span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token comment\">// 当前线程的索引</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token keyword\">int</span> CurrentThreadIndex <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token comment\">// 这样初始化使每个结构体的第一个成员为 NULL，其余全为 0，调试可看。</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token comment\">// 线程的列表</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>GMThread_t GMThreadList<span class=\"token punctuation\">[</span>MAXGMTHREAD<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span> <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token comment\">// 线程状态的标志</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token keyword\">enum</span> <span class=\"token class-name\">FLAGS</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>\tGMTHREAD_CREATE <span class=\"token operator\">=</span> <span class=\"token number\">0x1</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>\tGMTHREAD_READY <span class=\"token operator\">=</span> <span class=\"token number\">0x2</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>\tGMTHREAD_SLEEP <span class=\"token operator\">=</span> <span class=\"token number\">0x4</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>\tGMTHREAD_EXIT <span class=\"token operator\">=</span> <span class=\"token number\">0x8</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre></pre></td></tr><tr><td data-num=\"23\"></td><td><pre><span class=\"token comment\">// 启动线程的函数</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre><span class=\"token keyword\">void</span> <span class=\"token function\">GMThreadStartup</span><span class=\"token punctuation\">(</span>GMThread_t<span class=\"token operator\">*</span> GMThreadp<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>\tGMThreadp<span class=\"token operator\">-></span><span class=\"token function\">func</span><span class=\"token punctuation\">(</span>GMThreadp<span class=\"token operator\">-></span>lpParameter<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>\tGMThreadp<span class=\"token operator\">-></span>Flags <span class=\"token operator\">=</span> GMTHREAD_EXIT<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>\t<span class=\"token function\">Scheduling</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>\t<span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre></pre></td></tr><tr><td data-num=\"33\"></td><td><pre><span class=\"token comment\">// 空闲线程的函数</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre><span class=\"token keyword\">void</span> <span class=\"token function\">IdleGMThread</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">void</span><span class=\"token operator\">*</span> lpParameter<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>\t<span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"IdleGMThread---------------\\n\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>\t<span class=\"token function\">Scheduling</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>\t<span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre></pre></td></tr><tr><td data-num=\"41\"></td><td><pre><span class=\"token comment\">// 向栈中压入一个 uint 值</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre><span class=\"token keyword\">void</span> <span class=\"token function\">PushStack</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">unsigned</span> <span class=\"token keyword\">int</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span> Stackpp<span class=\"token punctuation\">,</span> <span class=\"token keyword\">unsigned</span> <span class=\"token keyword\">int</span> v<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>\t<span class=\"token operator\">*</span>Stackpp <span class=\"token operator\">-=</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span><span class=\"token comment\">//ebp - 4</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>\t<span class=\"token operator\">*</span><span class=\"token operator\">*</span>Stackpp <span class=\"token operator\">=</span> v<span class=\"token punctuation\">;</span><span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>\t<span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre></pre></td></tr><tr><td data-num=\"50\"></td><td><pre><span class=\"token comment\">// 初始化线程的信息</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre><span class=\"token keyword\">void</span> <span class=\"token function\">initGMThread</span><span class=\"token punctuation\">(</span>GMThread_t<span class=\"token operator\">*</span> GMThreadp<span class=\"token punctuation\">,</span> <span class=\"token keyword\">char</span><span class=\"token operator\">*</span> name<span class=\"token punctuation\">,</span> <span class=\"token keyword\">void</span><span class=\"token punctuation\">(</span><span class=\"token operator\">*</span>func<span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">void</span><span class=\"token operator\">*</span> lpParameter<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">void</span><span class=\"token operator\">*</span> lpParameter<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>\t<span class=\"token keyword\">unsigned</span> <span class=\"token keyword\">char</span><span class=\"token operator\">*</span> StackPages<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre>\t<span class=\"token keyword\">unsigned</span> <span class=\"token keyword\">int</span><span class=\"token operator\">*</span> StackDWordParam<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>\t<span class=\"token comment\">// 结构初始化赋值</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre>\tGMThreadp<span class=\"token operator\">-></span>Flags <span class=\"token operator\">=</span> GMTHREAD_CREATE<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre>\tGMThreadp<span class=\"token operator\">-></span>name <span class=\"token operator\">=</span> name<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"59\"></td><td><pre>\tGMThreadp<span class=\"token operator\">-></span>func <span class=\"token operator\">=</span> func<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre>\tGMThreadp<span class=\"token operator\">-></span>lpParameter <span class=\"token operator\">=</span> lpParameter<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"61\"></td><td><pre></pre></td></tr><tr><td data-num=\"62\"></td><td><pre>\t<span class=\"token comment\">// 申请空间</span></pre></td></tr><tr><td data-num=\"63\"></td><td><pre>\tStackPages <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">unsigned</span> <span class=\"token keyword\">char</span><span class=\"token operator\">*</span><span class=\"token punctuation\">)</span><span class=\"token function\">VirtualAlloc</span><span class=\"token punctuation\">(</span><span class=\"token constant\">NULL</span><span class=\"token punctuation\">,</span> GMTHREADSTACKSIZE<span class=\"token punctuation\">,</span> MEM_COMMIT<span class=\"token punctuation\">,</span> PAGE_READWRITE<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"64\"></td><td><pre>\t<span class=\"token comment\">// 初始化</span></pre></td></tr><tr><td data-num=\"65\"></td><td><pre>\t<span class=\"token function\">memset</span><span class=\"token punctuation\">(</span>StackPages<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> GMTHREADSTACKSIZE<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"66\"></td><td><pre>\t<span class=\"token comment\">// 初始化堆栈地址 </span></pre></td></tr><tr><td data-num=\"67\"></td><td><pre>\tGMThreadp<span class=\"token operator\">-></span>initialStack <span class=\"token operator\">=</span> StackPages <span class=\"token operator\">+</span> GMTHREADSTACKSIZE<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"68\"></td><td><pre>\t<span class=\"token comment\">// 堆栈限制</span></pre></td></tr><tr><td data-num=\"69\"></td><td><pre>\tGMThreadp<span class=\"token operator\">-></span>StackLimit <span class=\"token operator\">=</span> StackPages<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"70\"></td><td><pre>\t<span class=\"token comment\">// 堆栈地址 </span></pre></td></tr><tr><td data-num=\"71\"></td><td><pre>\tStackDWordParam <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">unsigned</span> <span class=\"token keyword\">int</span><span class=\"token operator\">*</span><span class=\"token punctuation\">)</span>GMThreadp<span class=\"token operator\">-></span>initialStack<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"72\"></td><td><pre></pre></td></tr><tr><td data-num=\"73\"></td><td><pre>\t<span class=\"token comment\">// 入栈</span></pre></td></tr><tr><td data-num=\"74\"></td><td><pre>\t<span class=\"token function\">PushStack</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>StackDWordParam<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">unsigned</span> <span class=\"token keyword\">int</span><span class=\"token punctuation\">)</span>GMThreadp<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\t\t<span class=\"token comment\">// 通过这个指针来找到线程函数，线程参数</span></pre></td></tr><tr><td data-num=\"75\"></td><td><pre>\t<span class=\"token function\">PushStack</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>StackDWordParam<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">unsigned</span> <span class=\"token keyword\">int</span><span class=\"token punctuation\">)</span><span class=\"token number\">0x12345678</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\t\t<span class=\"token comment\">// 平衡堆栈的 (不用管，此值无意义)</span></pre></td></tr><tr><td data-num=\"76\"></td><td><pre>\t<span class=\"token function\">PushStack</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>StackDWordParam<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">unsigned</span> <span class=\"token keyword\">int</span><span class=\"token punctuation\">)</span>GMThreadStartup<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\t<span class=\"token comment\">// 线程入口函数 这个函数负责调用线程函数</span></pre></td></tr><tr><td data-num=\"77\"></td><td><pre>\t<span class=\"token function\">PushStack</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>StackDWordParam<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">unsigned</span> <span class=\"token keyword\">int</span><span class=\"token punctuation\">)</span><span class=\"token number\">5</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\t\t\t\t<span class=\"token comment\">//push ebp  此值无意义，是寄存器初始值</span></pre></td></tr><tr><td data-num=\"78\"></td><td><pre>\t<span class=\"token function\">PushStack</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>StackDWordParam<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">unsigned</span> <span class=\"token keyword\">int</span><span class=\"token punctuation\">)</span><span class=\"token number\">7</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\t\t\t\t<span class=\"token comment\">//push edi  此值无意义</span></pre></td></tr><tr><td data-num=\"79\"></td><td><pre>\t<span class=\"token function\">PushStack</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>StackDWordParam<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">unsigned</span> <span class=\"token keyword\">int</span><span class=\"token punctuation\">)</span><span class=\"token number\">6</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\t\t\t\t<span class=\"token comment\">//push esi\t此值无意义</span></pre></td></tr><tr><td data-num=\"80\"></td><td><pre>\t<span class=\"token function\">PushStack</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>StackDWordParam<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">unsigned</span> <span class=\"token keyword\">int</span><span class=\"token punctuation\">)</span><span class=\"token number\">3</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\t\t\t\t<span class=\"token comment\">//push ebx\t此值无意义</span></pre></td></tr><tr><td data-num=\"81\"></td><td><pre>\t<span class=\"token function\">PushStack</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>StackDWordParam<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">unsigned</span> <span class=\"token keyword\">int</span><span class=\"token punctuation\">)</span><span class=\"token number\">2</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\t\t\t\t<span class=\"token comment\">//push ecx\t此值无意义</span></pre></td></tr><tr><td data-num=\"82\"></td><td><pre>\t<span class=\"token function\">PushStack</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>StackDWordParam<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">unsigned</span> <span class=\"token keyword\">int</span><span class=\"token punctuation\">)</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\t\t\t\t<span class=\"token comment\">//push edx\t此值无意义</span></pre></td></tr><tr><td data-num=\"83\"></td><td><pre>\t<span class=\"token function\">PushStack</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>StackDWordParam<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">unsigned</span> <span class=\"token keyword\">int</span><span class=\"token punctuation\">)</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\t\t\t\t<span class=\"token comment\">//push eax\t此值无意义</span></pre></td></tr><tr><td data-num=\"84\"></td><td><pre></pre></td></tr><tr><td data-num=\"85\"></td><td><pre>\t<span class=\"token comment\">// 当前线程的栈顶</span></pre></td></tr><tr><td data-num=\"86\"></td><td><pre>\tGMThreadp<span class=\"token operator\">-></span>KernelStack <span class=\"token operator\">=</span> StackDWordParam<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"87\"></td><td><pre></pre></td></tr><tr><td data-num=\"88\"></td><td><pre>\t<span class=\"token comment\">// 当前线程状态</span></pre></td></tr><tr><td data-num=\"89\"></td><td><pre>\tGMThreadp<span class=\"token operator\">-></span>Flags <span class=\"token operator\">=</span> GMTHREAD_READY<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"90\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"91\"></td><td><pre></pre></td></tr><tr><td data-num=\"92\"></td><td><pre><span class=\"token comment\">// 将一个函数注册为单独线程执行</span></pre></td></tr><tr><td data-num=\"93\"></td><td><pre><span class=\"token keyword\">int</span> <span class=\"token function\">RegisterGMThread</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">char</span><span class=\"token operator\">*</span> name<span class=\"token punctuation\">,</span> <span class=\"token keyword\">void</span><span class=\"token punctuation\">(</span><span class=\"token operator\">*</span>func<span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">void</span><span class=\"token operator\">*</span> lpParameter<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">void</span><span class=\"token operator\">*</span> lpParameter<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"94\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"95\"></td><td><pre>\t<span class=\"token keyword\">int</span> i<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"96\"></td><td><pre>\t<span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span>i <span class=\"token operator\">=</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span> GMThreadList<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>name<span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"97\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"98\"></td><td><pre>\t\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token number\">0</span> <span class=\"token operator\">==</span> <span class=\"token function\">_stricmp</span><span class=\"token punctuation\">(</span>GMThreadList<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>name<span class=\"token punctuation\">,</span> name<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"99\"></td><td><pre>\t\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"100\"></td><td><pre>\t\t\t<span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"101\"></td><td><pre>\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"102\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"103\"></td><td><pre>\t<span class=\"token function\">initGMThread</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>GMThreadList<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> name<span class=\"token punctuation\">,</span> func<span class=\"token punctuation\">,</span> lpParameter<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"104\"></td><td><pre></pre></td></tr><tr><td data-num=\"105\"></td><td><pre>\t<span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span>i <span class=\"token operator\">&amp;</span> <span class=\"token number\">0x55AA0000</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"106\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"107\"></td><td><pre></pre></td></tr><tr><td data-num=\"108\"></td><td><pre><span class=\"token comment\">// 切换线程\t1：当前线程结构体指针 2：要切换的线程结构体指针</span></pre></td></tr><tr><td data-num=\"109\"></td><td><pre><span class=\"token function\">__declspec</span><span class=\"token punctuation\">(</span>naked<span class=\"token punctuation\">)</span> <span class=\"token keyword\">void</span> <span class=\"token function\">SwitchContext</span><span class=\"token punctuation\">(</span>GMThread_t<span class=\"token operator\">*</span> SrcGMThreadp<span class=\"token punctuation\">,</span> GMThread_t<span class=\"token operator\">*</span> DstGMThreadp<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"110\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"111\"></td><td><pre>\t__asm</pre></td></tr><tr><td data-num=\"112\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"113\"></td><td><pre>\t\t<span class=\"token comment\">// 提升堆栈</span></pre></td></tr><tr><td data-num=\"114\"></td><td><pre>\t\tpush ebp</pre></td></tr><tr><td data-num=\"115\"></td><td><pre>\t\tmov ebp<span class=\"token punctuation\">,</span> esp</pre></td></tr><tr><td data-num=\"116\"></td><td><pre></pre></td></tr><tr><td data-num=\"117\"></td><td><pre>\t\t<span class=\"token comment\">// 保存当前线程寄存器</span></pre></td></tr><tr><td data-num=\"118\"></td><td><pre>\t\tpush edi</pre></td></tr><tr><td data-num=\"119\"></td><td><pre>\t\tpush esi</pre></td></tr><tr><td data-num=\"120\"></td><td><pre>\t\tpush ebx</pre></td></tr><tr><td data-num=\"121\"></td><td><pre>\t\tpush ecx</pre></td></tr><tr><td data-num=\"122\"></td><td><pre>\t\tpush edx</pre></td></tr><tr><td data-num=\"123\"></td><td><pre>\t\tpush eax</pre></td></tr><tr><td data-num=\"124\"></td><td><pre></pre></td></tr><tr><td data-num=\"125\"></td><td><pre>\t\tmov esi<span class=\"token punctuation\">,</span> SrcGMThreadp</pre></td></tr><tr><td data-num=\"126\"></td><td><pre>\t\tmov edi<span class=\"token punctuation\">,</span> DstGMThreadp</pre></td></tr><tr><td data-num=\"127\"></td><td><pre></pre></td></tr><tr><td data-num=\"128\"></td><td><pre>\t\tmov<span class=\"token punctuation\">[</span>esi <span class=\"token operator\">+</span> GMThread_t<span class=\"token punctuation\">.</span>KernelStack<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> esp</pre></td></tr><tr><td data-num=\"129\"></td><td><pre>\t\t<span class=\"token comment\">// 经典线程切换，另外一个线程复活</span></pre></td></tr><tr><td data-num=\"130\"></td><td><pre>\t\tmov esp<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span>edi <span class=\"token operator\">+</span> GMThread_t<span class=\"token punctuation\">.</span>KernelStack<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"131\"></td><td><pre></pre></td></tr><tr><td data-num=\"132\"></td><td><pre>\t\tpop eax</pre></td></tr><tr><td data-num=\"133\"></td><td><pre>\t\tpop edx</pre></td></tr><tr><td data-num=\"134\"></td><td><pre>\t\tpop ecx</pre></td></tr><tr><td data-num=\"135\"></td><td><pre>\t\tpop ebx</pre></td></tr><tr><td data-num=\"136\"></td><td><pre>\t\tpop esi</pre></td></tr><tr><td data-num=\"137\"></td><td><pre>\t\tpop edi</pre></td></tr><tr><td data-num=\"138\"></td><td><pre></pre></td></tr><tr><td data-num=\"139\"></td><td><pre>\t\tpop ebp</pre></td></tr><tr><td data-num=\"140\"></td><td><pre>\t\tret\t<span class=\"token comment\">// 把 startup (线程函数入口) 弹到 eip 执行的就是线程函数了</span></pre></td></tr><tr><td data-num=\"141\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"142\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"143\"></td><td><pre></pre></td></tr><tr><td data-num=\"144\"></td><td><pre><span class=\"token comment\">// 这个函数会让出 cpu，从队列里重新选择一个线程执行</span></pre></td></tr><tr><td data-num=\"145\"></td><td><pre><span class=\"token keyword\">void</span> <span class=\"token function\">Scheduling</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"146\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"147\"></td><td><pre>\t<span class=\"token comment\">// 获取自系统启动以来经过的毫秒数</span></pre></td></tr><tr><td data-num=\"148\"></td><td><pre>\t<span class=\"token keyword\">int</span> TickCount <span class=\"token operator\">=</span> <span class=\"token function\">GetTickCount</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"149\"></td><td><pre></pre></td></tr><tr><td data-num=\"150\"></td><td><pre>\tGMThread_t<span class=\"token operator\">*</span> SrcGMThreadp <span class=\"token operator\">=</span> <span class=\"token operator\">&amp;</span>GMThreadList<span class=\"token punctuation\">[</span>CurrentThreadIndex<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"151\"></td><td><pre>\tGMThread_t<span class=\"token operator\">*</span> DstGMThreadp <span class=\"token operator\">=</span> <span class=\"token operator\">&amp;</span>GMThreadList<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"152\"></td><td><pre></pre></td></tr><tr><td data-num=\"153\"></td><td><pre></pre></td></tr><tr><td data-num=\"154\"></td><td><pre>\t<span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> i <span class=\"token operator\">=</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span> GMThreadList<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>name<span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"155\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"156\"></td><td><pre>\t\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>GMThreadList<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>Flags <span class=\"token operator\">&amp;</span> GMTHREAD_SLEEP<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"157\"></td><td><pre>\t\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"158\"></td><td><pre>\t\t\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>TickCount <span class=\"token operator\">></span> GMThreadList<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>SleepMillsecondDot<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"159\"></td><td><pre>\t\t\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"160\"></td><td><pre>\t\t\t\tGMThreadList<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>Flags <span class=\"token operator\">=</span> GMTHREAD_READY<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"161\"></td><td><pre>\t\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"162\"></td><td><pre>\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"163\"></td><td><pre>\t\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>GMThreadList<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>Flags <span class=\"token operator\">&amp;</span> GMTHREAD_READY<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"164\"></td><td><pre>\t\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"165\"></td><td><pre>\t\t\tDstGMThreadp <span class=\"token operator\">=</span> <span class=\"token operator\">&amp;</span>GMThreadList<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"166\"></td><td><pre>\t\t\t<span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"167\"></td><td><pre>\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"168\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"169\"></td><td><pre>\t<span class=\"token comment\">// 获取队列中下一个线程的索引</span></pre></td></tr><tr><td data-num=\"170\"></td><td><pre>\tCurrentThreadIndex <span class=\"token operator\">=</span> DstGMThreadp <span class=\"token operator\">-</span> GMThreadList<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"171\"></td><td><pre></pre></td></tr><tr><td data-num=\"172\"></td><td><pre>\t<span class=\"token function\">SwitchContext</span><span class=\"token punctuation\">(</span>SrcGMThreadp<span class=\"token punctuation\">,</span> DstGMThreadp<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"173\"></td><td><pre></pre></td></tr><tr><td data-num=\"174\"></td><td><pre>\t<span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"175\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"176\"></td><td><pre></pre></td></tr><tr><td data-num=\"177\"></td><td><pre><span class=\"token keyword\">void</span> <span class=\"token function\">GMSleep</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> MilliSeconds<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"178\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"179\"></td><td><pre>\tGMThread_t<span class=\"token operator\">*</span> GMThreadp<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"180\"></td><td><pre>\tGMThreadp <span class=\"token operator\">=</span> <span class=\"token operator\">&amp;</span>GMThreadList<span class=\"token punctuation\">[</span>CurrentThreadIndex<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"181\"></td><td><pre></pre></td></tr><tr><td data-num=\"182\"></td><td><pre>\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>GMThreadp<span class=\"token operator\">-></span>Flags <span class=\"token operator\">!=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"183\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"184\"></td><td><pre>\t\tGMThreadp<span class=\"token operator\">-></span>Flags <span class=\"token operator\">=</span> GMTHREAD_SLEEP<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"185\"></td><td><pre>\t\tGMThreadp<span class=\"token operator\">-></span>SleepMillsecondDot <span class=\"token operator\">=</span> <span class=\"token function\">GetTickCount</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> MilliSeconds<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"186\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"187\"></td><td><pre></pre></td></tr><tr><td data-num=\"188\"></td><td><pre>\t<span class=\"token function\">Scheduling</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"189\"></td><td><pre>\t<span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"190\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>注意在  <code>GMThreadStartup</code>  函数中  <code>GMThreadp-&gt;func(GMThreadp-&gt;lpParameter);</code> <br />\n 我们在前面的模拟初始化线程结构体中，设置的线程函数是不一样的。<br />\n但，它是如何找线程的参数的呢？<br />\n这个函数 <code>void GMThreadStartup(GMThread_t* GMThreadp)</code>  我们并没有传参呀？</p>\n<p>这里看一下反汇编就明白了</p>\n<p><img data-src=\"image004.png\" alt=\"\" /></p>\n<p>虽然我们没有传参，但我们定义这个函数的时候是有参数的，所以程序编译的时候，它会直接找  <code>ebp+8</code>  的位置，那  <code>ebp+8</code>  它能正确找到参数吗？可以！！</p>\n<p>继续观察这个图：</p>\n<p><img data-src=\"image003.png\" alt=\"\" /></p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token number\">24</span><span class=\"token operator\">:</span> <span class=\"token keyword\">void</span> <span class=\"token function\">GMThreadStartup</span><span class=\"token punctuation\">(</span>GMThread_t<span class=\"token operator\">*</span> GMThreadp<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token number\">25</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token number\">0057</span>C020  push        ebp  </pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token number\">0057</span>C021  mov         ebp<span class=\"token punctuation\">,</span>esp</pre></td></tr></table></figure><p>当执行  <code>ret</code>  指令后，esp-4 esp 指向了 9（这个值是随便压入栈的）并且 eip 指向了堆栈中存储 Startup 函数地址的位置，既程序开始执行  <code>GMThreadStartup</code>  函数，然后执行了  <code>push ebp</code>  和  <code>mov  ebp,esp</code>  后，esp 和 ebp 都指向了堆栈中原来存储 Startup 函数地址的位置，并且这个值也被替换为了，原来的 esp 的值（这个 esp 的值也是我们随便压入栈的）。</p>\n<p>这个时候已经清楚的知道了 ebp 和 esp 的值， 在堆栈中  <code>ebp+8</code>  的位置正是每个线程的模拟结构体！</p>\n<p>非常的巧妙！我称之为艺术（嘿嘿没见过世面…）！！大拇指.png</p>\n<h2 id=\"maincpp\"><a class=\"anchor\" href=\"#maincpp\">#</a> main.cpp</h2>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">\"ThreadCore.h\"</span></span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">extern</span> <span class=\"token keyword\">int</span> CurrentThreadIndex<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token keyword\">extern</span> GMThread_t GMThreadList<span class=\"token punctuation\">[</span>MAXGMTHREAD<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token keyword\">void</span> <span class=\"token function\">Thread1</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">void</span><span class=\"token operator\">*</span> n<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\t<span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>\t\t<span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Thread%d\\n\"</span><span class=\"token punctuation\">,</span> n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>\t\t<span class=\"token function\">GMSleep</span><span class=\"token punctuation\">(</span><span class=\"token number\">500</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre></pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token keyword\">void</span> <span class=\"token function\">Thread2</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">void</span><span class=\"token operator\">*</span> n<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>\t<span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>\t\t<span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Thread%d\\n\"</span><span class=\"token punctuation\">,</span> n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>\t\t<span class=\"token function\">GMSleep</span><span class=\"token punctuation\">(</span><span class=\"token number\">200</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre></pre></td></tr><tr><td data-num=\"26\"></td><td><pre><span class=\"token keyword\">void</span> <span class=\"token function\">Thread3</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">void</span><span class=\"token operator\">*</span> n<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>\t<span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>\t\t<span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Thread%d\\n\"</span><span class=\"token punctuation\">,</span> n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>\t\t<span class=\"token function\">GMSleep</span><span class=\"token punctuation\">(</span><span class=\"token number\">10</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre></pre></td></tr><tr><td data-num=\"35\"></td><td><pre><span class=\"token keyword\">void</span> <span class=\"token function\">Thread4</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">void</span><span class=\"token operator\">*</span> n<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>\t<span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>\t\t<span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Thread%d\\n\"</span><span class=\"token punctuation\">,</span> n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>\t\t<span class=\"token function\">GMSleep</span><span class=\"token punctuation\">(</span><span class=\"token number\">1000</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><span class=\"token comment\">// 模拟调用 API 函数</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre></pre></td></tr><tr><td data-num=\"44\"></td><td><pre></pre></td></tr><tr><td data-num=\"45\"></td><td><pre><span class=\"token keyword\">int</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>\t<span class=\"token function\">RegisterGMThread</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">char</span><span class=\"token operator\">*</span><span class=\"token punctuation\">)</span><span class=\"token string\">\"Thread1\"</span><span class=\"token punctuation\">,</span> Thread1<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">void</span><span class=\"token operator\">*</span><span class=\"token punctuation\">)</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>\t<span class=\"token function\">RegisterGMThread</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">char</span><span class=\"token operator\">*</span><span class=\"token punctuation\">)</span><span class=\"token string\">\"Thread2\"</span><span class=\"token punctuation\">,</span> Thread2<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">void</span><span class=\"token operator\">*</span><span class=\"token punctuation\">)</span><span class=\"token number\">2</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>\t<span class=\"token function\">RegisterGMThread</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">char</span><span class=\"token operator\">*</span><span class=\"token punctuation\">)</span><span class=\"token string\">\"Thread3\"</span><span class=\"token punctuation\">,</span> Thread3<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">void</span><span class=\"token operator\">*</span><span class=\"token punctuation\">)</span><span class=\"token number\">3</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>\t<span class=\"token function\">RegisterGMThread</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">char</span><span class=\"token operator\">*</span><span class=\"token punctuation\">)</span><span class=\"token string\">\"Thread4\"</span><span class=\"token punctuation\">,</span> Thread4<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">void</span><span class=\"token operator\">*</span><span class=\"token punctuation\">)</span><span class=\"token number\">4</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre></pre></td></tr><tr><td data-num=\"52\"></td><td><pre>\t<span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">;</span><span class=\"token punctuation\">;</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre>\t\t<span class=\"token function\">Sleep</span><span class=\"token punctuation\">(</span><span class=\"token number\">20</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><span class=\"token comment\">// 模拟时钟中断</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre>\t\t<span class=\"token function\">Scheduling</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre></pre></td></tr><tr><td data-num=\"58\"></td><td><pre>\t<span class=\"token keyword\">return</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"59\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>这个就没什么好说的了。</p>\n<h1 id=\"课后作业\"><a class=\"anchor\" href=\"#课后作业\">#</a> 课后作业</h1>\n<p>写两个函数实现线程的挂起和恢复功能。</p>\n<p>就是模拟  <code>SuspendThread()</code>  和  <code>ResumeThread()</code>  函数</p>\n<p><strong>回顾一下以前的知识点：如何让线程停下来？</strong><br />\n让自己停下来: <code>Sleep()</code> <br />\n 让别人停下来: <code>SuspendThread()</code> <br />\n 线程恢复:  <code>ResumeThread()</code></p>\n<p>海哥说用最简约的方式写。<br />\n不就是改线程的状态吗！</p>\n<h2 id=\"代码\"><a class=\"anchor\" href=\"#代码\">#</a> 代码</h2>\n<p>写的时候也有其他疑问，要不要模拟操作系统添加一个 context 呢？要不要定义一个等待链表呢？如何随时挂起一个线程？不过海哥在视频里说了，用最简约的方式写，也是哈，操作系统考虑的事情很多，我们不用考虑那么多，没必要啊！</p>\n<p>线程 1 调用挂起函数，挂起哪个线程？  线程都有名字。</p>\n<p>调用恢复函数，恢复哪个函数？这个也可以使用名字。</p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">// 挂起函数</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">void</span> <span class=\"token function\">GMSuspend</span><span class=\"token punctuation\">(</span>LPCSTR ThreadName<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>\t<span class=\"token class-name\">size_t</span> i<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>\t<span class=\"token comment\">// 由线程名字查找线程</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>\t<span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span>i <span class=\"token operator\">=</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span> GMThreadList<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>name<span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>\t\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token number\">0</span> <span class=\"token operator\">==</span> <span class=\"token function\">strcmp</span><span class=\"token punctuation\">(</span>GMThreadList<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>name<span class=\"token punctuation\">,</span> ThreadName<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\t\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\t\t\t<span class=\"token comment\">// 修改线程状态</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>\t\t\tGMThreadList<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>Flags <span class=\"token operator\">=</span> GMTHREAD_SUSPEND<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>\t\t\t<span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre></pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token comment\">// 恢复线程</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre><span class=\"token keyword\">void</span> <span class=\"token function\">GMResume</span><span class=\"token punctuation\">(</span>LPCSTR ThreadName<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>\t<span class=\"token class-name\">size_t</span> i<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>\t<span class=\"token comment\">// 由线程名字查找线程</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>\t<span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span>i <span class=\"token operator\">=</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span> GMThreadList<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>name<span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>\t\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token number\">0</span> <span class=\"token operator\">==</span> <span class=\"token function\">strcmp</span><span class=\"token punctuation\">(</span>GMThreadList<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>name<span class=\"token punctuation\">,</span> ThreadName<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>\t\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>\t\t\t<span class=\"token comment\">// 修改线程状态</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>\t\t\tGMThreadList<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>Flags <span class=\"token operator\">=</span> GMTHREAD_READY<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>\t\t\t<span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>修改了一下 线程 1 的函数：</p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">void</span> <span class=\"token function\">Thread1</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">void</span><span class=\"token operator\">*</span> n<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>\tbool Flags <span class=\"token operator\">=</span> true<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>\t<span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>\t\t<span class=\"token keyword\">switch</span> <span class=\"token punctuation\">(</span>Flags<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>\t\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>\t\t\t<span class=\"token keyword\">case</span> true<span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\t\t\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\t\t\t\t<span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"我是Thread%d，我要运行1秒哦^v^，我运行的时候其他线程不许运行哦。\\n\"</span><span class=\"token punctuation\">,</span> n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>\t\t\t\t<span class=\"token function\">GMSuspend</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Thread2\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>\t\t\t\t<span class=\"token function\">GMSuspend</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Thread3\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>\t\t\t\t<span class=\"token function\">GMSuspend</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Thread4\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>\t\t\t\tFlags <span class=\"token operator\">=</span> false<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>\t\t\t\t<span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>\t\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>\t\t\t<span class=\"token keyword\">default</span><span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>\t\t\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>\t\t\t\t<span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"我是Thread%d，现在大家可以一起执行了哦^v^\\n\"</span><span class=\"token punctuation\">,</span> n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>\t\t\t\t<span class=\"token function\">GMResume</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Thread2\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>\t\t\t\t<span class=\"token function\">GMResume</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Thread3\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>\t\t\t\t<span class=\"token function\">GMResume</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Thread4\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>\t\t\t\tFlags <span class=\"token operator\">=</span> true<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>\t\t\t\t<span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>\t\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>\t\t<span class=\"token function\">GMSleep</span><span class=\"token punctuation\">(</span><span class=\"token number\">1000</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>截图：</p>\n<p><img data-src=\"image005.png\" alt=\"\" /></p>\n<h1 id=\"模拟线程切换总结\"><a class=\"anchor\" href=\"#模拟线程切换总结\">#</a> 模拟线程切换总结</h1>\n<ol>\n<li>\n<p>线程不是被动切换的，而是主动让出 CPU.</p>\n</li>\n<li>\n<p>线程切换并没有使用 TSS 来保存寄存器，而是使用堆栈.</p>\n</li>\n<li>\n<p>线程切换的过程就是堆栈切换的过程.</p>\n</li>\n</ol>\n",
            "tags": [
                "模拟线程切换",
                "模拟挂起与恢复函数"
            ]
        },
        {
            "id": "https://or0kit.github.io/Bin/Core/WindowsXp/Process-Thread/%E8%BF%9B%E7%A8%8B%E4%B8%8E%E7%BA%BF%E7%A8%8B-%E8%BF%9B%E7%A8%8B%E7%9A%84%E5%88%9B%E5%BB%BA/",
            "url": "https://or0kit.github.io/Bin/Core/WindowsXp/Process-Thread/%E8%BF%9B%E7%A8%8B%E4%B8%8E%E7%BA%BF%E7%A8%8B-%E8%BF%9B%E7%A8%8B%E7%9A%84%E5%88%9B%E5%BB%BA/",
            "title": "进程与线程-进程的创建",
            "date_published": "2022-01-11T13:39:45.000Z",
            "content_html": "<h1 id=\"楔子\"><a class=\"anchor\" href=\"#楔子\">#</a> 楔子</h1>\n<p>我们已经知道了进程和线程是如何在 Windows 中表示的，在内核层和执行体层分别包含了哪些信息。现在我们来看看 Windows 执行体是如何管理进程和线程的，包括进程和线程的创建和终止过程，以及进程和线程是如何创建起来的。</p>\n<h1 id=\"小知识获取当前进程或线程\"><a class=\"anchor\" href=\"#小知识获取当前进程或线程\">#</a> 小知识：获取当前进程或线程</h1>\n<p><strong>内核层函数 KeGetCurrentThread 是一个重要的函数</strong>，它返回当前处理器上正在运行的线程的 KTHREAD 结构指针。通过此结构信息，可以进一步得到 KPROCESS 、ETHREAD 和 EPROCESS 结构。在 WRK 中， KeGetCurrentThread 是这样实现的：</p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>FORCEINLINE</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">struct</span> <span class=\"token class-name\">_KTHREAD</span> <span class=\"token operator\">*</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>NTAPI <span class=\"token function\">KeGetCurrentThread</span> <span class=\"token punctuation\">(</span>VOID<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">if</span> <span class=\"token expression\"><span class=\"token punctuation\">(</span>_MSC_FULL_VER <span class=\"token operator\">>=</span> <span class=\"token number\">13012035</span><span class=\"token punctuation\">)</span></span></span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">struct</span> <span class=\"token class-name\">_KTHREAD</span> <span class=\"token operator\">*</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">(</span>ULONG_PTR<span class=\"token punctuation\">)</span> <span class=\"token function\">__readfsdword</span> <span class=\"token punctuation\">(</span><span class=\"token function\">FIELD_OFFSET</span> <span class=\"token punctuation\">(</span>KPCR<span class=\"token punctuation\">,</span> PrcbData<span class=\"token punctuation\">.</span>CurrentThread<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">else</span></span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    __asm <span class=\"token punctuation\">&#123;</span>  mov eax<span class=\"token punctuation\">,</span> fs<span class=\"token operator\">:</span><span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span> KPCR<span class=\"token punctuation\">.</span>PrcbData<span class=\"token punctuation\">.</span>CurrentThread <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">endif</span></span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>WRK 本身自带的编译器（tools\\x86\\cl.exe）版本（13.10.4035）大于 13012035 所以上面的代码取第一个条件分支，它展开来实际上只是一条指令。</p>\n<p>第二条分支， <code>mov eax, fs:[0] KPCR.PrcbData.CurrentThread</code>  应该等同于  <code>mov eax,fs:[0x124]</code> <br />\n 下面四种书写方式等价：<br />\n <code>MOV　AX, [BX+SI+1000H]</code> <br />\n <code>MOV　AX, 1000H[BX+SI]</code> <br />\n <code>MOV　AX, 1000H[BX][SI]</code> <br />\n <code>MOV　AX, 1000H[SI][BX]</code></p>\n<p>获取了当前线程的 KTHREAD 结构指针以后，便可以很方便的获取 ETHREAD 、 KPROCESS 和 EPROCESS 结构的指针了。</p>\n<p><strong>执行体层上获得当前线程和进程的函数</strong>分别是 PsGetCurrentThread 和 PsGetCurrentProcess ，代码如下：</p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name function\">_PsGetCurrentProcess</span><span class=\"token expression\"><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">(</span><span class=\"token function\">CONTAINING_RECORD</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token function\">KeGetCurrentThread</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token operator\">-></span>ApcState<span class=\"token punctuation\">.</span>Process<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>EPROCESS<span class=\"token punctuation\">,</span>Pcb<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></span></span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name function\">_PsGetCurrentThread</span><span class=\"token expression\"><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>PETHREAD<span class=\"token punctuation\">)</span><span class=\"token function\">KeGetCurrentThread</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></span></span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>PEPROCESS</pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token function\">PsGetCurrentProcess</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    VOID</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    <span class=\"token keyword\">return</span> <span class=\"token function\">_PsGetCurrentProcess</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>PETHREAD</pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token function\">PsGetCurrentThread</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    VOID</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>    <span class=\"token keyword\">return</span> <span class=\"token function\">_PsGetCurrentThread</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>我们看到，_PsGetCurrentProcess 宏从当前线程 KTHREAD 结构的 ApcState 成员中获得当前线程所属进程的 KPROCESS 结构。 这里之所以从 ApcState 成员中获取进程结构指针，而不是从 KTHREAD 的 Process 域 或 ETHREAD 的 ThreadProcess 域获取进程结构指针，<strong>是因为即使当前线程附载到其他进程中（通过 KeAttachProcess 函数），或者有回到原先的进程中（通过 KeDetachProcess 函数），这种做法也总是能够获得正确的当前进程结构的指针</strong>。 这里涉及 APC 相关的知识，还没学，暂时不深究。</p>\n<h1 id=\"进程创建过程\"><a class=\"anchor\" href=\"#进程创建过程\">#</a> 进程创建过程</h1>\n<p>看了几本书，还是没有捋顺知识点，先埋个坑。多看看书后再往下写了。CR3 的值在实模式下就被初始化好了，在一个链表中。</p>\n<h2 id=\"从r3-createprocess-分析进程创建过程\"><a class=\"anchor\" href=\"#从r3-createprocess-分析进程创建过程\">#</a> 从 R3  <code>CreateProcess</code>  分析进程创建过程</h2>\n<p>由于逆向的流程很复杂，我们先看 Xp 源码。</p>\n<p>BOOL<br />\nWINAPI<br />\nCreateProcessA(<br />\nLPCSTR lpApplicationName,<br />\nLPSTR lpCommandLine,<br />\nLPSECURITY_ATTRIBUTES lpProcessAttributes,<br />\nLPSECURITY_ATTRIBUTES lpThreadAttributes,<br />\nBOOL bInheritHandles,<br />\nDWORD dwCreationFlags,<br />\nLPVOID lpEnvironment,<br />\nLPCSTR lpCurrentDirectory,<br />\nLPSTARTUPINFOA lpStartupInfo,<br />\nLPPROCESS_INFORMATION lpProcessInformation<br />\n)</p>\n",
            "tags": [
                "进程的创建",
                "获取当前进程"
            ]
        },
        {
            "id": "https://or0kit.github.io/Bin/Core/WindowsXp/Process-Thread/%E8%BF%9B%E7%A8%8B%E4%B8%8E%E7%BA%BF%E7%A8%8B-%E7%AD%89%E5%BE%85%E9%93%BE%E8%A1%A8%E4%B8%8E%E8%B0%83%E5%BA%A6%E9%93%BE%E8%A1%A8/",
            "url": "https://or0kit.github.io/Bin/Core/WindowsXp/Process-Thread/%E8%BF%9B%E7%A8%8B%E4%B8%8E%E7%BA%BF%E7%A8%8B-%E7%AD%89%E5%BE%85%E9%93%BE%E8%A1%A8%E4%B8%8E%E8%B0%83%E5%BA%A6%E9%93%BE%E8%A1%A8/",
            "title": "进程与线程-等待链表与调度链表",
            "date_published": "2022-01-11T08:43:18.000Z",
            "content_html": "<h1 id=\"楔子\"><a class=\"anchor\" href=\"#楔子\">#</a> 楔子</h1>\n<p>进程结构体 EPROCESS (0x50 和 0x190) 是 2 个链表，里面圈着当前进程所有的线程。</p>\n<p>对进程断链，程序可以正常运行，原因是 CPU 执行与调度是以线程为单位的，进程断链只是影响一些遍历系统进程的 API，并不会影响程序执行。</p>\n<p>对线程断链也是一样的，断链后在 Windbg 或者 OD 中无法看到被断掉的线程，但并不影响其执行 (仍然再跑)。</p>\n<p>为什么程序还可以跑呢？</p>\n<p>肯定是操作系统找到线程的表不是我们断掉的这个。<br />\n接下来我们就要了解操作系统的等待链表与调度链表了，在此之前回顾一下计操相关的知识。</p>\n<h1 id=\"线程的三种状态\"><a class=\"anchor\" href=\"#线程的三种状态\">#</a> 线程的三种状态</h1>\n<h2 id=\"wait-等待-挂起-阻塞\"><a class=\"anchor\" href=\"#wait-等待-挂起-阻塞\">#</a> wait (等待、挂起、阻塞……)</h2>\n<p>导致线程等待的原因有多种，例如调用了 Sleep, WaitForSingleObject 等函数，或者在创建时和运行时让线程挂起的 API，例如 SuspendThread 函数。</p>\n<p>等待线程存储在等待链表头 KiWaitListHead 中， KiWaitListHead 是一个全局变量，在 Windbg 中查看：</p>\n<figure class=\"highlight raw\"><figcaption data-lang=\"\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>kd&gt; dd KiWaitListHead</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>8055d4a8  8a18ce00 8a06d858</pre></td></tr></table></figure><p>0x80553d88 存储了 KiWaitListHead ，这是一个 _LIST_ENTRY，它属于某个线程 _KTHREAD + 0x60 的位置。</p>\n<figure class=\"highlight raw\"><figcaption data-lang=\"\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>+0x060 WaitListEntry    : _LIST_ENTRY</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>   +0x060 SwapListEntry    : _SINGLE_LIST_ENTRY</pre></td></tr></table></figure><p>_KTHREAD + 0x60 是一个共用体 union，线程处于等待或者调度状态就会存到这个位置的链表里，如果是等待状态，这个地方就是等待链表；如果是调度状态，这里就是调度链表。</p>\n<h2 id=\"running运行中\"><a class=\"anchor\" href=\"#running运行中\">#</a> running（运行中）</h2>\n<p>一个核只有一个运行中的线程，运行中的线程存储在 KPCR 中。</p>\n<h2 id=\"ready就绪等待调度\"><a class=\"anchor\" href=\"#ready就绪等待调度\">#</a> ready（就绪，等待调度）</h2>\n<p>所有就绪线程根据 32 个不同的优先级，各自存储在 32 个链表中。</p>\n<p>通过全局变量  <code>KiDispatcherReadyListHead</code>  可以查看这 32 个链表的链表头：</p>\n<figure class=\"highlight raw\"><figcaption data-lang=\"\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>kd&gt; dd KiDispatcherReadyListHead L70</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>8055df80  8055df80 8055df80 8055df88 8055df88</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>8055df90  8055df90 8055df90 8055df98 8055df98</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>8055dfa0  8055dfa0 8055dfa0 8055dfa8 8055dfa8</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>8055dfb0  8055dfb0 8055dfb0 8055dfb8 8055dfb8</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>8055dfc0  8055dfc0 8055dfc0 8055dfc8 8055dfc8</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>8055dfd0  8055dfd0 8055dfd0 8055dfd8 8055dfd8</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>8055dfe0  8055dfe0 8055dfe0 8055dfe8 8055dfe8</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>8055dff0  8055dff0 8055dff0 8055dff8 8055dff8</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>8055e000  8055e000 8055e000 8055e008 8055e008</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>8055e010  8055e010 8055e010 8055e018 8055e018</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>8055e020  8055e020 8055e020 8055e028 8055e028</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>8055e030  8055e030 8055e030 8055e038 8055e038</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>8055e040  8055e040 8055e040 8055e048 8055e048</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>8055e050  8055e050 8055e050 8055e058 8055e058</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>8055e060  8055e060 8055e060 8055e068 8055e068</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>8055e070  8055e070 8055e070 8055e078 8055e078</pre></td></tr></table></figure><p>每两个 4 字节就构成了一个 LIST_ENTRY，我们发现这里 32 个链表都是空的，原因是现在 windbg 把系统挂起了，所有线程都处于等待状态，不能被调度了。</p>\n<p>32 个链表对应 32 个优先级 0-31，默认优先级是 8，优先级越高越优先。我推测空闲线程 IdleThread 的优先级是最低的。</p>\n<h1 id=\"总结\"><a class=\"anchor\" href=\"#总结\">#</a> 总结</h1>\n<p>那些所谓的进程隐藏、线程隐藏都不可能彻底隐藏起来，比拼的是谁更底层罢了。通过遍历这两个链表就可以找到所有进程和线程了。一旦把这两个链表断链，那么进程和线程就不会被操作系统维护，也就不会运行了。</p>\n",
            "tags": [
                "等待链表",
                "调度链表"
            ]
        },
        {
            "id": "https://or0kit.github.io/Bin/Core/WindowsXp/Process-Thread/%E8%BF%9B%E7%A8%8B%E4%B8%8E%E7%BA%BF%E7%A8%8B-KPCR/",
            "url": "https://or0kit.github.io/Bin/Core/WindowsXp/Process-Thread/%E8%BF%9B%E7%A8%8B%E4%B8%8E%E7%BA%BF%E7%A8%8B-KPCR/",
            "title": "进程与线程-KPCR",
            "date_published": "2022-01-11T08:42:21.000Z",
            "content_html": "<h1 id=\"内容回顾\"><a class=\"anchor\" href=\"#内容回顾\">#</a> 内容回顾</h1>\n<p>进程在内核中对应结构体：  <code>EPROCESS</code></p>\n<p>线程在内核中对应结构体：  <code>ETHREAD</code></p>\n<p>CPU 在内核中也有一个对应的结构体，每一个 CPU 有一个，叫  <code>KPCR\t</code></p>\n<h1 id=\"kpcr介绍\"><a class=\"anchor\" href=\"#kpcr介绍\">#</a> KPCR 介绍</h1>\n<ol>\n<li>\n<p>当线程进入 0 环时，FS:[0] 指向 KPCR (3 环时 FS:[0] -&gt; TEB)</p>\n</li>\n<li>\n<p>每个 CPU 都有一个 KPCR 结构体 (一个核一个)</p>\n</li>\n<li>\n<p>KPCR 中存储了 CPU 本身要用的一些重要数据：GDT、IDT 以及线程相关的一些信息。</p>\n</li>\n</ol>\n<h1 id=\"_kpcr-_nt_tib-_kprcb\"><a class=\"anchor\" href=\"#_kpcr-_nt_tib-_kprcb\">#</a> _KPCR, _NT_TIB, _KPRCB</h1>\n<p>KPCR  叫 CPU 控制区（Processor Control Region）</p>\n<p><img data-src=\"image001.png\" alt=\"\" /></p>\n<h2 id=\"_nt_tib-是-_kpcr-的前-0x1c-字节\"><a class=\"anchor\" href=\"#_nt_tib-是-_kpcr-的前-0x1c-字节\">#</a> _NT_TIB 是 _KPCR 的前 0x1c 字节</h2>\n<figure class=\"highlight raw\"><figcaption data-lang=\"\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>ntdll!_NT_TIB</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>   +0x000 ExceptionList    : Ptr32 _EXCEPTION_REGISTRATION_RECORD</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>\t异常链表，执行到 _try _catch 时，会在这个链表里添加异常处理函数</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>   +0x004 StackBase        : Ptr32 Void</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>   +0x008 StackLimit       : Ptr32 Void</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>   0 环当前线程的栈基址和栈大小</pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>   +0x00c SubSystemTib     : Ptr32 Void</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>   +0x010 FiberData        : Ptr32 Void</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>   +0x010 Version          : Uint4B</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>   +0x014 ArbitraryUserPointer : Ptr32 Void</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>   </pre></td></tr><tr><td data-num=\"14\"></td><td><pre>   +0x018 Self             : Ptr32 _NT_TIB</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>   指向自己的指针</pre></td></tr></table></figure><h2 id=\"_kpcr\"><a class=\"anchor\" href=\"#_kpcr\">#</a> _KPCR</h2>\n<figure class=\"highlight raw\"><figcaption data-lang=\"\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>nt!_KPCR</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>   +0x000 NtTib            : _NT_TIB</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>   +0x01c SelfPcr          : Ptr32 _KPCR</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>   指向自己的指针</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>   </pre></td></tr><tr><td data-num=\"6\"></td><td><pre>   +0x020 Prcb             : Ptr32 _KPRCB</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>   指向 _KPRCB，即 _KPCR + 0x120 偏移处的结构</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>   </pre></td></tr><tr><td data-num=\"9\"></td><td><pre>   +0x024 Irql             : UChar</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>   +0x028 IRR              : Uint4B</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>   +0x02c IrrActive        : Uint4B</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>   +0x030 IDR              : Uint4B</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>   +0x034 KdVersionBlock   : Ptr32 Void</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>   +0x038 IDT              : Ptr32 _KIDTENTRY</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>   +0x03c GDT              : Ptr32 _KGDTENTRY</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>   IDT, GDT 表基址</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>   </pre></td></tr><tr><td data-num=\"18\"></td><td><pre>   +0x040 TSS              : Ptr32 _KTSS</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>   指向 TSS 表，里面存储了 0 环栈顶 ESP0 和 0 环堆栈段 SS0，中断门提权要用</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>   </pre></td></tr><tr><td data-num=\"21\"></td><td><pre>   +0x044 MajorVersion     : Uint2B</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>   +0x046 MinorVersion     : Uint2B</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>   +0x048 SetMember        : Uint4B</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>   +0x04c StallScaleFactor : Uint4B</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>   +0x050 DebugActive      : UChar</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>   +0x051 Number           : UChar</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>   CPU 编号</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>   </pre></td></tr><tr><td data-num=\"29\"></td><td><pre>   +0x052 Spare0           : UChar</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>   +0x053 SecondLevelCacheAssociativity : UChar</pre></td></tr><tr><td data-num=\"31\"></td><td><pre>   +0x054 VdmAlert         : Uint4B</pre></td></tr><tr><td data-num=\"32\"></td><td><pre>   +0x058 KernelReserved   : [14] Uint4B</pre></td></tr><tr><td data-num=\"33\"></td><td><pre>   +0x090 SecondLevelCacheSize : Uint4B</pre></td></tr><tr><td data-num=\"34\"></td><td><pre>   +0x094 HalReserved      : [16] Uint4B</pre></td></tr><tr><td data-num=\"35\"></td><td><pre>   +0x0d4 InterruptMode    : Uint4B</pre></td></tr><tr><td data-num=\"36\"></td><td><pre>   +0x0d8 Spare1           : UChar</pre></td></tr><tr><td data-num=\"37\"></td><td><pre>   +0x0dc KernelReserved2  : [17] Uint4B</pre></td></tr><tr><td data-num=\"38\"></td><td><pre>   +0x120 PrcbData         : _KPRCB</pre></td></tr><tr><td data-num=\"39\"></td><td><pre>   扩展结构体</pre></td></tr></table></figure><h2 id=\"_kprcb\"><a class=\"anchor\" href=\"#_kprcb\">#</a> _KPRCB</h2>\n<figure class=\"highlight raw\"><figcaption data-lang=\"\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>ntdll!_KPRCB</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>   +0x000 MinorVersion     : Uint2B</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>   +0x002 MajorVersion     : Uint2B</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>   +0x004 CurrentThread    : Ptr32 _KTHREAD</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>   当前线程</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>   </pre></td></tr><tr><td data-num=\"7\"></td><td><pre>   +0x008 NextThread       : Ptr32 _KTHREAD</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>   即将切换的下一个线程</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>   </pre></td></tr><tr><td data-num=\"10\"></td><td><pre>   +0x00c IdleThread       : Ptr32 _KTHREAD</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>   空闲线程 &#x2F;&#x2F; 所有线程都执行完了，CPU 就致执行这个</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>   </pre></td></tr><tr><td data-num=\"13\"></td><td><pre>   +0x010 Number           : Char</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>   CPU 编号</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>   </pre></td></tr><tr><td data-num=\"16\"></td><td><pre>   +0x011 Reserved         : Char</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>   +0x012 BuildType        : Uint2B</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>   +0x014 SetMember        : Uint4B</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>   +0x018 CpuType          : Char</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>   +0x019 CpuID            : Char</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>   +0x01a CpuStep          : Uint2B</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>   +0x01c ProcessorState   : _KPROCESSOR_STATE</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>   +0x33c KernelReserved   : [16] Uint4B</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>   +0x37c HalReserved      : [16] Uint4B</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>   +0x3bc PrcbPad0         : [92] UChar</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>   +0x418 LockQueue        : [16] _KSPIN_LOCK_QUEUE</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>   +0x498 PrcbPad1         : [8] UChar</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>   +0x4a0 NpxThread        : Ptr32 _KTHREAD</pre></td></tr><tr><td data-num=\"29\"></td><td><pre>   +0x4a4 InterruptCount   : Uint4B</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>   +0x4a8 KernelTime       : Uint4B</pre></td></tr><tr><td data-num=\"31\"></td><td><pre>   +0x4ac UserTime         : Uint4B</pre></td></tr><tr><td data-num=\"32\"></td><td><pre>   +0x4b0 DpcTime          : Uint4B</pre></td></tr><tr><td data-num=\"33\"></td><td><pre>   +0x4b4 DebugDpcTime     : Uint4B</pre></td></tr><tr><td data-num=\"34\"></td><td><pre>   +0x4b8 InterruptTime    : Uint4B</pre></td></tr><tr><td data-num=\"35\"></td><td><pre>   +0x4bc AdjustDpcThreshold : Uint4B</pre></td></tr><tr><td data-num=\"36\"></td><td><pre>   +0x4c0 PageColor        : Uint4B</pre></td></tr><tr><td data-num=\"37\"></td><td><pre>   +0x4c4 SkipTick         : Uint4B</pre></td></tr><tr><td data-num=\"38\"></td><td><pre>   +0x4c8 MultiThreadSetBusy : UChar</pre></td></tr><tr><td data-num=\"39\"></td><td><pre>   +0x4c9 Spare2           : [3] UChar</pre></td></tr><tr><td data-num=\"40\"></td><td><pre>   +0x4cc ParentNode       : Ptr32 _KNODE</pre></td></tr><tr><td data-num=\"41\"></td><td><pre>   +0x4d0 MultiThreadProcessorSet : Uint4B</pre></td></tr><tr><td data-num=\"42\"></td><td><pre>   +0x4d4 MultiThreadSetMaster : Ptr32 _KPRCB</pre></td></tr><tr><td data-num=\"43\"></td><td><pre>   +0x4d8 ThreadStartCount : [2] Uint4B</pre></td></tr><tr><td data-num=\"44\"></td><td><pre>   +0x4e0 CcFastReadNoWait : Uint4B</pre></td></tr><tr><td data-num=\"45\"></td><td><pre>   +0x4e4 CcFastReadWait   : Uint4B</pre></td></tr><tr><td data-num=\"46\"></td><td><pre>   +0x4e8 CcFastReadNotPossible : Uint4B</pre></td></tr><tr><td data-num=\"47\"></td><td><pre>   +0x4ec CcCopyReadNoWait : Uint4B</pre></td></tr><tr><td data-num=\"48\"></td><td><pre>   +0x4f0 CcCopyReadWait   : Uint4B</pre></td></tr><tr><td data-num=\"49\"></td><td><pre>   +0x4f4 CcCopyReadNoWaitMiss : Uint4B</pre></td></tr><tr><td data-num=\"50\"></td><td><pre>   +0x4f8 KeAlignmentFixupCount : Uint4B</pre></td></tr><tr><td data-num=\"51\"></td><td><pre>   +0x4fc KeContextSwitches : Uint4B</pre></td></tr><tr><td data-num=\"52\"></td><td><pre>   +0x500 KeDcacheFlushCount : Uint4B</pre></td></tr><tr><td data-num=\"53\"></td><td><pre>   +0x504 KeExceptionDispatchCount : Uint4B</pre></td></tr><tr><td data-num=\"54\"></td><td><pre>   +0x508 KeFirstLevelTbFills : Uint4B</pre></td></tr><tr><td data-num=\"55\"></td><td><pre>   +0x50c KeFloatingEmulationCount : Uint4B</pre></td></tr><tr><td data-num=\"56\"></td><td><pre>   +0x510 KeIcacheFlushCount : Uint4B</pre></td></tr><tr><td data-num=\"57\"></td><td><pre>   +0x514 KeSecondLevelTbFills : Uint4B</pre></td></tr><tr><td data-num=\"58\"></td><td><pre>   +0x518 KeSystemCalls    : Uint4B</pre></td></tr><tr><td data-num=\"59\"></td><td><pre>   +0x51c SpareCounter0    : [1] Uint4B</pre></td></tr><tr><td data-num=\"60\"></td><td><pre>   +0x520 PPLookasideList  : [16] _PP_LOOKASIDE_LIST</pre></td></tr><tr><td data-num=\"61\"></td><td><pre>   +0x5a0 PPNPagedLookasideList : [32] _PP_LOOKASIDE_LIST</pre></td></tr><tr><td data-num=\"62\"></td><td><pre>   +0x6a0 PPPagedLookasideList : [32] _PP_LOOKASIDE_LIST</pre></td></tr><tr><td data-num=\"63\"></td><td><pre>   +0x7a0 PacketBarrier    : Uint4B</pre></td></tr><tr><td data-num=\"64\"></td><td><pre>   +0x7a4 ReverseStall     : Uint4B</pre></td></tr><tr><td data-num=\"65\"></td><td><pre>   +0x7a8 IpiFrame         : Ptr32 Void</pre></td></tr><tr><td data-num=\"66\"></td><td><pre>   +0x7ac PrcbPad2         : [52] UChar</pre></td></tr><tr><td data-num=\"67\"></td><td><pre>   +0x7e0 CurrentPacket    : [3] Ptr32 Void</pre></td></tr><tr><td data-num=\"68\"></td><td><pre>   +0x7ec TargetSet        : Uint4B</pre></td></tr><tr><td data-num=\"69\"></td><td><pre>   +0x7f0 WorkerRoutine    : Ptr32     void </pre></td></tr><tr><td data-num=\"70\"></td><td><pre>   +0x7f4 IpiFrozen        : Uint4B</pre></td></tr><tr><td data-num=\"71\"></td><td><pre>   +0x7f8 PrcbPad3         : [40] UChar</pre></td></tr><tr><td data-num=\"72\"></td><td><pre>   +0x820 RequestSummary   : Uint4B</pre></td></tr><tr><td data-num=\"73\"></td><td><pre>   +0x824 SignalDone       : Ptr32 _KPRCB</pre></td></tr><tr><td data-num=\"74\"></td><td><pre>   +0x828 PrcbPad4         : [56] UChar</pre></td></tr><tr><td data-num=\"75\"></td><td><pre>   +0x860 DpcListHead      : _LIST_ENTRY</pre></td></tr><tr><td data-num=\"76\"></td><td><pre>   +0x868 DpcStack         : Ptr32 Void</pre></td></tr><tr><td data-num=\"77\"></td><td><pre>   +0x86c DpcCount         : Uint4B</pre></td></tr><tr><td data-num=\"78\"></td><td><pre>   +0x870 DpcQueueDepth    : Uint4B</pre></td></tr><tr><td data-num=\"79\"></td><td><pre>   +0x874 DpcRoutineActive : Uint4B</pre></td></tr><tr><td data-num=\"80\"></td><td><pre>   +0x878 DpcInterruptRequested : Uint4B</pre></td></tr><tr><td data-num=\"81\"></td><td><pre>   +0x87c DpcLastCount     : Uint4B</pre></td></tr><tr><td data-num=\"82\"></td><td><pre>   +0x880 DpcRequestRate   : Uint4B</pre></td></tr><tr><td data-num=\"83\"></td><td><pre>   +0x884 MaximumDpcQueueDepth : Uint4B</pre></td></tr><tr><td data-num=\"84\"></td><td><pre>   +0x888 MinimumDpcRate   : Uint4B</pre></td></tr><tr><td data-num=\"85\"></td><td><pre>   +0x88c QuantumEnd       : Uint4B</pre></td></tr><tr><td data-num=\"86\"></td><td><pre>   +0x890 PrcbPad5         : [16] UChar</pre></td></tr><tr><td data-num=\"87\"></td><td><pre>   +0x8a0 DpcLock          : Uint4B</pre></td></tr><tr><td data-num=\"88\"></td><td><pre>   +0x8a4 PrcbPad6         : [28] UChar</pre></td></tr><tr><td data-num=\"89\"></td><td><pre>   +0x8c0 CallDpc          : _KDPC</pre></td></tr><tr><td data-num=\"90\"></td><td><pre>   +0x8e0 ChainedInterruptList : Ptr32 Void</pre></td></tr><tr><td data-num=\"91\"></td><td><pre>   +0x8e4 LookasideIrpFloat : Int4B</pre></td></tr><tr><td data-num=\"92\"></td><td><pre>   +0x8e8 SpareFields0     : [6] Uint4B</pre></td></tr><tr><td data-num=\"93\"></td><td><pre>   +0x900 VendorString     : [13] UChar</pre></td></tr><tr><td data-num=\"94\"></td><td><pre>   +0x90d InitialApicId    : UChar</pre></td></tr><tr><td data-num=\"95\"></td><td><pre>   +0x90e LogicalProcessorsPerPhysicalProcessor : UChar</pre></td></tr><tr><td data-num=\"96\"></td><td><pre>   +0x910 MHz              : Uint4B</pre></td></tr><tr><td data-num=\"97\"></td><td><pre>   +0x914 FeatureBits      : Uint4B</pre></td></tr><tr><td data-num=\"98\"></td><td><pre>   +0x918 UpdateSignature  : _LARGE_INTEGER</pre></td></tr><tr><td data-num=\"99\"></td><td><pre>   +0x920 NpxSaveArea      : _FX_SAVE_AREA</pre></td></tr><tr><td data-num=\"100\"></td><td><pre>   +0xb30 PowerState       : _PROCESSOR_POWER_STATE</pre></td></tr></table></figure><h1 id=\"reference\"><a class=\"anchor\" href=\"#reference\">#</a> Reference</h1>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L0t3YW5zeS9hcnRpY2xlL2RldGFpbHMvMTA5NTQ1NDI5\">https://blog.csdn.net/Kwansy/article/details/109545429</span></p>\n",
            "tags": [
                "KPCR结构体"
            ]
        },
        {
            "id": "https://or0kit.github.io/Bin/Core/WindowsXp/Process-Thread/%E8%BF%9B%E7%A8%8B%E4%B8%8E%E7%BA%BF%E7%A8%8B-%E7%BA%BF%E7%A8%8B%E7%BB%93%E6%9E%84%E4%BD%93/",
            "url": "https://or0kit.github.io/Bin/Core/WindowsXp/Process-Thread/%E8%BF%9B%E7%A8%8B%E4%B8%8E%E7%BA%BF%E7%A8%8B-%E7%BA%BF%E7%A8%8B%E7%BB%93%E6%9E%84%E4%BD%93/",
            "title": "进程与线程-线程结构体",
            "date_published": "2022-01-01T00:53:34.000Z",
            "content_html": "<h1 id=\"线程\"><a class=\"anchor\" href=\"#线程\">#</a> 线程</h1>\n<p>Windows 是一款微内核、抢占式多任务、软实时的操作系统。<strong>Windows 的任务调度主要以线程为单位进行</strong>，线程拥有 33 个优先级，数值为 0~32，其中 0 为最低优先级，32 为最高优先级，最高和最低优先级均保留给系统使用。用户可以使用的优先级为 1～31。</p>\n<h1 id=\"线程结构体-ethread\"><a class=\"anchor\" href=\"#线程结构体-ethread\">#</a> 线程结构体 ETHREAD</h1>\n<figure class=\"highlight raw\"><figcaption data-lang=\"\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>kd&gt; dt _ETHREAD</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>nt!_ETHREAD</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>   +0x000 Tcb              : _KTHREAD</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>   +0x1c0 CreateTime       : _LARGE_INTEGER</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>   +0x1c0 NestedFaultCount : Pos 0, 2 Bits</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>   +0x1c0 ApcNeeded        : Pos 2, 1 Bit</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>   +0x1c8 ExitTime         : _LARGE_INTEGER</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>   +0x1c8 LpcReplyChain    : _LIST_ENTRY</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>   +0x1c8 KeyedWaitChain   : _LIST_ENTRY</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>   +0x1d0 ExitStatus       : Int4B</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>   +0x1d0 OfsChain         : Ptr32 Void</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>   +0x1d4 PostBlockList    : _LIST_ENTRY</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>   +0x1dc TerminationPort  : Ptr32 _TERMINATION_PORT</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>   +0x1dc ReaperLink       : Ptr32 _ETHREAD</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>   +0x1dc KeyedWaitValue   : Ptr32 Void</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>   +0x1e0 ActiveTimerListLock : Uint4B</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>   +0x1e4 ActiveTimerListHead : _LIST_ENTRY</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>   +0x1ec Cid              : _CLIENT_ID</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>   +0x1f4 LpcReplySemaphore : _KSEMAPHORE</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>   +0x1f4 KeyedWaitSemaphore : _KSEMAPHORE</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>   +0x208 LpcReplyMessage  : Ptr32 Void</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>   +0x208 LpcWaitingOnPort : Ptr32 Void</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>   +0x20c ImpersonationInfo : Ptr32 _PS_IMPERSONATION_INFORMATION</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>   +0x210 IrpList          : _LIST_ENTRY</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>   +0x218 TopLevelIrp      : Uint4B</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>   +0x21c DeviceToVerify   : Ptr32 _DEVICE_OBJECT</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>   +0x220 ThreadsProcess   : Ptr32 _EPROCESS</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>   +0x224 StartAddress     : Ptr32 Void</pre></td></tr><tr><td data-num=\"29\"></td><td><pre>   +0x228 Win32StartAddress : Ptr32 Void</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>   +0x228 LpcReceivedMessageId : Uint4B</pre></td></tr><tr><td data-num=\"31\"></td><td><pre>   +0x22c ThreadListEntry  : _LIST_ENTRY</pre></td></tr><tr><td data-num=\"32\"></td><td><pre>   +0x234 RundownProtect   : _EX_RUNDOWN_REF</pre></td></tr><tr><td data-num=\"33\"></td><td><pre>   +0x238 ThreadLock       : _EX_PUSH_LOCK</pre></td></tr><tr><td data-num=\"34\"></td><td><pre>   +0x23c LpcReplyMessageId : Uint4B</pre></td></tr><tr><td data-num=\"35\"></td><td><pre>   +0x240 ReadClusterSize  : Uint4B</pre></td></tr><tr><td data-num=\"36\"></td><td><pre>   +0x244 GrantedAccess    : Uint4B</pre></td></tr><tr><td data-num=\"37\"></td><td><pre>   +0x248 CrossThreadFlags : Uint4B</pre></td></tr><tr><td data-num=\"38\"></td><td><pre>   +0x248 Terminated       : Pos 0, 1 Bit</pre></td></tr><tr><td data-num=\"39\"></td><td><pre>   +0x248 DeadThread       : Pos 1, 1 Bit</pre></td></tr><tr><td data-num=\"40\"></td><td><pre>   +0x248 HideFromDebugger : Pos 2, 1 Bit</pre></td></tr><tr><td data-num=\"41\"></td><td><pre>   +0x248 ActiveImpersonationInfo : Pos 3, 1 Bit</pre></td></tr><tr><td data-num=\"42\"></td><td><pre>   +0x248 SystemThread     : Pos 4, 1 Bit</pre></td></tr><tr><td data-num=\"43\"></td><td><pre>   +0x248 HardErrorsAreDisabled : Pos 5, 1 Bit</pre></td></tr><tr><td data-num=\"44\"></td><td><pre>   +0x248 BreakOnTermination : Pos 6, 1 Bit</pre></td></tr><tr><td data-num=\"45\"></td><td><pre>   +0x248 SkipCreationMsg  : Pos 7, 1 Bit</pre></td></tr><tr><td data-num=\"46\"></td><td><pre>   +0x248 SkipTerminationMsg : Pos 8, 1 Bit</pre></td></tr><tr><td data-num=\"47\"></td><td><pre>   +0x24c SameThreadPassiveFlags : Uint4B</pre></td></tr><tr><td data-num=\"48\"></td><td><pre>   +0x24c ActiveExWorker   : Pos 0, 1 Bit</pre></td></tr><tr><td data-num=\"49\"></td><td><pre>   +0x24c ExWorkerCanWaitUser : Pos 1, 1 Bit</pre></td></tr><tr><td data-num=\"50\"></td><td><pre>   +0x24c MemoryMaker      : Pos 2, 1 Bit</pre></td></tr><tr><td data-num=\"51\"></td><td><pre>   +0x250 SameThreadApcFlags : Uint4B</pre></td></tr><tr><td data-num=\"52\"></td><td><pre>   +0x250 LpcReceivedMsgIdValid : Pos 0, 1 Bit</pre></td></tr><tr><td data-num=\"53\"></td><td><pre>   +0x250 LpcExitThreadCalled : Pos 1, 1 Bit</pre></td></tr><tr><td data-num=\"54\"></td><td><pre>   +0x250 AddressSpaceOwner : Pos 2, 1 Bit</pre></td></tr><tr><td data-num=\"55\"></td><td><pre>   +0x254 ForwardClusterOnly : UChar</pre></td></tr><tr><td data-num=\"56\"></td><td><pre>   +0x255 DisablePageFaultClustering : UChar</pre></td></tr><tr><td data-num=\"57\"></td><td><pre>   +0x258 KernelStackReference : Uint4B</pre></td></tr></table></figure><p>其中第一个成员也是一个结构体 _KTHREAD</p>\n<figure class=\"highlight raw\"><figcaption data-lang=\"\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>kd&gt; dt _KTHREAD</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>nt!_KTHREAD</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>   +0x000 Header           : _DISPATCHER_HEADER</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>   +0x010 MutantListHead   : _LIST_ENTRY</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>   +0x018 InitialStack     : Ptr32 Void</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>   +0x01c StackLimit       : Ptr32 Void</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>   +0x020 Teb              : Ptr32 Void</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>   +0x024 TlsArray         : Ptr32 Void</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>   +0x028 KernelStack      : Ptr32 Void</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>   +0x02c DebugActive      : UChar</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>   +0x02d State            : UChar</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>   +0x02e Alerted          : [2] UChar</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>   +0x030 Iopl             : UChar</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>   +0x031 NpxState         : UChar</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>   +0x032 Saturation       : Char</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>   +0x033 Priority         : Char</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>   +0x034 ApcState         : _KAPC_STATE</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>   +0x04c ContextSwitches  : Uint4B</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>   +0x050 IdleSwapBlock    : UChar</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>   +0x051 VdmSafe          : UChar</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>   +0x052 Spare0           : [2] UChar</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>   +0x054 WaitStatus       : Int4B</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>   +0x058 WaitIrql         : UChar</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>   +0x059 WaitMode         : Char</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>   +0x05a WaitNext         : UChar</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>   +0x05b WaitReason       : UChar</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>   +0x05c WaitBlockList    : Ptr32 _KWAIT_BLOCK</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>   +0x060 WaitListEntry    : _LIST_ENTRY</pre></td></tr><tr><td data-num=\"29\"></td><td><pre>   +0x060 SwapListEntry    : _SINGLE_LIST_ENTRY</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>   +0x068 WaitTime         : Uint4B</pre></td></tr><tr><td data-num=\"31\"></td><td><pre>   +0x06c BasePriority     : Char</pre></td></tr><tr><td data-num=\"32\"></td><td><pre>   +0x06d DecrementCount   : UChar</pre></td></tr><tr><td data-num=\"33\"></td><td><pre>   +0x06e PriorityDecrement : Char</pre></td></tr><tr><td data-num=\"34\"></td><td><pre>   +0x06f Quantum          : Char</pre></td></tr><tr><td data-num=\"35\"></td><td><pre>   +0x070 WaitBlock        : [4] _KWAIT_BLOCK</pre></td></tr><tr><td data-num=\"36\"></td><td><pre>   +0x0d0 LegoData         : Ptr32 Void</pre></td></tr><tr><td data-num=\"37\"></td><td><pre>   +0x0d4 KernelApcDisable : Uint4B</pre></td></tr><tr><td data-num=\"38\"></td><td><pre>   +0x0d8 UserAffinity     : Uint4B</pre></td></tr><tr><td data-num=\"39\"></td><td><pre>   +0x0dc SystemAffinityActive : UChar</pre></td></tr><tr><td data-num=\"40\"></td><td><pre>   +0x0dd PowerState       : UChar</pre></td></tr><tr><td data-num=\"41\"></td><td><pre>   +0x0de NpxIrql          : UChar</pre></td></tr><tr><td data-num=\"42\"></td><td><pre>   +0x0df InitialNode      : UChar</pre></td></tr><tr><td data-num=\"43\"></td><td><pre>   +0x0e0 ServiceTable     : Ptr32 Void</pre></td></tr><tr><td data-num=\"44\"></td><td><pre>   +0x0e4 Queue            : Ptr32 _KQUEUE</pre></td></tr><tr><td data-num=\"45\"></td><td><pre>   +0x0e8 ApcQueueLock     : Uint4B</pre></td></tr><tr><td data-num=\"46\"></td><td><pre>   +0x0f0 Timer            : _KTIMER</pre></td></tr><tr><td data-num=\"47\"></td><td><pre>   +0x118 QueueListEntry   : _LIST_ENTRY</pre></td></tr><tr><td data-num=\"48\"></td><td><pre>   +0x120 SoftAffinity     : Uint4B</pre></td></tr><tr><td data-num=\"49\"></td><td><pre>   +0x124 Affinity         : Uint4B</pre></td></tr><tr><td data-num=\"50\"></td><td><pre>   +0x128 Preempted        : UChar</pre></td></tr><tr><td data-num=\"51\"></td><td><pre>   +0x129 ProcessReadyQueue : UChar</pre></td></tr><tr><td data-num=\"52\"></td><td><pre>   +0x12a KernelStackResident : UChar</pre></td></tr><tr><td data-num=\"53\"></td><td><pre>   +0x12b NextProcessor    : UChar</pre></td></tr><tr><td data-num=\"54\"></td><td><pre>   +0x12c CallbackStack    : Ptr32 Void</pre></td></tr><tr><td data-num=\"55\"></td><td><pre>   +0x130 Win32Thread      : Ptr32 Void</pre></td></tr><tr><td data-num=\"56\"></td><td><pre>   +0x134 TrapFrame        : Ptr32 _KTRAP_FRAME</pre></td></tr><tr><td data-num=\"57\"></td><td><pre>   +0x138 ApcStatePointer  : [2] Ptr32 _KAPC_STATE</pre></td></tr><tr><td data-num=\"58\"></td><td><pre>   +0x140 PreviousMode     : Char</pre></td></tr><tr><td data-num=\"59\"></td><td><pre>   +0x141 EnableStackSwap  : UChar</pre></td></tr><tr><td data-num=\"60\"></td><td><pre>   +0x142 LargeStack       : UChar</pre></td></tr><tr><td data-num=\"61\"></td><td><pre>   +0x143 ResourceIndex    : UChar</pre></td></tr><tr><td data-num=\"62\"></td><td><pre>   +0x144 KernelTime       : Uint4B</pre></td></tr><tr><td data-num=\"63\"></td><td><pre>   +0x148 UserTime         : Uint4B</pre></td></tr><tr><td data-num=\"64\"></td><td><pre>   +0x14c SavedApcState    : _KAPC_STATE</pre></td></tr><tr><td data-num=\"65\"></td><td><pre>   +0x164 Alertable        : UChar</pre></td></tr><tr><td data-num=\"66\"></td><td><pre>   +0x165 ApcStateIndex    : UChar</pre></td></tr><tr><td data-num=\"67\"></td><td><pre>   +0x166 ApcQueueable     : UChar</pre></td></tr><tr><td data-num=\"68\"></td><td><pre>   +0x167 AutoAlignment    : UChar</pre></td></tr><tr><td data-num=\"69\"></td><td><pre>   +0x168 StackBase        : Ptr32 Void</pre></td></tr><tr><td data-num=\"70\"></td><td><pre>   +0x16c SuspendApc       : _KAPC</pre></td></tr><tr><td data-num=\"71\"></td><td><pre>   +0x19c SuspendSemaphore : _KSEMAPHORE</pre></td></tr><tr><td data-num=\"72\"></td><td><pre>   +0x1b0 ThreadListEntry  : _LIST_ENTRY</pre></td></tr><tr><td data-num=\"73\"></td><td><pre>   +0x1b8 FreezeCount      : Char</pre></td></tr><tr><td data-num=\"74\"></td><td><pre>   +0x1b9 SuspendCount     : Char</pre></td></tr><tr><td data-num=\"75\"></td><td><pre>   +0x1ba IdealProcessor   : UChar</pre></td></tr><tr><td data-num=\"76\"></td><td><pre>   +0x1bb DisableBoost     : UChar</pre></td></tr></table></figure><h2 id=\"kthread-主要成员\"><a class=\"anchor\" href=\"#kthread-主要成员\">#</a> KTHREAD 主要成员</h2>\n<ol>\n<li><strong>+0x000 Header : _DISPATCHER_HEADER</strong></li>\n</ol>\n<p>和 KPROCESS 类似，开头是一个 Header，拥有此属性的内核对象可以 “被等待”（WaitForSingleObject）</p>\n<ol start=\"2\">\n<li><strong>+0x018 InitialStack : Ptr32 Void<br />\n+0x01c StackLimit : Ptr32 Void<br />\n+0x028 KernelStack : Ptr32 Void</strong></li>\n</ol>\n<p>线程切换相关</p>\n<p>InitialStack 初始栈顶，也可以理解成 ebp0<br />\nStackLimit 栈的大小<br />\n KernelStack 线程切换时，旧线程的 esp0 存到它的 KernelStack，然后把新线程的 KernelStack 写到 TSS</p>\n<ol start=\"3\">\n<li><strong>+0x020 Teb : Ptr32 Void</strong></li>\n</ol>\n<p>TEB，Thread Environment Block，线程环境块。<br />\n大小 4KB, 位于用户地址空间。<br />\n3 环可以通过 FS:[0] 找到 TEB</p>\n<ol start=\"4\">\n<li><strong>+0x02c DebugActive : UChar</strong></li>\n</ol>\n<p>是否处于调试状态</p>\n<ol start=\"5\">\n<li><strong>+0x034 ApcState : _KAPC_STATE</strong><br />\n<strong>+0x0e8 ApcQueueLock : Uint4B</strong><br />\n<strong>+0x138 ApcStatePointer : [2] Ptr32 _KAPC_STATE</strong><br />\n<strong>+0x14c SavedApcState : _KAPC_STATE</strong></li>\n</ol>\n<p>APC 相关属性。其中 **+0x034 ApcState : _KAPC_STATE** 的结构如下：</p>\n<figure class=\"highlight raw\"><figcaption data-lang=\"\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>kd&gt; dt _KAPC_STATE</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>nt!_KAPC_STATE</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>   +0x000 ApcListHead      : [2] _LIST_ENTRY</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>   +0x010 Process          : Ptr32 _KPROCESS</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>   +0x014 KernelApcInProgress : UChar</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>   +0x015 KernelApcPending : UChar</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>   +0x016 UserApcPending   : UChar</pre></td></tr></table></figure><p>故在  <code>+0x44</code>  的位置是当前线程的进程结构体  <code>EPROCESS</code>  的地址</p>\n<ol start=\"6\">\n<li><strong>+0x02d State : UChar</strong></li>\n</ol>\n<p>线程状态：就绪、等待、运行。</p>\n<ol start=\"7\">\n<li><strong>+0x06c BasePriority : Char</strong></li>\n</ol>\n<p>其初始值是所属进程的 BasePriority 值 (KPROCESS-&gt;BasePriority)，以后可以通过 KeSetBasePriorityThread () 函数重新设定</p>\n<ol start=\"8\">\n<li><strong>+0x070 WaitBlock : [4] _KWAIT_BLOCK</strong></li>\n</ol>\n<p>等待哪个对象（WaitForSingleObject）</p>\n<ol start=\"9\">\n<li><strong>+0x0e0 ServiceTable : Ptr32 Void</strong></li>\n</ol>\n<p>指向系统服务表基址</p>\n<ol start=\"10\">\n<li><strong>+0x134 TrapFrame</strong></li>\n</ol>\n<p>进 0 环时保存环境</p>\n<ol start=\"11\">\n<li><strong>+0x140 PreviousMode : Char</strong></li>\n</ol>\n<p>某些内核函数会判断程序是 0 环调用还是 3 环调用的</p>\n<ol start=\"12\">\n<li><strong>+0x1b0 ThreadListEntry : _LIST_ENTRY</strong></li>\n</ol>\n<p>双向链表，一个进程所有的线程都挂在一个链表中，挂的就是这个位置，有两个这样的链表</p>\n<p><img data-src=\"image001.png\" alt=\"\" /></p>\n<h2 id=\"_ethread-主要成员\"><a class=\"anchor\" href=\"#_ethread-主要成员\">#</a> _ETHREAD 主要成员</h2>\n<ol>\n<li><strong>+0x1ec Cid : _CLIENT_ID</strong></li>\n</ol>\n<p>进程 ID、线程 ID</p>\n<ol start=\"2\">\n<li><strong>+0x220 ThreadsProcess : Ptr32 _EPROCESS</strong></li>\n</ol>\n<p>指向自己所属进程结构体。这个值和 +0x44 那里的值一样。</p>\n<ol start=\"3\">\n<li><strong>+0x22c ThreadListEntry : _LIST_ENTRY</strong></li>\n</ol>\n<p>双向链表，一个进程所有的线程都挂在一个链表中，挂的就是这个位置，有两个这样的链表</p>\n<p><img data-src=\"image001.png\" alt=\"\" /></p>\n<h1 id=\"课后实验\"><a class=\"anchor\" href=\"#课后实验\">#</a> 课后实验</h1>\n<p>断链线程结构体，实现隐藏，并思考为什么断链后线程还能够执行。</p>\n<p>并没有写恢复 代码如下：</p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span><span class=\"token string\">&lt;ntddk.h></span></span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>VOID <span class=\"token function\">DriverUnload</span><span class=\"token punctuation\">(</span>PDRIVER_OBJECT pDriver<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>\t<span class=\"token function\">DbgPrint</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"我是驱动，我卸载了\\t\\n\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>NTSTATUS <span class=\"token function\">_NtThreadHide</span><span class=\"token punctuation\">(</span>PUCHAR lpImageFileName<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\tPEPROCESS pEPROCESS<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>\t__asm</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>\t\tmov eax<span class=\"token punctuation\">,</span> fs<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token number\">0x124</span><span class=\"token punctuation\">]</span> </pre></td></tr><tr><td data-num=\"15\"></td><td><pre>\t\tmov eax<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span>eax <span class=\"token operator\">+</span> <span class=\"token number\">0x220</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>\t\tmov pEPROCESS<span class=\"token punctuation\">,</span> eax</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>\tPLIST_ENTRY pHeader <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>PCHAR<span class=\"token punctuation\">)</span>pEPROCESS <span class=\"token operator\">+</span> <span class=\"token number\">0x88</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>\tPLIST_ENTRY pCur <span class=\"token operator\">=</span> pHeader<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>\t<span class=\"token keyword\">do</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>\t\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">strcmp</span><span class=\"token punctuation\">(</span>lpImageFileName<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span>PCHAR<span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>ULONG<span class=\"token punctuation\">)</span>pCur <span class=\"token operator\">-</span> <span class=\"token number\">0x88</span> <span class=\"token operator\">+</span> <span class=\"token number\">0x174</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>\t\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>\t\t\tPLIST_ENTRY pEThreadHeader1<span class=\"token punctuation\">,</span> pEThreadHeader2<span class=\"token punctuation\">,</span> pEThreadCur<span class=\"token punctuation\">,</span> pEThreadNext<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>\t\t\tULONG uSizeOfLIST_ENTRY <span class=\"token operator\">=</span> <span class=\"token keyword\">sizeof</span><span class=\"token punctuation\">(</span>LIST_ENTRY<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>\t\t\tlpImageFileName <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>PCHAR<span class=\"token punctuation\">)</span>pCur <span class=\"token operator\">+</span> <span class=\"token number\">0xec</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>\t\t\t<span class=\"token function\">DbgPrint</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"该进程名称: %s\\n\"</span><span class=\"token punctuation\">,</span> lpImageFileName<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>\t\t\tpEThreadHeader1 <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>PCHAR<span class=\"token punctuation\">)</span>pCur <span class=\"token operator\">-</span> <span class=\"token number\">0x88</span> <span class=\"token operator\">+</span> <span class=\"token number\">0x50</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// 模块链表头</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>\t\t\tpEThreadHeader2 <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>PCHAR<span class=\"token punctuation\">)</span>pCur <span class=\"token operator\">-</span> <span class=\"token number\">0x88</span> <span class=\"token operator\">+</span> <span class=\"token number\">0x190</span><span class=\"token punctuation\">;</span>\t<span class=\"token comment\">// 模块链表头</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>\t\t\tpEThreadCur <span class=\"token operator\">=</span> pEThreadHeader1<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>\t\t\t<span class=\"token keyword\">do</span> </pre></td></tr><tr><td data-num=\"34\"></td><td><pre>\t\t\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>\t\t\t\tpEThreadNext <span class=\"token operator\">=</span> pEThreadCur<span class=\"token operator\">-></span>Blink<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>\t\t\t\tpEThreadCur<span class=\"token operator\">-></span>Flink <span class=\"token operator\">=</span> pEThreadCur<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>\t\t\t\tpEThreadCur<span class=\"token operator\">-></span>Blink <span class=\"token operator\">=</span> pEThreadCur<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>\t\t\t\tpEThreadCur <span class=\"token operator\">=</span> pEThreadNext<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>\t\t\t\t</pre></td></tr><tr><td data-num=\"40\"></td><td><pre>\t\t\t<span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span>pEThreadHeader1 <span class=\"token operator\">==</span> pEThreadCur<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>\t\t\tpEThreadCur <span class=\"token operator\">=</span> pEThreadHeader2<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>\t\t\t<span class=\"token keyword\">do</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>\t\t\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>\t\t\t\tpEThreadNext <span class=\"token operator\">=</span> pEThreadCur<span class=\"token operator\">-></span>Blink<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>\t\t\t\tpEThreadCur<span class=\"token operator\">-></span>Flink <span class=\"token operator\">=</span> pEThreadCur<span class=\"token punctuation\">;</span>\t<span class=\"token comment\">// 指向自己，不能直接置为 0, 否则会触发蓝屏</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>\t\t\t\tpEThreadCur<span class=\"token operator\">-></span>Blink <span class=\"token operator\">=</span> pEThreadCur<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>\t\t\t\tpEThreadCur <span class=\"token operator\">=</span> pEThreadNext<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>\t\t\t<span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span>pEThreadHeader1 <span class=\"token operator\">==</span> pEThreadCur<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre></pre></td></tr><tr><td data-num=\"52\"></td><td><pre>\t\t\t<span class=\"token function\">DbgPrint</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"线程隐藏成功!\\n\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>\t\t\t<span class=\"token keyword\">return</span> STATUS_SUCCESS<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre>\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre>\t\tpCur <span class=\"token operator\">=</span> pCur<span class=\"token operator\">-></span>Blink<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span>pCur <span class=\"token operator\">!=</span> pHeader<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre>\t<span class=\"token keyword\">return</span> STATUS_ABANDONED<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"59\"></td><td><pre></pre></td></tr><tr><td data-num=\"60\"></td><td><pre>NTSTATUS <span class=\"token function\">DriverEntry</span><span class=\"token punctuation\">(</span>PDRIVER_OBJECT pDriver<span class=\"token punctuation\">,</span> PUNICODE_STRING pRegPath<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"61\"></td><td><pre>\tpDriver<span class=\"token operator\">-></span>DriverUnload <span class=\"token operator\">=</span> DriverUnload<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"62\"></td><td><pre>\t<span class=\"token function\">DbgPrint</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"我是驱动,我运行了\\t\\n\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"63\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"64\"></td><td><pre>\t<span class=\"token comment\">// 线程断链</span></pre></td></tr><tr><td data-num=\"65\"></td><td><pre>\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token function\">NT_SUCCESS</span><span class=\"token punctuation\">(</span><span class=\"token function\">_NtThreadHide</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Dbgview.exe\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"66\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"67\"></td><td><pre>\t\t<span class=\"token keyword\">return</span> STATUS_UNSUCCESSFUL<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"68\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"69\"></td><td><pre></pre></td></tr><tr><td data-num=\"70\"></td><td><pre>\t<span class=\"token keyword\">return</span> STATUS_SUCCESS<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"71\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p><img data-src=\"image002.png\" alt=\"\" /></p>\n<p>断链后</p>\n<p><img data-src=\"image003.png\" alt=\"\" /></p>\n<p>断链后还可以运行。</p>\n<p>尝试用调试器附加：</p>\n<p><img data-src=\"image004.png\" alt=\"\" /></p>\n<p>这个时候 xp 已经卡死了</p>\n<h1 id=\"reference\"><a class=\"anchor\" href=\"#reference\">#</a> Reference</h1>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80Mzg5MDk1OS9hcnRpY2xlL2RldGFpbHMvMTE0NTI3NDEx\">https://blog.csdn.net/weixin_43890959/article/details/114527411</span><br />\n<span class=\"exturl\" data-url=\"aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L0t3YW5zeS9hcnRpY2xlL2RldGFpbHMvMTA5NTI5MjY0\">https://blog.csdn.net/Kwansy/article/details/109529264</span></p>\n",
            "tags": [
                "ETHREAD",
                "KTHREAD"
            ]
        },
        {
            "id": "https://or0kit.github.io/Bin/Core/WindowsXp/Process-Thread/%E8%BF%9B%E7%A8%8B%E4%B8%8E%E7%BA%BF%E7%A8%8B-%E8%BF%9B%E7%A8%8B%E7%BB%93%E6%9E%84%E4%BD%93/",
            "url": "https://or0kit.github.io/Bin/Core/WindowsXp/Process-Thread/%E8%BF%9B%E7%A8%8B%E4%B8%8E%E7%BA%BF%E7%A8%8B-%E8%BF%9B%E7%A8%8B%E7%BB%93%E6%9E%84%E4%BD%93/",
            "title": "进程与线程-进程结构体",
            "date_published": "2022-01-01T00:53:20.000Z",
            "content_html": "<h1 id=\"进程\"><a class=\"anchor\" href=\"#进程\">#</a> 进程</h1>\n<p>进程最重要的作用是提供了 CR3，10-10-12 分页下 CR3 指向页目录表，2-9-9-12 分页下 CR3 指向页目录指针表。<br />\n每个进程至少有一个线程。<br />\n本质上，没有进程切换，只有线程切换。线程切换时会判断是否是同一个进程的线程，若不是同一进程则切换 CR3，这样看来进程也就切换了。<br />\n我们说进程是空间概念，进程为它的线程提供了 CR3，那么它的线程访问同一个线性地址时，就能访问到同一个物理页。<br />\nwindbg 中的  <code>attach</code>  和  <code>.process</code>  本质就是切换 CR3。</p>\n<h1 id=\"进程结构体-eproccess\"><a class=\"anchor\" href=\"#进程结构体-eproccess\">#</a> 进程结构体 EPROCCESS</h1>\n<figure class=\"highlight raw\"><figcaption data-lang=\"\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>kd&gt; dt _EPROCESS </pre></td></tr><tr><td data-num=\"2\"></td><td><pre>nt!_EPROCESS</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>   +0x000 Pcb              : _KPROCESS</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>   +0x06c ProcessLock      : _EX_PUSH_LOCK</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>   +0x070 CreateTime       : _LARGE_INTEGER</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>   +0x078 ExitTime         : _LARGE_INTEGER</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>   +0x080 RundownProtect   : _EX_RUNDOWN_REF</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>   +0x084 UniqueProcessId  : Ptr32 Void</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>   +0x088 ActiveProcessLinks : _LIST_ENTRY</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>   +0x090 QuotaUsage       : [3] Uint4B</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>   +0x09c QuotaPeak        : [3] Uint4B</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>   +0x0a8 CommitCharge     : Uint4B</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>   +0x0ac PeakVirtualSize  : Uint4B</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>   +0x0b0 VirtualSize      : Uint4B</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>   +0x0b4 SessionProcessLinks : _LIST_ENTRY</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>   +0x0bc DebugPort        : Ptr32 Void</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>   +0x0c0 ExceptionPort    : Ptr32 Void</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>   +0x0c4 ObjectTable      : Ptr32 _HANDLE_TABLE</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>   +0x0c8 Token            : _EX_FAST_REF</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>   +0x0cc WorkingSetLock   : _FAST_MUTEX</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>   +0x0ec WorkingSetPage   : Uint4B</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>   +0x0f0 AddressCreationLock : _FAST_MUTEX</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>   +0x110 HyperSpaceLock   : Uint4B</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>   +0x114 ForkInProgress   : Ptr32 _ETHREAD</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>   +0x118 HardwareTrigger  : Uint4B</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>   +0x11c VadRoot          : Ptr32 Void</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>   +0x120 VadHint          : Ptr32 Void</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>   +0x124 CloneRoot        : Ptr32 Void</pre></td></tr><tr><td data-num=\"29\"></td><td><pre>   +0x128 NumberOfPrivatePages : Uint4B</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>   +0x12c NumberOfLockedPages : Uint4B</pre></td></tr><tr><td data-num=\"31\"></td><td><pre>   +0x130 Win32Process     : Ptr32 Void</pre></td></tr><tr><td data-num=\"32\"></td><td><pre>   +0x134 Job              : Ptr32 _EJOB</pre></td></tr><tr><td data-num=\"33\"></td><td><pre>   +0x138 SectionObject    : Ptr32 Void</pre></td></tr><tr><td data-num=\"34\"></td><td><pre>   +0x13c SectionBaseAddress : Ptr32 Void</pre></td></tr><tr><td data-num=\"35\"></td><td><pre>   +0x140 QuotaBlock       : Ptr32 _EPROCESS_QUOTA_BLOCK</pre></td></tr><tr><td data-num=\"36\"></td><td><pre>   +0x144 WorkingSetWatch  : Ptr32 _PAGEFAULT_HISTORY</pre></td></tr><tr><td data-num=\"37\"></td><td><pre>   +0x148 Win32WindowStation : Ptr32 Void</pre></td></tr><tr><td data-num=\"38\"></td><td><pre>   +0x14c InheritedFromUniqueProcessId : Ptr32 Void</pre></td></tr><tr><td data-num=\"39\"></td><td><pre>   +0x150 LdtInformation   : Ptr32 Void</pre></td></tr><tr><td data-num=\"40\"></td><td><pre>   +0x154 VadFreeHint      : Ptr32 Void</pre></td></tr><tr><td data-num=\"41\"></td><td><pre>   +0x158 VdmObjects       : Ptr32 Void</pre></td></tr><tr><td data-num=\"42\"></td><td><pre>   +0x15c DeviceMap        : Ptr32 Void</pre></td></tr><tr><td data-num=\"43\"></td><td><pre>   +0x160 PhysicalVadList  : _LIST_ENTRY</pre></td></tr><tr><td data-num=\"44\"></td><td><pre>   +0x168 PageDirectoryPte : _HARDWARE_PTE</pre></td></tr><tr><td data-num=\"45\"></td><td><pre>   +0x168 Filler           : Uint8B</pre></td></tr><tr><td data-num=\"46\"></td><td><pre>   +0x170 Session          : Ptr32 Void</pre></td></tr><tr><td data-num=\"47\"></td><td><pre>   +0x174 ImageFileName    : [16] UChar</pre></td></tr><tr><td data-num=\"48\"></td><td><pre>   +0x184 JobLinks         : _LIST_ENTRY</pre></td></tr><tr><td data-num=\"49\"></td><td><pre>   +0x18c LockedPagesList  : Ptr32 Void</pre></td></tr><tr><td data-num=\"50\"></td><td><pre>   +0x190 ThreadListHead   : _LIST_ENTRY</pre></td></tr><tr><td data-num=\"51\"></td><td><pre>   +0x198 SecurityPort     : Ptr32 Void</pre></td></tr><tr><td data-num=\"52\"></td><td><pre>   +0x19c PaeTop           : Ptr32 Void</pre></td></tr><tr><td data-num=\"53\"></td><td><pre>   +0x1a0 ActiveThreads    : Uint4B</pre></td></tr><tr><td data-num=\"54\"></td><td><pre>   +0x1a4 GrantedAccess    : Uint4B</pre></td></tr><tr><td data-num=\"55\"></td><td><pre>   +0x1a8 DefaultHardErrorProcessing : Uint4B</pre></td></tr><tr><td data-num=\"56\"></td><td><pre>   +0x1ac LastThreadExitStatus : Int4B</pre></td></tr><tr><td data-num=\"57\"></td><td><pre>   +0x1b0 Peb              : Ptr32 _PEB</pre></td></tr><tr><td data-num=\"58\"></td><td><pre>   +0x1b4 PrefetchTrace    : _EX_FAST_REF</pre></td></tr><tr><td data-num=\"59\"></td><td><pre>   +0x1b8 ReadOperationCount : _LARGE_INTEGER</pre></td></tr><tr><td data-num=\"60\"></td><td><pre>   +0x1c0 WriteOperationCount : _LARGE_INTEGER</pre></td></tr><tr><td data-num=\"61\"></td><td><pre>   +0x1c8 OtherOperationCount : _LARGE_INTEGER</pre></td></tr><tr><td data-num=\"62\"></td><td><pre>   +0x1d0 ReadTransferCount : _LARGE_INTEGER</pre></td></tr><tr><td data-num=\"63\"></td><td><pre>   +0x1d8 WriteTransferCount : _LARGE_INTEGER</pre></td></tr><tr><td data-num=\"64\"></td><td><pre>   +0x1e0 OtherTransferCount : _LARGE_INTEGER</pre></td></tr><tr><td data-num=\"65\"></td><td><pre>   +0x1e8 CommitChargeLimit : Uint4B</pre></td></tr><tr><td data-num=\"66\"></td><td><pre>   +0x1ec CommitChargePeak : Uint4B</pre></td></tr><tr><td data-num=\"67\"></td><td><pre>   +0x1f0 AweInfo          : Ptr32 Void</pre></td></tr><tr><td data-num=\"68\"></td><td><pre>   +0x1f4 SeAuditProcessCreationInfo : _SE_AUDIT_PROCESS_CREATION_INFO</pre></td></tr><tr><td data-num=\"69\"></td><td><pre>   +0x1f8 Vm               : _MMSUPPORT</pre></td></tr><tr><td data-num=\"70\"></td><td><pre>   +0x238 LastFaultCount   : Uint4B</pre></td></tr><tr><td data-num=\"71\"></td><td><pre>   +0x23c ModifiedPageCount : Uint4B</pre></td></tr><tr><td data-num=\"72\"></td><td><pre>   +0x240 NumberOfVads     : Uint4B</pre></td></tr><tr><td data-num=\"73\"></td><td><pre>   +0x244 JobStatus        : Uint4B</pre></td></tr><tr><td data-num=\"74\"></td><td><pre>   +0x248 Flags            : Uint4B</pre></td></tr><tr><td data-num=\"75\"></td><td><pre>   +0x248 CreateReported   : Pos 0, 1 Bit</pre></td></tr><tr><td data-num=\"76\"></td><td><pre>   +0x248 NoDebugInherit   : Pos 1, 1 Bit</pre></td></tr><tr><td data-num=\"77\"></td><td><pre>   +0x248 ProcessExiting   : Pos 2, 1 Bit</pre></td></tr><tr><td data-num=\"78\"></td><td><pre>   +0x248 ProcessDelete    : Pos 3, 1 Bit</pre></td></tr><tr><td data-num=\"79\"></td><td><pre>   +0x248 Wow64SplitPages  : Pos 4, 1 Bit</pre></td></tr><tr><td data-num=\"80\"></td><td><pre>   +0x248 VmDeleted        : Pos 5, 1 Bit</pre></td></tr><tr><td data-num=\"81\"></td><td><pre>   +0x248 OutswapEnabled   : Pos 6, 1 Bit</pre></td></tr><tr><td data-num=\"82\"></td><td><pre>   +0x248 Outswapped       : Pos 7, 1 Bit</pre></td></tr><tr><td data-num=\"83\"></td><td><pre>   +0x248 ForkFailed       : Pos 8, 1 Bit</pre></td></tr><tr><td data-num=\"84\"></td><td><pre>   +0x248 HasPhysicalVad   : Pos 9, 1 Bit</pre></td></tr><tr><td data-num=\"85\"></td><td><pre>   +0x248 AddressSpaceInitialized : Pos 10, 2 Bits</pre></td></tr><tr><td data-num=\"86\"></td><td><pre>   +0x248 SetTimerResolution : Pos 12, 1 Bit</pre></td></tr><tr><td data-num=\"87\"></td><td><pre>   +0x248 BreakOnTermination : Pos 13, 1 Bit</pre></td></tr><tr><td data-num=\"88\"></td><td><pre>   +0x248 SessionCreationUnderway : Pos 14, 1 Bit</pre></td></tr><tr><td data-num=\"89\"></td><td><pre>   +0x248 WriteWatch       : Pos 15, 1 Bit</pre></td></tr><tr><td data-num=\"90\"></td><td><pre>   +0x248 ProcessInSession : Pos 16, 1 Bit</pre></td></tr><tr><td data-num=\"91\"></td><td><pre>   +0x248 OverrideAddressSpace : Pos 17, 1 Bit</pre></td></tr><tr><td data-num=\"92\"></td><td><pre>   +0x248 HasAddressSpace  : Pos 18, 1 Bit</pre></td></tr><tr><td data-num=\"93\"></td><td><pre>   +0x248 LaunchPrefetched : Pos 19, 1 Bit</pre></td></tr><tr><td data-num=\"94\"></td><td><pre>   +0x248 InjectInpageErrors : Pos 20, 1 Bit</pre></td></tr><tr><td data-num=\"95\"></td><td><pre>   +0x248 VmTopDown        : Pos 21, 1 Bit</pre></td></tr><tr><td data-num=\"96\"></td><td><pre>   +0x248 Unused3          : Pos 22, 1 Bit</pre></td></tr><tr><td data-num=\"97\"></td><td><pre>   +0x248 Unused4          : Pos 23, 1 Bit</pre></td></tr><tr><td data-num=\"98\"></td><td><pre>   +0x248 VdmAllowed       : Pos 24, 1 Bit</pre></td></tr><tr><td data-num=\"99\"></td><td><pre>   +0x248 Unused           : Pos 25, 5 Bits</pre></td></tr><tr><td data-num=\"100\"></td><td><pre>   +0x248 Unused1          : Pos 30, 1 Bit</pre></td></tr><tr><td data-num=\"101\"></td><td><pre>   +0x248 Unused2          : Pos 31, 1 Bit</pre></td></tr><tr><td data-num=\"102\"></td><td><pre>   +0x24c ExitStatus       : Int4B</pre></td></tr><tr><td data-num=\"103\"></td><td><pre>   +0x250 NextPageColor    : Uint2B</pre></td></tr><tr><td data-num=\"104\"></td><td><pre>   +0x252 SubSystemMinorVersion : UChar</pre></td></tr><tr><td data-num=\"105\"></td><td><pre>   +0x253 SubSystemMajorVersion : UChar</pre></td></tr><tr><td data-num=\"106\"></td><td><pre>   +0x252 SubSystemVersion : Uint2B</pre></td></tr><tr><td data-num=\"107\"></td><td><pre>   +0x254 PriorityClass    : UChar</pre></td></tr><tr><td data-num=\"108\"></td><td><pre>   +0x255 WorkingSetAcquiredUnsafe : UChar</pre></td></tr><tr><td data-num=\"109\"></td><td><pre>   +0x258 Cookie           : Uint4B</pre></td></tr></table></figure><p>其中第一个成员也是一个结构体 _KPROCESS</p>\n<figure class=\"highlight raw\"><figcaption data-lang=\"\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>kd&gt; dt _KPROCESS</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>ntdll!_KPROCESS</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>   +0x000 Header           : _DISPATCHER_HEADER</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>   +0x010 ProfileListHead  : _LIST_ENTRY</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>   +0x018 DirectoryTableBase : [2] Uint4B</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>   +0x020 LdtDescriptor    : _KGDTENTRY</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>   +0x028 Int21Descriptor  : _KIDTENTRY</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>   +0x030 IopmOffset       : Uint2B</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>   +0x032 Iopl             : UChar</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>   +0x033 Unused           : UChar</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>   +0x034 ActiveProcessors : Uint4B</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>   +0x038 KernelTime       : Uint4B</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>   +0x03c UserTime         : Uint4B</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>   +0x040 ReadyListHead    : _LIST_ENTRY</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>   +0x048 SwapListEntry    : _SINGLE_LIST_ENTRY</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>   +0x04c VdmTrapcHandler  : Ptr32 Void</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>   +0x050 ThreadListHead   : _LIST_ENTRY</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>   +0x058 ProcessLock      : Uint4B</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>   +0x05c Affinity         : Uint4B</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>   +0x060 StackCount       : Uint2B</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>   +0x062 BasePriority     : Char</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>   +0x063 ThreadQuantum    : Char</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>   +0x064 AutoAlignment    : UChar</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>   +0x065 State            : UChar</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>   +0x066 ThreadSeed       : UChar</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>   +0x067 DisableBoost     : UChar</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>   +0x068 PowerState       : UChar</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>   +0x069 DisableQuantum   : UChar</pre></td></tr><tr><td data-num=\"29\"></td><td><pre>   +0x06a IdealNode        : UChar</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>   +0x06b Flags            : _KEXECUTE_OPTIONS</pre></td></tr><tr><td data-num=\"31\"></td><td><pre>   +0x06b ExecuteOptions   : UChar</pre></td></tr></table></figure><h2 id=\"kprocess主要成员介绍\"><a class=\"anchor\" href=\"#kprocess主要成员介绍\">#</a> KPROCESS 主要成员介绍</h2>\n<p>内核层的进程对象。K 开头的是内核层的。</p>\n<h3 id=\"0x000-header-_dispatcher_header\"><a class=\"anchor\" href=\"#0x000-header-_dispatcher_header\">#</a> <strong>+0x000 Header           : _DISPATCHER_HEADER</strong></h3>\n<p>分发器对象 （dispatcher object），现在只需知道进程是可以被等待的就行。“可等待” 对象，比如 Mutex 互斥体、Event 事件等（WaitForSingleObject）</p>\n<h3 id=\"0x018-directorytablebase-2-uint4b\"><a class=\"anchor\" href=\"#0x018-directorytablebase-2-uint4b\">#</a> <strong>+0x018 DirectoryTableBase : [2] Uint4B</strong></h3>\n<p>一个只有两项的数组，其中第一项指向该进程的也目录表地址，第二项指向该进程的超空间（hyper space）的页目录表地址。</p>\n<h3 id=\"0x020-ldtdescriptor-_kgdtentry-0x028-int21descriptor-_kidtentry\"><a class=\"anchor\" href=\"#0x020-ldtdescriptor-_kgdtentry-0x028-int21descriptor-_kidtentry\">#</a> <strong>【+0x020 LdtDescriptor    : _KGDTENTRY】、【+0x028 Int21Descriptor  : _KIDTENTRY】</strong></h3>\n<p>历史遗留，16 位 Windows 段选择子不够 每个进程都有一个 LDT 表<br />\n Int21Descriptor  是 DOS 下要用的</p>\n<h3 id=\"0x034-activeprocessors-uint4b\"><a class=\"anchor\" href=\"#0x034-activeprocessors-uint4b\">#</a> <strong>+0x034 ActiveProcessors : Uint4B</strong></h3>\n<p>ActiveProcessors 域记录了当前进程正在哪些处理器上运行。</p>\n<h3 id=\"0x038-kerneltime-uint4b-0x03c-usertime-uint4b\"><a class=\"anchor\" href=\"#0x038-kerneltime-uint4b-0x03c-usertime-uint4b\">#</a> <strong>【+0x038 KernelTime       : Uint4B】、【+0x03c UserTime         : Uint4B】</strong></h3>\n<p>统计信息 记录了一个进程在内核模式 / 用户模式下所花的时间。进程的  <code>KernelTime</code>  和  <code>UserTime</code>  时间值等于所属线程对应的 <code>KernelTime</code>  和  <code>UserTime</code>  值的和。但是，由于仅当一个线程结束时才更新其进程的这两个时间值，所以，若一个进程中尚未有任何一个线程结束，则这两个域中的值为 0。</p>\n<h3 id=\"0x040-readylisthead-_list_entry\"><a class=\"anchor\" href=\"#0x040-readylisthead-_list_entry\">#</a> <strong>+0x040 ReadyListHead    : _LIST_ENTRY</strong></h3>\n<p><code>ReadyListHead</code>  是一个双向链表的表头，该链表记录了这个进程中处于就绪状态但尚未被加入全局就绪链表的线程，这个域的意义在于，当一个进程被换出内存以后，它所属的线程一旦就绪，则被挂到此链表中，并要求换入该进程；以后，当该进程被换入内存时， <code>ReadyListHead</code>  中的所有线程被加入到系统全局的就绪线程链表中。注意， <code>ReadyListHead</code>  链表中的每一项都是一个指向 <code>KTHREAD</code>  对象的 <code>WaitlistEntry</code>  域的地址，所以，从链表中的每一项都可以定位到对应的线程对象。例如，下面的代码片段是从 <code>KilnSwapProcesses</code>  函数中摘录的，从代码中可以看到 <code>ReadyListHead</code>  链表的用法。这段代码的意图是，将链表中的每个线程加入到全局就绪线程链表中（通过调用 <code>KiReadyThread</code>  来完成）。</p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>Process<span class=\"token operator\">-></span>State<span class=\"token operator\">=</span>ProcessInMemory；</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>NextEntry<span class=\"token operator\">=</span>Process<span class=\"token operator\">-></span>ReadyListHead<span class=\"token punctuation\">.</span>Flink<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">while</span><span class=\"token punctuation\">(</span>NextEntry l<span class=\"token operator\">=</span><span class=\"token operator\">&amp;</span>Process<span class=\"token operator\">-></span>ReadyListHead<span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  Thread<span class=\"token operator\">=</span><span class=\"token function\">CONTAINING_RECORD</span><span class=\"token punctuation\">(</span>NextEntry<span class=\"token punctuation\">,</span>KTHREAD<span class=\"token punctuation\">,</span>WaitListEntry<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  <span class=\"token function\">RemoveEntryList</span><span class=\"token punctuation\">(</span>NextEntry<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  Thread<span class=\"token operator\">-></span>ProcessReadyQueue <span class=\"token operator\">=</span>FALSE；</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  <span class=\"token function\">KiReadyThread</span><span class=\"token punctuation\">(</span>Thread<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  NextEntry<span class=\"token operator\">=</span>Process<span class=\"token operator\">-></span>ReadyListHead<span class=\"token punctuation\">.</span>Flink<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h3 id=\"0x048-swaplistentry-_single_list_entry\"><a class=\"anchor\" href=\"#0x048-swaplistentry-_single_list_entry\">#</a> <strong>+0x048 SwapListEntry    : _SINGLE_LIST_ENTRY</strong></h3>\n<p>SwapListEntry 域是一个单链表项，当一个进程要被换出内存时，它通过此域加入到以 KiProcessOurSwapListHead 为链头的单链表中；当一个进程要被换入内存时，它通过此域加入到以 KiProcessInSwapListHead 为链头的单链表中。这里，KiProcessOurSwapListHead 和 KiProcessInSwapListHead 是全局变量。</p>\n<h3 id=\"0x05c-affinity-uint4b\"><a class=\"anchor\" href=\"#0x05c-affinity-uint4b\">#</a> <strong>+0x05c Affinity         : Uint4B</strong></h3>\n<p>Affinity 域指定了该进程的线程可以在哪些处理器上运行，其类型是 KAFFINITY, 这是一个 32 位或 64 位整数，其二进制表示的每位分别对应于当前机器上的一个处理器 (或核)。</p>\n<p>规定进程里面的所有线程能在哪个 CPU 上跑，如果值为 1，那这个进程的所以线程只能在 0 号 CPU 上跑 (00000001)\t\t\t\t<br />\n如果值为 3，那这个进程的所以线程能在 0、1 号 CPU 上跑 (000000011)\t<br />\n如果值为 4，那这个进程的所以线程能在 2 号 CPU 上跑 (000000100)\t<br />\n如果值为 5，那这个进程的所以线程能在 0，2 号 CPU 上跑 (000000101)\t<br />\n4 个字节共 32 位  所以最多 32 核 Windows64 位 就 64 核\t\t\t<br />\n如果只有一个 CPU 把这个设置为 4 那么这个进程就死了</p>\n<h3 id=\"0x062-basepriority-char\"><a class=\"anchor\" href=\"#0x062-basepriority-char\">#</a> <strong>+0x062 BasePriority     : Char</strong></h3>\n<p>基础优先级或最低优先级 该进程中的所有线程最起码的优先级.</p>\n<h3 id=\"0x065-state-uchar\"><a class=\"anchor\" href=\"#0x065-state-uchar\">#</a> <strong>+0x065 State            : UChar</strong></h3>\n<p>State 域说明了一个进程是否在内存中，共有六种可能的状态： <code>ProcessInMemory</code> 、 <code>ProcessOutOfMemory</code> 、 <code>ProcessInTransition</code> 、 <code>ProcessOutTransition</code> 、 <code>ProcessInSwap</code>  和 <code>ProcessOutSwap</code> 。所谓一个进程在内存中，或者已被换出，或者正在转移过程中，是指该进程的虚拟地址空间需要占据足够的物理内存，或者虚拟空间中的内容已被换出物理内存，或者正在换入或换出过程之中。</p>\n<h2 id=\"eprocess其他成员\"><a class=\"anchor\" href=\"#eprocess其他成员\">#</a> EPROCESS 其他成员</h2>\n<p>执行体层的进程和线程对象。E 开头的。</p>\n<h3 id=\"0x070-createtime-_large_integer-0x078-exittime-_large_integer\"><a class=\"anchor\" href=\"#0x070-createtime-_large_integer-0x078-exittime-_large_integer\">#</a> <strong>【+0x070 CreateTime       : _LARGE_INTEGER】、【+0x078 ExitTime         : _LARGE_INTEGER】</strong></h3>\n<p>进程的创建 / 退出时间。 没什么用，不准确。</p>\n<h3 id=\"0x084-uniqueprocessid-ptr32-void\"><a class=\"anchor\" href=\"#0x084-uniqueprocessid-ptr32-void\">#</a> <strong>+0x084 UniqueProcessId  : Ptr32 Void</strong></h3>\n<p>进程的编号 任务管理器中的 PID</p>\n<h3 id=\"0x088-activeprocesslinks-_list_entry\"><a class=\"anchor\" href=\"#0x088-activeprocesslinks-_list_entry\">#</a> <strong>+0x088 ActiveProcessLinks : _LIST_ENTRY</strong></h3>\n<p>双向链表 所有的活动进程都连接在一起，构成了一个链表<br />\n PsActiveProcessHead 指向全局链表头</p>\n<p><img data-src=\"image001.png\" alt=\"\" /></p>\n<h3 id=\"0x090-quotausage-3-uint4b-0x09c-quotapeak-3-uint4b\"><a class=\"anchor\" href=\"#0x090-quotausage-3-uint4b-0x09c-quotapeak-3-uint4b\">#</a> <strong>【+0x090 QuotaUsage       : [3] Uint4B】、【+0x09c QuotaPeak        : [3] Uint4B】</strong></h3>\n<p>物理页相关的统计信息</p>\n<h3 id=\"0x0a8-commitcharge-uint4b-0x0ac-peakvirtualsize-uint4b-0x0b0-virtualsize-uint4b\"><a class=\"anchor\" href=\"#0x0a8-commitcharge-uint4b-0x0ac-peakvirtualsize-uint4b-0x0b0-virtualsize-uint4b\">#</a> <strong>【+0x0a8 CommitCharge     : Uint4B】、【+0x0ac PeakVirtualSize  : Uint4B】、【+0x0b0 VirtualSize      : Uint4B】</strong></h3>\n<p>虚拟内存相关的统计信息</p>\n<h3 id=\"0x11c-vadroot-ptr32-void\"><a class=\"anchor\" href=\"#0x11c-vadroot-ptr32-void\">#</a> <strong>+0x11c VadRoot          : Ptr32 Void</strong></h3>\n<p>标识 0-2G 哪些地址被占用了</p>\n<h3 id=\"0x0bc-debugport-ptr32-void-0x0c0-exceptionport-ptr32-void\"><a class=\"anchor\" href=\"#0x0bc-debugport-ptr32-void-0x0c0-exceptionport-ptr32-void\">#</a> <strong>【+0x0bc DebugPort        : Ptr32 Void】、【+0x0c0 ExceptionPort    : Ptr32 Void】</strong></h3>\n<p>调试相关</p>\n<h3 id=\"0x0c4-objecttable-ptr32-_handle_table\"><a class=\"anchor\" href=\"#0x0c4-objecttable-ptr32-_handle_table\">#</a> <strong>+0x0c4 ObjectTable      : Ptr32 _HANDLE_TABLE</strong></h3>\n<p>句柄表</p>\n<h3 id=\"0x174-imagefilename-16-uchar\"><a class=\"anchor\" href=\"#0x174-imagefilename-16-uchar\">#</a> <strong>+0x174 ImageFileName    : [16] UChar</strong></h3>\n<p>进程镜像文件名 最多 16 个字节</p>\n<h3 id=\"0x1a0-activethreads-uint4b\"><a class=\"anchor\" href=\"#0x1a0-activethreads-uint4b\">#</a> <strong>+0x1a0 ActiveThreads    : Uint4B</strong></h3>\n<p>活动线程的数量</p>\n<h3 id=\"0x1b0-peb-ptr32-_peb\"><a class=\"anchor\" href=\"#0x1b0-peb-ptr32-_peb\">#</a> <strong>+0x1b0 Peb              : Ptr32 _PEB</strong></h3>\n<p>PEB ((Process Environment Block 进程环境块)：进程在 3 环的一个结构体，里面包含了进程的模块列表、是否处于调试状态等信息。</p>\n<p>关于 PEB 或者其他成员更加详细的说明：参考 潘爱民老师《Windows 内核原理与实现》 中的第 3 章</p>\n<h1 id=\"本章总结\"><a class=\"anchor\" href=\"#本章总结\">#</a> 本章总结</h1>\n<p>0 环查看当前进程<br />\n通过 KPCR 找当前线程，然后找其 + 0x220 找当前进程。<br />\n后面通过学习进程的创建，来观察进程结构体是如何填充的。</p>\n<h1 id=\"实验练习\"><a class=\"anchor\" href=\"#实验练习\">#</a> 实验练习</h1>\n<blockquote>\n<ol>\n<li>体会 DebugPort 的作用：用调试器（调试器最好没有插件）调试程序，然后把 进程结构体的 DebugPort 清零，在调试器里接着调试，观察会发生什么。</li>\n</ol>\n</blockquote>\n<p>就不写代码更改了，直接用 windbg 修改了。<br />\n调试时 DebugPort 的值：</p>\n<p><img data-src=\"image002.png\" alt=\"\" /></p>\n<p><img data-src=\"image003.png\" alt=\"\" /></p>\n<p>清空这个值后，在调试器里执行单步：</p>\n<p><img data-src=\"image004.png\" alt=\"\" /></p>\n<p>直接报异常了。</p>\n<blockquote>\n<ol start=\"2\">\n<li>0 环进程断链</li>\n</ol>\n</blockquote>\n<p>代码如下：</p>\n<p>没有写恢复的。</p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span><span class=\"token string\">&lt;ntddk.h></span></span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>VOID <span class=\"token function\">DriverUnload</span><span class=\"token punctuation\">(</span>PDRIVER_OBJECT pDriver<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>\t<span class=\"token function\">DbgPrint</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"我是驱动，我卸载了\\t\\n\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>NTSTATUS <span class=\"token function\">EProcessBreakChain</span><span class=\"token punctuation\">(</span>PUCHAR ProcessName<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\tULONG Pro<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>\t<span class=\"token comment\">// 由 KPCR+0x124 的位置得到当前 CPU 正在处理的线程的结构体的指针，_KTHREAD + 0x44 的位置能够得到此线程的进程结构体的地址</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>\t__asm <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>\t\tmov eax<span class=\"token punctuation\">,</span> fs<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token number\">0x124</span><span class=\"token punctuation\">]</span> <span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>\t\tmov ecx<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span>eax <span class=\"token operator\">+</span> <span class=\"token number\">0x44</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>\t\tmov Pro<span class=\"token punctuation\">,</span> ecx<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>\t<span class=\"token comment\">// 进程结构体 EPROCESS +0x88 的位置是一个链接所有进程的双向链表</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>\tPLIST_ENTRY pListProcess <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>PLIST_ENTRY<span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span>Pro <span class=\"token operator\">+</span> <span class=\"token number\">0x88</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>\t<span class=\"token comment\">// 遍历进程</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>\t<span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span>pListProcess<span class=\"token operator\">-></span>Flink <span class=\"token operator\">!=</span> <span class=\"token punctuation\">(</span>PLIST_ENTRY<span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span>Pro <span class=\"token operator\">+</span> <span class=\"token number\">0x88</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>\t\t<span class=\"token comment\">//EPROCESS 结构体</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>\t\tULONG NextProcess <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>ULONG<span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span>pListProcess<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span> <span class=\"token number\">0x88</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>\t\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">strcmp</span><span class=\"token punctuation\">(</span>ProcessName<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span>PCHAR<span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span>NextProcess <span class=\"token operator\">+</span> <span class=\"token number\">0x174</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>\t\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>\t\t\t<span class=\"token function\">DbgPrint</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"FindProcess:%s PEPROCESS:%X\\t\\n\"</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>PCHAR<span class=\"token punctuation\">)</span>NextProcess <span class=\"token operator\">+</span> <span class=\"token number\">0x174</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> NextProcess<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>\t\t\t<span class=\"token comment\">// 断链</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>\t\t\tPLIST_ENTRY CurPro <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>PLIST_ENTRY<span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span>NextProcess<span class=\"token operator\">+</span> <span class=\"token number\">0x88</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>\t\t\tPLIST_ENTRY BlinkPro <span class=\"token operator\">=</span> CurPro<span class=\"token operator\">-></span>Blink<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>\t\t\tPLIST_ENTRY FlinkPro <span class=\"token operator\">=</span> CurPro<span class=\"token operator\">-></span>Flink<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>\t\t\tBlinkPro<span class=\"token operator\">-></span>Flink <span class=\"token operator\">=</span> FlinkPro<span class=\"token operator\">-></span>Flink<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>\t\t\tFlinkPro<span class=\"token operator\">-></span>Blink <span class=\"token operator\">=</span> BlinkPro<span class=\"token operator\">-></span>Flink<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>\t\t\t<span class=\"token keyword\">return</span> STATUS_SUCCESS<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>\t\tpListProcess <span class=\"token operator\">=</span> pListProcess<span class=\"token operator\">-></span>Flink<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>\t<span class=\"token keyword\">return</span> STATUS_UNSUCCESSFUL<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>NTSTATUS <span class=\"token function\">DriverEntry</span><span class=\"token punctuation\">(</span>PDRIVER_OBJECT pDriver<span class=\"token punctuation\">,</span> PUNICODE_STRING pRegPath<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>\tNTSTATUS ntStatus <span class=\"token operator\">=</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>\tpDriver<span class=\"token operator\">-></span>DriverUnload <span class=\"token operator\">=</span> DriverUnload<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>\t<span class=\"token function\">DbgPrint</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"我是驱动,我运行了\\t\\n\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>\t<span class=\"token comment\">//r0 进程断链</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>\t<span class=\"token comment\">// 遍历进程\t 断链</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>\tntStatus <span class=\"token operator\">=</span> <span class=\"token function\">EProcessBreakChain</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Dbgview.exe\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token function\">NT_SUCCESS</span><span class=\"token punctuation\">(</span>ntStatus<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre>\t\t<span class=\"token function\">DbgPrint</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"断链失败！！\\t\\n\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>\t\t<span class=\"token keyword\">return</span> ntStatus<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre>\t<span class=\"token function\">DbgPrint</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"断链成功！！\\t\\n\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>\t<span class=\"token keyword\">return</span> STATUS_SUCCESS<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p><img data-src=\"image001.png\" alt=\"\" /></p>\n<h1 id=\"reference\"><a class=\"anchor\" href=\"#reference\">#</a> Reference</h1>\n<p>潘爱民前辈的《Windows 内核原理与实现》一书。</p>\n",
            "tags": [
                "EPROCESS",
                "KPROCESS"
            ]
        },
        {
            "id": "https://or0kit.github.io/Bin/Core/WindowsXp/SystemCall/%E7%B3%BB%E7%BB%9F%E8%B0%83%E7%94%A8-%E8%AF%BE%E5%90%8E%E7%BB%83%E4%B9%A0/",
            "url": "https://or0kit.github.io/Bin/Core/WindowsXp/SystemCall/%E7%B3%BB%E7%BB%9F%E8%B0%83%E7%94%A8-%E8%AF%BE%E5%90%8E%E7%BB%83%E4%B9%A0/",
            "title": "系统调用-课后练习",
            "date_published": "2022-01-01T00:52:24.000Z",
            "content_html": "<h1 id=\"系统调用阶段总结\"><a class=\"anchor\" href=\"#系统调用阶段总结\">#</a> 系统调用阶段总结</h1>\n<p>把本阶段的课后作业练习一下</p>\n<h2 id=\"在ssdt表中追加一个函数地址\"><a class=\"anchor\" href=\"#在ssdt表中追加一个函数地址\">#</a> 在 SSDT 表中追加一个函数地址</h2>\n<p>在 SSDT 表中追加一个函数地址 (NtReadVirtualMemory), 自己编写 API 的 3 环部分调用这个新增的函数 (注意：使用 2-9-9-12 分页)。</p>\n<p><strong>发现函数表后面刚好有四个字节，然后就是参数表了，这四个字节的值为： <code>0000011c </code> 刚好是函数表函数的个数，覆盖后暂时没出问题。</strong></p>\n<h3 id=\"代码如下\"><a class=\"anchor\" href=\"#代码如下\">#</a> 代码如下</h3>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">// 在 SSDT 表中追加一个函数地址 (NtReadVirtualMemory), 自己编写 API 的 3 环部分调用这个新增的函数 (注意：使用 2-9-9-12 分页)。</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span><span class=\"token string\">&lt;ntifs.h></span></span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>VOID <span class=\"token function\">DriverUnload</span><span class=\"token punctuation\">(</span>PDRIVER_OBJECT pDriver<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>\t<span class=\"token comment\">// 恢复懒得写了</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>\t<span class=\"token function\">DbgPrint</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"我是驱动，我卸载了\\t\\n\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>VOID <span class=\"token function\">PageProtectOn</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>\t__asm <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>\t\tmov  eax<span class=\"token punctuation\">,</span> cr0</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>\t\tor eax<span class=\"token punctuation\">,</span> <span class=\"token number\">10000</span>h</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>\t\tmov  cr0<span class=\"token punctuation\">,</span> eax</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>\t\tsti</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>VOID <span class=\"token function\">PageProtectOff</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>\t__asm <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>\t\tcli</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>\t\tmov  eax<span class=\"token punctuation\">,</span> cr0</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>\t\tand eax<span class=\"token punctuation\">,</span> not <span class=\"token number\">10000</span>h</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>\t\tmov  cr0<span class=\"token punctuation\">,</span> eax</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre></pre></td></tr><tr><td data-num=\"31\"></td><td><pre></pre></td></tr><tr><td data-num=\"32\"></td><td><pre></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>VOID <span class=\"token function\">ModifySSDT</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"35\"></td><td><pre>\t<span class=\"token keyword\">extern</span> PULONG KeServiceDescriptorTable<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>\t<span class=\"token comment\">// 获取函数表的指针</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>\tPULONG pFuncTable <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>PULONG<span class=\"token punctuation\">)</span><span class=\"token operator\">*</span>KeServiceDescriptorTable<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>\t<span class=\"token function\">DbgPrint</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"pFuncTable:%p\\t\\n\"</span><span class=\"token punctuation\">,</span> pFuncTable<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>\t<span class=\"token comment\">// 获取函数个数的指针</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>\tPULONG pLimit <span class=\"token operator\">=</span> KeServiceDescriptorTable <span class=\"token operator\">+</span> <span class=\"token number\">0x2</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>\t<span class=\"token function\">DbgPrint</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"uLimit:%p\\t\\n\"</span><span class=\"token punctuation\">,</span> pLimit<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>\t<span class=\"token comment\">// 获取参数表的指针</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>\tPUCHAR pArgumentTable <span class=\"token operator\">=</span> <span class=\"token operator\">*</span><span class=\"token punctuation\">(</span>KeServiceDescriptorTable <span class=\"token operator\">+</span> <span class=\"token number\">0x3</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>\t<span class=\"token function\">DbgPrint</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"pArgumentTable:%p\\t\\n\"</span><span class=\"token punctuation\">,</span> pArgumentTable<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>\t<span class=\"token comment\">// 开始修改</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>\t<span class=\"token comment\">// 取函数表的后一项的地址，新加的函数就是这个地址，因为索引是从 0 开始的。</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>\tPULONG ModifyAddress1 <span class=\"token operator\">=</span> pFuncTable <span class=\"token operator\">+</span> <span class=\"token operator\">*</span>pLimit<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>\t<span class=\"token comment\">// 取参数表的后一项的地址，新加的函数就是这个地址，因为索引是从 0 开始的。</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>\tPUCHAR ModifyAddress2 <span class=\"token operator\">=</span> pArgumentTable <span class=\"token operator\">+</span> <span class=\"token operator\">*</span>pLimit<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>\t<span class=\"token function\">DbgPrint</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"ModifyAddress1:%p\\t\\n\"</span><span class=\"token punctuation\">,</span> ModifyAddress1<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre>\t<span class=\"token function\">DbgPrint</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"ModifyAddress2:%p\\t\\n\"</span><span class=\"token punctuation\">,</span> ModifyAddress2<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>\t<span class=\"token comment\">// 修改为 ReadProcessMemory -> NtReadVirtualMemory -> 0xBA</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"55\"></td><td><pre>\t<span class=\"token function\">PageProtectOff</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>\t<span class=\"token operator\">*</span>ModifyAddress1 <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>ULONG<span class=\"token punctuation\">)</span>pFuncTable<span class=\"token punctuation\">[</span><span class=\"token number\">0xBA</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre>\t<span class=\"token operator\">*</span>pLimit <span class=\"token operator\">+=</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre>\t<span class=\"token operator\">*</span>ModifyAddress2 <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>UCHAR<span class=\"token punctuation\">)</span>pArgumentTable<span class=\"token punctuation\">[</span><span class=\"token number\">0xBA</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"59\"></td><td><pre>\t<span class=\"token function\">PageProtectOn</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre>\t<span class=\"token function\">DbgPrint</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"ModifyAddress1:%p\\t\\n\"</span><span class=\"token punctuation\">,</span> ModifyAddress1<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"61\"></td><td><pre>\t<span class=\"token function\">DbgPrint</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"*uLimit:%X\\t\\n\"</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">*</span>pLimit<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"62\"></td><td><pre>\t<span class=\"token function\">DbgPrint</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"ModifyAddress2:%p\\t\\n\"</span><span class=\"token punctuation\">,</span> ModifyAddress2<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"63\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"64\"></td><td><pre></pre></td></tr><tr><td data-num=\"65\"></td><td><pre>NTSTATUS <span class=\"token function\">DriverEntry</span><span class=\"token punctuation\">(</span>PDRIVER_OBJECT pDriver<span class=\"token punctuation\">,</span> PUNICODE_STRING pRegPath<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"66\"></td><td><pre>\tpDriver<span class=\"token operator\">-></span>DriverUnload <span class=\"token operator\">=</span> DriverUnload<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"67\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"68\"></td><td><pre>\t<span class=\"token comment\">// 修改 SSDT 表，增加一项。修改页保护</span></pre></td></tr><tr><td data-num=\"69\"></td><td><pre>\t<span class=\"token function\">ModifySSDT</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"70\"></td><td><pre></pre></td></tr><tr><td data-num=\"71\"></td><td><pre></pre></td></tr><tr><td data-num=\"72\"></td><td><pre>\t<span class=\"token keyword\">return</span> STATUS_SUCCESS<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"73\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p><strong>R3Call</strong></p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">_CRT_SECURE_NO_WARNINGS</span></span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span><span class=\"token string\">&lt;stdio.h></span></span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span><span class=\"token string\">&lt;Windows.h></span></span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token function\">__declspec</span><span class=\"token punctuation\">(</span>naked<span class=\"token punctuation\">)</span> <span class=\"token keyword\">void</span> <span class=\"token function\">ModZwWriteVirtualMemory</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>\t__asm <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>\t\tmov     eax<span class=\"token punctuation\">,</span> <span class=\"token number\">0x11C</span><span class=\"token punctuation\">;</span> NtReadVirtualMemory</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>\t\tmov     edx<span class=\"token punctuation\">,</span> <span class=\"token number\">7FF</span>E0300h</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\t\tcall    dword ptr<span class=\"token punctuation\">[</span>edx<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\t\tretn    <span class=\"token number\">0x14</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>BOOL WINAPI <span class=\"token function\">WriteProcessMemory_FAST</span><span class=\"token punctuation\">(</span>HANDLE hProcess<span class=\"token punctuation\">,</span> LPCVOID lpBaseAddress<span class=\"token punctuation\">,</span> LPVOID lpBuffer<span class=\"token punctuation\">,</span> DWORD nSize<span class=\"token punctuation\">,</span> LPDWORD lpNumberOfBytesWritten<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>\tLONG NtStatus<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>\t__asm</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>\t\t<span class=\"token comment\">// 模拟 WriteProcessMemory</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>\t\tlea eax<span class=\"token punctuation\">,</span> lpNumberOfBytesWritten<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>\t\tpush eax<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>\t\tpush lpNumberOfBytesWritten<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>\t\tpush nSize<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>\t\tpush lpBuffer<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>\t\tpush lpBaseAddress<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>\t\tpush hProcess<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>\t\tcall ModZwWriteVirtualMemory</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>\t\tmov NtStatus<span class=\"token punctuation\">,</span> eax<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>lpNumberOfBytesWritten <span class=\"token operator\">!=</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>\t\t<span class=\"token operator\">*</span>lpNumberOfBytesWritten <span class=\"token operator\">=</span> nSize<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>\t<span class=\"token comment\">// 错误检查</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>NtStatus <span class=\"token operator\">&lt;</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>\t\t<span class=\"token keyword\">return</span> FALSE<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>\t<span class=\"token keyword\">return</span> TRUE<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre><span class=\"token comment\">// 提权函数：提升为 DEBUG 权限</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>BOOL <span class=\"token function\">EnableDebugPrivilege</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>\tHANDLE hToken<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>\tBOOL fOk <span class=\"token operator\">=</span> FALSE<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">OpenProcessToken</span><span class=\"token punctuation\">(</span><span class=\"token function\">GetCurrentProcess</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> TOKEN_ADJUST_PRIVILEGES<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>hToken<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>\t\tTOKEN_PRIVILEGES tp<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>\t\ttp<span class=\"token punctuation\">.</span>PrivilegeCount <span class=\"token operator\">=</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>\t\t<span class=\"token function\">LookupPrivilegeValue</span><span class=\"token punctuation\">(</span><span class=\"token constant\">NULL</span><span class=\"token punctuation\">,</span> SE_DEBUG_NAME<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>tp<span class=\"token punctuation\">.</span>Privileges<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>Luid<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre></pre></td></tr><tr><td data-num=\"52\"></td><td><pre>\t\ttp<span class=\"token punctuation\">.</span>Privileges<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>Attributes <span class=\"token operator\">=</span> SE_PRIVILEGE_ENABLED<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>\t\t<span class=\"token function\">AdjustTokenPrivileges</span><span class=\"token punctuation\">(</span>hToken<span class=\"token punctuation\">,</span> FALSE<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>tp<span class=\"token punctuation\">,</span> <span class=\"token keyword\">sizeof</span><span class=\"token punctuation\">(</span>tp<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">,</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre></pre></td></tr><tr><td data-num=\"55\"></td><td><pre>\t\tfOk <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token function\">GetLastError</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> ERROR_SUCCESS<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>\t\t<span class=\"token function\">CloseHandle</span><span class=\"token punctuation\">(</span>hToken<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre>\t<span class=\"token keyword\">return</span> fOk<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"59\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre></pre></td></tr><tr><td data-num=\"61\"></td><td><pre><span class=\"token keyword\">int</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> argc<span class=\"token punctuation\">,</span> <span class=\"token keyword\">char</span><span class=\"token operator\">*</span> argv<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"62\"></td><td><pre>\t<span class=\"token function\">EnableDebugPrivilege</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"63\"></td><td><pre>\tDWORD pid<span class=\"token punctuation\">,</span> addr<span class=\"token punctuation\">,</span> dwRead<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"64\"></td><td><pre>\t<span class=\"token keyword\">char</span> buff<span class=\"token punctuation\">[</span><span class=\"token number\">20</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span> <span class=\"token number\">0</span> <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"65\"></td><td><pre>\t<span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"依次输入PID和要读的线性地址（均为16进制）...\\n\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"66\"></td><td><pre>\t<span class=\"token function\">scanf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"%x %x\"</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>pid<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>addr<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"67\"></td><td><pre>\t<span class=\"token function\">getchar</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"68\"></td><td><pre>\t<span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"buff:%p\\n\"</span><span class=\"token punctuation\">,</span> buff<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"69\"></td><td><pre></pre></td></tr><tr><td data-num=\"70\"></td><td><pre>\t<span class=\"token function\">WriteProcessMemory_FAST</span><span class=\"token punctuation\">(</span><span class=\"token function\">OpenProcess</span><span class=\"token punctuation\">(</span>PROCESS_ALL_ACCESS<span class=\"token punctuation\">,</span> FALSE<span class=\"token punctuation\">,</span> pid<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span>LPCVOID<span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span>addr<span class=\"token operator\">+</span><span class=\"token number\">4</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> buff<span class=\"token punctuation\">,</span> <span class=\"token number\">4</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>dwRead<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"71\"></td><td><pre>\t<span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"读取了%d个字节，内容是: \\\"%s\\\"\\n\"</span><span class=\"token punctuation\">,</span> dwRead<span class=\"token punctuation\">,</span> buff<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"72\"></td><td><pre>\t<span class=\"token function\">getchar</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"73\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p><strong>TestReWriteR3ApI</strong></p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;stdio.h></span></span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;windows.h></span></span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;Tlhelp32.h></span></span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token keyword\">int</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> argc<span class=\"token punctuation\">,</span> <span class=\"token keyword\">char</span><span class=\"token operator\">*</span> argv<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token comment\">// 获取进程自身的 PID</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    HANDLE hSnapshot <span class=\"token operator\">=</span> <span class=\"token function\">CreateToolhelp32Snapshot</span><span class=\"token punctuation\">(</span>TH32CS_SNAPPROCESS<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>INVALID_HANDLE_VALUE <span class=\"token operator\">==</span> hSnapshot<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>        <span class=\"token keyword\">return</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    PROCESSENTRY32 pi<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    pi<span class=\"token punctuation\">.</span>dwSize <span class=\"token operator\">=</span> <span class=\"token keyword\">sizeof</span><span class=\"token punctuation\">(</span>PROCESSENTRY32<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// 第一次使用必须初始化成员</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    BOOL bRet <span class=\"token operator\">=</span> <span class=\"token function\">Process32First</span><span class=\"token punctuation\">(</span>hSnapshot<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>pi<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span>bRet<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">strcmp</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"TestReWriteR3API.exe\"</span><span class=\"token punctuation\">,</span> pi<span class=\"token punctuation\">.</span>szExeFile<span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>        <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>            <span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"进程ID = %X \\r\\n\"</span><span class=\"token punctuation\">,</span> pi<span class=\"token punctuation\">.</span>th32ProcessID<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>            <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>        bRet <span class=\"token operator\">=</span> <span class=\"token function\">Process32Next</span><span class=\"token punctuation\">(</span>hSnapshot<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>pi<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>    <span class=\"token function\">CloseHandle</span><span class=\"token punctuation\">(</span>hSnapshot<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>    <span class=\"token keyword\">char</span> str<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token string\">\"hahahaha\"</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>    <span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"%p--%s\\n\"</span><span class=\"token punctuation\">,</span> str<span class=\"token punctuation\">,</span> str<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>    <span class=\"token function\">getchar</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>    <span class=\"token keyword\">return</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>截图：</p>\n<p><img data-src=\"image001.png\" alt=\"\" /></p>\n<h2 id=\"ssdt-hook-实现进程保护\"><a class=\"anchor\" href=\"#ssdt-hook-实现进程保护\">#</a> SSDT HOOK 实现进程保护</h2>\n<p>将系统服务表中某个函数改成自己的函数，使任务管理器右键无法关闭自己，只有点击自己的关闭按钮才可以正常关闭。</p>\n<p>方法是 SSDT HOOK NtTerminateProcess 函数，进行一系列的判断。就保护记事本 (notepad.exe) 了。</p>\n<p>个人思路是：</p>\n<blockquote>\n<p>先判断要结束的进程是否是记事本 (notepad.exe), 不是则调用老的 TerminateProcess 函数。如果是在判断当前进程是否是记事本 (notepad.exe)。</p>\n</blockquote>\n<p>判断当前进程是否是记事本 (notepad.exe)：<br />\n1、当前进程句柄的值是 0xFFFFFFFF ，只需要判断一下进程句柄是否是 0xFFFFFFFF 就知道是否是当前进程自己点击关闭按钮了。<br />\n2、调用 API，获取记事本的 pid，然后再 hook 的函数中获取当前进程的 pid，进行判断。<br />\n3、查 KPCR -&gt; 获取当前线程结构体 -&gt; 获取当前进程结构体 -&gt; 查当前进程的名字、也可以查当前进程的 pid // 因为我写博客写的有点晚，写这篇博客的时候进程与线程已经学了一些了。</p>\n<h3 id=\"代码如下-2\"><a class=\"anchor\" href=\"#代码如下-2\">#</a> 代码如下</h3>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span><span class=\"token string\">&lt;ntddk.h></span></span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token comment\">//SST 系统服务表</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token keyword\">typedef</span> <span class=\"token keyword\">struct</span> <span class=\"token class-name\">_KSYSTEM_SERVICE_TABLE</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>\tPULONG FuncTable<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>\tULONG Count<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\tULONG ServiceLimit<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\tPUCHAR ArgumentTable<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token punctuation\">&#125;</span>KSST<span class=\"token punctuation\">,</span> <span class=\"token operator\">*</span> PKSST<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre></pre></td></tr><tr><td data-num=\"13\"></td><td><pre></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token comment\">//SSDT </span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token keyword\">typedef</span> <span class=\"token keyword\">struct</span> <span class=\"token class-name\">_SSDT</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>\tKSST ServiceTable<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>\tKSST ServiceTableShadow<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>\tKSST un1<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>\tKSST un2<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre><span class=\"token punctuation\">&#125;</span>SSDT<span class=\"token punctuation\">,</span> <span class=\"token operator\">*</span> PSSDT<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre></pre></td></tr><tr><td data-num=\"23\"></td><td><pre><span class=\"token comment\">// 函数指针</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre><span class=\"token keyword\">typedef</span> <span class=\"token function\">BOOLEAN</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">*</span>pTerminateProcess<span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span>\tHANDLE hProcess<span class=\"token punctuation\">,</span> ULONG uExitCode<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre></pre></td></tr><tr><td data-num=\"26\"></td><td><pre><span class=\"token comment\">// 获取 SSDT 的导出变量</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre><span class=\"token keyword\">extern</span> PSSDT KeServiceDescriptorTable<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>ULONG OldNtTerminateProcess<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre></pre></td></tr><tr><td data-num=\"30\"></td><td><pre><span class=\"token comment\">// 声明函数</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>VOID <span class=\"token function\">DriverUnload</span><span class=\"token punctuation\">(</span>PDRIVER_OBJECT pDriver<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>NTSTATUS <span class=\"token function\">MyTerminateProcess</span><span class=\"token punctuation\">(</span>HANDLE hProcess<span class=\"token punctuation\">,</span> ULONG uExitCode<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>VOID <span class=\"token function\">HookFunc</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>VOID <span class=\"token function\">UnHookFunc</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>VOID <span class=\"token function\">PageProtectOn</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>VOID <span class=\"token function\">PageProtectOff</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>VOID <span class=\"token function\">DriverUnload</span><span class=\"token punctuation\">(</span>PDRIVER_OBJECT pDriver<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>\t<span class=\"token function\">UnHookFunc</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>\t<span class=\"token function\">DbgPrint</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"我是驱动我卸载了\\t\\n\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>VOID <span class=\"token function\">PageProtectOn</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>\t__asm <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>\t\tmov  eax<span class=\"token punctuation\">,</span> cr0</pre></td></tr><tr><td data-num=\"46\"></td><td><pre>\t\tor eax<span class=\"token punctuation\">,</span> <span class=\"token number\">10000</span>h</pre></td></tr><tr><td data-num=\"47\"></td><td><pre>\t\tmov  cr0<span class=\"token punctuation\">,</span> eax</pre></td></tr><tr><td data-num=\"48\"></td><td><pre>\t\tsti</pre></td></tr><tr><td data-num=\"49\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre></pre></td></tr><tr><td data-num=\"52\"></td><td><pre>VOID <span class=\"token function\">PageProtectOff</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre>\t__asm <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre>\t\tcli</pre></td></tr><tr><td data-num=\"56\"></td><td><pre>\t\tmov  eax<span class=\"token punctuation\">,</span> cr0</pre></td></tr><tr><td data-num=\"57\"></td><td><pre>\t\tand eax<span class=\"token punctuation\">,</span> not <span class=\"token number\">10000</span>h</pre></td></tr><tr><td data-num=\"58\"></td><td><pre>\t\tmov  cr0<span class=\"token punctuation\">,</span> eax</pre></td></tr><tr><td data-num=\"59\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"61\"></td><td><pre></pre></td></tr><tr><td data-num=\"62\"></td><td><pre>VOID <span class=\"token function\">HookFunc</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"63\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"64\"></td><td><pre>\t<span class=\"token function\">DbgPrint</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"The start of the hook!\\t\\n\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"65\"></td><td><pre>\t<span class=\"token function\">PageProtectOff</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"66\"></td><td><pre>\tKeServiceDescriptorTable<span class=\"token operator\">-></span>ServiceTable<span class=\"token punctuation\">.</span>FuncTable<span class=\"token punctuation\">[</span><span class=\"token number\">0x101</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>ULONG<span class=\"token punctuation\">)</span>MyTerminateProcess<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"67\"></td><td><pre>\t<span class=\"token function\">PageProtectOn</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"68\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"69\"></td><td><pre></pre></td></tr><tr><td data-num=\"70\"></td><td><pre>VOID <span class=\"token function\">UnHookFunc</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"71\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"72\"></td><td><pre>\t<span class=\"token function\">PageProtectOff</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"73\"></td><td><pre>\tKeServiceDescriptorTable<span class=\"token operator\">-></span>ServiceTable<span class=\"token punctuation\">.</span>FuncTable<span class=\"token punctuation\">[</span><span class=\"token number\">0x101</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> OldNtTerminateProcess<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"74\"></td><td><pre>\t<span class=\"token function\">PageProtectOn</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"75\"></td><td><pre>\t<span class=\"token function\">DbgPrint</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"The end of the hook!\\t\\n\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"76\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"77\"></td><td><pre></pre></td></tr><tr><td data-num=\"78\"></td><td><pre>NTSTATUS <span class=\"token function\">MyTerminateProcess</span><span class=\"token punctuation\">(</span>HANDLE hProcess<span class=\"token punctuation\">,</span>\tULONG uExitCode<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"79\"></td><td><pre>\tULONG NotepadPid<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"80\"></td><td><pre>\tPUCHAR pImageFileName<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"81\"></td><td><pre>\tULONG pEprocess<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"82\"></td><td><pre></pre></td></tr><tr><td data-num=\"83\"></td><td><pre>\tNTSTATUS status <span class=\"token operator\">=</span> <span class=\"token function\">ObReferenceObjectByHandle</span><span class=\"token punctuation\">(</span>hProcess<span class=\"token punctuation\">,</span> FILE_READ_DATA<span class=\"token punctuation\">,</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">,</span> KernelMode<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span>PVOID<span class=\"token operator\">*</span><span class=\"token punctuation\">)</span><span class=\"token operator\">&amp;</span>pEprocess<span class=\"token punctuation\">,</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"84\"></td><td><pre>\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token function\">NT_SUCCESS</span><span class=\"token punctuation\">(</span>status<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"85\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"86\"></td><td><pre>\t\t<span class=\"token keyword\">return</span> status<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"87\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"88\"></td><td><pre>\t<span class=\"token comment\">// 判断要关闭的是否是记事本 (notepad.exe)，这里进程名的字符字符串最大是 16，所以不用担心越界</span></pre></td></tr><tr><td data-num=\"89\"></td><td><pre>\tpImageFileName <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>PUCHAR<span class=\"token punctuation\">)</span>pEprocess <span class=\"token operator\">+</span> <span class=\"token number\">0x174</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"90\"></td><td><pre></pre></td></tr><tr><td data-num=\"91\"></td><td><pre>\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">strcmp</span><span class=\"token punctuation\">(</span>pImageFileName<span class=\"token punctuation\">,</span> <span class=\"token string\">\"notepad.exe\"</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"92\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"93\"></td><td><pre>\t\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>hProcess <span class=\"token operator\">==</span> <span class=\"token punctuation\">(</span>HANDLE<span class=\"token punctuation\">)</span><span class=\"token number\">0xFFFFFFFF</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"94\"></td><td><pre>\t\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"95\"></td><td><pre>\t\t\t<span class=\"token comment\">// 通过关闭按钮关闭</span></pre></td></tr><tr><td data-num=\"96\"></td><td><pre>\t\t\t<span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>pTerminateProcess<span class=\"token punctuation\">)</span>OldNtTerminateProcess<span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span>hProcess<span class=\"token punctuation\">,</span> uExitCode<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"97\"></td><td><pre>\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"98\"></td><td><pre>\t\t<span class=\"token keyword\">else</span></pre></td></tr><tr><td data-num=\"99\"></td><td><pre>\t\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"100\"></td><td><pre>\t\t\t<span class=\"token comment\">// 通过任务管理器关闭</span></pre></td></tr><tr><td data-num=\"101\"></td><td><pre>\t\t\t<span class=\"token function\">DbgPrint</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Terminate denied. %s: NtTerminateProcess(%x, %x)\\n\"</span><span class=\"token punctuation\">,</span> pImageFileName<span class=\"token punctuation\">,</span> hProcess<span class=\"token punctuation\">,</span> uExitCode<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"102\"></td><td><pre>\t\t\t<span class=\"token keyword\">return</span> STATUS_ACCESS_DENIED<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"103\"></td><td><pre>\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"104\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"105\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"106\"></td><td><pre>\t<span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>pTerminateProcess<span class=\"token punctuation\">)</span>OldNtTerminateProcess<span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span>hProcess<span class=\"token punctuation\">,</span> uExitCode<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"107\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"108\"></td><td><pre></pre></td></tr><tr><td data-num=\"109\"></td><td><pre>NTSTATUS <span class=\"token function\">DriverEntry</span><span class=\"token punctuation\">(</span>PDRIVER_OBJECT pDriver<span class=\"token punctuation\">,</span> PUNICODE_STRING pRegPath<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"110\"></td><td><pre>\tpDriver<span class=\"token operator\">-></span>DriverUnload <span class=\"token operator\">=</span> DriverUnload<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"111\"></td><td><pre></pre></td></tr><tr><td data-num=\"112\"></td><td><pre>\t<span class=\"token comment\">// 定义老的 NtTerminateProcess</span></pre></td></tr><tr><td data-num=\"113\"></td><td><pre>\tOldNtTerminateProcess <span class=\"token operator\">=</span> KeServiceDescriptorTable<span class=\"token operator\">-></span>ServiceTable<span class=\"token punctuation\">.</span>FuncTable<span class=\"token punctuation\">[</span><span class=\"token number\">0x101</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"114\"></td><td><pre>\t<span class=\"token function\">DbgPrint</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"OldNtTerminateProcess:%X\\t\\n\"</span><span class=\"token punctuation\">,</span> OldNtTerminateProcess<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"115\"></td><td><pre>\t<span class=\"token comment\">//SSDT HOOK TerminateProcess</span></pre></td></tr><tr><td data-num=\"116\"></td><td><pre>\t<span class=\"token function\">HookFunc</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"117\"></td><td><pre></pre></td></tr><tr><td data-num=\"118\"></td><td><pre>\t<span class=\"token keyword\">return</span> STATUS_SUCCESS<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"119\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>截图：</p>\n<p><img data-src=\"image002.png\" alt=\"\" /></p>\n<p><strong>发现在这里点击结束任务</strong>，还是可以结束。</p>\n<p><img data-src=\"image003.png\" alt=\"\" /></p>\n<p>不论是点击结束进程或是进程树，都无法结束</p>\n<p><img data-src=\"image004.png\" alt=\"\" /></p>\n<p>驱动卸载后，hook 也就卸载了。</p>\n<h2 id=\"ssdt-hook-实现-findwindowa-监视器\"><a class=\"anchor\" href=\"#ssdt-hook-实现-findwindowa-监视器\">#</a> SSDT HOOK 实现 FindWindowA 监视器</h2>\n<p>FinWindowsA 是 Shadow 表中的函数。</p>\n<p>3 环调用流程分析</p>\n<p>FinWindowsA -&gt; 调用一系列的 ASCII 转 Unicode 函数，最终调用 -&gt; NtUserFindWindowEx</p>\n<p>传入服务号为 0x117A 。<strong>注意真正的编号还要与 0xFFF 进行与操作</strong>。</p>\n<p>win32k.sys 系统服务表可能会缺页，要在驱动里访问它，做法是创建一个已经调用过 GDI 函数的进程（不一定是窗口程序），然后通过 DeviceIoControl 函数和驱动通信，这样执行驱动代码时所属进程已经给 win32k.sys 系统服务表挂上物理页了，访问就不会蓝屏。这里参考：<span class=\"exturl\" data-url=\"aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L0t3YW5zeS9hcnRpY2xlL2RldGFpbHMvMTA5NTEwNjA2\">https://blog.csdn.net/Kwansy/article/details/109510606</span> 博主的文章，具体要自己逆向创建 GDI 线程的部分，才能清晰。</p>\n<p>并且还可以发现一个细节：<strong>当 3 环程序向驱动发起通信时，驱动所属进程就是 3 环的程序</strong></p>\n<h3 id=\"代码如下-3\"><a class=\"anchor\" href=\"#代码如下-3\">#</a> 代码如下</h3>\n<pre><code class=\"language-c\">\n</code></pre>\n<h1 id=\"reference\"><a class=\"anchor\" href=\"#reference\">#</a> Reference</h1>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L0t3YW5zeS9hcnRpY2xlL2RldGFpbHMvMTA5NTEwNjA2\">https://blog.csdn.net/Kwansy/article/details/109510606</span><br />\n<span class=\"exturl\" data-url=\"aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L0t3YW5zeS9hcnRpY2xlL2RldGFpbHMvMTA5NDkwNjU3\">https://blog.csdn.net/Kwansy/article/details/109490657</span></p>\n",
            "tags": [
                "系统调用阶段总结"
            ]
        },
        {
            "id": "https://or0kit.github.io/Bin/Core/WindowsXp/SystemCall/%E7%B3%BB%E7%BB%9F%E8%B0%83%E7%94%A8-SSDT%E9%9A%90%E8%97%8F-%E6%80%9D%E8%B7%AF-%E5%AE%9E%E6%88%98/",
            "url": "https://or0kit.github.io/Bin/Core/WindowsXp/SystemCall/%E7%B3%BB%E7%BB%9F%E8%B0%83%E7%94%A8-SSDT%E9%9A%90%E8%97%8F-%E6%80%9D%E8%B7%AF-%E5%AE%9E%E6%88%98/",
            "title": "系统调用-SSDT HOOK隐藏-思路-实战",
            "date_published": "2022-01-01T00:52:22.000Z",
            "content_html": "<h1 id=\"ssdt-hook隐藏思路\"><a class=\"anchor\" href=\"#ssdt-hook隐藏思路\">#</a> SSDT HOOK 隐藏思路</h1>\n<p>通过逆向分析 API 由 3 环进 0 环的过程，找到其中涉及系统服务表（SST）的位置，可以分析出一些能动手脚的地方。</p>\n<ol>\n<li>\n<p>增加函数项，修改原有代码服务号。</p>\n</li>\n<li>\n<p>修改线程结构体_KTHREAD + E0 （这里存放着 SSDT 的地址），改成我们的自己构造的 SSDT。<br />\n针对的检测是：检测老的 SSDT 有没有被挂钩，但我们不动操作系统的 SSDT 这样就可以绕过了。</p>\n</li>\n</ol>\n<blockquote>\n<p>首先找到进程再找其内的线程结构体，然后修改为我们构造的 SSDT 的地址，既要先拷贝一份 SSDT，并且因为线程可能会被切换，我们要设置一个定时器不停的遍历修改。<br />\n或者修改把线程 E0 赋给 edi 的值，既 INLINE HOOK 修改这里。</p>\n</blockquote>\n<ol start=\"3\">\n<li>系统调用过程中有两个环节是 找到要调用的函数 以及 去调用这个函数，我们可以改找到的函数，改调用的函数。</li>\n</ol>\n<p>另外火哥还说了 改所有线程的 E0，在切换线程的地方 HOOK 等等……。</p>\n<p>在 SSDT 这里能做的前辈们差不多都已经做过了…… 我们主要学习的是思想。・</p>\n<h1 id=\"代码实现\"><a class=\"anchor\" href=\"#代码实现\">#</a> 代码实现</h1>\n<p><strong>Hook.h</strong></p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">pragma</span> <span class=\"token expression\">once</span></span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">\"ssdt.h\"</span></span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token comment\">// 被 HOOK 函数的函数指针</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token comment\">//HOOK NtOpenProcess 函数</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token keyword\">typedef</span> <span class=\"token function\">NTSTATUS</span><span class=\"token punctuation\">(</span>NTAPI <span class=\"token operator\">*</span>PNTOPENPROCESS<span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>     PHANDLE ProcessHandle<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>     ACCESS_MASK DesiredAccess<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>     POBJECT_ATTRIBUTES ObjectAttributes<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>     PCLIENT_ID ClientId</pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre></pre></td></tr><tr><td data-num=\"14\"></td><td><pre></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token comment\">// 函数声明</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>VOID <span class=\"token function\">HookNtOpenProcess</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>VOID <span class=\"token function\">UnHookNtOpenProcess</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>VOID <span class=\"token function\">PageProtectOn</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>VOID <span class=\"token function\">PageProtectOff</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>NTSTATUS NTAPI <span class=\"token function\">ModifyNtOpenProcess</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>     PHANDLE ProcessHandle<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>     ACCESS_MASK DesiredAccess<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>     POBJECT_ATTRIBUTES ObjectAttributes<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>     PCLIENT_ID ClientId</pre></td></tr><tr><td data-num=\"26\"></td><td><pre><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre></pre></td></tr><tr><td data-num=\"28\"></td><td><pre><span class=\"token comment\">// 原来的函数地址</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>ULONG uOldNtOpenProcess<span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p><strong>Hook.c</strong></p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">\"Hook.h\"</span></span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>VOID <span class=\"token function\">PageProtectOff</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>\t__asm</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>\t\tcli<span class=\"token punctuation\">;</span> <span class=\"token comment\">// 关闭中断</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>\t\tmov eax<span class=\"token punctuation\">,</span> cr0<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\t\tor eax<span class=\"token punctuation\">,</span> <span class=\"token number\">0x10000</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// WP 位置 1</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\t\tmov cr0<span class=\"token punctuation\">,</span> eax<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre></pre></td></tr><tr><td data-num=\"14\"></td><td><pre></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>VOID <span class=\"token function\">PageProtectOn</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>\t__asm</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>\t\tsti<span class=\"token punctuation\">;</span> <span class=\"token comment\">// 恢复中断</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>\t\tmov eax<span class=\"token punctuation\">,</span> cr0<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>\t\tand eax<span class=\"token punctuation\">,</span> not <span class=\"token number\">0x10000</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// WP 位置 0</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>\t\tmov cr0<span class=\"token punctuation\">,</span> eax<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>VOID <span class=\"token function\">HookNtOpenProcess</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>\t<span class=\"token function\">DbgPrint</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"The start of the hook!\\t\\n\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>\t<span class=\"token function\">PageProtectOff</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>\tMySSDT<span class=\"token operator\">-></span>ServiceTable<span class=\"token punctuation\">.</span>FuncTable<span class=\"token punctuation\">[</span><span class=\"token number\">0x7A</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>ULONG<span class=\"token punctuation\">)</span>ModifyNtOpenProcess<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>\t<span class=\"token function\">PageProtectOn</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>VOID <span class=\"token function\">UnHookNtOpenProcess</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>\t<span class=\"token function\">PageProtectOff</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>\tMySSDT<span class=\"token operator\">-></span>ServiceTable<span class=\"token punctuation\">.</span>FuncTable<span class=\"token punctuation\">[</span><span class=\"token number\">0x7A</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> uOldNtOpenProcess<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>\t<span class=\"token function\">PageProtectOn</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>\t<span class=\"token function\">DbgPrint</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"The end of the hook!\\t\\n\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre></pre></td></tr><tr><td data-num=\"42\"></td><td><pre></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>NTSTATUS NTAPI <span class=\"token function\">ModifyNtOpenProcess</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>\tPHANDLE ProcessHandle<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>\tACCESS_MASK DesiredAccess<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>\tPOBJECT_ATTRIBUTES ObjectAttributes<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>\tPCLIENT_ID ClientId</pre></td></tr><tr><td data-num=\"48\"></td><td><pre><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>\t<span class=\"token function\">DbgPrint</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"打印NtOpenProcess的参数：%X %X %X %X\\t\\n\"</span><span class=\"token punctuation\">,</span> ProcessHandle<span class=\"token punctuation\">,</span> DesiredAccess<span class=\"token punctuation\">,</span> ObjectAttributes<span class=\"token punctuation\">,</span> ClientId<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>\t<span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>PNTOPENPROCESS<span class=\"token punctuation\">)</span>uOldNtOpenProcess<span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span>ProcessHandle<span class=\"token punctuation\">,</span> DesiredAccess<span class=\"token punctuation\">,</span> ObjectAttributes<span class=\"token punctuation\">,</span> ClientId<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p><strong>ssdt.h</strong></p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">pragma</span> <span class=\"token expression\">once</span></span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span><span class=\"token string\">&lt;ntddk.h></span></span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token comment\">//SST 系统服务表</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token keyword\">typedef</span> <span class=\"token keyword\">struct</span> <span class=\"token class-name\">_KSYSTEM_SERVICE_TABLE</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>\tPULONG FuncTable<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>\tPULONG Count<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\tULONG ServiceLimit<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\tPUCHAR ArgumentTable<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token punctuation\">&#125;</span>KSST<span class=\"token punctuation\">,</span> <span class=\"token operator\">*</span> PKSST<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre></pre></td></tr><tr><td data-num=\"13\"></td><td><pre></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token comment\">//SSDT </span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token keyword\">typedef</span> <span class=\"token keyword\">struct</span> <span class=\"token class-name\">_SSDT</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>\tKSST ServiceTable<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>\tKSST ServiceTableShadow<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>\tKSST un1<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>\tKSST un2<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre><span class=\"token punctuation\">&#125;</span>SSDT<span class=\"token punctuation\">,</span> <span class=\"token operator\">*</span> PSSDT<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre></pre></td></tr><tr><td data-num=\"23\"></td><td><pre></pre></td></tr><tr><td data-num=\"24\"></td><td><pre></pre></td></tr><tr><td data-num=\"25\"></td><td><pre><span class=\"token comment\">// 构造 SSDT</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>PSSDT MySSDT<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>BOOLEAN ThreadFlag<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>HANDLE hThread<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre><span class=\"token comment\">// 获取 SSDT 的导出变量</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre><span class=\"token keyword\">extern</span> PSSDT KeServiceDescriptorTable<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre></pre></td></tr><tr><td data-num=\"32\"></td><td><pre></pre></td></tr><tr><td data-num=\"33\"></td><td><pre><span class=\"token comment\">// 声明函数</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>VOID <span class=\"token function\">DriverUnload</span><span class=\"token punctuation\">(</span>PDRIVER_OBJECT pDriver<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>NTSTATUS <span class=\"token function\">DriverEntry</span><span class=\"token punctuation\">(</span>PDRIVER_OBJECT pDriver<span class=\"token punctuation\">,</span> PUNICODE_STRING pRegPath<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>NTSTATUS <span class=\"token function\">GetCopySSDT</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>ULONG <span class=\"token function\">FindProcess</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">char</span><span class=\"token operator\">*</span> ProcessName<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>VOID <span class=\"token function\">TraversalThreadReplaceE0</span><span class=\"token punctuation\">(</span>ULONG eProcess<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>VOID <span class=\"token function\">ResetThreadReplaceE0</span><span class=\"token punctuation\">(</span>ULONG eProc<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>VOID <span class=\"token function\">WorkThreadFunc</span><span class=\"token punctuation\">(</span>_In_ PVOID StartContext<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p><strong>main.c</strong></p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span><span class=\"token string\">\"Hook.h\"</span></span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>VOID <span class=\"token function\">DriverUnload</span><span class=\"token punctuation\">(</span>PDRIVER_OBJECT pDriver<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>\tThreadFlag <span class=\"token operator\">=</span> FALSE<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>\t<span class=\"token comment\">// 确保线程停止</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>\tLARGE_INTEGER timer <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span> <span class=\"token number\">0</span> <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\ttimer<span class=\"token punctuation\">.</span>QuadPart <span class=\"token operator\">=</span> <span class=\"token operator\">-</span><span class=\"token number\">30</span> <span class=\"token operator\">*</span> <span class=\"token number\">1000</span> <span class=\"token operator\">*</span> <span class=\"token number\">1000</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\t<span class=\"token function\">KeDelayExecutionThread</span><span class=\"token punctuation\">(</span>KernelMode<span class=\"token punctuation\">,</span> TRUE<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>timer<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>MySSDT <span class=\"token operator\">!=</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>\t\t<span class=\"token function\">ExFreePoolWithTag</span><span class=\"token punctuation\">(</span>MySSDT<span class=\"token operator\">-></span>ServiceTable<span class=\"token punctuation\">.</span>FuncTable<span class=\"token punctuation\">,</span> <span class=\"token string\">'MySF'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>\t\tMySSDT<span class=\"token operator\">-></span>ServiceTable<span class=\"token punctuation\">.</span>FuncTable <span class=\"token operator\">=</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>\t\t<span class=\"token function\">ExFreePoolWithTag</span><span class=\"token punctuation\">(</span>MySSDT<span class=\"token punctuation\">,</span> <span class=\"token string\">'MySD'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>\t\tMySSDT <span class=\"token operator\">=</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>\t<span class=\"token function\">DbgPrint</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"我是驱动，我卸载了\\t\\n\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>\t<span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>NTSTATUS <span class=\"token function\">GetCopySSDT</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>\t<span class=\"token comment\">//DbgPrint(\"KeServiceDescriptorTable:%p\\t\\n\", KeServiceDescriptorTable);</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>\tPSSDT SSDTShadow <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>PSSDT<span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span><span class=\"token operator\">*</span><span class=\"token punctuation\">(</span>PULONG<span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>KeServiceDescriptorTable<span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span> <span class=\"token number\">0x40</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>\t<span class=\"token comment\">//DbgPrint(\"SSDTShadow:%p\\t\\n\", SSDTShadow);</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>\t<span class=\"token comment\">//__asm int 3;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>\t<span class=\"token comment\">// </span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>\t<span class=\"token comment\">// 构造一份 SSDT</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>\t<span class=\"token comment\">// 申请一份 SSDT 大小的内存</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>\tMySSDT <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>PSSDT<span class=\"token punctuation\">)</span><span class=\"token function\">ExAllocatePoolWithTag</span><span class=\"token punctuation\">(</span>NonPagedPool<span class=\"token punctuation\">,</span> <span class=\"token keyword\">sizeof</span><span class=\"token punctuation\">(</span>SSDT<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'MySD'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>MySSDT <span class=\"token operator\">==</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>\t\t<span class=\"token function\">DbgPrint</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"MySD ExAllocatePoolWithTag Failed!\\t\\n\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>\t\t<span class=\"token keyword\">return</span> STATUS_UNSUCCESSFUL<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>\t<span class=\"token function\">memset</span><span class=\"token punctuation\">(</span>MySSDT<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">sizeof</span><span class=\"token punctuation\">(</span>SSDT<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>\t<span class=\"token function\">DbgPrint</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"MySSDT:%p\\t\\n\"</span><span class=\"token punctuation\">,</span> MySSDT<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>\t<span class=\"token comment\">// 申请函数表的内存</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>\tMySSDT<span class=\"token operator\">-></span>ServiceTable<span class=\"token punctuation\">.</span>FuncTable <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>PULONG<span class=\"token punctuation\">)</span><span class=\"token function\">ExAllocatePoolWithTag</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>\t\tNonPagedPool<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>\t\tKeServiceDescriptorTable<span class=\"token operator\">-></span>ServiceTable<span class=\"token punctuation\">.</span>ServiceLimit <span class=\"token operator\">*</span> <span class=\"token number\">4</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>\t\t<span class=\"token string\">'MySF'</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>\t<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>MySSDT<span class=\"token operator\">-></span>ServiceTable<span class=\"token punctuation\">.</span>FuncTable <span class=\"token operator\">==</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>\t\t<span class=\"token function\">ExFreePoolWithTag</span><span class=\"token punctuation\">(</span>MySSDT<span class=\"token punctuation\">,</span> <span class=\"token string\">'MySD'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre>\t\tMySSDT <span class=\"token operator\">=</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>\t\t<span class=\"token function\">DbgPrint</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"MySF ExAllocatePoolWithTag Failed!\\t\\n\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre>\t\t<span class=\"token keyword\">return</span> STATUS_UNSUCCESSFUL<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>\t<span class=\"token function\">memset</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>PVOID<span class=\"token punctuation\">)</span>MySSDT<span class=\"token operator\">-></span>ServiceTable<span class=\"token punctuation\">.</span>FuncTable<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> KeServiceDescriptorTable<span class=\"token operator\">-></span>ServiceTable<span class=\"token punctuation\">.</span>ServiceLimit <span class=\"token operator\">*</span> <span class=\"token number\">4</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre></pre></td></tr><tr><td data-num=\"58\"></td><td><pre>\t<span class=\"token comment\">// 拷贝 SSDT</span></pre></td></tr><tr><td data-num=\"59\"></td><td><pre></pre></td></tr><tr><td data-num=\"60\"></td><td><pre>\t<span class=\"token function\">memcpy</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>PVOID<span class=\"token punctuation\">)</span>MySSDT<span class=\"token operator\">-></span>ServiceTable<span class=\"token punctuation\">.</span>FuncTable<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span>PVOID<span class=\"token punctuation\">)</span>KeServiceDescriptorTable<span class=\"token operator\">-></span>ServiceTable<span class=\"token punctuation\">.</span>FuncTable<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"61\"></td><td><pre>\t\tKeServiceDescriptorTable<span class=\"token operator\">-></span>ServiceTable<span class=\"token punctuation\">.</span>ServiceLimit <span class=\"token operator\">*</span> <span class=\"token number\">4</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"62\"></td><td><pre>\tMySSDT<span class=\"token operator\">-></span>ServiceTable<span class=\"token punctuation\">.</span>ServiceLimit <span class=\"token operator\">=</span> KeServiceDescriptorTable<span class=\"token operator\">-></span>ServiceTable<span class=\"token punctuation\">.</span>ServiceLimit<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"63\"></td><td><pre>\tMySSDT<span class=\"token operator\">-></span>ServiceTable<span class=\"token punctuation\">.</span>ArgumentTable <span class=\"token operator\">=</span> KeServiceDescriptorTable<span class=\"token operator\">-></span>ServiceTable<span class=\"token punctuation\">.</span>ArgumentTable<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"64\"></td><td><pre></pre></td></tr><tr><td data-num=\"65\"></td><td><pre>\t<span class=\"token comment\">// 拷贝 Shadow 表</span></pre></td></tr><tr><td data-num=\"66\"></td><td><pre>\t<span class=\"token comment\">// 判断 GUI 函数表是否已经加载，如果不是 GUI 线程，则操作系统不会挂载 GUI 函数表</span></pre></td></tr><tr><td data-num=\"67\"></td><td><pre></pre></td></tr><tr><td data-num=\"68\"></td><td><pre>\t<span class=\"token comment\">// 思路判断 Shadwo 函数表的物理页属性</span></pre></td></tr><tr><td data-num=\"69\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"70\"></td><td><pre>\t<span class=\"token comment\">//if (影子表中的函数表被挂载了)</span></pre></td></tr><tr><td data-num=\"71\"></td><td><pre>\t<span class=\"token comment\">//&#123;</span></pre></td></tr><tr><td data-num=\"72\"></td><td><pre>\t<span class=\"token comment\">//\t// 申请影子表中函数表的内存</span></pre></td></tr><tr><td data-num=\"73\"></td><td><pre>\t<span class=\"token comment\">//\tMySSDT->ServiceTableShadow.FuncTable = (PULONG)ExAllocatePoolWithTag(</span></pre></td></tr><tr><td data-num=\"74\"></td><td><pre>\t<span class=\"token comment\">//\t\tNonPagedPool,</span></pre></td></tr><tr><td data-num=\"75\"></td><td><pre>\t<span class=\"token comment\">//\t\tSSDTShadow->ServiceTableShadow.ServiceLimit * 4,</span></pre></td></tr><tr><td data-num=\"76\"></td><td><pre>\t<span class=\"token comment\">//\t\t'MySH'</span></pre></td></tr><tr><td data-num=\"77\"></td><td><pre>\t<span class=\"token comment\">//\t);</span></pre></td></tr><tr><td data-num=\"78\"></td><td><pre>\t<span class=\"token comment\">//\tif (MySSDT->ServiceTableShadow.FuncTable == NULL)</span></pre></td></tr><tr><td data-num=\"79\"></td><td><pre>\t<span class=\"token comment\">//\t&#123;</span></pre></td></tr><tr><td data-num=\"80\"></td><td><pre>\t<span class=\"token comment\">//\t\tExFreePoolWithTag(MySSDT->ServiceTable.FuncTable, 'MySF');</span></pre></td></tr><tr><td data-num=\"81\"></td><td><pre>\t<span class=\"token comment\">//\t\tExFreePoolWithTag(MySSDT, 'MySD');</span></pre></td></tr><tr><td data-num=\"82\"></td><td><pre>\t<span class=\"token comment\">//\t\tDbgPrint(\"MySH ExAllocatePoolWithTag Failed!\\t\\n\");</span></pre></td></tr><tr><td data-num=\"83\"></td><td><pre>\t<span class=\"token comment\">//\t\treturn STATUS_UNSUCCESSFUL;</span></pre></td></tr><tr><td data-num=\"84\"></td><td><pre>\t<span class=\"token comment\">//\t&#125;</span></pre></td></tr><tr><td data-num=\"85\"></td><td><pre>\t<span class=\"token comment\">//\tmemset((PVOID)MySSDT->ServiceTableShadow.FuncTable, 0, SSDTShadow->ServiceTableShadow.ServiceLimit * 4);</span></pre></td></tr><tr><td data-num=\"86\"></td><td><pre>\t<span class=\"token comment\">//\tmemcpy((PVOID)MySSDT->ServiceTableShadow.FuncTable, (PVOID)SSDTShadow->ServiceTableShadow.FuncTable,</span></pre></td></tr><tr><td data-num=\"87\"></td><td><pre>\t<span class=\"token comment\">//\t\tSSDTShadow->ServiceTableShadow.ServiceLimit * 4);</span></pre></td></tr><tr><td data-num=\"88\"></td><td><pre></pre></td></tr><tr><td data-num=\"89\"></td><td><pre>\tMySSDT<span class=\"token operator\">-></span>ServiceTableShadow<span class=\"token punctuation\">.</span>FuncTable <span class=\"token operator\">=</span> SSDTShadow<span class=\"token operator\">-></span>ServiceTableShadow<span class=\"token punctuation\">.</span>FuncTable<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"90\"></td><td><pre></pre></td></tr><tr><td data-num=\"91\"></td><td><pre>\tMySSDT<span class=\"token operator\">-></span>ServiceTableShadow<span class=\"token punctuation\">.</span>ServiceLimit <span class=\"token operator\">=</span> SSDTShadow<span class=\"token operator\">-></span>ServiceTableShadow<span class=\"token punctuation\">.</span>ServiceLimit<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"92\"></td><td><pre>\tMySSDT<span class=\"token operator\">-></span>ServiceTableShadow<span class=\"token punctuation\">.</span>ArgumentTable <span class=\"token operator\">=</span> SSDTShadow<span class=\"token operator\">-></span>ServiceTableShadow<span class=\"token punctuation\">.</span>ArgumentTable<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"93\"></td><td><pre></pre></td></tr><tr><td data-num=\"94\"></td><td><pre><span class=\"token keyword\">return</span> STATUS_SUCCESS<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"95\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"96\"></td><td><pre></pre></td></tr><tr><td data-num=\"97\"></td><td><pre></pre></td></tr><tr><td data-num=\"98\"></td><td><pre><span class=\"token comment\">// 遍历进程 找到进程</span></pre></td></tr><tr><td data-num=\"99\"></td><td><pre>ULONG <span class=\"token function\">FindProcess</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">char</span><span class=\"token operator\">*</span> ProcessName<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"100\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"101\"></td><td><pre></pre></td></tr><tr><td data-num=\"102\"></td><td><pre>\tULONG Pro<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"103\"></td><td><pre>\t<span class=\"token comment\">// 由 KPCR+0x124 的位置得到当前 CPU 正在处理的线程的结构体的指针，_KTHREAD + 0x44 的位置能够得到此线程的进程结构体的地址</span></pre></td></tr><tr><td data-num=\"104\"></td><td><pre>\t__asm <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"105\"></td><td><pre>\t\tmov eax<span class=\"token punctuation\">,</span> fs<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token number\">0x124</span><span class=\"token punctuation\">]</span> <span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"106\"></td><td><pre>\t\tmov ecx<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span>eax <span class=\"token operator\">+</span> <span class=\"token number\">0x44</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"107\"></td><td><pre>\t\tmov Pro<span class=\"token punctuation\">,</span> ecx<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"108\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"109\"></td><td><pre>\t<span class=\"token comment\">// 进程结构体 EPROCESS +0x88 的位置是一个链接所有进程的双向链表</span></pre></td></tr><tr><td data-num=\"110\"></td><td><pre>\tPLIST_ENTRY pListProcess <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>PLIST_ENTRY<span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span>Pro <span class=\"token operator\">+</span> <span class=\"token number\">0x88</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"111\"></td><td><pre>\tBOOLEAN Flag <span class=\"token operator\">=</span> FALSE<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"112\"></td><td><pre></pre></td></tr><tr><td data-num=\"113\"></td><td><pre>\t<span class=\"token comment\">// 遍历进程</span></pre></td></tr><tr><td data-num=\"114\"></td><td><pre>\t<span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span>pListProcess<span class=\"token operator\">-></span>Flink <span class=\"token operator\">!=</span> <span class=\"token punctuation\">(</span>PLIST_ENTRY<span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span>Pro <span class=\"token operator\">+</span> <span class=\"token number\">0x88</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"115\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"116\"></td><td><pre>\t\t<span class=\"token comment\">//EPROCESS 结构体</span></pre></td></tr><tr><td data-num=\"117\"></td><td><pre>\t\tULONG NextProcess <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>ULONG<span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span>pListProcess<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span> <span class=\"token number\">0x88</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"118\"></td><td><pre>\t\t</pre></td></tr><tr><td data-num=\"119\"></td><td><pre>\t\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">strcmp</span><span class=\"token punctuation\">(</span>ProcessName<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span>PCHAR<span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span>NextProcess <span class=\"token operator\">+</span> <span class=\"token number\">0x174</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"120\"></td><td><pre>\t\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"121\"></td><td><pre>\t\t\t<span class=\"token function\">DbgPrint</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"FindProcess:%s PEPROCESS:%X\\t\\n\"</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>PCHAR<span class=\"token punctuation\">)</span>NextProcess <span class=\"token operator\">+</span> <span class=\"token number\">0x174</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> NextProcess<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"122\"></td><td><pre>\t\t\t<span class=\"token keyword\">return</span> NextProcess<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"123\"></td><td><pre>\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"124\"></td><td><pre>\t\tpListProcess <span class=\"token operator\">=</span> pListProcess<span class=\"token operator\">-></span>Flink<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"125\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"126\"></td><td><pre>\t<span class=\"token keyword\">return</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"127\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"128\"></td><td><pre></pre></td></tr><tr><td data-num=\"129\"></td><td><pre>VOID <span class=\"token function\">TraversalThreadReplaceE0</span><span class=\"token punctuation\">(</span>ULONG eProc<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"130\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"131\"></td><td><pre>\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>eProc <span class=\"token operator\">==</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"132\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"133\"></td><td><pre>\t\t<span class=\"token function\">DbgPrint</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"eProcess is NULL\\t\\n\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"134\"></td><td><pre>\t\t<span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"135\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"136\"></td><td><pre>\t<span class=\"token comment\">// 由进程结构体遍历线程</span></pre></td></tr><tr><td data-num=\"137\"></td><td><pre>\t<span class=\"token comment\">// 获取线程的双向链表</span></pre></td></tr><tr><td data-num=\"138\"></td><td><pre>\t<span class=\"token comment\">//+0x190 ThreadListHead   : _LIST_ENTRY [ 0x89ff024c - 0x89dbd56c ]</span></pre></td></tr><tr><td data-num=\"139\"></td><td><pre>\tPLIST_ENTRY ThreadList <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>PLIST_ENTRY<span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span>eProc <span class=\"token operator\">+</span> <span class=\"token number\">0x190</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"140\"></td><td><pre>\t<span class=\"token comment\">// 找了半天错误 原来是这里没有获取 焯！  PLIST_ENTRY CurrentThreadList = ThreadList</span></pre></td></tr><tr><td data-num=\"141\"></td><td><pre>\tPLIST_ENTRY CurrentThreadList <span class=\"token operator\">=</span> ThreadList<span class=\"token operator\">-></span>Flink<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"142\"></td><td><pre>\t<span class=\"token comment\">// 遍历线程</span></pre></td></tr><tr><td data-num=\"143\"></td><td><pre></pre></td></tr><tr><td data-num=\"144\"></td><td><pre>\t<span class=\"token keyword\">do</span></pre></td></tr><tr><td data-num=\"145\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"146\"></td><td><pre>\t\t<span class=\"token comment\">// 获取当前线程结构体的首部</span></pre></td></tr><tr><td data-num=\"147\"></td><td><pre>\t\tULONG CurrentThread <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>ULONG<span class=\"token punctuation\">)</span>CurrentThreadList <span class=\"token operator\">-</span> <span class=\"token number\">0x22c</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"148\"></td><td><pre>\t\t<span class=\"token comment\">// 取出线程中存储的 SSDT 的值</span></pre></td></tr><tr><td data-num=\"149\"></td><td><pre>\t\tPULONG ServiceTable <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>PULONG<span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span>CurrentThread <span class=\"token operator\">+</span> <span class=\"token number\">0xE0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"150\"></td><td><pre>\t\t<span class=\"token function\">DbgPrint</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"ServiceTable:%X\\t\\n\"</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">*</span>ServiceTable<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"151\"></td><td><pre>\t\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>ServiceTable <span class=\"token operator\">==</span> <span class=\"token punctuation\">(</span>PULONG<span class=\"token punctuation\">)</span>MySSDT<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"152\"></td><td><pre>\t\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"153\"></td><td><pre>\t\t\t<span class=\"token keyword\">continue</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"154\"></td><td><pre>\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"155\"></td><td><pre>\t\t<span class=\"token operator\">*</span>ServiceTable <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>ULONG<span class=\"token punctuation\">)</span>MySSDT<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"156\"></td><td><pre>\t\tCurrentThreadList <span class=\"token operator\">=</span> CurrentThreadList<span class=\"token operator\">-></span>Flink<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"157\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span>CurrentThreadList<span class=\"token operator\">-></span>Flink <span class=\"token operator\">!=</span> ThreadList<span class=\"token operator\">-></span>Flink<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"158\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"159\"></td><td><pre></pre></td></tr><tr><td data-num=\"160\"></td><td><pre>VOID <span class=\"token function\">ResetThreadReplaceE0</span><span class=\"token punctuation\">(</span>ULONG eProc<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"161\"></td><td><pre>\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>eProc <span class=\"token operator\">==</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"162\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"163\"></td><td><pre>\t\t<span class=\"token function\">DbgPrint</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"eProcess is NULL\\t\\n\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"164\"></td><td><pre>\t\t<span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"165\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"166\"></td><td><pre>\tPLIST_ENTRY ThreadList <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>PLIST_ENTRY<span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span>eProc <span class=\"token operator\">+</span> <span class=\"token number\">0x190</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"167\"></td><td><pre>\tPLIST_ENTRY CurrentThreadList <span class=\"token operator\">=</span> ThreadList<span class=\"token operator\">-></span>Flink<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"168\"></td><td><pre>\t<span class=\"token comment\">// 遍历线程</span></pre></td></tr><tr><td data-num=\"169\"></td><td><pre>\t<span class=\"token keyword\">do</span></pre></td></tr><tr><td data-num=\"170\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"171\"></td><td><pre>\t\t<span class=\"token comment\">// 获取当前线程结构体的首部</span></pre></td></tr><tr><td data-num=\"172\"></td><td><pre>\t\tULONG CurrentThread <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>ULONG<span class=\"token punctuation\">)</span>CurrentThreadList <span class=\"token operator\">-</span> <span class=\"token number\">0x22c</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"173\"></td><td><pre>\t\t<span class=\"token comment\">// 取出线程中存储的 SSDT 的值</span></pre></td></tr><tr><td data-num=\"174\"></td><td><pre>\t\tPULONG ServiceTable <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>PULONG<span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span>CurrentThread <span class=\"token operator\">+</span> <span class=\"token number\">0xE0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"175\"></td><td><pre>\t\tULONG ShadowTable <span class=\"token operator\">=</span> <span class=\"token operator\">*</span><span class=\"token punctuation\">(</span>PULONG<span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>KeServiceDescriptorTable<span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span> <span class=\"token number\">0x40</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"176\"></td><td><pre>\t\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>ServiceTable <span class=\"token operator\">==</span> <span class=\"token punctuation\">(</span>PULONG<span class=\"token punctuation\">)</span>ShadowTable<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"177\"></td><td><pre>\t\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"178\"></td><td><pre>\t\t\t<span class=\"token keyword\">continue</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"179\"></td><td><pre>\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"180\"></td><td><pre>\t\t<span class=\"token operator\">*</span>ServiceTable <span class=\"token operator\">=</span> ShadowTable<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"181\"></td><td><pre>\t\t<span class=\"token function\">DbgPrint</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"ServiceTable:%X\\t\\n\"</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">*</span>ServiceTable<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"182\"></td><td><pre>\t\tCurrentThreadList <span class=\"token operator\">=</span> CurrentThreadList<span class=\"token operator\">-></span>Flink<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"183\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span>CurrentThreadList<span class=\"token operator\">-></span>Flink <span class=\"token operator\">!=</span> ThreadList<span class=\"token operator\">-></span>Flink<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"184\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"185\"></td><td><pre></pre></td></tr><tr><td data-num=\"186\"></td><td><pre>VOID <span class=\"token function\">WorkThreadFunc</span><span class=\"token punctuation\">(</span>PVOID StartContext<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"187\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"188\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"189\"></td><td><pre>\tThreadFlag <span class=\"token operator\">=</span> TRUE<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"190\"></td><td><pre>\tULONG pProcess<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"191\"></td><td><pre>\tLARGE_INTEGER timer <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span> <span class=\"token number\">0</span> <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"192\"></td><td><pre>\ttimer<span class=\"token punctuation\">.</span>QuadPart <span class=\"token operator\">=</span> <span class=\"token operator\">-</span><span class=\"token number\">10</span> <span class=\"token operator\">*</span> <span class=\"token number\">1000</span> <span class=\"token operator\">*</span> <span class=\"token number\">1000</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"193\"></td><td><pre>\t<span class=\"token function\">DbgPrint</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"WorkThreadFunc 开始运行!\\t\\n\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"194\"></td><td><pre></pre></td></tr><tr><td data-num=\"195\"></td><td><pre>\t<span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span>ThreadFlag<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"196\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"197\"></td><td><pre>\t\t<span class=\"token function\">KeDelayExecutionThread</span><span class=\"token punctuation\">(</span>KernelMode<span class=\"token punctuation\">,</span> FALSE<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>timer<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"198\"></td><td><pre>\t\tpProcess <span class=\"token operator\">=</span> <span class=\"token function\">FindProcess</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Dbgview.exe\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// 一直查找此进程，因为此进程可能会被关闭</span></pre></td></tr><tr><td data-num=\"199\"></td><td><pre>\t\t<span class=\"token function\">TraversalThreadReplaceE0</span><span class=\"token punctuation\">(</span>pProcess<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"200\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"201\"></td><td><pre></pre></td></tr><tr><td data-num=\"202\"></td><td><pre>\t<span class=\"token function\">ResetThreadReplaceE0</span><span class=\"token punctuation\">(</span>pProcess<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"203\"></td><td><pre>\t<span class=\"token function\">UnHookNtOpenProcess</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"204\"></td><td><pre>\t<span class=\"token function\">DbgPrint</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"WorkThreadFunc 结束运行!\\t\\n\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"205\"></td><td><pre>\t<span class=\"token function\">ZwClose</span><span class=\"token punctuation\">(</span>hThread<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"206\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"207\"></td><td><pre></pre></td></tr><tr><td data-num=\"208\"></td><td><pre></pre></td></tr><tr><td data-num=\"209\"></td><td><pre>NTSTATUS <span class=\"token function\">DriverEntry</span><span class=\"token punctuation\">(</span>PDRIVER_OBJECT pDriver<span class=\"token punctuation\">,</span> PUNICODE_STRING pRegPath<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"210\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"211\"></td><td><pre>\tpDriver<span class=\"token operator\">-></span>DriverUnload <span class=\"token operator\">=</span> DriverUnload<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"212\"></td><td><pre></pre></td></tr><tr><td data-num=\"213\"></td><td><pre>\t<span class=\"token function\">DbgPrint</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"我是驱动，我运行了!\\t\\n\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"214\"></td><td><pre>\t<span class=\"token comment\">// 拷贝一份 SSDT 表</span></pre></td></tr><tr><td data-num=\"215\"></td><td><pre></pre></td></tr><tr><td data-num=\"216\"></td><td><pre>\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token function\">NT_SUCCESS</span><span class=\"token punctuation\">(</span><span class=\"token function\">GetCopySSDT</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"217\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"218\"></td><td><pre>\t\t<span class=\"token function\">DbgPrint</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"GetCopySSDT Failed!\\t\\n\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"219\"></td><td><pre>\t\t<span class=\"token keyword\">return</span> STATUS_UNSUCCESSFUL<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"220\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"221\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"222\"></td><td><pre>\t<span class=\"token comment\">// 打印一下 MySSDT</span></pre></td></tr><tr><td data-num=\"223\"></td><td><pre>\t<span class=\"token function\">DbgPrint</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"MySSDT:%p\\t\\n\"</span><span class=\"token punctuation\">,</span> MySSDT<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"224\"></td><td><pre>\t<span class=\"token comment\">// 定义老的 NtOpenProcess 地址</span></pre></td></tr><tr><td data-num=\"225\"></td><td><pre>\tuOldNtOpenProcess <span class=\"token operator\">=</span> MySSDT<span class=\"token operator\">-></span>ServiceTable<span class=\"token punctuation\">.</span>FuncTable<span class=\"token punctuation\">[</span><span class=\"token number\">0x7A</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"226\"></td><td><pre>\t<span class=\"token function\">DbgPrint</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"uOldNtOpenProcess:%p\\t\\n\"</span><span class=\"token punctuation\">,</span> uOldNtOpenProcess<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"227\"></td><td><pre>\t<span class=\"token comment\">// 开始 Hook</span></pre></td></tr><tr><td data-num=\"228\"></td><td><pre>\t<span class=\"token function\">HookNtOpenProcess</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"229\"></td><td><pre>\t<span class=\"token comment\">// 遍历进程 找到进程</span></pre></td></tr><tr><td data-num=\"230\"></td><td><pre>\t<span class=\"token comment\">// 遍历线程 替换 E0 位置</span></pre></td></tr><tr><td data-num=\"231\"></td><td><pre>\t<span class=\"token comment\">// 设置定时器，每隔 10 毫秒修改一次</span></pre></td></tr><tr><td data-num=\"232\"></td><td><pre>\t<span class=\"token comment\">// 结束时恢复 E0，结束 HOOK，关闭句柄</span></pre></td></tr><tr><td data-num=\"233\"></td><td><pre>\t<span class=\"token keyword\">extern</span> HANDLE hThread<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"234\"></td><td><pre>\t<span class=\"token function\">PsCreateSystemThread</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>hThread<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">,</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">,</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">,</span> WorkThreadFunc<span class=\"token punctuation\">,</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> </pre></td></tr><tr><td data-num=\"235\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"236\"></td><td><pre>\t<span class=\"token keyword\">return</span> STATUS_SUCCESS<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"237\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h2 id=\"运行截图\"><a class=\"anchor\" href=\"#运行截图\">#</a> 运行截图</h2>\n<p><img data-src=\"image001.png\" alt=\"\" /><br />\n<img data-src=\"image002.png\" alt=\"\" /></p>\n<h1 id=\"反思\"><a class=\"anchor\" href=\"#反思\">#</a> 反思</h1>\n<p>学过知识没有记住，要多做练习。</p>\n",
            "tags": [
                "SSDT HOOK隐藏"
            ]
        },
        {
            "id": "https://or0kit.github.io/Bin/Core/WindowsXp/SystemCall/%E7%B3%BB%E7%BB%9F%E8%B0%83%E7%94%A8-SSDT%E5%B8%B8%E8%A7%84HOOK/",
            "url": "https://or0kit.github.io/Bin/Core/WindowsXp/SystemCall/%E7%B3%BB%E7%BB%9F%E8%B0%83%E7%94%A8-SSDT%E5%B8%B8%E8%A7%84HOOK/",
            "title": "系统调用-SSDT常规HOOK",
            "date_published": "2021-12-27T09:25:16.000Z",
            "content_html": "<h1 id=\"ssdt-routinehook\"><a class=\"anchor\" href=\"#ssdt-routinehook\">#</a> SSDT-RoutineHook</h1>\n<p>常规 hook 思路：</p>\n<ol>\n<li>如何获取 SSDT 的地址？</li>\n</ol>\n<blockquote>\n<p>通过内核文件的导出变量获取</p>\n</blockquote>\n<ol start=\"2\">\n<li>如何获取函数表的地址？</li>\n</ol>\n<blockquote>\n<p>定义 SST（系统服务表）结构体</p>\n</blockquote>\n<ol start=\"3\">\n<li>如何修改函数所在物理页的页属性？</li>\n</ol>\n<p>SSDT 所在的物理页是只读的，如果要修改，先要修改页属性为可写：</p>\n<ul>\n<li>第一种办法，用我们学过的知识，通过页表基址直接修改：<strong>这种方法无论是单核还是多核都适用</strong>。</li>\n</ul>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>RCR4 <span class=\"token operator\">&amp;</span> <span class=\"token number\">0x00000020</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">&#123;</span><span class=\"token comment\">// 说明是 2-9-9-12 分页</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  <span class=\"token function\">KdPrint</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"2-9-9-12分页 %p\\n\"</span><span class=\"token punctuation\">,</span>RCR4<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  <span class=\"token function\">KdPrint</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"PTE1 %p\\n\"</span><span class=\"token punctuation\">,</span><span class=\"token operator\">*</span><span class=\"token punctuation\">(</span>DWORD<span class=\"token operator\">*</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span><span class=\"token number\">0xC0000000</span> <span class=\"token operator\">+</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>HookFunAddr <span class=\"token operator\">>></span> <span class=\"token number\">9</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;</span> <span class=\"token number\">0x007FFFF8</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  <span class=\"token operator\">*</span><span class=\"token punctuation\">(</span>DWORD64<span class=\"token operator\">*</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span><span class=\"token number\">0xC0000000</span> <span class=\"token operator\">+</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>HookFunAddr <span class=\"token operator\">>></span> <span class=\"token number\">9</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;</span> <span class=\"token number\">0x007FFFF8</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">|=</span> <span class=\"token number\">0x02</span><span class=\"token punctuation\">;</span> </pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  <span class=\"token function\">KdPrint</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"PTE1 %p\\n\"</span><span class=\"token punctuation\">,</span><span class=\"token operator\">*</span><span class=\"token punctuation\">(</span>DWORD<span class=\"token operator\">*</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span><span class=\"token number\">0xC0000000</span> <span class=\"token operator\">+</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>HookFunAddr <span class=\"token operator\">>></span> <span class=\"token number\">9</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;</span> <span class=\"token number\">0x007FFFF8</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token keyword\">else</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token punctuation\">&#123;</span><span class=\"token comment\">// 说明是 10-10-12 分页</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  <span class=\"token function\">KdPrint</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"10-10-12分页\\n\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  <span class=\"token function\">KdPrint</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"PTE1 %p\\n\"</span><span class=\"token punctuation\">,</span><span class=\"token operator\">*</span><span class=\"token punctuation\">(</span>DWORD<span class=\"token operator\">*</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span><span class=\"token number\">0xC0000000</span> <span class=\"token operator\">+</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>HookFunAddr <span class=\"token operator\">>></span> <span class=\"token number\">10</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;</span> <span class=\"token number\">0x003FFFFC</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  <span class=\"token operator\">*</span><span class=\"token punctuation\">(</span>DWORD<span class=\"token operator\">*</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span><span class=\"token number\">0xC0000000</span> <span class=\"token operator\">+</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>HookFunAddr <span class=\"token operator\">>></span> <span class=\"token number\">10</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;</span> <span class=\"token number\">0x003FFFFC</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">|=</span> <span class=\"token number\">0x02</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>  <span class=\"token function\">KdPrint</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"PTE2 %p\\n\"</span><span class=\"token punctuation\">,</span><span class=\"token operator\">*</span><span class=\"token punctuation\">(</span>DWORD<span class=\"token operator\">*</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span><span class=\"token number\">0xC0000000</span> <span class=\"token operator\">+</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>HookFunAddr <span class=\"token operator\">>></span> <span class=\"token number\">10</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;</span> <span class=\"token number\">0x003FFFFC</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><ul>\n<li>通过修改 CR0 寄存器</li>\n</ul>\n<p>CR0 寄存器的第 16 位叫做保护属性位，控制着页的读或写属性。这种方法在单核下是稳定的，但多核就不一定了，因为切换 CPU 后寄存器也变成其他核的寄存器了。</p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>VOID <span class=\"token function\">PageProtectOn</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>\t__asm<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>\t\t\tmov  eax<span class=\"token punctuation\">,</span>cr0</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>\t\t\tor   eax<span class=\"token punctuation\">,</span><span class=\"token number\">10000</span>h</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>\t\t\tmov  cr0<span class=\"token punctuation\">,</span>eax</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>\t\t\tsti</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>VOID <span class=\"token function\">PageProtectOff</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\t\t\t\t</pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>\t__asm<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>\t\t\tcli\t\t\t\t\t</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>\t\t\tmov  eax<span class=\"token punctuation\">,</span>cr0</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>\t\t\tand  eax<span class=\"token punctuation\">,</span>not <span class=\"token number\">10000</span>h</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>\t\t\tmov  cr0<span class=\"token punctuation\">,</span>eax</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h1 id=\"代码如下\"><a class=\"anchor\" href=\"#代码如下\">#</a> 代码如下</h1>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">//SSDT HOOK 框架</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;ntddk.h></span></span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;ntstatus.h></span></span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token comment\">/************************************************************************/</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token comment\">/* 类型声明                                                             */</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token comment\">/************************************************************************/</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token comment\">// 系统服务表</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token keyword\">typedef</span> <span class=\"token keyword\">struct</span> <span class=\"token class-name\">_KSYSTEM_SERVICE_TABLE</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>\tPULONG ServiceTableBase<span class=\"token punctuation\">;</span>\t\t\t<span class=\"token comment\">// 函数地址表（SSDT）</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>\tPULONG ServiceCounterTableBase<span class=\"token punctuation\">;</span>\t\t<span class=\"token comment\">// SSDT 函数被调用的次数</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>\tULONG NumberOfService<span class=\"token punctuation\">;</span>\t\t\t\t<span class=\"token comment\">// 函数个数</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>\tPULONG ParamTableBase<span class=\"token punctuation\">;</span>\t\t\t\t<span class=\"token comment\">// 函数参数表（SSPT）</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre><span class=\"token punctuation\">&#125;</span> KSYSTEM_SERVICE_TABLE<span class=\"token punctuation\">,</span> <span class=\"token operator\">*</span> PKSYSTEM_SERVICE_TABLE<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre></pre></td></tr><tr><td data-num=\"20\"></td><td><pre><span class=\"token comment\">//SSDT</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre><span class=\"token keyword\">typedef</span> <span class=\"token keyword\">struct</span> <span class=\"token class-name\">_KSERVICE_TABLE_DESCRIPTOR</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>\tKSYSTEM_SERVICE_TABLE ntoskrnl<span class=\"token punctuation\">;</span>\t\t<span class=\"token comment\">// 内核函数</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>\tKSYSTEM_SERVICE_TABLE win32k<span class=\"token punctuation\">;</span>\t\t<span class=\"token comment\">//win32k.sys 函数</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>\tKSYSTEM_SERVICE_TABLE unUsed1<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>\tKSYSTEM_SERVICE_TABLE unUsed2<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre><span class=\"token punctuation\">&#125;</span> KSERVICE_TABLE_DESCRIPTOR<span class=\"token punctuation\">,</span> <span class=\"token operator\">*</span> PKSERVICE_TABLE_DESCRIPTOR<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre></pre></td></tr><tr><td data-num=\"29\"></td><td><pre></pre></td></tr><tr><td data-num=\"30\"></td><td><pre><span class=\"token comment\">// 定义 被 hook 的函数的函数指针</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre><span class=\"token comment\">// NTOPENPROCESS</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre><span class=\"token keyword\">typedef</span> <span class=\"token function\">NTSTATUS</span><span class=\"token punctuation\">(</span><span class=\"token operator\">*</span>NTOPENPROCESS<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">(</span>PHANDLE ProcessHandle<span class=\"token punctuation\">,</span> ACCESS_MASK DesiredAccess<span class=\"token punctuation\">,</span> POBJECT_ATTRIBUTES ObjectAttributes<span class=\"token punctuation\">,</span> PCLIENT_ID ClientId<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre></pre></td></tr><tr><td data-num=\"34\"></td><td><pre></pre></td></tr><tr><td data-num=\"35\"></td><td><pre><span class=\"token comment\">/************************************************************************/</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre><span class=\"token comment\">/* 函数声明                                                             */</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre><span class=\"token comment\">/************************************************************************/</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>VOID <span class=\"token function\">DriverUnload</span><span class=\"token punctuation\">(</span>PDRIVER_OBJECT pDriver<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>NTSTATUS <span class=\"token function\">DriverEntry</span><span class=\"token punctuation\">(</span>PDRIVER_OBJECT pDriver<span class=\"token punctuation\">,</span> PUNICODE_STRING reg_path<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>VOID <span class=\"token function\">PageProtectOff</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>VOID <span class=\"token function\">PageProtectOn</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>VOID <span class=\"token function\">HookNtOpenProcess</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>VOID <span class=\"token function\">UnHookNtOpenProcess</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>NTSTATUS <span class=\"token function\">HbgNtOpenProcess</span><span class=\"token punctuation\">(</span>PHANDLE  ProcessHandle<span class=\"token punctuation\">,</span> ACCESS_MASK  DesiredAccess<span class=\"token punctuation\">,</span> POBJECT_ATTRIBUTES  ObjectAttributes<span class=\"token punctuation\">,</span> PCLIENT_ID  ClientId<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre></pre></td></tr><tr><td data-num=\"47\"></td><td><pre></pre></td></tr><tr><td data-num=\"48\"></td><td><pre><span class=\"token comment\">/************************************************************************/</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre><span class=\"token comment\">/* 全局变量                                                             */</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre><span class=\"token comment\">/************************************************************************/</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre></pre></td></tr><tr><td data-num=\"52\"></td><td><pre><span class=\"token comment\">//ntkrnlpa 或 ntoskrnl 中导出的全局变量</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre><span class=\"token keyword\">extern</span> PKSERVICE_TABLE_DESCRIPTOR KeServiceDescriptorTable<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre><span class=\"token comment\">// 旧的函数地址</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre>ULONG uOldNtOpenProcess<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre></pre></td></tr><tr><td data-num=\"57\"></td><td><pre></pre></td></tr><tr><td data-num=\"58\"></td><td><pre><span class=\"token comment\">/************************************************************************/</span></pre></td></tr><tr><td data-num=\"59\"></td><td><pre><span class=\"token comment\">/* 函数定义                                                             */</span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre><span class=\"token comment\">/************************************************************************/</span></pre></td></tr><tr><td data-num=\"61\"></td><td><pre></pre></td></tr><tr><td data-num=\"62\"></td><td><pre><span class=\"token comment\">// 驱动入口</span></pre></td></tr><tr><td data-num=\"63\"></td><td><pre>NTSTATUS <span class=\"token function\">DriverEntry</span><span class=\"token punctuation\">(</span>PDRIVER_OBJECT pDriver<span class=\"token punctuation\">,</span> PUNICODE_STRING reg_path<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"64\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"65\"></td><td><pre>\t<span class=\"token comment\">// HOOK</span></pre></td></tr><tr><td data-num=\"66\"></td><td><pre>\t<span class=\"token function\">HookNtOpenProcess</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"67\"></td><td><pre></pre></td></tr><tr><td data-num=\"68\"></td><td><pre>\tpDriver<span class=\"token operator\">-></span>DriverUnload <span class=\"token operator\">=</span> DriverUnload<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"69\"></td><td><pre></pre></td></tr><tr><td data-num=\"70\"></td><td><pre>\t<span class=\"token keyword\">return</span> STATUS_SUCCESS<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"71\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"72\"></td><td><pre></pre></td></tr><tr><td data-num=\"73\"></td><td><pre><span class=\"token comment\">// 卸载驱动</span></pre></td></tr><tr><td data-num=\"74\"></td><td><pre>VOID <span class=\"token function\">DriverUnload</span><span class=\"token punctuation\">(</span>PDRIVER_OBJECT pDriver<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"75\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"76\"></td><td><pre>\t<span class=\"token function\">UnHookNtOpenProcess</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"77\"></td><td><pre>\t<span class=\"token function\">DbgPrint</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Driver unloaded.\\n\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"78\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"79\"></td><td><pre></pre></td></tr><tr><td data-num=\"80\"></td><td><pre><span class=\"token comment\">// 关闭页保护</span></pre></td></tr><tr><td data-num=\"81\"></td><td><pre></pre></td></tr><tr><td data-num=\"82\"></td><td><pre>VOID <span class=\"token function\">PageProtectOff</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"83\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"84\"></td><td><pre>\t__asm</pre></td></tr><tr><td data-num=\"85\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"86\"></td><td><pre>\t\tcli<span class=\"token punctuation\">;</span> <span class=\"token comment\">// 关闭中断</span></pre></td></tr><tr><td data-num=\"87\"></td><td><pre>\t\tmov eax<span class=\"token punctuation\">,</span> cr0<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"88\"></td><td><pre>\t\tand eax<span class=\"token punctuation\">,</span> not <span class=\"token number\">0x10000</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// WP 位置 0</span></pre></td></tr><tr><td data-num=\"89\"></td><td><pre>\t\tmov cr0<span class=\"token punctuation\">,</span> eax<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"90\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"91\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"92\"></td><td><pre></pre></td></tr><tr><td data-num=\"93\"></td><td><pre><span class=\"token comment\">// 开启页保护</span></pre></td></tr><tr><td data-num=\"94\"></td><td><pre>VOID <span class=\"token function\">PageProtectOn</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"95\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"96\"></td><td><pre>\t__asm</pre></td></tr><tr><td data-num=\"97\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"98\"></td><td><pre>\t\tmov eax<span class=\"token punctuation\">,</span> cr0<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"99\"></td><td><pre>\t\tor eax<span class=\"token punctuation\">,</span> <span class=\"token number\">0x10000</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// WP 位置 1</span></pre></td></tr><tr><td data-num=\"100\"></td><td><pre>\t\tmov cr0<span class=\"token punctuation\">,</span> eax<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"101\"></td><td><pre>\t\tsti<span class=\"token punctuation\">;</span> <span class=\"token comment\">// 恢复中断</span></pre></td></tr><tr><td data-num=\"102\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"103\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"104\"></td><td><pre></pre></td></tr><tr><td data-num=\"105\"></td><td><pre><span class=\"token comment\">// HOOK NtOpenProcess</span></pre></td></tr><tr><td data-num=\"106\"></td><td><pre>VOID <span class=\"token function\">HookNtOpenProcess</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"107\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"108\"></td><td><pre>\t<span class=\"token function\">PageProtectOff</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"109\"></td><td><pre>\tuOldNtOpenProcess <span class=\"token operator\">=</span> KeServiceDescriptorTable<span class=\"token operator\">-></span>ntoskrnl<span class=\"token punctuation\">.</span>ServiceTableBase<span class=\"token punctuation\">[</span><span class=\"token number\">0x7A</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"110\"></td><td><pre>\tKeServiceDescriptorTable<span class=\"token operator\">-></span>ntoskrnl<span class=\"token punctuation\">.</span>ServiceTableBase<span class=\"token punctuation\">[</span><span class=\"token number\">0x7A</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>ULONG<span class=\"token punctuation\">)</span>HbgNtOpenProcess<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"111\"></td><td><pre>\t<span class=\"token function\">PageProtectOn</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"112\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"113\"></td><td><pre></pre></td></tr><tr><td data-num=\"114\"></td><td><pre><span class=\"token comment\">// UnHOOK NtOpenProcess</span></pre></td></tr><tr><td data-num=\"115\"></td><td><pre>VOID <span class=\"token function\">UnHookNtOpenProcess</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"116\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"117\"></td><td><pre>\t<span class=\"token function\">PageProtectOff</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"118\"></td><td><pre>\tKeServiceDescriptorTable<span class=\"token operator\">-></span>ntoskrnl<span class=\"token punctuation\">.</span>ServiceTableBase<span class=\"token punctuation\">[</span><span class=\"token number\">0x7A</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> uOldNtOpenProcess<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"119\"></td><td><pre>\t<span class=\"token function\">PageProtectOn</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"120\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"121\"></td><td><pre></pre></td></tr><tr><td data-num=\"122\"></td><td><pre><span class=\"token comment\">// 被修改的 NtOpenProcess 函数，简单打印参数</span></pre></td></tr><tr><td data-num=\"123\"></td><td><pre>NTSTATUS <span class=\"token function\">HbgNtOpenProcess</span><span class=\"token punctuation\">(</span>PHANDLE  ProcessHandle<span class=\"token punctuation\">,</span> ACCESS_MASK  DesiredAccess<span class=\"token punctuation\">,</span> POBJECT_ATTRIBUTES  ObjectAttributes<span class=\"token punctuation\">,</span> PCLIENT_ID  ClientId<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"124\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"125\"></td><td><pre>\t<span class=\"token function\">DbgPrint</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"%x %x %x %x\\n\"</span><span class=\"token punctuation\">,</span> ProcessHandle<span class=\"token punctuation\">,</span> DesiredAccess<span class=\"token punctuation\">,</span> ObjectAttributes<span class=\"token punctuation\">,</span> ClientId<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"126\"></td><td><pre>\t<span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>NTOPENPROCESS<span class=\"token punctuation\">)</span>uOldNtOpenProcess<span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span>ProcessHandle<span class=\"token punctuation\">,</span> DesiredAccess<span class=\"token punctuation\">,</span> ObjectAttributes<span class=\"token punctuation\">,</span> ClientId<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"127\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h1 id=\"openprocess函数\"><a class=\"anchor\" href=\"#openprocess函数\">#</a> OpenProcess 函数</h1>\n<p><code>OpenProcess</code>  函数，由 kernel32.dll 导出，其会调用 <code>NtOpenProcess</code>  函数，此函数由 ntdll.dll 导出，在 IDA 中查看为 <code>__stdcall ZwOpenProcess(x, x, x, x)</code> ，既 <code>NtOpenProcess</code>  是 <code>ZwOpenProcess</code>  函数的导出别名， <code>ZwOpenProcess</code>  函数会利用快速调用进 0 环，传递的服务号为 <code>0x7A</code> ，在 windbg 中查看 SSDT 函数表中索引为 0x7A 的函数：</p>\n<figure class=\"highlight raw\"><figcaption data-lang=\"\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>kd&gt; dd KeServiceDescriptorTable</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>8055d700  80505570 00000000 0000011c 805059e4</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>8055d710  00000000 00000000 00000000 00000000</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>8055d720  00000000 00000000 00000000 00000000</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>8055d730  00000000 00000000 00000000 00000000</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>kd&gt; dd 80505570 </pre></td></tr><tr><td data-num=\"7\"></td><td><pre>80505570  805a5664 805f23ea 805f5c20 805f241c</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>80505580  805f5c5a 805f2452 805f5c9e 805f5ce2</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>80505590  80616e80 806180e4 805ed7e8 805ed440</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>kd&gt; dd 80505570  + 0x7A *4</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>80505758  805cc486 805ef030 805eec94 805ab420</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>80505768  806162da 805c4c14 805cc712 805ef04e</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>80505778  805eee04 80618214 80646ea4 805ca534</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>kd&gt; u 805cc486 </pre></td></tr><tr><td data-num=\"15\"></td><td><pre>nt!NtOpenProcess:</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>805cc486 68c4000000      push    0C4h</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>805cc48b 68c0b44d80      push    offset nt!ObWatchHandles+0x25c (804db4c0)</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>805cc490 e8ab08f7ff      call    nt!_SEH_prolog (8053cd40)</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>805cc495 33f6            xor     esi,esi</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>805cc497 8975d4          mov     dword ptr [ebp-2Ch],esi</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>805cc49a 33c0            xor     eax,eax</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>805cc49c 8d7dd8          lea     edi,[ebp-28h]</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>805cc49f ab              stos    dword ptr es:[edi]</pre></td></tr></table></figure><p>由此可以发现最终调用的是内核文件中  <code>NtOpenProcess</code>  函数，也就是我们本次 HOOK 的代码。</p>\n",
            "tags": [
                "SSDT HOOK",
                "OpenProcess"
            ]
        },
        {
            "id": "https://or0kit.github.io/Bin/Core/WindowsXp/SystemCall/%E7%B3%BB%E7%BB%9F%E8%B0%83%E7%94%A8-SSDT/",
            "url": "https://or0kit.github.io/Bin/Core/WindowsXp/SystemCall/%E7%B3%BB%E7%BB%9F%E8%B0%83%E7%94%A8-SSDT/",
            "title": "系统调用-SSDT",
            "date_published": "2021-12-14T02:38:24.000Z",
            "content_html": "<h1 id=\"楔子\"><a class=\"anchor\" href=\"#楔子\">#</a> 楔子</h1>\n<p>在前两篇的 0/3 环调用分析中，我们知道有两个进入 0 环的方法，一个中断门 利用 <code>int 0x2e</code>  指令，一个是快速调用 利用 <code>sysenter</code>  指令，因为利用中断门进 0 环权限发生切换，会直接向堆栈中压入 5 个值：3 环的 SS、3 环 Eflags、3 环的 CS、3 环的 EIP。而通过快速调用却没有压入这 5 个值，所以会有  <code>KiFastSystemCall 与 KiIntSystemCall</code>  以及  <code>KiSystemService 与 KiFastCallEntry</code>  这四个函数。</p>\n<p><code>KiFastSystemCall 与 KiIntSystemCall</code>  是为了从 3 环进入 0 环，既修改 CS、SS、EIP、ESP。</p>\n<p><code>KiSystemService 与 KiFastCallEntry</code>  它们都是为了填充  <code>KTRAP_FRAME</code>  结构体，从而保存 3 环的环境。</p>\n<p>保存并切换完环境后，就开始调用函数了，这里涉及了一张表，系统服务表（SystemServiceTable)</p>\n<p>进 0 环后，3 环的各种寄存器的值都会保留到 <code>_Trap_Frame</code>  结构体中，如何根据系统服务号（eax 中存储）找到要执行的内核函数？调用时参数是存储到 3 环的堆栈，如何传递给内核函数？</p>\n<h1 id=\"系统服务表\"><a class=\"anchor\" href=\"#系统服务表\">#</a> 系统服务表</h1>\n<h2 id=\"结构\"><a class=\"anchor\" href=\"#结构\">#</a> 结构</h2>\n<p>首先我们得知道一个结构体，用来描述内核函数信息的表：SystemServiceTable，即系统服务表，它不是 SSDT。</p>\n<p><img data-src=\"image001.png\" alt=\"\" /></p>\n<p>系统服务表由 4 部分组成：<br />\n <code>ServiceTable</code>  指向的是函数地址数组，每个成员四个字节；<br />\n <code>Count</code>  表示调用次数；<br />\n <code>ServiceLimit</code>  表示表中函数的个数；<br />\n <code>ArgumentTable</code>  指向对应函数有几个参数，每个成员一个字节。</p>\n<p>Windows 提供了两张表：上面的表是用来处理一般内核函数的，下面这张表是用来处理与图形相关的内核函数。</p>\n<p>这张表里的都是向 3 环开放的内核函数，并不代表整个内核只有这么多函数。</p>\n<h2 id=\"系统服务表在哪\"><a class=\"anchor\" href=\"#系统服务表在哪\">#</a> 系统服务表在哪</h2>\n<p><code>SystemServiceTable</code>  系统服务表在哪？ 在 <code>_KTHREAD + 0xE0</code>  的位置</p>\n<p><img data-src=\"image002.png\" alt=\"\" /></p>\n<h2 id=\"判断要调用的函数在哪个表\"><a class=\"anchor\" href=\"#判断要调用的函数在哪个表\">#</a> 判断要调用的函数在哪个表</h2>\n<p><img data-src=\"image003.png\" alt=\"\" /></p>\n<h2 id=\"找到要执行的函数与参数个数\"><a class=\"anchor\" href=\"#找到要执行的函数与参数个数\">#</a> 找到要执行的函数与参数个数</h2>\n<p><img data-src=\"image004.png\" alt=\"\" /></p>\n<p>用查找到的函数在 <code>ServiceTable</code>  中的索引 <code>i</code> ，去找在 <code>ArgumentTable</code>  中索引为 <code>i</code>  元素，其值就是该函数的 <strong>参数个数 * 4。</strong></p>\n<h1 id=\"ssdt\"><a class=\"anchor\" href=\"#ssdt\">#</a> SSDT</h1>\n<p>SSDT 的全称是 <code>System Services Descriptor Table</code> ，意为系统服务描述符表。</p>\n<p>SSDT 的每个成员叫做系统服务表<br />\n SSDT 的第一个成员是导出的，声明一下即可使用<br />\n SSDT 的第二个成员是未导出的，需要通过其它方式查找<br />\n在 Windows 中，SSDT 的第三个成员和第四个成员未被使用</p>\n<p>在 32 位 XP 中，我们可以通过 <code>ETHREAD</code>  结构体加偏移的方式进行访问。</p>\n<p>在内核文件中，有一个变量是导出的：  <code>KeServiceDescriptorTable</code>  通过它我们可以访问 SSDT。</p>\n<p><img data-src=\"image005.png\" alt=\"\" /></p>\n<p>在 windbg 中查看一下：</p>\n<figure class=\"highlight raw\"><figcaption data-lang=\"\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>kd&gt; dd KeServiceDescriptorTable</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>8055d700  80505570 00000000 0000011c 805059e4</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>8055d710  00000000 00000000 00000000 00000000</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>8055d720  00000000 00000000 00000000 00000000</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>8055d730  00000000 00000000 00000000 00000000</pre></td></tr></table></figure><p>在 WinDbg 中查看未导出成员：</p>\n<figure class=\"highlight raw\"><figcaption data-lang=\"\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>kd&gt; dd KeServiceDescriptorTableShadow</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>8055d6c0  80505570 00000000 0000011c 805059e4</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>8055d6d0  bf9a6f80 00000000 0000029b bf9a7c90</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>8055d6e0  00000000 00000000 00000000 00000000</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>8055d6f0  00000000 00000000 00000000 00000000</pre></td></tr></table></figure>",
            "tags": [
                "系统服务表",
                "SSDT"
            ]
        },
        {
            "id": "https://or0kit.github.io/Bin/Core/WindowsXp/SystemCall/%E7%B3%BB%E7%BB%9F%E8%B0%83%E7%94%A8-0%E7%8E%AF%E8%B0%83%E7%94%A8%E5%88%86%E6%9E%90/",
            "url": "https://or0kit.github.io/Bin/Core/WindowsXp/SystemCall/%E7%B3%BB%E7%BB%9F%E8%B0%83%E7%94%A8-0%E7%8E%AF%E8%B0%83%E7%94%A8%E5%88%86%E6%9E%90/",
            "title": "系统调用-0环调用分析",
            "date_published": "2021-12-09T02:50:01.000Z",
            "content_html": "<h1 id=\"楔子\"><a class=\"anchor\" href=\"#楔子\">#</a> 楔子</h1>\n<p>上一次分析到 API 函数在  <code>ntdll.dll</code>  中的  <code>KiFastSystemCall</code>  与  <code>KiIntSystemCall</code>  函数。<br />\n补充一下，Windows API 的相关知识。</p>\n<p><code>API</code>  全称为  <code>Application Programming Interface</code> 。</p>\n<p>其中有几个比较重要的  <code>Dll</code> ，很多重要的函数都在这些动态链接库里面：</p>\n<ul>\n<li><code>Kernel32.dll</code> ：最核心的功能模块，比如管理内存、进程和线程相关的函数等。</li>\n<li><code>User32.dll</code> ：是  <code>Windows</code>  用户界面相关应用程序接口，如创建窗口和发送消息等。</li>\n<li><code>GDI32.dll</code> ：全称是  <code>Graphical Device Interface</code> ，即  <code>图形设备接口</code> ，包含用于画图和显示文本的函数。比如要显示一个程序窗口，就调用了其中的函数来画这个窗口。</li>\n<li><code>Ntdll.dll</code> ：大多数  <code>API</code>  都会通过这个  <code>DLL</code>  进入内核（0 环）。</li>\n</ul>\n<p>需要注意的是：并不是所有的  <code>API</code>  都必须要进 0 环的，有些功能完全可以在 3 环实现。</p>\n<p>我们可以知道函数在  <code>ntdll.dll</code>  中进入 R0, 那么它是如何实现的呢，进入 R0 后又做了什么呢？</p>\n<h1 id=\"分析-kifastsystemcall-与-kiintsystemcall\"><a class=\"anchor\" href=\"#分析-kifastsystemcall-与-kiintsystemcall\">#</a> 分析 KiFastSystemCall 与 KiIntSystemCall</h1>\n<h2 id=\"首先分析-kifastsystemcall\"><a class=\"anchor\" href=\"#首先分析-kifastsystemcall\">#</a> 首先分析 KiFastSystemCall</h2>\n<figure class=\"highlight raw\"><figcaption data-lang=\"\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>_DWORD __stdcall KiFastSystemCall()</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>                public _KiFastSystemCall@0</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>_KiFastSystemCall@0 proc near           ; DATA XREF: .text:off_7C923428↑o</pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>                mov     edx, esp</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>                sysenter</pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>_KiFastSystemCall@0 endp</pre></td></tr></table></figure><p>在 KiFastSystemCall 中，先把 R3 的栈顶 esp 存到了 edx 中，然后执行了 sysenter 指令，那这个指令具体是怎么做的呢？</p>\n<h2 id=\"sysenter-指令进0环\"><a class=\"anchor\" href=\"#sysenter-指令进0环\">#</a> sysenter 指令进 0 环</h2>\n<p>如果要进入 R0 必须要指定相关的 CS SS EIP ESP。所以在执行  <code>sysenter</code>  指令之前，操作系统必须指定 0 环的  <code>CS</code> 、 <code>SS</code> 、 <code>EIP</code>  以及  <code>ESP</code> 。<br />\n而它们的值存储在  <code>MSR</code>  寄存器中，它的具体结构并未公开。<br />\n每个  <code>MSR</code>  寄存器都会有一个相应的  <code>ID</code> ，即  <code>MSR Index</code> 。当执行  <code>RDMSR</code>  或者  <code>WRMSR</code>  指令的时候，只要提供  <code>MSR Index</code>  就能让  <code>CPU</code>  知道目标  <code>MSR</code>  寄存器。</p>\n<table>\n<thead>\n<tr>\n<th>MSR</th>\n<th>Index</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>IA32_SYSENTER_CS</td>\n<td>174H</td>\n</tr>\n<tr>\n<td>IA32_SYSENTER_ESP</td>\n<td>175H</td>\n</tr>\n<tr>\n<td>IA32_SYSENTER_EIP</td>\n<td>176H</td>\n</tr>\n</tbody>\n</table>\n<p>其中并没有 SS 的值，这是因为 SS 的值是通过 CS + 0x8 算出来的。</p>\n<p>在 windbg 中查看一下</p>\n<figure class=\"highlight raw\"><figcaption data-lang=\"\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>kd&gt; rdmsr 174</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>msr[174] &#x3D; 00000000&#96;00000008</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>kd&gt; rdmsr 175</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>msr[175] &#x3D; 00000000&#96;ba4d0000</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>kd&gt; rdmsr 176</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>msr[176] &#x3D; 00000000&#96;805426e0</pre></td></tr></table></figure><p>查看 EIP 指向的函数：</p>\n<figure class=\"highlight raw\"><figcaption data-lang=\"\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>kd&gt; u 805426e0</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>nt!KiFastCallEntry:</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>805426e0 b923000000      mov     ecx,23h</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>805426e5 6a30            push    30h</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>805426e7 0fa1            pop     fs</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>805426e9 8ed9            mov     ds,cx</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>805426eb 8ec1            mov     es,cx</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>805426ed 648b0d40000000  mov     ecx,dword ptr fs:[40h]</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>805426f4 8b6104          mov     esp,dword ptr [ecx+4]</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>805426f7 6a23            push    23h</pre></td></tr></table></figure><p><strong>发现是  <code>KiFastCallEntry</code>  函数</strong></p>\n<h2 id=\"接下来分析-kiintsystemcall\"><a class=\"anchor\" href=\"#接下来分析-kiintsystemcall\">#</a> 接下来分析 KiIntSystemCall</h2>\n<figure class=\"highlight raw\"><figcaption data-lang=\"\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>_DWORD __stdcall KiIntSystemCall ()</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>                public _KiIntSystemCall@0</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>_KiIntSystemCall@0 proc near            ; DATA XREF: .text:off_7C923428↑o</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>                lea     edx, [esp+8] ; 参数指针</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>                int     2Eh             ; DOS 2+ internal - EXECUTE COMMAND</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>                                        ; DS:SI -&gt; counted CR-terminated command string</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>                retn</pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>_KiIntSystemCall@0 endp</pre></td></tr></table></figure><p>首先把 esp+8 的地址给了 edx，然后使用中断门，触发中断，中断号是 0x2E，用 windbg 看看 2E 号中断的中断门描述符： <code> 8054ee00`00082611</code>  这个值在不同的计算机上应该都不一样。</p>\n<figure class=\"highlight raw\"><figcaption data-lang=\"\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>kd&gt; r idtr</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>idtr&#x3D;8003f400</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>kd&gt; dq 8003f400 + 0x2e * 8</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>8003f570  8054ee00&#96;00082611 80548e00&#96;0008590c</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>8003f580  80548e00&#96;00081cd0 80548e00&#96;00081cda</pre></td></tr></table></figure><p>拆分中断门描述符，可以得到新的 CS 是 0008（系统代码段），EIP 是  <code>80542611</code>  ，这个是内核模块的  <code>KiSystemService</code>  函数。</p>\n<figure class=\"highlight raw\"><figcaption data-lang=\"\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>kd&gt; u 80542611</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>nt!KiSystemService:</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>80542611 6a00            push    0</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>80542613 55              push    ebp</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>80542614 53              push    ebx</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>80542615 56              push    esi</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>80542616 57              push    edi</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>80542617 0fa0            push    fs</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>80542619 bb30000000      mov     ebx,30h</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>8054261e 668ee3          mov     fs,bx</pre></td></tr></table></figure><h2 id=\"总结\"><a class=\"anchor\" href=\"#总结\">#</a> 总结</h2>\n<p><code>KiIntSystemCall</code>  通过中断门进 0 环：</p>\n<ol>\n<li>固定中断号为 0x2E</li>\n<li>CS/EIP 由门描述符提供   ESP/SS 由 TSS 提供</li>\n<li>进入 0 环后执行的内核函数： <code>NT!KiSystemService</code></li>\n</ol>\n<p><code>KiFastSystemCall</code>  通过 sysenter 指令进 0 环：</p>\n<ol>\n<li>CS/ESP/EIP 由 MSR 寄存器提供 (SS 是算出来的)</li>\n<li>进入 0 环后执行的内核函数： <code>NT!KiFastCallEntry</code></li>\n</ol>\n<h1 id=\"分析-kisystemservice-和-kifastcallentry-函数\"><a class=\"anchor\" href=\"#分析-kisystemservice-和-kifastcallentry-函数\">#</a> 分析 KiSystemService 和 KiFastCallEntry 函数</h1>\n<p>通过 <code>int 2E</code>  或者 <code>sysenter</code>  进入内核后，之后的流程会怎样继续进行呢？</p>\n<p>首先我们得知道这两个结构体  <code>Trap_Frame</code>  和  <code>KPCR</code> 。</p>\n<p>这里有一个小知识，和前面学的可以连起来。</p>\n<p>首先复习一下 TSS 表，TSS 表只有一张，但是系统里有成百上千的线程，线程进 0 环时，假设使用中断门，0 环的 ESP 和 SS 从 TSS 表获取，怎么保证每个线程都有自己的堆栈，不互相冲突呢？答案是，线程切换时会修改 TSS 表，确保每个线程执行时，TSS 里的 ESP,SS 都对应当前线程。</p>\n<p><code>Trap_Frame</code>  和 0 环栈密切相关。用户定义中断进 0 环，涉及提权时，CPU 会把 5 个寄存器的值压入 0 环堆栈，这是我们在中断门的课程里学习过的：</p>\n<p><img data-src=\"image001.png\" alt=\"\" /><br />\n上图是不完整的。</p>\n<p>实际上，完整的 0 环的栈是 Trap_Frame，中断门进 0 环后，新的 ESP 指向偏移 0x068（Eip）处。</p>\n<h2 id=\"trap_frame\"><a class=\"anchor\" href=\"#trap_frame\">#</a> Trap_Frame</h2>\n<p><img data-src=\"image002.png\" alt=\"\" /></p>\n<p>在 windbg 中查看</p>\n<figure class=\"highlight raw\"><figcaption data-lang=\"\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>kd&gt; dt _KTRAP_FRAME</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>nt!_KTRAP_FRAME</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>   +0x000 DbgEbp           : Uint4B</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>   +0x004 DbgEip           : Uint4B</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>   +0x008 DbgArgMark       : Uint4B</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>   +0x00c DbgArgPointer    : Uint4B</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>   +0x010 TempSegCs        : Uint4B</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>   +0x014 TempEsp          : Uint4B</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>   +0x018 Dr0              : Uint4B</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>   +0x01c Dr1              : Uint4B</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>   +0x020 Dr2              : Uint4B</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>   +0x024 Dr3              : Uint4B</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>   +0x028 Dr6              : Uint4B</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>   +0x02c Dr7              : Uint4B</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>   +0x030 SegGs            : Uint4B</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>   +0x034 SegEs            : Uint4B</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>   +0x038 SegDs            : Uint4B</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>   +0x03c Edx              : Uint4B</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>   +0x040 Ecx              : Uint4B</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>   +0x044 Eax              : Uint4B</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>   +0x048 PreviousPreviousMode : Uint4B</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>   +0x04c ExceptionList    : Ptr32 _EXCEPTION_REGISTRATION_RECORD</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>   +0x050 SegFs            : Uint4B</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>   +0x054 Edi              : Uint4B</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>   +0x058 Esi              : Uint4B</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>   +0x05c Ebx              : Uint4B</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>   +0x060 Ebp              : Uint4B</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>   +0x064 ErrCode          : Uint4B</pre></td></tr><tr><td data-num=\"29\"></td><td><pre>   +0x068 Eip              : Uint4B</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>   +0x06c SegCs            : Uint4B</pre></td></tr><tr><td data-num=\"31\"></td><td><pre>   +0x070 EFlags           : Uint4B</pre></td></tr><tr><td data-num=\"32\"></td><td><pre>   +0x074 HardwareEsp      : Uint4B</pre></td></tr><tr><td data-num=\"33\"></td><td><pre>   +0x078 HardwareSegSs    : Uint4B</pre></td></tr><tr><td data-num=\"34\"></td><td><pre>   +0x07c V86Es            : Uint4B</pre></td></tr><tr><td data-num=\"35\"></td><td><pre>   +0x080 V86Ds            : Uint4B</pre></td></tr><tr><td data-num=\"36\"></td><td><pre>   +0x084 V86Fs            : Uint4B</pre></td></tr><tr><td data-num=\"37\"></td><td><pre>   +0x088 V86Gs            : Uint4B</pre></td></tr></table></figure><p>_Trap_Frame 结构体，实际上是 windows 对内核栈的使用约定，它约定了不同的偏移分别用来存储什么数据。</p>\n<p>我们待会逆向 KiSystemService 的时候会发现，第一条指令就是 push 0，意思就是设置 ErrCode = 0。</p>\n<p>第一个问题：进 0 环后，原来的寄存器存在哪里？</p>\n<p>看到这个结构，相信你已经有了答案，我们可以通过逆向 KiSystemService 来验证猜想。</p>\n<h2 id=\"_kpcr-_nt_tib-_kprcb\"><a class=\"anchor\" href=\"#_kpcr-_nt_tib-_kprcb\">#</a> _KPCR, _NT_TIB, _KPRCB</h2>\n<p><img data-src=\"image003.png\" alt=\"\" /></p>\n<p>这三个结构体存储了当前 CPU 的信息，其实这三个结构体是一个结构体，只不过抽象成三部分而已。地址固定是 0xffdff000。</p>\n<p><code>_KPCR</code> <br />\nKPCR（Processor Control Region）是 CPU 控制区的意思，每个 CPU 都有一个 KPCR 结构。</p>\n<figure class=\"highlight raw\"><figcaption data-lang=\"\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>nt!_KPCR</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>   +0x000 NtTib            : _NT_TIB</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>   +0x01c SelfPcr          : Ptr32 _KPCR</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>   +0x020 Prcb             : Ptr32 _KPRCB</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>   +0x024 Irql             : UChar</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>   +0x028 IRR              : Uint4B</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>   +0x02c IrrActive        : Uint4B</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>   +0x030 IDR              : Uint4B</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>   +0x034 KdVersionBlock   : Ptr32 Void</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>   +0x038 IDT              : Ptr32 _KIDTENTRY</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>   +0x03c GDT              : Ptr32 _KGDTENTRY</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>   +0x040 TSS              : Ptr32 _KTSS</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>   +0x044 MajorVersion     : Uint2B</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>   +0x046 MinorVersion     : Uint2B</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>   +0x048 SetMember        : Uint4B</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>   +0x04c StallScaleFactor : Uint4B</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>   +0x050 DebugActive      : UChar</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>   +0x051 Number           : UChar</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>   +0x052 Spare0           : UChar</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>   +0x053 SecondLevelCacheAssociativity : UChar</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>   +0x054 VdmAlert         : Uint4B</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>   +0x058 KernelReserved   : [14] Uint4B</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>   +0x090 SecondLevelCacheSize : Uint4B</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>   +0x094 HalReserved      : [16] Uint4B</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>   +0x0d4 InterruptMode    : Uint4B</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>   +0x0d8 Spare1           : UChar</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>   +0x0dc KernelReserved2  : [17] Uint4B</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>   +0x120 PrcbData         : _KPRCB</pre></td></tr></table></figure><p><code>_NT_TIB</code> <br />\n 主要存储了 SEH 结构化异常链表和一个指向自己的指针。</p>\n<figure class=\"highlight raw\"><figcaption data-lang=\"\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>nt!_NT_TIB</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>   +0x000 ExceptionList    : Ptr32 _EXCEPTION_REGISTRATION_RECORD</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>   +0x004 StackBase        : Ptr32 Void</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>   +0x008 StackLimit       : Ptr32 Void</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>   +0x00c SubSystemTib     : Ptr32 Void</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>   +0x010 FiberData        : Ptr32 Void</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>   +0x010 Version          : Uint4B</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>   +0x014 ArbitraryUserPointer : Ptr32 Void</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>   +0x018 Self             : Ptr32 _NT_TIB</pre></td></tr></table></figure><p><code>_KPRCB</code></p>\n<figure class=\"highlight raw\"><figcaption data-lang=\"\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>nt!_KPRCB</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>   +0x000 MinorVersion     : Uint2B</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>   +0x002 MajorVersion     : Uint2B</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>   +0x004 CurrentThread    : Ptr32 _KTHREAD</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>   +0x008 NextThread       : Ptr32 _KTHREAD</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>   +0x00c IdleThread       : Ptr32 _KTHREAD</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>   +0x010 Number           : Char</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>   +0x011 Reserved         : Char</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>   +0x012 BuildType        : Uint2B</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>   +0x014 SetMember        : Uint4B</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>   +0x018 CpuType          : Char</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>   +0x019 CpuID            : Char</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>   +0x01a CpuStep          : Uint2B</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>   +0x01c ProcessorState   : _KPROCESSOR_STATE</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>   +0x33c KernelReserved   : [16] Uint4B</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>   +0x37c HalReserved      : [16] Uint4B</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>   +0x3bc PrcbPad0         : [92] UChar</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>   +0x418 LockQueue        : [16] _KSPIN_LOCK_QUEUE</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>   +0x498 PrcbPad1         : [8] UChar</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>   +0x4a0 NpxThread        : Ptr32 _KTHREAD</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>   +0x4a4 InterruptCount   : Uint4B</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>   +0x4a8 KernelTime       : Uint4B</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>   +0x4ac UserTime         : Uint4B</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>   +0x4b0 DpcTime          : Uint4B</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>   +0x4b4 DebugDpcTime     : Uint4B</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>   +0x4b8 InterruptTime    : Uint4B</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>   +0x4bc AdjustDpcThreshold : Uint4B</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>   +0x4c0 PageColor        : Uint4B</pre></td></tr><tr><td data-num=\"29\"></td><td><pre>   +0x4c4 SkipTick         : Uint4B</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>   +0x4c8 MultiThreadSetBusy : UChar</pre></td></tr><tr><td data-num=\"31\"></td><td><pre>   +0x4c9 Spare2           : [3] UChar</pre></td></tr><tr><td data-num=\"32\"></td><td><pre>   +0x4cc ParentNode       : Ptr32 _KNODE</pre></td></tr><tr><td data-num=\"33\"></td><td><pre>   +0x4d0 MultiThreadProcessorSet : Uint4B</pre></td></tr><tr><td data-num=\"34\"></td><td><pre>   +0x4d4 MultiThreadSetMaster : Ptr32 _KPRCB</pre></td></tr><tr><td data-num=\"35\"></td><td><pre>   +0x4d8 ThreadStartCount : [2] Uint4B</pre></td></tr><tr><td data-num=\"36\"></td><td><pre>   +0x4e0 CcFastReadNoWait : Uint4B</pre></td></tr><tr><td data-num=\"37\"></td><td><pre>   +0x4e4 CcFastReadWait   : Uint4B</pre></td></tr><tr><td data-num=\"38\"></td><td><pre>   +0x4e8 CcFastReadNotPossible : Uint4B</pre></td></tr><tr><td data-num=\"39\"></td><td><pre>   +0x4ec CcCopyReadNoWait : Uint4B</pre></td></tr><tr><td data-num=\"40\"></td><td><pre>   +0x4f0 CcCopyReadWait   : Uint4B</pre></td></tr><tr><td data-num=\"41\"></td><td><pre>   +0x4f4 CcCopyReadNoWaitMiss : Uint4B</pre></td></tr><tr><td data-num=\"42\"></td><td><pre>   +0x4f8 KeAlignmentFixupCount : Uint4B</pre></td></tr><tr><td data-num=\"43\"></td><td><pre>   +0x4fc KeContextSwitches : Uint4B</pre></td></tr><tr><td data-num=\"44\"></td><td><pre>   +0x500 KeDcacheFlushCount : Uint4B</pre></td></tr><tr><td data-num=\"45\"></td><td><pre>   +0x504 KeExceptionDispatchCount : Uint4B</pre></td></tr><tr><td data-num=\"46\"></td><td><pre>   +0x508 KeFirstLevelTbFills : Uint4B</pre></td></tr><tr><td data-num=\"47\"></td><td><pre>   +0x50c KeFloatingEmulationCount : Uint4B</pre></td></tr><tr><td data-num=\"48\"></td><td><pre>   +0x510 KeIcacheFlushCount : Uint4B</pre></td></tr><tr><td data-num=\"49\"></td><td><pre>   +0x514 KeSecondLevelTbFills : Uint4B</pre></td></tr><tr><td data-num=\"50\"></td><td><pre>   +0x518 KeSystemCalls    : Uint4B</pre></td></tr><tr><td data-num=\"51\"></td><td><pre>   +0x51c SpareCounter0    : [1] Uint4B</pre></td></tr><tr><td data-num=\"52\"></td><td><pre>   +0x520 PPLookasideList  : [16] _PP_LOOKASIDE_LIST</pre></td></tr><tr><td data-num=\"53\"></td><td><pre>   +0x5a0 PPNPagedLookasideList : [32] _PP_LOOKASIDE_LIST</pre></td></tr><tr><td data-num=\"54\"></td><td><pre>   +0x6a0 PPPagedLookasideList : [32] _PP_LOOKASIDE_LIST</pre></td></tr><tr><td data-num=\"55\"></td><td><pre>   +0x7a0 PacketBarrier    : Uint4B</pre></td></tr><tr><td data-num=\"56\"></td><td><pre>   +0x7a4 ReverseStall     : Uint4B</pre></td></tr><tr><td data-num=\"57\"></td><td><pre>   +0x7a8 IpiFrame         : Ptr32 Void</pre></td></tr><tr><td data-num=\"58\"></td><td><pre>   +0x7ac PrcbPad2         : [52] UChar</pre></td></tr><tr><td data-num=\"59\"></td><td><pre>   +0x7e0 CurrentPacket    : [3] Ptr32 Void</pre></td></tr><tr><td data-num=\"60\"></td><td><pre>   +0x7ec TargetSet        : Uint4B</pre></td></tr><tr><td data-num=\"61\"></td><td><pre>   +0x7f0 WorkerRoutine    : Ptr32     void </pre></td></tr><tr><td data-num=\"62\"></td><td><pre>   +0x7f4 IpiFrozen        : Uint4B</pre></td></tr><tr><td data-num=\"63\"></td><td><pre>   +0x7f8 PrcbPad3         : [40] UChar</pre></td></tr><tr><td data-num=\"64\"></td><td><pre>   +0x820 RequestSummary   : Uint4B</pre></td></tr><tr><td data-num=\"65\"></td><td><pre>   +0x824 SignalDone       : Ptr32 _KPRCB</pre></td></tr><tr><td data-num=\"66\"></td><td><pre>   +0x828 PrcbPad4         : [56] UChar</pre></td></tr><tr><td data-num=\"67\"></td><td><pre>   +0x860 DpcListHead      : _LIST_ENTRY</pre></td></tr><tr><td data-num=\"68\"></td><td><pre>   +0x868 DpcStack         : Ptr32 Void</pre></td></tr><tr><td data-num=\"69\"></td><td><pre>   +0x86c DpcCount         : Uint4B</pre></td></tr><tr><td data-num=\"70\"></td><td><pre>   +0x870 DpcQueueDepth    : Uint4B</pre></td></tr><tr><td data-num=\"71\"></td><td><pre>   +0x874 DpcRoutineActive : Uint4B</pre></td></tr><tr><td data-num=\"72\"></td><td><pre>   +0x878 DpcInterruptRequested : Uint4B</pre></td></tr><tr><td data-num=\"73\"></td><td><pre>   +0x87c DpcLastCount     : Uint4B</pre></td></tr><tr><td data-num=\"74\"></td><td><pre>   +0x880 DpcRequestRate   : Uint4B</pre></td></tr><tr><td data-num=\"75\"></td><td><pre>   +0x884 MaximumDpcQueueDepth : Uint4B</pre></td></tr><tr><td data-num=\"76\"></td><td><pre>   +0x888 MinimumDpcRate   : Uint4B</pre></td></tr><tr><td data-num=\"77\"></td><td><pre>   +0x88c QuantumEnd       : Uint4B</pre></td></tr><tr><td data-num=\"78\"></td><td><pre>   +0x890 PrcbPad5         : [16] UChar</pre></td></tr><tr><td data-num=\"79\"></td><td><pre>   +0x8a0 DpcLock          : Uint4B</pre></td></tr><tr><td data-num=\"80\"></td><td><pre>   +0x8a4 PrcbPad6         : [28] UChar</pre></td></tr><tr><td data-num=\"81\"></td><td><pre>   +0x8c0 CallDpc          : _KDPC</pre></td></tr><tr><td data-num=\"82\"></td><td><pre>   +0x8e0 ChainedInterruptList : Ptr32 Void</pre></td></tr><tr><td data-num=\"83\"></td><td><pre>   +0x8e4 LookasideIrpFloat : Int4B</pre></td></tr><tr><td data-num=\"84\"></td><td><pre>   +0x8e8 SpareFields0     : [6] Uint4B</pre></td></tr><tr><td data-num=\"85\"></td><td><pre>   +0x900 VendorString     : [13] UChar</pre></td></tr><tr><td data-num=\"86\"></td><td><pre>   +0x90d InitialApicId    : UChar</pre></td></tr><tr><td data-num=\"87\"></td><td><pre>   +0x90e LogicalProcessorsPerPhysicalProcessor : UChar</pre></td></tr><tr><td data-num=\"88\"></td><td><pre>   +0x910 MHz              : Uint4B</pre></td></tr><tr><td data-num=\"89\"></td><td><pre>   +0x914 FeatureBits      : Uint4B</pre></td></tr><tr><td data-num=\"90\"></td><td><pre>   +0x918 UpdateSignature  : _LARGE_INTEGER</pre></td></tr><tr><td data-num=\"91\"></td><td><pre>   +0x920 NpxSaveArea      : _FX_SAVE_AREA</pre></td></tr><tr><td data-num=\"92\"></td><td><pre>   +0xb30 PowerState       : _PROCESSOR_POWER_STATE</pre></td></tr></table></figure><h2 id=\"_ethread-_kthread\"><a class=\"anchor\" href=\"#_ethread-_kthread\">#</a> _ETHREAD, _KTHREAD</h2>\n<p>这俩其实也是同一个结构体，刚才介绍的 _KPRCB + 0x04 里用到了 _KTHREAD。这俩结构体存储的是线程相关的信息。</p>\n<p><code>_ETHREAD</code></p>\n<figure class=\"highlight raw\"><figcaption data-lang=\"\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>nt!_ETHREAD</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>   +0x000 Tcb              : _KTHREAD</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>   +0x1c0 CreateTime       : _LARGE_INTEGER</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>   +0x1c0 NestedFaultCount : Pos 0, 2 Bits</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>   +0x1c0 ApcNeeded        : Pos 2, 1 Bit</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>   +0x1c8 ExitTime         : _LARGE_INTEGER</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>   +0x1c8 LpcReplyChain    : _LIST_ENTRY</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>   +0x1c8 KeyedWaitChain   : _LIST_ENTRY</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>   +0x1d0 ExitStatus       : Int4B</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>   +0x1d0 OfsChain         : Ptr32 Void</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>   +0x1d4 PostBlockList    : _LIST_ENTRY</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>   +0x1dc TerminationPort  : Ptr32 _TERMINATION_PORT</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>   +0x1dc ReaperLink       : Ptr32 _ETHREAD</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>   +0x1dc KeyedWaitValue   : Ptr32 Void</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>   +0x1e0 ActiveTimerListLock : Uint4B</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>   +0x1e4 ActiveTimerListHead : _LIST_ENTRY</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>   +0x1ec Cid              : _CLIENT_ID</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>   +0x1f4 LpcReplySemaphore : _KSEMAPHORE</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>   +0x1f4 KeyedWaitSemaphore : _KSEMAPHORE</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>   +0x208 LpcReplyMessage  : Ptr32 Void</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>   +0x208 LpcWaitingOnPort : Ptr32 Void</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>   +0x20c ImpersonationInfo : Ptr32 _PS_IMPERSONATION_INFORMATION</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>   +0x210 IrpList          : _LIST_ENTRY</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>   +0x218 TopLevelIrp      : Uint4B</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>   +0x21c DeviceToVerify   : Ptr32 _DEVICE_OBJECT</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>   +0x220 ThreadsProcess   : Ptr32 _EPROCESS</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>   +0x224 StartAddress     : Ptr32 Void</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>   +0x228 Win32StartAddress : Ptr32 Void</pre></td></tr><tr><td data-num=\"29\"></td><td><pre>   +0x228 LpcReceivedMessageId : Uint4B</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>   +0x22c ThreadListEntry  : _LIST_ENTRY</pre></td></tr><tr><td data-num=\"31\"></td><td><pre>   +0x234 RundownProtect   : _EX_RUNDOWN_REF</pre></td></tr><tr><td data-num=\"32\"></td><td><pre>   +0x238 ThreadLock       : _EX_PUSH_LOCK</pre></td></tr><tr><td data-num=\"33\"></td><td><pre>   +0x23c LpcReplyMessageId : Uint4B</pre></td></tr><tr><td data-num=\"34\"></td><td><pre>   +0x240 ReadClusterSize  : Uint4B</pre></td></tr><tr><td data-num=\"35\"></td><td><pre>   +0x244 GrantedAccess    : Uint4B</pre></td></tr><tr><td data-num=\"36\"></td><td><pre>   +0x248 CrossThreadFlags : Uint4B</pre></td></tr><tr><td data-num=\"37\"></td><td><pre>   +0x248 Terminated       : Pos 0, 1 Bit</pre></td></tr><tr><td data-num=\"38\"></td><td><pre>   +0x248 DeadThread       : Pos 1, 1 Bit</pre></td></tr><tr><td data-num=\"39\"></td><td><pre>   +0x248 HideFromDebugger : Pos 2, 1 Bit</pre></td></tr><tr><td data-num=\"40\"></td><td><pre>   +0x248 ActiveImpersonationInfo : Pos 3, 1 Bit</pre></td></tr><tr><td data-num=\"41\"></td><td><pre>   +0x248 SystemThread     : Pos 4, 1 Bit</pre></td></tr><tr><td data-num=\"42\"></td><td><pre>   +0x248 HardErrorsAreDisabled : Pos 5, 1 Bit</pre></td></tr><tr><td data-num=\"43\"></td><td><pre>   +0x248 BreakOnTermination : Pos 6, 1 Bit</pre></td></tr><tr><td data-num=\"44\"></td><td><pre>   +0x248 SkipCreationMsg  : Pos 7, 1 Bit</pre></td></tr><tr><td data-num=\"45\"></td><td><pre>   +0x248 SkipTerminationMsg : Pos 8, 1 Bit</pre></td></tr><tr><td data-num=\"46\"></td><td><pre>   +0x24c SameThreadPassiveFlags : Uint4B</pre></td></tr><tr><td data-num=\"47\"></td><td><pre>   +0x24c ActiveExWorker   : Pos 0, 1 Bit</pre></td></tr><tr><td data-num=\"48\"></td><td><pre>   +0x24c ExWorkerCanWaitUser : Pos 1, 1 Bit</pre></td></tr><tr><td data-num=\"49\"></td><td><pre>   +0x24c MemoryMaker      : Pos 2, 1 Bit</pre></td></tr><tr><td data-num=\"50\"></td><td><pre>   +0x250 SameThreadApcFlags : Uint4B</pre></td></tr><tr><td data-num=\"51\"></td><td><pre>   +0x250 LpcReceivedMsgIdValid : Pos 0, 1 Bit</pre></td></tr><tr><td data-num=\"52\"></td><td><pre>   +0x250 LpcExitThreadCalled : Pos 1, 1 Bit</pre></td></tr><tr><td data-num=\"53\"></td><td><pre>   +0x250 AddressSpaceOwner : Pos 2, 1 Bit</pre></td></tr><tr><td data-num=\"54\"></td><td><pre>   +0x254 ForwardClusterOnly : UChar</pre></td></tr><tr><td data-num=\"55\"></td><td><pre>   +0x255 DisablePageFaultClustering : UChar</pre></td></tr></table></figure><p><code>_KTHREAD</code></p>\n<figure class=\"highlight raw\"><figcaption data-lang=\"\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>nt!_KTHREAD</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>   +0x000 Header           : _DISPATCHER_HEADER</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>   +0x010 MutantListHead   : _LIST_ENTRY</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>   +0x018 InitialStack     : Ptr32 Void</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>   +0x01c StackLimit       : Ptr32 Void</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>   +0x020 Teb              : Ptr32 Void</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>   +0x024 TlsArray         : Ptr32 Void</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>   +0x028 KernelStack      : Ptr32 Void</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>   +0x02c DebugActive      : UChar</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>   +0x02d State            : UChar</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>   +0x02e Alerted          : [2] UChar</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>   +0x030 Iopl             : UChar</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>   +0x031 NpxState         : UChar</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>   +0x032 Saturation       : Char</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>   +0x033 Priority         : Char</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>   +0x034 ApcState         : _KAPC_STATE</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>   +0x04c ContextSwitches  : Uint4B</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>   +0x050 IdleSwapBlock    : UChar</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>   +0x051 Spare0           : [3] UChar</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>   +0x054 WaitStatus       : Int4B</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>   +0x058 WaitIrql         : UChar</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>   +0x059 WaitMode         : Char</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>   +0x05a WaitNext         : UChar</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>   +0x05b WaitReason       : UChar</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>   +0x05c WaitBlockList    : Ptr32 _KWAIT_BLOCK</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>   +0x060 WaitListEntry    : _LIST_ENTRY</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>   +0x060 SwapListEntry    : _SINGLE_LIST_ENTRY</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>   +0x068 WaitTime         : Uint4B</pre></td></tr><tr><td data-num=\"29\"></td><td><pre>   +0x06c BasePriority     : Char</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>   +0x06d DecrementCount   : UChar</pre></td></tr><tr><td data-num=\"31\"></td><td><pre>   +0x06e PriorityDecrement : Char</pre></td></tr><tr><td data-num=\"32\"></td><td><pre>   +0x06f Quantum          : Char</pre></td></tr><tr><td data-num=\"33\"></td><td><pre>   +0x070 WaitBlock        : [4] _KWAIT_BLOCK</pre></td></tr><tr><td data-num=\"34\"></td><td><pre>   +0x0d0 LegoData         : Ptr32 Void</pre></td></tr><tr><td data-num=\"35\"></td><td><pre>   +0x0d4 KernelApcDisable : Uint4B</pre></td></tr><tr><td data-num=\"36\"></td><td><pre>   +0x0d8 UserAffinity     : Uint4B</pre></td></tr><tr><td data-num=\"37\"></td><td><pre>   +0x0dc SystemAffinityActive : UChar</pre></td></tr><tr><td data-num=\"38\"></td><td><pre>   +0x0dd PowerState       : UChar</pre></td></tr><tr><td data-num=\"39\"></td><td><pre>   +0x0de NpxIrql          : UChar</pre></td></tr><tr><td data-num=\"40\"></td><td><pre>   +0x0df InitialNode      : UChar</pre></td></tr><tr><td data-num=\"41\"></td><td><pre>   +0x0e0 ServiceTable     : Ptr32 Void</pre></td></tr><tr><td data-num=\"42\"></td><td><pre>   +0x0e4 Queue            : Ptr32 _KQUEUE</pre></td></tr><tr><td data-num=\"43\"></td><td><pre>   +0x0e8 ApcQueueLock     : Uint4B</pre></td></tr><tr><td data-num=\"44\"></td><td><pre>   +0x0f0 Timer            : _KTIMER</pre></td></tr><tr><td data-num=\"45\"></td><td><pre>   +0x118 QueueListEntry   : _LIST_ENTRY</pre></td></tr><tr><td data-num=\"46\"></td><td><pre>   +0x120 SoftAffinity     : Uint4B</pre></td></tr><tr><td data-num=\"47\"></td><td><pre>   +0x124 Affinity         : Uint4B</pre></td></tr><tr><td data-num=\"48\"></td><td><pre>   +0x128 Preempted        : UChar</pre></td></tr><tr><td data-num=\"49\"></td><td><pre>   +0x129 ProcessReadyQueue : UChar</pre></td></tr><tr><td data-num=\"50\"></td><td><pre>   +0x12a KernelStackResident : UChar</pre></td></tr><tr><td data-num=\"51\"></td><td><pre>   +0x12b NextProcessor    : UChar</pre></td></tr><tr><td data-num=\"52\"></td><td><pre>   +0x12c CallbackStack    : Ptr32 Void</pre></td></tr><tr><td data-num=\"53\"></td><td><pre>   +0x130 Win32Thread      : Ptr32 Void</pre></td></tr><tr><td data-num=\"54\"></td><td><pre>   +0x134 TrapFrame        : Ptr32 _KTRAP_FRAME</pre></td></tr><tr><td data-num=\"55\"></td><td><pre>   +0x138 ApcStatePointer  : [2] Ptr32 _KAPC_STATE</pre></td></tr><tr><td data-num=\"56\"></td><td><pre>   +0x140 PreviousMode     : Char</pre></td></tr><tr><td data-num=\"57\"></td><td><pre>   +0x141 EnableStackSwap  : UChar</pre></td></tr><tr><td data-num=\"58\"></td><td><pre>   +0x142 LargeStack       : UChar</pre></td></tr><tr><td data-num=\"59\"></td><td><pre>   +0x143 ResourceIndex    : UChar</pre></td></tr><tr><td data-num=\"60\"></td><td><pre>   +0x144 KernelTime       : Uint4B</pre></td></tr><tr><td data-num=\"61\"></td><td><pre>   +0x148 UserTime         : Uint4B</pre></td></tr><tr><td data-num=\"62\"></td><td><pre>   +0x14c SavedApcState    : _KAPC_STATE</pre></td></tr><tr><td data-num=\"63\"></td><td><pre>   +0x164 Alertable        : UChar</pre></td></tr><tr><td data-num=\"64\"></td><td><pre>   +0x165 ApcStateIndex    : UChar</pre></td></tr><tr><td data-num=\"65\"></td><td><pre>   +0x166 ApcQueueable     : UChar</pre></td></tr><tr><td data-num=\"66\"></td><td><pre>   +0x167 AutoAlignment    : UChar</pre></td></tr><tr><td data-num=\"67\"></td><td><pre>   +0x168 StackBase        : Ptr32 Void</pre></td></tr><tr><td data-num=\"68\"></td><td><pre>   +0x16c SuspendApc       : _KAPC</pre></td></tr><tr><td data-num=\"69\"></td><td><pre>   +0x19c SuspendSemaphore : _KSEMAPHORE</pre></td></tr><tr><td data-num=\"70\"></td><td><pre>   +0x1b0 ThreadListEntry  : _LIST_ENTRY</pre></td></tr><tr><td data-num=\"71\"></td><td><pre>   +0x1b8 FreezeCount      : Char</pre></td></tr><tr><td data-num=\"72\"></td><td><pre>   +0x1b9 SuspendCount     : Char</pre></td></tr><tr><td data-num=\"73\"></td><td><pre>   +0x1ba IdealProcessor   : UChar</pre></td></tr><tr><td data-num=\"74\"></td><td><pre>   +0x1bb DisableBoost     : UChar</pre></td></tr></table></figure><h2 id=\"分析-kifastcallentry\"><a class=\"anchor\" href=\"#分析-kifastcallentry\">#</a> 分析 KiFastCallEntry</h2>\n<p>在 IDA 中查看内核函数 KiFastCallEntry，发现有两个：</p>\n<p><img data-src=\"image004.png\" alt=\"\" /></p>\n<p>这是因为，内核函数也是有两套的，一套给用户层用，一套给内核层用。</p>\n<p>提权与不提权的堆栈变化不同。</p>\n<p>我们从 3 环来的，走的是 KiFastCallEntry。</p>\n<p>首先函数修改了 FS 段寄存器的段选择子，使其指向了 KPCR 这个结构。</p>\n<p>这个我们可以根据段选择子查 GDT 表，查看 KPCR 的位置。</p>\n<p><img data-src=\"image005.png\" alt=\"\" /></p>\n<p>在其中 0x120 处的 KPRCB 结构中也可以看 CPU 的厂商，其原理还是用 cpuid 指令查询后写到这里的。</p>\n<p><code>+0x900 VendorString     : [13]  &quot;GenuineIntel&quot;</code></p>\n<figure class=\"highlight raw\"><figcaption data-lang=\"\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>.text:0046A6E0 _KiFastCallEntry proc near              ; DATA XREF: KiLoadFastSyscallMachineSpecificRegisters (x)+24↑o</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>.text:0046A6E0                                         ; _KiTrap01+74↓o</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>.text:0046A6E0                 mov     ecx, 23h ; &#39;#&#39;</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>.text:0046A6E5                 push    30h ; &#39;0&#39;</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>.text:0046A6E7                 pop     fs              ; 修改 FS 段选择子 0 环的 FS 指向 KPCR 这个结构体 3 环的指向 TEB</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>.text:0046A6E9                 mov     ds, ecx         ; 修改 ds es 段选择子，在 3 环好像也是 0x23</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>.text:0046A6EB                 mov     es, ecx</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>.text:0046A6EB _KiFastCallEntry endp</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>.text:0046A6EB</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>.text:0046A6ED                 mov     ecx, large fs:_KPCR.TSS ; 取 TSS 的地址赋给 ecx</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>.text:0046A6F4                 mov     esp, [ecx+_KTSS.Esp0] ; 取 TSS 中存储的 0 环的 ESP。这个 ESP 指向的是 KTRAP_FRAME 结构，后面的压栈都是往这个结构体重填充数据。</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>.text:0046A6F7                 push    23h ; &#39;#&#39;       ; 系统写死了，这里相结构体中填充的是 3 环的 SS，既修改 3 环的 SS 为 0x23</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>.text:0046A6F9                 push    edx             ; 把 3 环的 esp 压栈</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>.text:0046A6FA                 pushf                   ; 压入 16 位的 flags。esp 会 - 2</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>.text:0046A6FB</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>.text:0046A6FB loc_46A6FB:                             ; CODE XREF: _KiFastCallEntry2+23↑j</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>.text:0046A6FB                 push    2</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>.text:0046A6FD                 add     edx, 8          ; 取参数。esp+8 的位置 是 三环压入的参数的起始位置</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>.text:0046A700                 popf                    ; 修改 EFLAGS 为 2。因为 eflags 的第 1（从 0 开始计数）位默认要为 1。即清空 Eflag</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>.text:0046A701                 or      byte ptr [esp+1], 2 ; 对压入的 16 位 3 环 flags 寄存器的值的第 9（从 0 开始）位进行或操作。既把第 9 位的值置为 1。</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>.text:0046A706                 push    1Bh             ; SegCs</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>.text:0046A708                 push    dword ptr ds:0FFDF0304h ; 返回地址 既结构体 KUSER_SHARED_DATA 中的 SystemCallReturn 成员</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>.text:0046A70E                 push    0               ; ErrorCode</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>.text:0046A710                 push    ebp</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>.text:0046A711                 push    ebx</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>.text:0046A712                 push    esi</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>.text:0046A713                 push    edi</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>.text:0046A714                 mov     ebx, large fs:_KPCR.SelfPcr ; ebx &#x3D; KPCR</pre></td></tr><tr><td data-num=\"29\"></td><td><pre>.text:0046A71B                 push    3Bh ; &#39;;&#39;       ; SegFs。系统写死了是 0x3B, 这说明不论是单核还是多核，在 GDT 中 0x3B 这个位置就是 3 环的 fs</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>.text:0046A71D                 mov     esi, [ebx+_KPCR.PrcbData.CurrentThread] ; esi &#x3D; 当前 CPU 所执行线程的_ETHREAD 结构体</pre></td></tr><tr><td data-num=\"31\"></td><td><pre>.text:0046A723                 push    dword ptr [ebx] ; 压入 3 环的 ExceptionList</pre></td></tr><tr><td data-num=\"32\"></td><td><pre>.text:0046A725                 mov     dword ptr [ebx], 0FFFFFFFFh ; 将 ExceptionList 置 -1（EXCEPTION_CHAIN_END）</pre></td></tr><tr><td data-num=\"33\"></td><td><pre>.text:0046A72B                 mov     ebp, [esi+_ETHREAD.Tcb.InitialStack] ; 线程初始的栈</pre></td></tr><tr><td data-num=\"34\"></td><td><pre>.text:0046A72E                 push    1               ; 存储到 PreviousMode（先前模式）。</pre></td></tr><tr><td data-num=\"35\"></td><td><pre>.text:0046A72E                                         ; 1 表示表示用户态进来</pre></td></tr><tr><td data-num=\"36\"></td><td><pre>.text:0046A730                 sub     esp, 48h        ; 栈顶提升 0x48。指向_KTRAP_FRAME 结构体的第一个成员</pre></td></tr><tr><td data-num=\"37\"></td><td><pre>.text:0046A733                 sub     ebp, 29Ch       ; 减去 0x29c 后指向的与 esp 是同一个位置</pre></td></tr><tr><td data-num=\"38\"></td><td><pre>.text:0046A739                 mov     [esi+_ETHREAD.Tcb.PreviousMode], 1</pre></td></tr><tr><td data-num=\"39\"></td><td><pre>.text:0046A740                 cmp     ebp, esp</pre></td></tr><tr><td data-num=\"40\"></td><td><pre>.text:0046A742                 jnz     short loc_46A6D1 ; 如果不相等，跳入异常</pre></td></tr><tr><td data-num=\"41\"></td><td><pre>.text:0046A744                 and     [ebp+_KTRAP_FRAME.Dr7], 0 ; 把调试相关的寄存器 Dr7（控制寄存器，debug 异常发生的允许条件由 Dr7 控制）设置为 0</pre></td></tr><tr><td data-num=\"42\"></td><td><pre>.text:0046A748                 test    [esi+_ETHREAD.Tcb.DebugActive], 0FFh ; 判断线程是否是在调试的状态</pre></td></tr><tr><td data-num=\"43\"></td><td><pre>.text:0046A74C                 mov     [esi+_ETHREAD.Tcb.TrapFrame], ebp ; 保存当前线程的环境，这样我们的环境就和线程相关联了。</pre></td></tr><tr><td data-num=\"44\"></td><td><pre>.text:0046A752                 jnz     Dr_FastCallDrSave ; 若是调试的话会接着填充 Trap_Frame 结构体中调试相关的成员。</pre></td></tr><tr><td data-num=\"45\"></td><td><pre>.text:0046A758 loc_46A758:                             ; CODE XREF: Dr_FastCallDrSave+10↑j</pre></td></tr><tr><td data-num=\"46\"></td><td><pre>.text:0046A758                                         ; Dr_FastCallDrSave+7C↑j</pre></td></tr><tr><td data-num=\"47\"></td><td><pre>.text:0046A758                 mov     ebx, [ebp+_KTRAP_FRAME._Ebp] ; ebx &#x3D; TrapFrame.Ebp</pre></td></tr><tr><td data-num=\"48\"></td><td><pre>.text:0046A75B                 mov     edi, [ebp+_KTRAP_FRAME._Eip] ; edi &#x3D; TrapFrame.Eip</pre></td></tr><tr><td data-num=\"49\"></td><td><pre>.text:0046A75E                 mov     [ebp+_KTRAP_FRAME.DbgArgPointer], edx ; DbgArgPointer &#x3D; 3 环传来的参数列表</pre></td></tr><tr><td data-num=\"50\"></td><td><pre>.text:0046A761                 mov     [ebp+_KTRAP_FRAME.DbgArgMark], 0BADB0D00h ; DbgArgMark 掩码，现在记住就行</pre></td></tr><tr><td data-num=\"51\"></td><td><pre>.text:0046A768                 mov     [ebp+_KTRAP_FRAME.DbgEbp], ebx ; DbgEbp &#x3D; Trap_Frame.Ebp</pre></td></tr><tr><td data-num=\"52\"></td><td><pre>.text:0046A76B                 mov     [ebp+_KTRAP_FRAME.DbgEip], edi ; DbgEip &#x3D; Trap_Frame.DbgEip</pre></td></tr><tr><td data-num=\"53\"></td><td><pre>.text:0046A76E                 sti                     ; 启用中断，不允许别人打断</pre></td></tr><tr><td data-num=\"54\"></td><td><pre>.text:0046A76F</pre></td></tr><tr><td data-num=\"55\"></td><td><pre>.text:0046A76F loc_46A76F:                             ; CODE XREF: _KiBBTUnexpectedRange+18↑j</pre></td></tr><tr><td data-num=\"56\"></td><td><pre>.text:0046A76F                                         ; _KiSystemService+72↑j</pre></td></tr><tr><td data-num=\"57\"></td><td><pre>.text:0046A76F                 mov     edi, eax        ; 取 3 环传来的服务号</pre></td></tr><tr><td data-num=\"58\"></td><td><pre>.text:0046A771                 shr     edi, 8          ; 右移 8 位</pre></td></tr><tr><td data-num=\"59\"></td><td><pre>.text:0046A774                 and     edi, 30h        ; (（编号 &gt;&gt;8) &amp; 0x30) 确定是哪个表中。也就是说大于 0xFFF 的在另一个表中</pre></td></tr><tr><td data-num=\"60\"></td><td><pre>.text:0046A777                 mov     ecx, edi        ; ecx &#x3D; 表的偏移</pre></td></tr><tr><td data-num=\"61\"></td><td><pre>.text:0046A779                 add     edi, [esi+_ETHREAD.Tcb.ServiceTable] ; edi &#x3D; 服务表。线程初始化的时候 SSDT 表的值就已经放到这里了。</pre></td></tr><tr><td data-num=\"62\"></td><td><pre>.text:0046A77F                 mov     ebx, eax        ; ebx &#x3D; 3 环传来的服务号</pre></td></tr><tr><td data-num=\"63\"></td><td><pre>.text:0046A781                 and     eax, 0FFFh      ; 获取真正的编号</pre></td></tr><tr><td data-num=\"64\"></td><td><pre>.text:0046A786                 cmp     eax, [edi+8]    ; 服务表加 8，服务表里的函数的最大个数。</pre></td></tr><tr><td data-num=\"65\"></td><td><pre>.text:0046A789                 jnb     _KiBBTUnexpectedRange ; 如果超出，说明越界，跳走</pre></td></tr><tr><td data-num=\"66\"></td><td><pre>.text:0046A78F                 cmp     ecx, 10h        ; 判断是否是 UI 表</pre></td></tr><tr><td data-num=\"67\"></td><td><pre>.text:0046A792                 jnz     short loc_46A7AF ; 如果不是 UI 表就跳走</pre></td></tr><tr><td data-num=\"68\"></td><td><pre>.text:0046A794                 mov     ecx, large fs:_KPCR.NtTib.Self ; 取自己</pre></td></tr><tr><td data-num=\"69\"></td><td><pre>.text:0046A79B                 xor     ebx, ebx</pre></td></tr><tr><td data-num=\"70\"></td><td><pre>ext:0046A79D                   ; _DWORD __stdcall loc_46A79D ()</pre></td></tr><tr><td data-num=\"71\"></td><td><pre>.text:0046A79D                   loc_46A79D:                             ; DATA XREF: KiPreprocessAccessViolation (x,x,x)+3D↑o</pre></td></tr><tr><td data-num=\"72\"></td><td><pre>.text:0046A79D 0B 99 70 0F 00 00                 or      ebx, [ecx+0F70h]</pre></td></tr><tr><td data-num=\"73\"></td><td><pre>.text:0046A7A3 74 0A                             jz      short loc_46A7AF</pre></td></tr><tr><td data-num=\"74\"></td><td><pre>.text:0046A7A5 52                                push    edx</pre></td></tr><tr><td data-num=\"75\"></td><td><pre>.text:0046A7A6 50                                push    eax</pre></td></tr><tr><td data-num=\"76\"></td><td><pre>.text:0046A7A7 FF 15 48 57 48 00                 call    ds:_KeGdiFlushUserBatch</pre></td></tr><tr><td data-num=\"77\"></td><td><pre>.text:0046A7AD 58                                pop     eax</pre></td></tr><tr><td data-num=\"78\"></td><td><pre>.text:0046A7AE 5A                                pop     edx</pre></td></tr><tr><td data-num=\"79\"></td><td><pre>.text:0046A7AF</pre></td></tr><tr><td data-num=\"80\"></td><td><pre>.text:0046A7AF                   loc_46A7AF:                             ; CODE XREF: .text:0046A792↑j</pre></td></tr><tr><td data-num=\"81\"></td><td><pre>.text:0046A7AF                                                           ; .text:0046A7A3↑j</pre></td></tr><tr><td data-num=\"82\"></td><td><pre>.text:0046A7AF 64 FF 05 38 06 00+                inc     large dword ptr fs:_KPCR.PrcbData.KeSystemCalls</pre></td></tr><tr><td data-num=\"83\"></td><td><pre>.text:0046A7AF 00</pre></td></tr><tr><td data-num=\"84\"></td><td><pre>.text:0046A7B6 8B F2                             mov     esi, edx        ; esi &#x3D; 指向 3 环函数传递的参数（在堆栈中）</pre></td></tr><tr><td data-num=\"85\"></td><td><pre>.text:0046A7B8 8B 5F 0C                          mov     ebx, [edi+0Ch]  ; SSDT 参数表地址</pre></td></tr><tr><td data-num=\"86\"></td><td><pre>.text:0046A7BB 33 C9                             xor     ecx, ecx</pre></td></tr><tr><td data-num=\"87\"></td><td><pre>.text:0046A7BD 8A 0C 18                          mov     cl, [eax+ebx]   ; 获得调用指定函数的参数表的参数长度</pre></td></tr><tr><td data-num=\"88\"></td><td><pre>.text:0046A7C0 8B 3F                             mov     edi, [edi]      ; 获取函数表</pre></td></tr><tr><td data-num=\"89\"></td><td><pre>.text:0046A7C2 8B 1C 87                          mov     ebx, [edi+eax*4] ; 获取函数</pre></td></tr><tr><td data-num=\"90\"></td><td><pre>.text:0046A7C5 2B E1                             sub     esp, ecx        ; 获取要 copy 的栈</pre></td></tr><tr><td data-num=\"91\"></td><td><pre>.text:0046A7C7 C1 E9 02                          shr     ecx, 2          ; 按照四个字节来 copy 所以 &gt;&gt;2</pre></td></tr><tr><td data-num=\"92\"></td><td><pre>.text:0046A7CA 8B FC                             mov     edi, esp</pre></td></tr><tr><td data-num=\"93\"></td><td><pre>.text:0046A7CC F6 45 72 02                       test    byte ptr [ebp+(_KTRAP_FRAME.EFlags+2)], 2 ; 判断 eflags 的第 1（从 0 开始计数）位是否为 1。KTRAP_FRAME 里保存的是 3 环的数据。</pre></td></tr><tr><td data-num=\"94\"></td><td><pre>.text:0046A7D0 75 06                             jnz     short loc_46A7D8 ; 判断地址是否是 3 环的。就是 0x7fffffff-- 火哥说的</pre></td></tr><tr><td data-num=\"95\"></td><td><pre>.text:0046A7D2 F6 45 6C 01                       test    byte ptr [ebp+_KTRAP_FRAME.SegCs], 1 ; 判断 CS 是不是用户环的</pre></td></tr><tr><td data-num=\"96\"></td><td><pre>.text:0046A7D6 74 0C                             jz      short loc_46A7E4 ; 如果是 0 环的，就不用判断地址是否合法了</pre></td></tr><tr><td data-num=\"97\"></td><td><pre>.text:0046A7D8</pre></td></tr><tr><td data-num=\"98\"></td><td><pre>.text:0046A7D8                   loc_46A7D8:                             ; CODE XREF: .text:0046A7D0↑j</pre></td></tr><tr><td data-num=\"99\"></td><td><pre>.text:0046A7D8 3B 35 34 B1 48 00                 cmp     esi, ds:_MmUserProbeAddress ; 判断地址是否是 3 环的。就是 0x7fffffff-- 火哥说的</pre></td></tr><tr><td data-num=\"100\"></td><td><pre>.text:0046A7DE 0F 83 A8 01 00 00                 jnb     loc_46A98C      ; 地址访问异常</pre></td></tr><tr><td data-num=\"101\"></td><td><pre>.text:0046A7E4</pre></td></tr><tr><td data-num=\"102\"></td><td><pre>.text:0046A7E4                   ; _DWORD __stdcall loc_46A7E4 ()</pre></td></tr><tr><td data-num=\"103\"></td><td><pre>.text:0046A7E4                   loc_46A7E4:                             ; CODE XREF: .text:0046A7D6↑j</pre></td></tr><tr><td data-num=\"104\"></td><td><pre>.text:0046A7E4                                                           ; DATA XREF: KiPreprocessAccessViolation (x,x,x):loc_42BD4B↑o</pre></td></tr><tr><td data-num=\"105\"></td><td><pre>.text:0046A7E4 F3 A5                             rep movsd               ; 拷贝参数</pre></td></tr><tr><td data-num=\"106\"></td><td><pre>.text:0046A7E6 FF D3                             call    ebx             ; 调用函数</pre></td></tr><tr><td data-num=\"107\"></td><td><pre>.text:0046A7E8</pre></td></tr><tr><td data-num=\"108\"></td><td><pre>.text:0046A7E8                   ; _DWORD __stdcall loc_46A7E8 ()</pre></td></tr><tr><td data-num=\"109\"></td><td><pre>.text:0046A7E8                   loc_46A7E8:                             ; CODE XREF: .text:0046A991↓j</pre></td></tr><tr><td data-num=\"110\"></td><td><pre>.text:0046A7E8                                                           ; DATA XREF: KiPreprocessAccessViolation (x,x,x)+59↑o</pre></td></tr><tr><td data-num=\"111\"></td><td><pre>.text:0046A7E8 8B E5                             mov     esp, ebp        ; esp ebp 又指向了 KTRAP_FRAME 结构体</pre></td></tr><tr><td data-num=\"112\"></td><td><pre>.text:0046A7EA</pre></td></tr><tr><td data-num=\"113\"></td><td><pre>.text:0046A7EA                   loc_46A7EA:                             ; CODE XREF: _KiBBTUnexpectedRange+38↑j</pre></td></tr><tr><td data-num=\"114\"></td><td><pre>.text:0046A7EA                                                           ; _KiBBTUnexpectedRange+43↑j</pre></td></tr><tr><td data-num=\"115\"></td><td><pre>.text:0046A7EA 64 8B 0D 24 01 00+                mov     ecx, large fs:_KPCR.PrcbData.CurrentThread ; ecx &#x3D; 当前 CPU 所执行线程的_ETHREAD 结构体</pre></td></tr><tr><td data-num=\"116\"></td><td><pre>.text:0046A7EA 00</pre></td></tr><tr><td data-num=\"117\"></td><td><pre>.text:0046A7F1 8B 55 3C                          mov     edx, [ebp+_KTRAP_FRAME._Edx] ; 取三环的 esp</pre></td></tr><tr><td data-num=\"118\"></td><td><pre>.text:0046A7F4 89 91 34 01 00 00                 mov     [ecx+_KTHREAD.TrapFrame], edx</pre></td></tr><tr><td data-num=\"119\"></td><td><pre>.text:0046A7FA</pre></td></tr><tr><td data-num=\"120\"></td><td><pre>.text:0046A7FA                   loc_46A7FA:                             ; CODE XREF: KiCallUserMode (x,x)+EC↑j</pre></td></tr><tr><td data-num=\"121\"></td><td><pre>.text:0046A7FA                                                           ; NtContinue (x,x)+43↓j ...</pre></td></tr><tr><td data-num=\"122\"></td><td><pre>.text:0046A7FA FA                                cli                     ; 结束中断</pre></td></tr><tr><td data-num=\"123\"></td><td><pre>.text:0046A7FB F7 45 70 00 00 02+                test    [ebp+_KTRAP_FRAME.EFlags], 20000h ; 判断是不是虚拟 8086 模式。eflags 中的 VM 位（第 17 位）。</pre></td></tr><tr><td data-num=\"124\"></td><td><pre>.text:0046A7FB 00</pre></td></tr><tr><td data-num=\"125\"></td><td><pre>.text:0046A802 75 06                             jnz     short loc_46A80A ; ebx &#x3D; 当前 CPU 所执行线程的_ETHREAD 结构体</pre></td></tr><tr><td data-num=\"126\"></td><td><pre>.text:0046A804 F6 45 6C 01                       test    byte ptr [ebp+_KTRAP_FRAME.SegCs], 1 ; 判断是否是用户态</pre></td></tr><tr><td data-num=\"127\"></td><td><pre>.text:0046A808 74 56                             jz      short loc_46A860 ; 取出异常链</pre></td></tr><tr><td data-num=\"128\"></td><td><pre>.text:0046A80A</pre></td></tr><tr><td data-num=\"129\"></td><td><pre>.text:0046A80A                   loc_46A80A:                             ; CODE XREF: .text:0046A802↑j</pre></td></tr><tr><td data-num=\"130\"></td><td><pre>.text:0046A80A                                                           ; .text:0046A85E↓j</pre></td></tr><tr><td data-num=\"131\"></td><td><pre>.text:0046A80A 64 8B 1D 24 01 00+                mov     ebx, large fs:_KPCR.PrcbData.CurrentThread ; ebx &#x3D; 当前 CPU 所执行线程的_ETHREAD 结构体</pre></td></tr><tr><td data-num=\"132\"></td><td><pre>.text:0046A80A 00</pre></td></tr><tr><td data-num=\"133\"></td><td><pre>.text:0046A811 C6 43 2E 00                       mov     [ebx+_ETHREAD.Tcb.Alerted], 0 ; APC 相关的了，还没学，先跳过。</pre></td></tr><tr><td data-num=\"134\"></td><td><pre>.text:0046A815 80 7B 4A 00                       cmp     [ebx+_ETHREAD.Tcb.ApcState.UserApcPending], 0</pre></td></tr><tr><td data-num=\"135\"></td><td><pre>.text:0046A819 74 45                             jz      short loc_46A860 ; 取出异常链</pre></td></tr><tr><td data-num=\"136\"></td><td><pre>.text:0046A81B 8B DD                             mov     ebx, ebp</pre></td></tr><tr><td data-num=\"137\"></td><td><pre>.text:0046A81D 89 43 44                          mov     [ebx+44h], eax</pre></td></tr><tr><td data-num=\"138\"></td><td><pre>.text:0046A820 C7 43 50 3B 00 00+                mov     [ebx+_KTRAP_FRAME.SegFs], 3Bh ; &#39;;&#39;</pre></td></tr><tr><td data-num=\"139\"></td><td><pre>.text:0046A820 00</pre></td></tr><tr><td data-num=\"140\"></td><td><pre>.text:0046A827 C7 43 38 23 00 00+                mov     [ebx+_KTRAP_FRAME.SegDs], 23h ; &#39;#&#39;</pre></td></tr><tr><td data-num=\"141\"></td><td><pre>.text:0046A827 00</pre></td></tr><tr><td data-num=\"142\"></td><td><pre>.text:0046A82E C7 43 34 23 00 00+                mov     [ebx+_KTRAP_FRAME.SegEs], 23h ; &#39;#&#39;</pre></td></tr><tr><td data-num=\"143\"></td><td><pre>.text:0046A82E 00</pre></td></tr><tr><td data-num=\"144\"></td><td><pre>.text:0046A835 C7 43 30 00 00 00+                mov     [ebx+_KTRAP_FRAME.SegGs], 0</pre></td></tr><tr><td data-num=\"145\"></td><td><pre>.text:0046A835 00</pre></td></tr><tr><td data-num=\"146\"></td><td><pre>.text:0046A83C B9 01 00 00 00                    mov     ecx, 1</pre></td></tr><tr><td data-num=\"147\"></td><td><pre>.text:0046A841 FF 15 2C 10 40 00                 call    ds:__imp_@KfRaiseIrql@4 ; KfRaiseIrql (x)</pre></td></tr><tr><td data-num=\"148\"></td><td><pre>.text:0046A847 50                                push    eax</pre></td></tr><tr><td data-num=\"149\"></td><td><pre>.text:0046A848 FB                                sti</pre></td></tr><tr><td data-num=\"150\"></td><td><pre>.text:0046A849 53                                push    ebx</pre></td></tr><tr><td data-num=\"151\"></td><td><pre>.text:0046A84A 6A 00                             push    0</pre></td></tr><tr><td data-num=\"152\"></td><td><pre>.text:0046A84C 6A 01                             push    1</pre></td></tr><tr><td data-num=\"153\"></td><td><pre>.text:0046A84E E8 99 DF FB FF                    call    _KiDeliverApc@12 ; KiDeliverApc (x,x,x)</pre></td></tr><tr><td data-num=\"154\"></td><td><pre>.text:0046A853 59                                pop     ecx</pre></td></tr><tr><td data-num=\"155\"></td><td><pre>.text:0046A854 FF 15 30 10 40 00                 call    ds:__imp_@KfLowerIrql@4 ; KfLowerIrql (x)</pre></td></tr><tr><td data-num=\"156\"></td><td><pre>.text:0046A85A 8B 43 44                          mov     eax, [ebx+44h]</pre></td></tr><tr><td data-num=\"157\"></td><td><pre>.text:0046A85D FA                                cli</pre></td></tr><tr><td data-num=\"158\"></td><td><pre>.text:0046A85E EB AA                             jmp     short loc_46A80A ; ebx &#x3D; 当前 CPU 所执行线程的_ETHREAD 结构体</pre></td></tr><tr><td data-num=\"159\"></td><td><pre>.text:0046A860                   ; ---------------------------------------------------------------------------</pre></td></tr><tr><td data-num=\"160\"></td><td><pre>.text:0046A860</pre></td></tr><tr><td data-num=\"161\"></td><td><pre>.text:0046A860                   loc_46A860:                             ; CODE XREF: .text:0046A808↑j</pre></td></tr><tr><td data-num=\"162\"></td><td><pre>.text:0046A860                                                           ; .text:0046A819↑j</pre></td></tr><tr><td data-num=\"163\"></td><td><pre>.text:0046A860 8B 54 24 4C                       mov     edx, [esp+_KTRAP_FRAME.ExceptionList] ; 取出异常链</pre></td></tr><tr><td data-num=\"164\"></td><td><pre>.text:0046A864 64 8B 1D 50 00 00+                mov     ebx, large fs:_KPCR.DebugActive ; 取出调试状态</pre></td></tr><tr><td data-num=\"165\"></td><td><pre>.text:0046A864 00</pre></td></tr><tr><td data-num=\"166\"></td><td><pre>.text:0046A86B 64 89 15 00 00 00+                mov     large fs:_KPCR, edx ; 把 KTRAP_FRAME 结构中的 ExceptionList 放在了 KPCR 结构成员 ExceptionList。要还原了，恢复数据。</pre></td></tr><tr><td data-num=\"167\"></td><td><pre>.text:0046A86B 00</pre></td></tr><tr><td data-num=\"168\"></td><td><pre>.text:0046A872 8B 4C 24 48                       mov     ecx, [esp+_KTRAP_FRAME.PreviousPreviousMode]</pre></td></tr><tr><td data-num=\"169\"></td><td><pre>.text:0046A876 64 8B 35 24 01 00+                mov     esi, large fs:_KPCR.PrcbData.CurrentThread</pre></td></tr><tr><td data-num=\"170\"></td><td><pre>.text:0046A876 00</pre></td></tr><tr><td data-num=\"171\"></td><td><pre>.text:0046A87D 88 8E 40 01 00 00                 mov     [esi+_ETHREAD.Tcb.PreviousMode], cl ; 把 KTRAP_FRAME 结构中的 PreviousPreviousMode 放在了 KPCR 的结构成员 PreviousMode。把先前模式还原</pre></td></tr><tr><td data-num=\"172\"></td><td><pre>.text:0046A883 F7 C3 FF 00 00 00                 test    ebx, 0FFh       ; 再次判断调试状态</pre></td></tr><tr><td data-num=\"173\"></td><td><pre>.text:0046A889 75 79                             jnz     short loc_46A904 ; 若是调试状态还要，还原一些调试相关的寄存器</pre></td></tr><tr><td data-num=\"174\"></td><td><pre>.text:0046A88B</pre></td></tr><tr><td data-num=\"175\"></td><td><pre>.text:0046A88B                   loc_46A88B:                             ; CODE XREF: .text:0046A914↓j</pre></td></tr><tr><td data-num=\"176\"></td><td><pre>.text:0046A88B                                                           ; .text:0046A943↓j</pre></td></tr><tr><td data-num=\"177\"></td><td><pre>.text:0046A88B F7 44 24 70 00 00+                test    [esp+_KTRAP_FRAME.EFlags], 20000h ; 判读是否是虚拟 8086 模式</pre></td></tr><tr><td data-num=\"178\"></td><td><pre>.text:0046A88B 02 00</pre></td></tr><tr><td data-num=\"179\"></td><td><pre>.text:0046A893 0F 85 FF 08 00 00                 jnz     loc_46B198      ; 如果是的话，走虚拟 8086 的模式退出</pre></td></tr><tr><td data-num=\"180\"></td><td><pre>.text:0046A899 66 F7 44 24 6C F9+                test    word ptr [esp+_KTRAP_FRAME.SegCs], 0FFF9h</pre></td></tr><tr><td data-num=\"181\"></td><td><pre>.text:0046A899 FF</pre></td></tr><tr><td data-num=\"182\"></td><td><pre>.text:0046A8A0 0F 84 B4 00 00 00                 jz      loc_46A95A</pre></td></tr><tr><td data-num=\"183\"></td><td><pre>.text:0046A8A6 66 83 7C 24 6C 1B                 cmp     word ptr [esp+_KTRAP_FRAME.SegCs], 1Bh</pre></td></tr><tr><td data-num=\"184\"></td><td><pre>.text:0046A8AC 66 0F BA 64 24 6C+                bt      word ptr [esp+_KTRAP_FRAME.SegCs], 0</pre></td></tr><tr><td data-num=\"185\"></td><td><pre>.text:0046A8AC 00</pre></td></tr><tr><td data-num=\"186\"></td><td><pre>.text:0046A8B3 F5                                cmc</pre></td></tr><tr><td data-num=\"187\"></td><td><pre>.text:0046A8B4 0F 87 8E 00 00 00                 ja      loc_46A948</pre></td></tr><tr><td data-num=\"188\"></td><td><pre>.text:0046A8BA 66 83 7D 6C 08                    cmp     word ptr [ebp+_KTRAP_FRAME.SegCs], 8</pre></td></tr><tr><td data-num=\"189\"></td><td><pre>.text:0046A8BF 74 05                             jz      short loc_46A8C6</pre></td></tr><tr><td data-num=\"190\"></td><td><pre>.text:0046A8C1</pre></td></tr><tr><td data-num=\"191\"></td><td><pre>.text:0046A8C1                   loc_46A8C1:                             ; CODE XREF: .text:0046A955↓j</pre></td></tr><tr><td data-num=\"192\"></td><td><pre>.text:0046A8C1 8D 65 50                          lea     esp, [ebp+_KTRAP_FRAME.SegFs]</pre></td></tr><tr><td data-num=\"193\"></td><td><pre>.text:0046A8C4 0F A1                             pop     fs              ; 还原 fs</pre></td></tr><tr><td data-num=\"194\"></td><td><pre>.text:0046A8C6                                   assume fs:nothing</pre></td></tr><tr><td data-num=\"195\"></td><td><pre>.text:0046A8C6</pre></td></tr><tr><td data-num=\"196\"></td><td><pre>.text:0046A8C6                   loc_46A8C6:                             ; CODE XREF: .text:0046A8BF↑j</pre></td></tr><tr><td data-num=\"197\"></td><td><pre>.text:0046A8C6 8D 65 54                          lea     esp, [ebp+_KTRAP_FRAME._Edi]</pre></td></tr><tr><td data-num=\"198\"></td><td><pre>.text:0046A8C9 5F                                pop     edi             ; 还原 edi</pre></td></tr><tr><td data-num=\"199\"></td><td><pre>.text:0046A8CA 5E                                pop     esi</pre></td></tr><tr><td data-num=\"200\"></td><td><pre>.text:0046A8CB 5B                                pop     ebx</pre></td></tr><tr><td data-num=\"201\"></td><td><pre>.text:0046A8CC 5D                                pop     ebp             ; 还原 ebp, 此时 esp 指向 ErrorCode</pre></td></tr><tr><td data-num=\"202\"></td><td><pre>.text:0046A8CD 66 81 7C 24 08 80+                cmp     word ptr [esp+8], 80h ; &#39;€&#39; ; 此时 esp+8 指向的是 SegCs</pre></td></tr><tr><td data-num=\"203\"></td><td><pre>.text:0046A8CD 00</pre></td></tr><tr><td data-num=\"204\"></td><td><pre>.text:0046A8D4 0F 87 DA 08 00 00                 ja      loc_46B1B4</pre></td></tr><tr><td data-num=\"205\"></td><td><pre>.text:0046A8DA 83 C4 04                          add     esp, 4          ; 此时 esp 指向 Eip,Eip 中存储的是 KUSER_SHARED_DATA 中的 SystemCallReturn</pre></td></tr><tr><td data-num=\"206\"></td><td><pre>.text:0046A8DD F7 44 24 04 01 00+                test    dword ptr [esp+4], 1 ; esp+4 指向 SegCs</pre></td></tr><tr><td data-num=\"207\"></td><td><pre>.text:0046A8DD 00 00</pre></td></tr><tr><td data-num=\"208\"></td><td><pre>.text:0046A8E5</pre></td></tr><tr><td data-num=\"209\"></td><td><pre>.text:0046A8E5                   loc_46A8E5:                             ; DATA XREF: KiDisableFastSyscallReturn ()+9↑w</pre></td></tr><tr><td data-num=\"210\"></td><td><pre>.text:0046A8E5                                                           ; KiEnableFastSyscallReturn ():loc_4278B0↑r ...</pre></td></tr><tr><td data-num=\"211\"></td><td><pre>.text:0046A8E5 75 05                             jnz     short locret_46A8EC</pre></td></tr><tr><td data-num=\"212\"></td><td><pre>.text:0046A8E7 5A                                pop     edx             ; edx &#x3D; SystemCallReturn</pre></td></tr><tr><td data-num=\"213\"></td><td><pre>.text:0046A8E8 59                                pop     ecx             ; ecx &#x3D; SegCs</pre></td></tr><tr><td data-num=\"214\"></td><td><pre>.text:0046A8E9 9D                                popf                    ; 还原 flags 寄存器</pre></td></tr><tr><td data-num=\"215\"></td><td><pre>.text:0046A8EA FF E2                             jmp     edx</pre></td></tr></table></figure><p>在 windbg 中对 KiFastCallEntry 下了断点后 一步一步跟了一下：</p>\n<figure class=\"highlight raw\"><figcaption data-lang=\"\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>kd&gt; bp KiFastCallEntry</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>kd&gt; g</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>Breakpoint 0 hit</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>nt!KiFastCallEntry:</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>805426e0 b923000000      mov     ecx,23h</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>kd&gt; p</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>nt!KiFastCallEntry+0x5:</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>805426e5 6a30            push    30h</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>kd&gt; p</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>nt!KiFastCallEntry+0x7:</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>805426e7 0fa1            pop     fs</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>kd&gt; p</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>nt!KiFastCallEntry+0x9:</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>805426e9 8ed9            mov     ds,cx</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>kd&gt; p</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>nt!KiFastCallEntry+0xb:</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>805426eb 8ec1            mov     es,cx</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>kd&gt; p</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>nt!KiFastCallEntry+0xd:</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>805426ed 648b0d40000000  mov     ecx,dword ptr fs:[40h]</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>kd&gt; p</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>nt!KiFastCallEntry+0x14:</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>805426f4 8b6104          mov     esp,dword ptr [ecx+4]</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>kd&gt; p</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>nt!KiFastCallEntry+0x17:</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>805426f7 6a23            push    23h</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>kd&gt; p</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>nt!KiFastCallEntry+0x19:</pre></td></tr><tr><td data-num=\"29\"></td><td><pre>805426f9 52              push    edx</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>kd&gt; p</pre></td></tr><tr><td data-num=\"31\"></td><td><pre>nt!KiFastCallEntry+0x1a:</pre></td></tr><tr><td data-num=\"32\"></td><td><pre>805426fa 9c              pushfd</pre></td></tr><tr><td data-num=\"33\"></td><td><pre>kd&gt; p</pre></td></tr><tr><td data-num=\"34\"></td><td><pre>nt!KiFastCallEntry+0x1b:</pre></td></tr><tr><td data-num=\"35\"></td><td><pre>805426fb 6a02            push    2</pre></td></tr><tr><td data-num=\"36\"></td><td><pre>kd&gt; p</pre></td></tr><tr><td data-num=\"37\"></td><td><pre>nt!KiFastCallEntry+0x1d:</pre></td></tr><tr><td data-num=\"38\"></td><td><pre>805426fd 83c208          add     edx,8</pre></td></tr><tr><td data-num=\"39\"></td><td><pre>kd&gt; p</pre></td></tr><tr><td data-num=\"40\"></td><td><pre>nt!KiFastCallEntry+0x20:</pre></td></tr><tr><td data-num=\"41\"></td><td><pre>80542700 9d              popfd</pre></td></tr><tr><td data-num=\"42\"></td><td><pre>kd&gt; p</pre></td></tr><tr><td data-num=\"43\"></td><td><pre>nt!KiFastCallEntry+0x21:</pre></td></tr><tr><td data-num=\"44\"></td><td><pre>80542701 804c240102      or      byte ptr [esp+1],2</pre></td></tr><tr><td data-num=\"45\"></td><td><pre>kd&gt; p</pre></td></tr><tr><td data-num=\"46\"></td><td><pre>nt!KiFastCallEntry+0x26:</pre></td></tr><tr><td data-num=\"47\"></td><td><pre>80542706 6a1b            push    1Bh</pre></td></tr><tr><td data-num=\"48\"></td><td><pre>kd&gt; p</pre></td></tr><tr><td data-num=\"49\"></td><td><pre>nt!KiFastCallEntry+0x28:</pre></td></tr><tr><td data-num=\"50\"></td><td><pre>80542708 ff350403dfff    push    dword ptr ds:[0FFDF0304h]</pre></td></tr><tr><td data-num=\"51\"></td><td><pre>kd&gt; p</pre></td></tr><tr><td data-num=\"52\"></td><td><pre>nt!KiFastCallEntry+0x2e:</pre></td></tr><tr><td data-num=\"53\"></td><td><pre>8054270e 6a00            push    0</pre></td></tr><tr><td data-num=\"54\"></td><td><pre>kd&gt; p</pre></td></tr><tr><td data-num=\"55\"></td><td><pre>nt!KiFastCallEntry+0x30:</pre></td></tr><tr><td data-num=\"56\"></td><td><pre>80542710 55              push    ebp</pre></td></tr><tr><td data-num=\"57\"></td><td><pre>kd&gt; p</pre></td></tr><tr><td data-num=\"58\"></td><td><pre>nt!KiFastCallEntry+0x31:</pre></td></tr><tr><td data-num=\"59\"></td><td><pre>80542711 53              push    ebx</pre></td></tr><tr><td data-num=\"60\"></td><td><pre>kd&gt; p</pre></td></tr><tr><td data-num=\"61\"></td><td><pre>nt!KiFastCallEntry+0x32:</pre></td></tr><tr><td data-num=\"62\"></td><td><pre>80542712 56              push    esi</pre></td></tr><tr><td data-num=\"63\"></td><td><pre>kd&gt; p</pre></td></tr><tr><td data-num=\"64\"></td><td><pre>nt!KiFastCallEntry+0x33:</pre></td></tr><tr><td data-num=\"65\"></td><td><pre>80542713 57              push    edi</pre></td></tr><tr><td data-num=\"66\"></td><td><pre>kd&gt; p</pre></td></tr><tr><td data-num=\"67\"></td><td><pre>nt!KiFastCallEntry+0x34:</pre></td></tr><tr><td data-num=\"68\"></td><td><pre>80542714 648b1d1c000000  mov     ebx,dword ptr fs:[1Ch]</pre></td></tr><tr><td data-num=\"69\"></td><td><pre>kd&gt; p</pre></td></tr><tr><td data-num=\"70\"></td><td><pre>nt!KiFastCallEntry+0x3b:</pre></td></tr><tr><td data-num=\"71\"></td><td><pre>8054271b 6a3b            push    3Bh</pre></td></tr><tr><td data-num=\"72\"></td><td><pre>kd&gt; p</pre></td></tr><tr><td data-num=\"73\"></td><td><pre>nt!KiFastCallEntry+0x3d:</pre></td></tr><tr><td data-num=\"74\"></td><td><pre>8054271d 8bb324010000    mov     esi,dword ptr [ebx+124h]</pre></td></tr><tr><td data-num=\"75\"></td><td><pre>kd&gt; p</pre></td></tr><tr><td data-num=\"76\"></td><td><pre>nt!KiFastCallEntry+0x43:</pre></td></tr><tr><td data-num=\"77\"></td><td><pre>80542723 ff33            push    dword ptr [ebx]</pre></td></tr><tr><td data-num=\"78\"></td><td><pre>kd&gt; p</pre></td></tr><tr><td data-num=\"79\"></td><td><pre>nt!KiFastCallEntry+0x45:</pre></td></tr><tr><td data-num=\"80\"></td><td><pre>80542725 c703ffffffff    mov     dword ptr [ebx],0FFFFFFFFh</pre></td></tr><tr><td data-num=\"81\"></td><td><pre>kd&gt; p</pre></td></tr><tr><td data-num=\"82\"></td><td><pre>nt!KiFastCallEntry+0x4b:</pre></td></tr><tr><td data-num=\"83\"></td><td><pre>8054272b 8b6e18          mov     ebp,dword ptr [esi+18h]</pre></td></tr><tr><td data-num=\"84\"></td><td><pre>kd&gt; p</pre></td></tr><tr><td data-num=\"85\"></td><td><pre>nt!KiFastCallEntry+0x4e:</pre></td></tr><tr><td data-num=\"86\"></td><td><pre>8054272e 6a01            push    1</pre></td></tr><tr><td data-num=\"87\"></td><td><pre>kd&gt; p</pre></td></tr><tr><td data-num=\"88\"></td><td><pre>nt!KiFastCallEntry+0x50:</pre></td></tr><tr><td data-num=\"89\"></td><td><pre>80542730 83ec48          sub     esp,48h</pre></td></tr><tr><td data-num=\"90\"></td><td><pre>kd&gt; p</pre></td></tr><tr><td data-num=\"91\"></td><td><pre>nt!KiFastCallEntry+0x53:</pre></td></tr><tr><td data-num=\"92\"></td><td><pre>80542733 81ed9c020000    sub     ebp,29Ch</pre></td></tr><tr><td data-num=\"93\"></td><td><pre>kd&gt; p</pre></td></tr><tr><td data-num=\"94\"></td><td><pre>nt!KiFastCallEntry+0x59:</pre></td></tr><tr><td data-num=\"95\"></td><td><pre>80542739 c6864001000001  mov     byte ptr [esi+140h],1</pre></td></tr><tr><td data-num=\"96\"></td><td><pre>kd&gt; r</pre></td></tr><tr><td data-num=\"97\"></td><td><pre>eax&#x3D;00000077 ebx&#x3D;ffdff000 ecx&#x3D;80042000 edx&#x3D;0015f938 esi&#x3D;8a13eda0 edi&#x3D;0015fc70</pre></td></tr><tr><td data-num=\"98\"></td><td><pre>eip&#x3D;80542739 esp&#x3D;b9cc8d64 ebp&#x3D;b9cc8d64 iopl&#x3D;0         nv up di ng nz ac po nc</pre></td></tr><tr><td data-num=\"99\"></td><td><pre>cs&#x3D;0008  ss&#x3D;0010  ds&#x3D;0023  es&#x3D;0023  fs&#x3D;0030  gs&#x3D;0000             efl&#x3D;00000092</pre></td></tr><tr><td data-num=\"100\"></td><td><pre>nt!KiFastCallEntry+0x59:</pre></td></tr><tr><td data-num=\"101\"></td><td><pre>80542739 c6864001000001  mov     byte ptr [esi+140h],1      ds:0023:8a13eee0&#x3D;01</pre></td></tr><tr><td data-num=\"102\"></td><td><pre>kd&gt; dt _KTRAP_FRAME b9cc8d64</pre></td></tr><tr><td data-num=\"103\"></td><td><pre>ntdll!_KTRAP_FRAME</pre></td></tr><tr><td data-num=\"104\"></td><td><pre>   +0x000 DbgEbp           : 0</pre></td></tr><tr><td data-num=\"105\"></td><td><pre>   +0x004 DbgEip           : 0</pre></td></tr><tr><td data-num=\"106\"></td><td><pre>   +0x008 DbgArgMark       : 0x23</pre></td></tr><tr><td data-num=\"107\"></td><td><pre>   +0x00c DbgArgPointer    : 0x23</pre></td></tr><tr><td data-num=\"108\"></td><td><pre>   +0x010 TempSegCs        : 0x15f938</pre></td></tr><tr><td data-num=\"109\"></td><td><pre>   +0x014 TempEsp          : 0x80042000</pre></td></tr><tr><td data-num=\"110\"></td><td><pre>   +0x018 Dr0              : 0x77</pre></td></tr><tr><td data-num=\"111\"></td><td><pre>   +0x01c Dr1              : 0x77</pre></td></tr><tr><td data-num=\"112\"></td><td><pre>   +0x020 Dr2              : 0xffffffff</pre></td></tr><tr><td data-num=\"113\"></td><td><pre>   +0x024 Dr3              : 0x30</pre></td></tr><tr><td data-num=\"114\"></td><td><pre>   +0x028 Dr6              : 0x15fc70</pre></td></tr><tr><td data-num=\"115\"></td><td><pre>   +0x02c Dr7              : 0x8a13eda0</pre></td></tr><tr><td data-num=\"116\"></td><td><pre>   +0x030 SegGs            : 0xffdff000</pre></td></tr><tr><td data-num=\"117\"></td><td><pre>   +0x034 SegEs            : 0xb9cc9000</pre></td></tr><tr><td data-num=\"118\"></td><td><pre>   +0x038 SegDs            : 0</pre></td></tr><tr><td data-num=\"119\"></td><td><pre>   +0x03c Edx              : 0x80542730</pre></td></tr><tr><td data-num=\"120\"></td><td><pre>   +0x040 Ecx              : 8</pre></td></tr><tr><td data-num=\"121\"></td><td><pre>   +0x044 Eax              : 0x102</pre></td></tr><tr><td data-num=\"122\"></td><td><pre>   +0x048 PreviousPreviousMode : 1</pre></td></tr><tr><td data-num=\"123\"></td><td><pre>   +0x04c ExceptionList    : 0xffffffff _EXCEPTION_REGISTRATION_RECORD</pre></td></tr><tr><td data-num=\"124\"></td><td><pre>   +0x050 SegFs            : 0x3b</pre></td></tr><tr><td data-num=\"125\"></td><td><pre>   +0x054 Edi              : 0x15fc70</pre></td></tr><tr><td data-num=\"126\"></td><td><pre>   +0x058 Esi              : 0x1106a0</pre></td></tr><tr><td data-num=\"127\"></td><td><pre>   +0x05c Ebx              : 0</pre></td></tr><tr><td data-num=\"128\"></td><td><pre>   +0x060 Ebp              : 0x15fc40</pre></td></tr><tr><td data-num=\"129\"></td><td><pre>   +0x064 ErrCode          : 0</pre></td></tr><tr><td data-num=\"130\"></td><td><pre>   +0x068 Eip              : 0x7c92e4f4</pre></td></tr><tr><td data-num=\"131\"></td><td><pre>   +0x06c SegCs            : 0x1b</pre></td></tr><tr><td data-num=\"132\"></td><td><pre>   +0x070 EFlags           : 0x246</pre></td></tr><tr><td data-num=\"133\"></td><td><pre>   +0x074 HardwareEsp      : 0x15f930</pre></td></tr><tr><td data-num=\"134\"></td><td><pre>   +0x078 HardwareSegSs    : 0x23</pre></td></tr><tr><td data-num=\"135\"></td><td><pre>   +0x07c V86Es            : 0</pre></td></tr><tr><td data-num=\"136\"></td><td><pre>   +0x080 V86Ds            : 0</pre></td></tr><tr><td data-num=\"137\"></td><td><pre>   +0x084 V86Fs            : 0</pre></td></tr><tr><td data-num=\"138\"></td><td><pre>   +0x088 V86Gs            : 0</pre></td></tr><tr><td data-num=\"139\"></td><td><pre>kd&gt; p</pre></td></tr><tr><td data-num=\"140\"></td><td><pre>nt!KiFastCallEntry+0x60:</pre></td></tr><tr><td data-num=\"141\"></td><td><pre>80542740 3bec            cmp     ebp,esp</pre></td></tr><tr><td data-num=\"142\"></td><td><pre>kd&gt; p</pre></td></tr><tr><td data-num=\"143\"></td><td><pre>nt!KiFastCallEntry+0x62:</pre></td></tr><tr><td data-num=\"144\"></td><td><pre>80542742 758d            jne     nt!KiFastCallEntry2+0x49 (805426d1)</pre></td></tr><tr><td data-num=\"145\"></td><td><pre>kd&gt; p</pre></td></tr><tr><td data-num=\"146\"></td><td><pre>nt!KiFastCallEntry+0x64:</pre></td></tr><tr><td data-num=\"147\"></td><td><pre>80542744 83652c00        and     dword ptr [ebp+2Ch],0</pre></td></tr><tr><td data-num=\"148\"></td><td><pre>kd&gt; p</pre></td></tr><tr><td data-num=\"149\"></td><td><pre>nt!KiFastCallEntry+0x68:</pre></td></tr><tr><td data-num=\"150\"></td><td><pre>80542748 f6462cff        test    byte ptr [esi+2Ch],0FFh</pre></td></tr><tr><td data-num=\"151\"></td><td><pre>kd&gt; p</pre></td></tr><tr><td data-num=\"152\"></td><td><pre>nt!KiFastCallEntry+0x6c:</pre></td></tr><tr><td data-num=\"153\"></td><td><pre>8054274c 89ae34010000    mov     dword ptr [esi+134h],ebp</pre></td></tr><tr><td data-num=\"154\"></td><td><pre>kd&gt; p</pre></td></tr><tr><td data-num=\"155\"></td><td><pre>nt!KiFastCallEntry+0x72:</pre></td></tr><tr><td data-num=\"156\"></td><td><pre>80542752 0f8538feffff    jne     nt!Dr_FastCallDrSave (80542590)</pre></td></tr><tr><td data-num=\"157\"></td><td><pre>kd&gt; p</pre></td></tr><tr><td data-num=\"158\"></td><td><pre>nt!KiFastCallEntry+0x78:</pre></td></tr><tr><td data-num=\"159\"></td><td><pre>80542758 8b5d60          mov     ebx,dword ptr [ebp+60h]</pre></td></tr><tr><td data-num=\"160\"></td><td><pre>kd&gt; p</pre></td></tr><tr><td data-num=\"161\"></td><td><pre>nt!KiFastCallEntry+0x7b:</pre></td></tr><tr><td data-num=\"162\"></td><td><pre>8054275b 8b7d68          mov     edi,dword ptr [ebp+68h]</pre></td></tr><tr><td data-num=\"163\"></td><td><pre>kd&gt; p</pre></td></tr><tr><td data-num=\"164\"></td><td><pre>nt!KiFastCallEntry+0x7e:</pre></td></tr><tr><td data-num=\"165\"></td><td><pre>8054275e 89550c          mov     dword ptr [ebp+0Ch],edx</pre></td></tr><tr><td data-num=\"166\"></td><td><pre>kd&gt; p</pre></td></tr><tr><td data-num=\"167\"></td><td><pre>nt!KiFastCallEntry+0x81:</pre></td></tr><tr><td data-num=\"168\"></td><td><pre>80542761 c74508000ddbba  mov     dword ptr [ebp+8],0BADB0D00h</pre></td></tr><tr><td data-num=\"169\"></td><td><pre>kd&gt; p</pre></td></tr><tr><td data-num=\"170\"></td><td><pre>nt!KiFastCallEntry+0x88:</pre></td></tr><tr><td data-num=\"171\"></td><td><pre>80542768 895d00          mov     dword ptr [ebp],ebx</pre></td></tr><tr><td data-num=\"172\"></td><td><pre>kd&gt; p</pre></td></tr><tr><td data-num=\"173\"></td><td><pre>nt!KiFastCallEntry+0x8b:</pre></td></tr><tr><td data-num=\"174\"></td><td><pre>8054276b 897d04          mov     dword ptr [ebp+4],edi</pre></td></tr><tr><td data-num=\"175\"></td><td><pre>kd&gt; p</pre></td></tr><tr><td data-num=\"176\"></td><td><pre>nt!KiFastCallEntry+0x8e:</pre></td></tr><tr><td data-num=\"177\"></td><td><pre>8054276e fb              sti</pre></td></tr><tr><td data-num=\"178\"></td><td><pre>kd&gt; p</pre></td></tr><tr><td data-num=\"179\"></td><td><pre>nt!KiFastCallEntry+0x8f:</pre></td></tr><tr><td data-num=\"180\"></td><td><pre>8054276f 8bf8            mov     edi,eax</pre></td></tr><tr><td data-num=\"181\"></td><td><pre>kd&gt; p</pre></td></tr><tr><td data-num=\"182\"></td><td><pre>nt!KiFastCallEntry+0x91:</pre></td></tr><tr><td data-num=\"183\"></td><td><pre>80542771 c1ef08          shr     edi,8</pre></td></tr><tr><td data-num=\"184\"></td><td><pre>kd&gt; p</pre></td></tr><tr><td data-num=\"185\"></td><td><pre>nt!KiFastCallEntry+0x94:</pre></td></tr><tr><td data-num=\"186\"></td><td><pre>80542774 83e730          and     edi,30h</pre></td></tr><tr><td data-num=\"187\"></td><td><pre>kd&gt; p</pre></td></tr><tr><td data-num=\"188\"></td><td><pre>nt!KiFastCallEntry+0x97:</pre></td></tr><tr><td data-num=\"189\"></td><td><pre>80542777 8bcf            mov     ecx,edi</pre></td></tr><tr><td data-num=\"190\"></td><td><pre>kd&gt; p</pre></td></tr><tr><td data-num=\"191\"></td><td><pre>nt!KiFastCallEntry+0x99:</pre></td></tr><tr><td data-num=\"192\"></td><td><pre>80542779 03bee0000000    add     edi,dword ptr [esi+0E0h]</pre></td></tr><tr><td data-num=\"193\"></td><td><pre>kd&gt; p</pre></td></tr><tr><td data-num=\"194\"></td><td><pre>nt!KiFastCallEntry+0x9f:</pre></td></tr><tr><td data-num=\"195\"></td><td><pre>8054277f 8bd8            mov     ebx,eax</pre></td></tr><tr><td data-num=\"196\"></td><td><pre>kd&gt; p</pre></td></tr><tr><td data-num=\"197\"></td><td><pre>nt!KiFastCallEntry+0xa1:</pre></td></tr><tr><td data-num=\"198\"></td><td><pre>80542781 25ff0f0000      and     eax,0FFFh</pre></td></tr><tr><td data-num=\"199\"></td><td><pre>kd&gt; p</pre></td></tr><tr><td data-num=\"200\"></td><td><pre>nt!KiFastCallEntry+0xa6:</pre></td></tr><tr><td data-num=\"201\"></td><td><pre>80542786 3b4708          cmp     eax,dword ptr [edi+8]</pre></td></tr><tr><td data-num=\"202\"></td><td><pre>kd&gt; p</pre></td></tr><tr><td data-num=\"203\"></td><td><pre>nt!KiFastCallEntry+0xa9:</pre></td></tr><tr><td data-num=\"204\"></td><td><pre>80542789 0f8333fdffff    jae     nt!KiBBTUnexpectedRange (805424c2)</pre></td></tr><tr><td data-num=\"205\"></td><td><pre>kd&gt; p</pre></td></tr><tr><td data-num=\"206\"></td><td><pre>nt!KiFastCallEntry+0xaf:</pre></td></tr><tr><td data-num=\"207\"></td><td><pre>8054278f 83f910          cmp     ecx,10h</pre></td></tr><tr><td data-num=\"208\"></td><td><pre>kd&gt; p</pre></td></tr><tr><td data-num=\"209\"></td><td><pre>nt!KiFastCallEntry+0xb2:</pre></td></tr><tr><td data-num=\"210\"></td><td><pre>80542792 751b            jne     nt!KiSystemServiceAccessTeb+0x12 (805427af)</pre></td></tr><tr><td data-num=\"211\"></td><td><pre>kd&gt; p</pre></td></tr><tr><td data-num=\"212\"></td><td><pre>nt!KiSystemServiceAccessTeb+0x12:</pre></td></tr><tr><td data-num=\"213\"></td><td><pre>805427af 64ff0538060000  inc     dword ptr fs:[638h]</pre></td></tr><tr><td data-num=\"214\"></td><td><pre>kd&gt; p</pre></td></tr><tr><td data-num=\"215\"></td><td><pre>nt!KiSystemServiceAccessTeb+0x19:</pre></td></tr><tr><td data-num=\"216\"></td><td><pre>805427b6 8bf2            mov     esi,edx</pre></td></tr><tr><td data-num=\"217\"></td><td><pre>kd&gt; p</pre></td></tr><tr><td data-num=\"218\"></td><td><pre>nt!KiSystemServiceAccessTeb+0x1b:</pre></td></tr><tr><td data-num=\"219\"></td><td><pre>805427b8 8b5f0c          mov     ebx,dword ptr [edi+0Ch]</pre></td></tr><tr><td data-num=\"220\"></td><td><pre>kd&gt; p</pre></td></tr><tr><td data-num=\"221\"></td><td><pre>nt!KiSystemServiceAccessTeb+0x1e:</pre></td></tr><tr><td data-num=\"222\"></td><td><pre>805427bb 33c9            xor     ecx,ecx</pre></td></tr><tr><td data-num=\"223\"></td><td><pre>kd&gt; p</pre></td></tr><tr><td data-num=\"224\"></td><td><pre>nt!KiSystemServiceAccessTeb+0x20:</pre></td></tr><tr><td data-num=\"225\"></td><td><pre>805427bd 8a0c18          mov     cl,byte ptr [eax+ebx]</pre></td></tr><tr><td data-num=\"226\"></td><td><pre>kd&gt; p</pre></td></tr><tr><td data-num=\"227\"></td><td><pre>nt!KiSystemServiceAccessTeb+0x23:</pre></td></tr><tr><td data-num=\"228\"></td><td><pre>805427c0 8b3f            mov     edi,dword ptr [edi]</pre></td></tr><tr><td data-num=\"229\"></td><td><pre>kd&gt; p</pre></td></tr><tr><td data-num=\"230\"></td><td><pre>nt!KiSystemServiceAccessTeb+0x25:</pre></td></tr><tr><td data-num=\"231\"></td><td><pre>805427c2 8b1c87          mov     ebx,dword ptr [edi+eax*4]</pre></td></tr><tr><td data-num=\"232\"></td><td><pre>kd&gt; p</pre></td></tr><tr><td data-num=\"233\"></td><td><pre>nt!KiSystemServiceAccessTeb+0x28:</pre></td></tr><tr><td data-num=\"234\"></td><td><pre>805427c5 2be1            sub     esp,ecx</pre></td></tr><tr><td data-num=\"235\"></td><td><pre>kd&gt; p</pre></td></tr><tr><td data-num=\"236\"></td><td><pre>nt!KiSystemServiceAccessTeb+0x2a:</pre></td></tr><tr><td data-num=\"237\"></td><td><pre>805427c7 c1e902          shr     ecx,2</pre></td></tr><tr><td data-num=\"238\"></td><td><pre>kd&gt; p</pre></td></tr><tr><td data-num=\"239\"></td><td><pre>nt!KiSystemServiceAccessTeb+0x2d:</pre></td></tr><tr><td data-num=\"240\"></td><td><pre>805427ca 8bfc            mov     edi,esp</pre></td></tr><tr><td data-num=\"241\"></td><td><pre>kd&gt; p</pre></td></tr><tr><td data-num=\"242\"></td><td><pre>nt!KiSystemServiceAccessTeb+0x2f:</pre></td></tr><tr><td data-num=\"243\"></td><td><pre>805427cc f6457202        test    byte ptr [ebp+72h],2</pre></td></tr><tr><td data-num=\"244\"></td><td><pre>kd&gt; p</pre></td></tr><tr><td data-num=\"245\"></td><td><pre>nt!KiSystemServiceAccessTeb+0x33:</pre></td></tr><tr><td data-num=\"246\"></td><td><pre>805427d0 7506            jne     nt!KiSystemServiceAccessTeb+0x3b (805427d8)</pre></td></tr><tr><td data-num=\"247\"></td><td><pre>kd&gt; p</pre></td></tr><tr><td data-num=\"248\"></td><td><pre>nt!KiSystemServiceAccessTeb+0x35:</pre></td></tr><tr><td data-num=\"249\"></td><td><pre>805427d2 f6456c01        test    byte ptr [ebp+6Ch],1</pre></td></tr><tr><td data-num=\"250\"></td><td><pre>kd&gt; p</pre></td></tr><tr><td data-num=\"251\"></td><td><pre>nt!KiSystemServiceAccessTeb+0x39:</pre></td></tr><tr><td data-num=\"252\"></td><td><pre>805427d6 740c            je      nt!KiSystemServiceCopyArguments (805427e4)</pre></td></tr><tr><td data-num=\"253\"></td><td><pre>kd&gt; p</pre></td></tr><tr><td data-num=\"254\"></td><td><pre>nt!KiSystemServiceAccessTeb+0x3b:</pre></td></tr><tr><td data-num=\"255\"></td><td><pre>805427d8 3b3534315680    cmp     esi,dword ptr [nt!MmUserProbeAddress (80563134)]</pre></td></tr><tr><td data-num=\"256\"></td><td><pre>kd&gt; p</pre></td></tr><tr><td data-num=\"257\"></td><td><pre>nt!KiSystemServiceAccessTeb+0x41:</pre></td></tr><tr><td data-num=\"258\"></td><td><pre>805427de 0f83a8010000    jae     nt!KiSystemCallExit2+0x9f (8054298c)</pre></td></tr><tr><td data-num=\"259\"></td><td><pre>kd&gt; p</pre></td></tr><tr><td data-num=\"260\"></td><td><pre>nt!KiSystemServiceCopyArguments:</pre></td></tr><tr><td data-num=\"261\"></td><td><pre>805427e4 f3a5            rep movs dword ptr es:[edi],dword ptr [esi]</pre></td></tr><tr><td data-num=\"262\"></td><td><pre>kd&gt; p</pre></td></tr><tr><td data-num=\"263\"></td><td><pre>nt!KiSystemServiceCopyArguments+0x2:</pre></td></tr><tr><td data-num=\"264\"></td><td><pre>805427e6 ffd3            call    ebx</pre></td></tr><tr><td data-num=\"265\"></td><td><pre>kd&gt; p</pre></td></tr><tr><td data-num=\"266\"></td><td><pre>nt!KiSystemServicePostCall:</pre></td></tr><tr><td data-num=\"267\"></td><td><pre>805427e8 8be5            mov     esp,ebp</pre></td></tr><tr><td data-num=\"268\"></td><td><pre>kd&gt; p</pre></td></tr><tr><td data-num=\"269\"></td><td><pre>nt!KiSystemServicePostCall+0x2:</pre></td></tr><tr><td data-num=\"270\"></td><td><pre>805427ea 648b0d24010000  mov     ecx,dword ptr fs:[124h]</pre></td></tr><tr><td data-num=\"271\"></td><td><pre>kd&gt; p</pre></td></tr><tr><td data-num=\"272\"></td><td><pre>nt!KiSystemServicePostCall+0x9:</pre></td></tr><tr><td data-num=\"273\"></td><td><pre>805427f1 8b553c          mov     edx,dword ptr [ebp+3Ch]</pre></td></tr><tr><td data-num=\"274\"></td><td><pre>kd&gt; p</pre></td></tr><tr><td data-num=\"275\"></td><td><pre>nt!KiSystemServicePostCall+0xc:</pre></td></tr><tr><td data-num=\"276\"></td><td><pre>805427f4 899134010000    mov     dword ptr [ecx+134h],edx</pre></td></tr><tr><td data-num=\"277\"></td><td><pre>kd&gt; p</pre></td></tr><tr><td data-num=\"278\"></td><td><pre>nt!KiServiceExit:</pre></td></tr><tr><td data-num=\"279\"></td><td><pre>805427fa fa              cli</pre></td></tr><tr><td data-num=\"280\"></td><td><pre>kd&gt; p</pre></td></tr><tr><td data-num=\"281\"></td><td><pre>nt!KiServiceExit+0x1:</pre></td></tr><tr><td data-num=\"282\"></td><td><pre>805427fb f7457000000200  test    dword ptr [ebp+70h],20000h</pre></td></tr><tr><td data-num=\"283\"></td><td><pre>kd&gt; p</pre></td></tr><tr><td data-num=\"284\"></td><td><pre>nt!KiServiceExit+0x8:</pre></td></tr><tr><td data-num=\"285\"></td><td><pre>80542802 7506            jne     nt!KiServiceExit+0x10 (8054280a)</pre></td></tr><tr><td data-num=\"286\"></td><td><pre>kd&gt; p</pre></td></tr><tr><td data-num=\"287\"></td><td><pre>nt!KiServiceExit+0xa:</pre></td></tr><tr><td data-num=\"288\"></td><td><pre>80542804 f6456c01        test    byte ptr [ebp+6Ch],1</pre></td></tr><tr><td data-num=\"289\"></td><td><pre>kd&gt; p</pre></td></tr><tr><td data-num=\"290\"></td><td><pre>nt!KiServiceExit+0xe:</pre></td></tr><tr><td data-num=\"291\"></td><td><pre>80542808 7456            je      nt!KiServiceExit+0x66 (80542860)</pre></td></tr><tr><td data-num=\"292\"></td><td><pre>kd&gt; p</pre></td></tr><tr><td data-num=\"293\"></td><td><pre>nt!KiServiceExit+0x66:</pre></td></tr><tr><td data-num=\"294\"></td><td><pre>80542860 8b54244c        mov     edx,dword ptr [esp+4Ch]</pre></td></tr><tr><td data-num=\"295\"></td><td><pre>kd&gt; p</pre></td></tr><tr><td data-num=\"296\"></td><td><pre>nt!KiServiceExit+0x6a:</pre></td></tr><tr><td data-num=\"297\"></td><td><pre>80542864 648b1d50000000  mov     ebx,dword ptr fs:[50h]</pre></td></tr><tr><td data-num=\"298\"></td><td><pre>kd&gt; p</pre></td></tr><tr><td data-num=\"299\"></td><td><pre>nt!KiServiceExit+0x71:</pre></td></tr><tr><td data-num=\"300\"></td><td><pre>8054286b 64891500000000  mov     dword ptr fs:[0],edx</pre></td></tr><tr><td data-num=\"301\"></td><td><pre>kd&gt; p</pre></td></tr><tr><td data-num=\"302\"></td><td><pre>nt!KiServiceExit+0x78:</pre></td></tr><tr><td data-num=\"303\"></td><td><pre>80542872 8b4c2448        mov     ecx,dword ptr [esp+48h]</pre></td></tr><tr><td data-num=\"304\"></td><td><pre>kd&gt; p</pre></td></tr><tr><td data-num=\"305\"></td><td><pre>nt!KiServiceExit+0x7c:</pre></td></tr><tr><td data-num=\"306\"></td><td><pre>80542876 648b3524010000  mov     esi,dword ptr fs:[124h]</pre></td></tr><tr><td data-num=\"307\"></td><td><pre>kd&gt; p</pre></td></tr><tr><td data-num=\"308\"></td><td><pre>nt!KiServiceExit+0x83:</pre></td></tr><tr><td data-num=\"309\"></td><td><pre>8054287d 888e40010000    mov     byte ptr [esi+140h],cl</pre></td></tr><tr><td data-num=\"310\"></td><td><pre>kd&gt; p</pre></td></tr><tr><td data-num=\"311\"></td><td><pre>nt!KiServiceExit+0x89:</pre></td></tr><tr><td data-num=\"312\"></td><td><pre>80542883 f7c3ff000000    test    ebx,0FFh</pre></td></tr><tr><td data-num=\"313\"></td><td><pre>kd&gt; p</pre></td></tr><tr><td data-num=\"314\"></td><td><pre>nt!KiServiceExit+0x8f:</pre></td></tr><tr><td data-num=\"315\"></td><td><pre>80542889 7579            jne     nt!KiSystemCallExit2+0x17 (80542904)</pre></td></tr><tr><td data-num=\"316\"></td><td><pre>kd&gt; p</pre></td></tr><tr><td data-num=\"317\"></td><td><pre>nt!KiServiceExit+0x91:</pre></td></tr><tr><td data-num=\"318\"></td><td><pre>8054288b f744247000000200 test    dword ptr [esp+70h],20000h</pre></td></tr><tr><td data-num=\"319\"></td><td><pre>kd&gt; p</pre></td></tr><tr><td data-num=\"320\"></td><td><pre>nt!KiServiceExit+0x99:</pre></td></tr><tr><td data-num=\"321\"></td><td><pre>80542893 0f85ff080000    jne     nt!KiExceptionExit+0x12c (80543198)</pre></td></tr><tr><td data-num=\"322\"></td><td><pre>kd&gt; p</pre></td></tr><tr><td data-num=\"323\"></td><td><pre>nt!KiServiceExit+0x9f:</pre></td></tr><tr><td data-num=\"324\"></td><td><pre>80542899 66f744246cf9ff  test    word ptr [esp+6Ch],0FFF9h</pre></td></tr><tr><td data-num=\"325\"></td><td><pre>kd&gt; p</pre></td></tr><tr><td data-num=\"326\"></td><td><pre>nt!KiServiceExit+0xa6:</pre></td></tr><tr><td data-num=\"327\"></td><td><pre>805428a0 0f84b4000000    je      nt!KiSystemCallExit2+0x6d (8054295a)</pre></td></tr><tr><td data-num=\"328\"></td><td><pre>kd&gt; p</pre></td></tr><tr><td data-num=\"329\"></td><td><pre>nt!KiServiceExit+0xac:</pre></td></tr><tr><td data-num=\"330\"></td><td><pre>805428a6 66837c246c1b    cmp     word ptr [esp+6Ch],1Bh</pre></td></tr><tr><td data-num=\"331\"></td><td><pre>kd&gt; p</pre></td></tr><tr><td data-num=\"332\"></td><td><pre>nt!KiServiceExit+0xb2:</pre></td></tr><tr><td data-num=\"333\"></td><td><pre>805428ac 660fba64246c00  bt      word ptr [esp+6Ch],0</pre></td></tr><tr><td data-num=\"334\"></td><td><pre>kd&gt; p</pre></td></tr><tr><td data-num=\"335\"></td><td><pre>nt!KiServiceExit+0xb9:</pre></td></tr><tr><td data-num=\"336\"></td><td><pre>805428b3 f5              cmc</pre></td></tr><tr><td data-num=\"337\"></td><td><pre>kd&gt; p</pre></td></tr><tr><td data-num=\"338\"></td><td><pre>nt!KiServiceExit+0xba:</pre></td></tr><tr><td data-num=\"339\"></td><td><pre>805428b4 0f878e000000    ja      nt!KiSystemCallExit2+0x5b (80542948)</pre></td></tr><tr><td data-num=\"340\"></td><td><pre>kd&gt; p</pre></td></tr><tr><td data-num=\"341\"></td><td><pre>nt!KiServiceExit+0xc0:</pre></td></tr><tr><td data-num=\"342\"></td><td><pre>805428ba 66837d6c08      cmp     word ptr [ebp+6Ch],8</pre></td></tr><tr><td data-num=\"343\"></td><td><pre>kd&gt; p</pre></td></tr><tr><td data-num=\"344\"></td><td><pre>nt!KiServiceExit+0xc5:</pre></td></tr><tr><td data-num=\"345\"></td><td><pre>805428bf 7405            je      nt!KiServiceExit+0xcc (805428c6)</pre></td></tr><tr><td data-num=\"346\"></td><td><pre>kd&gt; p</pre></td></tr><tr><td data-num=\"347\"></td><td><pre>nt!KiServiceExit+0xcc:</pre></td></tr><tr><td data-num=\"348\"></td><td><pre>805428c6 8d6554          lea     esp,[ebp+54h]</pre></td></tr><tr><td data-num=\"349\"></td><td><pre>kd&gt; p</pre></td></tr><tr><td data-num=\"350\"></td><td><pre>nt!KiServiceExit+0xcf:</pre></td></tr><tr><td data-num=\"351\"></td><td><pre>805428c9 5f              pop     edi</pre></td></tr><tr><td data-num=\"352\"></td><td><pre>kd&gt; p</pre></td></tr><tr><td data-num=\"353\"></td><td><pre>nt!KiServiceExit+0xd0:</pre></td></tr><tr><td data-num=\"354\"></td><td><pre>805428ca 5e              pop     esi</pre></td></tr><tr><td data-num=\"355\"></td><td><pre>kd&gt; p</pre></td></tr><tr><td data-num=\"356\"></td><td><pre>nt!KiServiceExit+0xd1:</pre></td></tr><tr><td data-num=\"357\"></td><td><pre>805428cb 5b              pop     ebx</pre></td></tr><tr><td data-num=\"358\"></td><td><pre>kd&gt; p</pre></td></tr><tr><td data-num=\"359\"></td><td><pre>nt!KiServiceExit+0xd2:</pre></td></tr><tr><td data-num=\"360\"></td><td><pre>805428cc 5d              pop     ebp</pre></td></tr><tr><td data-num=\"361\"></td><td><pre>kd&gt; p</pre></td></tr><tr><td data-num=\"362\"></td><td><pre>nt!KiServiceExit+0xd3:</pre></td></tr><tr><td data-num=\"363\"></td><td><pre>805428cd 66817c24088000  cmp     word ptr [esp+8],80h</pre></td></tr><tr><td data-num=\"364\"></td><td><pre>kd&gt; p</pre></td></tr><tr><td data-num=\"365\"></td><td><pre>nt!KiServiceExit+0xda:</pre></td></tr><tr><td data-num=\"366\"></td><td><pre>805428d4 0f87da080000    ja      nt!KiExceptionExit+0x148 (805431b4)</pre></td></tr><tr><td data-num=\"367\"></td><td><pre>kd&gt; p</pre></td></tr><tr><td data-num=\"368\"></td><td><pre>nt!KiServiceExit+0xe0:</pre></td></tr><tr><td data-num=\"369\"></td><td><pre>805428da 83c404          add     esp,4</pre></td></tr><tr><td data-num=\"370\"></td><td><pre>kd&gt; p</pre></td></tr><tr><td data-num=\"371\"></td><td><pre>nt!KiServiceExit+0xe3:</pre></td></tr><tr><td data-num=\"372\"></td><td><pre>805428dd f744240401000000 test    dword ptr [esp+4],1</pre></td></tr><tr><td data-num=\"373\"></td><td><pre>kd&gt; p</pre></td></tr><tr><td data-num=\"374\"></td><td><pre>nt!KiSystemCallExitBranch:</pre></td></tr><tr><td data-num=\"375\"></td><td><pre>805428e5 7506            jne     nt!KiSystemCallExit2 (805428ed)</pre></td></tr><tr><td data-num=\"376\"></td><td><pre>kd&gt; p</pre></td></tr><tr><td data-num=\"377\"></td><td><pre>nt!KiSystemCallExitBranch+0x2:</pre></td></tr><tr><td data-num=\"378\"></td><td><pre>805428e7 5a              pop     edx</pre></td></tr><tr><td data-num=\"379\"></td><td><pre>kd&gt; p</pre></td></tr><tr><td data-num=\"380\"></td><td><pre>nt!KiSystemCallExitBranch+0x3:</pre></td></tr><tr><td data-num=\"381\"></td><td><pre>805428e8 59              pop     ecx</pre></td></tr><tr><td data-num=\"382\"></td><td><pre>kd&gt; p</pre></td></tr><tr><td data-num=\"383\"></td><td><pre>nt!KiSystemCallExitBranch+0x4:</pre></td></tr><tr><td data-num=\"384\"></td><td><pre>805428e9 9d              popfd</pre></td></tr><tr><td data-num=\"385\"></td><td><pre>kd&gt; p</pre></td></tr><tr><td data-num=\"386\"></td><td><pre>nt!KiSystemCallExitBranch+0x5:</pre></td></tr><tr><td data-num=\"387\"></td><td><pre>805428ea ffe2            jmp     edx</pre></td></tr><tr><td data-num=\"388\"></td><td><pre>kd&gt; r</pre></td></tr><tr><td data-num=\"389\"></td><td><pre>eax&#x3D;c0000034 ebx&#x3D;00000000 ecx&#x3D;00000008 edx&#x3D;80501681 esi&#x3D;000003e8 edi&#x3D;00000001</pre></td></tr><tr><td data-num=\"390\"></td><td><pre>eip&#x3D;805428ea esp&#x3D;ba4ffd10 ebp&#x3D;ba4ffd68 iopl&#x3D;0         nv up ei pl zr na pe nc</pre></td></tr><tr><td data-num=\"391\"></td><td><pre>cs&#x3D;0008  ss&#x3D;0010  ds&#x3D;0023  es&#x3D;0023  fs&#x3D;0030  gs&#x3D;0000             efl&#x3D;00000246</pre></td></tr><tr><td data-num=\"392\"></td><td><pre>nt!KiSystemCallExitBranch+0x5:</pre></td></tr><tr><td data-num=\"393\"></td><td><pre>805428ea ffe2            jmp     edx &#123;nt!ZwOpenEvent+0x11 (80501681)&#125;</pre></td></tr><tr><td data-num=\"394\"></td><td><pre>kd&gt; t</pre></td></tr><tr><td data-num=\"395\"></td><td><pre>nt!ZwOpenEvent+0x11:</pre></td></tr><tr><td data-num=\"396\"></td><td><pre>80501681 c20c00          ret     0Ch</pre></td></tr><tr><td data-num=\"397\"></td><td><pre>kd&gt; p</pre></td></tr><tr><td data-num=\"398\"></td><td><pre>MountMgr!WorkerThread+0x79:</pre></td></tr><tr><td data-num=\"399\"></td><td><pre>ba0b83c3 85c0            test    eax,eax</pre></td></tr><tr><td data-num=\"400\"></td><td><pre>kd&gt; p</pre></td></tr><tr><td data-num=\"401\"></td><td><pre>MountMgr!WorkerThread+0x7b:</pre></td></tr><tr><td data-num=\"402\"></td><td><pre>ba0b83c5 7d16            jge     MountMgr!WorkerThread+0x93 (ba0b83dd)</pre></td></tr><tr><td data-num=\"403\"></td><td><pre>kd&gt; p</pre></td></tr><tr><td data-num=\"404\"></td><td><pre>MountMgr!WorkerThread+0x7d:</pre></td></tr><tr><td data-num=\"405\"></td><td><pre>ba0b83c7 8d45f4          lea     eax,[ebp-0Ch]</pre></td></tr><tr><td data-num=\"406\"></td><td><pre>kd&gt; p</pre></td></tr><tr><td data-num=\"407\"></td><td><pre>MountMgr!WorkerThread+0x80:</pre></td></tr><tr><td data-num=\"408\"></td><td><pre>ba0b83ca 50              push    eax</pre></td></tr><tr><td data-num=\"409\"></td><td><pre>kd&gt; p</pre></td></tr><tr><td data-num=\"410\"></td><td><pre>MountMgr!WorkerThread+0x81:</pre></td></tr><tr><td data-num=\"411\"></td><td><pre>ba0b83cb 53              push    ebx</pre></td></tr><tr><td data-num=\"412\"></td><td><pre>kd&gt; p</pre></td></tr><tr><td data-num=\"413\"></td><td><pre>MountMgr!WorkerThread+0x82:</pre></td></tr><tr><td data-num=\"414\"></td><td><pre>ba0b83cc 53              push    ebx</pre></td></tr><tr><td data-num=\"415\"></td><td><pre>kd&gt; p</pre></td></tr><tr><td data-num=\"416\"></td><td><pre>MountMgr!WorkerThread+0x83:</pre></td></tr><tr><td data-num=\"417\"></td><td><pre>ba0b83cd 53              push    ebx</pre></td></tr><tr><td data-num=\"418\"></td><td><pre>kd&gt; p</pre></td></tr><tr><td data-num=\"419\"></td><td><pre>MountMgr!WorkerThread+0x84:</pre></td></tr><tr><td data-num=\"420\"></td><td><pre>ba0b83ce 8d45dc          lea     eax,[ebp-24h]</pre></td></tr><tr><td data-num=\"421\"></td><td><pre>kd&gt; p</pre></td></tr><tr><td data-num=\"422\"></td><td><pre>MountMgr!WorkerThread+0x87:</pre></td></tr><tr><td data-num=\"423\"></td><td><pre>ba0b83d1 50              push    eax</pre></td></tr><tr><td data-num=\"424\"></td><td><pre>kd&gt; p</pre></td></tr><tr><td data-num=\"425\"></td><td><pre>MountMgr!WorkerThread+0x88:</pre></td></tr><tr><td data-num=\"426\"></td><td><pre>ba0b83d2 ff15a0880bba    call    dword ptr [MountMgr!_imp__KeWaitForSingleObject (ba0b88a0)]</pre></td></tr><tr><td data-num=\"427\"></td><td><pre>kd&gt; p</pre></td></tr><tr><td data-num=\"428\"></td><td><pre>Breakpoint 0 hit</pre></td></tr><tr><td data-num=\"429\"></td><td><pre>nt!KiFastCallEntry:</pre></td></tr><tr><td data-num=\"430\"></td><td><pre>805426e0 b923000000      mov     ecx,23h</pre></td></tr><tr><td data-num=\"431\"></td><td><pre>kd&gt; p</pre></td></tr><tr><td data-num=\"432\"></td><td><pre>nt!KiFastCallEntry+0x5:</pre></td></tr><tr><td data-num=\"433\"></td><td><pre>805426e5 6a30            push    30h</pre></td></tr></table></figure><p>想知道它是怎么返回三环的，海哥说需要学习 APC 之后的内容了。jmp edx 后面的就不懂了。</p>\n<h2 id=\"分析-kisystemservice\"><a class=\"anchor\" href=\"#分析-kisystemservice\">#</a> 分析 KiSystemService</h2>\n<figure class=\"highlight raw\"><figcaption data-lang=\"\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>.text:0046A611 _KiSystemService proc near              ; CODE XREF: ZwAcceptConnectPort (x,x,x,x,x,x)+C↑p</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>.text:0046A611                                         ; ZwAccessCheck (x,x,x,x,x,x,x,x)+C↑p ...</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>.text:0046A611</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>.text:0046A611 arg_0           &#x3D; dword ptr  4</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>.text:0046A611</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>.text:0046A611                 push    0               ; 保存系统空间的寄存器到_KTRAP_FRAME +0x064 ErrorCode</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>.text:0046A613                 push    ebp             ; 保存系统空间的寄存器到 +0x060 Ebp</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>.text:0046A614                 push    ebx             ; 保存系统空间的寄存器到 +0x05c Ebx</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>.text:0046A615                 push    esi             ; 保存系统空间的寄存器到 +0x058 Esi</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>.text:0046A616                 push    edi             ; 保存系统空间的寄存器到 +0x054 Edi</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>.text:0046A617                 push    fs              ; 保存系统空间的寄存器到 +0x050 SegFs</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>.text:0046A619                 mov     ebx, 30h ; &#39;0&#39;  ; 永远都用这个值吗？如果是多核也不变吗？</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>.text:0046A61E                 mov     fs, bx          ; Windows 内核有个特殊的基本要求，就是只要 CPU 在内核中运行，就得使</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>.text:0046A61E                                         ; mov ebx,30 &#x2F;&#x2F;0011 0000  所以就是 0 环 GDT 索引 6</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>.text:0046A61E                                         ;</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>.text:0046A61E                                         ; 0 环的 FS.Base 指向 CPU 自己的 KPCR，不是指向当前线程</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>.text:0046A61E                                         ; 选择码，0x30 的结构分析如下：</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>.text:0046A61E                                         ; 1.bit0~bit1:RPL, 要求运行的级别，这里是 0</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>.text:0046A61E                                         ; 2.bit2：找 GDT 还是 IDT，这里是 0，GDT</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>.text:0046A61E                                         ; 3.bit3！bit15，是在 GDT 或者 IDT 的下标</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>.text:0046A61E                                         ; windbg 查看段描述符：834093f2 dc003748</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>.text:0046A61E                                         ; Base:83f2dc00 指向当前的_KPCR</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>.text:0046A621                 assume fs:nothing</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>.text:0046A621                 push    large dword ptr fs:_KPCR ; 保存老的 ExceptionList</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>.text:0046A621                                         ; _KPCR 偏移 + 0x00-&gt;NT_TIB-&gt;ExceptionList</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>.text:0046A628                 mov     large dword ptr fs:0, 0FFFFFFFFh ; 设置新的 ExceptonList 为 - 1，因为 3 环的异常链表，不能用，要进 0 环了</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>.text:0046A633                 mov     esi, large fs:_KPCR.PrcbData.CurrentThread ; esi &#x3D;  当前 CPU 所执行线程的_ETHREAD</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>.text:0046A63A                 push    dword ptr [esi+_ETHREAD.Tcb.PreviousMode] ; 因为 Esi 存的_KTHREAD, 偏移 0x140 存的 PreviousMode,</pre></td></tr><tr><td data-num=\"29\"></td><td><pre>.text:0046A63A                                         ; 就是保存老的先前模式到堆栈</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>.text:0046A63A                                         ; 先前模式就是当调用这些代码时候，原来是几环的数就是几，比如原来 0 环，先前模式就是 0，原来 3 环就是 1</pre></td></tr><tr><td data-num=\"31\"></td><td><pre>.text:0046A63A                                         ; 因为有些内核代码可以从 0 和 3 调用，但是执行内容不一样，通过这个知道执行什么。</pre></td></tr><tr><td data-num=\"32\"></td><td><pre>.text:0046A640                 sub     esp, 48h        ; ESP 提升到_KTRAP_FRAME 结构体第一个成员，也就是这个结构体指针</pre></td></tr><tr><td data-num=\"33\"></td><td><pre>.text:0046A643                 mov     ebx, [esp+_KTRAP_FRAME.SegCs] ; 取出 3 环压入的参数 CS _KTRAP_FRAME + 0x6C</pre></td></tr><tr><td data-num=\"34\"></td><td><pre>.text:0046A647                 and     ebx, 1          ; 0 环的最低位为 0,3 环的最低位为 1</pre></td></tr><tr><td data-num=\"35\"></td><td><pre>.text:0046A64A                 mov     [esi+_ETHREAD.Tcb.PreviousMode], bl ; 保存老的 “先前模式” 到堆栈</pre></td></tr><tr><td data-num=\"36\"></td><td><pre>.text:0046A650                 mov     ebp, esp        ; ESP &#x3D; EBP _KTRAP_FRAME 结构指针</pre></td></tr><tr><td data-num=\"37\"></td><td><pre>.text:0046A652                 mov     ebx, [esi+_ETHREAD.Tcb.TrapFrame] ; _KTHTEAD 中的 TrapFrame 给 ebx</pre></td></tr><tr><td data-num=\"38\"></td><td><pre>.text:0046A658                 mov     [ebp+_KTRAP_FRAME._Edx], ebx ; 将_KTHREAD 中的 Trap_Frame 暂时存在这个位置后面会将这个值取出来，</pre></td></tr><tr><td data-num=\"39\"></td><td><pre>.text:0046A658                                         ; 重新恢复给_KTHREAD 的 Trap_Frame</pre></td></tr><tr><td data-num=\"40\"></td><td><pre>.text:0046A65B                 mov     [esi+_ETHREAD.Tcb.TrapFrame], ebp ; 将堆栈中形成的_KTRAP_FRAME 结构指针复制给_KTHREAD 中的 TRAPFRAME</pre></td></tr><tr><td data-num=\"41\"></td><td><pre>.text:0046A661                 cld</pre></td></tr><tr><td data-num=\"42\"></td><td><pre>.text:0046A662                 mov     ebx, [ebp+_KTRAP_FRAME._Ebp] ; 3 环的 EBP</pre></td></tr><tr><td data-num=\"43\"></td><td><pre>.text:0046A665                 mov     edi, [ebp+_KTRAP_FRAME._Eip] ; 3 环的 EIP</pre></td></tr><tr><td data-num=\"44\"></td><td><pre>.text:0046A668                 mov     [ebp+_KTRAP_FRAME.DbgArgPointer], edx ; edx 存储的是 3 环函数的参数的指针:</pre></td></tr><tr><td data-num=\"45\"></td><td><pre>.text:0046A668                                         ;</pre></td></tr><tr><td data-num=\"46\"></td><td><pre>.text:0046A668                                         ; _KiIntSystemCall：</pre></td></tr><tr><td data-num=\"47\"></td><td><pre>.text:0046A668                                         ;</pre></td></tr><tr><td data-num=\"48\"></td><td><pre>.text:0046A668                                         ; lea     edx, [esp+8] ; 参数指针</pre></td></tr><tr><td data-num=\"49\"></td><td><pre>.text:0046A668                                         ; int     2Eh</pre></td></tr><tr><td data-num=\"50\"></td><td><pre>.text:0046A668                                         ; retn</pre></td></tr><tr><td data-num=\"51\"></td><td><pre>.text:0046A66B                 mov     [ebp+_KTRAP_FRAME.DbgArgMark], 0BADB0D00h ; 这个是操作系统的标志</pre></td></tr><tr><td data-num=\"52\"></td><td><pre>.text:0046A672                 mov     [ebp+_KTRAP_FRAME.DbgEbp], ebx ; 3 环的 ebp 存储到 KTRAP_FRAME+0x000 DbgEbp 的位置</pre></td></tr><tr><td data-num=\"53\"></td><td><pre>.text:0046A675                 mov     [ebp+_KTRAP_FRAME.DbgEip], edi ; 3 环的 eip 存储到 KTRAP_FRAME+0x004 DbgEip 的位置</pre></td></tr><tr><td data-num=\"54\"></td><td><pre>.text:0046A678                 test    [esi+_KTHREAD.DebugActive], 0FFh ; 判断_KTHREAD 的 +0x02c DebugActive 是否为 - 1</pre></td></tr><tr><td data-num=\"55\"></td><td><pre>.text:0046A67C                 jnz     Dr_kss_a        ; 如果处于调试状态，跳转</pre></td></tr><tr><td data-num=\"56\"></td><td><pre>.text:0046A682</pre></td></tr><tr><td data-num=\"57\"></td><td><pre>.text:0046A682 loc_46A682:                             ; CODE XREF: Dr_kss_a+10↑j</pre></td></tr><tr><td data-num=\"58\"></td><td><pre>.text:0046A682                                         ; Dr_kss_a+7C↑j</pre></td></tr><tr><td data-num=\"59\"></td><td><pre>.text:0046A682                 sti                     ; 关闭中断</pre></td></tr><tr><td data-num=\"60\"></td><td><pre>.text:0046A683                 jmp     loc_46A76F      ; 取 3 环传来的服务号</pre></td></tr><tr><td data-num=\"61\"></td><td><pre>.text:0046A683 _KiSystemService endp</pre></td></tr></table></figure><p>Dr_kss_a:</p>\n<figure class=\"highlight raw\"><figcaption data-lang=\"\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>.text:0046A50C Dr_kss_a        proc near               ; CODE XREF: _KiSystemService+6B↓j</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>.text:0046A50C                 test    [ebp+_KTRAP_FRAME.EFlags], 20000h ; 判断 VM 位是否为 1</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>.text:0046A513                 jnz     short loc_46A522</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>.text:0046A515                 test    [ebp+_KTRAP_FRAME.SegCs], 1</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>.text:0046A51C                 jz      loc_46A682      ; 关闭中断</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>.text:0046A522</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>.text:0046A522 loc_46A522:                             ; CODE XREF: Dr_kss_a+7↑j</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>.text:0046A522                 mov     ebx, dr0</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>.text:0046A525                 mov     ecx, dr1</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>.text:0046A528                 mov     edi, dr2</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>.text:0046A52B                 mov     [ebp+_KTRAP_FRAME.Dr0], ebx ; 存储 Dr0 寄存器到 _KTRAP_FRAME +0x18</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>.text:0046A52E                 mov     [ebp+1Ch], ecx  ; 存储 Dr1 寄存器到 _KTRAP_FRAME +0x1C</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>.text:0046A531                 mov     [ebp+20h], edi  ; 存储 Dr2 寄存器到 _KTRAP_FRAME</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>.text:0046A534                 mov     ebx, dr3</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>.text:0046A537                 mov     ecx, dr6</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>.text:0046A53A                 mov     edi, dr7</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>.text:0046A53D                 mov     [ebp+24h], ebx  ; 存储 Dr3 寄存器到 _KTRAP_FRAME</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>.text:0046A540                 mov     [ebp+28h], ecx  ; 存储 Dr6 寄存器到 _KTRAP_FRAME</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>.text:0046A543                 xor     ebx, ebx        ; ebx &#x3D; 0</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>.text:0046A545                 mov     [ebp+2Ch], edi  ; 存储 Dr7 寄存器到 _KTRAP_FRAME</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>.text:0046A548                 mov     dr7, ebx        ; 将 Dr7 清零</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>.text:0046A54B                 mov     edi, large fs:_KPCR.Prcb ; edi &#x3D; _KPRCB 的指针</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>.text:0046A552                 mov     ebx, [edi+_KPRCB.ProcessorState.SpecialRegisters.KernelDr0]</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>.text:0046A558                 mov     ecx, [edi+_KPRCB.ProcessorState.SpecialRegisters.KernelDr1]</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>.text:0046A55E                 mov     dr0, ebx</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>.text:0046A561                 mov     dr1, ecx</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>.text:0046A564                 mov     ebx, [edi+_KPRCB.ProcessorState.SpecialRegisters.KernelDr2]</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>.text:0046A56A                 mov     ecx, [edi+_KPRCB.ProcessorState.SpecialRegisters.KernelDr3]</pre></td></tr><tr><td data-num=\"29\"></td><td><pre>.text:0046A570                 mov     dr2, ebx</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>.text:0046A573                 mov     dr3, ecx</pre></td></tr><tr><td data-num=\"31\"></td><td><pre>.text:0046A576                 mov     ebx, [edi+_KPRCB.ProcessorState.SpecialRegisters.KernelDr6]</pre></td></tr><tr><td data-num=\"32\"></td><td><pre>.text:0046A57C                 mov     ecx, [edi+_KPRCB.ProcessorState.SpecialRegisters.KernelDr7]</pre></td></tr><tr><td data-num=\"33\"></td><td><pre>.text:0046A582                 mov     dr6, ebx</pre></td></tr><tr><td data-num=\"34\"></td><td><pre>.text:0046A585                 mov     dr7, ecx</pre></td></tr><tr><td data-num=\"35\"></td><td><pre>.text:0046A588                 jmp     loc_46A682      ; 关闭中断</pre></td></tr><tr><td data-num=\"36\"></td><td><pre>.text:0046A588 Dr_kss_a        endp</pre></td></tr></table></figure><p>loc_46A76F: 既又跳转到 KiFastCallEntry 里了。</p>\n<h2 id=\"总结-2\"><a class=\"anchor\" href=\"#总结-2\">#</a> 总结</h2>\n<p>逆内核的时候要有一个主线，因为操作系统要考虑的事情太多了。<br />\n我们要带着目的去逆向，不然很容易迷失的。</p>\n<ol>\n<li>\n<p>进 0 环后，原来的寄存器存在哪里？</p>\n</li>\n<li>\n<p>如何根据系统服务号 (eax 中存储) 找到要执行的内核函数？</p>\n</li>\n<li>\n<p>调用时参数是存储到 3 环的堆栈，如何传递给内核函数？</p>\n</li>\n<li>\n<p>2 种调用方式是如何返回到 3 环的？</p>\n</li>\n</ol>\n<p>逆完我们可以知道：<br />\n快速调用与中断门填充完_KTRAP_FRAME 结构后，走的还是同样的代码去调用函数，最后出来的时候也是分开的。<br />\n既两个入口两个出口。</p>\n<p>这里面也涉及反硬件断点调试的操作，修改判断是否处于调试状态的_KTHREAD.DebugActive 的值，就可以让人获取不了 Dr0~Dr7 寄存器的值。</p>\n<p>海哥的视频里说了，如今这个阶段只需要知道如何进的 0 环就行了，至于如何返回的要等学过 APC 后了。</p>\n<h1 id=\"额外的小知识\"><a class=\"anchor\" href=\"#额外的小知识\">#</a> 额外的小知识</h1>\n<p>查看 CPU 数量</p>\n<p><code>kd&gt; dd KeNumberProcessors</code></p>\n<figure class=\"highlight raw\"><figcaption data-lang=\"\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>kd&gt; dd KeNumberProcessors</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>80556a60  00000001</pre></td></tr></table></figure><p>查看 KPCR</p>\n<figure class=\"highlight raw\"><figcaption data-lang=\"\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>kd&gt; dd KiProcessorBlock  L2</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>80554040  ffdff120 00000000\t\t\t\t&#x2F;&#x2F; 如果有 2 个核，那么就会出现 2 个地址</pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>kd&gt; dt _kpcr ffdff120-120\t\t\t\t&#x2F;&#x2F; 减去 120 (kpcr 的大小)\t就是 kpcr 的地址\t\t</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>nt!_KPCR</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  +0x000 NtTib            : _NT_TIB\t\t\t\t\t\t\t</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  +0x01c SelfPcr          : 0xffdff000 _KPCR\t\t\t\t\t\t\t</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  +0x020 Prcb             : 0xffdff120 _KPRCB\t\t\t\t\t\t\t</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  +0x024 Irql             : 0 &#39;&#39;\t\t\t\t\t\t\t</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  +0x028 IRR              : 0\t\t\t\t\t\t\t</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  +0x02c IrrActive        : 0\t\t\t\t\t\t\t</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  +0x030 IDR              : 0xffffffff\t\t\t\t\t\t\t</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>  +0x034 KdVersionBlock   : 0x80546cb8 Void\t\t\t\t\t\t\t</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>  +0x038 IDT              : 0x8003f400 _KIDTENTRY\t\t\t\t\t\t\t</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>  +0x03c GDT              : 0x8003f000 _KGDTENTRY\t\t\t\t\t\t\t</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>  +0x040 TSS              : 0x80042000 _KTSS\t\t\t\t\t\t\t</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>  +0x044 MajorVersion     : 1\t\t\t\t\t\t\t</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>  +0x046 MinorVersion     : 1\t\t\t\t\t\t\t</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>  +0x048 SetMember        : 1\t\t\t\t\t\t\t</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>  +0x04c StallScaleFactor : 0x13b5\t\t\t\t\t\t\t</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>  +0x050 DebugActive      : 0 &#39;&#39;\t\t\t\t\t\t\t</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>  +0x051 Number           : 0 &#39;&#39;\t\t\t\t\t\t\t</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>  +0x052 Spare0           : 0 &#39;&#39;\t\t\t\t\t\t\t</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>  +0x053 SecondLevelCacheAssociativity : 0 &#39;&#39;\t\t\t\t\t\t\t</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>  +0x054 VdmAlert         : 0\t\t\t\t\t\t\t</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>  +0x058 KernelReserved   : [14] 0\t\t\t\t\t\t\t</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>  +0x090 SecondLevelCacheSize : 0\t\t\t\t\t\t\t</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>  +0x094 HalReserved      : [16] 0\t\t\t\t\t\t\t</pre></td></tr><tr><td data-num=\"29\"></td><td><pre>  +0x0d4 InterruptMode    : 0\t\t\t\t\t\t\t</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>  +0x0d8 Spare1           : 0 &#39;&#39;\t\t\t\t\t\t\t</pre></td></tr><tr><td data-num=\"31\"></td><td><pre>  +0x0dc KernelReserved2  : [17] 0\t\t\t\t\t\t\t</pre></td></tr><tr><td data-num=\"32\"></td><td><pre>  +0x120 PrcbData         : _KPRCB</pre></td></tr></table></figure><h1 id=\"reference\"><a class=\"anchor\" href=\"#reference\">#</a> Reference</h1>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L0t3YW5zeS9hcnRpY2xlL2RldGFpbHMvMTA5NDI2Njg4\">https://blog.csdn.net/Kwansy/article/details/109426688</span></p>\n",
            "tags": [
                "sysenter指令",
                "KiFastCallEntry函数",
                "KiSystemService函数",
                "Trap_Frame"
            ]
        },
        {
            "id": "https://or0kit.github.io/Bin/Core/WindowsXp/SystemCall/%E7%B3%BB%E7%BB%9F%E8%B0%83%E7%94%A8-3%E7%8E%AF%E8%B0%83%E7%94%A8%E5%88%86%E6%9E%90/",
            "url": "https://or0kit.github.io/Bin/Core/WindowsXp/SystemCall/%E7%B3%BB%E7%BB%9F%E8%B0%83%E7%94%A8-3%E7%8E%AF%E8%B0%83%E7%94%A8%E5%88%86%E6%9E%90/",
            "title": "系统调用-3环调用分析",
            "date_published": "2021-12-07T00:20:27.000Z",
            "content_html": "<h1 id=\"分析3环api-readprocessmemory\"><a class=\"anchor\" href=\"#分析3环api-readprocessmemory\">#</a> 分析 3 环 API ReadProcessMemory</h1>\n<p>用 IDA 分析 kernel32.dll, 找到  <code>ReadProcessMemory</code>  函数，因为这个函数会进入 R0，所以我们对其分析 API 的调用过程。</p>\n<figure class=\"highlight raw\"><figcaption data-lang=\"\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>.text:7C8021D0 ; BOOL __stdcall ReadProcessMemory(HANDLE hProcess, LPCVOID lpBaseAddress, LPVOID lpBuffer, SIZE_T nSize, SIZE_T *lpNumberOfBytesRead)</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>.text:7C8021D0                 public _ReadProcessMemory@20</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>.text:7C8021D0 _ReadProcessMemory@20 proc near         ; CODE XREF: GetProcessVersion(x)+2F18B↓p</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>.text:7C8021D0                                         ; GetProcessVersion(x)+2F1AA↓p ...</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>.text:7C8021D0</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>.text:7C8021D0 hProcess        &#x3D; dword ptr  8</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>.text:7C8021D0 lpBaseAddress   &#x3D; dword ptr  0Ch</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>.text:7C8021D0 lpBuffer        &#x3D; dword ptr  10h</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>.text:7C8021D0 nSize           &#x3D; dword ptr  14h</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>.text:7C8021D0 lpNumberOfBytesRead&#x3D; dword ptr  18h</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>.text:7C8021D0</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>.text:7C8021D0                 mov     edi, edi</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>.text:7C8021D2                 push    ebp</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>.text:7C8021D3                 mov     ebp, esp</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>.text:7C8021D5                 lea     eax, [ebp+nSize]</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>.text:7C8021D8                 push    eax             ; NumberOfBytesRead</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>.text:7C8021D9                 push    [ebp+nSize]     ; NumberOfBytesToRead</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>.text:7C8021DC                 push    [ebp+lpBuffer]  ; Buffer</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>.text:7C8021DF                 push    [ebp+lpBaseAddress] ; BaseAddress</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>.text:7C8021E2                 push    [ebp+hProcess]  ; ProcessHandle</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>.text:7C8021E5                 call    ds:__imp__NtReadVirtualMemory@20 ; NtReadVirtualMemory(x,x,x,x,x)</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>.text:7C8021EB                 mov     ecx, [ebp+lpNumberOfBytesRead]</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>.text:7C8021EE                 test    ecx, ecx</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>.text:7C8021F0                 jnz     short loc_7C8021FD</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>.text:7C8021F2</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>.text:7C8021F2 loc_7C8021F2:                           ; CODE XREF: ReadProcessMemory(x,x,x,x,x)+32↓j</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>.text:7C8021F2                 test    eax, eax</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>.text:7C8021F4                 jl      short loc_7C802204</pre></td></tr><tr><td data-num=\"29\"></td><td><pre>.text:7C8021F6                 xor     eax, eax</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>.text:7C8021F8                 inc     eax</pre></td></tr><tr><td data-num=\"31\"></td><td><pre>.text:7C8021F9</pre></td></tr><tr><td data-num=\"32\"></td><td><pre>.text:7C8021F9 loc_7C8021F9:                           ; CODE XREF: ReadProcessMemory(x,x,x,x,x)+3C↓j</pre></td></tr><tr><td data-num=\"33\"></td><td><pre>.text:7C8021F9                 pop     ebp</pre></td></tr><tr><td data-num=\"34\"></td><td><pre>.text:7C8021FA                 retn    14h</pre></td></tr><tr><td data-num=\"35\"></td><td><pre>.text:7C8021FD ; ---------------------------------------------------------------------------</pre></td></tr><tr><td data-num=\"36\"></td><td><pre>.text:7C8021FD</pre></td></tr><tr><td data-num=\"37\"></td><td><pre>.text:7C8021FD loc_7C8021FD:                           ; CODE XREF: ReadProcessMemory(x,x,x,x,x)+20↑j</pre></td></tr><tr><td data-num=\"38\"></td><td><pre>.text:7C8021FD                 mov     edx, [ebp+nSize]</pre></td></tr><tr><td data-num=\"39\"></td><td><pre>.text:7C802200                 mov     [ecx], edx</pre></td></tr><tr><td data-num=\"40\"></td><td><pre>.text:7C802202                 jmp     short loc_7C8021F2</pre></td></tr><tr><td data-num=\"41\"></td><td><pre>.text:7C802204 ; ---------------------------------------------------------------------------</pre></td></tr><tr><td data-num=\"42\"></td><td><pre>.text:7C802204</pre></td></tr><tr><td data-num=\"43\"></td><td><pre>.text:7C802204 loc_7C802204:                           ; CODE XREF: ReadProcessMemory(x,x,x,x,x)+24↑j</pre></td></tr><tr><td data-num=\"44\"></td><td><pre>.text:7C802204                 push    eax             ; Status</pre></td></tr><tr><td data-num=\"45\"></td><td><pre>.text:7C802205                 call    _BaseSetLastNTError@4 ; BaseSetLastNTError(x)</pre></td></tr><tr><td data-num=\"46\"></td><td><pre>.text:7C80220A                 xor     eax, eax</pre></td></tr><tr><td data-num=\"47\"></td><td><pre>.text:7C80220C                 jmp     short loc_7C8021F9</pre></td></tr><tr><td data-num=\"48\"></td><td><pre>.text:7C80220C _ReadProcessMemory@20 endp</pre></td></tr></table></figure><p>由  <code>.text:7C8021E5                 call    ds:__imp__NtReadVirtualMemory@20 ; NtReadVirtualMemory(x,x,x,x,x)</code>  可知函数  <code>ReadProcessMemory</code>  调用了导入函数  <code>NtReadVirtualMemory</code></p>\n<p>查看导入表： <code>7C80141C\tNtReadVirtualMemory\tntdll</code> <br />\n 得知这个函数在 ntdll.dll 中</p>\n<p>用 IDA 打开 ntdll.dll, 查找 NtReadVirtualMemory 函数</p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">.</span>text<span class=\"token operator\">:</span><span class=\"token number\">7</span>C92D9E0 <span class=\"token punctuation\">;</span> __stdcall <span class=\"token function\">NtReadVirtualMemory</span><span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">,</span> x<span class=\"token punctuation\">,</span> x<span class=\"token punctuation\">,</span> x<span class=\"token punctuation\">,</span> x<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">.</span>text<span class=\"token operator\">:</span><span class=\"token number\">7</span>C92D9E0                 public _NtReadVirtualMemory@<span class=\"token number\">20</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">.</span>text<span class=\"token operator\">:</span><span class=\"token number\">7</span>C92D9E0 _NtReadVirtualMemory@<span class=\"token number\">20</span> proc near       <span class=\"token punctuation\">;</span> CODE XREF<span class=\"token operator\">:</span> <span class=\"token function\">LdrFindCreateProcessManifest</span><span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">,</span>x<span class=\"token punctuation\">,</span>x<span class=\"token punctuation\">,</span>x<span class=\"token punctuation\">,</span>x<span class=\"token punctuation\">)</span><span class=\"token operator\">+</span><span class=\"token number\">1</span>CC↓p</pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token punctuation\">.</span>text<span class=\"token operator\">:</span><span class=\"token number\">7</span>C92D9E0                                         <span class=\"token punctuation\">;</span> <span class=\"token function\">LdrCreateOutOfProcessImage</span><span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">,</span>x<span class=\"token punctuation\">,</span>x<span class=\"token punctuation\">,</span>x<span class=\"token punctuation\">)</span><span class=\"token operator\">+</span><span class=\"token number\">7</span>C↓p <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">.</span>text<span class=\"token operator\">:</span><span class=\"token number\">7</span>C92D9E0                 mov     eax<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span>BAh       <span class=\"token punctuation\">;</span> NtReadVirtualMemory</pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">.</span>text<span class=\"token operator\">:</span><span class=\"token number\">7</span>C92D9E5                 mov     edx<span class=\"token punctuation\">,</span> <span class=\"token number\">7FF</span>E0300h</pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token punctuation\">.</span>text<span class=\"token operator\">:</span><span class=\"token number\">7</span>C92D9EA                 call    dword ptr <span class=\"token punctuation\">[</span>edx<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token punctuation\">.</span>text<span class=\"token operator\">:</span><span class=\"token number\">7</span>C92D9EC                 retn    <span class=\"token number\">14</span>h</pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token punctuation\">.</span>text<span class=\"token operator\">:</span><span class=\"token number\">7</span>C92D9EC _NtReadVirtualMemory@<span class=\"token number\">20</span> endp</pre></td></tr></table></figure><p>可以看到这个函数只有短短几行汇编代码：给 eax 赋个值，然后给 edx 个地址，然后 call 一下 edx 指向的地址，然后就平栈（由于 STDCALL 调用约定）返回了。<br />\n但要看懂这几行代码，必须要了解一些知识。</p>\n<h1 id=\"_kuser_shared_data-结构体\"><a class=\"anchor\" href=\"#_kuser_shared_data-结构体\">#</a> _KUSER_SHARED_DATA 结构体</h1>\n<p>在 R3 和 R0 分别定义了一个_KUSER_SHARED_DATA 结构区域，用于 R3 和 R0 共享某些数据。<br />\n它们在同一个物理页上被映射到不同的虚拟地址，_KUSER_SHARED_DATA 结构在 R3 地址为 0x7ffe0000，在 R0 地址为 0xffdf0000。</p>\n<p>其结构如下所示：</p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>kd<span class=\"token operator\">></span> dt _KUSER_SHARED_DATA</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>nt<span class=\"token operator\">!</span>_KUSER_SHARED_DATA</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>   <span class=\"token operator\">+</span><span class=\"token number\">0x000</span> TickCountLow     <span class=\"token operator\">:</span> Uint4B</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>   <span class=\"token operator\">+</span><span class=\"token number\">0x004</span> TickCountMultiplier <span class=\"token operator\">:</span> Uint4B</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>   <span class=\"token operator\">+</span><span class=\"token number\">0x008</span> InterruptTime    <span class=\"token operator\">:</span> _KSYSTEM_TIME</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>   <span class=\"token operator\">+</span><span class=\"token number\">0x014</span> SystemTime       <span class=\"token operator\">:</span> _KSYSTEM_TIME</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>   <span class=\"token operator\">+</span><span class=\"token number\">0x020</span> TimeZoneBias     <span class=\"token operator\">:</span> _KSYSTEM_TIME</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>   <span class=\"token operator\">+</span><span class=\"token number\">0x02c</span> ImageNumberLow   <span class=\"token operator\">:</span> Uint2B</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>   <span class=\"token operator\">+</span><span class=\"token number\">0x02e</span> ImageNumberHigh  <span class=\"token operator\">:</span> Uint2B</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>   <span class=\"token operator\">+</span><span class=\"token number\">0x030</span> NtSystemRoot     <span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token number\">260</span><span class=\"token punctuation\">]</span> Uint2B</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>   <span class=\"token operator\">+</span><span class=\"token number\">0x238</span> MaxStackTraceDepth <span class=\"token operator\">:</span> Uint4B</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>   <span class=\"token operator\">+</span><span class=\"token number\">0x23c</span> CryptoExponent   <span class=\"token operator\">:</span> Uint4B</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>   <span class=\"token operator\">+</span><span class=\"token number\">0x240</span> TimeZoneId       <span class=\"token operator\">:</span> Uint4B</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>   <span class=\"token operator\">+</span><span class=\"token number\">0x244</span> Reserved2        <span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token number\">8</span><span class=\"token punctuation\">]</span> Uint4B</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>   <span class=\"token operator\">+</span><span class=\"token number\">0x264</span> NtProductType    <span class=\"token operator\">:</span> _NT_PRODUCT_TYPE</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>   <span class=\"token operator\">+</span><span class=\"token number\">0x268</span> ProductTypeIsValid <span class=\"token operator\">:</span> UChar</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>   <span class=\"token operator\">+</span><span class=\"token number\">0x26c</span> NtMajorVersion   <span class=\"token operator\">:</span> Uint4B</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>   <span class=\"token operator\">+</span><span class=\"token number\">0x270</span> NtMinorVersion   <span class=\"token operator\">:</span> Uint4B</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>   <span class=\"token operator\">+</span><span class=\"token number\">0x274</span> ProcessorFeatures <span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token number\">64</span><span class=\"token punctuation\">]</span> UChar</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>   <span class=\"token operator\">+</span><span class=\"token number\">0x2b4</span> Reserved1        <span class=\"token operator\">:</span> Uint4B</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>   <span class=\"token operator\">+</span><span class=\"token number\">0x2b8</span> Reserved3        <span class=\"token operator\">:</span> Uint4B</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>   <span class=\"token operator\">+</span><span class=\"token number\">0x2bc</span> TimeSlip         <span class=\"token operator\">:</span> Uint4B</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>   <span class=\"token operator\">+</span><span class=\"token number\">0x2c0</span> AlternativeArchitecture <span class=\"token operator\">:</span> _ALTERNATIVE_ARCHITECTURE_TYPE</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>   <span class=\"token operator\">+</span><span class=\"token number\">0x2c8</span> SystemExpirationDate <span class=\"token operator\">:</span> _LARGE_INTEGER</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>   <span class=\"token operator\">+</span><span class=\"token number\">0x2d0</span> SuiteMask        <span class=\"token operator\">:</span> Uint4B</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>   <span class=\"token operator\">+</span><span class=\"token number\">0x2d4</span> KdDebuggerEnabled <span class=\"token operator\">:</span> UChar</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>   <span class=\"token operator\">+</span><span class=\"token number\">0x2d5</span> NXSupportPolicy  <span class=\"token operator\">:</span> UChar</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>   <span class=\"token operator\">+</span><span class=\"token number\">0x2d8</span> ActiveConsoleId  <span class=\"token operator\">:</span> Uint4B</pre></td></tr><tr><td data-num=\"29\"></td><td><pre>   <span class=\"token operator\">+</span><span class=\"token number\">0x2dc</span> DismountCount    <span class=\"token operator\">:</span> Uint4B</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>   <span class=\"token operator\">+</span><span class=\"token number\">0x2e0</span> ComPlusPackage   <span class=\"token operator\">:</span> Uint4B</pre></td></tr><tr><td data-num=\"31\"></td><td><pre>   <span class=\"token operator\">+</span><span class=\"token number\">0x2e4</span> LastSystemRITEventTickCount <span class=\"token operator\">:</span> Uint4B</pre></td></tr><tr><td data-num=\"32\"></td><td><pre>   <span class=\"token operator\">+</span><span class=\"token number\">0x2e8</span> NumberOfPhysicalPages <span class=\"token operator\">:</span> Uint4B</pre></td></tr><tr><td data-num=\"33\"></td><td><pre>   <span class=\"token operator\">+</span><span class=\"token number\">0x2ec</span> SafeBootMode     <span class=\"token operator\">:</span> UChar</pre></td></tr><tr><td data-num=\"34\"></td><td><pre>   <span class=\"token operator\">+</span><span class=\"token number\">0x2f0</span> TraceLogging     <span class=\"token operator\">:</span> Uint4B</pre></td></tr><tr><td data-num=\"35\"></td><td><pre>   <span class=\"token operator\">+</span><span class=\"token number\">0x2f8</span> TestRetInstruction <span class=\"token operator\">:</span> Uint8B</pre></td></tr><tr><td data-num=\"36\"></td><td><pre>   <span class=\"token operator\">+</span><span class=\"token number\">0x300</span> SystemCall       <span class=\"token operator\">:</span> Uint4B</pre></td></tr><tr><td data-num=\"37\"></td><td><pre>   <span class=\"token operator\">+</span><span class=\"token number\">0x304</span> SystemCallReturn <span class=\"token operator\">:</span> Uint4B</pre></td></tr><tr><td data-num=\"38\"></td><td><pre>   <span class=\"token operator\">+</span><span class=\"token number\">0x308</span> SystemCallPad    <span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token number\">3</span><span class=\"token punctuation\">]</span> Uint8B</pre></td></tr><tr><td data-num=\"39\"></td><td><pre>   <span class=\"token operator\">+</span><span class=\"token number\">0x320</span> TickCount        <span class=\"token operator\">:</span> _KSYSTEM_TIME</pre></td></tr><tr><td data-num=\"40\"></td><td><pre>   <span class=\"token operator\">+</span><span class=\"token number\">0x320</span> TickCountQuad    <span class=\"token operator\">:</span> Uint8B</pre></td></tr><tr><td data-num=\"41\"></td><td><pre>   <span class=\"token operator\">+</span><span class=\"token number\">0x330</span> Cookie           <span class=\"token operator\">:</span> Uint4B</pre></td></tr></table></figure><p>虽然它们指向的是同一个物理页，但通过分页机制使其在 R3 是只读的，在 R0 是可读可写的，以保证安全性。</p>\n<p>其中相对结构体偏移 0x300 处的成员就是 3 环 API 进入内核的入口函数。</p>\n<p>查看其内容：</p>\n<figure class=\"highlight raw\"><figcaption data-lang=\"\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>kd&gt; .process 89aad020  </pre></td></tr><tr><td data-num=\"2\"></td><td><pre>Implicit process is now 89aad020</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>WARNING: .cache forcedecodeuser is not enabled</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>kd&gt; dd 0x7ffe0000</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>7ffe0000  000a01e6 0fa00000 dc0bc1e4 00000017</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>7ffe0010  00000017 ae23657c 01d7ec22 01d7ec22</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>7ffe0020  f1dcc000 ffffffbc ffffffbc 014c014c</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>7ffe0030  003a0043 0057005c 004e0049 004f0044</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>7ffe0040  00530057 00000000 00000000 00000000</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>7ffe0050  00000000 00000000 00000000 00000000</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>7ffe0060  00000000 00000000 00000000 00000000</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>7ffe0070  00000000 00000000 00000000 00000000</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>kd&gt; dd ffdf0000</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>ffdf0000  000a01e6 0fa00000 dc0bc1e4 00000017</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>ffdf0010  00000017 ae23657c 01d7ec22 01d7ec22</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>ffdf0020  f1dcc000 ffffffbc ffffffbc 014c014c</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>ffdf0030  003a0043 0057005c 004e0049 004f0044</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>ffdf0040  00530057 00000000 00000000 00000000</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>ffdf0050  00000000 00000000 00000000 00000000</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>ffdf0060  00000000 00000000 00000000 00000000</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>ffdf0070  00000000 00000000 00000000 00000000</pre></td></tr></table></figure><p>可以发现 7ffe0000 与 ffdf0000 处的数据相同。</p>\n<p>我们先看看 0xffdf0300 这个地址里面存的是什么，先 dd 一下，在查看其存储的地址的反汇编：</p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>kd<span class=\"token operator\">></span> dd ffdf0300</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>ffdf0300  <span class=\"token number\">7</span>c92e4f0 <span class=\"token number\">7</span>c92e4f4 <span class=\"token number\">00000000</span> <span class=\"token number\">00000000</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>ffdf0310  <span class=\"token number\">00000000</span> <span class=\"token number\">00000000</span> <span class=\"token number\">00000000</span> <span class=\"token number\">00000000</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>ffdf0320  <span class=\"token number\">00000000</span> <span class=\"token number\">00000000</span> <span class=\"token number\">00000000</span> <span class=\"token number\">00000000</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>ffdf0330  dc76a788 <span class=\"token number\">00000000</span> <span class=\"token number\">00000000</span> <span class=\"token number\">00000000</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>ffdf0340  <span class=\"token number\">00000000</span> <span class=\"token number\">00000000</span> <span class=\"token number\">00000000</span> <span class=\"token number\">00000000</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>ffdf0350  <span class=\"token number\">00000000</span> <span class=\"token number\">00000000</span> <span class=\"token number\">00000000</span> <span class=\"token number\">00000000</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>ffdf0360  <span class=\"token number\">00000000</span> <span class=\"token number\">00000000</span> <span class=\"token number\">00000000</span> <span class=\"token number\">00000000</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>ffdf0370  <span class=\"token number\">00000000</span> <span class=\"token number\">00000000</span> <span class=\"token number\">00000000</span> <span class=\"token number\">00000000</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>kd<span class=\"token operator\">></span> uf <span class=\"token number\">7</span>c92e4f0</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>ntdll<span class=\"token operator\">!</span>KiFastSystemCall<span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token number\">7</span>c92e4f0 <span class=\"token number\">8</span>bd4            mov     edx<span class=\"token punctuation\">,</span>esp</pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token number\">7</span>c92e4f2 <span class=\"token number\">0f</span><span class=\"token number\">34</span>            sysenter</pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token number\">7</span>c92e4f4 c3              ret</pre></td></tr></table></figure><p>由 windbg 的符号表可以发现，调用了  <code>KiFastSystemCall</code>  函数，这个函数也就三行汇编代码：把 esp 的值交给了 edx，然后调用 sysenter。</p>\n<p>这个函数就是快速调用。</p>\n<h1 id=\"快速调用与中断调用\"><a class=\"anchor\" href=\"#快速调用与中断调用\">#</a> 快速调用与中断调用</h1>\n<p>学了前面的保护模式后，我们知道如果想要提权，少不了更改 4 个值：CS/SS/ESP/EIP。所以不管是哪一种调用，其目的都是获取这四个值。</p>\n<p>中断调用是通过中断门进 0 环，此过程需要查 IDT 表和 TSS 表，涉及内存寻址。</p>\n<p>快速调用则是使用  <code>sysenter</code>  指令进 0 环，这种方式不需要查内存，而是直接从 CPU 的 MSR 寄存器中获取所需数据，相对中断调用更快，所以称为快速调用。</p>\n<hr />\n<p>中断门进 0 环，需要的 CS、EIP 在 IDT 表中，需要查内存（SS 与 ESP 由 TSS 提供），而 CPU 如果支持 sysenter 指令时，操作系统会提前将 CS/SS/ESP/EIP 的值存储在 MSR 寄存器中，sysenter 指令执行时，CPU 会将 MSR 寄存器中的值直接写入相关寄存器，没有读内存的过程，所以叫快速调用，但本质是一样的。</p>\n<p>其实，快速调用并不是一直存在的，在比较古老的 CPU 是不支持快速调用的。<br />\n它们进入内核的方式很简单粗暴，就是使用中断门。</p>\n<p>CPU 如何知道是否支持快速调用呢？当通过 eax=1 来执行 cpuid 指令时，处理器的特征信息被放在 ecx 和 edx 寄存器中，其中 edx 包含了一个 SEP 位（11 位），该位指明了当前处理器知否支持 sysenter/sysexit 指令，具体细节可以查看白皮书。</p>\n<h1 id=\"kifastsystemcall-与-kiintsystemcall\"><a class=\"anchor\" href=\"#kifastsystemcall-与-kiintsystemcall\">#</a> KiFastSystemCall 与 KiIntSystemCall</h1>\n<p>通过逆向汇编代码可以看出，不管 CPU 是否支持快速调用，它都是调用该地址。</p>\n<p>这就说明操作系统在初始化该结构体的时候必须先判断支不支持，然后填入适当的值。</p>\n<p>如果 CPU 支持快速调用，操作系统就会填入 KiFastSystemCall 函数的地址，我们可以看一下：</p>\n<figure class=\"highlight raw\"><figcaption data-lang=\"\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>_DWORD __stdcall KiFastSystemCall()</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>                public _KiFastSystemCall@0</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>_KiFastSystemCall@0 proc near           ; DATA XREF: .text:off_7C923428↑o</pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>                mov     edx, esp</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>                sysenter</pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>_KiFastSystemCall@0 endp</pre></td></tr></table></figure><p>如果 CPU 不支持快速调用，操作系统就会填入 KiIntSystemCall 函数的地址，我们可以看一下：</p>\n<figure class=\"highlight raw\"><figcaption data-lang=\"\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>_DWORD __stdcall KiIntSystemCall ()</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>                public _KiIntSystemCall@0</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>_KiIntSystemCall@0 proc near            ; DATA XREF: .text:off_7C923428↑o</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>arg_4           &#x3D; byte ptr  8</pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>                lea     edx, [esp+arg_4] ; 参数指针</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>                int     2Eh             ; DOS 2+ internal - EXECUTE COMMAND</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>                                        ; DS:SI -&gt; counted CR-terminated command string</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>                retn</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\t\t\t\t</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>_KiIntSystemCall@0 endp</pre></td></tr></table></figure><h1 id=\"重写-readprocessmemory-和-writeprocessmemory\"><a class=\"anchor\" href=\"#重写-readprocessmemory-和-writeprocessmemory\">#</a> 重写 ReadProcessMemory 和 WriteProcessMemory</h1>\n<p>首先分析一下这两个函数的调用流程</p>\n<h2 id=\"readprocessmemory-3环调用流程\"><a class=\"anchor\" href=\"#readprocessmemory-3环调用流程\">#</a> ReadProcessMemory 3 环调用流程</h2>\n<p>在 kernel32.dll 中</p>\n<figure class=\"highlight raw\"><figcaption data-lang=\"\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>.text:7C8021D0 ; BOOL __stdcall ReadProcessMemory(HANDLE hProcess, LPCVOID lpBaseAddress, LPVOID lpBuffer, SIZE_T nSize, SIZE_T *lpNumberOfBytesRead)</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>.text:7C8021D0                 public _ReadProcessMemory@20</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>.text:7C8021D0 _ReadProcessMemory@20 proc near         ; CODE XREF: GetProcessVersion(x)+2F18B↓p</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>.text:7C8021D0                                         ; GetProcessVersion(x)+2F1AA↓p ...</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>.text:7C8021D0</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>.text:7C8021D0 hProcess        &#x3D; dword ptr  8</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>.text:7C8021D0 lpBaseAddress   &#x3D; dword ptr  0Ch</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>.text:7C8021D0 lpBuffer        &#x3D; dword ptr  10h</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>.text:7C8021D0 nSize           &#x3D; dword ptr  14h</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>.text:7C8021D0 lpNumberOfBytesRead&#x3D; dword ptr  18h</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>.text:7C8021D0</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>.text:7C8021D0                 mov     edi, edi</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>.text:7C8021D2                 push    ebp</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>.text:7C8021D3                 mov     ebp, esp</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>.text:7C8021D5                 lea     eax, [ebp+nSize]</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>.text:7C8021D8                 push    eax             ; NumberOfBytesRead</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>.text:7C8021D9                 push    [ebp+nSize]     ; NumberOfBytesToRead</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>.text:7C8021DC                 push    [ebp+lpBuffer]  ; Buffer</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>.text:7C8021DF                 push    [ebp+lpBaseAddress] ; BaseAddress</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>.text:7C8021E2                 push    [ebp+hProcess]  ; ProcessHandle</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>.text:7C8021E5                 call    ds:__imp__NtReadVirtualMemory@20 ; NtReadVirtualMemory(x,x,x,x,x)</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>.text:7C8021EB                 mov     ecx, [ebp+lpNumberOfBytesRead]</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>.text:7C8021EE                 test    ecx, ecx</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>.text:7C8021F0                 jnz     short loc_7C8021FD</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>.text:7C8021F2</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>.text:7C8021F2 loc_7C8021F2:                           ; CODE XREF: ReadProcessMemory(x,x,x,x,x)+32↓j</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>.text:7C8021F2                 test    eax, eax</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>.text:7C8021F4                 jl      short loc_7C802204</pre></td></tr><tr><td data-num=\"29\"></td><td><pre>.text:7C8021F6                 xor     eax, eax</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>.text:7C8021F8                 inc     eax</pre></td></tr><tr><td data-num=\"31\"></td><td><pre>.text:7C8021F9</pre></td></tr><tr><td data-num=\"32\"></td><td><pre>.text:7C8021F9 loc_7C8021F9:                           ; CODE XREF: ReadProcessMemory(x,x,x,x,x)+3C↓j</pre></td></tr><tr><td data-num=\"33\"></td><td><pre>.text:7C8021F9                 pop     ebp</pre></td></tr><tr><td data-num=\"34\"></td><td><pre>.text:7C8021FA                 retn    14h</pre></td></tr></table></figure><p>发现其调用了 ntdll.dll 中的 NtReadVirtualMemory 函数</p>\n<p>查看 ntdll.dll 中的 NtReadVirtualMemory</p>\n<figure class=\"highlight raw\"><figcaption data-lang=\"\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>.text:7C92D9E0 ; __stdcall NtReadVirtualMemory(x, x, x, x, x)</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>.text:7C92D9E0                 public _NtReadVirtualMemory@20</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>.text:7C92D9E0 _NtReadVirtualMemory@20 proc near       ; CODE XREF: LdrFindCreateProcessManifest(x,x,x,x,x)+1CC↓p</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>.text:7C92D9E0                                         ; LdrCreateOutOfProcessImage(x,x,x,x)+7C↓p ...</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>.text:7C92D9E0                 mov     eax, 0BAh       ; NtReadVirtualMemory</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>.text:7C92D9E5                 mov     edx, 7FFE0300h</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>.text:7C92D9EA                 call    dword ptr [edx]</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>.text:7C92D9EC                 retn    14h</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>.text:7C92D9EC _NtReadVirtualMemory@20 endp</pre></td></tr></table></figure><p>其堆栈变化为：</p>\n<p><img data-src=\"image004.png\" alt=\"\" /></p>\n<h2 id=\"rewriter3apicpp\"><a class=\"anchor\" href=\"#rewriter3apicpp\">#</a> RewriteR3API.cpp</h2>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span>  <span class=\"token macro-name\">_CRT_SECURE_NO_WARNINGS</span></span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span><span class=\"token string\">&lt;stdio.h></span></span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span><span class=\"token string\">&lt;Windows.h></span></span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token comment\">// 读进程内存（中断门调用）</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>BOOL WINAPI <span class=\"token function\">HbgReadProcessMemory_INT</span><span class=\"token punctuation\">(</span>HANDLE hProcess<span class=\"token punctuation\">,</span> LPCVOID lpBaseAddress<span class=\"token punctuation\">,</span> LPVOID lpBuffer<span class=\"token punctuation\">,</span> DWORD nSize<span class=\"token punctuation\">,</span> LPDWORD lpNumberOfBytesRead<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>\tLONG NtStatus<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\t__asm</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>\t\t<span class=\"token comment\">// 直接模拟 KiIntSystemCall</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>\t\tlea edx<span class=\"token punctuation\">,</span> hProcess<span class=\"token punctuation\">;</span> <span class=\"token comment\">// 要求 edx 存储最后入栈的参数</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>\t\tmov eax<span class=\"token punctuation\">,</span> <span class=\"token number\">0xBA</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>\t\t<span class=\"token keyword\">int</span> <span class=\"token number\">0x2E</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>\t\tmov NtStatus<span class=\"token punctuation\">,</span> eax<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>lpNumberOfBytesRead <span class=\"token operator\">!=</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>\t\t<span class=\"token operator\">*</span>lpNumberOfBytesRead <span class=\"token operator\">=</span> nSize<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>\t<span class=\"token comment\">// 错误检查</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>NtStatus <span class=\"token operator\">&lt;</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>\t\t<span class=\"token keyword\">return</span> FALSE<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>\t<span class=\"token keyword\">return</span> TRUE<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre></pre></td></tr><tr><td data-num=\"29\"></td><td><pre><span class=\"token comment\">// 读进程内存（快速调用）</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>BOOL WINAPI <span class=\"token function\">HbgReadProcessMemory_FAST</span><span class=\"token punctuation\">(</span>HANDLE hProcess<span class=\"token punctuation\">,</span> LPCVOID lpBaseAddress<span class=\"token punctuation\">,</span> LPVOID lpBuffer<span class=\"token punctuation\">,</span> DWORD nSize<span class=\"token punctuation\">,</span> LPDWORD lpNumberOfBytesRead<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>\tLONG NtStatus<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>\t__asm</pre></td></tr><tr><td data-num=\"34\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>\t\t<span class=\"token comment\">// 模拟 ReadProcessMemory</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>\t\tlea eax<span class=\"token punctuation\">,</span> nSize<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>\t\tpush eax<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>\t\tpush nSize<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>\t\tpush lpBuffer<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>\t\tpush lpBaseAddress<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>\t\tpush hProcess<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>\t\tsub esp<span class=\"token punctuation\">,</span> <span class=\"token number\">0x04</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// 模拟 ReadProcessMemory 里的 CALL NtReadVirtualMemory</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>\t\t<span class=\"token comment\">// 模拟 NtReadVirtualMemory</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>\t\tmov eax<span class=\"token punctuation\">,</span> <span class=\"token number\">0xBA</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>\t\tpush NtReadVirtualMemoryReturn<span class=\"token punctuation\">;</span> <span class=\"token comment\">// 模拟 NtReadVirtualMemory 函数里的 CALL [0x7FFE0300]</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>\t\t<span class=\"token comment\">// 模拟 KiFastSystemCall</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>\t\tmov edx<span class=\"token punctuation\">,</span> esp<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>\t\t_emit <span class=\"token number\">0x0F</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// sysenter </span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>\t\t_emit <span class=\"token number\">0x34</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>\tNtReadVirtualMemoryReturn<span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>\t\tadd esp<span class=\"token punctuation\">,</span> <span class=\"token number\">0x18</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// 模拟 NtReadVirtualMemory 返回到 ReadProcessMemory 时的 RETN 0x14</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre>\t\tmov NtStatus<span class=\"token punctuation\">,</span> eax<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre>\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>lpNumberOfBytesRead <span class=\"token operator\">!=</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>\t\t<span class=\"token operator\">*</span>lpNumberOfBytesRead <span class=\"token operator\">=</span> nSize<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre>\t<span class=\"token comment\">// 错误检查</span></pre></td></tr><tr><td data-num=\"59\"></td><td><pre>\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>NtStatus <span class=\"token operator\">&lt;</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"61\"></td><td><pre>\t\t<span class=\"token keyword\">return</span> FALSE<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"62\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"63\"></td><td><pre>\t<span class=\"token keyword\">return</span> TRUE<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"64\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"65\"></td><td><pre></pre></td></tr><tr><td data-num=\"66\"></td><td><pre><span class=\"token comment\">// 写进程内存（中断门调用）</span></pre></td></tr><tr><td data-num=\"67\"></td><td><pre>BOOL WINAPI <span class=\"token function\">HbgWriteProcessMemory_INT</span><span class=\"token punctuation\">(</span>HANDLE hProcess<span class=\"token punctuation\">,</span> LPCVOID lpBaseAddress<span class=\"token punctuation\">,</span> LPVOID lpBuffer<span class=\"token punctuation\">,</span> DWORD nSize<span class=\"token punctuation\">,</span> LPDWORD lpNumberOfBytesWritten<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"68\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"69\"></td><td><pre>\tLONG NtStatus<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"70\"></td><td><pre>\t__asm</pre></td></tr><tr><td data-num=\"71\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"72\"></td><td><pre>\t\tlea edx<span class=\"token punctuation\">,</span> hProcess<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"73\"></td><td><pre>\t\tmov eax<span class=\"token punctuation\">,</span> <span class=\"token number\">0x115</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"74\"></td><td><pre>\t\t<span class=\"token keyword\">int</span> <span class=\"token number\">0x2E</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"75\"></td><td><pre>\t\tmov NtStatus<span class=\"token punctuation\">,</span> eax<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"76\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"77\"></td><td><pre>\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>lpNumberOfBytesWritten <span class=\"token operator\">!=</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"78\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"79\"></td><td><pre>\t\t<span class=\"token operator\">*</span>lpNumberOfBytesWritten <span class=\"token operator\">=</span> nSize<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"80\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"81\"></td><td><pre>\t<span class=\"token comment\">// 错误检查</span></pre></td></tr><tr><td data-num=\"82\"></td><td><pre>\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>NtStatus <span class=\"token operator\">&lt;</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"83\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"84\"></td><td><pre>\t\t<span class=\"token keyword\">return</span> FALSE<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"85\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"86\"></td><td><pre>\t<span class=\"token keyword\">return</span> TRUE<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"87\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"88\"></td><td><pre></pre></td></tr><tr><td data-num=\"89\"></td><td><pre><span class=\"token comment\">// 写进程内存（快速调用）</span></pre></td></tr><tr><td data-num=\"90\"></td><td><pre>BOOL WINAPI <span class=\"token function\">HbgWriteProcessMemory_FAST</span><span class=\"token punctuation\">(</span>HANDLE hProcess<span class=\"token punctuation\">,</span> LPCVOID lpBaseAddress<span class=\"token punctuation\">,</span> LPVOID lpBuffer<span class=\"token punctuation\">,</span> DWORD nSize<span class=\"token punctuation\">,</span> LPDWORD lpNumberOfBytesWritten<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"91\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"92\"></td><td><pre>\tLONG NtStatus<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"93\"></td><td><pre>\t__asm</pre></td></tr><tr><td data-num=\"94\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"95\"></td><td><pre>\t\t<span class=\"token comment\">// 模拟 WriteProcessMemory</span></pre></td></tr><tr><td data-num=\"96\"></td><td><pre>\t\tlea eax<span class=\"token punctuation\">,</span> nSize<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"97\"></td><td><pre>\t\tpush eax<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"98\"></td><td><pre>\t\tpush nSize<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"99\"></td><td><pre>\t\tpush lpBuffer<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"100\"></td><td><pre>\t\tpush lpBaseAddress<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"101\"></td><td><pre>\t\tpush hProcess<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"102\"></td><td><pre>\t\tsub esp<span class=\"token punctuation\">,</span> <span class=\"token number\">0x04</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// 模拟 WriteProcessMemory 里的 CALL NtWriteVirtualMemory</span></pre></td></tr><tr><td data-num=\"103\"></td><td><pre>\t\t<span class=\"token comment\">// 模拟 NtWriteVirtualMemory</span></pre></td></tr><tr><td data-num=\"104\"></td><td><pre>\t\tmov eax<span class=\"token punctuation\">,</span> <span class=\"token number\">0x115</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"105\"></td><td><pre>\t\tpush NtWriteVirtualMemoryReturn<span class=\"token punctuation\">;</span> <span class=\"token comment\">// 模拟 NtWriteVirtualMemory 函数里的 CALL [0x7FFE0300]</span></pre></td></tr><tr><td data-num=\"106\"></td><td><pre>\t\t<span class=\"token comment\">// 模拟 KiFastSystemCall</span></pre></td></tr><tr><td data-num=\"107\"></td><td><pre>\t\tmov edx<span class=\"token punctuation\">,</span> esp<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"108\"></td><td><pre>\t\t_emit <span class=\"token number\">0x0F</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// sysenter </span></pre></td></tr><tr><td data-num=\"109\"></td><td><pre>\t\t_emit <span class=\"token number\">0x34</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"110\"></td><td><pre>\tNtWriteVirtualMemoryReturn<span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"111\"></td><td><pre>\t\tadd esp<span class=\"token punctuation\">,</span> <span class=\"token number\">0x18</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// 模拟 NtWriteVirtualMemory 返回到 WriteProcessMemory 时的 RETN 0x14</span></pre></td></tr><tr><td data-num=\"112\"></td><td><pre>\t\tmov NtStatus<span class=\"token punctuation\">,</span> eax<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"113\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"114\"></td><td><pre>\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>lpNumberOfBytesWritten <span class=\"token operator\">!=</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"115\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"116\"></td><td><pre>\t\t<span class=\"token operator\">*</span>lpNumberOfBytesWritten <span class=\"token operator\">=</span> nSize<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"117\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"118\"></td><td><pre>\t<span class=\"token comment\">// 错误检查</span></pre></td></tr><tr><td data-num=\"119\"></td><td><pre>\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>NtStatus <span class=\"token operator\">&lt;</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"120\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"121\"></td><td><pre>\t\t<span class=\"token keyword\">return</span> FALSE<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"122\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"123\"></td><td><pre>\t<span class=\"token keyword\">return</span> TRUE<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"124\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"125\"></td><td><pre></pre></td></tr><tr><td data-num=\"126\"></td><td><pre><span class=\"token comment\">// 提权函数：提升为 DEBUG 权限</span></pre></td></tr><tr><td data-num=\"127\"></td><td><pre>BOOL <span class=\"token function\">EnableDebugPrivilege</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"128\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"129\"></td><td><pre>\tHANDLE hToken<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"130\"></td><td><pre>\tBOOL fOk <span class=\"token operator\">=</span> FALSE<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"131\"></td><td><pre>\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">OpenProcessToken</span><span class=\"token punctuation\">(</span><span class=\"token function\">GetCurrentProcess</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> TOKEN_ADJUST_PRIVILEGES<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>hToken<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"132\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"133\"></td><td><pre>\t\tTOKEN_PRIVILEGES tp<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"134\"></td><td><pre>\t\ttp<span class=\"token punctuation\">.</span>PrivilegeCount <span class=\"token operator\">=</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"135\"></td><td><pre>\t\t<span class=\"token function\">LookupPrivilegeValue</span><span class=\"token punctuation\">(</span><span class=\"token constant\">NULL</span><span class=\"token punctuation\">,</span> SE_DEBUG_NAME<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>tp<span class=\"token punctuation\">.</span>Privileges<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>Luid<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"136\"></td><td><pre></pre></td></tr><tr><td data-num=\"137\"></td><td><pre>\t\ttp<span class=\"token punctuation\">.</span>Privileges<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>Attributes <span class=\"token operator\">=</span> SE_PRIVILEGE_ENABLED<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"138\"></td><td><pre>\t\t<span class=\"token function\">AdjustTokenPrivileges</span><span class=\"token punctuation\">(</span>hToken<span class=\"token punctuation\">,</span> FALSE<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>tp<span class=\"token punctuation\">,</span> <span class=\"token keyword\">sizeof</span><span class=\"token punctuation\">(</span>tp<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">,</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"139\"></td><td><pre></pre></td></tr><tr><td data-num=\"140\"></td><td><pre>\t\tfOk <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token function\">GetLastError</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> ERROR_SUCCESS<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"141\"></td><td><pre>\t\t<span class=\"token function\">CloseHandle</span><span class=\"token punctuation\">(</span>hToken<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"142\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"143\"></td><td><pre>\t<span class=\"token keyword\">return</span> fOk<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"144\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"145\"></td><td><pre></pre></td></tr><tr><td data-num=\"146\"></td><td><pre><span class=\"token keyword\">int</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> argc<span class=\"token punctuation\">,</span> <span class=\"token keyword\">char</span><span class=\"token operator\">*</span> argv<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"147\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"148\"></td><td><pre>\t<span class=\"token function\">EnableDebugPrivilege</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"149\"></td><td><pre></pre></td></tr><tr><td data-num=\"150\"></td><td><pre>\tDWORD pid<span class=\"token punctuation\">,</span> addr<span class=\"token punctuation\">,</span> dwRead<span class=\"token punctuation\">,</span> dwWritten<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"151\"></td><td><pre>\t<span class=\"token keyword\">char</span> buff<span class=\"token punctuation\">[</span><span class=\"token number\">20</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span> <span class=\"token number\">0</span> <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"152\"></td><td><pre>\t<span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"依次输入PID和要读的线性地址（均为16进制）...\\n\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"153\"></td><td><pre>\t<span class=\"token function\">scanf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"%x %x\"</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>pid<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>addr<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"154\"></td><td><pre>\t<span class=\"token function\">getchar</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"155\"></td><td><pre></pre></td></tr><tr><td data-num=\"156\"></td><td><pre>\t<span class=\"token comment\">// 测试两个版本的 ReadProcessMemory</span></pre></td></tr><tr><td data-num=\"157\"></td><td><pre>\t<span class=\"token function\">HbgReadProcessMemory_INT</span><span class=\"token punctuation\">(</span><span class=\"token function\">OpenProcess</span><span class=\"token punctuation\">(</span>PROCESS_ALL_ACCESS<span class=\"token punctuation\">,</span> FALSE<span class=\"token punctuation\">,</span> pid<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span>LPCVOID<span class=\"token punctuation\">)</span>addr<span class=\"token punctuation\">,</span> buff<span class=\"token punctuation\">,</span> <span class=\"token number\">4</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>dwRead<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"158\"></td><td><pre>\t<span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"读取了%d个字节，内容是: \\\"%s\\\"\\n\"</span><span class=\"token punctuation\">,</span> dwRead<span class=\"token punctuation\">,</span> buff<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"159\"></td><td><pre>\t<span class=\"token function\">HbgReadProcessMemory_FAST</span><span class=\"token punctuation\">(</span><span class=\"token function\">OpenProcess</span><span class=\"token punctuation\">(</span>PROCESS_ALL_ACCESS<span class=\"token punctuation\">,</span> FALSE<span class=\"token punctuation\">,</span> pid<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span>LPCVOID<span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span>addr <span class=\"token operator\">+</span> <span class=\"token number\">4</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> buff<span class=\"token punctuation\">,</span> <span class=\"token number\">4</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>dwRead<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"160\"></td><td><pre>\t<span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"读取了%d个字节，内容是: \\\"%s\\\"\\n\"</span><span class=\"token punctuation\">,</span> dwRead<span class=\"token punctuation\">,</span> buff<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"161\"></td><td><pre></pre></td></tr><tr><td data-num=\"162\"></td><td><pre>\t<span class=\"token comment\">// 测试两个版本的 WriteProcessMemory</span></pre></td></tr><tr><td data-num=\"163\"></td><td><pre>\t<span class=\"token function\">HbgWriteProcessMemory_INT</span><span class=\"token punctuation\">(</span><span class=\"token function\">OpenProcess</span><span class=\"token punctuation\">(</span>PROCESS_ALL_ACCESS<span class=\"token punctuation\">,</span> FALSE<span class=\"token punctuation\">,</span> pid<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span>LPCVOID<span class=\"token punctuation\">)</span>addr<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span>LPVOID<span class=\"token punctuation\">)</span><span class=\"token string\">\"##\"</span><span class=\"token punctuation\">,</span> <span class=\"token number\">2</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>dwWritten<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"164\"></td><td><pre>\t<span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"写入了%d字节.\\n\"</span><span class=\"token punctuation\">,</span> dwWritten<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"165\"></td><td><pre>\t<span class=\"token function\">HbgWriteProcessMemory_FAST</span><span class=\"token punctuation\">(</span><span class=\"token function\">OpenProcess</span><span class=\"token punctuation\">(</span>PROCESS_ALL_ACCESS<span class=\"token punctuation\">,</span> FALSE<span class=\"token punctuation\">,</span> pid<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span>LPCVOID<span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span>addr <span class=\"token operator\">+</span> <span class=\"token number\">4</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span>LPVOID<span class=\"token punctuation\">)</span><span class=\"token string\">\"**\"</span><span class=\"token punctuation\">,</span> <span class=\"token number\">2</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>dwWritten<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"166\"></td><td><pre>\t<span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"写入了%d字节.\\n\"</span><span class=\"token punctuation\">,</span> dwWritten<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"167\"></td><td><pre></pre></td></tr><tr><td data-num=\"168\"></td><td><pre>\t<span class=\"token comment\">// 再次读取，验证写入是否成功</span></pre></td></tr><tr><td data-num=\"169\"></td><td><pre>\t<span class=\"token function\">HbgReadProcessMemory_INT</span><span class=\"token punctuation\">(</span><span class=\"token function\">OpenProcess</span><span class=\"token punctuation\">(</span>PROCESS_ALL_ACCESS<span class=\"token punctuation\">,</span> FALSE<span class=\"token punctuation\">,</span> pid<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span>LPCVOID<span class=\"token punctuation\">)</span>addr<span class=\"token punctuation\">,</span> buff<span class=\"token punctuation\">,</span> <span class=\"token number\">4</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>dwRead<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"170\"></td><td><pre>\t<span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"读取了%d个字节，内容是: \\\"%s\\\"\\n\"</span><span class=\"token punctuation\">,</span> dwRead<span class=\"token punctuation\">,</span> buff<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"171\"></td><td><pre>\t<span class=\"token function\">HbgReadProcessMemory_FAST</span><span class=\"token punctuation\">(</span><span class=\"token function\">OpenProcess</span><span class=\"token punctuation\">(</span>PROCESS_ALL_ACCESS<span class=\"token punctuation\">,</span> FALSE<span class=\"token punctuation\">,</span> pid<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span>LPCVOID<span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span>addr <span class=\"token operator\">+</span> <span class=\"token number\">4</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> buff<span class=\"token punctuation\">,</span> <span class=\"token number\">4</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>dwRead<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"172\"></td><td><pre>\t<span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"读取了%d个字节，内容是: \\\"%s\\\"\\n\"</span><span class=\"token punctuation\">,</span> dwRead<span class=\"token punctuation\">,</span> buff<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"173\"></td><td><pre></pre></td></tr><tr><td data-num=\"174\"></td><td><pre>\t<span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"bye!\\n\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"175\"></td><td><pre>\t<span class=\"token function\">getchar</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"176\"></td><td><pre>\t<span class=\"token keyword\">return</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"177\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h2 id=\"testrewriter3apicpp\"><a class=\"anchor\" href=\"#testrewriter3apicpp\">#</a> TestRewriteR3API.cpp</h2>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;stdio.h></span></span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;windows.h></span></span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;Tlhelp32.h></span></span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token keyword\">int</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> argc<span class=\"token punctuation\">,</span> <span class=\"token keyword\">char</span><span class=\"token operator\">*</span> argv<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">&#123;</span>   </pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token comment\">// 获取进程自身的 PID</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    HANDLE hSnapshot <span class=\"token operator\">=</span> <span class=\"token function\">CreateToolhelp32Snapshot</span><span class=\"token punctuation\">(</span>TH32CS_SNAPPROCESS<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>INVALID_HANDLE_VALUE <span class=\"token operator\">==</span> hSnapshot<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>        <span class=\"token keyword\">return</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    PROCESSENTRY32 pi<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    pi<span class=\"token punctuation\">.</span>dwSize <span class=\"token operator\">=</span> <span class=\"token keyword\">sizeof</span><span class=\"token punctuation\">(</span>PROCESSENTRY32<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// 第一次使用必须初始化成员</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    BOOL bRet <span class=\"token operator\">=</span> <span class=\"token function\">Process32First</span><span class=\"token punctuation\">(</span>hSnapshot<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>pi<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span>bRet<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">strcmp</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"TestReWriteR3API.exe\"</span><span class=\"token punctuation\">,</span> pi<span class=\"token punctuation\">.</span>szExeFile<span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>        <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>            <span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"进程ID = %X \\r\\n\"</span><span class=\"token punctuation\">,</span> pi<span class=\"token punctuation\">.</span>th32ProcessID<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>            <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>        bRet <span class=\"token operator\">=</span> <span class=\"token function\">Process32Next</span><span class=\"token punctuation\">(</span>hSnapshot<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>pi<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>    <span class=\"token function\">CloseHandle</span><span class=\"token punctuation\">(</span>hSnapshot<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>    <span class=\"token keyword\">char</span> str<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token string\">\"菜就多练练\"</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>    <span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"%p--%s\\n\"</span><span class=\"token punctuation\">,</span> str<span class=\"token punctuation\">,</span> str<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>    <span class=\"token function\">getchar</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>    <span class=\"token keyword\">return</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>结果：</p>\n<p><img data-src=\"image001.png\" alt=\"\" /></p>\n<p>并且查看导入表中并没有 ReadProcessMemory 和 WriteProcessMemory。</p>\n<p><img data-src=\"image002.png\" alt=\"\" /></p>\n<p><img data-src=\"image003.png\" alt=\"\" /></p>\n<h1 id=\"reference\"><a class=\"anchor\" href=\"#reference\">#</a> Reference</h1>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L0t3YW5zeS9hcnRpY2xlL2RldGFpbHMvMTA5MzQxNzk0\">https://blog.csdn.net/Kwansy/article/details/109341794</span></p>\n",
            "tags": [
                "快速调用",
                "中断调用",
                "分析ReadProcessMemory",
                "KiFastSystemCall",
                "KiIntSystemCall",
                "重写3环",
                "_KUSER_SHARED_DATA"
            ]
        },
        {
            "id": "https://or0kit.github.io/Bin/Core/Drive-Development/%E9%A9%B1%E5%8A%A8%E5%BC%80%E5%8F%91-%E9%9A%90%E8%97%8F%E9%A9%B1%E5%8A%A8/",
            "url": "https://or0kit.github.io/Bin/Core/Drive-Development/%E9%A9%B1%E5%8A%A8%E5%BC%80%E5%8F%91-%E9%9A%90%E8%97%8F%E9%A9%B1%E5%8A%A8/",
            "title": "驱动开发-隐藏驱动",
            "date_published": "2021-12-06T14:13:08.000Z",
            "content_html": "<h1 id=\"楔子\"><a class=\"anchor\" href=\"#楔子\">#</a> 楔子</h1>\n<p>编写一个 0 环断链的驱动代码</p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">// 遍历内核模块</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span><span class=\"token string\">&lt;ntddk.h></span></span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token keyword\">typedef</span> <span class=\"token keyword\">struct</span> <span class=\"token class-name\">_LDR_DATA_TABLE_ENTRY</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>\tLIST_ENTRY InLoadOrderLinks<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>\tLIST_ENTRY InMemoryOrderLinks<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\tLIST_ENTRY InInitializationOrderLinks<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\tPVOID DllBase<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>\tPVOID EntryPoint<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>\tUINT32 SizeOfImage<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>\tUNICODE_STRING FullDllName<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>\tUNICODE_STRING BaseDllName<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>\tUINT32 Flags<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>\tUINT16 LoadCount<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>\tUINT16 TlsIndex<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>\tLIST_ENTRY HashLinks<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>\tPVOID SectionPointer<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>\tUINT32 CheckSum<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>\tUINT32 TimeDateStamp<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>\tPVOID LoadedImports<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>\tPVOID EntryPointActivationContext<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>\tPVOID PatchInformation<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre><span class=\"token punctuation\">&#125;</span> LDR_DATA_TABLE_ENTRY<span class=\"token punctuation\">,</span> <span class=\"token operator\">*</span> PLDR_DATA_TABLE_ENTRY<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre></pre></td></tr><tr><td data-num=\"27\"></td><td><pre></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>VOID <span class=\"token function\">DriverUnload</span><span class=\"token punctuation\">(</span>PDRIVER_OBJECT pdriver<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>\t<span class=\"token function\">DbgPrint</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"我是驱动，我卸载了\\n\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>NTSTATUS <span class=\"token function\">DriverEntry</span><span class=\"token punctuation\">(</span>PDRIVER_OBJECT pdriver<span class=\"token punctuation\">,</span> PUNICODE_STRING reg_path<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>\t<span class=\"token function\">DbgPrint</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"我是驱动，我运行了\\n\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>\tPLDR_DATA_TABLE_ENTRY pLdtePre<span class=\"token punctuation\">;</span> <span class=\"token comment\">// </span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>\tPLDR_DATA_TABLE_ENTRY pLdteCur<span class=\"token punctuation\">;</span> <span class=\"token comment\">// </span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>\tPLDR_DATA_TABLE_ENTRY pLdteNex<span class=\"token punctuation\">;</span> <span class=\"token comment\">// </span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>\tpLdteCur <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>PLDR_DATA_TABLE_ENTRY<span class=\"token punctuation\">)</span>pdriver<span class=\"token operator\">-></span>DriverSection<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>\tpLdtePre <span class=\"token operator\">=</span> pLdteCur<span class=\"token operator\">-></span>InLoadOrderLinks<span class=\"token punctuation\">.</span>Blink<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>\tpLdteNex <span class=\"token operator\">=</span> pLdteCur<span class=\"token operator\">-></span>InLoadOrderLinks<span class=\"token punctuation\">.</span>Flink<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>\tpLdtePre<span class=\"token operator\">-></span>InLoadOrderLinks<span class=\"token punctuation\">.</span>Flink <span class=\"token operator\">=</span> pLdteCur<span class=\"token operator\">-></span>InLoadOrderLinks<span class=\"token punctuation\">.</span>Flink<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>\tpLdteNex<span class=\"token operator\">-></span>InLoadOrderLinks<span class=\"token punctuation\">.</span>Blink <span class=\"token operator\">=</span> pLdteCur<span class=\"token operator\">-></span>InLoadOrderLinks<span class=\"token punctuation\">.</span>Blink<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre></pre></td></tr><tr><td data-num=\"45\"></td><td><pre></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>\tpdriver<span class=\"token operator\">-></span>DriverUnload <span class=\"token operator\">=</span> DriverUnload<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>\t<span class=\"token keyword\">return</span> STATUS_SUCCESS<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>可是在 PCHunter32 中依然可以查得到。</p>\n<p><img data-src=\"image001.png\" alt=\"\" /></p>\n<p>这是为什么呢？<br />\n这时我们就要去分析驱动是如何加载的了，在代码中下个断点，在 windbg 中查看堆栈，因为堆栈中有先前调用的函数的返回地址。</p>\n<figure class=\"highlight raw\"><figcaption data-lang=\"\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>kd&gt; k</pre></td></tr><tr><td data-num=\"2\"></td><td><pre> # ChildEBP RetAddr  </pre></td></tr><tr><td data-num=\"3\"></td><td><pre>00 ba503c84 805823af DriverHidden!DriverEntry+0xf [F:\\Text_Files\\Driver\\DriverHidden\\main.c @ 34] </pre></td></tr><tr><td data-num=\"4\"></td><td><pre>01 ba503d54 805824bf nt!IopLoadDriver+0x66d</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>02 ba503d7c 80539923 nt!IopLoadUnloadDriver+0x45</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>03 ba503dac 805d0fee nt!ExpWorkerThread+0xef</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>04 ba503ddc 8054720e nt!PspSystemThreadStartup+0x34</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>05 00000000 00000000 nt!KiThreadStartup+0x16</pre></td></tr></table></figure><p>发现驱动运行前，系统调用了  <code>IopLoadDriver</code>  函数。</p>\n<h1 id=\"逆向分析ioploaddriver函数\"><a class=\"anchor\" href=\"#逆向分析ioploaddriver函数\">#</a> 逆向分析 IopLoadDriver 函数</h1>\n<p>在 IDA 中逆向分析一下此函数，发现此函数的流程非常复杂：</p>\n<p><img data-src=\"image002.png\" alt=\"\" /></p>\n<p><code>F5</code>  一下</p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">int</span> __stdcall <span class=\"token function\">IopLoadDriver</span><span class=\"token punctuation\">(</span>HANDLE KeyHandle<span class=\"token punctuation\">,</span> <span class=\"token keyword\">char</span> a2<span class=\"token punctuation\">,</span> <span class=\"token keyword\">int</span> a3<span class=\"token punctuation\">,</span> <span class=\"token keyword\">int</span> a4<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  NTSTATUS v4<span class=\"token punctuation\">;</span> <span class=\"token comment\">// eax</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  <span class=\"token keyword\">unsigned</span> __int16 <span class=\"token operator\">*</span>v5<span class=\"token punctuation\">;</span> <span class=\"token comment\">// esi</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  <span class=\"token keyword\">unsigned</span> __int16 <span class=\"token operator\">*</span>v6<span class=\"token punctuation\">;</span> <span class=\"token comment\">// eax</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  <span class=\"token keyword\">int</span> i<span class=\"token punctuation\">;</span> <span class=\"token comment\">// edi</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  PVOID v8<span class=\"token punctuation\">;</span> <span class=\"token comment\">// esi</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  <span class=\"token keyword\">int</span> v10<span class=\"token punctuation\">;</span> <span class=\"token comment\">// eax</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  <span class=\"token keyword\">int</span> v11<span class=\"token punctuation\">;</span> <span class=\"token comment\">// eax</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  <span class=\"token keyword\">unsigned</span> __int16 <span class=\"token operator\">*</span>v12<span class=\"token punctuation\">;</span> <span class=\"token comment\">// esi</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  PIMAGE_NT_HEADERS v13<span class=\"token punctuation\">;</span> <span class=\"token comment\">// eax</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  <span class=\"token keyword\">char</span> <span class=\"token operator\">*</span>v14<span class=\"token punctuation\">;</span> <span class=\"token comment\">// ecx</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>  ULONG v15<span class=\"token punctuation\">;</span> <span class=\"token comment\">// edi</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>  <span class=\"token keyword\">unsigned</span> __int16 <span class=\"token operator\">*</span>v16<span class=\"token punctuation\">;</span> <span class=\"token comment\">// eax</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>  PVOID v17<span class=\"token punctuation\">;</span> <span class=\"token comment\">// eax</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>  <span class=\"token keyword\">int</span> v18<span class=\"token punctuation\">;</span> <span class=\"token comment\">// eax</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>  <span class=\"token keyword\">int</span> v19<span class=\"token punctuation\">;</span> <span class=\"token comment\">// eax</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>  _DWORD <span class=\"token operator\">*</span>v20<span class=\"token punctuation\">;</span> <span class=\"token comment\">// eax</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>  <span class=\"token keyword\">void</span> <span class=\"token punctuation\">(</span>__stdcall <span class=\"token operator\">*</span>v21<span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span>ULONG<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// eax</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>  <span class=\"token keyword\">int</span> v22<span class=\"token punctuation\">;</span> <span class=\"token comment\">// [esp+Ch] [ebp-B4h] BYREF</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>  <span class=\"token keyword\">int</span> v23<span class=\"token punctuation\">;</span> <span class=\"token comment\">// [esp+10h] [ebp-B0h]</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>  <span class=\"token keyword\">struct</span> <span class=\"token class-name\">_UNICODE_STRING</span> <span class=\"token operator\">*</span>v24<span class=\"token punctuation\">;</span> <span class=\"token comment\">// [esp+14h] [ebp-ACh]</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>  <span class=\"token keyword\">int</span> v25<span class=\"token punctuation\">;</span> <span class=\"token comment\">// [esp+18h] [ebp-A8h]</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>  <span class=\"token keyword\">int</span> v26<span class=\"token punctuation\">;</span> <span class=\"token comment\">// [esp+1Ch] [ebp-A4h]</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>  <span class=\"token keyword\">int</span> v27<span class=\"token punctuation\">;</span> <span class=\"token comment\">// [esp+20h] [ebp-A0h]</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>  ULONG v28<span class=\"token punctuation\">;</span> <span class=\"token comment\">// [esp+24h] [ebp-9Ch] BYREF</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>  PVOID v29<span class=\"token punctuation\">;</span> <span class=\"token comment\">// [esp+28h] [ebp-98h] BYREF</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>  PVOID v30<span class=\"token punctuation\">;</span> <span class=\"token comment\">// [esp+2Ch] [ebp-94h]</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>  PVOID Object<span class=\"token punctuation\">;</span> <span class=\"token comment\">// [esp+30h] [ebp-90h] BYREF</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>  <span class=\"token keyword\">struct</span> <span class=\"token class-name\">_UNICODE_STRING</span> v32<span class=\"token punctuation\">;</span> <span class=\"token comment\">// [esp+34h] [ebp-8Ch] BYREF</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>  <span class=\"token keyword\">struct</span> <span class=\"token class-name\">_UNICODE_STRING</span> DestinationString<span class=\"token punctuation\">;</span> <span class=\"token comment\">// [esp+3Ch] [ebp-84h] BYREF</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>  PVOID P<span class=\"token punctuation\">;</span> <span class=\"token comment\">// [esp+44h] [ebp-7Ch] BYREF</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>  ULONG ResultLength<span class=\"token punctuation\">;</span> <span class=\"token comment\">// [esp+48h] [ebp-78h] BYREF</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>  HANDLE Handle<span class=\"token punctuation\">;</span> <span class=\"token comment\">// [esp+4Ch] [ebp-74h]</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>  PVOID BaseAddress<span class=\"token punctuation\">;</span> <span class=\"token comment\">// [esp+50h] [ebp-70h] BYREF</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>  HANDLE v38<span class=\"token punctuation\">;</span> <span class=\"token comment\">// [esp+54h] [ebp-6Ch] BYREF</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>  <span class=\"token keyword\">int</span> v39<span class=\"token punctuation\">;</span> <span class=\"token comment\">// [esp+58h] [ebp-68h] BYREF</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>  PVOID v40<span class=\"token punctuation\">;</span> <span class=\"token comment\">// [esp+5Ch] [ebp-64h]</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>  ULONG ReturnLength<span class=\"token punctuation\">;</span> <span class=\"token comment\">// [esp+60h] [ebp-60h] BYREF</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>  <span class=\"token keyword\">struct</span> <span class=\"token class-name\">_UNICODE_STRING</span> Destination<span class=\"token punctuation\">;</span> <span class=\"token comment\">// [esp+64h] [ebp-5Ch] BYREF</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>  NTSTATUS v43<span class=\"token punctuation\">;</span> <span class=\"token comment\">// [esp+6Ch] [ebp-54h]</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>  <span class=\"token keyword\">int</span> KeyValueInformation<span class=\"token punctuation\">[</span><span class=\"token number\">20</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// [esp+70h] [ebp-50h] BYREF</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>  v29 <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>PVOID<span class=\"token punctuation\">)</span>a4<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>  <span class=\"token operator\">*</span><span class=\"token punctuation\">(</span>_DWORD <span class=\"token operator\">*</span><span class=\"token punctuation\">)</span>a4 <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>  Handle <span class=\"token operator\">=</span> KeyHandle<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>  v30 <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>  v39 <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>  v40 <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>  v32<span class=\"token punctuation\">.</span>Buffer <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>  Destination<span class=\"token punctuation\">.</span>Buffer <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre>  v4 <span class=\"token operator\">=</span> <span class=\"token function\">NtQueryKey</span><span class=\"token punctuation\">(</span>KeyHandle<span class=\"token punctuation\">,</span> KeyBasicInformation<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>ResultLength<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span> v4 <span class=\"token operator\">!=</span> <span class=\"token operator\">-</span><span class=\"token number\">2147483643</span> <span class=\"token operator\">&amp;&amp;</span> v4 <span class=\"token operator\">!=</span> <span class=\"token operator\">-</span><span class=\"token number\">1073741789</span> <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre>  <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre>    v43 <span class=\"token operator\">=</span> <span class=\"token operator\">-</span><span class=\"token number\">1073741472</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>LABEL_82<span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre>    <span class=\"token function\">HeadlessKernelAddLogEntry</span><span class=\"token punctuation\">(</span><span class=\"token number\">3</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre>    <span class=\"token keyword\">goto</span> LABEL_22<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"59\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre>  v5 <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">unsigned</span> __int16 <span class=\"token operator\">*</span><span class=\"token punctuation\">)</span><span class=\"token function\">ExAllocatePoolWithTag</span><span class=\"token punctuation\">(</span>NonPagedPool<span class=\"token punctuation\">,</span> ResultLength <span class=\"token operator\">+</span> <span class=\"token number\">8</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x20206F49u</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"61\"></td><td><pre>  v30 <span class=\"token operator\">=</span> v5<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"62\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span> <span class=\"token operator\">!</span>v5 <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"63\"></td><td><pre>  <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"64\"></td><td><pre>LABEL_60<span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"65\"></td><td><pre>    v43 <span class=\"token operator\">=</span> <span class=\"token operator\">-</span><span class=\"token number\">1073741670</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"66\"></td><td><pre>    <span class=\"token keyword\">goto</span> LABEL_82<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"67\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"68\"></td><td><pre>  v43 <span class=\"token operator\">=</span> <span class=\"token function\">NtQueryKey</span><span class=\"token punctuation\">(</span>Handle<span class=\"token punctuation\">,</span> KeyBasicInformation<span class=\"token punctuation\">,</span> v5<span class=\"token punctuation\">,</span> ResultLength<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>ResultLength<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"69\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span> v43 <span class=\"token operator\">>=</span> <span class=\"token number\">0</span> <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"70\"></td><td><pre>  <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"71\"></td><td><pre>    Destination<span class=\"token punctuation\">.</span>Length <span class=\"token operator\">=</span> v5<span class=\"token punctuation\">[</span><span class=\"token number\">6</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"72\"></td><td><pre>    Destination<span class=\"token punctuation\">.</span>MaximumLength <span class=\"token operator\">=</span> Destination<span class=\"token punctuation\">.</span>Length <span class=\"token operator\">+</span> <span class=\"token number\">8</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"73\"></td><td><pre>    Destination<span class=\"token punctuation\">.</span>Buffer <span class=\"token operator\">=</span> v5 <span class=\"token operator\">+</span> <span class=\"token number\">8</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"74\"></td><td><pre>    v6 <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">unsigned</span> __int16 <span class=\"token operator\">*</span><span class=\"token punctuation\">)</span><span class=\"token function\">ExAllocatePoolWithTag</span><span class=\"token punctuation\">(</span>PagedPool<span class=\"token punctuation\">,</span> Destination<span class=\"token punctuation\">.</span>Length <span class=\"token operator\">+</span> <span class=\"token number\">2</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x20206F49u</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"75\"></td><td><pre>    v40 <span class=\"token operator\">=</span> v6<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"76\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span> v6 <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"77\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"78\"></td><td><pre>      <span class=\"token function\">LOWORD</span><span class=\"token punctuation\">(</span>v39<span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span> Destination<span class=\"token punctuation\">.</span>Length<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"79\"></td><td><pre>      <span class=\"token function\">HIWORD</span><span class=\"token punctuation\">(</span>v39<span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span> Destination<span class=\"token punctuation\">.</span>Length <span class=\"token operator\">+</span> <span class=\"token number\">2</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"80\"></td><td><pre>      <span class=\"token function\">qmemcpy</span><span class=\"token punctuation\">(</span>v6<span class=\"token punctuation\">,</span> Destination<span class=\"token punctuation\">.</span>Buffer<span class=\"token punctuation\">,</span> Destination<span class=\"token punctuation\">.</span>Length<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"81\"></td><td><pre>      <span class=\"token operator\">*</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>_WORD <span class=\"token operator\">*</span><span class=\"token punctuation\">)</span>v40 <span class=\"token operator\">+</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">unsigned</span> __int16<span class=\"token punctuation\">)</span>v39 <span class=\"token operator\">>></span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"82\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"83\"></td><td><pre>    <span class=\"token function\">RtlAppendUnicodeToString</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>Destination<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>off_4A9CE2<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"84\"></td><td><pre>    <span class=\"token function\">HeadlessKernelAddLogEntry</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>Destination<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"85\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span> a2 <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"86\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"87\"></td><td><pre>      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span> InitSafeBootMode <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"88\"></td><td><pre>      <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"89\"></td><td><pre>        <span class=\"token function\">RtlInitUnicodeString</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>DestinationString<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>word_4A9CEE<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"90\"></td><td><pre>        <span class=\"token function\">memset</span><span class=\"token punctuation\">(</span>KeyValueInformation<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x4Cu</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"91\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span> <span class=\"token function\">NtQueryValueKey</span><span class=\"token punctuation\">(</span>Handle<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>DestinationString<span class=\"token punctuation\">,</span> KeyValuePartialInformation<span class=\"token punctuation\">,</span> KeyValueInformation<span class=\"token punctuation\">,</span> <span class=\"token number\">0x4Cu</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>v28<span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;</span> <span class=\"token number\">0</span></pre></td></tr><tr><td data-num=\"92\"></td><td><pre>          <span class=\"token operator\">||</span> <span class=\"token punctuation\">(</span>DestinationString<span class=\"token punctuation\">.</span>Length <span class=\"token operator\">=</span> <span class=\"token function\">LOWORD</span><span class=\"token punctuation\">(</span>KeyValueInformation<span class=\"token punctuation\">[</span><span class=\"token number\">2</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span> <span class=\"token number\">2</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"93\"></td><td><pre>              DestinationString<span class=\"token punctuation\">.</span>MaximumLength <span class=\"token operator\">=</span> <span class=\"token function\">LOWORD</span><span class=\"token punctuation\">(</span>KeyValueInformation<span class=\"token punctuation\">[</span><span class=\"token number\">2</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span> <span class=\"token number\">2</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"94\"></td><td><pre>              DestinationString<span class=\"token punctuation\">.</span>Buffer <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">unsigned</span> __int16 <span class=\"token operator\">*</span><span class=\"token punctuation\">)</span><span class=\"token operator\">&amp;</span>KeyValueInformation<span class=\"token punctuation\">[</span><span class=\"token number\">3</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"95\"></td><td><pre>              <span class=\"token operator\">!</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">unsigned</span> __int8<span class=\"token punctuation\">)</span><span class=\"token function\">IopSafebootDriverLoad</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>DestinationString<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"96\"></td><td><pre>        <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"97\"></td><td><pre>          <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span> <span class=\"token operator\">!</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">unsigned</span> __int8<span class=\"token punctuation\">)</span><span class=\"token function\">IopSafebootDriverLoad</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>Destination<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"98\"></td><td><pre>          <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"99\"></td><td><pre>            <span class=\"token function\">IopBootLog</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>Destination<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"100\"></td><td><pre>            <span class=\"token function\">DbgPrint</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"SAFEBOOT: skipping device = %wZ(%wZ)\\n\"</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>Destination<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>DestinationString<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"101\"></td><td><pre>            <span class=\"token function\">HeadlessKernelAddLogEntry</span><span class=\"token punctuation\">(</span><span class=\"token number\">2</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"102\"></td><td><pre>            <span class=\"token keyword\">return</span> <span class=\"token function\">xHalReferenceHandler</span><span class=\"token punctuation\">(</span>KeyValueInformation<span class=\"token punctuation\">[</span><span class=\"token number\">19</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> v22<span class=\"token punctuation\">,</span> v23<span class=\"token punctuation\">,</span> v24<span class=\"token punctuation\">,</span> v25<span class=\"token punctuation\">,</span> v26<span class=\"token punctuation\">,</span> v27<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"103\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"104\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"105\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"106\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"107\"></td><td><pre>    <span class=\"token function\">ExAcquireResourceSharedLite</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>PsLoadedModuleResource<span class=\"token punctuation\">,</span> <span class=\"token number\">1u</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"108\"></td><td><pre>    <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span> i <span class=\"token operator\">=</span> PsLoadedModuleList<span class=\"token punctuation\">;</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> <span class=\"token operator\">*</span><span class=\"token punctuation\">)</span>i <span class=\"token operator\">!=</span> <span class=\"token operator\">&amp;</span>PsLoadedModuleList<span class=\"token punctuation\">;</span> i <span class=\"token operator\">=</span> <span class=\"token operator\">*</span><span class=\"token punctuation\">(</span>_DWORD <span class=\"token operator\">*</span><span class=\"token punctuation\">)</span>i <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"109\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"110\"></td><td><pre>      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span> <span class=\"token function\">RtlEqualString</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">const</span> STRING <span class=\"token operator\">*</span><span class=\"token punctuation\">)</span><span class=\"token operator\">&amp;</span>Destination<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">const</span> STRING <span class=\"token operator\">*</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span>i <span class=\"token operator\">+</span> <span class=\"token number\">36</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1u</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"111\"></td><td><pre>      <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"112\"></td><td><pre>        v43 <span class=\"token operator\">=</span> <span class=\"token operator\">-</span><span class=\"token number\">1073741554</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"113\"></td><td><pre>        <span class=\"token function\">ExReleaseResourceLite</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>PsLoadedModuleResource<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"114\"></td><td><pre>        <span class=\"token function\">IopBootLog</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>Destination<span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"115\"></td><td><pre>        Destination<span class=\"token punctuation\">.</span>Buffer <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"116\"></td><td><pre>        <span class=\"token keyword\">goto</span> LABEL_21<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"117\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"118\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"119\"></td><td><pre>    <span class=\"token function\">ExReleaseResourceLite</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>PsLoadedModuleResource<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"120\"></td><td><pre>    v43 <span class=\"token operator\">=</span> <span class=\"token function\">IopBuildFullDriverPath</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span><span class=\"token punctuation\">)</span><span class=\"token operator\">&amp;</span>v39<span class=\"token punctuation\">,</span> Handle<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span><span class=\"token punctuation\">)</span><span class=\"token operator\">&amp;</span>Destination<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"121\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span> v43 <span class=\"token operator\">&lt;</span> <span class=\"token number\">0</span> <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"122\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"123\"></td><td><pre>      Destination<span class=\"token punctuation\">.</span>Buffer <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"124\"></td><td><pre>      <span class=\"token keyword\">goto</span> LABEL_80<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"125\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"126\"></td><td><pre>    v43 <span class=\"token operator\">=</span> <span class=\"token function\">IopGetDriverNameFromKeyNode</span><span class=\"token punctuation\">(</span>Handle<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>v32<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"127\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span> v43 <span class=\"token operator\">>=</span> <span class=\"token number\">0</span> <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"128\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"129\"></td><td><pre>      v24 <span class=\"token operator\">=</span> <span class=\"token operator\">&amp;</span>v32<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"130\"></td><td><pre>      v22 <span class=\"token operator\">=</span> <span class=\"token number\">24</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"131\"></td><td><pre>      v23 <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"132\"></td><td><pre>      v25 <span class=\"token operator\">=</span> <span class=\"token number\">16</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"133\"></td><td><pre>      v26 <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"134\"></td><td><pre>      v27 <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"135\"></td><td><pre>      v10 <span class=\"token operator\">=</span> <span class=\"token function\">MmLoadSystemImage</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>ULONG<span class=\"token punctuation\">)</span><span class=\"token operator\">&amp;</span>Destination<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span><span class=\"token punctuation\">)</span><span class=\"token operator\">&amp;</span>P<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span><span class=\"token punctuation\">)</span><span class=\"token operator\">&amp;</span>BaseAddress<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"136\"></td><td><pre>      v43 <span class=\"token operator\">=</span> v10<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"137\"></td><td><pre>      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span> v10 <span class=\"token operator\">&lt;</span> <span class=\"token number\">0</span> <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"138\"></td><td><pre>      <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"139\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span> v10 <span class=\"token operator\">==</span> <span class=\"token operator\">-</span><span class=\"token number\">1073741554</span> <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"140\"></td><td><pre>        <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"141\"></td><td><pre>          v43 <span class=\"token operator\">=</span> <span class=\"token function\">ObOpenObjectByName</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span><span class=\"token punctuation\">)</span><span class=\"token operator\">&amp;</span>v22<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span><span class=\"token punctuation\">)</span>IoDriverObjectType<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span><span class=\"token punctuation\">)</span><span class=\"token operator\">&amp;</span>v38<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"142\"></td><td><pre>          <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span> v43 <span class=\"token operator\">&lt;</span> <span class=\"token number\">0</span> <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"143\"></td><td><pre>          <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"144\"></td><td><pre>            <span class=\"token function\">IopBootLog</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>Destination<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"145\"></td><td><pre>            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span> v43 <span class=\"token operator\">==</span> <span class=\"token operator\">-</span><span class=\"token number\">1073741772</span> <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"146\"></td><td><pre>              v43 <span class=\"token operator\">=</span> <span class=\"token operator\">-</span><span class=\"token number\">1073740914</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"147\"></td><td><pre>LABEL_80<span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"148\"></td><td><pre>            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span> v43 <span class=\"token operator\">>=</span> <span class=\"token number\">0</span> <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"149\"></td><td><pre>              <span class=\"token keyword\">goto</span> LABEL_21<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"150\"></td><td><pre>            <span class=\"token keyword\">goto</span> LABEL_81<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"151\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"152\"></td><td><pre>          <span class=\"token function\">LOBYTE</span><span class=\"token punctuation\">(</span>DestinationString<span class=\"token punctuation\">.</span>Buffer<span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span> <span class=\"token function\">KeGetCurrentThread</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">-></span>PreviousMode<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"153\"></td><td><pre>          v43 <span class=\"token operator\">=</span> <span class=\"token function\">ObReferenceObjectByHandle</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"154\"></td><td><pre>                  v38<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"155\"></td><td><pre>                  <span class=\"token number\">0</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"156\"></td><td><pre>                  IoDriverObjectType<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"157\"></td><td><pre>                  <span class=\"token punctuation\">(</span>KPROCESSOR_MODE<span class=\"token punctuation\">)</span>DestinationString<span class=\"token punctuation\">.</span>Buffer<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"158\"></td><td><pre>                  <span class=\"token operator\">&amp;</span>Object<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"159\"></td><td><pre>                  <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"160\"></td><td><pre>          <span class=\"token function\">NtClose</span><span class=\"token punctuation\">(</span>v38<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"161\"></td><td><pre>          <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span> v43 <span class=\"token operator\">>=</span> <span class=\"token number\">0</span> <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"162\"></td><td><pre>          <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"163\"></td><td><pre>            v43 <span class=\"token operator\">=</span> <span class=\"token function\">IopResurrectDriver</span><span class=\"token punctuation\">(</span>Object<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"164\"></td><td><pre>            <span class=\"token function\">ObfDereferenceObject</span><span class=\"token punctuation\">(</span>Object<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"165\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"166\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"167\"></td><td><pre>LABEL_55<span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"168\"></td><td><pre>        <span class=\"token function\">IopBootLog</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>Destination<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"169\"></td><td><pre>        <span class=\"token keyword\">goto</span> LABEL_80<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"170\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"171\"></td><td><pre>      <span class=\"token function\">RtlImageNtHeader</span><span class=\"token punctuation\">(</span>BaseAddress<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"172\"></td><td><pre>      v43 <span class=\"token operator\">=</span> <span class=\"token function\">IopPrepareDriverLoading</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span><span class=\"token punctuation\">)</span><span class=\"token operator\">&amp;</span>v39<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span><span class=\"token punctuation\">)</span>Handle<span class=\"token punctuation\">,</span> BaseAddress<span class=\"token punctuation\">,</span> a3<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"173\"></td><td><pre>      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span> v43 <span class=\"token operator\">&lt;</span> <span class=\"token number\">0</span> <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"174\"></td><td><pre>      <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"175\"></td><td><pre>        <span class=\"token function\">MmUnloadSystemImage</span><span class=\"token punctuation\">(</span>P<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"176\"></td><td><pre>        <span class=\"token keyword\">goto</span> LABEL_55<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"177\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"178\"></td><td><pre>      <span class=\"token function\">LOBYTE</span><span class=\"token punctuation\">(</span>DestinationString<span class=\"token punctuation\">.</span>Buffer<span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span> <span class=\"token function\">KeGetCurrentThread</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">-></span>PreviousMode<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"179\"></td><td><pre>      v11 <span class=\"token operator\">=</span> <span class=\"token function\">ObCreateObject</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"180\"></td><td><pre>              <span class=\"token punctuation\">(</span>KPROCESSOR_MODE<span class=\"token punctuation\">)</span>DestinationString<span class=\"token punctuation\">.</span>Buffer<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"181\"></td><td><pre>              <span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span><span class=\"token punctuation\">)</span>IoDriverObjectType<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"182\"></td><td><pre>              <span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span><span class=\"token punctuation\">)</span><span class=\"token operator\">&amp;</span>v22<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"183\"></td><td><pre>              <span class=\"token number\">0</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"184\"></td><td><pre>              <span class=\"token number\">0</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"185\"></td><td><pre>              <span class=\"token number\">196</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"186\"></td><td><pre>              <span class=\"token number\">0</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"187\"></td><td><pre>              <span class=\"token number\">0</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"188\"></td><td><pre>              <span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span><span class=\"token punctuation\">)</span><span class=\"token operator\">&amp;</span>DestinationString<span class=\"token punctuation\">.</span>Buffer<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"189\"></td><td><pre>      v12 <span class=\"token operator\">=</span> DestinationString<span class=\"token punctuation\">.</span>Buffer<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"190\"></td><td><pre>      v43 <span class=\"token operator\">=</span> v11<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"191\"></td><td><pre>      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span> v11 <span class=\"token operator\">&lt;</span> <span class=\"token number\">0</span> <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"192\"></td><td><pre>        <span class=\"token keyword\">goto</span> LABEL_55<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"193\"></td><td><pre>      <span class=\"token function\">memset</span><span class=\"token punctuation\">(</span>DestinationString<span class=\"token punctuation\">.</span>Buffer<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0xC4u</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"194\"></td><td><pre>      <span class=\"token operator\">*</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>_DWORD <span class=\"token operator\">*</span><span class=\"token punctuation\">)</span>v12 <span class=\"token operator\">+</span> <span class=\"token number\">6</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span> v12 <span class=\"token operator\">+</span> <span class=\"token number\">84</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"195\"></td><td><pre>      <span class=\"token operator\">*</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>_DWORD <span class=\"token operator\">*</span><span class=\"token punctuation\">)</span>v12 <span class=\"token operator\">+</span> <span class=\"token number\">42</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span> v12<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"196\"></td><td><pre>      <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span> ReturnLength <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> ReturnLength <span class=\"token operator\">&lt;=</span> <span class=\"token number\">0x1B</span><span class=\"token punctuation\">;</span> <span class=\"token operator\">++</span>ReturnLength <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"197\"></td><td><pre>        <span class=\"token operator\">*</span><span class=\"token punctuation\">(</span>_DWORD <span class=\"token operator\">*</span><span class=\"token punctuation\">)</span><span class=\"token operator\">&amp;</span>v12<span class=\"token punctuation\">[</span><span class=\"token number\">2</span> <span class=\"token operator\">*</span> ReturnLength <span class=\"token operator\">+</span> <span class=\"token number\">28</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> IopInvalidDeviceRequest<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"198\"></td><td><pre>      <span class=\"token operator\">*</span>v12 <span class=\"token operator\">=</span> <span class=\"token number\">4</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"199\"></td><td><pre>      v12<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token number\">168</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"200\"></td><td><pre>      v13 <span class=\"token operator\">=</span> <span class=\"token function\">RtlImageNtHeader</span><span class=\"token punctuation\">(</span>BaseAddress<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"201\"></td><td><pre>      v14 <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">char</span> <span class=\"token operator\">*</span><span class=\"token punctuation\">)</span>BaseAddress <span class=\"token operator\">+</span> v13<span class=\"token operator\">-></span>OptionalHeader<span class=\"token punctuation\">.</span>AddressOfEntryPoint<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"202\"></td><td><pre>      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span> <span class=\"token punctuation\">(</span>v13<span class=\"token operator\">-></span>OptionalHeader<span class=\"token punctuation\">.</span>DllCharacteristics <span class=\"token operator\">&amp;</span> <span class=\"token number\">0x2000</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> <span class=\"token number\">0</span> <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"203\"></td><td><pre>        <span class=\"token operator\">*</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>_DWORD <span class=\"token operator\">*</span><span class=\"token punctuation\">)</span>v12 <span class=\"token operator\">+</span> <span class=\"token number\">2</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">|=</span> <span class=\"token number\">2u</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"204\"></td><td><pre>      <span class=\"token operator\">*</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>_DWORD <span class=\"token operator\">*</span><span class=\"token punctuation\">)</span>v12 <span class=\"token operator\">+</span> <span class=\"token number\">11</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span> v14<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"205\"></td><td><pre>      <span class=\"token operator\">*</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>_DWORD <span class=\"token operator\">*</span><span class=\"token punctuation\">)</span>v12 <span class=\"token operator\">+</span> <span class=\"token number\">5</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span> P<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"206\"></td><td><pre>      <span class=\"token operator\">*</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>_DWORD <span class=\"token operator\">*</span><span class=\"token punctuation\">)</span>v12 <span class=\"token operator\">+</span> <span class=\"token number\">3</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span> BaseAddress<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"207\"></td><td><pre>      <span class=\"token operator\">*</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>_DWORD <span class=\"token operator\">*</span><span class=\"token punctuation\">)</span>v12 <span class=\"token operator\">+</span> <span class=\"token number\">4</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span> v13<span class=\"token operator\">-></span>OptionalHeader<span class=\"token punctuation\">.</span>SizeOfImage<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"208\"></td><td><pre>      v43 <span class=\"token operator\">=</span> <span class=\"token function\">ObInsertObject</span><span class=\"token punctuation\">(</span>v12<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1u</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>v38<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"209\"></td><td><pre>      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span> v43 <span class=\"token operator\">&lt;</span> <span class=\"token number\">0</span> <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"210\"></td><td><pre>        <span class=\"token keyword\">goto</span> LABEL_55<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"211\"></td><td><pre>      <span class=\"token function\">ObReferenceObjectByHandle</span><span class=\"token punctuation\">(</span>v38<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> IoDriverObjectType<span class=\"token punctuation\">,</span> <span class=\"token function\">KeGetCurrentThread</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">-></span>PreviousMode<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span>PVOID <span class=\"token operator\">*</span><span class=\"token punctuation\">)</span><span class=\"token operator\">&amp;</span>v28<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"212\"></td><td><pre>      v15 <span class=\"token operator\">=</span> v28<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"213\"></td><td><pre>      DestinationString<span class=\"token punctuation\">.</span>Buffer <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">unsigned</span> __int16 <span class=\"token operator\">*</span><span class=\"token punctuation\">)</span>v28<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"214\"></td><td><pre>      <span class=\"token function\">NtClose</span><span class=\"token punctuation\">(</span>v38<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"215\"></td><td><pre>      <span class=\"token operator\">*</span><span class=\"token punctuation\">(</span>_DWORD <span class=\"token operator\">*</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span>v15 <span class=\"token operator\">+</span> <span class=\"token number\">36</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span> <span class=\"token operator\">&amp;</span>CmRegistryMachineHardwareDescriptionSystemName<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"216\"></td><td><pre>      v16 <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">unsigned</span> __int16 <span class=\"token operator\">*</span><span class=\"token punctuation\">)</span><span class=\"token function\">ExAllocatePoolWithTag</span><span class=\"token punctuation\">(</span>PagedPool<span class=\"token punctuation\">,</span> v32<span class=\"token punctuation\">.</span>MaximumLength<span class=\"token punctuation\">,</span> <span class=\"token number\">0x20206F49u</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"217\"></td><td><pre>      <span class=\"token operator\">*</span><span class=\"token punctuation\">(</span>_DWORD <span class=\"token operator\">*</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span>v15 <span class=\"token operator\">+</span> <span class=\"token number\">32</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span> v16<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"218\"></td><td><pre>      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span> v16 <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"219\"></td><td><pre>      <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"220\"></td><td><pre>        <span class=\"token operator\">*</span><span class=\"token punctuation\">(</span>_WORD <span class=\"token operator\">*</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span>v15 <span class=\"token operator\">+</span> <span class=\"token number\">30</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span> v32<span class=\"token punctuation\">.</span>MaximumLength<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"221\"></td><td><pre>        <span class=\"token operator\">*</span><span class=\"token punctuation\">(</span>_WORD <span class=\"token operator\">*</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span>v15 <span class=\"token operator\">+</span> <span class=\"token number\">28</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span> v32<span class=\"token punctuation\">.</span>Length<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"222\"></td><td><pre>        <span class=\"token function\">qmemcpy</span><span class=\"token punctuation\">(</span>v16<span class=\"token punctuation\">,</span> v32<span class=\"token punctuation\">.</span>Buffer<span class=\"token punctuation\">,</span> v32<span class=\"token punctuation\">.</span>MaximumLength<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"223\"></td><td><pre>        v15 <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>ULONG<span class=\"token punctuation\">)</span>DestinationString<span class=\"token punctuation\">.</span>Buffer<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"224\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"225\"></td><td><pre>      v17 <span class=\"token operator\">=</span> <span class=\"token function\">ExAllocatePoolWithTag</span><span class=\"token punctuation\">(</span>NonPagedPool<span class=\"token punctuation\">,</span> <span class=\"token number\">0x1000u</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x20206F49u</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"226\"></td><td><pre>      Object <span class=\"token operator\">=</span> v17<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"227\"></td><td><pre>      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span> <span class=\"token operator\">!</span>v17 <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"228\"></td><td><pre>      <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"229\"></td><td><pre>        <span class=\"token function\">ObMakeTemporaryObject</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>PVOID<span class=\"token punctuation\">)</span>v15<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"230\"></td><td><pre>        <span class=\"token function\">ObfDereferenceObject</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>PVOID<span class=\"token punctuation\">)</span>v15<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"231\"></td><td><pre>        <span class=\"token keyword\">goto</span> LABEL_60<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"232\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"233\"></td><td><pre>      v43 <span class=\"token operator\">=</span> <span class=\"token function\">NtQueryObject</span><span class=\"token punctuation\">(</span>Handle<span class=\"token punctuation\">,</span> ObjectNameInformation<span class=\"token punctuation\">,</span> v17<span class=\"token punctuation\">,</span> <span class=\"token number\">0x1000u</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>ReturnLength<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"234\"></td><td><pre>      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span> v43 <span class=\"token operator\">&lt;</span> <span class=\"token number\">0</span> <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"235\"></td><td><pre>      <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"236\"></td><td><pre>        <span class=\"token function\">ObMakeTemporaryObject</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>PVOID<span class=\"token punctuation\">)</span>v15<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"237\"></td><td><pre>        <span class=\"token function\">ObfDereferenceObject</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>PVOID<span class=\"token punctuation\">)</span>v15<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"238\"></td><td><pre>        <span class=\"token function\">ExFreePoolWithTag</span><span class=\"token punctuation\">(</span>Object<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"239\"></td><td><pre>        <span class=\"token keyword\">goto</span> LABEL_80<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"240\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"241\"></td><td><pre>      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span> v40 <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"242\"></td><td><pre>      <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"243\"></td><td><pre>        <span class=\"token operator\">*</span><span class=\"token punctuation\">(</span>_DWORD <span class=\"token operator\">*</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span><span class=\"token operator\">*</span><span class=\"token punctuation\">(</span>_DWORD <span class=\"token operator\">*</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span>v15 <span class=\"token operator\">+</span> <span class=\"token number\">24</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> <span class=\"token number\">16</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span> <span class=\"token function\">ExAllocatePoolWithTag</span><span class=\"token punctuation\">(</span>NonPagedPool<span class=\"token punctuation\">,</span> <span class=\"token function\">HIWORD</span><span class=\"token punctuation\">(</span>v39<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x20206F49u</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"244\"></td><td><pre>        v18 <span class=\"token operator\">=</span> <span class=\"token operator\">*</span><span class=\"token punctuation\">(</span>_DWORD <span class=\"token operator\">*</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span>v15 <span class=\"token operator\">+</span> <span class=\"token number\">24</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"245\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span> <span class=\"token operator\">*</span><span class=\"token punctuation\">(</span>_DWORD <span class=\"token operator\">*</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span>v18 <span class=\"token operator\">+</span> <span class=\"token number\">16</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"246\"></td><td><pre>        <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"247\"></td><td><pre>          <span class=\"token operator\">*</span><span class=\"token punctuation\">(</span>_WORD <span class=\"token operator\">*</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span>v18 <span class=\"token operator\">+</span> <span class=\"token number\">14</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span> <span class=\"token function\">HIWORD</span><span class=\"token punctuation\">(</span>v39<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"248\"></td><td><pre>          <span class=\"token operator\">*</span><span class=\"token punctuation\">(</span>_WORD <span class=\"token operator\">*</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span><span class=\"token operator\">*</span><span class=\"token punctuation\">(</span>_DWORD <span class=\"token operator\">*</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span>v15 <span class=\"token operator\">+</span> <span class=\"token number\">24</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> <span class=\"token number\">12</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span> v39<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"249\"></td><td><pre>          <span class=\"token function\">qmemcpy</span><span class=\"token punctuation\">(</span><span class=\"token operator\">*</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">void</span> <span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span><span class=\"token operator\">*</span><span class=\"token punctuation\">(</span>_DWORD <span class=\"token operator\">*</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span>v15 <span class=\"token operator\">+</span> <span class=\"token number\">24</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> <span class=\"token number\">16</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> v40<span class=\"token punctuation\">,</span> <span class=\"token function\">HIWORD</span><span class=\"token punctuation\">(</span>v39<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"250\"></td><td><pre>          v15 <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>ULONG<span class=\"token punctuation\">)</span>DestinationString<span class=\"token punctuation\">.</span>Buffer<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"251\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"252\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"253\"></td><td><pre>      v19 <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">*</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> <span class=\"token punctuation\">(</span>__stdcall <span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span>ULONG<span class=\"token punctuation\">,</span> PVOID<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span>v15 <span class=\"token operator\">+</span> <span class=\"token number\">44</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span>v15<span class=\"token punctuation\">,</span> Object<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"254\"></td><td><pre>      v43 <span class=\"token operator\">=</span> v19<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"255\"></td><td><pre>      <span class=\"token operator\">*</span><span class=\"token punctuation\">(</span>_DWORD <span class=\"token operator\">*</span><span class=\"token punctuation\">)</span>v29 <span class=\"token operator\">=</span> v19<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"256\"></td><td><pre>      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span> v19 <span class=\"token operator\">&lt;</span> <span class=\"token number\">0</span> <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"257\"></td><td><pre>        v43 <span class=\"token operator\">=</span> <span class=\"token operator\">-</span><span class=\"token number\">1073740955</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"258\"></td><td><pre>      <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span> ReturnLength <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> ReturnLength <span class=\"token operator\">&lt;=</span> <span class=\"token number\">0x1B</span><span class=\"token punctuation\">;</span> <span class=\"token operator\">++</span>ReturnLength <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"259\"></td><td><pre>      <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"260\"></td><td><pre>        v20 <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>_DWORD <span class=\"token operator\">*</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span>v15 <span class=\"token operator\">+</span> <span class=\"token number\">4</span> <span class=\"token operator\">*</span> ReturnLength <span class=\"token operator\">+</span> <span class=\"token number\">56</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"261\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span> <span class=\"token operator\">!</span><span class=\"token operator\">*</span>v20 <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"262\"></td><td><pre>          <span class=\"token operator\">*</span>v20 <span class=\"token operator\">=</span> IopInvalidDeviceRequest<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"263\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"264\"></td><td><pre>      <span class=\"token function\">ExFreePoolWithTag</span><span class=\"token punctuation\">(</span>Object<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"265\"></td><td><pre>      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span> v43 <span class=\"token operator\">&lt;</span> <span class=\"token number\">0</span> <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"266\"></td><td><pre>      <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"267\"></td><td><pre>LABEL_78<span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"268\"></td><td><pre>        <span class=\"token function\">ObMakeTemporaryObject</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>PVOID<span class=\"token punctuation\">)</span>v15<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"269\"></td><td><pre>        <span class=\"token function\">ObfDereferenceObject</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>PVOID<span class=\"token punctuation\">)</span>v15<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"270\"></td><td><pre>        <span class=\"token keyword\">goto</span> LABEL_80<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"271\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"272\"></td><td><pre>      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span> <span class=\"token operator\">!</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">unsigned</span> __int8<span class=\"token punctuation\">)</span><span class=\"token function\">IopIsLegacyDriver</span><span class=\"token punctuation\">(</span>v15<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"273\"></td><td><pre>      <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"274\"></td><td><pre>        v43 <span class=\"token operator\">=</span> <span class=\"token function\">IopPnpDriverStarted</span><span class=\"token punctuation\">(</span>v15<span class=\"token punctuation\">,</span> Handle<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>v39<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"275\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span> v43 <span class=\"token operator\">>=</span> <span class=\"token number\">0</span> <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"276\"></td><td><pre>          <span class=\"token keyword\">goto</span> LABEL_79<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"277\"></td><td><pre>        v21 <span class=\"token operator\">=</span> <span class=\"token operator\">*</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">void</span> <span class=\"token punctuation\">(</span>__stdcall <span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span>ULONG<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span>v15 <span class=\"token operator\">+</span> <span class=\"token number\">52</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"278\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span> v21 <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"279\"></td><td><pre>        <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"280\"></td><td><pre>          <span class=\"token operator\">*</span><span class=\"token punctuation\">(</span>_DWORD <span class=\"token operator\">*</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span>v15 <span class=\"token operator\">+</span> <span class=\"token number\">8</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">|=</span> <span class=\"token number\">1u</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"281\"></td><td><pre>          <span class=\"token function\">v21</span><span class=\"token punctuation\">(</span>v15<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"282\"></td><td><pre>          <span class=\"token function\">IopBootLog</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>Destination<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"283\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"284\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"285\"></td><td><pre>      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span> v43 <span class=\"token operator\">&lt;</span> <span class=\"token number\">0</span> <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"286\"></td><td><pre>        <span class=\"token keyword\">goto</span> LABEL_78<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"287\"></td><td><pre>LABEL_79<span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"288\"></td><td><pre>      <span class=\"token function\">IopBootLog</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>Destination<span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"289\"></td><td><pre>      <span class=\"token function\">MmFreeDriverInitialization</span><span class=\"token punctuation\">(</span><span class=\"token operator\">*</span><span class=\"token punctuation\">(</span>_DWORD <span class=\"token operator\">*</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span>v15 <span class=\"token operator\">+</span> <span class=\"token number\">20</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"290\"></td><td><pre>      <span class=\"token function\">IopReadyDeviceObjects</span><span class=\"token punctuation\">(</span>v15<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"291\"></td><td><pre>      <span class=\"token keyword\">goto</span> LABEL_80<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"292\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"293\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"294\"></td><td><pre>LABEL_81<span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"295\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span> v43 <span class=\"token operator\">!=</span> <span class=\"token operator\">-</span><span class=\"token number\">1073741554</span> <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"296\"></td><td><pre>    <span class=\"token keyword\">goto</span> LABEL_82<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"297\"></td><td><pre>LABEL_21<span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"298\"></td><td><pre>  <span class=\"token function\">HeadlessKernelAddLogEntry</span><span class=\"token punctuation\">(</span><span class=\"token number\">2</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"299\"></td><td><pre>LABEL_22<span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"300\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span> v32<span class=\"token punctuation\">.</span>Buffer <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"301\"></td><td><pre>    <span class=\"token function\">ExFreePoolWithTag</span><span class=\"token punctuation\">(</span>v32<span class=\"token punctuation\">.</span>Buffer<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"302\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span> v30 <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"303\"></td><td><pre>    <span class=\"token function\">ExFreePoolWithTag</span><span class=\"token punctuation\">(</span>v30<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"304\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span> v40 <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"305\"></td><td><pre>    <span class=\"token function\">ExFreePoolWithTag</span><span class=\"token punctuation\">(</span>v40<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"306\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span> Destination<span class=\"token punctuation\">.</span>Buffer <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"307\"></td><td><pre>    <span class=\"token function\">ExFreePoolWithTag</span><span class=\"token punctuation\">(</span>Destination<span class=\"token punctuation\">.</span>Buffer<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"308\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span> v43 <span class=\"token operator\">&lt;</span> <span class=\"token number\">0</span> <span class=\"token operator\">&amp;&amp;</span> v43 <span class=\"token operator\">!=</span> <span class=\"token operator\">-</span><span class=\"token number\">1073741218</span> <span class=\"token operator\">&amp;&amp;</span> v43 <span class=\"token operator\">!=</span> <span class=\"token operator\">-</span><span class=\"token number\">1073741554</span> <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"309\"></td><td><pre>  <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"310\"></td><td><pre>    <span class=\"token function\">IopDriverLoadingFailed</span><span class=\"token punctuation\">(</span>Handle<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"311\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span> <span class=\"token function\">IopGetRegistryValue</span><span class=\"token punctuation\">(</span>Handle<span class=\"token punctuation\">,</span> <span class=\"token string\">\"E\"</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span><span class=\"token punctuation\">)</span><span class=\"token operator\">&amp;</span>v29<span class=\"token punctuation\">)</span> <span class=\"token operator\">>=</span> <span class=\"token number\">0</span> <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"312\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"313\"></td><td><pre>      v8 <span class=\"token operator\">=</span> v29<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"314\"></td><td><pre>      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span> <span class=\"token operator\">*</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>_DWORD <span class=\"token operator\">*</span><span class=\"token punctuation\">)</span>v29 <span class=\"token operator\">+</span> <span class=\"token number\">3</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"315\"></td><td><pre>        <span class=\"token function\">CmBootLastKnownGood</span><span class=\"token punctuation\">(</span><span class=\"token operator\">*</span><span class=\"token punctuation\">(</span>_DWORD <span class=\"token operator\">*</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">char</span> <span class=\"token operator\">*</span><span class=\"token punctuation\">)</span>v29 <span class=\"token operator\">+</span> <span class=\"token operator\">*</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>_DWORD <span class=\"token operator\">*</span><span class=\"token punctuation\">)</span>v29 <span class=\"token operator\">+</span> <span class=\"token number\">2</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"316\"></td><td><pre>      <span class=\"token function\">ExFreePoolWithTag</span><span class=\"token punctuation\">(</span>v8<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"317\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"318\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"319\"></td><td><pre>  <span class=\"token function\">ObCloseHandle</span><span class=\"token punctuation\">(</span>Handle<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"320\"></td><td><pre>  <span class=\"token keyword\">return</span> <span class=\"token function\">xHalReferenceHandler</span><span class=\"token punctuation\">(</span>KeyValueInformation<span class=\"token punctuation\">[</span><span class=\"token number\">19</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> v22<span class=\"token punctuation\">,</span> v23<span class=\"token punctuation\">,</span> v24<span class=\"token punctuation\">,</span> v25<span class=\"token punctuation\">,</span> v26<span class=\"token punctuation\">,</span> v27<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"321\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>对于如此复杂的内核函数，我们可以参考 WRK 源码进行分析，分析发现其实和 WRK 的源码几乎是一样的</p>\n<p>WRK 中  <code>IopLoadDriver</code>  源码</p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>NTSTATUS</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token function\">IopLoadDriver</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    IN  HANDLE      KeyHandle<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    IN  BOOLEAN     CheckForSafeBoot<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    IN  BOOLEAN     IsFilter<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    OUT NTSTATUS   <span class=\"token operator\">*</span>DriverEntryStatus</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token comment\">/*++</pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>Routine Description:</pre></td></tr><tr><td data-num=\"11\"></td><td><pre></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    This routine is invoked to load a device or file system driver, either</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    during system initialization, or dynamically while the system is running.</pre></td></tr><tr><td data-num=\"14\"></td><td><pre></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>Arguments:</pre></td></tr><tr><td data-num=\"16\"></td><td><pre></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    KeyHandle - Supplies a handle to the driver service node in the registry</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>        that describes the driver to be loaded.</pre></td></tr><tr><td data-num=\"19\"></td><td><pre></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>    IsFilter - TRUE if the driver is a WDM filter, FALSE otherwise.</pre></td></tr><tr><td data-num=\"21\"></td><td><pre></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>    CheckForSafeBoot - If TRUE, the driver will be loaded only if it belongs</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>                       to the list of safe mode OK binaries.</pre></td></tr><tr><td data-num=\"24\"></td><td><pre></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>    DriverEntryStatus - Receives status returned by DriverEntry(...)</pre></td></tr><tr><td data-num=\"26\"></td><td><pre></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>Return Value:</pre></td></tr><tr><td data-num=\"28\"></td><td><pre></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>    The function value is the final status of the load operation. If</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>    STATUS_FAILED_DRIVER_ENTRY is returned, the driver's return value</pre></td></tr><tr><td data-num=\"31\"></td><td><pre>    is stored in DriverEntryStatus.</pre></td></tr><tr><td data-num=\"32\"></td><td><pre></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>Notes:</pre></td></tr><tr><td data-num=\"34\"></td><td><pre></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>    Note that this routine closes the KeyHandle before returning.</pre></td></tr><tr><td data-num=\"36\"></td><td><pre></pre></td></tr><tr><td data-num=\"37\"></td><td><pre></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>--*/</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>    NTSTATUS status<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>    PLIST_ENTRY nextEntry<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>    PKLDR_DATA_TABLE_ENTRY driverEntry<span class=\"token punctuation\">;</span>    </pre></td></tr><tr><td data-num=\"43\"></td><td><pre>    PKEY_BASIC_INFORMATION keyBasicInformation <span class=\"token operator\">=</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>    ULONG keyBasicLength<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>    UNICODE_STRING baseName<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>    UNICODE_STRING serviceName <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>    OBJECT_ATTRIBUTES objectAttributes<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>    PVOID sectionPointer<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>    UNICODE_STRING driverName<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>    PDRIVER_OBJECT driverObject<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>    PIMAGE_NT_HEADERS ntHeaders<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre>    PVOID imageBaseAddress<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>    ULONG_PTR entryPoint<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre>    HANDLE driverHandle<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre>    ULONG i<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>    POBJECT_NAME_INFORMATION registryPath<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">if</span> <span class=\"token expression\">DBG</span></span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre>    LARGE_INTEGER stime<span class=\"token punctuation\">,</span> etime<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"59\"></td><td><pre>    ULONG dtime<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">endif</span></span></pre></td></tr><tr><td data-num=\"61\"></td><td><pre></pre></td></tr><tr><td data-num=\"62\"></td><td><pre>    <span class=\"token function\">PAGED_CODE</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"63\"></td><td><pre></pre></td></tr><tr><td data-num=\"64\"></td><td><pre>    driverName<span class=\"token punctuation\">.</span>Buffer <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>PWSTR<span class=\"token punctuation\">)</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"65\"></td><td><pre>    <span class=\"token operator\">*</span>DriverEntryStatus <span class=\"token operator\">=</span> STATUS_SUCCESS<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"66\"></td><td><pre>    baseName<span class=\"token punctuation\">.</span>Buffer <span class=\"token operator\">=</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"67\"></td><td><pre></pre></td></tr><tr><td data-num=\"68\"></td><td><pre>    <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"69\"></td><td><pre>    <span class=\"token comment\">// Begin by formulating the name of the driver image file to be loaded.</span></pre></td></tr><tr><td data-num=\"70\"></td><td><pre>    <span class=\"token comment\">// Note that this is used to determine whether or not the driver has</span></pre></td></tr><tr><td data-num=\"71\"></td><td><pre>    <span class=\"token comment\">// already been loaded by the OS loader, not necessarily in actually</span></pre></td></tr><tr><td data-num=\"72\"></td><td><pre>    <span class=\"token comment\">// loading the driver image, since the node can override that name.</span></pre></td></tr><tr><td data-num=\"73\"></td><td><pre>    <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"74\"></td><td><pre></pre></td></tr><tr><td data-num=\"75\"></td><td><pre>    status <span class=\"token operator\">=</span> <span class=\"token function\">NtQueryKey</span><span class=\"token punctuation\">(</span> KeyHandle<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"76\"></td><td><pre>                         KeyBasicInformation<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"77\"></td><td><pre>                         <span class=\"token punctuation\">(</span>PVOID<span class=\"token punctuation\">)</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"78\"></td><td><pre>                         <span class=\"token number\">0</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"79\"></td><td><pre>                         <span class=\"token operator\">&amp;</span>keyBasicLength <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"80\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>status <span class=\"token operator\">!=</span> STATUS_BUFFER_OVERFLOW <span class=\"token operator\">&amp;&amp;</span></pre></td></tr><tr><td data-num=\"81\"></td><td><pre>        status <span class=\"token operator\">!=</span> STATUS_BUFFER_TOO_SMALL<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"82\"></td><td><pre></pre></td></tr><tr><td data-num=\"83\"></td><td><pre>        status <span class=\"token operator\">=</span> STATUS_ILL_FORMED_SERVICE_ENTRY<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"84\"></td><td><pre>        <span class=\"token keyword\">goto</span> IopLoadExit<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"85\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"86\"></td><td><pre></pre></td></tr><tr><td data-num=\"87\"></td><td><pre>    keyBasicInformation <span class=\"token operator\">=</span> <span class=\"token function\">ExAllocatePool</span><span class=\"token punctuation\">(</span> NonPagedPool<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"88\"></td><td><pre>                                          keyBasicLength <span class=\"token operator\">+</span> <span class=\"token punctuation\">(</span><span class=\"token number\">4</span> <span class=\"token operator\">*</span> <span class=\"token number\">2</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"89\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>keyBasicInformation<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"90\"></td><td><pre>        status <span class=\"token operator\">=</span> STATUS_INSUFFICIENT_RESOURCES<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"91\"></td><td><pre>        <span class=\"token keyword\">goto</span> IopLoadExit<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"92\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"93\"></td><td><pre></pre></td></tr><tr><td data-num=\"94\"></td><td><pre>    status <span class=\"token operator\">=</span> <span class=\"token function\">NtQueryKey</span><span class=\"token punctuation\">(</span> KeyHandle<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"95\"></td><td><pre>                         KeyBasicInformation<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"96\"></td><td><pre>                         keyBasicInformation<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"97\"></td><td><pre>                         keyBasicLength<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"98\"></td><td><pre>                         <span class=\"token operator\">&amp;</span>keyBasicLength <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"99\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token function\">NT_SUCCESS</span><span class=\"token punctuation\">(</span> status <span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"100\"></td><td><pre>        <span class=\"token keyword\">goto</span> IopLoadExit<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"101\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"102\"></td><td><pre></pre></td></tr><tr><td data-num=\"103\"></td><td><pre>    <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"104\"></td><td><pre>    <span class=\"token comment\">// Create a Unicode string descriptor which forms the name of the</span></pre></td></tr><tr><td data-num=\"105\"></td><td><pre>    <span class=\"token comment\">// driver.</span></pre></td></tr><tr><td data-num=\"106\"></td><td><pre>    <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"107\"></td><td><pre></pre></td></tr><tr><td data-num=\"108\"></td><td><pre>    baseName<span class=\"token punctuation\">.</span>Length <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>USHORT<span class=\"token punctuation\">)</span> keyBasicInformation<span class=\"token operator\">-></span>NameLength<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"109\"></td><td><pre>    baseName<span class=\"token punctuation\">.</span>MaximumLength <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>USHORT<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">(</span>baseName<span class=\"token punctuation\">.</span>Length <span class=\"token operator\">+</span> <span class=\"token punctuation\">(</span><span class=\"token number\">4</span> <span class=\"token operator\">*</span> <span class=\"token number\">2</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"110\"></td><td><pre>    baseName<span class=\"token punctuation\">.</span>Buffer <span class=\"token operator\">=</span> <span class=\"token operator\">&amp;</span>keyBasicInformation<span class=\"token operator\">-></span>Name<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"111\"></td><td><pre></pre></td></tr><tr><td data-num=\"112\"></td><td><pre>    serviceName<span class=\"token punctuation\">.</span>Buffer <span class=\"token operator\">=</span> <span class=\"token function\">ExAllocatePool</span><span class=\"token punctuation\">(</span>PagedPool<span class=\"token punctuation\">,</span> baseName<span class=\"token punctuation\">.</span>Length <span class=\"token operator\">+</span> <span class=\"token keyword\">sizeof</span><span class=\"token punctuation\">(</span>UNICODE_NULL<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"113\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>serviceName<span class=\"token punctuation\">.</span>Buffer<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"114\"></td><td><pre>        serviceName<span class=\"token punctuation\">.</span>Length <span class=\"token operator\">=</span> baseName<span class=\"token punctuation\">.</span>Length<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"115\"></td><td><pre>        serviceName<span class=\"token punctuation\">.</span>MaximumLength <span class=\"token operator\">=</span> serviceName<span class=\"token punctuation\">.</span>Length <span class=\"token operator\">+</span> <span class=\"token keyword\">sizeof</span><span class=\"token punctuation\">(</span>UNICODE_NULL<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"116\"></td><td><pre>        <span class=\"token function\">RtlCopyMemory</span><span class=\"token punctuation\">(</span>serviceName<span class=\"token punctuation\">.</span>Buffer<span class=\"token punctuation\">,</span> baseName<span class=\"token punctuation\">.</span>Buffer<span class=\"token punctuation\">,</span> baseName<span class=\"token punctuation\">.</span>Length<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"117\"></td><td><pre>        serviceName<span class=\"token punctuation\">.</span>Buffer<span class=\"token punctuation\">[</span>serviceName<span class=\"token punctuation\">.</span>Length <span class=\"token operator\">/</span> <span class=\"token keyword\">sizeof</span><span class=\"token punctuation\">(</span>WCHAR<span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> UNICODE_NULL<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"118\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"119\"></td><td><pre>        status <span class=\"token operator\">=</span> STATUS_INSUFFICIENT_RESOURCES<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"120\"></td><td><pre>        <span class=\"token keyword\">goto</span> IopLoadExit<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"121\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"122\"></td><td><pre></pre></td></tr><tr><td data-num=\"123\"></td><td><pre>    <span class=\"token function\">RtlAppendUnicodeToString</span><span class=\"token punctuation\">(</span> <span class=\"token operator\">&amp;</span>baseName<span class=\"token punctuation\">,</span> L<span class=\"token string\">\".SYS\"</span> <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"124\"></td><td><pre></pre></td></tr><tr><td data-num=\"125\"></td><td><pre>    <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"126\"></td><td><pre>    <span class=\"token comment\">// Log the file name</span></pre></td></tr><tr><td data-num=\"127\"></td><td><pre>    <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"128\"></td><td><pre>    <span class=\"token function\">HeadlessKernelAddLogEntry</span><span class=\"token punctuation\">(</span>HEADLESS_LOG_LOADING_FILENAME<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>baseName<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"129\"></td><td><pre></pre></td></tr><tr><td data-num=\"130\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>CheckForSafeBoot <span class=\"token operator\">&amp;&amp;</span> InitSafeBootMode<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"131\"></td><td><pre></pre></td></tr><tr><td data-num=\"132\"></td><td><pre>        BOOLEAN GroupIsGood <span class=\"token operator\">=</span> FALSE<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"133\"></td><td><pre>        UNICODE_STRING string<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"134\"></td><td><pre>        PKEY_VALUE_PARTIAL_INFORMATION keyValue<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"135\"></td><td><pre>        UCHAR nameBuffer<span class=\"token punctuation\">[</span><span class=\"token function\">FIELD_OFFSET</span><span class=\"token punctuation\">(</span>KEY_VALUE_PARTIAL_INFORMATION<span class=\"token punctuation\">,</span> Data<span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> <span class=\"token number\">64</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"136\"></td><td><pre>        ULONG length<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"137\"></td><td><pre></pre></td></tr><tr><td data-num=\"138\"></td><td><pre>        <span class=\"token function\">RtlInitUnicodeString</span><span class=\"token punctuation\">(</span> <span class=\"token operator\">&amp;</span>string<span class=\"token punctuation\">,</span> L<span class=\"token string\">\"Group\"</span> <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"139\"></td><td><pre>        keyValue <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>PKEY_VALUE_PARTIAL_INFORMATION<span class=\"token punctuation\">)</span>nameBuffer<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"140\"></td><td><pre>        <span class=\"token function\">RtlZeroMemory</span><span class=\"token punctuation\">(</span>nameBuffer<span class=\"token punctuation\">,</span> <span class=\"token keyword\">sizeof</span><span class=\"token punctuation\">(</span>nameBuffer<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"141\"></td><td><pre></pre></td></tr><tr><td data-num=\"142\"></td><td><pre>        status <span class=\"token operator\">=</span> <span class=\"token function\">NtQueryValueKey</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"143\"></td><td><pre>            KeyHandle<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"144\"></td><td><pre>            <span class=\"token operator\">&amp;</span>string<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"145\"></td><td><pre>            KeyValuePartialInformation<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"146\"></td><td><pre>            keyValue<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"147\"></td><td><pre>            <span class=\"token keyword\">sizeof</span><span class=\"token punctuation\">(</span>nameBuffer<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"148\"></td><td><pre>            <span class=\"token operator\">&amp;</span>length</pre></td></tr><tr><td data-num=\"149\"></td><td><pre>            <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"150\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">NT_SUCCESS</span><span class=\"token punctuation\">(</span>status<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"151\"></td><td><pre></pre></td></tr><tr><td data-num=\"152\"></td><td><pre>            string<span class=\"token punctuation\">.</span>Length <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>USHORT<span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span>keyValue<span class=\"token operator\">-></span>DataLength <span class=\"token operator\">-</span> <span class=\"token keyword\">sizeof</span><span class=\"token punctuation\">(</span>WCHAR<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"153\"></td><td><pre>            string<span class=\"token punctuation\">.</span>MaximumLength <span class=\"token operator\">=</span> string<span class=\"token punctuation\">.</span>Length<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"154\"></td><td><pre>            string<span class=\"token punctuation\">.</span>Buffer <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>PWSTR<span class=\"token punctuation\">)</span>keyValue<span class=\"token operator\">-></span>Data<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"155\"></td><td><pre></pre></td></tr><tr><td data-num=\"156\"></td><td><pre>            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">IopSafebootDriverLoad</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>string<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"157\"></td><td><pre>                GroupIsGood <span class=\"token operator\">=</span> TRUE<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"158\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"159\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"160\"></td><td><pre></pre></td></tr><tr><td data-num=\"161\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>GroupIsGood <span class=\"token operator\">&amp;&amp;</span> <span class=\"token operator\">!</span><span class=\"token function\">IopSafebootDriverLoad</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>baseName<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"162\"></td><td><pre>            <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"163\"></td><td><pre>            <span class=\"token comment\">// don't load the driver</span></pre></td></tr><tr><td data-num=\"164\"></td><td><pre>            <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"165\"></td><td><pre></pre></td></tr><tr><td data-num=\"166\"></td><td><pre>            <span class=\"token function\">IopBootLog</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>baseName<span class=\"token punctuation\">,</span> FALSE<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"167\"></td><td><pre></pre></td></tr><tr><td data-num=\"168\"></td><td><pre>            <span class=\"token function\">DbgPrint</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"SAFEBOOT: skipping device = %wZ(%wZ)\\n\"</span><span class=\"token punctuation\">,</span><span class=\"token operator\">&amp;</span>baseName<span class=\"token punctuation\">,</span><span class=\"token operator\">&amp;</span>string<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"169\"></td><td><pre>            <span class=\"token function\">HeadlessKernelAddLogEntry</span><span class=\"token punctuation\">(</span>HEADLESS_LOG_LOAD_SUCCESSFUL<span class=\"token punctuation\">,</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"170\"></td><td><pre>            <span class=\"token keyword\">return</span> STATUS_SUCCESS<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"171\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"172\"></td><td><pre></pre></td></tr><tr><td data-num=\"173\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"174\"></td><td><pre></pre></td></tr><tr><td data-num=\"175\"></td><td><pre>    <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"176\"></td><td><pre>    <span class=\"token comment\">// See if this driver has already been loaded by the boot loader.</span></pre></td></tr><tr><td data-num=\"177\"></td><td><pre>    <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"178\"></td><td><pre></pre></td></tr><tr><td data-num=\"179\"></td><td><pre>    <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"180\"></td><td><pre>    <span class=\"token comment\">// No need to do KeEnterCriticalRegion as this is called</span></pre></td></tr><tr><td data-num=\"181\"></td><td><pre>    <span class=\"token comment\">// from system process only.</span></pre></td></tr><tr><td data-num=\"182\"></td><td><pre>    <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"183\"></td><td><pre>    <span class=\"token function\">ExAcquireResourceSharedLite</span><span class=\"token punctuation\">(</span> <span class=\"token operator\">&amp;</span>PsLoadedModuleResource<span class=\"token punctuation\">,</span> TRUE <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"184\"></td><td><pre>    nextEntry <span class=\"token operator\">=</span> PsLoadedModuleList<span class=\"token punctuation\">.</span>Flink<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"185\"></td><td><pre>    <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span>nextEntry <span class=\"token operator\">!=</span> <span class=\"token operator\">&amp;</span>PsLoadedModuleList<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"186\"></td><td><pre></pre></td></tr><tr><td data-num=\"187\"></td><td><pre>        <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"188\"></td><td><pre>        <span class=\"token comment\">// Look at the next boot driver in the list.</span></pre></td></tr><tr><td data-num=\"189\"></td><td><pre>        <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"190\"></td><td><pre></pre></td></tr><tr><td data-num=\"191\"></td><td><pre>        driverEntry <span class=\"token operator\">=</span> <span class=\"token function\">CONTAINING_RECORD</span><span class=\"token punctuation\">(</span> nextEntry<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"192\"></td><td><pre>                                         KLDR_DATA_TABLE_ENTRY<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"193\"></td><td><pre>                                         InLoadOrderLinks <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"194\"></td><td><pre></pre></td></tr><tr><td data-num=\"195\"></td><td><pre>        <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"196\"></td><td><pre>        <span class=\"token comment\">// If this is not the kernel image (ntoskrnl) and not the HAL (hal),</span></pre></td></tr><tr><td data-num=\"197\"></td><td><pre>        <span class=\"token comment\">// then this is a driver, so initialize it.</span></pre></td></tr><tr><td data-num=\"198\"></td><td><pre>        <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"199\"></td><td><pre></pre></td></tr><tr><td data-num=\"200\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">RtlEqualUnicodeString</span><span class=\"token punctuation\">(</span>  <span class=\"token operator\">&amp;</span>baseName<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"201\"></td><td><pre>                             <span class=\"token operator\">&amp;</span>driverEntry<span class=\"token operator\">-></span>FullDllName<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"202\"></td><td><pre>                            TRUE <span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"203\"></td><td><pre></pre></td></tr><tr><td data-num=\"204\"></td><td><pre>            status <span class=\"token operator\">=</span> STATUS_IMAGE_ALREADY_LOADED<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"205\"></td><td><pre>            <span class=\"token function\">ExReleaseResourceLite</span><span class=\"token punctuation\">(</span> <span class=\"token operator\">&amp;</span>PsLoadedModuleResource <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"206\"></td><td><pre></pre></td></tr><tr><td data-num=\"207\"></td><td><pre>            <span class=\"token function\">IopBootLog</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>baseName<span class=\"token punctuation\">,</span> TRUE<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"208\"></td><td><pre>            baseName<span class=\"token punctuation\">.</span>Buffer <span class=\"token operator\">=</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"209\"></td><td><pre>            <span class=\"token keyword\">goto</span> IopLoadExit<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"210\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"211\"></td><td><pre></pre></td></tr><tr><td data-num=\"212\"></td><td><pre>        nextEntry <span class=\"token operator\">=</span> nextEntry<span class=\"token operator\">-></span>Flink<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"213\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"214\"></td><td><pre>    <span class=\"token function\">ExReleaseResourceLite</span><span class=\"token punctuation\">(</span> <span class=\"token operator\">&amp;</span>PsLoadedModuleResource <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"215\"></td><td><pre></pre></td></tr><tr><td data-num=\"216\"></td><td><pre>    <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"217\"></td><td><pre>    <span class=\"token comment\">// This driver has not already been loaded by the OS loader.  Form the</span></pre></td></tr><tr><td data-num=\"218\"></td><td><pre>    <span class=\"token comment\">// full path name for this driver.</span></pre></td></tr><tr><td data-num=\"219\"></td><td><pre>    <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"220\"></td><td><pre></pre></td></tr><tr><td data-num=\"221\"></td><td><pre>    status <span class=\"token operator\">=</span> <span class=\"token function\">IopBuildFullDriverPath</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>serviceName<span class=\"token punctuation\">,</span> KeyHandle<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>baseName<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"222\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token function\">NT_SUCCESS</span><span class=\"token punctuation\">(</span>status<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"223\"></td><td><pre></pre></td></tr><tr><td data-num=\"224\"></td><td><pre>        baseName<span class=\"token punctuation\">.</span>Buffer <span class=\"token operator\">=</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"225\"></td><td><pre>        <span class=\"token keyword\">goto</span> IopLoadExit<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"226\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"227\"></td><td><pre></pre></td></tr><tr><td data-num=\"228\"></td><td><pre>    <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"229\"></td><td><pre>    <span class=\"token comment\">// Now get the name of the driver object.</span></pre></td></tr><tr><td data-num=\"230\"></td><td><pre>    <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"231\"></td><td><pre></pre></td></tr><tr><td data-num=\"232\"></td><td><pre>    status <span class=\"token operator\">=</span> <span class=\"token function\">IopGetDriverNameFromKeyNode</span><span class=\"token punctuation\">(</span> KeyHandle<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"233\"></td><td><pre>                                          <span class=\"token operator\">&amp;</span>driverName <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"234\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token function\">NT_SUCCESS</span><span class=\"token punctuation\">(</span> status <span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"235\"></td><td><pre>        <span class=\"token keyword\">goto</span> IopLoadExit<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"236\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"237\"></td><td><pre></pre></td></tr><tr><td data-num=\"238\"></td><td><pre>    <span class=\"token function\">InitializeObjectAttributes</span><span class=\"token punctuation\">(</span> <span class=\"token operator\">&amp;</span>objectAttributes<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"239\"></td><td><pre>                                <span class=\"token operator\">&amp;</span>driverName<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"240\"></td><td><pre>                                OBJ_PERMANENT<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"241\"></td><td><pre>                                <span class=\"token punctuation\">(</span>HANDLE<span class=\"token punctuation\">)</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"242\"></td><td><pre>                                <span class=\"token punctuation\">(</span>PSECURITY_DESCRIPTOR<span class=\"token punctuation\">)</span> <span class=\"token constant\">NULL</span> <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"243\"></td><td><pre></pre></td></tr><tr><td data-num=\"244\"></td><td><pre>    <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"245\"></td><td><pre>    <span class=\"token comment\">// Load the driver image into memory.  If this fails partway through</span></pre></td></tr><tr><td data-num=\"246\"></td><td><pre>    <span class=\"token comment\">// the operation, then it will automatically be unloaded.</span></pre></td></tr><tr><td data-num=\"247\"></td><td><pre>    <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"248\"></td><td><pre></pre></td></tr><tr><td data-num=\"249\"></td><td><pre>    <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"250\"></td><td><pre>    <span class=\"token comment\">// No need to do KeEnterCriticalRegion here as this is only</span></pre></td></tr><tr><td data-num=\"251\"></td><td><pre>    <span class=\"token comment\">// called from system process</span></pre></td></tr><tr><td data-num=\"252\"></td><td><pre>    <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"253\"></td><td><pre>    <span class=\"token function\">ExAcquireResourceExclusiveLite</span><span class=\"token punctuation\">(</span> <span class=\"token operator\">&amp;</span>IopDriverLoadResource<span class=\"token punctuation\">,</span> TRUE <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"254\"></td><td><pre></pre></td></tr><tr><td data-num=\"255\"></td><td><pre>    status <span class=\"token operator\">=</span> <span class=\"token function\">MmLoadSystemImage</span><span class=\"token punctuation\">(</span> <span class=\"token operator\">&amp;</span>baseName<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"256\"></td><td><pre>                                <span class=\"token constant\">NULL</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"257\"></td><td><pre>                                <span class=\"token constant\">NULL</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"258\"></td><td><pre>                                <span class=\"token number\">0</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"259\"></td><td><pre>                                <span class=\"token operator\">&amp;</span>sectionPointer<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"260\"></td><td><pre>                                <span class=\"token punctuation\">(</span>PVOID <span class=\"token operator\">*</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;</span>imageBaseAddress <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"261\"></td><td><pre></pre></td></tr><tr><td data-num=\"262\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token function\">NT_SUCCESS</span><span class=\"token punctuation\">(</span> status <span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"263\"></td><td><pre></pre></td></tr><tr><td data-num=\"264\"></td><td><pre></pre></td></tr><tr><td data-num=\"265\"></td><td><pre>        <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"266\"></td><td><pre>        <span class=\"token comment\">// If the image was not already loaded then exit.</span></pre></td></tr><tr><td data-num=\"267\"></td><td><pre>        <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"268\"></td><td><pre></pre></td></tr><tr><td data-num=\"269\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>status <span class=\"token operator\">!=</span> STATUS_IMAGE_ALREADY_LOADED<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"270\"></td><td><pre></pre></td></tr><tr><td data-num=\"271\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">if</span> <span class=\"token expression\"><span class=\"token function\">defined</span><span class=\"token punctuation\">(</span>_WIN64<span class=\"token punctuation\">)</span></span></span></pre></td></tr><tr><td data-num=\"272\"></td><td><pre>            <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"273\"></td><td><pre>            <span class=\"token comment\">// If this is a driver meant for another architecture, then block this driver</span></pre></td></tr><tr><td data-num=\"274\"></td><td><pre>            <span class=\"token comment\">// and continue with loading the rest of the drivers stack.</span></pre></td></tr><tr><td data-num=\"275\"></td><td><pre>            <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"276\"></td><td><pre></pre></td></tr><tr><td data-num=\"277\"></td><td><pre>            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">IopCheckIfNotNativeDriver</span> <span class=\"token punctuation\">(</span>status<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>baseName<span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> TRUE<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"278\"></td><td><pre>            </pre></td></tr><tr><td data-num=\"279\"></td><td><pre>                <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>IsFilter <span class=\"token operator\">!=</span> FALSE<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"280\"></td><td><pre>                    status <span class=\"token operator\">=</span> STATUS_DRIVER_BLOCKED<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"281\"></td><td><pre>                <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"282\"></td><td><pre>                    status <span class=\"token operator\">=</span> STATUS_DRIVER_BLOCKED_CRITICAL<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"283\"></td><td><pre>                <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"284\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">if</span> <span class=\"token expression\">DBG</span></span></pre></td></tr><tr><td data-num=\"285\"></td><td><pre>                <span class=\"token function\">DbgPrint</span> <span class=\"token punctuation\">(</span><span class=\"token string\">\"IopLoadDriver - Blocking driver %ws (32-bit) - Status = %lx\\n\"</span><span class=\"token punctuation\">,</span> </pre></td></tr><tr><td data-num=\"286\"></td><td><pre>                          baseName<span class=\"token punctuation\">.</span>Buffer<span class=\"token punctuation\">,</span> status<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"287\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">endif</span></span></pre></td></tr><tr><td data-num=\"288\"></td><td><pre></pre></td></tr><tr><td data-num=\"289\"></td><td><pre>                <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"290\"></td><td><pre>                <span class=\"token comment\">// Log an event to the eventlog</span></pre></td></tr><tr><td data-num=\"291\"></td><td><pre>                <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"292\"></td><td><pre></pre></td></tr><tr><td data-num=\"293\"></td><td><pre>                <span class=\"token function\">IopLogBlockedDriverEvent</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>baseName<span class=\"token punctuation\">,</span> STATUS_INCOMPATIBLE_DRIVER_BLOCKED<span class=\"token punctuation\">,</span> status<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"294\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"295\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">endif</span></span></pre></td></tr><tr><td data-num=\"296\"></td><td><pre></pre></td></tr><tr><td data-num=\"297\"></td><td><pre></pre></td></tr><tr><td data-num=\"298\"></td><td><pre>            <span class=\"token function\">ExReleaseResourceLite</span><span class=\"token punctuation\">(</span> <span class=\"token operator\">&amp;</span>IopDriverLoadResource <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"299\"></td><td><pre>            <span class=\"token function\">IopBootLog</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>baseName<span class=\"token punctuation\">,</span> FALSE<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"300\"></td><td><pre></pre></td></tr><tr><td data-num=\"301\"></td><td><pre>            <span class=\"token keyword\">goto</span> IopLoadExit<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"302\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"303\"></td><td><pre></pre></td></tr><tr><td data-num=\"304\"></td><td><pre>        <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"305\"></td><td><pre>        <span class=\"token comment\">// Open the driver object.</span></pre></td></tr><tr><td data-num=\"306\"></td><td><pre>        <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"307\"></td><td><pre></pre></td></tr><tr><td data-num=\"308\"></td><td><pre>        status <span class=\"token operator\">=</span> <span class=\"token function\">ObOpenObjectByName</span><span class=\"token punctuation\">(</span> <span class=\"token operator\">&amp;</span>objectAttributes<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"309\"></td><td><pre>                                     IoDriverObjectType<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"310\"></td><td><pre>                                     KernelMode<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"311\"></td><td><pre>                                     <span class=\"token constant\">NULL</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"312\"></td><td><pre>                                     <span class=\"token number\">0</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"313\"></td><td><pre>                                     <span class=\"token constant\">NULL</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"314\"></td><td><pre>                                     <span class=\"token operator\">&amp;</span>driverHandle <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"315\"></td><td><pre></pre></td></tr><tr><td data-num=\"316\"></td><td><pre></pre></td></tr><tr><td data-num=\"317\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token function\">NT_SUCCESS</span><span class=\"token punctuation\">(</span> status <span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"318\"></td><td><pre></pre></td></tr><tr><td data-num=\"319\"></td><td><pre>            <span class=\"token function\">ExReleaseResourceLite</span><span class=\"token punctuation\">(</span> <span class=\"token operator\">&amp;</span>IopDriverLoadResource <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"320\"></td><td><pre>            <span class=\"token function\">IopBootLog</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>baseName<span class=\"token punctuation\">,</span> FALSE<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"321\"></td><td><pre></pre></td></tr><tr><td data-num=\"322\"></td><td><pre>            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>status <span class=\"token operator\">==</span> STATUS_OBJECT_NAME_NOT_FOUND<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"323\"></td><td><pre></pre></td></tr><tr><td data-num=\"324\"></td><td><pre>                <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"325\"></td><td><pre>                <span class=\"token comment\">// Adjust the exit code so that we can distinguish drivers that</span></pre></td></tr><tr><td data-num=\"326\"></td><td><pre>                <span class=\"token comment\">// aren't present from drivers that are present but have had</span></pre></td></tr><tr><td data-num=\"327\"></td><td><pre>                <span class=\"token comment\">// their driver objects made temporary.</span></pre></td></tr><tr><td data-num=\"328\"></td><td><pre>                <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"329\"></td><td><pre>                status <span class=\"token operator\">=</span> STATUS_DRIVER_FAILED_PRIOR_UNLOAD<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"330\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"331\"></td><td><pre></pre></td></tr><tr><td data-num=\"332\"></td><td><pre>            <span class=\"token keyword\">goto</span> IopLoadExit<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"333\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"334\"></td><td><pre></pre></td></tr><tr><td data-num=\"335\"></td><td><pre>        <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"336\"></td><td><pre>        <span class=\"token comment\">// Reference the handle and obtain a pointer to the driver object so that</span></pre></td></tr><tr><td data-num=\"337\"></td><td><pre>        <span class=\"token comment\">// the handle can be deleted without the object going away.</span></pre></td></tr><tr><td data-num=\"338\"></td><td><pre>        <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"339\"></td><td><pre></pre></td></tr><tr><td data-num=\"340\"></td><td><pre>        status <span class=\"token operator\">=</span> <span class=\"token function\">ObReferenceObjectByHandle</span><span class=\"token punctuation\">(</span> driverHandle<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"341\"></td><td><pre>                                            <span class=\"token number\">0</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"342\"></td><td><pre>                                            IoDriverObjectType<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"343\"></td><td><pre>                                            <span class=\"token function\">KeGetPreviousMode</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"344\"></td><td><pre>                                            <span class=\"token punctuation\">(</span>PVOID <span class=\"token operator\">*</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;</span>driverObject<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"345\"></td><td><pre>                                            <span class=\"token punctuation\">(</span>POBJECT_HANDLE_INFORMATION<span class=\"token punctuation\">)</span> <span class=\"token constant\">NULL</span> <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"346\"></td><td><pre>        <span class=\"token function\">NtClose</span><span class=\"token punctuation\">(</span> driverHandle <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"347\"></td><td><pre></pre></td></tr><tr><td data-num=\"348\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token function\">NT_SUCCESS</span><span class=\"token punctuation\">(</span> status <span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"349\"></td><td><pre>            <span class=\"token function\">ExReleaseResourceLite</span><span class=\"token punctuation\">(</span> <span class=\"token operator\">&amp;</span>IopDriverLoadResource <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"350\"></td><td><pre>            <span class=\"token function\">IopBootLog</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>baseName<span class=\"token punctuation\">,</span> FALSE<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"351\"></td><td><pre>            <span class=\"token keyword\">goto</span> IopLoadExit<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"352\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"353\"></td><td><pre></pre></td></tr><tr><td data-num=\"354\"></td><td><pre></pre></td></tr><tr><td data-num=\"355\"></td><td><pre>        status <span class=\"token operator\">=</span> <span class=\"token function\">IopResurrectDriver</span><span class=\"token punctuation\">(</span> driverObject <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"356\"></td><td><pre></pre></td></tr><tr><td data-num=\"357\"></td><td><pre>        <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"358\"></td><td><pre>        <span class=\"token comment\">// Regardless of the status the driver object should be dereferenced.</span></pre></td></tr><tr><td data-num=\"359\"></td><td><pre>        <span class=\"token comment\">// if the unload has already run then driver is almost gone. If</span></pre></td></tr><tr><td data-num=\"360\"></td><td><pre>        <span class=\"token comment\">// the driver has been resurrected then the I/O system still has its</span></pre></td></tr><tr><td data-num=\"361\"></td><td><pre>        <span class=\"token comment\">// original reference.</span></pre></td></tr><tr><td data-num=\"362\"></td><td><pre>        <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"363\"></td><td><pre></pre></td></tr><tr><td data-num=\"364\"></td><td><pre>        <span class=\"token function\">ObDereferenceObject</span><span class=\"token punctuation\">(</span> driverObject <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"365\"></td><td><pre>        <span class=\"token function\">ExReleaseResourceLite</span><span class=\"token punctuation\">(</span> <span class=\"token operator\">&amp;</span>IopDriverLoadResource <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"366\"></td><td><pre>        <span class=\"token function\">IopBootLog</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>baseName<span class=\"token punctuation\">,</span> FALSE<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"367\"></td><td><pre>        <span class=\"token keyword\">goto</span> IopLoadExit<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"368\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"369\"></td><td><pre></pre></td></tr><tr><td data-num=\"370\"></td><td><pre>        ntHeaders <span class=\"token operator\">=</span> <span class=\"token function\">RtlImageNtHeader</span><span class=\"token punctuation\">(</span> imageBaseAddress <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"371\"></td><td><pre></pre></td></tr><tr><td data-num=\"372\"></td><td><pre>        <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"373\"></td><td><pre>        <span class=\"token comment\">// Check should this driver be loaded.  If yes, the enum subkey</span></pre></td></tr><tr><td data-num=\"374\"></td><td><pre>        <span class=\"token comment\">// of the service will be prepared.</span></pre></td></tr><tr><td data-num=\"375\"></td><td><pre>        <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"376\"></td><td><pre></pre></td></tr><tr><td data-num=\"377\"></td><td><pre>        status <span class=\"token operator\">=</span> <span class=\"token function\">IopPrepareDriverLoading</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>serviceName<span class=\"token punctuation\">,</span> KeyHandle<span class=\"token punctuation\">,</span> imageBaseAddress<span class=\"token punctuation\">,</span> IsFilter<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"378\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token function\">NT_SUCCESS</span><span class=\"token punctuation\">(</span>status<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"379\"></td><td><pre>            <span class=\"token function\">MmUnloadSystemImage</span><span class=\"token punctuation\">(</span>sectionPointer<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"380\"></td><td><pre>            <span class=\"token function\">ExReleaseResourceLite</span><span class=\"token punctuation\">(</span> <span class=\"token operator\">&amp;</span>IopDriverLoadResource <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"381\"></td><td><pre>            <span class=\"token function\">IopBootLog</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>baseName<span class=\"token punctuation\">,</span> FALSE<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"382\"></td><td><pre>            <span class=\"token keyword\">goto</span> IopLoadExit<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"383\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"384\"></td><td><pre></pre></td></tr><tr><td data-num=\"385\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"386\"></td><td><pre></pre></td></tr><tr><td data-num=\"387\"></td><td><pre>    <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"388\"></td><td><pre>    <span class=\"token comment\">// The driver image has now been loaded into memory.  Create the driver</span></pre></td></tr><tr><td data-num=\"389\"></td><td><pre>    <span class=\"token comment\">// object that represents this image.</span></pre></td></tr><tr><td data-num=\"390\"></td><td><pre>    <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"391\"></td><td><pre></pre></td></tr><tr><td data-num=\"392\"></td><td><pre>    status <span class=\"token operator\">=</span> <span class=\"token function\">ObCreateObject</span><span class=\"token punctuation\">(</span> <span class=\"token function\">KeGetPreviousMode</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"393\"></td><td><pre>                             IoDriverObjectType<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"394\"></td><td><pre>                             <span class=\"token operator\">&amp;</span>objectAttributes<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"395\"></td><td><pre>                             KernelMode<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"396\"></td><td><pre>                             <span class=\"token punctuation\">(</span>PVOID<span class=\"token punctuation\">)</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"397\"></td><td><pre>                             <span class=\"token punctuation\">(</span>ULONG<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">sizeof</span><span class=\"token punctuation\">(</span> DRIVER_OBJECT <span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> <span class=\"token keyword\">sizeof</span> <span class=\"token punctuation\">(</span> DRIVER_EXTENSION <span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"398\"></td><td><pre>                             <span class=\"token number\">0</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"399\"></td><td><pre>                             <span class=\"token number\">0</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"400\"></td><td><pre>                             <span class=\"token punctuation\">(</span>PVOID <span class=\"token operator\">*</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;</span>driverObject <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"401\"></td><td><pre></pre></td></tr><tr><td data-num=\"402\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token function\">NT_SUCCESS</span><span class=\"token punctuation\">(</span> status <span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"403\"></td><td><pre>        <span class=\"token function\">MmUnloadSystemImage</span><span class=\"token punctuation\">(</span>sectionPointer<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"404\"></td><td><pre>        <span class=\"token function\">ExReleaseResourceLite</span><span class=\"token punctuation\">(</span> <span class=\"token operator\">&amp;</span>IopDriverLoadResource <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"405\"></td><td><pre>        <span class=\"token function\">IopBootLog</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>baseName<span class=\"token punctuation\">,</span> FALSE<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"406\"></td><td><pre>        <span class=\"token keyword\">goto</span> IopLoadExit<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"407\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"408\"></td><td><pre></pre></td></tr><tr><td data-num=\"409\"></td><td><pre>    <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"410\"></td><td><pre>    <span class=\"token comment\">// Initialize this driver object and insert it into the object table.</span></pre></td></tr><tr><td data-num=\"411\"></td><td><pre>    <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"412\"></td><td><pre></pre></td></tr><tr><td data-num=\"413\"></td><td><pre>    <span class=\"token function\">RtlZeroMemory</span><span class=\"token punctuation\">(</span> driverObject<span class=\"token punctuation\">,</span> <span class=\"token keyword\">sizeof</span><span class=\"token punctuation\">(</span> DRIVER_OBJECT <span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> <span class=\"token keyword\">sizeof</span> <span class=\"token punctuation\">(</span> DRIVER_EXTENSION<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"414\"></td><td><pre>    driverObject<span class=\"token operator\">-></span>DriverExtension <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>PDRIVER_EXTENSION<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">(</span>driverObject <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"415\"></td><td><pre>    driverObject<span class=\"token operator\">-></span>DriverExtension<span class=\"token operator\">-></span>DriverObject <span class=\"token operator\">=</span> driverObject<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"416\"></td><td><pre></pre></td></tr><tr><td data-num=\"417\"></td><td><pre>    <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span>i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;=</span> IRP_MJ_MAXIMUM_FUNCTION<span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"418\"></td><td><pre>        driverObject<span class=\"token operator\">-></span>MajorFunction<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> IopInvalidDeviceRequest<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"419\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"420\"></td><td><pre></pre></td></tr><tr><td data-num=\"421\"></td><td><pre>    driverObject<span class=\"token operator\">-></span>Type <span class=\"token operator\">=</span> IO_TYPE_DRIVER<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"422\"></td><td><pre>    driverObject<span class=\"token operator\">-></span>Size <span class=\"token operator\">=</span> <span class=\"token keyword\">sizeof</span><span class=\"token punctuation\">(</span> DRIVER_OBJECT <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"423\"></td><td><pre>    ntHeaders <span class=\"token operator\">=</span> <span class=\"token function\">RtlImageNtHeader</span><span class=\"token punctuation\">(</span> imageBaseAddress <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"424\"></td><td><pre>    entryPoint <span class=\"token operator\">=</span> ntHeaders<span class=\"token operator\">-></span>OptionalHeader<span class=\"token punctuation\">.</span>AddressOfEntryPoint<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"425\"></td><td><pre>    entryPoint <span class=\"token operator\">+=</span> <span class=\"token punctuation\">(</span>ULONG_PTR<span class=\"token punctuation\">)</span> imageBaseAddress<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"426\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token punctuation\">(</span>ntHeaders<span class=\"token operator\">-></span>OptionalHeader<span class=\"token punctuation\">.</span>DllCharacteristics <span class=\"token operator\">&amp;</span> IMAGE_DLLCHARACTERISTICS_WDM_DRIVER<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"427\"></td><td><pre>        driverObject<span class=\"token operator\">-></span>Flags <span class=\"token operator\">|=</span> DRVO_LEGACY_DRIVER<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"428\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"429\"></td><td><pre>    driverObject<span class=\"token operator\">-></span>DriverInit <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>PDRIVER_INITIALIZE<span class=\"token punctuation\">)</span> entryPoint<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"430\"></td><td><pre>    driverObject<span class=\"token operator\">-></span>DriverSection <span class=\"token operator\">=</span> sectionPointer<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"431\"></td><td><pre>    driverObject<span class=\"token operator\">-></span>DriverStart <span class=\"token operator\">=</span> imageBaseAddress<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"432\"></td><td><pre>    driverObject<span class=\"token operator\">-></span>DriverSize <span class=\"token operator\">=</span> ntHeaders<span class=\"token operator\">-></span>OptionalHeader<span class=\"token punctuation\">.</span>SizeOfImage<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"433\"></td><td><pre></pre></td></tr><tr><td data-num=\"434\"></td><td><pre>    status <span class=\"token operator\">=</span> <span class=\"token function\">ObInsertObject</span><span class=\"token punctuation\">(</span> driverObject<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"435\"></td><td><pre>                             <span class=\"token punctuation\">(</span>PACCESS_STATE<span class=\"token punctuation\">)</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"436\"></td><td><pre>                             FILE_READ_DATA<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"437\"></td><td><pre>                             <span class=\"token number\">0</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"438\"></td><td><pre>                             <span class=\"token punctuation\">(</span>PVOID <span class=\"token operator\">*</span><span class=\"token punctuation\">)</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"439\"></td><td><pre>                             <span class=\"token operator\">&amp;</span>driverHandle <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"440\"></td><td><pre></pre></td></tr><tr><td data-num=\"441\"></td><td><pre>    <span class=\"token function\">ExReleaseResourceLite</span><span class=\"token punctuation\">(</span> <span class=\"token operator\">&amp;</span>IopDriverLoadResource <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"442\"></td><td><pre></pre></td></tr><tr><td data-num=\"443\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token function\">NT_SUCCESS</span><span class=\"token punctuation\">(</span> status <span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"444\"></td><td><pre>        <span class=\"token function\">IopBootLog</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>baseName<span class=\"token punctuation\">,</span> FALSE<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"445\"></td><td><pre>        <span class=\"token keyword\">goto</span> IopLoadExit<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"446\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"447\"></td><td><pre></pre></td></tr><tr><td data-num=\"448\"></td><td><pre>    <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"449\"></td><td><pre>    <span class=\"token comment\">// Reference the handle and obtain a pointer to the driver object so that</span></pre></td></tr><tr><td data-num=\"450\"></td><td><pre>    <span class=\"token comment\">// the handle can be deleted without the object going away.</span></pre></td></tr><tr><td data-num=\"451\"></td><td><pre>    <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"452\"></td><td><pre></pre></td></tr><tr><td data-num=\"453\"></td><td><pre>    status <span class=\"token operator\">=</span> <span class=\"token function\">ObReferenceObjectByHandle</span><span class=\"token punctuation\">(</span> driverHandle<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"454\"></td><td><pre>                                        <span class=\"token number\">0</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"455\"></td><td><pre>                                        IoDriverObjectType<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"456\"></td><td><pre>                                        <span class=\"token function\">KeGetPreviousMode</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"457\"></td><td><pre>                                        <span class=\"token punctuation\">(</span>PVOID <span class=\"token operator\">*</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;</span>driverObject<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"458\"></td><td><pre>                                        <span class=\"token punctuation\">(</span>POBJECT_HANDLE_INFORMATION<span class=\"token punctuation\">)</span> <span class=\"token constant\">NULL</span> <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"459\"></td><td><pre></pre></td></tr><tr><td data-num=\"460\"></td><td><pre>    <span class=\"token function\">ASSERT</span><span class=\"token punctuation\">(</span>status <span class=\"token operator\">==</span> STATUS_SUCCESS<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"461\"></td><td><pre></pre></td></tr><tr><td data-num=\"462\"></td><td><pre>    <span class=\"token function\">NtClose</span><span class=\"token punctuation\">(</span> driverHandle <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"463\"></td><td><pre></pre></td></tr><tr><td data-num=\"464\"></td><td><pre>    <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"465\"></td><td><pre>    <span class=\"token comment\">// Load the Registry information in the appropriate fields of the device</span></pre></td></tr><tr><td data-num=\"466\"></td><td><pre>    <span class=\"token comment\">// object.</span></pre></td></tr><tr><td data-num=\"467\"></td><td><pre>    <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"468\"></td><td><pre></pre></td></tr><tr><td data-num=\"469\"></td><td><pre>    driverObject<span class=\"token operator\">-></span>HardwareDatabase <span class=\"token operator\">=</span></pre></td></tr><tr><td data-num=\"470\"></td><td><pre>        <span class=\"token operator\">&amp;</span>CmRegistryMachineHardwareDescriptionSystemName<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"471\"></td><td><pre></pre></td></tr><tr><td data-num=\"472\"></td><td><pre>    <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"473\"></td><td><pre>    <span class=\"token comment\">// Store the name of the device driver in the driver object so that it</span></pre></td></tr><tr><td data-num=\"474\"></td><td><pre>    <span class=\"token comment\">// can be easily found by the error log thread.</span></pre></td></tr><tr><td data-num=\"475\"></td><td><pre>    <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"476\"></td><td><pre></pre></td></tr><tr><td data-num=\"477\"></td><td><pre>    driverObject<span class=\"token operator\">-></span>DriverName<span class=\"token punctuation\">.</span>Buffer <span class=\"token operator\">=</span> <span class=\"token function\">ExAllocatePool</span><span class=\"token punctuation\">(</span> PagedPool<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"478\"></td><td><pre>                                                      driverName<span class=\"token punctuation\">.</span>MaximumLength <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"479\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>driverObject<span class=\"token operator\">-></span>DriverName<span class=\"token punctuation\">.</span>Buffer<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"480\"></td><td><pre>        driverObject<span class=\"token operator\">-></span>DriverName<span class=\"token punctuation\">.</span>MaximumLength <span class=\"token operator\">=</span> driverName<span class=\"token punctuation\">.</span>MaximumLength<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"481\"></td><td><pre>        driverObject<span class=\"token operator\">-></span>DriverName<span class=\"token punctuation\">.</span>Length <span class=\"token operator\">=</span> driverName<span class=\"token punctuation\">.</span>Length<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"482\"></td><td><pre></pre></td></tr><tr><td data-num=\"483\"></td><td><pre>        <span class=\"token function\">RtlCopyMemory</span><span class=\"token punctuation\">(</span> driverObject<span class=\"token operator\">-></span>DriverName<span class=\"token punctuation\">.</span>Buffer<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"484\"></td><td><pre>                       driverName<span class=\"token punctuation\">.</span>Buffer<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"485\"></td><td><pre>                       driverName<span class=\"token punctuation\">.</span>MaximumLength <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"486\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"487\"></td><td><pre></pre></td></tr><tr><td data-num=\"488\"></td><td><pre>    <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"489\"></td><td><pre>    <span class=\"token comment\">// Query the name of the registry path for this driver so that it can</span></pre></td></tr><tr><td data-num=\"490\"></td><td><pre>    <span class=\"token comment\">// be passed to the driver.</span></pre></td></tr><tr><td data-num=\"491\"></td><td><pre>    <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"492\"></td><td><pre></pre></td></tr><tr><td data-num=\"493\"></td><td><pre>    registryPath <span class=\"token operator\">=</span> <span class=\"token function\">ExAllocatePool</span><span class=\"token punctuation\">(</span> NonPagedPool<span class=\"token punctuation\">,</span> PAGE_SIZE <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"494\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>registryPath<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"495\"></td><td><pre>        <span class=\"token function\">ObMakeTemporaryObject</span><span class=\"token punctuation\">(</span> driverObject <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"496\"></td><td><pre>        <span class=\"token function\">ObDereferenceObject</span><span class=\"token punctuation\">(</span> driverObject <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"497\"></td><td><pre>        status <span class=\"token operator\">=</span> STATUS_INSUFFICIENT_RESOURCES<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"498\"></td><td><pre>        <span class=\"token keyword\">goto</span> IopLoadExit<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"499\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"500\"></td><td><pre></pre></td></tr><tr><td data-num=\"501\"></td><td><pre>    status <span class=\"token operator\">=</span> <span class=\"token function\">NtQueryObject</span><span class=\"token punctuation\">(</span> KeyHandle<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"502\"></td><td><pre>                            ObjectNameInformation<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"503\"></td><td><pre>                            registryPath<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"504\"></td><td><pre>                            PAGE_SIZE<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"505\"></td><td><pre>                            <span class=\"token operator\">&amp;</span>i <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"506\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token function\">NT_SUCCESS</span><span class=\"token punctuation\">(</span> status <span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"507\"></td><td><pre>        <span class=\"token function\">ObMakeTemporaryObject</span><span class=\"token punctuation\">(</span> driverObject <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"508\"></td><td><pre>        <span class=\"token function\">ObDereferenceObject</span><span class=\"token punctuation\">(</span> driverObject <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"509\"></td><td><pre>        <span class=\"token function\">ExFreePool</span><span class=\"token punctuation\">(</span> registryPath <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"510\"></td><td><pre>        <span class=\"token keyword\">goto</span> IopLoadExit<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"511\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"512\"></td><td><pre></pre></td></tr><tr><td data-num=\"513\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">if</span> <span class=\"token expression\">DBG</span></span></pre></td></tr><tr><td data-num=\"514\"></td><td><pre>    <span class=\"token function\">KeQuerySystemTime</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>stime<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"515\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">endif</span></span></pre></td></tr><tr><td data-num=\"516\"></td><td><pre></pre></td></tr><tr><td data-num=\"517\"></td><td><pre>    <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"518\"></td><td><pre>    <span class=\"token comment\">// Store the service key name of the device driver in the driver object</span></pre></td></tr><tr><td data-num=\"519\"></td><td><pre>    <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"520\"></td><td><pre></pre></td></tr><tr><td data-num=\"521\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>serviceName<span class=\"token punctuation\">.</span>Buffer<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"522\"></td><td><pre>        driverObject<span class=\"token operator\">-></span>DriverExtension<span class=\"token operator\">-></span>ServiceKeyName<span class=\"token punctuation\">.</span>Buffer <span class=\"token operator\">=</span></pre></td></tr><tr><td data-num=\"523\"></td><td><pre>            <span class=\"token function\">ExAllocatePool</span><span class=\"token punctuation\">(</span> NonPagedPool<span class=\"token punctuation\">,</span> serviceName<span class=\"token punctuation\">.</span>MaximumLength <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"524\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>driverObject<span class=\"token operator\">-></span>DriverExtension<span class=\"token operator\">-></span>ServiceKeyName<span class=\"token punctuation\">.</span>Buffer<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"525\"></td><td><pre>            driverObject<span class=\"token operator\">-></span>DriverExtension<span class=\"token operator\">-></span>ServiceKeyName<span class=\"token punctuation\">.</span>MaximumLength <span class=\"token operator\">=</span> serviceName<span class=\"token punctuation\">.</span>MaximumLength<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"526\"></td><td><pre>            driverObject<span class=\"token operator\">-></span>DriverExtension<span class=\"token operator\">-></span>ServiceKeyName<span class=\"token punctuation\">.</span>Length <span class=\"token operator\">=</span> serviceName<span class=\"token punctuation\">.</span>Length<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"527\"></td><td><pre></pre></td></tr><tr><td data-num=\"528\"></td><td><pre>            <span class=\"token function\">RtlCopyMemory</span><span class=\"token punctuation\">(</span> driverObject<span class=\"token operator\">-></span>DriverExtension<span class=\"token operator\">-></span>ServiceKeyName<span class=\"token punctuation\">.</span>Buffer<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"529\"></td><td><pre>                           serviceName<span class=\"token punctuation\">.</span>Buffer<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"530\"></td><td><pre>                           serviceName<span class=\"token punctuation\">.</span>MaximumLength <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"531\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"532\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"533\"></td><td><pre></pre></td></tr><tr><td data-num=\"534\"></td><td><pre>    <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"535\"></td><td><pre>    <span class=\"token comment\">// Now invoke the driver's initialization routine to initialize itself.</span></pre></td></tr><tr><td data-num=\"536\"></td><td><pre>    <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"537\"></td><td><pre></pre></td></tr><tr><td data-num=\"538\"></td><td><pre>    status <span class=\"token operator\">=</span> driverObject<span class=\"token operator\">-></span><span class=\"token function\">DriverInit</span><span class=\"token punctuation\">(</span> driverObject<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>registryPath<span class=\"token operator\">-></span>Name <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"539\"></td><td><pre></pre></td></tr><tr><td data-num=\"540\"></td><td><pre>    <span class=\"token operator\">*</span>DriverEntryStatus <span class=\"token operator\">=</span> status<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"541\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token function\">NT_SUCCESS</span><span class=\"token punctuation\">(</span>status<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"542\"></td><td><pre></pre></td></tr><tr><td data-num=\"543\"></td><td><pre>        status <span class=\"token operator\">=</span> STATUS_FAILED_DRIVER_ENTRY<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"544\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"545\"></td><td><pre></pre></td></tr><tr><td data-num=\"546\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">if</span> <span class=\"token expression\">DBG</span></span></pre></td></tr><tr><td data-num=\"547\"></td><td><pre></pre></td></tr><tr><td data-num=\"548\"></td><td><pre>    <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"549\"></td><td><pre>    <span class=\"token comment\">// If DriverInit took longer than 5 seconds, print a message.</span></pre></td></tr><tr><td data-num=\"550\"></td><td><pre>    <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"551\"></td><td><pre></pre></td></tr><tr><td data-num=\"552\"></td><td><pre>    <span class=\"token function\">KeQuerySystemTime</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>etime<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"553\"></td><td><pre>    dtime  <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>ULONG<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>etime<span class=\"token punctuation\">.</span>QuadPart <span class=\"token operator\">-</span> stime<span class=\"token punctuation\">.</span>QuadPart<span class=\"token punctuation\">)</span> <span class=\"token operator\">/</span> <span class=\"token number\">1000000</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"554\"></td><td><pre></pre></td></tr><tr><td data-num=\"555\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>dtime <span class=\"token operator\">></span> <span class=\"token number\">50</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"556\"></td><td><pre>        <span class=\"token function\">DbgPrint</span><span class=\"token punctuation\">(</span> <span class=\"token string\">\"IOLOAD: Driver %wZ took %d.%ds to %s\\n\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"557\"></td><td><pre>            <span class=\"token operator\">&amp;</span>driverName<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"558\"></td><td><pre>            dtime<span class=\"token operator\">/</span><span class=\"token number\">10</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"559\"></td><td><pre>            dtime<span class=\"token operator\">%</span><span class=\"token number\">10</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"560\"></td><td><pre>            <span class=\"token function\">NT_SUCCESS</span><span class=\"token punctuation\">(</span>status<span class=\"token punctuation\">)</span> <span class=\"token operator\">?</span> <span class=\"token string\">\"initialize\"</span> <span class=\"token operator\">:</span> <span class=\"token string\">\"fail initialization\"</span></pre></td></tr><tr><td data-num=\"561\"></td><td><pre>            <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"562\"></td><td><pre></pre></td></tr><tr><td data-num=\"563\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"564\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">endif</span></span></pre></td></tr><tr><td data-num=\"565\"></td><td><pre></pre></td></tr><tr><td data-num=\"566\"></td><td><pre>    <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"567\"></td><td><pre>    <span class=\"token comment\">// Workaround for broken NT 4.0 3D labs driver</span></pre></td></tr><tr><td data-num=\"568\"></td><td><pre>    <span class=\"token comment\">// They zero out some function table entries by mistake.</span></pre></td></tr><tr><td data-num=\"569\"></td><td><pre></pre></td></tr><tr><td data-num=\"570\"></td><td><pre>    <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span>i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;=</span> IRP_MJ_MAXIMUM_FUNCTION<span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"571\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>driverObject<span class=\"token operator\">-></span>MajorFunction<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span> <span class=\"token operator\">==</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"572\"></td><td><pre>            <span class=\"token function\">ASSERT</span><span class=\"token punctuation\">(</span>driverObject<span class=\"token operator\">-></span>MajorFunction<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span> <span class=\"token operator\">!=</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"573\"></td><td><pre>            driverObject<span class=\"token operator\">-></span>MajorFunction<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> IopInvalidDeviceRequest<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"574\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"575\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"576\"></td><td><pre></pre></td></tr><tr><td data-num=\"577\"></td><td><pre>    <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"578\"></td><td><pre>    <span class=\"token comment\">// If DriverInit doesn't work, then simply unload the image and mark the driver</span></pre></td></tr><tr><td data-num=\"579\"></td><td><pre>    <span class=\"token comment\">// object as temporary.  This will cause everything to be deleted.</span></pre></td></tr><tr><td data-num=\"580\"></td><td><pre>    <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"581\"></td><td><pre></pre></td></tr><tr><td data-num=\"582\"></td><td><pre>    <span class=\"token function\">ExFreePool</span><span class=\"token punctuation\">(</span> registryPath <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"583\"></td><td><pre></pre></td></tr><tr><td data-num=\"584\"></td><td><pre>    <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"585\"></td><td><pre>    <span class=\"token comment\">// If we load the driver because we think it is a legacy driver and</span></pre></td></tr><tr><td data-num=\"586\"></td><td><pre>    <span class=\"token comment\">// it does not create any device object in its DriverEntry.  We will</span></pre></td></tr><tr><td data-num=\"587\"></td><td><pre>    <span class=\"token comment\">// unload this driver.</span></pre></td></tr><tr><td data-num=\"588\"></td><td><pre>    <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"589\"></td><td><pre></pre></td></tr><tr><td data-num=\"590\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">NT_SUCCESS</span><span class=\"token punctuation\">(</span>status<span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token operator\">!</span><span class=\"token function\">IopIsLegacyDriver</span><span class=\"token punctuation\">(</span>driverObject<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"591\"></td><td><pre></pre></td></tr><tr><td data-num=\"592\"></td><td><pre>        status <span class=\"token operator\">=</span> <span class=\"token function\">IopPnpDriverStarted</span><span class=\"token punctuation\">(</span>driverObject<span class=\"token punctuation\">,</span> KeyHandle<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>serviceName<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"593\"></td><td><pre></pre></td></tr><tr><td data-num=\"594\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token function\">NT_SUCCESS</span><span class=\"token punctuation\">(</span>status<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"595\"></td><td><pre>            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>driverObject<span class=\"token operator\">-></span>DriverUnload<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"596\"></td><td><pre>                driverObject<span class=\"token operator\">-></span>Flags <span class=\"token operator\">|=</span> DRVO_UNLOAD_INVOKED<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"597\"></td><td><pre>                driverObject<span class=\"token operator\">-></span><span class=\"token function\">DriverUnload</span><span class=\"token punctuation\">(</span>driverObject<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"598\"></td><td><pre>                <span class=\"token function\">IopBootLog</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>baseName<span class=\"token punctuation\">,</span> FALSE<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"599\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"600\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">if</span> <span class=\"token expression\">DBG</span></span></pre></td></tr><tr><td data-num=\"601\"></td><td><pre>                <span class=\"token function\">DbgPrint</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"IopLoadDriver: A PnP driver %wZ does not support DriverUnload routine.\\n\"</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>driverName<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"602\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">endif</span></span></pre></td></tr><tr><td data-num=\"603\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"604\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"605\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"606\"></td><td><pre></pre></td></tr><tr><td data-num=\"607\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token function\">NT_SUCCESS</span><span class=\"token punctuation\">(</span> status <span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"608\"></td><td><pre>        <span class=\"token function\">ObMakeTemporaryObject</span><span class=\"token punctuation\">(</span> driverObject <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"609\"></td><td><pre>        <span class=\"token function\">ObDereferenceObject</span><span class=\"token punctuation\">(</span> driverObject <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"610\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"611\"></td><td><pre></pre></td></tr><tr><td data-num=\"612\"></td><td><pre>        <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"613\"></td><td><pre>        <span class=\"token comment\">// Free the memory occupied by the driver's initialization routines.</span></pre></td></tr><tr><td data-num=\"614\"></td><td><pre>        <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"615\"></td><td><pre></pre></td></tr><tr><td data-num=\"616\"></td><td><pre>        <span class=\"token function\">IopBootLog</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>baseName<span class=\"token punctuation\">,</span> TRUE<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"617\"></td><td><pre>        <span class=\"token function\">MmFreeDriverInitialization</span><span class=\"token punctuation\">(</span> driverObject<span class=\"token operator\">-></span>DriverSection <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"618\"></td><td><pre>        <span class=\"token function\">IopReadyDeviceObjects</span><span class=\"token punctuation\">(</span> driverObject <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"619\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"620\"></td><td><pre></pre></td></tr><tr><td data-num=\"621\"></td><td><pre>IopLoadExit<span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"622\"></td><td><pre></pre></td></tr><tr><td data-num=\"623\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">NT_SUCCESS</span><span class=\"token punctuation\">(</span>status<span class=\"token punctuation\">)</span> <span class=\"token operator\">||</span> <span class=\"token punctuation\">(</span>status <span class=\"token operator\">==</span> STATUS_IMAGE_ALREADY_LOADED<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"624\"></td><td><pre>        <span class=\"token function\">HeadlessKernelAddLogEntry</span><span class=\"token punctuation\">(</span>HEADLESS_LOG_LOAD_SUCCESSFUL<span class=\"token punctuation\">,</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"625\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"626\"></td><td><pre>        <span class=\"token function\">HeadlessKernelAddLogEntry</span><span class=\"token punctuation\">(</span>HEADLESS_LOG_LOAD_FAILED<span class=\"token punctuation\">,</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"627\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"628\"></td><td><pre></pre></td></tr><tr><td data-num=\"629\"></td><td><pre>    <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"630\"></td><td><pre>    <span class=\"token comment\">// Free any pool that was allocated by this routine that has not yet</span></pre></td></tr><tr><td data-num=\"631\"></td><td><pre>    <span class=\"token comment\">// been freed.</span></pre></td></tr><tr><td data-num=\"632\"></td><td><pre>    <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"633\"></td><td><pre></pre></td></tr><tr><td data-num=\"634\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>driverName<span class=\"token punctuation\">.</span>Buffer <span class=\"token operator\">!=</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"635\"></td><td><pre>        <span class=\"token function\">ExFreePool</span><span class=\"token punctuation\">(</span> driverName<span class=\"token punctuation\">.</span>Buffer <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"636\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"637\"></td><td><pre></pre></td></tr><tr><td data-num=\"638\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>keyBasicInformation <span class=\"token operator\">!=</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"639\"></td><td><pre>        <span class=\"token function\">ExFreePool</span><span class=\"token punctuation\">(</span> keyBasicInformation <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"640\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"641\"></td><td><pre></pre></td></tr><tr><td data-num=\"642\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>serviceName<span class=\"token punctuation\">.</span>Buffer <span class=\"token operator\">!=</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"643\"></td><td><pre>        <span class=\"token function\">ExFreePool</span><span class=\"token punctuation\">(</span>serviceName<span class=\"token punctuation\">.</span>Buffer<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"644\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"645\"></td><td><pre></pre></td></tr><tr><td data-num=\"646\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>baseName<span class=\"token punctuation\">.</span>Buffer <span class=\"token operator\">!=</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"647\"></td><td><pre>        <span class=\"token function\">ExFreePool</span><span class=\"token punctuation\">(</span>baseName<span class=\"token punctuation\">.</span>Buffer<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"648\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"649\"></td><td><pre></pre></td></tr><tr><td data-num=\"650\"></td><td><pre>    <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"651\"></td><td><pre>    <span class=\"token comment\">// If this routine is about to return a failure, then let the Configuration</span></pre></td></tr><tr><td data-num=\"652\"></td><td><pre>    <span class=\"token comment\">// Manager know about it.  But, if STATUS_PLUGPLAY_NO_DEVICE, the device was</span></pre></td></tr><tr><td data-num=\"653\"></td><td><pre>    <span class=\"token comment\">// disabled by hardware profile.  In this case we don't need to report it.</span></pre></td></tr><tr><td data-num=\"654\"></td><td><pre>    <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"655\"></td><td><pre></pre></td></tr><tr><td data-num=\"656\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token function\">NT_SUCCESS</span><span class=\"token punctuation\">(</span> status <span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token punctuation\">(</span>status <span class=\"token operator\">!=</span> STATUS_PLUGPLAY_NO_DEVICE<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"657\"></td><td><pre></pre></td></tr><tr><td data-num=\"658\"></td><td><pre>        NTSTATUS lStatus<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"659\"></td><td><pre>        PULONG errorControl<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"660\"></td><td><pre>        PKEY_VALUE_FULL_INFORMATION keyValueInformation<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"661\"></td><td><pre></pre></td></tr><tr><td data-num=\"662\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>status <span class=\"token operator\">!=</span> STATUS_IMAGE_ALREADY_LOADED<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"663\"></td><td><pre></pre></td></tr><tr><td data-num=\"664\"></td><td><pre>            <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"665\"></td><td><pre>            <span class=\"token comment\">// If driver was loaded, do not call IopDriverLoadingFailed to change</span></pre></td></tr><tr><td data-num=\"666\"></td><td><pre>            <span class=\"token comment\">// the driver loading status.  Because, obviously, the driver is</span></pre></td></tr><tr><td data-num=\"667\"></td><td><pre>            <span class=\"token comment\">// running.</span></pre></td></tr><tr><td data-num=\"668\"></td><td><pre>            <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"669\"></td><td><pre></pre></td></tr><tr><td data-num=\"670\"></td><td><pre>            <span class=\"token function\">IopDriverLoadingFailed</span><span class=\"token punctuation\">(</span>KeyHandle<span class=\"token punctuation\">,</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"671\"></td><td><pre>            lStatus <span class=\"token operator\">=</span> <span class=\"token function\">IopGetRegistryValue</span><span class=\"token punctuation\">(</span> KeyHandle<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"672\"></td><td><pre>                                           L<span class=\"token string\">\"ErrorControl\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"673\"></td><td><pre>                                           <span class=\"token operator\">&amp;</span>keyValueInformation <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"674\"></td><td><pre>            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token function\">NT_SUCCESS</span><span class=\"token punctuation\">(</span> lStatus <span class=\"token punctuation\">)</span> <span class=\"token operator\">||</span> <span class=\"token operator\">!</span>keyValueInformation<span class=\"token operator\">-></span>DataLength<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"675\"></td><td><pre>                <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">NT_SUCCESS</span><span class=\"token punctuation\">(</span> lStatus <span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"676\"></td><td><pre>                    <span class=\"token function\">ExFreePool</span><span class=\"token punctuation\">(</span> keyValueInformation <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"677\"></td><td><pre>                <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"678\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"679\"></td><td><pre>                errorControl <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>PULONG<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>PUCHAR<span class=\"token punctuation\">)</span> keyValueInformation <span class=\"token operator\">+</span> keyValueInformation<span class=\"token operator\">-></span>DataOffset<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"680\"></td><td><pre>                <span class=\"token function\">CmBootLastKnownGood</span><span class=\"token punctuation\">(</span> <span class=\"token operator\">*</span>errorControl <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"681\"></td><td><pre>                <span class=\"token function\">ExFreePool</span><span class=\"token punctuation\">(</span> keyValueInformation <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"682\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"683\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"684\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"685\"></td><td><pre></pre></td></tr><tr><td data-num=\"686\"></td><td><pre>    <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"687\"></td><td><pre>    <span class=\"token comment\">// Close the caller's handle and return the final status from the load</span></pre></td></tr><tr><td data-num=\"688\"></td><td><pre>    <span class=\"token comment\">// operation.</span></pre></td></tr><tr><td data-num=\"689\"></td><td><pre>    <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"690\"></td><td><pre></pre></td></tr><tr><td data-num=\"691\"></td><td><pre>    <span class=\"token function\">ObCloseHandle</span><span class=\"token punctuation\">(</span> KeyHandle <span class=\"token punctuation\">,</span> KernelMode<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"692\"></td><td><pre>    <span class=\"token keyword\">return</span> status<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"693\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>其中这个链表就是我们在 0 环的断的链表，链表由操作系统填充。</p>\n<p><img data-src=\"image003.png\" alt=\"\" /></p>\n<p>前期是读取注册表获取驱动信息，然后申请资源然后在  <code>PsLoadedModuleList</code>  这个全局变量插入一个驱动对象。</p>\n<p>接着向下分析，看到有驱动对象相关的操作：</p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>driverObject<span class=\"token operator\">-></span>DriverExtension <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>PDRIVER_EXTENSION<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">(</span>driverObject <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>driverObject<span class=\"token operator\">-></span>DriverExtension<span class=\"token operator\">-></span>DriverObject <span class=\"token operator\">=</span> driverObject<span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>不知道为什么使驱动对象加 1，使驱动扩展节的第一个驱动对象指向自己</p>\n<p><img data-src=\"image004.png\" alt=\"\" /></p>\n<p>接着就是一系列的赋值操作，其中有一个驱动初始化的函数，里面有驱动的入口函数：</p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>driverObject<span class=\"token operator\">-></span>DriverInit <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>PDRIVER_INITIALIZE<span class=\"token punctuation\">)</span> entryPoint<span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p><img data-src=\"image005.png\" alt=\"\" /></p>\n<p>可以发现是 PE 映像。</p>\n<p>下面是给节区赋值：</p>\n<p><code>driverObject-&gt;DriverSection = sectionPointer;</code></p>\n<p><code>sectionPointer</code>  这样被赋值了</p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>status <span class=\"token operator\">=</span> <span class=\"token function\">MmLoadSystemImage</span><span class=\"token punctuation\">(</span> <span class=\"token operator\">&amp;</span>baseName<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>                                <span class=\"token constant\">NULL</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>                                <span class=\"token constant\">NULL</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>                                <span class=\"token number\">0</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>                                <span class=\"token operator\">&amp;</span>sectionPointer<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>                                <span class=\"token punctuation\">(</span>PVOID <span class=\"token operator\">*</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;</span>imageBaseAddress <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>跟一下  <code>MmLoadSystemImage</code>  这个函数:</p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>NTSTATUS</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token function\">MmLoadSystemImage</span> <span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    IN PUNICODE_STRING ImageFileName<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    IN PUNICODE_STRING NamePrefix OPTIONAL<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    IN PUNICODE_STRING LoadedBaseName OPTIONAL<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    IN ULONG LoadFlags<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    OUT PVOID <span class=\"token operator\">*</span>ImageHandle<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    OUT PVOID <span class=\"token operator\">*</span>ImageBaseAddress</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token punctuation\">)</span></pre></td></tr></table></figure><p>我们只看其对倒数第二个函数的操作：</p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token operator\">*</span>ImageHandle <span class=\"token operator\">=</span> DataTableEntry<span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>发现有对其赋值的操作，查看  <code>DataTableEntry</code> :</p>\n<p>查看其声明  <code>PKLDR_DATA_TABLE_ENTRY DataTableEntry;</code></p>\n<p>查看类型：</p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">typedef</span> <span class=\"token keyword\">struct</span> <span class=\"token class-name\">_KLDR_DATA_TABLE_ENTRY</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    LIST_ENTRY InLoadOrderLinks<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    PVOID ExceptionTable<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    ULONG ExceptionTableSize<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token comment\">// ULONG padding on IA64</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    PVOID GpValue<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    PNON_PAGED_DEBUG_INFO NonPagedDebugInfo<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    PVOID DllBase<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    PVOID EntryPoint<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    ULONG SizeOfImage<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    UNICODE_STRING FullDllName<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    UNICODE_STRING BaseDllName<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    ULONG Flags<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    USHORT LoadCount<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    USHORT __Unused5<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    PVOID SectionPointer<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    ULONG CheckSum<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>    <span class=\"token comment\">// ULONG padding on IA64</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    PVOID LoadedImports<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>    PVOID PatchInformation<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre><span class=\"token punctuation\">&#125;</span> KLDR_DATA_TABLE_ENTRY<span class=\"token punctuation\">,</span> <span class=\"token operator\">*</span>PKLDR_DATA_TABLE_ENTRY<span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>还是这个链表。</p>\n<p>接着向下分析：</p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>status <span class=\"token operator\">=</span> <span class=\"token function\">ObInsertObject</span><span class=\"token punctuation\">(</span> driverObject<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>                             <span class=\"token punctuation\">(</span>PACCESS_STATE<span class=\"token punctuation\">)</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>                             FILE_READ_DATA<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>                             <span class=\"token number\">0</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>                             <span class=\"token punctuation\">(</span>PVOID <span class=\"token operator\">*</span><span class=\"token punctuation\">)</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>                             <span class=\"token operator\">&amp;</span>driverHandle <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>这个函数的介绍是：这个例程在当前进程句柄表中插入一个对象。</p>\n<p>接着下面的函数是资源相关的，暂时不分析。</p>\n<p>接着又是测试  <code>ObReferenceObjectByHandle</code>  函数，</p>\n<p>WRK 中的函数介绍为：给定一个对象的句柄，这个例程返回一个指向具有适当引用计数的对象主体的指针。</p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>status <span class=\"token operator\">=</span> <span class=\"token function\">ObReferenceObjectByHandle</span><span class=\"token punctuation\">(</span> driverHandle<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>                                    <span class=\"token number\">0</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>                                    IoDriverObjectType<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>                                    <span class=\"token function\">KeGetPreviousMode</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>                                    <span class=\"token punctuation\">(</span>PVOID <span class=\"token operator\">*</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;</span>driverObject<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>                                    <span class=\"token punctuation\">(</span>POBJECT_HANDLE_INFORMATION<span class=\"token punctuation\">)</span> <span class=\"token constant\">NULL</span> <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token function\">ASSERT</span><span class=\"token punctuation\">(</span>status <span class=\"token operator\">==</span> STATUS_SUCCESS<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token function\">NtClose</span><span class=\"token punctuation\">(</span> driverHandle <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>判读是否成功后就关闭句柄了。</p>\n<p>接着向下分析直到看到调用入口点了：</p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>status <span class=\"token operator\">=</span> driverObject<span class=\"token operator\">-></span><span class=\"token function\">DriverInit</span><span class=\"token punctuation\">(</span> driverObject<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>registryPath<span class=\"token operator\">-></span>Name <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token operator\">*</span>DriverEntryStatus <span class=\"token operator\">=</span> status<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token function\">NT_SUCCESS</span><span class=\"token punctuation\">(</span>status<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  status <span class=\"token operator\">=</span> STATUS_FAILED_DRIVER_ENTRY<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>也就是说只要符合 PE 文件格式的，我们自己可以构造，就是用 mian 函数构造两个参数，分别接受这个两个对象，一样的可以贴到这个内核里面，通过服务注册，因为从上到下来看它并没用做什么校验。--- 火哥原话 …… 没听懂。</p>\n<p><strong>这里还有一个扩展知识</strong><br />\n调用  <code>DriverInit</code>  函数时有一个返回，如果不成功，还会把这个返回值给下一个函数，而下一个函数会把这个加载失败的驱动给去掉。而这种一次性的加载能干什么呢？<br />\n如果我们是想提权，直接在 DriverEntry 中构建一个调用门或者构建一个中断，然后把我们的函数拷贝到自己分配的一块内存，把 ShellCode 拷进去，这样我们驱动返回失败，驱动被摘除，只留下了一块内存（函数）了，基本就检测不到了。</p>\n<p><code>IopLoadExit</code>  后面都是释放了内存。</p>\n<p>如图：</p>\n<p><img data-src=\"image006.png\" alt=\"\" /></p>\n<p>系统已经自己抹去 PE 指纹了，初始化函数已经没了。</p>\n<p>操作系统并没有把驱动对象放到全局变量中保存，只是一个局部变量，唯一做得就是放到链表中保存，搞定这个链表就把驱动隐藏了。</p>\n<p>操作系统若不释放的话，谁都能找到这个驱动的入口的点了:</p>\n<p><img data-src=\"image008.png\" alt=\"\" /></p>\n<p>当操作系统抹去 PE 指纹后，就不是一个 PE 文件了，只是一块内存注入到了内核空间中（高 2G 上）。<br />\n所以在这里，所有的东西都被抹掉了，只能通过这个链表才能找的着，那我们如何在这里动手脚呢？</p>\n<p>还是需要看这两个结构体：</p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>kd<span class=\"token operator\">></span> <span class=\"token operator\">?</span><span class=\"token operator\">?</span> <span class=\"token operator\">/</span>s pdriver</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">struct</span> <span class=\"token class-name\">_DRIVER_OBJECT</span> <span class=\"token operator\">*</span> <span class=\"token number\">0x89d35f38</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>   <span class=\"token operator\">+</span><span class=\"token number\">0x000</span> Type             <span class=\"token operator\">:</span> <span class=\"token number\">0</span>n4</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>   <span class=\"token operator\">+</span><span class=\"token number\">0x002</span> Size             <span class=\"token operator\">:</span> <span class=\"token number\">0</span>n168</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>   <span class=\"token operator\">+</span><span class=\"token number\">0x004</span> DeviceObject     <span class=\"token operator\">:</span> <span class=\"token punctuation\">(</span>null<span class=\"token punctuation\">)</span> </pre></td></tr><tr><td data-num=\"6\"></td><td><pre>   <span class=\"token operator\">+</span><span class=\"token number\">0x008</span> Flags            <span class=\"token operator\">:</span> <span class=\"token number\">2</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>   <span class=\"token operator\">+</span><span class=\"token number\">0x00c</span> DriverStart      <span class=\"token operator\">:</span> <span class=\"token number\">0xba4a0000</span> Void</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>   <span class=\"token operator\">+</span><span class=\"token number\">0x010</span> DriverSize       <span class=\"token operator\">:</span> <span class=\"token number\">0x6000</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>   <span class=\"token operator\">+</span><span class=\"token number\">0x014</span> DriverSection    <span class=\"token operator\">:</span> <span class=\"token number\">0x89e01618</span> Void</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>   <span class=\"token operator\">+</span><span class=\"token number\">0x018</span> DriverExtension  <span class=\"token operator\">:</span> <span class=\"token number\">0x89d35fe0</span> _DRIVER_EXTENSION</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>   <span class=\"token operator\">+</span><span class=\"token number\">0x01c</span> DriverName       <span class=\"token operator\">:</span> _UNICODE_STRING <span class=\"token string\">\"\\Driver\\DriverHidden111\"</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>   <span class=\"token operator\">+</span><span class=\"token number\">0x024</span> HardwareDatabase <span class=\"token operator\">:</span> <span class=\"token number\">0x8067f260</span> _UNICODE_STRING <span class=\"token string\">\"\\REGISTRY\\MACHINE\\HARDWARE\\DESCRIPTION\\SYSTEM\"</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>   <span class=\"token operator\">+</span><span class=\"token number\">0x028</span> FastIoDispatch   <span class=\"token operator\">:</span> <span class=\"token punctuation\">(</span>null<span class=\"token punctuation\">)</span> </pre></td></tr><tr><td data-num=\"14\"></td><td><pre>   <span class=\"token operator\">+</span><span class=\"token number\">0x02c</span> DriverInit       <span class=\"token operator\">:</span> <span class=\"token number\">0xba4a4000</span>     <span class=\"token keyword\">long</span>  DriverHidden111<span class=\"token operator\">!</span>GsDriverEntry<span class=\"token operator\">+</span><span class=\"token number\">0</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>   <span class=\"token operator\">+</span><span class=\"token number\">0x030</span> DriverStartIo    <span class=\"token operator\">:</span> <span class=\"token punctuation\">(</span>null<span class=\"token punctuation\">)</span> </pre></td></tr><tr><td data-num=\"16\"></td><td><pre>   <span class=\"token operator\">+</span><span class=\"token number\">0x034</span> DriverUnload     <span class=\"token operator\">:</span> <span class=\"token punctuation\">(</span>null<span class=\"token punctuation\">)</span> </pre></td></tr><tr><td data-num=\"17\"></td><td><pre>   <span class=\"token operator\">+</span><span class=\"token number\">0x038</span> MajorFunction    <span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token number\">28</span><span class=\"token punctuation\">]</span> <span class=\"token number\">0x804f55ce</span>     <span class=\"token keyword\">long</span>  nt<span class=\"token operator\">!</span>IopInvalidDeviceRequest<span class=\"token operator\">+</span><span class=\"token number\">0</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>kd<span class=\"token operator\">></span> dt _LDR_DATA_TABLE_ENTRY <span class=\"token number\">0x89e01618</span> </pre></td></tr><tr><td data-num=\"20\"></td><td><pre>nt<span class=\"token operator\">!</span>_LDR_DATA_TABLE_ENTRY</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>   <span class=\"token operator\">+</span><span class=\"token number\">0x000</span> InLoadOrderLinks <span class=\"token operator\">:</span> _LIST_ENTRY <span class=\"token punctuation\">[</span> <span class=\"token number\">0x8055e720</span> <span class=\"token operator\">-</span> <span class=\"token number\">0x8a1b5c30</span> <span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>   <span class=\"token operator\">+</span><span class=\"token number\">0x008</span> InMemoryOrderLinks <span class=\"token operator\">:</span> _LIST_ENTRY <span class=\"token punctuation\">[</span> <span class=\"token number\">0xffffffff</span> <span class=\"token operator\">-</span> <span class=\"token number\">0xffffffff</span> <span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>   <span class=\"token operator\">+</span><span class=\"token number\">0x010</span> InInitializationOrderLinks <span class=\"token operator\">:</span> _LIST_ENTRY <span class=\"token punctuation\">[</span> <span class=\"token number\">0x12</span> <span class=\"token operator\">-</span> <span class=\"token number\">0x0</span> <span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>   <span class=\"token operator\">+</span><span class=\"token number\">0x018</span> DllBase          <span class=\"token operator\">:</span> <span class=\"token number\">0xba4a0000</span> Void</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>   <span class=\"token operator\">+</span><span class=\"token number\">0x01c</span> EntryPoint       <span class=\"token operator\">:</span> <span class=\"token number\">0xba4a4000</span> Void</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>   <span class=\"token operator\">+</span><span class=\"token number\">0x020</span> SizeOfImage      <span class=\"token operator\">:</span> <span class=\"token number\">0x6000</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>   <span class=\"token operator\">+</span><span class=\"token number\">0x024</span> FullDllName      <span class=\"token operator\">:</span> _UNICODE_STRING <span class=\"token string\">\"\\??\\C:\\Documents and Settings\\Administrator\\桌面\\DriverHidden111.sys\"</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>   <span class=\"token operator\">+</span><span class=\"token number\">0x02c</span> BaseDllName      <span class=\"token operator\">:</span> _UNICODE_STRING <span class=\"token string\">\"DriverHidden111.sys\"</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>   <span class=\"token operator\">+</span><span class=\"token number\">0x034</span> Flags            <span class=\"token operator\">:</span> <span class=\"token number\">0x9104000</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>   <span class=\"token operator\">+</span><span class=\"token number\">0x038</span> LoadCount        <span class=\"token operator\">:</span> <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>   <span class=\"token operator\">+</span><span class=\"token number\">0x03a</span> TlsIndex         <span class=\"token operator\">:</span> <span class=\"token number\">0x2d</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>   <span class=\"token operator\">+</span><span class=\"token number\">0x03c</span> HashLinks        <span class=\"token operator\">:</span> _LIST_ENTRY <span class=\"token punctuation\">[</span> <span class=\"token number\">0xffffffff</span> <span class=\"token operator\">-</span> <span class=\"token number\">0xa576</span> <span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>   <span class=\"token operator\">+</span><span class=\"token number\">0x03c</span> SectionPointer   <span class=\"token operator\">:</span> <span class=\"token number\">0xffffffff</span> Void</pre></td></tr><tr><td data-num=\"34\"></td><td><pre>   <span class=\"token operator\">+</span><span class=\"token number\">0x040</span> CheckSum         <span class=\"token operator\">:</span> <span class=\"token number\">0xa576</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>   <span class=\"token operator\">+</span><span class=\"token number\">0x044</span> TimeDateStamp    <span class=\"token operator\">:</span> <span class=\"token number\">0xfffffffe</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>   <span class=\"token operator\">+</span><span class=\"token number\">0x044</span> LoadedImports    <span class=\"token operator\">:</span> <span class=\"token number\">0xfffffffe</span> Void</pre></td></tr><tr><td data-num=\"37\"></td><td><pre>   <span class=\"token operator\">+</span><span class=\"token number\">0x048</span> EntryPointActivationContext <span class=\"token operator\">:</span> <span class=\"token punctuation\">(</span>null<span class=\"token punctuation\">)</span> </pre></td></tr><tr><td data-num=\"38\"></td><td><pre>   <span class=\"token operator\">+</span><span class=\"token number\">0x04c</span> PatchInformation <span class=\"token operator\">:</span> <span class=\"token number\">0x00720044</span> Void</pre></td></tr></table></figure><p>为了看着方便直接就简化了：</p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>kd<span class=\"token operator\">></span> <span class=\"token operator\">?</span><span class=\"token operator\">?</span> <span class=\"token operator\">/</span>s pdriver</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">struct</span> <span class=\"token class-name\">_DRIVER_OBJECT</span> <span class=\"token operator\">*</span> <span class=\"token number\">0x89d35f38</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>   <span class=\"token operator\">+</span><span class=\"token number\">0x000</span> Type             <span class=\"token operator\">:</span> <span class=\"token number\">0</span>n4</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>   <span class=\"token operator\">+</span><span class=\"token number\">0x002</span> Size             <span class=\"token operator\">:</span> <span class=\"token number\">0</span>n168</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>   ……</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>   <span class=\"token operator\">+</span><span class=\"token number\">0x00c</span> DriverStart      <span class=\"token operator\">:</span> <span class=\"token number\">0xba4a0000</span> Void</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>   <span class=\"token operator\">+</span><span class=\"token number\">0x010</span> DriverSize       <span class=\"token operator\">:</span> <span class=\"token number\">0x6000</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>   <span class=\"token operator\">+</span><span class=\"token number\">0x014</span> DriverSection    <span class=\"token operator\">:</span> <span class=\"token number\">0x89e01618</span> Void</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>   ……</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>   <span class=\"token operator\">+</span><span class=\"token number\">0x02c</span> DriverInit       <span class=\"token operator\">:</span> <span class=\"token number\">0xba4a4000</span>     <span class=\"token keyword\">long</span>  DriverHidden111<span class=\"token operator\">!</span>GsDriverEntry<span class=\"token operator\">+</span><span class=\"token number\">0</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>   ……</pre></td></tr><tr><td data-num=\"12\"></td><td><pre></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>kd<span class=\"token operator\">></span> dt _LDR_DATA_TABLE_ENTRY <span class=\"token number\">0x89e01618</span> </pre></td></tr><tr><td data-num=\"14\"></td><td><pre>nt<span class=\"token operator\">!</span>_LDR_DATA_TABLE_ENTRY</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>  ……</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>   <span class=\"token operator\">+</span><span class=\"token number\">0x018</span> DllBase          <span class=\"token operator\">:</span> <span class=\"token number\">0xba4a0000</span> Void</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>   <span class=\"token operator\">+</span><span class=\"token number\">0x01c</span> EntryPoint       <span class=\"token operator\">:</span> <span class=\"token number\">0xba4a4000</span> Void</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>   <span class=\"token operator\">+</span><span class=\"token number\">0x020</span> SizeOfImage      <span class=\"token operator\">:</span> <span class=\"token number\">0x6000</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>  ……</pre></td></tr></table></figure><hr />\n<p>上面逆 IopLoadDriver 函数 主要得到的信息就是：驱动对象不是全局变量，在这个函数结束后就被释放了，唯一保存的地方就是  <code>_LDR_DATA_TABLE_ENTRY</code>  链表中，但为什么我们断链后 PCHunter 仍然能后发现我们的驱动呢？</p>\n<p>其实 PCHunter 并不是遍历链表找驱动，而是进行特征码扫描，去寻找驱动对象的特征，从而定位驱动对象这个结构体。</p>\n<p>PCHunter 是在哪里定位扫描的呢？</p>\n<p>不知道……</p>\n<hr />\n<p>有哪些特征码呢？</p>\n<p>根据  <code>_DRIVER_OBJECT</code>  结构体我们能发现一些固有的 “特征”，这些可以拿来作为特征码遍历内存。</p>\n<p>从结构体来看，加载完后暂时没用的可以作为特征的结构有如下：</p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>CSHORT Type<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>CSHORT Size<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>PVOID DriverStart<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>ULONG DriverSize<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>PVOID DriverSection<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>PDRIVER_EXTENSION DriverExtension<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>UNICODE_STRING DriverName<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>PUNICODE_STRING HardwareDatabase<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>PFAST_IO_DISPATCH FastIoDispatch<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>PDRIVER_INITIALIZE DriverInit<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>PDRIVER_STARTIO DriverStartIo<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>PDRIVER_UNLOAD DriverUnload<span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>其实只要抹掉  <code>DriverSection</code>  就行了，但保险起见可以都抹除了。</p>\n<h1 id=\"编写代码绕过pchunter\"><a class=\"anchor\" href=\"#编写代码绕过pchunter\">#</a> 编写代码绕过 PCHunter</h1>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">// 遍历内核模块</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span><span class=\"token string\">&lt;ntddk.h></span></span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">typedef</span> <span class=\"token keyword\">struct</span> <span class=\"token class-name\">_LDR_DATA_TABLE_ENTRY</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>\tLIST_ENTRY InLoadOrderLinks<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>\tLIST_ENTRY InMemoryOrderLinks<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>\tLIST_ENTRY InInitializationOrderLinks<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>\tPVOID DllBase<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\tPVOID EntryPoint<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\tULONG SizeOfImage<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>\tUNICODE_STRING FullDllName<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>\tUNICODE_STRING BaseDllName<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>\tULONG Flags<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>\tUSHORT LoadCount<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>\tUSHORT TlsIndex<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>\t<span class=\"token keyword\">union</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>\t\tLIST_ENTRY HashLinks<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>\t\t<span class=\"token keyword\">struct</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>\t\t\tPVOID SectionPointer<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>\t\t\tULONG CheckSum<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>\t\t<span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>\t<span class=\"token keyword\">union</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>\t\t<span class=\"token keyword\">struct</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>\t\t\tULONG TimeDateStamp<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>\t\t<span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>\t\t<span class=\"token keyword\">struct</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>\t\t\tPVOID LoadedImports<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>\t\t<span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>\t<span class=\"token keyword\">struct</span> <span class=\"token class-name\">_ACTIVATION_CONTEXT</span><span class=\"token operator\">*</span> EntryPointActivationContext<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>\tPVOID PatchInformation<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre></pre></td></tr><tr><td data-num=\"35\"></td><td><pre><span class=\"token punctuation\">&#125;</span> LDR_DATA_TABLE_ENTRY<span class=\"token punctuation\">,</span> <span class=\"token operator\">*</span> PLDR_DATA_TABLE_ENTRY<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>HANDLE hThread<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>VOID <span class=\"token function\">ThreadRun</span><span class=\"token punctuation\">(</span>_In_ PVOID StartContext<span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>\t<span class=\"token function\">DbgPrint</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"线程开始执行！\\n\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>\tLARGE_INTEGER times<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>\ttimes<span class=\"token punctuation\">.</span>QuadPart <span class=\"token operator\">=</span> <span class=\"token operator\">-</span><span class=\"token number\">30</span> <span class=\"token operator\">*</span> <span class=\"token number\">1000</span> <span class=\"token operator\">*</span> <span class=\"token number\">1000</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>\t<span class=\"token function\">KeDelayExecutionThread</span><span class=\"token punctuation\">(</span>KernelMode<span class=\"token punctuation\">,</span> FALSE<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>times<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>\tPDRIVER_OBJECT pDriver <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>PDRIVER_OBJECT<span class=\"token punctuation\">)</span>StartContext<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>\tpDriver<span class=\"token operator\">-></span>DriverSize <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>\tpDriver<span class=\"token operator\">-></span>DriverSection <span class=\"token operator\">=</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>\tpDriver<span class=\"token operator\">-></span>DriverStart <span class=\"token operator\">=</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>\tpDriver<span class=\"token operator\">-></span>DriverInit <span class=\"token operator\">=</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>\tpDriver<span class=\"token operator\">-></span>DriverStartIo <span class=\"token operator\">=</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>\tpDriver<span class=\"token operator\">-></span>FastIoDispatch <span class=\"token operator\">=</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>\tpDriver<span class=\"token operator\">-></span>DriverExtension <span class=\"token operator\">=</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre>\t<span class=\"token function\">ZwClose</span><span class=\"token punctuation\">(</span>hThread<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>\t<span class=\"token function\">DbgPrint</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"线程结束执行！\\n\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>VOID <span class=\"token function\">DriverUnload</span><span class=\"token punctuation\">(</span>PDRIVER_OBJECT pdriver<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre>\t<span class=\"token function\">DbgPrint</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"我是驱动，我卸载了\\n\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"59\"></td><td><pre></pre></td></tr><tr><td data-num=\"60\"></td><td><pre>NTSTATUS <span class=\"token function\">DriverEntry</span><span class=\"token punctuation\">(</span>PDRIVER_OBJECT pdriver<span class=\"token punctuation\">,</span> PUNICODE_STRING reg_path<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"61\"></td><td><pre>\t<span class=\"token function\">DbgPrint</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"我是驱动，我运行了\\n\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"62\"></td><td><pre>\t__asm <span class=\"token keyword\">int</span> <span class=\"token number\">3</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"63\"></td><td><pre></pre></td></tr><tr><td data-num=\"64\"></td><td><pre>\tPLDR_DATA_TABLE_ENTRY pLdtePre<span class=\"token punctuation\">;</span> <span class=\"token comment\">// </span></pre></td></tr><tr><td data-num=\"65\"></td><td><pre>\tPLDR_DATA_TABLE_ENTRY pLdteCur<span class=\"token punctuation\">;</span> <span class=\"token comment\">// </span></pre></td></tr><tr><td data-num=\"66\"></td><td><pre>\tPLDR_DATA_TABLE_ENTRY pLdteNex<span class=\"token punctuation\">;</span> <span class=\"token comment\">// </span></pre></td></tr><tr><td data-num=\"67\"></td><td><pre></pre></td></tr><tr><td data-num=\"68\"></td><td><pre>\tpLdteCur <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>PLDR_DATA_TABLE_ENTRY<span class=\"token punctuation\">)</span>pdriver<span class=\"token operator\">-></span>DriverSection<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"69\"></td><td><pre>\tpLdtePre <span class=\"token operator\">=</span> pLdteCur<span class=\"token operator\">-></span>InLoadOrderLinks<span class=\"token punctuation\">.</span>Blink<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"70\"></td><td><pre>\tpLdteNex <span class=\"token operator\">=</span> pLdteCur<span class=\"token operator\">-></span>InLoadOrderLinks<span class=\"token punctuation\">.</span>Flink<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"71\"></td><td><pre>\tpLdtePre<span class=\"token operator\">-></span>InLoadOrderLinks<span class=\"token punctuation\">.</span>Flink <span class=\"token operator\">=</span> pLdteCur<span class=\"token operator\">-></span>InLoadOrderLinks<span class=\"token punctuation\">.</span>Flink<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"72\"></td><td><pre>\tpLdteNex<span class=\"token operator\">-></span>InLoadOrderLinks<span class=\"token punctuation\">.</span>Blink <span class=\"token operator\">=</span> pLdteCur<span class=\"token operator\">-></span>InLoadOrderLinks<span class=\"token punctuation\">.</span>Blink<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"73\"></td><td><pre></pre></td></tr><tr><td data-num=\"74\"></td><td><pre>\tpdriver<span class=\"token operator\">-></span>DriverUnload <span class=\"token operator\">=</span> DriverUnload<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"75\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"76\"></td><td><pre>\t<span class=\"token function\">PsCreateSystemThread</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>hThread<span class=\"token punctuation\">,</span> GENERIC_ALL<span class=\"token punctuation\">,</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">,</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">,</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">,</span> ThreadRun<span class=\"token punctuation\">,</span> pdriver<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"77\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"78\"></td><td><pre>\t<span class=\"token keyword\">return</span> STATUS_SUCCESS<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"79\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>这里有点不好的地方就是无法卸载此驱动，就算在  <code>UnloadDriver</code>  填写了恢复代码。具体详情需要分析  <code>IopUnloadDriver</code>   看它什么时候调用该函数。</p>\n<p>结果：</p>\n<p><img data-src=\"image009.png\" alt=\"\" /></p>\n<p>经过火哥测试，在 win7 下也是可以隐藏的。</p>\n",
            "tags": [
                "隐藏驱动",
                "IopLoadDriver"
            ]
        },
        {
            "id": "https://or0kit.github.io/Bin/Core/Drive-Development/%E9%A9%B1%E5%8A%A8%E5%BC%80%E5%8F%91-%E5%86%85%E6%A0%B8%E7%BC%96%E7%A8%8B%E5%B8%B8%E7%94%A8%E6%8A%80%E5%B7%A7/",
            "url": "https://or0kit.github.io/Bin/Core/Drive-Development/%E9%A9%B1%E5%8A%A8%E5%BC%80%E5%8F%91-%E5%86%85%E6%A0%B8%E7%BC%96%E7%A8%8B%E5%B8%B8%E7%94%A8%E6%8A%80%E5%B7%A7/",
            "title": "驱动开发-内核编程常用技巧",
            "date_published": "2021-12-06T14:12:04.000Z",
            "content_html": "<h1 id=\"\"><a class=\"anchor\" href=\"#\">#</a> </h1>\n",
            "tags": []
        },
        {
            "id": "https://or0kit.github.io/Bin/Core/Drive-Development/%E9%A9%B1%E5%8A%A8%E5%BC%80%E5%8F%91-64%E4%BD%8D%E4%B8%8E32%E4%BD%8D%E5%86%85%E6%A0%B8%E5%BC%80%E5%8F%91%E5%B7%AE%E5%BC%82/",
            "url": "https://or0kit.github.io/Bin/Core/Drive-Development/%E9%A9%B1%E5%8A%A8%E5%BC%80%E5%8F%91-64%E4%BD%8D%E4%B8%8E32%E4%BD%8D%E5%86%85%E6%A0%B8%E5%BC%80%E5%8F%91%E5%B7%AE%E5%BC%82/",
            "title": "驱动开发-64位与32位内核开发差异",
            "date_published": "2021-12-06T14:11:07.000Z",
            "content_html": "<h1 id=\"\"><a class=\"anchor\" href=\"#\">#</a> </h1>\n",
            "tags": []
        },
        {
            "id": "https://or0kit.github.io/Bin/Core/Drive-Development/%E9%A9%B1%E5%8A%A8%E5%BC%80%E5%8F%91-%E5%86%85%E6%A0%B8%E7%BC%96%E7%A8%8B%E5%9F%BA%E7%A1%80plus/",
            "url": "https://or0kit.github.io/Bin/Core/Drive-Development/%E9%A9%B1%E5%8A%A8%E5%BC%80%E5%8F%91-%E5%86%85%E6%A0%B8%E7%BC%96%E7%A8%8B%E5%9F%BA%E7%A1%80plus/",
            "title": "驱动开发-内核编程基础plus",
            "date_published": "2021-12-06T14:08:01.000Z",
            "content_html": "<h1 id=\"楔子\"><a class=\"anchor\" href=\"#楔子\">#</a> 楔子</h1>\n<p>学习一下常用的驱动编程机制。</p>\n<h1 id=\"上下文环境\"><a class=\"anchor\" href=\"#上下文环境\">#</a> 上下文环境</h1>\n<p>应用层 EXE 有独立进程的概念。当这个 EXE 运行的时候，开发者可以很清楚地知道程序的定运行在哪一个线程中。对于内核驱动开发来说，进程的概念啊显得相当模糊，初学者往往不清楚自己的驱动代码具体运行在什么进程或线程中。</p>\n<p>这就是需要了解的上下文 (Context) 概念，上下文泛指 CPU 在执行代码时，该代码所处的环境与状态。通俗来讲，这些环境包括（不仅限）：当前代码所属线程、中断请求级别、CPU 寄存器各状态。</p>\n<p>这里可以做一个小实验，写代码验证一下。<br />\n写一个简单的驱动代码，测试驱动入口函数和驱动卸载函数在执行时是属于哪一个进程的，只要在这两个函数中调用  <code>PsGetCurrentProcessId</code>  函数获取当前进程 ID 就行。</p>\n<p>这里我就直接说结果了。</p>\n<p>无论是驱动入口函数还是驱动卸载函数，都隶属于进程 ID 为 4 的进程，也就是 SYSTEM 进程。</p>\n<p>SYSTEM 进程其实是操作系统虚拟出来的一个进程，代表系统内核。一般来说内核代码都处于 SYSTEM 进程空间中，但驱动对象（DRIVER_OBJECT）的派遣例程一般工作在发起请求的进程中。</p>\n<p><strong>地址空间</strong>，对 32 位系统来说，应用层程序有独立的 2GB 低地址虚拟内存空间，而高地址的 2GB 是内核共享的地址空间。<br />\n在 64 位 Windows 中，虚拟地址空间的理论大小为 2 的 64 次方字节，但实际使用的仅一小部分，范围从  <code>0x000`00000000</code>  至  <code>0x7FF`FFFFFFFF</code>  的 8TB 用于应用层空间，范围从  <code>0xFFFF0800`00000000</code>  至  <code>0xFFFFFFFF`FFFFFFFF</code>  的 248TB 用于内核空间。</p>\n<h1 id=\"中断请求级别\"><a class=\"anchor\" href=\"#中断请求级别\">#</a> 中断请求级别</h1>\n<h1 id=\"链表\"><a class=\"anchor\" href=\"#链表\">#</a> 链表</h1>\n<p>链表作为内核</p>\n<h1 id=\"自旋锁\"><a class=\"anchor\" href=\"#自旋锁\">#</a> 自旋锁</h1>\n<h1 id=\"注册表\"><a class=\"anchor\" href=\"#注册表\">#</a> 注册表</h1>\n<p>注册表是 Windows 系统中最重要的数据配置存储结构，存储着系统绝大部分的核心配置信息。注册表实际上也是一种文件。这些文件大多数存储在<strong>系统盘</strong> system32\\config 目录下。</p>\n<p>在资源管理器中我没有权限访问，懒得更改了，我在 cmd 中查看如下：</p>\n<figure class=\"highlight raw\"><figcaption data-lang=\"\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>C:\\Windows\\System32\\config&gt;dir</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>C:\\Windows\\System32\\config 的目录</pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>2022&#x2F;05&#x2F;09  13:09    &lt;DIR&gt;          .</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>2022&#x2F;05&#x2F;09  13:09    &lt;DIR&gt;          ..</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>2022&#x2F;05&#x2F;06  00:57           524,288 BBI</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>2022&#x2F;01&#x2F;26  16:46            28,672 BCD-Template</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>2022&#x2F;05&#x2F;09  18:04        38,797,312 COMPONENTS</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>2022&#x2F;05&#x2F;06  00:57           786,432 DEFAULT</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>2022&#x2F;05&#x2F;09  17:31         8,118,272 DRIVERS</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>2022&#x2F;01&#x2F;26  18:14            32,768 ELAM</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>2022&#x2F;01&#x2F;26  16:37    &lt;DIR&gt;          Journal</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>2022&#x2F;01&#x2F;26  16:37    &lt;DIR&gt;          RegBack</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>2022&#x2F;05&#x2F;06  00:57           131,072 SAM</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>2022&#x2F;05&#x2F;06  00:57            65,536 SECURITY</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>2022&#x2F;05&#x2F;06  00:57       118,489,088 SOFTWARE</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>2022&#x2F;05&#x2F;06  00:57        24,903,680 SYSTEM</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>2022&#x2F;01&#x2F;26  16:37    &lt;DIR&gt;          systemprofile</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>2022&#x2F;01&#x2F;26  16:37    &lt;DIR&gt;          TxR</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>2022&#x2F;01&#x2F;26  16:40             8,192 userdiff</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>              11 个文件    191,885,312 字节</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>               6 个目录 50,612,371,456 可用字节</pre></td></tr></table></figure><p>可以看到  <code>SOFTWARE</code>  、  <code>SYSTEM</code>  、  <code>SAM</code>  、等文件，这些文件被以<strong>内存映射</strong>的方式映射到内核空间，然后以一种被称为 “HIVE&quot; 的方式组织起来、注册表 API 实际上操作的是这份 HIVE 内存数据，对 HIVE 数据的改动，最终会被回写到 config 目录下对应的文件中。</p>\n<p>如果只是想单纯的使用注册表做数据读取或存储，可以没有必要深入去研究内核对注册表的实现方式。</p>\n<h2 id=\"注册表的打开与关闭\"><a class=\"anchor\" href=\"#注册表的打开与关闭\">#</a> 注册表的打开与关闭</h2>\n<h2 id=\"注册表的修改\"><a class=\"anchor\" href=\"#注册表的修改\">#</a> 注册表的修改</h2>\n<h2 id=\"注册表的读取\"><a class=\"anchor\" href=\"#注册表的读取\">#</a> 注册表的读取</h2>\n<h2 id=\"作业\"><a class=\"anchor\" href=\"#作业\">#</a> 作业</h2>\n<h3 id=\"注册表实现驱动的自启\"><a class=\"anchor\" href=\"#注册表实现驱动的自启\">#</a> 注册表实现驱动的自启</h3>\n<p>驱动文件的转移</p>\n<h1 id=\"文件操作\"><a class=\"anchor\" href=\"#文件操作\">#</a> 文件操作</h1>\n<h2 id=\"文件的打开与关闭\"><a class=\"anchor\" href=\"#文件的打开与关闭\">#</a> 文件的打开与关闭</h2>\n<h2 id=\"文件的读写\"><a class=\"anchor\" href=\"#文件的读写\">#</a> 文件的读写</h2>\n<h2 id=\"文件的删除\"><a class=\"anchor\" href=\"#文件的删除\">#</a> 文件的删除</h2>\n<p>强行删除<br />\n文件的保护</p>\n<h2 id=\"作业-2\"><a class=\"anchor\" href=\"#作业-2\">#</a> 作业</h2>\n<p>在内核中实现文件的拷贝</p>\n<h1 id=\"线程与事件\"><a class=\"anchor\" href=\"#线程与事件\">#</a> 线程与事件</h1>\n<h2 id=\"使用系统线程\"><a class=\"anchor\" href=\"#使用系统线程\">#</a> 使用系统线程</h2>\n<h2 id=\"使用同步事件\"><a class=\"anchor\" href=\"#使用同步事件\">#</a> 使用同步事件</h2>\n",
            "tags": [
                "上下文环境",
                "中断请求级别",
                "链表",
                "自旋锁",
                "注册表",
                "地址空间",
                "文件操作",
                "线程与事件"
            ]
        },
        {
            "id": "https://or0kit.github.io/Bin/Core/Drive-Development/%E9%A9%B1%E5%8A%A8%E5%BC%80%E5%8F%91-%E5%9F%BA%E4%BA%8EVS+WDK%E7%9A%84%E9%A9%B1%E5%8A%A8%E8%B0%83%E8%AF%95/",
            "url": "https://or0kit.github.io/Bin/Core/Drive-Development/%E9%A9%B1%E5%8A%A8%E5%BC%80%E5%8F%91-%E5%9F%BA%E4%BA%8EVS+WDK%E7%9A%84%E9%A9%B1%E5%8A%A8%E8%B0%83%E8%AF%95/",
            "title": "驱动开发-基于VS+WDK的驱动调试",
            "date_published": "2021-11-20T06:22:33.000Z",
            "content_html": "<h1 id=\"基于vs-wdk-的环境调试\"><a class=\"anchor\" href=\"#基于vs-wdk-的环境调试\">#</a> 基于 VS + WDK 的环境调试</h1>\n<p>物理机为 win10,Visual Studio 的办事本是 2019，配合 WDK10 版本。</p>\n<p>VMware 虚拟机内安装了一个 Win10 操作系统，虚拟机网卡使用 NAT 方式，具体情如下：</p>\n<blockquote>\n<p>调试机器：Windows10  IP：192.168.2.105<br />\n 被调试机器：Windows10  IP：192.168.252.135</p>\n</blockquote>\n<p>调试使用网络作为调试机器与被调试机器之间的连接方式，但是注意防火墙，为了避免不必要的麻烦建议关闭防火墙，或配置防火墙放行规则，不管怎样，要保持调试机器与被调试机器之间网络的畅通。</p>\n<h2 id=\"配置被调试机\"><a class=\"anchor\" href=\"#配置被调试机\">#</a> 配置被调试机</h2>\n<p>以管理员权限运行 <code>cmd</code> , 输入： <code>bcdedit/debug on</code>  命令。这个命令的作用是把被调试机器设置成调试模式。</p>\n<p>再输入： <code>bcdedit /dbgsettings net hostip:192.168.2.105 port:50011</code> 。</p>\n<p>这个命令的作用是使用网络进行调试的连接方式，  <code>hostip</code>  值调试机器的 IP，  <code>port</code>  标识使用的网络端口，建议范围是  <code>49152-65535</code> 。</p>\n<p>命令执行完后会显示一个  <code>Key</code> ，需要保存这个  <code>Key</code> ，用于后面调试机器的配置。</p>\n<p><img data-src=\"image001.png\" alt=\"\" /></p>\n<h2 id=\"配置调试机\"><a class=\"anchor\" href=\"#配置调试机\">#</a> 配置调试机</h2>\n<p>首先打开 VS，找到  <code>Configure Devices</code></p>\n<p><img data-src=\"image002.png\" alt=\"\" /></p>\n<p>点击 <code>Add New Device</code>  弹出的配置对话框，在 “Dispaly name” 下面输入设备的名字，例如： “MyFirstDevice”；<br />\n在 “Device Type” 下面的下拉框中选择 “Computer”；我的 vs2019 版本中没有这个选项，忽略。<br />\n在 “Network host name” 下面输入被调试机器的 “hostname”，也可以输入 “IP”；<br />\n在最后一项 “Provisioning Options” 中，选择第二项 “Manually configure debuggers and do not  provision”，意思是说手动配置被调试机器的调试选项以及手动分发驱动文件。</p>\n<p>整体配置如下：</p>\n<p><img data-src=\"image003.png\" alt=\"\" /></p>\n<p>完成后点击下一步。</p>\n<p>需要注意的是，如果被调试机器只有一个网卡，则最后一个 “bus Parameters” 可以不填，否则需要根据 PCI 规范，填入相应设备的总线号（Bus number）、设备号 (Device Number) 以及功能号（Function number），因为我的被调试机只有一块网卡，所以这个值留空。</p>\n<p>整体配置如下：</p>\n<p><img data-src=\"image004.png\" alt=\"\" /></p>\n<h1 id=\"进行调试\"><a class=\"anchor\" href=\"#进行调试\">#</a> 进行调试</h1>\n<p>开始调试前介绍两个断点函数</p>\n<p><code>KdBreakPoint()</code>  ：只对 Debug 版的驱动有效。<br />\n <code>DbgBreakPoint()</code> ： 对 Release 版的有效。</p>\n<p>驱动代码如下：</p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span><span class=\"token string\">&lt;ntddk.h></span></span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token comment\">// 卸载函数</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>VOID <span class=\"token function\">DriverUnload</span><span class=\"token punctuation\">(</span>PDRIVER_OBJECT driver<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>\t<span class=\"token function\">DbgPrint</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"驱动程序停止运行了.\\r\\n\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>NTSTATUS <span class=\"token function\">DriverEntry</span><span class=\"token punctuation\">(</span>PDRIVER_OBJECT pdriver<span class=\"token punctuation\">,</span> PUNICODE_STRING pRegPath<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>\t<span class=\"token function\">DbgPrint</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"我是驱动，我被加载了。\\r\\n\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>\t<span class=\"token function\">DbgBreakPoint</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>\tpdriver<span class=\"token operator\">-></span>DriverUnload <span class=\"token operator\">=</span> DriverUnload<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>\t<span class=\"token keyword\">return</span> STATUS_SUCCESS<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>首先编译生成 sys 文件，然后在 VS 的菜单中找到 “调试”--&gt;“附加到进程”，在弹出的对话框中，选择 “连接类型” 为 “Windows Kernel Mode Debugger”，“连接目标” 选择为刚才我们配置好的 “MyFirst Device”，在可用进程中选择 “Kernel”，如下所示：</p>\n<p><img data-src=\"image005.png\" alt=\"\" /></p>\n<p>点击附加后 vs 中会出现一个 “Debugger Immediate Window” 界面，界面显示如图所示：</p>\n<p><img data-src=\"image006.png\" alt=\"\" /></p>\n<p>这表示当前调试使用网络连接的方式，正在等待被连接。接下来重启被调试机器，让被调试机器的调试配置生效。</p>\n<p>被调试机器在重启过程中，会主动连接设置的 50011 端口，连接建立好之后，可以在 “Debugger Immediate Window” 界面看到如下信息：</p>\n<p><img data-src=\"image007.png\" alt=\"\" /></p>\n<p>最后把 sys 文件放入被调试机器中，运行加载该驱动，由于有断点所以会被断下，我们就可以 F10 单步调试了。</p>\n<h1 id=\"reference\"><a class=\"anchor\" href=\"#reference\">#</a> Reference</h1>\n<p>谭文 陈铭霖《Windows 内核编程》</p>\n",
            "tags": [
                "驱动调试"
            ]
        },
        {
            "id": "https://or0kit.github.io/Bin/Core/Drive-Development/%E9%A9%B1%E5%8A%A8%E5%BC%80%E5%8F%91-%E8%BF%87%E5%86%99%E6%8B%B7%E8%B4%9D/",
            "url": "https://or0kit.github.io/Bin/Core/Drive-Development/%E9%A9%B1%E5%8A%A8%E5%BC%80%E5%8F%91-%E8%BF%87%E5%86%99%E6%8B%B7%E8%B4%9D/",
            "title": "驱动开发-过写拷贝",
            "date_published": "2021-10-29T08:15:32.000Z",
            "content_html": "<h1 id=\"要求\"><a class=\"anchor\" href=\"#要求\">#</a> 要求</h1>\n<ol>\n<li>自己写代码加载、卸载驱动</li>\n<li>段页的知识：绕过写拷贝。</li>\n</ol>\n<blockquote>\n<p>两个思路：<br />\n（1）、另外申请一个线性地址，映射到 MessageBoxA 的物理页，设置 PTE 的 R/W 属性，使其可读写。<br />\n（2）、修改 VAD 树，将写拷贝改为可读可写。</p>\n</blockquote>\n<ol start=\"3\">\n<li>R3R0 通信</li>\n<li>写 HOOK</li>\n<li>ShellCode</li>\n<li>ShellCode 放哪？</li>\n</ol>\n<p>在 ring3：<br />\n注册和卸载驱动<br />\n找到 User32，定位 Messagebox 函数地址，传给 0 环</p>\n<p>编写 shellcode 注入进 user32，对 Messagebox 进行 INLINE HOOK<br />\n 打印使用 Messagebox 的程序<br />\n在 ring0：</p>\n<p>与 3 环通信，并接受 Messagebox 的地址，修改其 PTE 与 PDE 的属性<br />\n修改完后给 3 环发送信息，告知 ring 3 可以开始 inline hook</p>\n<h1 id=\"驱动中设备扩展的使用\"><a class=\"anchor\" href=\"#驱动中设备扩展的使用\">#</a> 驱动中设备扩展的使用</h1>\n<p>驱动的设备对象中有一个字段是设备扩展<br />\n该设备扩展的大小是不固定的，依据在创建设备对象时给定的大小分配内存。</p>\n<p>详细参见：<span class=\"exturl\" data-url=\"aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQxNDkwODczL2FydGljbGUvZGV0YWlscy8xMDc1ODc5MTg=\">https://blog.csdn.net/qq_41490873/article/details/107587918</span></p>\n<h1 id=\"不使用-shellcode-注入\"><a class=\"anchor\" href=\"#不使用-shellcode-注入\">#</a> 不使用 ShellCode 注入</h1>\n<p>驱动编程<br />\n 0 环 - 3 环通信常规方式（设备读写）<br />\n修改 PTE 过写拷贝<br />\n调用门提权（有一套 API 实现以系统权限调用用户程序里的裸函数，支持传参）<br />\n中断门 HOOK<br />\n 设备扩展内存<br />\n双端链表模拟队列</p>\n<p>参考：<span class=\"exturl\" data-url=\"aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L0t3YW5zeS9hcnRpY2xlL2RldGFpbHMvMTA5MzEzMjM3\">https://blog.csdn.net/Kwansy/article/details/109313237</span></p>\n<h1 id=\"代码\"><a class=\"anchor\" href=\"#代码\">#</a> 代码</h1>\n<p>github:&lt;&gt;</p>\n",
            "tags": []
        },
        {
            "id": "https://or0kit.github.io/Bin/Core/Drive-Development/%E9%A9%B1%E5%8A%A8%E5%BC%80%E5%8F%91%E2%80%94%E4%BD%BF%E7%94%A8SCM%E5%8A%A0%E8%BD%BD%E9%A9%B1%E5%8A%A8/",
            "url": "https://or0kit.github.io/Bin/Core/Drive-Development/%E9%A9%B1%E5%8A%A8%E5%BC%80%E5%8F%91%E2%80%94%E4%BD%BF%E7%94%A8SCM%E5%8A%A0%E8%BD%BD%E9%A9%B1%E5%8A%A8/",
            "title": "驱动开发—使用SCM加载驱动",
            "date_published": "2021-10-12T02:59:22.000Z",
            "content_html": "<h1 id=\"正文\"><a class=\"anchor\" href=\"#正文\">#</a> 正文</h1>\n<p>Windows 系统加载驱动的方法有很多，其中最正确的方法就是使用 SCM（Server Control manager，服务控制管理器）来完成此操作。<br />\n使用 SCM 记载驱动是需要我们注意两点：</p>\n<ul>\n<li>SCM 会操作注册表</li>\n<li>SCM 加载驱动是不可分页的</li>\n</ul>\n<p>这个机制会使驱动的回调函数、IRP 处理函数与其他重要代码不会被页换出，而总是驻留在内存中，以此来保证这个驱动不会因为这些原因导致 BsoD。</p>\n<h1 id=\"代码实现\"><a class=\"anchor\" href=\"#代码实现\">#</a> 代码实现</h1>\n<p>接下来用代码来演示如何加载和卸载一个驱动。</p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>VOID <span class=\"token function\">SCMLoadDriver</span><span class=\"token punctuation\">(</span>PUCHAR lpszDriverFullPath<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>\t<span class=\"token comment\">//1. 使用 OpenSCManager 函数打开 SCM</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>\t<span class=\"token comment\">//SCM 句柄</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>\tSC_HANDLE hSCM <span class=\"token operator\">=</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>\tPUCHAR lpszDriverName <span class=\"token operator\">=</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>\tDWORD dwRtn <span class=\"token operator\">=</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>\t<span class=\"token comment\">// 获取驱动名</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\t<span class=\"token function\">_splitpath</span><span class=\"token punctuation\">(</span>lpszDriverFullPath<span class=\"token punctuation\">,</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">,</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">,</span> lpszDriverName<span class=\"token punctuation\">,</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>\thSCM <span class=\"token operator\">=</span> <span class=\"token function\">OpenSCManager</span><span class=\"token punctuation\">(</span><span class=\"token constant\">NULL</span><span class=\"token punctuation\">,</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">,</span> SC_MANAGER_ALL_ACCESS<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>hSCM <span class=\"token operator\">==</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>\t\t<span class=\"token function\">MessageBox</span><span class=\"token punctuation\">(</span><span class=\"token constant\">NULL</span><span class=\"token punctuation\">,</span> L<span class=\"token string\">\"Error!\"</span><span class=\"token punctuation\">,</span> L<span class=\"token string\">\"OpenSCManager fail!\"</span><span class=\"token punctuation\">,</span> MB_OK<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>\t\t<span class=\"token function\">CloseServiceHandle</span><span class=\"token punctuation\">(</span>hSCM<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>\t<span class=\"token comment\">//2. 使用 CreateService 函数利用 SCM 句柄创建一个服务</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>\t<span class=\"token comment\">//NT 驱动服务句柄</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>\tSC_HANDLE hService <span class=\"token operator\">=</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>\thService <span class=\"token operator\">=</span> <span class=\"token function\">CreateService</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>\t\thSCM<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>\t\tlpszDriverName<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>\t\tlpszDriverName<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>\t\tSERVICE_ALL_ACCESS<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>\t\tSERVICE_KERNEL_DRIVER<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>\t\tSERVICE_DEMAND_START<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>\t\tSERVICE_ERROR_IGNORE<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>\t\tlpszDriverFullPath<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>\t\t<span class=\"token constant\">NULL</span><span class=\"token punctuation\">,</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">,</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">,</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">,</span> <span class=\"token constant\">NULL</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>\t<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>hService <span class=\"token operator\">==</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>\t\tdwRtn <span class=\"token operator\">=</span> <span class=\"token function\">GetLastError</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>\t\t<span class=\"token function\">MessageBox</span><span class=\"token punctuation\">(</span><span class=\"token constant\">NULL</span><span class=\"token punctuation\">,</span> L<span class=\"token string\">\"Error!\"</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span>L<span class=\"token string\">\"CreateeeeeeeService fail! ErrorCode:%d\"</span><span class=\"token punctuation\">,</span> dwRtn<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> MB_OK<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>\t\t<span class=\"token function\">CloseServiceHandle</span><span class=\"token punctuation\">(</span>hService<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>\t\t<span class=\"token function\">CloseServiceHandle</span><span class=\"token punctuation\">(</span>hSCM<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>\t<span class=\"token comment\">//3. 使用 StartService 函数启动我们刚刚创建的服务</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token function\">StartService</span><span class=\"token punctuation\">(</span>hService<span class=\"token punctuation\">,</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">,</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>\t\tdwRtn <span class=\"token operator\">=</span> <span class=\"token function\">GetLastError</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>\t\t<span class=\"token function\">MessageBox</span><span class=\"token punctuation\">(</span><span class=\"token constant\">NULL</span><span class=\"token punctuation\">,</span> L<span class=\"token string\">\"Error!\"</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span>L<span class=\"token string\">\"StartService fail! ErrorCode:%d\"</span><span class=\"token punctuation\">,</span> dwRtn<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> MB_OK<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>\t\t<span class=\"token function\">CloseServiceHandle</span><span class=\"token punctuation\">(</span>hService<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>\t\t<span class=\"token function\">CloseServiceHandle</span><span class=\"token punctuation\">(</span>hSCM<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure>",
            "tags": [
                "OpenSCManager",
                "CreateService"
            ]
        },
        {
            "id": "https://or0kit.github.io/Bin/Core/Drive-Development/%E9%A9%B1%E5%8A%A8%E5%BC%80%E5%8F%91-0%E7%8E%AF%E4%B8%8E3%E7%8E%AF%E7%9A%84%E9%80%9A%E4%BF%A1%EF%BC%88%E5%B8%B8%E8%A7%84%E6%96%B9%E6%B3%95%EF%BC%89/",
            "url": "https://or0kit.github.io/Bin/Core/Drive-Development/%E9%A9%B1%E5%8A%A8%E5%BC%80%E5%8F%91-0%E7%8E%AF%E4%B8%8E3%E7%8E%AF%E7%9A%84%E9%80%9A%E4%BF%A1%EF%BC%88%E5%B8%B8%E8%A7%84%E6%96%B9%E6%B3%95%EF%BC%89/",
            "title": "驱动开发-0环与3环的通信（常规方法）",
            "date_published": "2021-09-24T15:54:24.000Z",
            "content_html": "<h1 id=\"前言\"><a class=\"anchor\" href=\"#前言\">#</a> 前言</h1>\n<p>非常规方法是 0 环  <code>INLINE HOOK</code></p>\n<h1 id=\"正文\"><a class=\"anchor\" href=\"#正文\">#</a> 正文</h1>\n<p>驱动程序原本的目的是用来控制硬件，为了控制驱动运行，我们需要在 3 环向驱动发数据，所以我们需要有一种方法来建立 0 环到 3 环的通信。</p>\n<p>虽然驱动程序的目的是用来控制硬件的，但我们也可以用驱动做一些安全相关的事情，因为驱动运行在 0 环。</p>\n<p>本文介绍常规方式，也就是创建设备对象的方式。</p>\n<h2 id=\"设备对象\"><a class=\"anchor\" href=\"#设备对象\">#</a> 设备对象</h2>\n<ol>\n<li>我们在<strong>开发窗口程序</strong>的时候，消息被封装成一个结构体：<strong>MSG</strong></li>\n<li>在<strong>内核开发</strong>时，消息被封装成另外一个结构体：<strong>IRP（I/O Request Package）</strong></li>\n<li>在<strong>窗口程序</strong>中，能够接收消息的只能是<strong>窗口对象</strong></li>\n<li>在<strong>内核</strong>中，能够接收 IRP 消息的只能是<strong>设备对象</strong></li>\n</ol>\n<p><img data-src=\"image001.png\" alt=\"\" /></p>\n<p><img data-src=\"image002.png\" alt=\"\" /></p>\n<p>可以发现 3 环窗口程序中的 MSG 结构体和窗口对象，与 0 环的设备对象和 IRP 结构体的关系很像。</p>\n<h2 id=\"创建设备对象\"><a class=\"anchor\" href=\"#创建设备对象\">#</a> 创建设备对象</h2>\n<p>调用 IoCreateDevice 函数创建设备对象，例如：</p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>NTSTATUS <span class=\"token function\">IoCreateDevice</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    _In_  PDRIVER_OBJECT DriverObject<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    _In_  ULONG DeviceExtensionSize<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    _In_opt_ PUNICODE_STRING DeviceName<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    _In_  DEVICE_TYPE DeviceType<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    _In_  ULONG DeviceCharacteristics<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    _In_  BOOLEAN Exclusive<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    PDEVICE_OBJECT <span class=\"token operator\">*</span>DeviceObject  <span class=\"token comment\">// 二级指针</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p><strong>参数说明</strong></p>\n<ul>\n<li>\n<p>DriverObject<br />\n 一个指向调用该函数的驱动程序对象。每一个驱动程序在它的 DriverEntry 过程里接收一个指向它的驱动程序对象.<br />\nWDM 功能和过滤驱动程序也在他们的 AddDevice 过程接受一个驱动程序对象的指针</p>\n</li>\n<li>\n<p>DeviceExtensionSize<br />\n 指定驱动程序为设备扩展对象而定义的结构体的大小。</p>\n</li>\n<li>\n<p>DeviceName<br />\n (可选的参数) 指向一个以零结尾的包含 Unicode 字符串的缓冲区，那是这个设备的名称，该字符串必须是一个完整的设备路径名.<br />\nWDM 功能驱动程序和过滤驱动程序它们的设备对象没有名字.</p>\n</li>\n</ul>\n<p>注意：如果设备名未提供 (即这个参数是 NULL),IoCreateDevice 创建的设备对象将不会有一个 DACL 与之相关联</p>\n<ul>\n<li>\n<p>DeviceType<br />\n 指定一个由一个系统定义的 FILE_DEVICE_XXX 常量，表明了这个设备的类型<br />\n (如 FILE_DEVICE_DISK,FILE_DEVICE_KEYBOARD 等), 或供应商定义的一种新型设备的类型</p>\n</li>\n<li>\n<p>DeviceCharacteristics<br />\n 指定一个或多个系统定义的常量，连接在一起，提供有关驱动程序的设备其他信息。对于可能的设备特征信息，<br />\n 见 <code>DEVICE_OBJECT</code>  结构体.</p>\n</li>\n<li>\n<p>Exclusive<br />\n 如果指定设备是独占的，大部分驱动程序设置这个值为 FALSE, 如果是独占的话设置为 TRUE，非独占设置为 FALSE.</p>\n</li>\n<li>\n<p>DeviceObject<br />\n 一个指向 DEVICE_OBJECT 结构体指针的指针，这是一个指针的指针，指向的指针用来接收 DEVICE_OBJECT 结构体的指针.</p>\n</li>\n</ul>\n<p><strong>返回值</strong></p>\n<p>IoCreateDevice 函数成功时返回 STATUS_SUCCESS, 失败时返回适当的 NTSTATUS 错误代码.<br />\n 这时这个函数返回值:　<br />\n <code>STATUS_INSUFFICIENT_RESOURCES</code> <br />\n <code>STATUS_OBJECT_NAME_EXISTS</code> <br />\n <code>STATUS_OBJECT_NAME_COLLISION</code></p>\n<p><strong>调用要求</strong></p>\n<blockquote>\n<p>包含文件:wdm.h,ntddk.h</p>\n</blockquote>\n<p><strong>扩展</strong></p>\n<p>通常设备对象都把自己的名字放到 / Device 目录中。在 Windows 2000 中，设备的名称有两个用途。第一个用途，设备命名后，其它内核模式部件可以通过调用 <code>IoGetDeviceObjectPointer</code>  函数找到该设备，找到设备对象后，就可以向该设备的驱动程序发送 IRP。</p>\n<p>另一个用途，允许应用程序打开命名设备的句柄，这样它们就可以向驱动程序发送 IRP。应用程序可以使用标准的 <code>CreateFile</code>  API 打开命名设备句柄，然后用 <code>ReadFile</code> 、 <code>WriteFile</code> ，和 <code>DeviceIoControl</code>  向驱动程序发出请求。应用程序打开设备句柄时使用 <code>//./</code>  路径前缀而不是标准的 <code>UNC</code>  (统一命名约定) 名称，如 <code>C:/MYFILE.CPP</code>  或 <code>//FRED/C-Drive/HISFILE.CPP</code> 。在内部，I/O 管理器在执行名称搜索前自动把 <code>//./</code>  转换成 <code>/??/</code> 。为了把 <code>/??</code>  目录中的名字与名字在其它目录 (例如，在 / Device 目录) 中的对象相连接，对象管理器实现了一种称为符号连接 (symbolic link) 的对象。IRP 就是应用程序调用驱动程序。</p>\n<h2 id=\"数据交互的方式\"><a class=\"anchor\" href=\"#数据交互的方式\">#</a> 数据交互的方式</h2>\n<p>设置交互数据的方式</p>\n<p><code>pDeviceObj-&gt;Flags |= DO_BUFFERED_IO;</code></p>\n<blockquote>\n<p>缓冲区方式读写 ( <code>DO_BUFFERED_IO</code> ) ：操作系统将应用程序提供缓冲区的数据复制到内核模式下的地址中。<br />\n优点：方便；缺点：效率低<br />\n适合数据量较小时使用</p>\n</blockquote>\n<blockquote>\n<p>直接方式读写 ( <code>DO_DIRECT_IO</code> )  ：操作系统会将用户模式下的缓冲区锁住。<br />\n然后操作系统将这段缓冲区在内核模式地址再次映射一遍。<br />\n这样，用户模式的缓冲区和内核模式的缓冲区指向的是同一区域的物理内存。<br />\n优点：效率高；缺点：单独占用物理页面，无法再进行其它操作（例如文件读写）<br />\n适合数据量较大时使用</p>\n</blockquote>\n<blockquote>\n<p>其他方式读写（在调用 IoCreateDevice 创建设备后对 pDevObj-&gt;Flags 即不设置 DO_BUFFERED_IO 也不设置 DO_DIRECT_IO 此时就是其他方式）：在使用其他方式读写设备时，派遣函数直接读写应用程序提供的缓冲区地址。<br />\n在驱动程序中，直接操作应用程序的缓冲区地址是很危险的。<br />\n只有驱动程序与应用程序运行在相同线程上下文的情况下，才能使用这种方式</p>\n</blockquote>\n<h2 id=\"符号链接\"><a class=\"anchor\" href=\"#符号链接\">#</a> 符号链接</h2>\n<p>特别说明:</p>\n<ol>\n<li>设备名称的作用是给内核对象用的，如果要在 Ring3 访问，必须要有符号链接。 其实就是一个别名，没有这个别名，在 Ring3 不可见。</li>\n<li>内核模式下，符号链接是以 <code>\\??\\</code>  开头的，如 C 盘就是 <code>\\??\\C:</code></li>\n<li>而在用户模式下，则是以 <code>\\\\.\\</code>  开头的，如 C 盘就是 <code>\\\\.\\C:</code></li>\n</ol>\n<h2 id=\"irp与派遣函数\"><a class=\"anchor\" href=\"#irp与派遣函数\">#</a> IRP 与派遣函数</h2>\n<p>描述：</p>\n<ol>\n<li>当对窗口对象传递消息时，窗口对象会根据我们所传入的消息类型执行对应的回调函数</li>\n<li>当调用 CreateFile 等函数时，操作系统会将它们封装成一个结构体，此时就可以传递给设备对象，设备对象根据 IRP 的类型调用对应的派遣函数</li>\n</ol>\n<p><img data-src=\"image002.png\" alt=\"\" /></p>\n<h2 id=\"irp的类型\"><a class=\"anchor\" href=\"#irp的类型\">#</a> IRP 的类型</h2>\n<p>描述：当应用层通过 <code>CreateFile</code> ， <code>ReadFile</code> ， <code>WriteFile</code> ， <code>CloseHandle</code>  等函数对设备进行打开、读取、写入、关闭的时候，会使操作系统产生出 <code>IRP_MJ_CREATE</code> ， <code>IRP_MJ_READ</code> ， <code>IRP_MJ_WRITE</code> ， <code>IRP_MJ_CLOSE</code>  等不同的 IRP。</p>\n<p>其它类型的 IRP</p>\n<p><img data-src=\"image003.png\" alt=\"\" /></p>\n<h2 id=\"派遣函数\"><a class=\"anchor\" href=\"#派遣函数\">#</a> 派遣函数</h2>\n<h3 id=\"派遣函数注册位置\"><a class=\"anchor\" href=\"#派遣函数注册位置\">#</a> 派遣函数注册位置</h3>\n<pre><code>kd&gt; dt _DRIVER_OBJECT\nnt!_DRIVER_OBJECT\n   +0x000 Type             : Int2B\n   +0x002 Size             : Int2B\n   +0x004 DeviceObject     : Ptr32 _DEVICE_OBJECT\n   +0x008 Flags            : Uint4B\n   +0x00c DriverStart      : Ptr32 Void\n   +0x010 DriverSize       : Uint4B\n....\n   +0x030 DriverStartIo    : Ptr32     void \n   +0x034 DriverUnload     : Ptr32     void \t\t//卸载函数\n   +0x038 MajorFunction    : [28] Ptr32     long \t//派遣函数\n</code></pre>\n<h3 id=\"注册派遣函数\"><a class=\"anchor\" href=\"#注册派遣函数\">#</a> 注册派遣函数</h3>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>NTSTATUS <span class=\"token function\">DriverEntry</span><span class=\"token punctuation\">(</span> 。。。。<span class=\"token punctuation\">)</span>  </pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">&#123;</span>  </pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token comment\">// 设置卸载函数   </span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    pDriverObject<span class=\"token operator\">-></span>DriverUnload <span class=\"token operator\">=</span> 卸载函数<span class=\"token punctuation\">;</span>  </pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  </pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token comment\">// 设置派遣函数   </span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    pDriverObject<span class=\"token operator\">-></span>MajorFunction<span class=\"token punctuation\">[</span>IRP_MJ_CREATE<span class=\"token punctuation\">]</span> \t<span class=\"token operator\">=</span> 派遣函数<span class=\"token number\">1</span><span class=\"token punctuation\">;</span>  </pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    pDriverObject<span class=\"token operator\">-></span>MajorFunction<span class=\"token punctuation\">[</span>IRP_MJ_CLOSE<span class=\"token punctuation\">]</span> \t<span class=\"token operator\">=</span> 派遣函数<span class=\"token number\">2</span><span class=\"token punctuation\">;</span>  </pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    pDriverObject<span class=\"token operator\">-></span>MajorFunction<span class=\"token punctuation\">[</span>IRP_MJ_WRITE<span class=\"token punctuation\">]</span> \t<span class=\"token operator\">=</span> 派遣函数<span class=\"token number\">3</span><span class=\"token punctuation\">;</span>  </pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    pDriverObject<span class=\"token operator\">-></span>MajorFunction<span class=\"token punctuation\">[</span>IRP_MJ_READ<span class=\"token punctuation\">]</span> \t<span class=\"token operator\">=</span> 派遣函数<span class=\"token number\">4</span><span class=\"token punctuation\">;</span>  </pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    pDriverObject<span class=\"token operator\">-></span>MajorFunction<span class=\"token punctuation\">[</span>IRP_MJ_CLEANUP<span class=\"token punctuation\">]</span> \t<span class=\"token operator\">=</span> 派遣函数<span class=\"token number\">5</span><span class=\"token punctuation\">;</span>  </pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    pDriverObject<span class=\"token operator\">-></span>MajorFunction<span class=\"token punctuation\">[</span>IRP_MJ_SET_INFORMATION<span class=\"token punctuation\">]</span> \t<span class=\"token operator\">=</span> 派遣函数<span class=\"token number\">6</span><span class=\"token punctuation\">;</span>  </pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    pDriverObject<span class=\"token operator\">-></span>MajorFunction<span class=\"token punctuation\">[</span>IRP_MJ_DEVICE_CONTROL<span class=\"token punctuation\">]</span> \t<span class=\"token operator\">=</span> 派遣函数<span class=\"token number\">7</span><span class=\"token punctuation\">;</span>  </pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    pDriverObject<span class=\"token operator\">-></span>MajorFunction<span class=\"token punctuation\">[</span>IRP_MJ_SHUTDOWN<span class=\"token punctuation\">]</span> \t\t<span class=\"token operator\">=</span> 派遣函数<span class=\"token number\">8</span><span class=\"token punctuation\">;</span>  </pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    pDriverObject<span class=\"token operator\">-></span>MajorFunction<span class=\"token punctuation\">[</span>IRP_MJ_SYSTEM_CONTROL<span class=\"token punctuation\">]</span> \t<span class=\"token operator\">=</span> 派遣函数<span class=\"token number\">9</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token punctuation\">&#125;</span> </pre></td></tr><tr><td data-num=\"17\"></td><td><pre></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>IRP_MJ_MAXIMUM_FUNCTION   派遣函数的最大值</pre></td></tr></table></figure><h3 id=\"派遣函数的格式\"><a class=\"anchor\" href=\"#派遣函数的格式\">#</a> 派遣函数的格式</h3>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">// 派遣函数的格式：</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>NTSTATUS <span class=\"token function\">MyDispatchFunction</span><span class=\"token punctuation\">(</span>PDEVICE_OBJECT pDevObj<span class=\"token punctuation\">,</span> PIRP pIrp<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>\t<span class=\"token comment\">// 处理自己的业务...</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>\t<span class=\"token comment\">// 设置返回状态</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>\tpIrp<span class=\"token operator\">-></span>IoStatus<span class=\"token punctuation\">.</span>Status <span class=\"token operator\">=</span> STATUS_SUCCESS<span class=\"token punctuation\">;</span>\t<span class=\"token comment\">//  getlasterror () 得到的就是这个值</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\tpIrp<span class=\"token operator\">-></span>IoStatus<span class=\"token punctuation\">.</span>Information <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\t\t<span class=\"token comment\">//  返回给 3 环多少数据 没有填 0</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\t<span class=\"token function\">IoCompleteRequest</span><span class=\"token punctuation\">(</span>pIrp<span class=\"token punctuation\">,</span> IO_NO_INCREMENT<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>\t<span class=\"token keyword\">return</span> STATUS_SUCCESS<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h2 id=\"实验\"><a class=\"anchor\" href=\"#实验\">#</a> 实验</h2>\n<h3 id=\"r0代码\"><a class=\"anchor\" href=\"#r0代码\">#</a> R0 代码</h3>\n<p>格式都是这样</p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;ntddk.h></span></span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">DEVICE_NAME</span> <span class=\"token expression\">L</span><span class=\"token string\">\"\\\\Device\\\\MyDevice\"</span></span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token comment\">// Ring3 用 CreateFile 打开设备时，用 \"\\\\\\\\.\\\\MyTestDriver\"</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">SYMBOLICLINK_NAME</span> <span class=\"token expression\">L</span><span class=\"token string\">\"\\\\??\\\\MyTestDriver\"</span></span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token comment\">// 0-2047 是保留的  2048~4095</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">OPER1</span> <span class=\"token expression\"><span class=\"token function\">CTL_CODE</span><span class=\"token punctuation\">(</span>FILE_DEVICE_UNKNOWN<span class=\"token punctuation\">,</span> <span class=\"token number\">0x800</span><span class=\"token punctuation\">,</span> METHOD_BUFFERED<span class=\"token punctuation\">,</span> FILE_ANY_ACCESS<span class=\"token punctuation\">)</span></span></span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">OPER2</span> <span class=\"token expression\"><span class=\"token function\">CTL_CODE</span><span class=\"token punctuation\">(</span>FILE_DEVICE_UNKNOWN<span class=\"token punctuation\">,</span> <span class=\"token number\">0x900</span><span class=\"token punctuation\">,</span> METHOD_BUFFERED<span class=\"token punctuation\">,</span> FILE_ANY_ACCESS<span class=\"token punctuation\">)</span></span></span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token comment\">// 卸载函数</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>VOID <span class=\"token function\">DriverUnload</span><span class=\"token punctuation\">(</span>PDRIVER_OBJECT pDriver<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>\tUNICODE_STRING SymbolicLinkName <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span> <span class=\"token number\">0</span> <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>\t<span class=\"token function\">DbgPrint</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"驱动程序停止运行了 . \\r\\n\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>\t<span class=\"token comment\">// 删除符号链接 删除设备</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>\t<span class=\"token function\">RtlInitUnicodeString</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>SymbolicLinkName<span class=\"token punctuation\">,</span> SYMBOLICLINK_NAME<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>\t<span class=\"token function\">IoDeleteSymbolicLink</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>SymbolicLinkName<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>\t<span class=\"token function\">IoDeleteDevice</span><span class=\"token punctuation\">(</span>pDriver<span class=\"token operator\">-></span>DeviceObject<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre></pre></td></tr><tr><td data-num=\"24\"></td><td><pre><span class=\"token comment\">// IRP_MJ_CREATE 处理函数</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>NTSTATUS <span class=\"token function\">IrpCreateProc</span><span class=\"token punctuation\">(</span>PDEVICE_OBJECT pDevObj<span class=\"token punctuation\">,</span> PIRP pIrp<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>\t<span class=\"token function\">DbgPrint</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"DispatchCreate ... \\n\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>\t<span class=\"token comment\">// 返回状态如果不设置 Ring3 返回的是失败</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>\tpIrp<span class=\"token operator\">-></span>IoStatus<span class=\"token punctuation\">.</span>Status <span class=\"token operator\">=</span> STATUS_SUCCESS<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>\tpIrp<span class=\"token operator\">-></span>IoStatus<span class=\"token punctuation\">.</span>Information <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>\t<span class=\"token function\">IoCompleteRequest</span><span class=\"token punctuation\">(</span>pIrp<span class=\"token punctuation\">,</span> IO_NO_INCREMENT<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>\t<span class=\"token keyword\">return</span> STATUS_SUCCESS<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre></pre></td></tr><tr><td data-num=\"36\"></td><td><pre><span class=\"token comment\">// IRP_MJ_CLOSE 处理函数</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>NTSTATUS <span class=\"token function\">IrpCloseProc</span><span class=\"token punctuation\">(</span>PDEVICE_OBJECT pDevObj<span class=\"token punctuation\">,</span> PIRP pIrp<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>\t<span class=\"token function\">DbgPrint</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"DispatchClose ... \\n\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>\tpIrp<span class=\"token operator\">-></span>IoStatus<span class=\"token punctuation\">.</span>Status <span class=\"token operator\">=</span> STATUS_SUCCESS<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>\tpIrp<span class=\"token operator\">-></span>IoStatus<span class=\"token punctuation\">.</span>Information <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>\t<span class=\"token function\">IoCompleteRequest</span><span class=\"token punctuation\">(</span>pIrp<span class=\"token punctuation\">,</span> IO_NO_INCREMENT<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>\t<span class=\"token keyword\">return</span> STATUS_SUCCESS<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre></pre></td></tr><tr><td data-num=\"46\"></td><td><pre><span class=\"token comment\">// IRP_MJ_DEVICE_CONTROL 处理函数 用来处理与 Ring3 交互</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>NTSTATUS <span class=\"token function\">IrpDeviceControlProc</span><span class=\"token punctuation\">(</span>PDEVICE_OBJECT pDevObj<span class=\"token punctuation\">,</span> PIRP pIrp<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>\tNTSTATUS status <span class=\"token operator\">=</span> STATUS_INVALID_DEVICE_REQUEST<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>\tPIO_STACK_LOCATION pIrpStack<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>\tULONG uIoControlCode<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre>\tPVOID pIoBuffer<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>\tULONG uInLength<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre>\tULONG uOutLength<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre>\tULONG uRead<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>\tULONG uWrite <span class=\"token operator\">=</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre></pre></td></tr><tr><td data-num=\"58\"></td><td><pre>\t<span class=\"token comment\">// 设置临时变量的值</span></pre></td></tr><tr><td data-num=\"59\"></td><td><pre>\tpIrpStack <span class=\"token operator\">=</span> <span class=\"token function\">IoGetCurrentIrpStackLocation</span><span class=\"token punctuation\">(</span>pIrp<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre>\t<span class=\"token comment\">// 获取控制码</span></pre></td></tr><tr><td data-num=\"61\"></td><td><pre>\tuIoControlCode <span class=\"token operator\">=</span> pIrpStack<span class=\"token operator\">-></span>Parameters<span class=\"token punctuation\">.</span>DeviceIoControl<span class=\"token punctuation\">.</span>IoControlCode<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"62\"></td><td><pre>\t<span class=\"token comment\">// 获取缓冲区地址 (输入和输出的缓冲区都是一个)</span></pre></td></tr><tr><td data-num=\"63\"></td><td><pre>\tpIoBuffer <span class=\"token operator\">=</span> pIrp<span class=\"token operator\">-></span>AssociatedIrp<span class=\"token punctuation\">.</span>SystemBuffer<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"64\"></td><td><pre>\t<span class=\"token comment\">// Ring3 发送数据的长度</span></pre></td></tr><tr><td data-num=\"65\"></td><td><pre>\tuInLength <span class=\"token operator\">=</span> pIrpStack<span class=\"token operator\">-></span>Parameters<span class=\"token punctuation\">.</span>DeviceIoControl<span class=\"token punctuation\">.</span>InputBufferLength<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"66\"></td><td><pre>\t<span class=\"token comment\">// Ring0 发送数据的长度</span></pre></td></tr><tr><td data-num=\"67\"></td><td><pre>\tuOutLength <span class=\"token operator\">=</span> pIrpStack<span class=\"token operator\">-></span>Parameters<span class=\"token punctuation\">.</span>DeviceIoControl<span class=\"token punctuation\">.</span>OutputBufferLength<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"68\"></td><td><pre></pre></td></tr><tr><td data-num=\"69\"></td><td><pre>\t<span class=\"token keyword\">switch</span> <span class=\"token punctuation\">(</span>uIoControlCode<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"70\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"71\"></td><td><pre>\t<span class=\"token keyword\">case</span> OPER1<span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"72\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"73\"></td><td><pre>\t\t<span class=\"token function\">DbgPrint</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"IrpDeviceControlProc -> OPER1 ... \\n\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"74\"></td><td><pre></pre></td></tr><tr><td data-num=\"75\"></td><td><pre>\t\tpIrp<span class=\"token operator\">-></span>IoStatus<span class=\"token punctuation\">.</span>Information <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"76\"></td><td><pre>\t\tstatus <span class=\"token operator\">=</span> STATUS_SUCCESS<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"77\"></td><td><pre>\t\t<span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"78\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"79\"></td><td><pre>\t<span class=\"token keyword\">case</span> OPER2<span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"80\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"81\"></td><td><pre>\t\t<span class=\"token function\">DbgPrint</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"IrpDeviceControlProc -> OPER2 接收字节数：%d \\n\"</span><span class=\"token punctuation\">,</span> uInLength<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"82\"></td><td><pre>\t\t<span class=\"token function\">DbgPrint</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"IrpDeviceControlProc -> OPER2 输出字节数：%d \\n\"</span><span class=\"token punctuation\">,</span> uOutLength<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"83\"></td><td><pre>\t\t<span class=\"token comment\">// Read From Buffer</span></pre></td></tr><tr><td data-num=\"84\"></td><td><pre>\t\t<span class=\"token function\">memcpy</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>uRead<span class=\"token punctuation\">,</span> pIoBuffer<span class=\"token punctuation\">,</span> <span class=\"token number\">4</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"85\"></td><td><pre>\t\t<span class=\"token function\">DbgPrint</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"IrpDeviceControlProc -> OPER2 ... %x \\n\"</span><span class=\"token punctuation\">,</span> uRead<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"86\"></td><td><pre>\t\t<span class=\"token comment\">// Write To Buffer</span></pre></td></tr><tr><td data-num=\"87\"></td><td><pre>\t\t<span class=\"token function\">memcpy</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>pIoBuffer<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>uWrite<span class=\"token punctuation\">,</span> <span class=\"token number\">4</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"88\"></td><td><pre>\t\t<span class=\"token comment\">// Set Status</span></pre></td></tr><tr><td data-num=\"89\"></td><td><pre>\t\tpIrp<span class=\"token operator\">-></span>IoStatus<span class=\"token punctuation\">.</span>Information <span class=\"token operator\">=</span> <span class=\"token number\">2</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"90\"></td><td><pre>\t\tstatus <span class=\"token operator\">=</span> STATUS_SUCCESS<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"91\"></td><td><pre>\t\t<span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"92\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"93\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"94\"></td><td><pre></pre></td></tr><tr><td data-num=\"95\"></td><td><pre>\t<span class=\"token comment\">// 设置返回状态</span></pre></td></tr><tr><td data-num=\"96\"></td><td><pre>\tpIrp<span class=\"token operator\">-></span>IoStatus<span class=\"token punctuation\">.</span>Status <span class=\"token operator\">=</span> status<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"97\"></td><td><pre>\t<span class=\"token function\">IoCompleteRequest</span><span class=\"token punctuation\">(</span>pIrp<span class=\"token punctuation\">,</span> IO_NO_INCREMENT<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"98\"></td><td><pre>\t<span class=\"token keyword\">return</span> status<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"99\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"100\"></td><td><pre></pre></td></tr><tr><td data-num=\"101\"></td><td><pre><span class=\"token comment\">// 入口函数 相当于 Main 函数</span></pre></td></tr><tr><td data-num=\"102\"></td><td><pre>NTSTATUS <span class=\"token function\">DriverEntry</span><span class=\"token punctuation\">(</span>PDRIVER_OBJECT pDriver<span class=\"token punctuation\">,</span> PUNICODE_STRING reg_path<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"103\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"104\"></td><td><pre>\tNTSTATUS status <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"105\"></td><td><pre>\tULONG    uIndex <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"106\"></td><td><pre>\tPDEVICE_OBJECT pDeviceObj <span class=\"token operator\">=</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"107\"></td><td><pre>\tUNICODE_STRING Devicename<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"108\"></td><td><pre>\tUNICODE_STRING SymbolicLinkName<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"109\"></td><td><pre></pre></td></tr><tr><td data-num=\"110\"></td><td><pre>\t<span class=\"token function\">DbgPrint</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"驱动程序开始运行了 . \\r\\n\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"111\"></td><td><pre></pre></td></tr><tr><td data-num=\"112\"></td><td><pre>\t<span class=\"token comment\">// 创建设备名称</span></pre></td></tr><tr><td data-num=\"113\"></td><td><pre>\t<span class=\"token function\">RtlInitUnicodeString</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>Devicename<span class=\"token punctuation\">,</span> DEVICE_NAME<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"114\"></td><td><pre></pre></td></tr><tr><td data-num=\"115\"></td><td><pre>\t<span class=\"token comment\">// 创建设备</span></pre></td></tr><tr><td data-num=\"116\"></td><td><pre>\tstatus <span class=\"token operator\">=</span> <span class=\"token function\">IoCreateDevice</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"117\"></td><td><pre>\t\tpDriver<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"118\"></td><td><pre>\t\t<span class=\"token number\">0</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"119\"></td><td><pre>\t\t<span class=\"token operator\">&amp;</span>Devicename<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"120\"></td><td><pre>\t\tFILE_DEVICE_UNKNOWN<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"121\"></td><td><pre>\t\tFILE_DEVICE_SECURE_OPEN<span class=\"token punctuation\">,</span> </pre></td></tr><tr><td data-num=\"122\"></td><td><pre>\t\tFALSE<span class=\"token punctuation\">,</span> </pre></td></tr><tr><td data-num=\"123\"></td><td><pre>\t\t<span class=\"token operator\">&amp;</span>pDeviceObj</pre></td></tr><tr><td data-num=\"124\"></td><td><pre>\t<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"125\"></td><td><pre>\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>status <span class=\"token operator\">!=</span> STATUS_SUCCESS<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"126\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"127\"></td><td><pre>\t\t<span class=\"token function\">DbgPrint</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"创建设备失败! \\r\\n\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"128\"></td><td><pre>\t\t<span class=\"token keyword\">return</span> status<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"129\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"130\"></td><td><pre>\t<span class=\"token comment\">// 设置交互数据的方式</span></pre></td></tr><tr><td data-num=\"131\"></td><td><pre>\tpDeviceObj<span class=\"token operator\">-></span>Flags <span class=\"token operator\">|=</span> DO_BUFFERED_IO<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"132\"></td><td><pre></pre></td></tr><tr><td data-num=\"133\"></td><td><pre>\t<span class=\"token comment\">// 创建符号链接名称</span></pre></td></tr><tr><td data-num=\"134\"></td><td><pre>\t<span class=\"token function\">RtlInitUnicodeString</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>SymbolicLinkName<span class=\"token punctuation\">,</span> SYMBOLICLINK_NAME<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"135\"></td><td><pre></pre></td></tr><tr><td data-num=\"136\"></td><td><pre>\t<span class=\"token comment\">// 创建符号链接</span></pre></td></tr><tr><td data-num=\"137\"></td><td><pre>\tstatus <span class=\"token operator\">=</span> <span class=\"token function\">IoCreateSymbolicLink</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>SymbolicLinkName<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>Devicename<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"138\"></td><td><pre>\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>status <span class=\"token operator\">!=</span> STATUS_SUCCESS<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"139\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"140\"></td><td><pre>\t\t<span class=\"token function\">DbgPrint</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"创建符号链接失败! \\r\\n\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"141\"></td><td><pre>\t\t<span class=\"token function\">IoDeleteDevice</span><span class=\"token punctuation\">(</span>pDeviceObj<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"142\"></td><td><pre>\t\t<span class=\"token keyword\">return</span> status<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"143\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"144\"></td><td><pre></pre></td></tr><tr><td data-num=\"145\"></td><td><pre>\t<span class=\"token comment\">// 设置分发函数和卸载函数</span></pre></td></tr><tr><td data-num=\"146\"></td><td><pre>\tpDriver<span class=\"token operator\">-></span>MajorFunction<span class=\"token punctuation\">[</span>IRP_MJ_CREATE<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> IrpCreateProc<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"147\"></td><td><pre>\tpDriver<span class=\"token operator\">-></span>MajorFunction<span class=\"token punctuation\">[</span>IRP_MJ_CLOSE<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> IrpCloseProc<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"148\"></td><td><pre>\tpDriver<span class=\"token operator\">-></span>MajorFunction<span class=\"token punctuation\">[</span>IRP_MJ_DEVICE_CONTROL<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> IrpDeviceControlProc<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"149\"></td><td><pre>\tpDriver<span class=\"token operator\">-></span>DriverUnload <span class=\"token operator\">=</span> DriverUnload<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"150\"></td><td><pre></pre></td></tr><tr><td data-num=\"151\"></td><td><pre>\t<span class=\"token keyword\">return</span> STATUS_SUCCESS<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"152\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h3 id=\"r3代码\"><a class=\"anchor\" href=\"#r3代码\">#</a> R3 代码</h3>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">_CRT_SECURE_NO_WARNINGS</span></span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;stdio.h></span></span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;windows.h></span></span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;winioctl.h></span></span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">IN_BUFFER_MAXLENGTH</span>  <span class=\"token expression\"><span class=\"token number\">0x10</span>\t</span><span class=\"token comment\">// 输入缓存最大长度</span></span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">OUT_BUFFER_MAXLENGTH</span> <span class=\"token expression\"><span class=\"token number\">0x10</span>\t</span><span class=\"token comment\">// 输出缓存最大长度</span></span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">OPER1</span> <span class=\"token expression\"><span class=\"token function\">CTL_CODE</span><span class=\"token punctuation\">(</span>FILE_DEVICE_UNKNOWN<span class=\"token punctuation\">,</span> <span class=\"token number\">0x800</span><span class=\"token punctuation\">,</span> METHOD_BUFFERED<span class=\"token punctuation\">,</span> FILE_ANY_ACCESS<span class=\"token punctuation\">)</span></span></span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">OPER2</span> <span class=\"token expression\"><span class=\"token function\">CTL_CODE</span><span class=\"token punctuation\">(</span>FILE_DEVICE_UNKNOWN<span class=\"token punctuation\">,</span> <span class=\"token number\">0x900</span><span class=\"token punctuation\">,</span> METHOD_BUFFERED<span class=\"token punctuation\">,</span> FILE_ANY_ACCESS<span class=\"token punctuation\">)</span></span></span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">SYMBOLICLINK_NAME</span> <span class=\"token string\">\"\\\\\\\\.\\\\MyTestDriver\"</span></span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>HANDLE g_hDevice<span class=\"token punctuation\">;</span>\t<span class=\"token comment\">// 驱动句柄</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token comment\">/***************************************************************************/</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token comment\">// 打开驱动服务句柄</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token comment\">// 打开三环链接名：\\\\\\\\.\\\\Driver</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token comment\">/***************************************************************************/</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>BOOL <span class=\"token function\">Open</span><span class=\"token punctuation\">(</span>PCHAR pLinkName<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>\tTCHAR szBuffer<span class=\"token punctuation\">[</span><span class=\"token number\">10</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span> <span class=\"token number\">0</span> <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>\t<span class=\"token comment\">// 在 3 环获取驱动程序</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>\tg_hDevice <span class=\"token operator\">=</span> <span class=\"token function\">CreateFile</span><span class=\"token punctuation\">(</span>pLinkName<span class=\"token punctuation\">,</span> GENERIC_READ <span class=\"token operator\">|</span> GENERIC_WRITE<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> OPEN_EXISTING<span class=\"token punctuation\">,</span> FILE_ATTRIBUTE_NORMAL<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>\tDWORD err <span class=\"token operator\">=</span> <span class=\"token function\">GetLastError</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>\t<span class=\"token function\">sprintf</span><span class=\"token punctuation\">(</span>szBuffer<span class=\"token punctuation\">,</span> <span class=\"token string\">\"%d\\n\"</span><span class=\"token punctuation\">,</span> err<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>g_hDevice <span class=\"token operator\">!=</span> INVALID_HANDLE_VALUE<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>\t\t<span class=\"token keyword\">return</span> TRUE<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>\t<span class=\"token keyword\">else</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>\t\t<span class=\"token keyword\">return</span> FALSE<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre></pre></td></tr><tr><td data-num=\"31\"></td><td><pre><span class=\"token comment\">/***************************************************************************/</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre><span class=\"token comment\">// 与驱动通信的函数</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre><span class=\"token comment\">/***************************************************************************/</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>BOOL <span class=\"token function\">IoControl</span><span class=\"token punctuation\">(</span>DWORD dwIoCode<span class=\"token punctuation\">,</span> PVOID InBuff<span class=\"token punctuation\">,</span> DWORD InBuffLen<span class=\"token punctuation\">,</span> PVOID OutBuff<span class=\"token punctuation\">,</span> DWORD OutBuffLen<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>\tDWORD dw<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>\t<span class=\"token comment\">// 驱动句柄 / 操作码 / 输入缓冲区地址 / 输入缓冲区长度 / 输出缓冲区地址 / 输出缓冲区长度 / 返回长度 / 指向 OVERLAPPED 此处为 NULL</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>\t<span class=\"token function\">DeviceIoControl</span><span class=\"token punctuation\">(</span>g_hDevice<span class=\"token punctuation\">,</span> dwIoCode<span class=\"token punctuation\">,</span> InBuff<span class=\"token punctuation\">,</span> InBuffLen<span class=\"token punctuation\">,</span> OutBuff<span class=\"token punctuation\">,</span> OutBuffLen<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>dw<span class=\"token punctuation\">,</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>\t<span class=\"token keyword\">return</span> TRUE<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre></pre></td></tr><tr><td data-num=\"43\"></td><td><pre></pre></td></tr><tr><td data-num=\"44\"></td><td><pre><span class=\"token keyword\">int</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>\tDWORD dwInBuffer <span class=\"token operator\">=</span> <span class=\"token number\">0x11223344</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>\tTCHAR szOutBuffer<span class=\"token punctuation\">[</span>OUT_BUFFER_MAXLENGTH<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span> <span class=\"token number\">0</span> <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>\t<span class=\"token comment\">//1. 通过符号链接，打开设备</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>\t<span class=\"token function\">Open</span><span class=\"token punctuation\">(</span>SYMBOLICLINK_NAME<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre></pre></td></tr><tr><td data-num=\"52\"></td><td><pre>\t<span class=\"token comment\">//2. 测试通信</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>\t<span class=\"token function\">IoControl</span><span class=\"token punctuation\">(</span>OPER2<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>dwInBuffer<span class=\"token punctuation\">,</span> IN_BUFFER_MAXLENGTH<span class=\"token punctuation\">,</span> szOutBuffer<span class=\"token punctuation\">,</span> OUT_BUFFER_MAXLENGTH<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre>\t<span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"%s\"</span><span class=\"token punctuation\">,</span> szOutBuffer<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>\t<span class=\"token comment\">//3. 关闭设备</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre>\t<span class=\"token function\">CloseHandle</span><span class=\"token punctuation\">(</span>g_hDevice<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre></pre></td></tr><tr><td data-num=\"59\"></td><td><pre>\t<span class=\"token function\">getchar</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre>\t<span class=\"token keyword\">return</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"61\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h1 id=\"reference\"><a class=\"anchor\" href=\"#reference\">#</a> Reference</h1>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQxOTg4NDQ4L2FydGljbGUvZGV0YWlscy8xMDM1MTk0Nzg=\">https://blog.csdn.net/qq_41988448/article/details/103519478</span><br />\n<span class=\"exturl\" data-url=\"aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L0t3YW5zeS9hcnRpY2xlL2RldGFpbHMvMTA5MTcwMTI5\">https://blog.csdn.net/Kwansy/article/details/109170129</span><br />\n<span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cueHVlYnV5dWFuLmNvbS84Mzg0OTkuaHRtbA==\">https://www.xuebuyuan.com/838499.html</span><br />\n<span class=\"exturl\" data-url=\"aHR0cHM6Ly9iYWlrZS5iYWlkdS5jb20vaXRlbS9Jb0NyZWF0ZURldmljZSUyOCUyOS8zMDcxNTM2\">https://baike.baidu.com/item/IoCreateDevice()/3071536</span></p>\n",
            "tags": [
                "0环与3环的通信（常规方法）"
            ]
        },
        {
            "id": "https://or0kit.github.io/Bin/Core/Drive-Development/%E9%A9%B1%E5%8A%A8%E5%BC%80%E5%8F%91-%E5%86%85%E6%A0%B8%E7%A9%BA%E9%97%B4%E5%92%8C%E5%86%85%E6%A0%B8%E6%A8%A1%E5%9D%97/",
            "url": "https://or0kit.github.io/Bin/Core/Drive-Development/%E9%A9%B1%E5%8A%A8%E5%BC%80%E5%8F%91-%E5%86%85%E6%A0%B8%E7%A9%BA%E9%97%B4%E5%92%8C%E5%86%85%E6%A0%B8%E6%A8%A1%E5%9D%97/",
            "title": "驱动开发-内核空间和内核模块",
            "date_published": "2021-09-24T15:53:44.000Z",
            "content_html": "<h1 id=\"内核空间\"><a class=\"anchor\" href=\"#内核空间\">#</a> 内核空间</h1>\n<p>每个进程的低 2G 都是独立的，它们所对应的物理页都是不一样的，而高 2G 所对应的物理页都是相同的。</p>\n<p>概念图:</p>\n<p><img data-src=\"image001.png\" alt=\"\" /></p>\n<h2 id=\"实验验证\"><a class=\"anchor\" href=\"#实验验证\">#</a> 实验验证</h2>\n<p>写一个驱动程序定义一个全局变量，在不同进程中查看。</p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span><span class=\"token string\">&lt;ntddk.h></span></span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>ULONG g_Value <span class=\"token operator\">=</span> <span class=\"token number\">0x12345678</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>VOID <span class=\"token function\">DriverUnload</span><span class=\"token punctuation\">(</span>PDRIVER_OBJECT pdriver<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>\t<span class=\"token function\">DbgPrint</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"我是驱动，我卸载了\\n\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>NTSTATUS <span class=\"token function\">DriverEntry</span><span class=\"token punctuation\">(</span>PDRIVER_OBJECT pdriver<span class=\"token punctuation\">,</span> PUNICODE_STRING reg_path<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\t<span class=\"token function\">DbgPrint</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"我是驱动我运行了\\n\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>\t<span class=\"token function\">DbgPrint</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"%p\\n\"</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>g_Value<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>\tpdriver<span class=\"token operator\">-></span>DriverUnload <span class=\"token operator\">=</span> DriverUnload<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>\t<span class=\"token keyword\">return</span> STATUS_SUCCESS<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p><img data-src=\"image002.png\" alt=\"\" /><br />\n<img data-src=\"image003.png\" alt=\"\" /></p>\n<h1 id=\"内核模块\"><a class=\"anchor\" href=\"#内核模块\">#</a> 内核模块</h1>\n<p>硬件的种类繁多，不可能做一个兼容所有硬件的内核，因此，微软提供规定的接口格式，让硬件驱动人员按照规定的格式编写 “驱动程序”<br />\n 这些驱动程序每一个都是一个模块，称为 “内核模块”，可以加载到内核中，并遵守 PE 结构。但本质上讲，任意一个.sys 文件与内核文件没有区别<br />\n不管是我们自己编写的 .sys 文件，还是 Windows 自带的内核文件（如 ntoskrnl.exe），它们在内核中的地位是相同的，都是内核模块中的其中一个</p>\n<p><img data-src=\"image004.png\" alt=\"\" /></p>\n<h1 id=\"驱动对象\"><a class=\"anchor\" href=\"#驱动对象\">#</a> 驱动对象</h1>\n<h2 id=\"_driver_object结构体\"><a class=\"anchor\" href=\"#_driver_object结构体\">#</a>  <code>_DRIVER_OBJECT</code>  结构体</h2>\n<pre><code>kd&gt; dt _DRIVER_OBJECT\nnt!_DRIVER_OBJECT\n  +0x000 Type             : Int2B\n  +0x002 Size             : Int2B\n  +0x004 DeviceObject     : Ptr32 _DEVICE_OBJECT\n  +0x008 Flags            : Uint4B\n  +0x00c DriverStart      : Ptr32 Void\n  +0x010 DriverSize       : Uint4B\n  +0x014 DriverSection    : Ptr32 Void\n  +0x018 DriverExtension  : Ptr32 _DRIVER_EXTENSION\n  +0x01c DriverName       : _UNICODE_STRING\n  +0x024 HardwareDatabase : Ptr32 _UNICODE_STRING\n  +0x028 FastIoDispatch   : Ptr32 _FAST_IO_DISPATCH\n  +0x02c DriverInit       : Ptr32     long \n  +0x030 DriverStartIo    : Ptr32     void \n  +0x034 DriverUnload     : Ptr32     void \n  +0x038 MajorFunction    : [28] Ptr32     long \n</code></pre>\n<p>其中对我们来说比较重要的结构:<br />\n <code>DriverStart：</code> 驱动模块在内核中的地址<br />\n <code>DriverSize：</code> 驱动模块在内核中的大小<br />\n <code>DriverName：</code> 驱动模块在内核中的名字<br />\n <code>DriverSection：</code> 指向  <code>_LDR_DATA_TABLE_ENTRY</code>  结构体</p>\n<h2 id=\"_ldr_data_table_entry-结构体\"><a class=\"anchor\" href=\"#_ldr_data_table_entry-结构体\">#</a>  <code>_LDR_DATA_TABLE_ENTRY</code>  结构体</h2>\n<p>描述：包含了当前内核模块的具体信息，以及其它内核模块的双向链表。</p>\n<pre><code>kd&gt; dt _LDR_DATA_TABLE_ENTRY\nnt!_LDR_DATA_TABLE_ENTRY\n  +0x000 InLoadOrderLinks : _LIST_ENTRY\n  +0x008 InMemoryOrderLinks : _LIST_ENTRY\n  +0x010 InInitializationOrderLinks : _LIST_ENTRY\n  +0x018 DllBase          : Ptr32 Void\n  +0x01c EntryPoint       : Ptr32 Void\n  +0x020 SizeOfImage      : Uint4B\n  +0x024 FullDllName      : _UNICODE_STRING\n  +0x02c BaseDllName      : _UNICODE_STRING\n  +0x034 Flags            : Uint4B\n  +0x038 LoadCount        : Uint2B\n  +0x03a TlsIndex         : Uint2B\n  +0x03c HashLinks        : _LIST_ENTRY\n  +0x03c SectionPointer   : Ptr32 Void\n  +0x040 CheckSum         : Uint4B\n  +0x044 TimeDateStamp    : Uint4B\n  +0x044 LoadedImports    : Ptr32 Void\n  +0x048 EntryPointActivationContext : Ptr32 Void\n  +0x04c PatchInformation : Ptr32 Void\n</code></pre>\n<p>和 3 环有点区别，在 0 环中  <code>InMemoryOrderLinks</code>  和  <code>InInitializationOrderLinks</code>  是没用的，只需要关注第一个链表  <code>InLoadOrderLinks</code> 。</p>\n<p><code>_LIST_ENTRY</code>  这个结构体存了两个地址，指向前一个节点和下一个节点。</p>\n<pre><code>kd&gt; dt _LIST_ENTRY\nntdll!_LIST_ENTRY\n  +0x000 Flink            : Ptr32 _LIST_ENTRY\n  +0x004 Blink            : Ptr32 _LIST_ENTRY\n</code></pre>\n<p>比较重要的结构:<br />\n <code>InLoadOrderLinks：</code> 双向链表，包含所有内核模块<br />\n <code>DllBase：</code> 当前内核模块起始地址<br />\n <code>SizeOfImage：</code> 当前内核模块的大小<br />\n <code>FullDllName：</code> 当前内核模块的完整路径<br />\n <code>BaseDllName：</code> 当前内核模块的模块名</p>\n<h2 id=\"遍历内核模块\"><a class=\"anchor\" href=\"#遍历内核模块\">#</a> 遍历内核模块</h2>\n<p>我们可以发现，我们可以由一个内核模块遍历处所有的内核模块。</p>\n<p>通过这个  <code>InLoadOrderLinks</code> ，我们可以遍历整个高 2G 的模块了。 <code>InLoadOrderLinks.Flink</code>  指向的就是下一个  <code>_LDR_DATA_TABLE_ENTRY</code> 。</p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">// 遍历内核模块</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span><span class=\"token string\">&lt;ntddk.h></span></span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token keyword\">typedef</span> <span class=\"token keyword\">struct</span> <span class=\"token class-name\">_LDR_DATA_TABLE_ENTRY</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>\tLIST_ENTRY InLoadOrderLinks<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>\tLIST_ENTRY InMemoryOrderLinks<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\tLIST_ENTRY InInitializationOrderLinks<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\tPVOID DllBase<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>\tPVOID EntryPoint<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>\tUINT32 SizeOfImage<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>\tUNICODE_STRING FullDllName<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>\tUNICODE_STRING BaseDllName<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>\tUINT32 Flags<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>\tUINT16 LoadCount<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>\tUINT16 TlsIndex<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>\tLIST_ENTRY HashLinks<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>\tPVOID SectionPointer<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>\tUINT32 CheckSum<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>\tUINT32 TimeDateStamp<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>\tPVOID LoadedImports<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>\tPVOID EntryPointActivationContext<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>\tPVOID PatchInformation<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre><span class=\"token punctuation\">&#125;</span> LDR_DATA_TABLE_ENTRY<span class=\"token punctuation\">,</span> <span class=\"token operator\">*</span> PLDR_DATA_TABLE_ENTRY<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre></pre></td></tr><tr><td data-num=\"27\"></td><td><pre></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>VOID <span class=\"token function\">DriverUnload</span><span class=\"token punctuation\">(</span>PDRIVER_OBJECT pdriver<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>\t<span class=\"token function\">DbgPrint</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"我是驱动，我卸载了\\n\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>NTSTATUS <span class=\"token function\">DriverEntry</span><span class=\"token punctuation\">(</span>PDRIVER_OBJECT pdriver<span class=\"token punctuation\">,</span> PUNICODE_STRING reg_path<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>\t<span class=\"token function\">DbgPrint</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"我是驱动，我运行了\\n\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>\tPLDR_DATA_TABLE_ENTRY pLdteHead<span class=\"token punctuation\">;</span> <span class=\"token comment\">// 内核模块链表头</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>\tPLDR_DATA_TABLE_ENTRY pLdteCur<span class=\"token punctuation\">;</span> <span class=\"token comment\">// 遍历指针</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>\tpLdteHead <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>PLDR_DATA_TABLE_ENTRY<span class=\"token punctuation\">)</span>pdriver<span class=\"token operator\">-></span>DriverSection<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>\tpLdteCur <span class=\"token operator\">=</span> pLdteHead<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>\t<span class=\"token keyword\">do</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>\t\t<span class=\"token function\">DbgPrint</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"DllBase: %p, SizeOfImage: %08X %wZ\\n\"</span><span class=\"token punctuation\">,</span> pLdteCur<span class=\"token operator\">-></span>DllBase<span class=\"token punctuation\">,</span> pLdteCur<span class=\"token operator\">-></span>SizeOfImage<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span><span class=\"token punctuation\">(</span>pLdteCur<span class=\"token operator\">-></span>FullDllName<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>\t\tpLdteCur <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>PLDR_DATA_TABLE_ENTRY<span class=\"token punctuation\">)</span>pLdteCur<span class=\"token operator\">-></span>InLoadOrderLinks<span class=\"token punctuation\">.</span>Flink<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span>pLdteHead <span class=\"token operator\">!=</span> pLdteCur<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre></pre></td></tr><tr><td data-num=\"46\"></td><td><pre></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>\tpdriver<span class=\"token operator\">-></span>DriverUnload <span class=\"token operator\">=</span> DriverUnload<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>\t<span class=\"token keyword\">return</span> STATUS_SUCCESS<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p><img data-src=\"image005.png\" alt=\"\" /></p>\n<h1 id=\"定位未导出函数pspterminateprocess\"><a class=\"anchor\" href=\"#定位未导出函数pspterminateprocess\">#</a> 定位未导出函数 PspTerminateProcess</h1>\n<p>我们想找未导出函数  <code>PspTerminateProcess</code> ，用来杀进程的。学习以下几种方法。</p>\n<h2 id=\"windbgpdb\"><a class=\"anchor\" href=\"#windbgpdb\">#</a> windbg+pdb</h2>\n<p>在有内核 PDB 的情况下，用 windbg 可以直接找到该函数：</p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>kd<span class=\"token operator\">></span>  u PspTerminateProcess l2e</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>  nt<span class=\"token operator\">!</span>PspTerminateProcess<span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  <span class=\"token number\">805</span>d3482 <span class=\"token number\">8</span>bff            mov     edi<span class=\"token punctuation\">,</span>edi</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  <span class=\"token number\">805</span>d3484 <span class=\"token number\">55</span>              push    ebp</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  <span class=\"token number\">805</span>d3485 <span class=\"token number\">8</span>bec            mov     ebp<span class=\"token punctuation\">,</span>esp</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  <span class=\"token number\">805</span>d3487 <span class=\"token number\">56</span>              push    esi</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  <span class=\"token number\">805</span>d3488 <span class=\"token number\">64</span>a124010000    mov     eax<span class=\"token punctuation\">,</span>dword ptr fs<span class=\"token operator\">:</span><span class=\"token punctuation\">[</span><span class=\"token number\">00000124</span>h<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  <span class=\"token number\">805</span>d348e <span class=\"token number\">8</span>b7508          mov     esi<span class=\"token punctuation\">,</span>dword ptr <span class=\"token punctuation\">[</span>ebp<span class=\"token operator\">+</span><span class=\"token number\">8</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  <span class=\"token number\">805</span>d3491 <span class=\"token number\">3</span>b7044          cmp     esi<span class=\"token punctuation\">,</span>dword ptr <span class=\"token punctuation\">[</span>eax<span class=\"token operator\">+</span><span class=\"token number\">44</span>h<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  <span class=\"token number\">805</span>d3494 <span class=\"token number\">7507</span>            jne     nt<span class=\"token operator\">!</span>PspTerminateProcess<span class=\"token operator\">+</span><span class=\"token number\">0</span><span class=\"token function\">x1b</span> <span class=\"token punctuation\">(</span><span class=\"token number\">805</span>d349d<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  <span class=\"token number\">805</span>d3496 b80d0000c0      mov     eax<span class=\"token punctuation\">,</span><span class=\"token number\">0</span>C000000Dh</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  <span class=\"token number\">805</span>d349b eb5a            jmp     nt<span class=\"token operator\">!</span>PspTerminateProcess<span class=\"token operator\">+</span><span class=\"token number\">0</span><span class=\"token function\">x75</span> <span class=\"token punctuation\">(</span><span class=\"token number\">805</span>d34f7<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>  <span class=\"token number\">805</span>d349d <span class=\"token number\">57</span>              push    edi</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>  <span class=\"token number\">805</span>d349e <span class=\"token number\">8</span>dbe48020000    lea     edi<span class=\"token punctuation\">,</span><span class=\"token punctuation\">[</span>esi<span class=\"token operator\">+</span><span class=\"token number\">248</span>h<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>  <span class=\"token number\">805</span>d34a4 f6470120        test    byte ptr <span class=\"token punctuation\">[</span>edi<span class=\"token operator\">+</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span><span class=\"token number\">20</span>h</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>  <span class=\"token number\">805</span>d34a8 <span class=\"token number\">7412</span>            je      nt<span class=\"token operator\">!</span>PspTerminateProcess<span class=\"token operator\">+</span><span class=\"token number\">0</span><span class=\"token function\">x3a</span> <span class=\"token punctuation\">(</span><span class=\"token number\">805</span>d34bc<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>  <span class=\"token number\">805</span>d34aa <span class=\"token number\">8</span>d8674010000    lea     eax<span class=\"token punctuation\">,</span><span class=\"token punctuation\">[</span>esi<span class=\"token operator\">+</span><span class=\"token number\">174</span>h<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>  <span class=\"token number\">805</span>d34b0 <span class=\"token number\">50</span>              push    eax</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>  <span class=\"token number\">805</span>d34b1 <span class=\"token number\">56</span>              push    esi</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>  <span class=\"token number\">805</span>d34b2 <span class=\"token number\">6854345</span>d80      push    offset nt<span class=\"token operator\">!</span>NtTerminateProcess<span class=\"token operator\">+</span><span class=\"token number\">0</span><span class=\"token function\">x14c</span> <span class=\"token punctuation\">(</span><span class=\"token number\">805</span>d3454<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>  <span class=\"token number\">805</span>d34b7 e8f2eeffff      call    nt<span class=\"token operator\">!</span><span class=\"token function\">PspCatchCriticalBreak</span> <span class=\"token punctuation\">(</span><span class=\"token number\">805</span>d23ae<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>  <span class=\"token number\">805</span>d34bc <span class=\"token number\">6</span>a08            push    <span class=\"token number\">8</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>  <span class=\"token number\">805</span>d34be <span class=\"token number\">58</span>              pop     eax</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>  <span class=\"token number\">805</span>d34bf f00907          lock or dword ptr <span class=\"token punctuation\">[</span>edi<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>eax</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>  <span class=\"token number\">805</span>d34c2 <span class=\"token number\">6</span>a00            push    <span class=\"token number\">0</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>  <span class=\"token number\">805</span>d34c4 <span class=\"token number\">56</span>              push    esi</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>  <span class=\"token number\">805</span>d34c5 e8ca560000      call    nt<span class=\"token operator\">!</span><span class=\"token function\">PsGetNextProcessThread</span> <span class=\"token punctuation\">(</span><span class=\"token number\">805</span>d8b94<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>  <span class=\"token number\">805</span>d34ca <span class=\"token number\">8</span>bf8            mov     edi<span class=\"token punctuation\">,</span>eax</pre></td></tr><tr><td data-num=\"29\"></td><td><pre>  <span class=\"token number\">805</span>d34cc <span class=\"token number\">85ff</span>            test    edi<span class=\"token punctuation\">,</span>edi</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>  <span class=\"token number\">805</span>d34ce <span class=\"token number\">741</span>e            je      nt<span class=\"token operator\">!</span>PspTerminateProcess<span class=\"token operator\">+</span><span class=\"token number\">0</span><span class=\"token function\">x6c</span> <span class=\"token punctuation\">(</span><span class=\"token number\">805</span>d34ee<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>  <span class=\"token number\">805</span>d34d0 ff750c          push    dword ptr <span class=\"token punctuation\">[</span>ebp<span class=\"token operator\">+</span><span class=\"token number\">0</span>Ch<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>  <span class=\"token number\">805</span>d34d3 <span class=\"token number\">57</span>              push    edi</pre></td></tr><tr><td data-num=\"33\"></td><td><pre>  <span class=\"token number\">805</span>d34d4 e807fdffff      call    nt<span class=\"token operator\">!</span><span class=\"token function\">PspTerminateThreadByPointer</span> <span class=\"token punctuation\">(</span><span class=\"token number\">805</span>d31e0<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>  <span class=\"token number\">805</span>d34d9 <span class=\"token number\">57</span>              push    edi</pre></td></tr><tr><td data-num=\"35\"></td><td><pre>  <span class=\"token number\">805</span>d34da <span class=\"token number\">56</span>              push    esi</pre></td></tr><tr><td data-num=\"36\"></td><td><pre>  <span class=\"token number\">805</span>d34db e8b4560000      call    nt<span class=\"token operator\">!</span><span class=\"token function\">PsGetNextProcessThread</span> <span class=\"token punctuation\">(</span><span class=\"token number\">805</span>d8b94<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>  <span class=\"token number\">805</span>d34e0 <span class=\"token number\">8</span>bf8            mov     edi<span class=\"token punctuation\">,</span>eax</pre></td></tr><tr><td data-num=\"38\"></td><td><pre>  <span class=\"token number\">805</span>d34e2 <span class=\"token number\">85ff</span>            test    edi<span class=\"token punctuation\">,</span>edi</pre></td></tr><tr><td data-num=\"39\"></td><td><pre>  <span class=\"token number\">805</span>d34e4 <span class=\"token number\">75</span>ea            jne     nt<span class=\"token operator\">!</span>PspTerminateProcess<span class=\"token operator\">+</span><span class=\"token number\">0</span><span class=\"token function\">x4e</span> <span class=\"token punctuation\">(</span><span class=\"token number\">805</span>d34d0<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>  <span class=\"token number\">805</span>d34e6 <span class=\"token number\">3986</span>bc000000    cmp     dword ptr <span class=\"token punctuation\">[</span>esi<span class=\"token operator\">+</span><span class=\"token number\">0</span>BCh<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>eax</pre></td></tr><tr><td data-num=\"41\"></td><td><pre>  <span class=\"token number\">805</span>d34ec <span class=\"token number\">7406</span>            je      nt<span class=\"token operator\">!</span>PspTerminateProcess<span class=\"token operator\">+</span><span class=\"token number\">0</span><span class=\"token function\">x72</span> <span class=\"token punctuation\">(</span><span class=\"token number\">805</span>d34f4<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>  <span class=\"token number\">805</span>d34ee <span class=\"token number\">56</span>              push    esi</pre></td></tr><tr><td data-num=\"43\"></td><td><pre>  <span class=\"token number\">805</span>d34ef e86e05ffff      call    nt<span class=\"token operator\">!</span><span class=\"token function\">ObClearProcessHandleTable</span> <span class=\"token punctuation\">(</span><span class=\"token number\">805</span>c3a62<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>  <span class=\"token number\">805</span>d34f4 <span class=\"token number\">33</span>c0            xor     eax<span class=\"token punctuation\">,</span>eax</pre></td></tr><tr><td data-num=\"45\"></td><td><pre>  <span class=\"token number\">805</span>d34f6 <span class=\"token number\">5f</span>              pop     edi</pre></td></tr><tr><td data-num=\"46\"></td><td><pre>  <span class=\"token number\">805</span>d34f7 <span class=\"token number\">5</span>e              pop     esi</pre></td></tr><tr><td data-num=\"47\"></td><td><pre>  <span class=\"token number\">805</span>d34f8 <span class=\"token number\">5</span>d              pop     ebp</pre></td></tr><tr><td data-num=\"48\"></td><td><pre>  <span class=\"token number\">805</span>d34f9 c20800          ret     <span class=\"token number\">8</span></pre></td></tr></table></figure><p>805d3482 就是函数头，然而这个值由于重定位，可能会变的，所以我们就要用其他办法，确保每次都能找到这个函数。</p>\n<h2 id=\"通过已导出函数\"><a class=\"anchor\" href=\"#通过已导出函数\">#</a> 通过已导出函数</h2>\n<p>第二种办法是根据已导出函数找未导出函数，在驱动里找已导出函数使用的函数是  <code>MmGetSystemRoutineAddress</code>  。我们通过 IDA 交叉引用，并没有找到调用 PspTerminateProcess 的导出函数。</p>\n<h2 id=\"模块基址偏移\"><a class=\"anchor\" href=\"#模块基址偏移\">#</a> 模块基址 + 偏移</h2>\n<p>虽然模块基址会变，但是函数相对基址的偏移是不变的，通过这个规律也可以找到想要的函数。<br />\nPspTerminateProcess 相对内核基址的偏移 = 8062f050 - 804D8000 = 157050<br />\n 只要找到内核基址，加上 0x157050 就是 PspTerminateProcess 的地址。</p>\n<h2 id=\"特征码匹配最常用\"><a class=\"anchor\" href=\"#特征码匹配最常用\">#</a> 特征码匹配（最常用）</h2>\n<p>特征码提取时，<strong>要避免使用全局变量等和重定位有关的指令</strong>，也要<strong>避免提取这种所有函数都有的指令</strong>。</p>\n<pre><code>805d3482 8bff            mov     edi,edi\n805d3484 55              push    ebp\n805d3485 8bec            mov     ebp,esp\n805d3487 56              push    esi\n</code></pre>\n<p>我是跳着提取特征码的:</p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">// 函数 PspTerminateProcess 开头对应的硬编码</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>pShellCode<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span>\t\t\t<span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>UINT32<span class=\"token punctuation\">)</span><span class=\"token number\">0x8b55ff8b</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\">// 相对函数开头偏移 0X0C 个字节后对应的硬编码</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>pShellCode<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span>\t\t\t<span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>UINT32<span class=\"token punctuation\">)</span><span class=\"token number\">0x3b08758b</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token comment\">// 相对函数开头偏移 0X22 个字节后对应的硬编码</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token operator\">*</span><span class=\"token punctuation\">(</span>pShellCode <span class=\"token operator\">+</span> <span class=\"token number\">2</span><span class=\"token punctuation\">)</span>\t\t<span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>UINT32<span class=\"token punctuation\">)</span><span class=\"token number\">0x200147f6</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token comment\">// 相对函数开头偏移 0X48 个字节后对应的硬编码</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token operator\">*</span><span class=\"token punctuation\">(</span>pShellCode <span class=\"token operator\">+</span> <span class=\"token number\">3</span><span class=\"token punctuation\">)</span>\t\t<span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>UINT32<span class=\"token punctuation\">)</span><span class=\"token number\">0xff85f88b</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token comment\">// 相对函数开头偏移 0X6A 个字节后对应的硬编码</span></pre></td></tr></table></figure><p>代码如下：</p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span><span class=\"token string\">&lt;ntifs.h></span></span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">FristOffset</span>\t\t<span class=\"token expression\"><span class=\"token number\">0x0</span></span></span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">SecondOffset</span>\t<span class=\"token expression\"><span class=\"token number\">0x0C</span></span></span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">ThirdOffset</span>\t\t<span class=\"token expression\"><span class=\"token number\">0x22</span></span></span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">FourthOffset</span>\t<span class=\"token expression\"><span class=\"token number\">0x48</span></span></span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">FifthOffset</span>\t\t<span class=\"token expression\"><span class=\"token number\">0x6A</span></span></span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token keyword\">typedef</span> <span class=\"token keyword\">struct</span> <span class=\"token class-name\">_LDR_DATA_TABLE_ENTRY</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\tLIST_ENTRY InLoadOrderLinks<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>\tLIST_ENTRY InMemoryOrderLinks<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>\tLIST_ENTRY InInitializationOrderLinks<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>\tPVOID DllBase<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>\tPVOID EntryPoint<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>\tUINT32 SizeOfImage<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>\tUNICODE_STRING FullDllName<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>\tUNICODE_STRING BaseDllName<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>\tUINT32 Flages<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>\tUINT16 LoadCount<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>\tUINT16 TlsIndex<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>\tLIST_ENTRY HashLinks<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>\tPVOID SectionPointer<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>\tUINT32 CheckSum<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>\tUINT32 TimeDateStamp<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>\tPVOID LoadedImports<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>\tPVOID EntryPointActivationContext<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>\tPVOID PatchInformation<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre><span class=\"token punctuation\">&#125;</span>LDR_DATA_TABLE_ENTRY<span class=\"token punctuation\">,</span><span class=\"token operator\">*</span>PLDR_DATA_TABLE_ENTRY<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre></pre></td></tr><tr><td data-num=\"30\"></td><td><pre><span class=\"token comment\">// 定义 PspTerminateProcess 函数指针</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre><span class=\"token keyword\">typedef</span> <span class=\"token function\">NTSTATUS</span><span class=\"token punctuation\">(</span><span class=\"token operator\">*</span>_PspTerminateProcess<span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span>PEPROCESS pEprocess<span class=\"token punctuation\">,</span> NTSTATUS ExitCode<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>_PspTerminateProcess PspTerminateProcess <span class=\"token operator\">=</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>VOID <span class=\"token function\">DriverUnload</span><span class=\"token punctuation\">(</span>PDRIVER_OBJECT pdriver<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>\t<span class=\"token function\">DbgPrint</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"我是驱动，我停止加载了\\n\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre></pre></td></tr><tr><td data-num=\"38\"></td><td><pre><span class=\"token comment\">// 获取内核基址，大小</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>VOID <span class=\"token function\">GetKernelBase</span><span class=\"token punctuation\">(</span>IN PDRIVER_OBJECT driver<span class=\"token punctuation\">,</span> OUT PVOID<span class=\"token operator\">*</span> pKrnlBase<span class=\"token punctuation\">,</span> OUT PUINT32 uKrnlImageSize<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>\tPLDR_DATA_TABLE_ENTRY pLdteHead<span class=\"token punctuation\">;</span> <span class=\"token comment\">// 内核模块链表头</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>\tPLDR_DATA_TABLE_ENTRY pLdteCur<span class=\"token punctuation\">;</span> <span class=\"token comment\">// 遍历指针</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>\tUNICODE_STRING usBaseDllNameNtoskrnl<span class=\"token punctuation\">,</span> usDllNameNtkrnlpa<span class=\"token punctuation\">;</span> <span class=\"token comment\">// 内核模块名</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>\t<span class=\"token comment\">// 两种分页模式下的内核模块</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>\t<span class=\"token function\">RtlInitUnicodeString</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>usBaseDllNameNtoskrnl<span class=\"token punctuation\">,</span> L<span class=\"token string\">\"ntoskrnl.exe\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>\t<span class=\"token function\">RtlInitUnicodeString</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>usDllNameNtkrnlpa<span class=\"token punctuation\">,</span> L<span class=\"token string\">\"ntkrnlpa.exe\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>\tpLdteHead <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>PLDR_DATA_TABLE_ENTRY<span class=\"token punctuation\">)</span>driver<span class=\"token operator\">-></span>DriverSection<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>\tpLdteCur <span class=\"token operator\">=</span> pLdteHead<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>\t<span class=\"token keyword\">do</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>\t\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre>\t\t\t<span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre>\t\t\t\t<span class=\"token punctuation\">(</span><span class=\"token function\">RtlCompareUnicodeString</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>pLdteCur<span class=\"token operator\">-></span>BaseDllName<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>usBaseDllNameNtoskrnl<span class=\"token punctuation\">,</span> TRUE<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>\t\t\t\t<span class=\"token operator\">||</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre>\t\t\t\t<span class=\"token punctuation\">(</span><span class=\"token function\">RtlCompareUnicodeString</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>pLdteCur<span class=\"token operator\">-></span>BaseDllName<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>usBaseDllNameNtoskrnl<span class=\"token punctuation\">,</span> TRUE<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre>\t\t\t\t<span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> <span class=\"token number\">0</span></pre></td></tr><tr><td data-num=\"59\"></td><td><pre>\t\t\t<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre>\t\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"61\"></td><td><pre>\t\t\t<span class=\"token operator\">*</span>pKrnlBase <span class=\"token operator\">=</span> pLdteCur<span class=\"token operator\">-></span>DllBase<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"62\"></td><td><pre>\t\t\t<span class=\"token operator\">*</span>uKrnlImageSize <span class=\"token operator\">=</span> pLdteCur<span class=\"token operator\">-></span>SizeOfImage<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"63\"></td><td><pre>\t\t\t<span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"64\"></td><td><pre>\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"65\"></td><td><pre>\t\tpLdteCur <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>PLDR_DATA_TABLE_ENTRY<span class=\"token punctuation\">)</span>pLdteCur<span class=\"token operator\">-></span>InLoadOrderLinks<span class=\"token punctuation\">.</span>Flink<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"66\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span>pLdteHead <span class=\"token operator\">!=</span> pLdteCur<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"67\"></td><td><pre>\t<span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"68\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"69\"></td><td><pre></pre></td></tr><tr><td data-num=\"70\"></td><td><pre>PVOID <span class=\"token function\">GetUndocumentFunctionAddress</span><span class=\"token punctuation\">(</span>PUCHAR pStartAddress<span class=\"token punctuation\">,</span> PUINT32 pShellcode<span class=\"token punctuation\">,</span> UINT32 maxSize<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"71\"></td><td><pre>\t<span class=\"token class-name\">size_t</span> i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> j <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"72\"></td><td><pre>\tPUCHAR Tmp <span class=\"token operator\">=</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"73\"></td><td><pre>\tpStartAddress <span class=\"token operator\">+=</span> <span class=\"token number\">0xFB000</span><span class=\"token punctuation\">;</span><span class=\"token comment\">// 从内核基址 0x804d8000 到这个函数的位置 0x805d3482 需要循环遍历 0xFB482 (1029250) 次，此举是为了节约时间……</span></pre></td></tr><tr><td data-num=\"74\"></td><td><pre>\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token function\">MmIsAddressValid</span><span class=\"token punctuation\">(</span>pStartAddress<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"75\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"76\"></td><td><pre>\t\t<span class=\"token function\">DbgPrint</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"pStartAddress地址不合法，或者地址指向内存不可读！\\n\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"77\"></td><td><pre>\t\t<span class=\"token keyword\">return</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"78\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"79\"></td><td><pre>\t<span class=\"token function\">DbgPrint</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"地址合法，开始查找...\\n\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"80\"></td><td><pre>\t<span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> maxSize<span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"81\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"82\"></td><td><pre>\t\tTmp <span class=\"token operator\">=</span> pStartAddress <span class=\"token operator\">+</span> i<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"83\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"84\"></td><td><pre>\t\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"85\"></td><td><pre>\t\t\t<span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token operator\">*</span><span class=\"token punctuation\">(</span>PUINT32<span class=\"token punctuation\">)</span><span class=\"token operator\">&amp;</span>Tmp<span class=\"token punctuation\">[</span>FristOffset<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> pShellcode<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"86\"></td><td><pre>\t\t\t<span class=\"token operator\">&amp;&amp;</span></pre></td></tr><tr><td data-num=\"87\"></td><td><pre>\t\t\t<span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token operator\">*</span><span class=\"token punctuation\">(</span>PUINT32<span class=\"token punctuation\">)</span><span class=\"token operator\">&amp;</span>Tmp<span class=\"token punctuation\">[</span>SecondOffset<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> pShellcode<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"88\"></td><td><pre>\t\t\t<span class=\"token operator\">&amp;&amp;</span></pre></td></tr><tr><td data-num=\"89\"></td><td><pre>\t\t\t<span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token operator\">*</span><span class=\"token punctuation\">(</span>PUINT32<span class=\"token punctuation\">)</span><span class=\"token operator\">&amp;</span>Tmp<span class=\"token punctuation\">[</span>ThirdOffset<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> pShellcode<span class=\"token punctuation\">[</span><span class=\"token number\">2</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"90\"></td><td><pre>\t\t\t<span class=\"token operator\">&amp;&amp;</span></pre></td></tr><tr><td data-num=\"91\"></td><td><pre>\t\t\t<span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token operator\">*</span><span class=\"token punctuation\">(</span>PUINT32<span class=\"token punctuation\">)</span><span class=\"token operator\">&amp;</span>Tmp<span class=\"token punctuation\">[</span>FourthOffset<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> pShellcode<span class=\"token punctuation\">[</span><span class=\"token number\">3</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"92\"></td><td><pre>\t\t\t<span class=\"token operator\">&amp;&amp;</span></pre></td></tr><tr><td data-num=\"93\"></td><td><pre>\t\t\t<span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token operator\">*</span><span class=\"token punctuation\">(</span>PUINT32<span class=\"token punctuation\">)</span><span class=\"token operator\">&amp;</span>Tmp<span class=\"token punctuation\">[</span>FifthOffset<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> pShellcode<span class=\"token punctuation\">[</span><span class=\"token number\">4</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"94\"></td><td><pre>\t\t\t<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"95\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"96\"></td><td><pre>\t\t<span class=\"token comment\">//DbgPrint(\"i=%d\\n\", i);</span></pre></td></tr><tr><td data-num=\"97\"></td><td><pre>\t\t<span class=\"token comment\">//UINT32 S1 = *(PUINT32)&amp;Tmp[FristOffset],</span></pre></td></tr><tr><td data-num=\"98\"></td><td><pre>\t\t<span class=\"token comment\">//\tS2 = *(PUINT32)&amp;Tmp[SecondOffset],</span></pre></td></tr><tr><td data-num=\"99\"></td><td><pre>\t\t<span class=\"token comment\">//\tS3 = *(PUINT32)&amp;Tmp[ThirdOffset],</span></pre></td></tr><tr><td data-num=\"100\"></td><td><pre>\t\t<span class=\"token comment\">//\tS4 = *(PUINT32)&amp;Tmp[FourthOffset],</span></pre></td></tr><tr><td data-num=\"101\"></td><td><pre>\t\t<span class=\"token comment\">//\tS5 = *(PUINT32)&amp;Tmp[FifthOffset];</span></pre></td></tr><tr><td data-num=\"102\"></td><td><pre></pre></td></tr><tr><td data-num=\"103\"></td><td><pre>\t\t<span class=\"token comment\">//DbgPrint(\"S1=%08X\\tS2=%08X\\tS3=%08X\\tS4=%08X\\tS5=%08X\\n\", S1, S2, S3, S4, S5);</span></pre></td></tr><tr><td data-num=\"104\"></td><td><pre></pre></td></tr><tr><td data-num=\"105\"></td><td><pre>\t\t<span class=\"token comment\">//if (</span></pre></td></tr><tr><td data-num=\"106\"></td><td><pre>\t\t<span class=\"token comment\">//\t(S1 == pShellcode[0])</span></pre></td></tr><tr><td data-num=\"107\"></td><td><pre>\t\t<span class=\"token comment\">//\t&amp;&amp;</span></pre></td></tr><tr><td data-num=\"108\"></td><td><pre>\t\t<span class=\"token comment\">//\t(S2 == pShellcode[1])</span></pre></td></tr><tr><td data-num=\"109\"></td><td><pre>\t\t<span class=\"token comment\">//\t&amp;&amp;</span></pre></td></tr><tr><td data-num=\"110\"></td><td><pre>\t\t<span class=\"token comment\">//\t(S3 == pShellcode[2])</span></pre></td></tr><tr><td data-num=\"111\"></td><td><pre>\t\t<span class=\"token comment\">//\t&amp;&amp;</span></pre></td></tr><tr><td data-num=\"112\"></td><td><pre>\t\t<span class=\"token comment\">//\t(S4 == pShellcode[3])</span></pre></td></tr><tr><td data-num=\"113\"></td><td><pre>\t\t<span class=\"token comment\">//\t&amp;&amp;</span></pre></td></tr><tr><td data-num=\"114\"></td><td><pre>\t\t<span class=\"token comment\">//\t(S5 == pShellcode[4])</span></pre></td></tr><tr><td data-num=\"115\"></td><td><pre>\t\t<span class=\"token comment\">//\t)</span></pre></td></tr><tr><td data-num=\"116\"></td><td><pre>\t\t<span class=\"token punctuation\">&#123;</span>\t\t</pre></td></tr><tr><td data-num=\"117\"></td><td><pre>\t\t\t<span class=\"token keyword\">return</span> Tmp<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"118\"></td><td><pre>\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"119\"></td><td><pre>\t\t<span class=\"token keyword\">else</span></pre></td></tr><tr><td data-num=\"120\"></td><td><pre>\t\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"121\"></td><td><pre>\t\t\t<span class=\"token keyword\">continue</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"122\"></td><td><pre>\t\t<span class=\"token punctuation\">&#125;</span>\t\t</pre></td></tr><tr><td data-num=\"123\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"124\"></td><td><pre>\t<span class=\"token keyword\">return</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"125\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"126\"></td><td><pre></pre></td></tr><tr><td data-num=\"127\"></td><td><pre>NTSTATUS <span class=\"token function\">DriverEntry</span><span class=\"token punctuation\">(</span>PDRIVER_OBJECT pdriver<span class=\"token punctuation\">,</span> PUNICODE_STRING reg_path<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"128\"></td><td><pre>\t<span class=\"token function\">DbgPrint</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"我是驱动，我加载了！\\n\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"129\"></td><td><pre>\tpdriver<span class=\"token operator\">-></span>DriverUnload <span class=\"token operator\">=</span> DriverUnload<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"130\"></td><td><pre>\t<span class=\"token comment\">// 内核基址</span></pre></td></tr><tr><td data-num=\"131\"></td><td><pre>\tPVOID pKrnlBase\t\t\t<span class=\"token operator\">=</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"132\"></td><td><pre>\t<span class=\"token comment\">// 内核基址的大小</span></pre></td></tr><tr><td data-num=\"133\"></td><td><pre>\tUINT32 uKrnlImageSize\t<span class=\"token operator\">=</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">;</span> </pre></td></tr><tr><td data-num=\"134\"></td><td><pre></pre></td></tr><tr><td data-num=\"135\"></td><td><pre>\t<span class=\"token comment\">// 申请一块内存，我只是为了方便传递参数</span></pre></td></tr><tr><td data-num=\"136\"></td><td><pre>\tPUINT32 pShellCode\t\t<span class=\"token operator\">=</span> <span class=\"token function\">ExAllocatePoolWithTag</span><span class=\"token punctuation\">(</span>NonPagedPool<span class=\"token punctuation\">,</span> <span class=\"token number\">20</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"ShellCode\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"137\"></td><td><pre>\t<span class=\"token comment\">// 函数 PspTerminateProcess 开头对应的硬编码</span></pre></td></tr><tr><td data-num=\"138\"></td><td><pre>\tpShellCode<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span>\t\t\t<span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>UINT32<span class=\"token punctuation\">)</span><span class=\"token number\">0x8b55ff8b</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"139\"></td><td><pre>\t<span class=\"token comment\">// 相对函数开头偏移 0X0C 个字节后对应的硬编码</span></pre></td></tr><tr><td data-num=\"140\"></td><td><pre>\tpShellCode<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span>\t\t\t<span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>UINT32<span class=\"token punctuation\">)</span><span class=\"token number\">0x3b08758b</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"141\"></td><td><pre>\t<span class=\"token comment\">// 相对函数开头偏移 0X22 个字节后对应的硬编码</span></pre></td></tr><tr><td data-num=\"142\"></td><td><pre>\t<span class=\"token operator\">*</span><span class=\"token punctuation\">(</span>pShellCode <span class=\"token operator\">+</span> <span class=\"token number\">2</span><span class=\"token punctuation\">)</span>\t\t<span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>UINT32<span class=\"token punctuation\">)</span><span class=\"token number\">0x200147f6</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"143\"></td><td><pre>\t<span class=\"token comment\">// 相对函数开头偏移 0X48 个字节后对应的硬编码</span></pre></td></tr><tr><td data-num=\"144\"></td><td><pre>\t<span class=\"token operator\">*</span><span class=\"token punctuation\">(</span>pShellCode <span class=\"token operator\">+</span> <span class=\"token number\">3</span><span class=\"token punctuation\">)</span>\t\t<span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>UINT32<span class=\"token punctuation\">)</span><span class=\"token number\">0xff85f88b</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"145\"></td><td><pre>\t<span class=\"token comment\">// 相对函数开头偏移 0X6A 个字节后对应的硬编码</span></pre></td></tr><tr><td data-num=\"146\"></td><td><pre>\t<span class=\"token operator\">*</span><span class=\"token punctuation\">(</span>pShellCode <span class=\"token operator\">+</span> <span class=\"token number\">4</span><span class=\"token punctuation\">)</span>\t    <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>UINT32<span class=\"token punctuation\">)</span><span class=\"token number\">0xe8560674</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"147\"></td><td><pre></pre></td></tr><tr><td data-num=\"148\"></td><td><pre>\t<span class=\"token comment\">// 获取内核基址和大小</span></pre></td></tr><tr><td data-num=\"149\"></td><td><pre>\t<span class=\"token function\">GetKernelBase</span><span class=\"token punctuation\">(</span>pdriver<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>pKrnlBase<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>uKrnlImageSize<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"150\"></td><td><pre></pre></td></tr><tr><td data-num=\"151\"></td><td><pre>\t<span class=\"token comment\">// 遍历内核内存定位未导出函数</span></pre></td></tr><tr><td data-num=\"152\"></td><td><pre>\t PVOID p <span class=\"token operator\">=</span> <span class=\"token function\">GetUndocumentFunctionAddress</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>PUCHAR<span class=\"token punctuation\">)</span>pKrnlBase<span class=\"token punctuation\">,</span> pShellCode<span class=\"token punctuation\">,</span> uKrnlImageSize<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"153\"></td><td><pre>\t <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>p <span class=\"token operator\">!=</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"154\"></td><td><pre>\t <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"155\"></td><td><pre>\t\t <span class=\"token function\">DbgPrint</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"成功找到函数首地址：%x\\n\"</span><span class=\"token punctuation\">,</span> p<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"156\"></td><td><pre>\t\t <span class=\"token function\">DbgPrint</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"开始尝试调用函数...\\n\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"157\"></td><td><pre></pre></td></tr><tr><td data-num=\"158\"></td><td><pre>\t\t <span class=\"token comment\">/****** 调用 PspTerminateProcess (IN PEPROCESS Process, IN NTSTATUS ExitStatus) 函数 ******/</span></pre></td></tr><tr><td data-num=\"159\"></td><td><pre>\t\t PEPROCESS hProcess<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"160\"></td><td><pre>\t\t <span class=\"token function\">PsLookupProcessByProcessId</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>HANDLE<span class=\"token punctuation\">)</span><span class=\"token number\">224</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>hProcess<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"161\"></td><td><pre>\t\t PspTerminateProcess <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>_PspTerminateProcess<span class=\"token punctuation\">)</span>p<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"162\"></td><td><pre>\t\t <span class=\"token function\">PspTerminateProcess</span><span class=\"token punctuation\">(</span>hProcess<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"163\"></td><td><pre>\t\t <span class=\"token comment\">/****** 调用 PspTerminateProcess (IN PEPROCESS Process, IN NTSTATUS ExitStatus) 函数 ******/</span></pre></td></tr><tr><td data-num=\"164\"></td><td><pre></pre></td></tr><tr><td data-num=\"165\"></td><td><pre>\t\t <span class=\"token function\">DbgPrint</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"函数调用结束.\\n\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"166\"></td><td><pre>\t <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"167\"></td><td><pre>\t <span class=\"token keyword\">else</span></pre></td></tr><tr><td data-num=\"168\"></td><td><pre>\t\t <span class=\"token function\">DbgPrint</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"查找失败！\\n\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"169\"></td><td><pre></pre></td></tr><tr><td data-num=\"170\"></td><td><pre>\t <span class=\"token keyword\">return</span> STATUS_SUCCESS<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"171\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p><img data-src=\"image008.png\" alt=\"\" /></p>\n<p>编程的过程中碰到不少非常离谱的事情，简直称得上玄学！编译执行了好几遍都蓝屏，于是就去问别人，问了一堆人都说没问题，调试了半个小时，还是原来的代码又重新编译执行了一遍竟然可以运行了？？？？？？</p>\n<h1 id=\"reference\"><a class=\"anchor\" href=\"#reference\">#</a> Reference</h1>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L0t3YW5zeS9hcnRpY2xlL2RldGFpbHMvMTA5MTQ1MTEw\">https://blog.csdn.net/Kwansy/article/details/109145110</span><br />\n<span class=\"exturl\" data-url=\"aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQxOTg4NDQ4L2FydGljbGUvZGV0YWlscy8xMDM1MTQwMDc=\">https://blog.csdn.net/qq_41988448/article/details/103514007</span></p>\n",
            "tags": [
                "内核空间",
                "内核模块",
                "遍历内核模块",
                "定位未导出函数PspTiminateProcess"
            ]
        },
        {
            "id": "https://or0kit.github.io/Bin/Core/Drive-Development/%E9%A9%B1%E5%8A%A8%E5%BC%80%E5%8F%91-%E5%86%85%E6%A0%B8%E7%BC%96%E7%A8%8B%E5%9F%BA%E7%A1%80/",
            "url": "https://or0kit.github.io/Bin/Core/Drive-Development/%E9%A9%B1%E5%8A%A8%E5%BC%80%E5%8F%91-%E5%86%85%E6%A0%B8%E7%BC%96%E7%A8%8B%E5%9F%BA%E7%A1%80/",
            "title": "驱动开发-内核编程基础",
            "date_published": "2021-09-03T14:52:35.000Z",
            "content_html": "<h1 id=\"未文档化函数-未导出函数\"><a class=\"anchor\" href=\"#未文档化函数-未导出函数\">#</a> 未文档化函数、未导出函数</h1>\n<p>未文档化就是 WDK 文档里搜不到，但是在导出表里的函数，要使用这种函数可以使用 GetProcAddress 函数获取函数地址；</p>\n<p>未导出函数就是不在导出表的函数，可以通过<strong>特征码</strong>搜索或者<strong>解析内核 PDB</strong> 的方式找到函数地址，通过函数指针调用。</p>\n<h1 id=\"wdk数据类型\"><a class=\"anchor\" href=\"#wdk数据类型\">#</a> WDK 数据类型</h1>\n<p>WDK 数据类型在 ntdef.h 中定义，下面列举部分，注意，并没有 UINT</p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">typedef</span> <span class=\"token keyword\">unsigned</span> <span class=\"token keyword\">char</span> UCHAR<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">typedef</span> <span class=\"token keyword\">unsigned</span> <span class=\"token keyword\">short</span> USHORT<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">typedef</span> <span class=\"token keyword\">unsigned</span> <span class=\"token keyword\">long</span> ULONG<span class=\"token punctuation\">;</span></pre></td></tr></table></figure><h1 id=\"ntstatus-返回值\"><a class=\"anchor\" href=\"#ntstatus-返回值\">#</a> NTSTATUS 返回值</h1>\n<p>很多内核函数的返回值都是 NTSTATUS，这是一个 4 字节整型。<br />\n例如：</p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>STATUS_SUCCESS\t\t<span class=\"token number\">0x00000000</span>\t成功</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>STATUS_INVALID_PARAMETER\t<span class=\"token number\">0xC000000D</span>\t参数无效</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>STATUS_BUFFER_OVERFLOW\t<span class=\"token number\">0x80000005</span>\t缓冲区长度不够</pre></td></tr></table></figure><h1 id=\"内核异常处理\"><a class=\"anchor\" href=\"#内核异常处理\">#</a> 内核异常处理</h1>\n<p>在内核中，一个小小的错误就可能导致蓝屏，比如：读写一个无效的内存地址。为了让自己的内核程序更加健壮，强烈建议大家在编写内核程序时，使用异常处。<br />\nWindows 提供了结构化异常处理机制，一般的编译器都是支持的，如下：</p>\n<pre><code>__try&#123;\n\t//可能出错的代码\n&#125;\n__except(filter_value) &#123;\n\t//出错时要执行的代码\n&#125;\n</code></pre>\n<p>出现异常时，可根据 filter_value 的值来决定程序该如果执行，当 filter_value 的值为：<br />\n <code>EXCEPTION_EXECUTE_HANDLER(1)</code> ，代码进入 except 块<br />\n <code>EXCEPTION_CONTINUE_SEARCH(0)</code> ，不处理异常，由上一层调用函数处理<br />\n <code>EXCEPTION_CONTINUE_EXECUTION(-1)</code> ，回去继续执行错误处的代码</p>\n<p>在火哥的视频中，火哥说加了这玩意该蓝屏还是蓝屏…… 试了试确实……。</p>\n<p>演示代码：</p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span><span class=\"token string\">&lt;ntddk.h></span></span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>VOID <span class=\"token function\">DriverUnload</span><span class=\"token punctuation\">(</span>PDRIVER_OBJECT pdriver<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>\t<span class=\"token function\">DbgPrint</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"我是驱动，我卸载了\\n\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>NTSTATUS <span class=\"token function\">DriverEntry</span><span class=\"token punctuation\">(</span>PDRIVER_OBJECT pdriver<span class=\"token punctuation\">,</span> PUNICODE_STRING pReg<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\t__try</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>\t\tPULONG ptr <span class=\"token operator\">=</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>\t\t<span class=\"token operator\">*</span>ptr <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>\t<span class=\"token function\">__except</span> <span class=\"token punctuation\">(</span>EXCEPTION_EXECUTE_HANDLER<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>\t\t<span class=\"token function\">DbgPrint</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"非法访问内存.\\r\\n\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>\tpdriver<span class=\"token operator\">-></span>DriverUnload <span class=\"token operator\">=</span> DriverUnload<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>\t<span class=\"token keyword\">return</span> STATUS_SUCCESS<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p><img data-src=\"image001.png\" alt=\"\" /></p>\n<h1 id=\"常用的内核内存函数\"><a class=\"anchor\" href=\"#常用的内核内存函数\">#</a> 常用的内核内存函数</h1>\n<table>\n<thead>\n<tr>\n<th>C 语言</th>\n<th>内核</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>malloc</td>\n<td>ExAllocatePool</td>\n</tr>\n<tr>\n<td>memset</td>\n<td>RtlFillMemory</td>\n</tr>\n<tr>\n<td>memcpy</td>\n<td>RtlMoveMemory</td>\n</tr>\n<tr>\n<td>free</td>\n<td>ExFreePool</td>\n</tr>\n</tbody>\n</table>\n<h1 id=\"内核字符串及常用字符串函数\"><a class=\"anchor\" href=\"#内核字符串及常用字符串函数\">#</a> 内核字符串及常用字符串函数</h1>\n<p>为了提高安全性，内核中的字符串不再是字符串首地址指针作为开始，0 作为结尾，而是采用了以下两个结构体：</p>\n<p><strong>ANSI_STRING 字符串：</strong></p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">typedef</span> <span class=\"token keyword\">struct</span> <span class=\"token class-name\">_STRING</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    USHORT Length<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    USHORT MaximumLength<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    PCHAR Buffer<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">&#125;</span>STRING<span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p><strong>UNICODE_STRING 字符串：</strong></p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">typedef</span> <span class=\"token keyword\">struct</span> <span class=\"token class-name\">_UNICODE_STRING</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    USHORT Length<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    USHORT MaxmumLength<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    PWSTR Buffer<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">&#125;</span> UNICODE_STRING<span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>下面的表格列出了常用的字符串函数：</p>\n<table>\n<thead>\n<tr>\n<th>功能</th>\n<th>ANSI_STRING 字符串</th>\n<th>UNICODE_STRING 字符串</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>创建</td>\n<td>RtlInitAnsiString</td>\n<td>RtlInitUnicodeString</td>\n</tr>\n<tr>\n<td>复制</td>\n<td>RtlCopyString</td>\n<td>RtlCopyUnicodeString</td>\n</tr>\n<tr>\n<td>比较</td>\n<td>RtlCompareString</td>\n<td>RtlCompareUnicoodeString</td>\n</tr>\n<tr>\n<td>转换</td>\n<td>RtlAnsiStringToUnicodeString</td>\n<td>RtlUnicodeStringToAnsiString</td>\n</tr>\n</tbody>\n</table>\n<h1 id=\"课后练习\"><a class=\"anchor\" href=\"#课后练习\">#</a> 课后练习</h1>\n<ol>\n<li>\n<p>申请一块内存，并在内存中存储 GDT、IDT 的所有数据。然后在 debugview 中显示出来，最后释放内存。</p>\n</li>\n<li>\n<p>编写代码，实现如下功能：</p>\n</li>\n</ol>\n<blockquote>\n<p>初始化一个字符串（）<br />\n拷贝一个字符串<br />\n比较两个字符串是否相等<br />\n ANSI_STRING 与 UNICODE_STRING 字符串相互转换</p>\n</blockquote>\n<h2 id=\"第1题\"><a class=\"anchor\" href=\"#第1题\">#</a> 第 1 题</h2>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;ntddk.h></span></span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;ntdef.h></span></span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token comment\">// 卸载函数</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>VOID <span class=\"token function\">DriverUnload</span><span class=\"token punctuation\">(</span>PDRIVER_OBJECT pdriver<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>\t<span class=\"token function\">DbgPrint</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"驱动程序停止运行了.\\r\\n\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token comment\">// 入口函数，相当于 main</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>NTSTATUS <span class=\"token function\">DriverEntry</span><span class=\"token punctuation\">(</span>PDRIVER_OBJECT pdriver<span class=\"token punctuation\">,</span> PUNICODE_STRING pRegPath<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>\tUCHAR GDT<span class=\"token punctuation\">[</span><span class=\"token number\">6</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> IDT<span class=\"token punctuation\">[</span><span class=\"token number\">6</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>\tULONG GDTAddr<span class=\"token punctuation\">,</span> IDTAddr<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>\tUSHORT GDTLen<span class=\"token punctuation\">,</span> IDTLen<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>\tPULONG pbuffer<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>\tULONG i<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>\t__asm <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>\t\tsgdt GDT<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>\t\tsidt IDT<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>\tGDTAddr <span class=\"token operator\">=</span> <span class=\"token operator\">*</span><span class=\"token punctuation\">(</span>PULONG<span class=\"token punctuation\">)</span><span class=\"token operator\">&amp;</span>GDT<span class=\"token punctuation\">[</span><span class=\"token number\">2</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>\t<span class=\"token comment\">//GDTAddr = *(PULONG)(GDT+2);</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>\tGDTLen <span class=\"token operator\">=</span> <span class=\"token operator\">*</span><span class=\"token punctuation\">(</span>PUSHORT<span class=\"token punctuation\">)</span><span class=\"token operator\">&amp;</span>GDT<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>\tIDTAddr <span class=\"token operator\">=</span> <span class=\"token operator\">*</span><span class=\"token punctuation\">(</span>PULONG<span class=\"token punctuation\">)</span><span class=\"token operator\">&amp;</span>IDT<span class=\"token punctuation\">[</span><span class=\"token number\">2</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>\tIDTLen <span class=\"token operator\">=</span> <span class=\"token operator\">*</span><span class=\"token punctuation\">(</span>PUSHORT<span class=\"token punctuation\">)</span><span class=\"token operator\">&amp;</span>IDT<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>\t<span class=\"token function\">DbgPrint</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"GDTAddr:%#010X,GDTLen:%#06X\\n\"</span><span class=\"token punctuation\">,</span> GDTAddr<span class=\"token punctuation\">,</span> GDTLen<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>\t<span class=\"token function\">DbgPrint</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"IDTAddr:%#010X,IDTLen:%#06X\\n\"</span><span class=\"token punctuation\">,</span> IDTAddr<span class=\"token punctuation\">,</span> IDTLen<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>\tpbuffer <span class=\"token operator\">=</span> <span class=\"token function\">ExAllocatePoolWithTag</span><span class=\"token punctuation\">(</span>NonPagedPool<span class=\"token punctuation\">,</span> GDTLen<span class=\"token punctuation\">,</span> <span class=\"token string\">\"MemGdt\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>pbuffer <span class=\"token operator\">==</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>\t\t<span class=\"token function\">DbgPrint</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"申请内存失败1\\n\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>\t\t<span class=\"token keyword\">return</span> STATUS_UNSUCCESSFUL<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>\t<span class=\"token function\">RtlMoveMemory</span><span class=\"token punctuation\">(</span>pbuffer<span class=\"token punctuation\">,</span> GDTAddr<span class=\"token punctuation\">,</span> GDTLen<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre></pre></td></tr><tr><td data-num=\"43\"></td><td><pre></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>\t<span class=\"token function\">DbgPrint</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"在新开辟的内存%p中打印GDT\\n\"</span><span class=\"token punctuation\">,</span> pbuffer<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>\t<span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span> i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> GDTLen<span class=\"token punctuation\">;</span> i<span class=\"token operator\">+=</span><span class=\"token number\">16</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>\t\t<span class=\"token function\">DbgPrint</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"%08X %08X %08X %08X %08X\\n\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>\t\t\tpbuffer <span class=\"token operator\">+</span> i<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>\t\t\t<span class=\"token operator\">*</span><span class=\"token punctuation\">(</span>PULONG<span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span>pbuffer <span class=\"token operator\">+</span> i<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>\t\t\t<span class=\"token operator\">*</span><span class=\"token punctuation\">(</span>PULONG<span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span>pbuffer <span class=\"token operator\">+</span> i <span class=\"token operator\">+</span> <span class=\"token number\">4</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre>\t\t\t<span class=\"token operator\">*</span><span class=\"token punctuation\">(</span>PULONG<span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span>pbuffer <span class=\"token operator\">+</span> i <span class=\"token operator\">+</span> <span class=\"token number\">8</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>\t\t\t<span class=\"token operator\">*</span><span class=\"token punctuation\">(</span>PULONG<span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span>pbuffer <span class=\"token operator\">+</span> i <span class=\"token operator\">+</span> <span class=\"token number\">12</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>\t<span class=\"token function\">ExFreePoolWithTag</span><span class=\"token punctuation\">(</span>pbuffer<span class=\"token punctuation\">,</span> <span class=\"token string\">\"MemGdt\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre></pre></td></tr><tr><td data-num=\"58\"></td><td><pre>\tpbuffer <span class=\"token operator\">=</span> <span class=\"token function\">ExAllocatePoolWithTag</span><span class=\"token punctuation\">(</span>NonPagedPool<span class=\"token punctuation\">,</span> IDTLen<span class=\"token punctuation\">,</span> <span class=\"token string\">\"MemIdt\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"59\"></td><td><pre></pre></td></tr><tr><td data-num=\"60\"></td><td><pre>\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>pbuffer <span class=\"token operator\">==</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"61\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"62\"></td><td><pre>\t\t<span class=\"token function\">DbgPrint</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"申请内存失败2\\n\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"63\"></td><td><pre>\t\t<span class=\"token keyword\">return</span> STATUS_UNSUCCESSFUL<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"64\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"65\"></td><td><pre></pre></td></tr><tr><td data-num=\"66\"></td><td><pre>\t<span class=\"token function\">RtlMoveMemory</span><span class=\"token punctuation\">(</span>pbuffer<span class=\"token punctuation\">,</span> GDTAddr<span class=\"token punctuation\">,</span> GDTLen<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"67\"></td><td><pre></pre></td></tr><tr><td data-num=\"68\"></td><td><pre></pre></td></tr><tr><td data-num=\"69\"></td><td><pre>\t<span class=\"token function\">DbgPrint</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"在新开辟的内存%p中打印IDT\\n\"</span><span class=\"token punctuation\">,</span> pbuffer<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"70\"></td><td><pre></pre></td></tr><tr><td data-num=\"71\"></td><td><pre>\t<span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span>i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> GDTLen<span class=\"token punctuation\">;</span> i <span class=\"token operator\">+=</span> <span class=\"token number\">16</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"72\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"73\"></td><td><pre>\t\t<span class=\"token function\">DbgPrint</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"%08X %08X %08X %08X %08X\\n\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"74\"></td><td><pre>\t\t\tpbuffer <span class=\"token operator\">+</span> i<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"75\"></td><td><pre>\t\t\t<span class=\"token operator\">*</span><span class=\"token punctuation\">(</span>PULONG<span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span>pbuffer <span class=\"token operator\">+</span> i<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"76\"></td><td><pre>\t\t\t<span class=\"token operator\">*</span><span class=\"token punctuation\">(</span>PULONG<span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span>pbuffer <span class=\"token operator\">+</span> i <span class=\"token operator\">+</span> <span class=\"token number\">4</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"77\"></td><td><pre>\t\t\t<span class=\"token operator\">*</span><span class=\"token punctuation\">(</span>PULONG<span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span>pbuffer <span class=\"token operator\">+</span> i <span class=\"token operator\">+</span> <span class=\"token number\">8</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"78\"></td><td><pre>\t\t\t<span class=\"token operator\">*</span><span class=\"token punctuation\">(</span>PULONG<span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span>pbuffer <span class=\"token operator\">+</span> i <span class=\"token operator\">+</span> <span class=\"token number\">12</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"79\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"80\"></td><td><pre></pre></td></tr><tr><td data-num=\"81\"></td><td><pre>\t<span class=\"token function\">ExFreePoolWithTag</span><span class=\"token punctuation\">(</span>pbuffer<span class=\"token punctuation\">,</span> <span class=\"token string\">\"MemGdt\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"82\"></td><td><pre></pre></td></tr><tr><td data-num=\"83\"></td><td><pre>\tpdriver<span class=\"token operator\">-></span>DriverUnload <span class=\"token operator\">=</span> DriverUnload<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"84\"></td><td><pre></pre></td></tr><tr><td data-num=\"85\"></td><td><pre>\t<span class=\"token keyword\">return</span> STATUS_SUCCESS<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"86\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p><img data-src=\"image002.png\" alt=\"\" /></p>\n<h2 id=\"第2题\"><a class=\"anchor\" href=\"#第2题\">#</a> 第 2 题</h2>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span><span class=\"token string\">&lt;ntddk.h></span></span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;ntdef.h></span></span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>VOID <span class=\"token function\">DriverUnload</span><span class=\"token punctuation\">(</span>PDRIVER_OBJECT pdriver<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>\t<span class=\"token function\">DbgPrint</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"驱动程序停止运行了\\n\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>NTSTATUS <span class=\"token function\">DriverEntry</span><span class=\"token punctuation\">(</span>PDRIVER_OBJECT pdriver<span class=\"token punctuation\">,</span> PUNICODE_STRING pReg<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>\tANSI_STRING AnsiString1<span class=\"token punctuation\">,</span> AnsiString2<span class=\"token punctuation\">,</span> AnsiString3<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>\tUNICODE_STRING UnicodeString1<span class=\"token punctuation\">,</span> UnicodeString2<span class=\"token punctuation\">,</span> UnicodeString3<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>\tCHAR Buf1<span class=\"token punctuation\">[</span><span class=\"token number\">256</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> Buf2<span class=\"token punctuation\">[</span><span class=\"token number\">256</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>\tWCHAR wcBuf1<span class=\"token punctuation\">[</span><span class=\"token number\">256</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> wcBuf2<span class=\"token punctuation\">[</span><span class=\"token number\">256</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>\t<span class=\"token comment\">// 初始化字符串</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>\t<span class=\"token function\">RtlInitAnsiString</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>AnsiString1<span class=\"token punctuation\">,</span> <span class=\"token string\">\"This is AnsiString1\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>\t<span class=\"token function\">RtlInitUnicodeString</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>UnicodeString1<span class=\"token punctuation\">,</span> L<span class=\"token string\">\"This is UnicodeString1\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>\t<span class=\"token function\">RtlInitEmptyAnsiString</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>AnsiString2<span class=\"token punctuation\">,</span> Buf1<span class=\"token punctuation\">,</span> <span class=\"token number\">256</span> <span class=\"token operator\">*</span> <span class=\"token keyword\">sizeof</span><span class=\"token punctuation\">(</span>CHAR<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>\t<span class=\"token function\">RtlInitEmptyAnsiString</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>AnsiString3<span class=\"token punctuation\">,</span> Buf2<span class=\"token punctuation\">,</span> <span class=\"token number\">256</span> <span class=\"token operator\">*</span> <span class=\"token keyword\">sizeof</span><span class=\"token punctuation\">(</span>CHAR<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>\t<span class=\"token function\">RtlInitEmptyUnicodeString</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>UnicodeString2<span class=\"token punctuation\">,</span> wcBuf1<span class=\"token punctuation\">,</span> <span class=\"token number\">256</span> <span class=\"token operator\">*</span> <span class=\"token keyword\">sizeof</span><span class=\"token punctuation\">(</span>WCHAR<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>\t<span class=\"token function\">RtlInitEmptyUnicodeString</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>UnicodeString3<span class=\"token punctuation\">,</span> wcBuf2<span class=\"token punctuation\">,</span> <span class=\"token number\">256</span> <span class=\"token operator\">*</span> <span class=\"token keyword\">sizeof</span><span class=\"token punctuation\">(</span>WCHAR<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>\t<span class=\"token function\">DbgPrint</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"打印AnsiString1。 Buffer:%s Length:%d MaximumLength:%d\\n\"</span><span class=\"token punctuation\">,</span> AnsiString1<span class=\"token punctuation\">.</span>Buffer<span class=\"token punctuation\">,</span> AnsiString1<span class=\"token punctuation\">.</span>Length<span class=\"token punctuation\">,</span> AnsiString1<span class=\"token punctuation\">.</span>MaximumLength<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>\t<span class=\"token function\">DbgPrint</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"打印UnicodeString1。 \\nBuffer:%ws \\nLength:%d \\nMaximumLength:%d\\n\"</span><span class=\"token punctuation\">,</span> UnicodeString1<span class=\"token punctuation\">.</span>Buffer<span class=\"token punctuation\">,</span> UnicodeString1<span class=\"token punctuation\">.</span>Length<span class=\"token punctuation\">,</span> UnicodeString1<span class=\"token punctuation\">.</span>MaximumLength<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"29\"></td><td><pre>\t<span class=\"token comment\">// 拷贝字符串</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>\t<span class=\"token function\">RtlCopyString</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>AnsiString2<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>AnsiString1<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>\t<span class=\"token function\">RtlCopyUnicodeString</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>UnicodeString2<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>UnicodeString1<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"33\"></td><td><pre>\t<span class=\"token function\">DbgPrint</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"打印AnsiString2。Buffer:%s Length:%d MaximumLength:%d\\n\"</span><span class=\"token punctuation\">,</span> AnsiString2<span class=\"token punctuation\">.</span>Buffer<span class=\"token punctuation\">,</span> AnsiString2<span class=\"token punctuation\">.</span>Length<span class=\"token punctuation\">,</span> AnsiString2<span class=\"token punctuation\">.</span>MaximumLength<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>\t<span class=\"token function\">DbgPrint</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"打印UnicodeString2。\\nBuffer:%ws \\nLength：%d \\nMaximumLength:%d\\n\"</span><span class=\"token punctuation\">,</span> UnicodeString2<span class=\"token punctuation\">.</span>Buffer<span class=\"token punctuation\">,</span> UnicodeString2<span class=\"token punctuation\">.</span>Length<span class=\"token punctuation\">,</span> UnicodeString2<span class=\"token punctuation\">.</span>MaximumLength<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"36\"></td><td><pre>\t<span class=\"token comment\">// 比较字符串</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">RtlCompareString</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>AnsiString1<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>AnsiString2<span class=\"token punctuation\">,</span> TRUE<span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>\t\t<span class=\"token function\">DbgPrint</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"AnsiString1与AnsiString2相等\\n\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>\t<span class=\"token keyword\">else</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>\t\t<span class=\"token function\">DbgPrint</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"AnsiString1与AnsiString2不相等\\n\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">RtlCompareUnicodeString</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>UnicodeString1<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>UnicodeString2<span class=\"token punctuation\">,</span> TRUE<span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>\t\t<span class=\"token function\">DbgPrint</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"UnicodeString1与UnicodeString2相等\\n\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>\t<span class=\"token keyword\">else</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>\t\t<span class=\"token function\">DbgPrint</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"UnicodeString1与UnicodeString2不相等\\n\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>\t<span class=\"token comment\">// 转化字符串</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre>\t<span class=\"token function\">RtlAnsiStringToUnicodeString</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>UnicodeString3<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>AnsiString1<span class=\"token punctuation\">,</span> TRUE<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>\t<span class=\"token function\">RtlUnicodeStringToAnsiString</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>AnsiString3<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span> UnicodeString1<span class=\"token punctuation\">,</span> TRUE<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre></pre></td></tr><tr><td data-num=\"55\"></td><td><pre>\t<span class=\"token function\">DbgPrint</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"打印AnsiString3。Buffer:%s Length:%d MaximumLength:%d\\n\"</span><span class=\"token punctuation\">,</span> AnsiString3<span class=\"token punctuation\">.</span>Buffer<span class=\"token punctuation\">,</span> AnsiString3<span class=\"token punctuation\">.</span>Length<span class=\"token punctuation\">,</span> AnsiString3<span class=\"token punctuation\">.</span>MaximumLength<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>\t<span class=\"token function\">DbgPrint</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"打印UnicodeString3。\\nBuffer:%ws \\nLength：%d \\nMaximumLength:%d\\n\"</span><span class=\"token punctuation\">,</span> UnicodeString3<span class=\"token punctuation\">.</span>Buffer<span class=\"token punctuation\">,</span> UnicodeString3<span class=\"token punctuation\">.</span>Length<span class=\"token punctuation\">,</span> UnicodeString3<span class=\"token punctuation\">.</span>MaximumLength<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"58\"></td><td><pre>\tpdriver<span class=\"token operator\">-></span>DriverUnload <span class=\"token operator\">=</span> DriverUnload<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"59\"></td><td><pre></pre></td></tr><tr><td data-num=\"60\"></td><td><pre>\t<span class=\"token keyword\">return</span> STATUS_SUCCESS<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"61\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p><img data-src=\"image003.png\" alt=\"\" /></p>\n",
            "tags": [
                "内核编程基础",
                "ANSI_STRING",
                "UNICODE_STRING",
                "内核内存"
            ]
        },
        {
            "id": "https://or0kit.github.io/Bin/Core/Drive-Development/%E9%A9%B1%E5%8A%A8%E5%BC%80%E5%8F%91-%E8%B0%83%E8%AF%95%E9%A9%B1%E5%8A%A8%E7%A8%8B%E5%BA%8F/",
            "url": "https://or0kit.github.io/Bin/Core/Drive-Development/%E9%A9%B1%E5%8A%A8%E5%BC%80%E5%8F%91-%E8%B0%83%E8%AF%95%E9%A9%B1%E5%8A%A8%E7%A8%8B%E5%BA%8F/",
            "title": "驱动开发-调试驱动程序",
            "date_published": "2021-09-03T14:52:10.000Z",
            "content_html": "<h1 id=\"代码\"><a class=\"anchor\" href=\"#代码\">#</a> 代码</h1>\n<p>在驱动代码中加入汇编指令  <code>int 3</code>  ，这样 windbg 就会接管中断异常，就可以进行调试了。但在 x64 的驱动中不能这样写。</p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span><span class=\"token string\">&lt;ntddk.h></span></span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>VOID <span class=\"token function\">DriverUnload</span><span class=\"token punctuation\">(</span>PDRIVER_OBJECT pdriver<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>\t<span class=\"token function\">DbgPrint</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"我是驱动，我卸载了\\n\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>NTSTATUS <span class=\"token function\">DriverEntry</span><span class=\"token punctuation\">(</span>PDRIVER_OBJECT pdriver<span class=\"token punctuation\">,</span> PUNICODE_STRING pReg<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\t__asm <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\t\t<span class=\"token keyword\">int</span> <span class=\"token number\">3</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>\t\tmov eax<span class=\"token punctuation\">,</span> eax<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>\t\tmov ecx<span class=\"token punctuation\">,</span> ecx<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>\t<span class=\"token function\">DbgPrint</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"我是驱动，我运行了\\n\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>\tpdriver<span class=\"token operator\">-></span>DriverUnload <span class=\"token operator\">=</span> DriverUnload<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>\t<span class=\"token keyword\">return</span> STATUS_SUCCESS<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>多了一个源代码窗口。</p>\n<p><img data-src=\"image001.png\" alt=\"\" /></p>\n",
            "tags": [
                "调试驱动程序"
            ]
        },
        {
            "id": "https://or0kit.github.io/Bin/Core/Drive-Development/%E9%A9%B1%E5%8A%A8%E5%BC%80%E5%8F%91-%E7%AC%AC%E4%B8%80%E4%B8%AA%E9%A9%B1%E5%8A%A8%E7%A8%8B%E5%BA%8F/",
            "url": "https://or0kit.github.io/Bin/Core/Drive-Development/%E9%A9%B1%E5%8A%A8%E5%BC%80%E5%8F%91-%E7%AC%AC%E4%B8%80%E4%B8%AA%E9%A9%B1%E5%8A%A8%E7%A8%8B%E5%BA%8F/",
            "title": "驱动开发-第一个驱动程序",
            "date_published": "2021-09-03T14:52:00.000Z",
            "content_html": "<h1 id=\"配置vs2019wdk10\"><a class=\"anchor\" href=\"#配置vs2019wdk10\">#</a> 配置 VS2019+WDK10</h1>\n<p>参见：<span class=\"exturl\" data-url=\"aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L20wXzQ4OTk1NjExL2FydGljbGUvZGV0YWlscy8xMTIxOTU0OTc=\">https://blog.csdn.net/m0_48995611/article/details/112195497</span></p>\n<h1 id=\"编写代码\"><a class=\"anchor\" href=\"#编写代码\">#</a> 编写代码</h1>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span><span class=\"token string\">&lt;ntddk.h></span></span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>VOID <span class=\"token function\">DriverUnload</span><span class=\"token punctuation\">(</span>PDRIVER_OBJECT pdriver<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>\t<span class=\"token function\">DbgPrint</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"我是驱动，我卸载了\\n\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>NTSTATUS <span class=\"token function\">DriverEntry</span><span class=\"token punctuation\">(</span>PDRIVER_OBJECT pdriver<span class=\"token punctuation\">,</span> PUNICODE_STRING pReg<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\t<span class=\"token function\">DbgPrint</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"我是驱动，我运行了\\n\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\tpdriver<span class=\"token operator\">-></span>DriverUnload <span class=\"token operator\">=</span> DriverUnload<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>\t<span class=\"token keyword\">return</span> STATUS_SUCCESS<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>注意用 release 版。<br />\nDbgView 设置</p>\n<p><img data-src=\"image001.png\" alt=\"\" /></p>\n<p>结果：</p>\n<p><img data-src=\"image002.png\" alt=\"\" /></p>\n",
            "tags": [
                "配置VS2019+WDK10",
                "第一个驱动程序"
            ]
        },
        {
            "id": "https://or0kit.github.io/Bin/Core/WindowsXp/Protect-Mode/%E4%BF%9D%E6%8A%A4%E6%A8%A1%E5%BC%8F-%E9%98%B6%E6%AE%B5%E6%B5%8B%E8%AF%95/",
            "url": "https://or0kit.github.io/Bin/Core/WindowsXp/Protect-Mode/%E4%BF%9D%E6%8A%A4%E6%A8%A1%E5%BC%8F-%E9%98%B6%E6%AE%B5%E6%B5%8B%E8%AF%95/",
            "title": "保护模式-阶段测试",
            "date_published": "2021-09-03T14:46:00.000Z",
            "content_html": "<h1 id=\"保护模式阶段测试\"><a class=\"anchor\" href=\"#保护模式阶段测试\">#</a> 保护模式阶段测试</h1>\n<ol>\n<li>\n<p>给定一个线性地址，和长度，读取内容；<br />\nint ReadMemory(OUT BYTE* buffer,IN DWORD dwAddr,IN DWORD dwLeght)<br />\n 要求：<br />\n1) 可以自己指定分页方式。<br />\n2) 页不存在，要提示，不能报错。<br />\n3) 可以正确读取数据。</p>\n</li>\n<li>\n<p>申请长度为 100 的 DWORD 的数组，且每项用该项的地址初始化；<br />\n把这个数组所在的物理页挂到 0x1000 的地址上；<br />\n 定义一个指针，指向 0x1000 这个页里的数组所在的地址，用 0x1000 这个页的线性地址打印出这数组的值；</p>\n</li>\n</ol>\n<p>要求：<br />\n数组所在的物理页，是同一个页；</p>\n<h2 id=\"第一题\"><a class=\"anchor\" href=\"#第一题\">#</a> 第一题</h2>\n<p><strong>所遇问题：</strong></p>\n<p>在运行程序时发现了一个问题，用 VC 6.0 编译 C 语言是 总是提示一个错误：error C2143: syntax error : missing ‘;’ before ‘type’。解决方法如下：把所有变量的声明放在可执行代码之前。</p>\n<p>出现此问题的原因在于：将文件保存成了 .c 格式。如果是 cpp 格式就能正常编译。改成.cpp 就可以正常运行，和你变量声明的位置就没有关系了。*</p>\n<p>一般在 ANSI C 或者 C++ 中，在可执行代码中随时定义变量是允许的，但是在 K&amp;R C 中是不允许的，因此才会出现这个错误。VC6.0 、VS2008 都是用的 K&amp;R C 来实现 C 语言的，因此编译过程中会报错。</p>\n<p><strong>代码：</strong></p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;stdio.h></span></span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;Windows.h></span></span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">DATALEN</span> <span class=\"token expression\"><span class=\"token number\">0x200</span></span></span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>DWORD somedata<span class=\"token punctuation\">[</span>DATALEN<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// 数据源</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>DWORD mybuff<span class=\"token punctuation\">[</span>DATALEN<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// 空白缓冲区</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token comment\">// 2-9-9-12 分页读内存，要判断线性地址有效性，要能正确处理跨页的情况</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>BOOL <span class=\"token function\">ReadMemory</span><span class=\"token punctuation\">(</span>OUT BYTE<span class=\"token operator\">*</span> buffer<span class=\"token punctuation\">,</span> IN DWORD dwAddr<span class=\"token punctuation\">,</span> IN DWORD dwLength<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>\tDWORD i<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>\t<span class=\"token comment\">//__asm int 3;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>\t<span class=\"token comment\">// 以字节为单位读取</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>\t<span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span>i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> dwLength<span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>\t\tDWORD PDE <span class=\"token operator\">=</span> <span class=\"token operator\">*</span><span class=\"token punctuation\">(</span>DWORD<span class=\"token operator\">*</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span><span class=\"token number\">0xc0600000</span> <span class=\"token operator\">+</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>dwAddr <span class=\"token operator\">+</span> i<span class=\"token punctuation\">)</span> <span class=\"token operator\">>></span> <span class=\"token number\">18</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;</span> <span class=\"token number\">0x3ff8</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>\t\tDWORD PTE <span class=\"token operator\">=</span> <span class=\"token operator\">*</span><span class=\"token punctuation\">(</span>DWORD<span class=\"token operator\">*</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span><span class=\"token number\">0xc0000000</span> <span class=\"token operator\">+</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>dwAddr <span class=\"token operator\">+</span> i<span class=\"token punctuation\">)</span> <span class=\"token operator\">>></span> <span class=\"token number\">9</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;</span> <span class=\"token number\">0x7ffff8</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>\t\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>PDE <span class=\"token operator\">&amp;</span> <span class=\"token number\">0x00000001</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token comment\">//&amp; 比 == 的运算级高</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>\t\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>\t\t\t<span class=\"token keyword\">return</span> FALSE<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>\t\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>PTE <span class=\"token operator\">&amp;</span> <span class=\"token number\">0x00000001</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> </pre></td></tr><tr><td data-num=\"27\"></td><td><pre>\t\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>\t\t\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>PTE <span class=\"token operator\">==</span> <span class=\"token number\">0</span> <span class=\"token operator\">||</span> <span class=\"token punctuation\">(</span>PTE <span class=\"token operator\">&amp;</span> <span class=\"token number\">0xFFFFFC1F</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>\t\t\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>\t\t\t\t<span class=\"token keyword\">return</span> FALSE<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>\t\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>\t\tbuffer<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>PBYTE<span class=\"token punctuation\">)</span>dwAddr<span class=\"token punctuation\">)</span><span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>\t<span class=\"token keyword\">return</span> TRUE<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre></pre></td></tr><tr><td data-num=\"38\"></td><td><pre><span class=\"token keyword\">void</span> <span class=\"token function\">__declspec</span><span class=\"token punctuation\">(</span>naked<span class=\"token punctuation\">)</span> <span class=\"token function\">R0Function</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>\t__asm</pre></td></tr><tr><td data-num=\"41\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>\t\tpushad</pre></td></tr><tr><td data-num=\"43\"></td><td><pre>\t\tpushfd</pre></td></tr><tr><td data-num=\"44\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>\t<span class=\"token comment\">// 读 NULL 指针，错误原因：请求零页面</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>\t<span class=\"token comment\">//ReadMemory((PBYTE)mybuff, 0, 0x1000);</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>\t<span class=\"token function\">ReadMemory</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>PBYTE<span class=\"token punctuation\">)</span>mybuff<span class=\"token punctuation\">,</span><span class=\"token punctuation\">(</span>DWORD<span class=\"token punctuation\">)</span>somedata<span class=\"token punctuation\">,</span>DATALEN<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>\t__asm</pre></td></tr><tr><td data-num=\"52\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>\t\tpopfd</pre></td></tr><tr><td data-num=\"54\"></td><td><pre>\t\tpopad</pre></td></tr><tr><td data-num=\"55\"></td><td><pre>\t\tiretd</pre></td></tr><tr><td data-num=\"56\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre></pre></td></tr><tr><td data-num=\"59\"></td><td><pre><span class=\"token keyword\">int</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> argc<span class=\"token punctuation\">,</span> <span class=\"token keyword\">char</span><span class=\"token operator\">*</span> argv<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"61\"></td><td><pre>\t<span class=\"token keyword\">int</span> i<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"62\"></td><td><pre>\t<span class=\"token comment\">// 初始化数据</span></pre></td></tr><tr><td data-num=\"63\"></td><td><pre>\t<span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span>i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> DATALEN<span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span> somedata<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> i<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"64\"></td><td><pre>\t<span class=\"token function\">memset</span><span class=\"token punctuation\">(</span>mybuff<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> DATALEN<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"65\"></td><td><pre></pre></td></tr><tr><td data-num=\"66\"></td><td><pre>\t<span class=\"token comment\">// 提权到 R0 测试 ReadMemory 函数</span></pre></td></tr><tr><td data-num=\"67\"></td><td><pre>\t<span class=\"token comment\">//DbgPrint = (DBGPRINT) GetProcAddress (LoadLibraryA (\"ntdll.dll\"), \"DbgPrint\"); // 载入函数</span></pre></td></tr><tr><td data-num=\"68\"></td><td><pre>\t<span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"在IDT表构建中断门，请在windbg中执行下面的指令：\\n\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"69\"></td><td><pre>\t<span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"eq 8003f500 %04xee00`0008%04x\\n\"</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span>DWORD<span class=\"token punctuation\">)</span>R0Function <span class=\"token operator\">>></span> <span class=\"token number\">16</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span>DWORD<span class=\"token punctuation\">)</span>R0Function <span class=\"token operator\">&amp;</span> <span class=\"token number\">0x0000FFFF</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"70\"></td><td><pre>\t<span class=\"token function\">getchar</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"71\"></td><td><pre>\t__asm <span class=\"token keyword\">int</span> <span class=\"token number\">0x20</span></pre></td></tr><tr><td data-num=\"72\"></td><td><pre></pre></td></tr><tr><td data-num=\"73\"></td><td><pre>\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">memcmp</span><span class=\"token punctuation\">(</span>mybuff<span class=\"token punctuation\">,</span> somedata<span class=\"token punctuation\">,</span> DATALEN<span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"74\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"75\"></td><td><pre>\t\t<span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"读取失败.\\n\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"76\"></td><td><pre>\t\t<span class=\"token function\">getchar</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"77\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"78\"></td><td><pre>\t<span class=\"token keyword\">else</span></pre></td></tr><tr><td data-num=\"79\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"80\"></td><td><pre>\t\t<span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"读取成功.\\n\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"81\"></td><td><pre>\t\t<span class=\"token function\">getchar</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"82\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"83\"></td><td><pre>\t<span class=\"token keyword\">return</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"84\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h2 id=\"第二题\"><a class=\"anchor\" href=\"#第二题\">#</a> 第二题</h2>\n<p><strong>所遇问题</strong></p>\n<p>将 C 代码在 VC<ins> 中编译，经常会出现 error C2275 错误，结果是变量的定义位置不对，应该在函数块的最前面。<br />\n这是一个编程习惯的问题。<br />\n在移植 c</ins> 代码到 c 的时候，经常会出现一个奇怪的错误：“error C2275: “xxxxx”: 将此类型用作表达式非法”<br />\n 这个错误是由于 c 的编译器要求将变量的申明放在一个函数块的头部，而 c++ 没有这样的要求造成的。<br />\n解决的办法就是把变量的声明全部放在变量的生存块的开始。</p>\n<p>代码：</p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;stdio.h></span></span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;Windows.h></span></span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>DWORD <span class=\"token operator\">*</span>arr<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token keyword\">void</span> <span class=\"token function\">__declspec</span><span class=\"token punctuation\">(</span>naked<span class=\"token punctuation\">)</span> <span class=\"token function\">R0Function</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>\t__asm</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\t\tpushad</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>\t\tpushfd</pre></td></tr><tr><td data-num=\"12\"></td><td><pre></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>\t\tmov eax<span class=\"token punctuation\">,</span> dword ptr<span class=\"token punctuation\">[</span>arr<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>\t\tshr eax<span class=\"token punctuation\">,</span> <span class=\"token number\">9</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>\t\tand eax<span class=\"token punctuation\">,</span> <span class=\"token number\">7FFFF</span><span class=\"token number\">8</span>h<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>\t\tsub eax<span class=\"token punctuation\">,</span> <span class=\"token number\">40000000</span>h<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>\t\tmov ebx<span class=\"token punctuation\">,</span> <span class=\"token number\">0x1000</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>\t\tshr ebx<span class=\"token punctuation\">,</span> <span class=\"token number\">9</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>\t\tand ebx<span class=\"token punctuation\">,</span> <span class=\"token number\">7FFFF</span><span class=\"token number\">8</span>h<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>\t\tsub ebx<span class=\"token punctuation\">,</span> <span class=\"token number\">40000000</span>h<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>\t\tmov eax<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span>eax<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>\t\tmov <span class=\"token punctuation\">[</span>ebx<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> eax<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre></pre></td></tr><tr><td data-num=\"26\"></td><td><pre></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>\t\tpopfd</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>\t\tpopad</pre></td></tr><tr><td data-num=\"29\"></td><td><pre>\t\tiretd</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre></pre></td></tr><tr><td data-num=\"33\"></td><td><pre><span class=\"token keyword\">int</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> argc<span class=\"token punctuation\">,</span> <span class=\"token keyword\">char</span><span class=\"token operator\">*</span> argv<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>\t<span class=\"token keyword\">int</span> i<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>\t<span class=\"token comment\">// 定义 0x1000 指针</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>\tDWORD<span class=\"token operator\">*</span> ptr <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>DWORD<span class=\"token operator\">*</span><span class=\"token punctuation\">)</span><span class=\"token number\">0x1000</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>\t<span class=\"token comment\">// 申请数组并初始化</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>\tarr <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>DWORD<span class=\"token operator\">*</span><span class=\"token punctuation\">)</span><span class=\"token function\">VirtualAlloc</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x1000</span><span class=\"token punctuation\">,</span> MEM_COMMIT<span class=\"token punctuation\">,</span> PAGE_READWRITE<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>\t<span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span>i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> <span class=\"token number\">100</span><span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>\t\tarr<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>DWORD<span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span>arr <span class=\"token operator\">+</span> i<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>\t<span class=\"token comment\">// 挂物理页</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>\t<span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"在IDT表构建中断门，请在windbg中执行下面的指令：\\n\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>\t<span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"eq 8003f500 %04xee00`0008%04x\\n\"</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span>DWORD<span class=\"token punctuation\">)</span>R0Function <span class=\"token operator\">>></span> <span class=\"token number\">16</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span>DWORD<span class=\"token punctuation\">)</span>R0Function <span class=\"token operator\">&amp;</span> <span class=\"token number\">0x0000FFFF</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>\t<span class=\"token function\">getchar</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>\t__asm <span class=\"token keyword\">int</span> <span class=\"token number\">0x20</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>\t<span class=\"token comment\">// 通过 0x1000 打印数组</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>\t<span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span>i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> <span class=\"token number\">100</span><span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre>\t\t<span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"%x\\n\"</span><span class=\"token punctuation\">,</span> ptr<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre>\t<span class=\"token function\">getchar</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre>\t<span class=\"token keyword\">return</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h1 id=\"reference\"><a class=\"anchor\" href=\"#reference\">#</a> Reference</h1>\n<p>[关于 C++ 程序编译出现 error C2143: syntax error : missing ';' before 'type' 的解决办法]<span class=\"exturl\" data-url=\"aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2xjcl9oYXBweS9hcnRpY2xlL2RldGFpbHMvNTI0Njc2OTM=\">https://blog.csdn.net/lcr_happy/article/details/52467693</span><br />\n [error C2275 将此类型用作表达式非法]<span class=\"exturl\" data-url=\"aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2xxazE5ODUvYXJ0aWNsZS9kZXRhaWxzLzczODkxNTk=\">https://blog.csdn.net/lqk1985/article/details/7389159</span><br />\n<span class=\"exturl\" data-url=\"aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L0t3YW5zeS9hcnRpY2xlL2RldGFpbHMvMTA5MDI0NTA0\">https://blog.csdn.net/Kwansy/article/details/109024504</span></p>\n",
            "tags": [
                "error C2143",
                "error C2275"
            ]
        },
        {
            "id": "https://or0kit.github.io/Bin/Core/WindowsXp/Protect-Mode/%E4%BF%9D%E6%8A%A4%E6%A8%A1%E5%BC%8F-PWT%E4%B8%8EPCD%E5%B1%9E%E6%80%A7/",
            "url": "https://or0kit.github.io/Bin/Core/WindowsXp/Protect-Mode/%E4%BF%9D%E6%8A%A4%E6%A8%A1%E5%BC%8F-PWT%E4%B8%8EPCD%E5%B1%9E%E6%80%A7/",
            "title": "保护模式-PWT与PCD属性",
            "date_published": "2021-09-03T14:45:30.000Z",
            "content_html": "<h1 id=\"楔子\"><a class=\"anchor\" href=\"#楔子\">#</a> 楔子</h1>\n<p>在学习 PDE 与 PTE 的属性时，我们对两个位做了 <strong>保留</strong> ，并没有说明其作用，那就是今天要学习的<strong> PWT 位</strong>与<strong> PCD 位</strong></p>\n<h2 id=\"cpu缓存\"><a class=\"anchor\" href=\"#cpu缓存\">#</a> CPU 缓存</h2>\n<p>描述：</p>\n<ol>\n<li>CPU 缓存是位于<strong> CPU</strong> 与<strong>物理内存</strong>之间的 <strong>临时存储器</strong> ，它的 <strong>容量比内存小的多</strong> ，但是<strong>交换速度（读写速度）比内存要快得多</strong></li>\n<li>CPU 缓存可以做的很大，有几 K、几十 K、几百 K、甚至上 M，这决定于<strong> CPU 的版本</strong></li>\n</ol>\n<h3 id=\"cpu缓存与tlb的区别\"><a class=\"anchor\" href=\"#cpu缓存与tlb的区别\">#</a> CPU 缓存与 TLB 的区别</h3>\n<p>TLB：</p>\n<blockquote>\n<p>存储了  <code>线性地址</code> 与  <code>物理地址</code> 之间的对应关系</p>\n</blockquote>\n<p>CPU 缓存：</p>\n<blockquote>\n<p>存储了  <code>物理地址</code> 与  <code>内容</code> 之间的对应关系</p>\n</blockquote>\n<p>有了 CPU 缓存，当 CPU 再去<strong>查找 / 读取</strong>某一个线性地址对应的物理页时，就可以：</p>\n<ol>\n<li>先查 <strong>TLB</strong> ，找到它的<strong>物理地址</strong></li>\n<li>再找 <strong>CPU 缓存</strong> ，找到它的<strong>内容</strong></li>\n</ol>\n<p>CPU 缓存的大小决定了 CPU 的执行速度（ <strong>CPU 缓存越大，速度越快</strong> ，当然也会越贵）</p>\n<p><strong>注意</strong> ：</p>\n<ol>\n<li>更多关于 CPU 缓存的细节请参考<strong> Intel 白皮书第三卷第 11 章</strong></li>\n<li>不同的版本，章节顺序可能不一样，请参考章节标题</li>\n</ol>\n<p><img data-src=\"image001.png\" alt=\"\" /></p>\n<h2 id=\"pwtpage-write-through\"><a class=\"anchor\" href=\"#pwtpage-write-through\">#</a> PWT（Page Write Through）</h2>\n<p><code>PWT=1</code> ：写<strong> Cache</strong> 的时候也要将<strong>数据</strong>写入<strong>内存</strong>中<br />\n <code>PWT=0</code> ：写<strong> Cache</strong> 的时候就只是写 Cache，是否要映射到内存由<strong> CPU 缓存控制器</strong>自己决定</p>\n<h2 id=\"pcdpage-cache-disable\"><a class=\"anchor\" href=\"#pcdpage-cache-disable\">#</a> PCD（Page Cache Disable）</h2>\n<p><code>PCD=1</code> ：禁止某个页写入缓存（直接写入内存）<br />\n<strong>比如</strong> ：做页表用的页，已经存储在 TLB 中，可能就不需要再做缓存，而它的 PCD 一定为 1</p>\n<h1 id=\"reference\"><a class=\"anchor\" href=\"#reference\">#</a> Reference</h1>\n<p>滴水课件<br />\n<span class=\"exturl\" data-url=\"aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQxOTg4NDQ4L2FydGljbGUvZGV0YWlscy8xMDI3NjM4OTE=\"> https://blog.csdn.net/qq_41988448/article/details/102763891</span></p>\n",
            "tags": [
                "TLB",
                "PWT",
                "PDT",
                "CPU缓存"
            ]
        },
        {
            "id": "https://or0kit.github.io/Bin/Core/WindowsXp/Protect-Mode/%E4%BF%9D%E6%8A%A4%E6%A8%A1%E5%BC%8F-%E6%8E%A7%E5%88%B6%E5%AF%84%E5%AD%98%E5%99%A8/",
            "url": "https://or0kit.github.io/Bin/Core/WindowsXp/Protect-Mode/%E4%BF%9D%E6%8A%A4%E6%A8%A1%E5%BC%8F-%E6%8E%A7%E5%88%B6%E5%AF%84%E5%AD%98%E5%99%A8/",
            "title": "保护模式-控制寄存器",
            "date_published": "2021-09-03T14:43:31.000Z",
            "content_html": "<h1 id=\"控制寄存器\"><a class=\"anchor\" href=\"#控制寄存器\">#</a> 控制寄存器</h1>\n<p>控制寄存器用于控制和确定 CPU 的操作模式。</p>\n<p>控制寄存器有五个  <code>Cr0 Cr1 Cr2 Cr3 Cr4 </code>  其中  <code>Cr1</code>  保留， <code>Cr3</code>  存储的是页目录表基址</p>\n<h2 id=\"cr0\"><a class=\"anchor\" href=\"#cr0\">#</a> CR0</h2>\n<p><img data-src=\"image001.png\" alt=\"\" /></p>\n<p><strong>说明：</strong></p>\n<p><code>PE位</code> ：启用保护（Protecction Enable）标志<br />\n<strong> PE=1</strong> ：保护模式<br />\n<strong> PE=0</strong> ：实地址模式<br />\n这个标志 <strong>仅开启段级保护</strong> ，而没有启用分页机制<br />\n若要启用 <strong>分页机制</strong> ，那么<strong> PE</strong> 和<strong> PG</strong> 标志都要置位</p>\n<p><code>PG位</code> ：分页机制标志<br />\n<strong> PG=1</strong> ：开启了分页机制<br />\n<strong> PG=0</strong> ：未开启分页机制<br />\n在开启这个标志位之前<strong>必须已经或者同时开启  <code>PE</code>  标志</strong></p>\n<p><strong>PG=0</strong> 且 <strong>PE=0</strong> ：处理器工作状态为<strong>实地址模式</strong><br />\n<strong> PG=0</strong> 且 <strong>PE=1</strong> ：处理器工作状态为<strong>没有开启分页机制的保护模式</strong><br />\n<strong> PG=1</strong> 且 <strong>PE=0</strong> ：不存在。在<strong> PE</strong> 没有开启的情况下<strong>无法开启 PG</strong><br />\n<strong>PG=1</strong> 且 <strong>PE=1</strong> ：处理器工作状态为<strong>开启了分页机制的保护模式</strong></p>\n<p><code>WP位</code> ：写保护（Write Proctect）标志<br />\n对于 <strong>Intel 80486 或以上的 CPU</strong> ，CR0 的<strong> 16 位</strong>是写保护标志<br />\n当设置该标志时，处理器会禁止 <strong>超级用户程序</strong> （例如特权级 0 的程序）向<strong>用户级只读页面</strong>执行写操作</p>\n<p>当<strong> CPL&lt;3</strong> 的时候：</p>\n<ol>\n<li>如果 <strong>WP=0</strong> 可以<strong>读写</strong>任意用户级物理页，<strong>只要线性地址有效</strong></li>\n<li>如果 <strong>WP=1</strong> 可以<strong>读取</strong>任意用户级物理页，<strong>但对于只读的物理页，则不能写</strong></li>\n</ol>\n<h2 id=\"cr2\"><a class=\"anchor\" href=\"#cr2\">#</a> CR2</h2>\n<p><img data-src=\"image002.png\" alt=\"\" /></p>\n<p>当 CPU 访问某个无效页面时，会产生缺页异常，此时，CPU 会将引起异常的线性地址存放在 CR2 中</p>\n<p>举例：</p>\n<ol>\n<li>当 CPU 访问某个物理页，但 PDE/PTE 的<strong> P 位为 0</strong> 时，会产生<strong>缺页异常</strong></li>\n<li>缺页异常一旦发生，CPU 会将<strong>引起缺页异常的线性地址</strong>存储到<strong> Cr2</strong> 中</li>\n<li>此时，操作系统的处理程序开始<strong>对异常进行处理</strong></li>\n<li>若<strong>处理结束</strong>后，虽然 PDE/PTE 的 P 位为 0，但实际上它被写进了页面</li>\n<li>这时，处理程序会<strong>将数据从页面中读出，再挂上一个有效的物理页，让程序接着往下跑</strong></li>\n<li>程序往下跑时，操作系统必须要记录程序<strong>原先已经跑到了哪里</strong></li>\n<li>此时，Cr2 便派上了用场，因为<strong>产生异常时的线性地址存在了 Cr2 中</strong></li>\n<li>但如果异常处理程序检测到用户访问的页面是一个<strong>未分配的页面</strong></li>\n<li>这时，操作系统会报告一个 <strong>异常</strong> ，告诉我们<strong>在哪里发生了错误</strong></li>\n<li><strong>若没有 Cr2 寄存器，当进入异常处理程序时，将找不到回去的线性地址</strong></li>\n</ol>\n<h2 id=\"cr4寄存器\"><a class=\"anchor\" href=\"#cr4寄存器\">#</a> Cr4 寄存器</h2>\n<p><img data-src=\"image003.png\" alt=\"\" /></p>\n<p>PAE/PSE 说明：</p>\n<p>PAE=1 是 2-9-9-12 分页  PAE=0 是 10-10-12 分页。<br />\nPSE：大页开启标志。</p>\n<p><img data-src=\"image004.png\" alt=\"\" /></p>\n<blockquote>\n<p>注意：关于控制寄存器的更多细节，请参考 Intel 白皮书第三卷</p>\n</blockquote>\n<p><img data-src=\"image005.png\" alt=\"\" /></p>\n<h1 id=\"reference\"><a class=\"anchor\" href=\"#reference\">#</a> Reference</h1>\n<p>滴水课件<br />\n<span class=\"exturl\" data-url=\"aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQxOTg4NDQ4L2FydGljbGUvZGV0YWlscy8xMDI3NjM2NDY=\"> https://blog.csdn.net/qq_41988448/article/details/102763646</span></p>\n",
            "tags": [
                "CR0",
                "CR2",
                "CR4"
            ]
        },
        {
            "id": "https://or0kit.github.io/Bin/Core/WindowsXp/Protect-Mode/%E4%BF%9D%E6%8A%A4%E6%A8%A1%E5%BC%8F-%E4%B8%AD%E6%96%AD%E4%B8%8E%E5%BC%82%E5%B8%B8/",
            "url": "https://or0kit.github.io/Bin/Core/WindowsXp/Protect-Mode/%E4%BF%9D%E6%8A%A4%E6%A8%A1%E5%BC%8F-%E4%B8%AD%E6%96%AD%E4%B8%8E%E5%BC%82%E5%B8%B8/",
            "title": "保护模式-中断与异常",
            "date_published": "2021-09-03T14:43:18.000Z",
            "content_html": "<h1 id=\"什么是中断\"><a class=\"anchor\" href=\"#什么是中断\">#</a> 什么是中断</h1>\n<ol>\n<li>\n<p>中断通常是由 CPU 外部的输入输出设备 (硬件) 所触发的，供外部设备通知<br />\n CPU “有事情需要处理”，因此又叫中断请求 (Interrupt Request).</p>\n</li>\n<li>\n<p>中断请求的目的是希望 CPU 暂时停止执行当前正在执行的程序，转去执行<br />\n中断请求所对应的中断处理例程 (中断处理程序在哪有 IDT 表决定)</p>\n</li>\n<li>\n<p>80x86 有两条中断请求线：</p>\n<p>非屏蔽中断线，称为 NMI（NonMaskable Interrupt）</p>\n<p>可屏蔽中断线，称为 INTR（Interrupt Require）</p>\n</li>\n<li>\n<p>假设没有中断这种机制，当一个的程序的代码为死循环时，其他的程序就没有机会执行了。</p>\n</li>\n</ol>\n<p>中断的本质：改变 CPU 的执行路线</p>\n<h2 id=\"可屏蔽中断\"><a class=\"anchor\" href=\"#可屏蔽中断\">#</a> 可屏蔽中断</h2>\n<p><strong>描述：</strong></p>\n<p>在硬件级，可屏蔽中断是由一块专门的芯片来管理的，通常称为中断控制器<br />\n它负责分配中断资源和管理各个中断源发出的中断请求<br />\n为了便于标识各个中断请求，中断管理器通常用 IRQ（Interrupt Request）后面加上数字来表示不同的中断<br />\n比如：在 Windows 中，时钟中断的 IRQ 编号为 0，也就是  <code>IRQ0</code></p>\n<h2 id=\"时钟中断\"><a class=\"anchor\" href=\"#时钟中断\">#</a> 时钟中断</h2>\n<p><strong>描述：</strong></p>\n<p>大多数操作系统时钟中断在 10-100MS 之间，Windows 系列为 10-20MS<br />\nWindows 时钟中断每隔 10~20MS 会向 CPU 发送一个请求，当 CPU 收到请求时，操作系统就会接管 CPU，指定 CPU 去执行一段代码，操作系统在这段代码里便有机会进行线程的切换。这样，即便一个程序进入死循环，操作系统依然有机会进行线程切换<br />\n当然，操作系统主要并不是通过时钟中断来进行线程切换，而只是有机会进行线程切换，这里只是举个例子。</p>\n<p><img data-src=\"image001.png\" alt=\"\" /></p>\n<h2 id=\"可屏蔽中断如何处理\"><a class=\"anchor\" href=\"#可屏蔽中断如何处理\">#</a> 可屏蔽中断如何处理？</h2>\n<p><strong>描述：</strong></p>\n<ol>\n<li><strong>时钟中断</strong>的 <strong>IRQ 编号为 0</strong> ，所在位置为<strong> IDT [0x30]</strong></li>\n<li><strong>IRQ1~IRQ15</strong> 分别对应<strong> IDT [0x31]~IDT [0x35]</strong></li>\n</ol>\n<p><img data-src=\"image002.png\" alt=\"\" /></p>\n<p><strong>特别说明：</strong></p>\n<p>1、如果自己的程序执行时不希望 CPU 去处理这些中断，可以<br />\n用  <code>CLI</code>  指令清空 EFLAG 寄存器中的 IF 位<br />\n用  <code>STI</code>  指令设置 EFLAG 寄存器中的 IF 位</p>\n<p>2、硬件中断与 IDT 表中的对应关系并非固定不变的<br />\n参见：APIC（高级可编程中断控制器）</p>\n<h2 id=\"不可屏蔽中断如何处理\"><a class=\"anchor\" href=\"#不可屏蔽中断如何处理\">#</a> 不可屏蔽中断如何处理？</h2>\n<p><img data-src=\"image003.png\" alt=\"\" /></p>\n<p>特别说明：</p>\n<blockquote>\n<p>当非可屏蔽中断产生时，CPU 在执行完当前指令后会里面进入中断处理程序</p>\n</blockquote>\n<blockquote>\n<p>非可屏蔽中断不受 EFLAG 寄存器中 IF 位的影响，一旦发生，CPU 必须处理</p>\n</blockquote>\n<blockquote>\n<p>非可屏蔽中断处理程序位于 IDT 表中的 2 号位置</p>\n</blockquote>\n<h1 id=\"异常\"><a class=\"anchor\" href=\"#异常\">#</a> 异常</h1>\n<p>描述：</p>\n<blockquote>\n<p>异常通常是 <strong>CPU 在执行指令时检测到的某些错误</strong> ，比如除 0、访问无效页面等。</p>\n</blockquote>\n<p>中断与异常的区别：</p>\n<ol>\n<li><code>中断</code> 来自于 <strong>外部设备</strong> ，是 <strong>中断源</strong> （比如键盘）发起的，<strong>CPU 是被动的</strong></li>\n<li><code>异常</code> 来自于 <strong>CPU 本身</strong> ，是<strong> CPU 主动产生的</strong></li>\n<li><strong>INT N</strong> 虽然被称为 “软件中断”，但其<strong>本质是异常</strong></li>\n<li>EFLAG 的  <code>IF位</code> 对  <code>INT N</code>  无效。</li>\n</ol>\n<h2 id=\"异常处理\"><a class=\"anchor\" href=\"#异常处理\">#</a> 异常处理</h2>\n<p>描述：</p>\n<blockquote>\n<p>无论是由<strong>硬件设备触发的中断请求</strong>还是由 <strong>CPU 产生的异常</strong> ，处理程序都在  <code>IDT表</code></p>\n</blockquote>\n<p>常见的异常处理程序：</p>\n<p><img data-src=\"image004.png\" alt=\"\" /></p>\n<p><code>页错误</code> ：当我们访问一个 <strong>线性地址</strong> ，而这个线性地址指向的<strong>物理页</strong>是 <strong>无效的</strong> ，便会触发 CPU 异常，该异常位于 <strong>E 号门</strong> （IDT [0xE]）<br />\n <code>段错误</code> ：一旦<strong>段的运算发生异常</strong>时（如权限检查），便会走 <strong>D 号门</strong> （IDT [0xD]）<br />\n <code>除0错误</code> ：当<strong>除数为 0</strong> 时，会触发异常，这时走 <strong>0 号门</strong> （IDT [0x0]）<br />\n <code>双重错误</code> ：假设 <strong>执行一个异常（如页错误）时又产生了一个错误</strong> ，那么便会触发双重错误，这时走 <strong>8 号门</strong> （IDT [0x8]）</p>\n<h2 id=\"缺页异常\"><a class=\"anchor\" href=\"#缺页异常\">#</a> 缺页异常</h2>\n<p>缺页异常的 <strong>产生</strong> （例举两种）：</p>\n<ol>\n<li>当 PDE/PTE 的<strong> P=0</strong> 时会发生缺页异常</li>\n<li>当 PDE/PTE 的<strong>属性为只读但程序试图写入</strong>时会发生缺页异常</li>\n</ol>\n<p>一旦发生缺页异常，CPU 会执行 IDT 表中的<strong> 0xE 号</strong>中断处理程序，由操作系统来接管，后面会学习的。</p>\n<p><img data-src=\"image005.png\" alt=\"\" /></p>\n<h1 id=\"实验\"><a class=\"anchor\" href=\"#实验\">#</a> 实验</h1>\n<h2 id=\"分析idt表中0x2号中断的执行流程\"><a class=\"anchor\" href=\"#分析idt表中0x2号中断的执行流程\">#</a> 分析 IDT 表中 0x2 号中断的执行流程</h2>\n<h2 id=\"分析idt表中0x8号中断的执行流程\"><a class=\"anchor\" href=\"#分析idt表中0x8号中断的执行流程\">#</a> 分析 IDT 表中 0x8 号中断的执行流程</h2>\n<h1 id=\"reference\"><a class=\"anchor\" href=\"#reference\">#</a> Reference</h1>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQxOTg4NDQ4L2FydGljbGUvZGV0YWlscy8xMDI3NjA1NzA=\">https://blog.csdn.net/qq_41988448/article/details/102760570</span></p>\n",
            "tags": [
                "中断",
                "异常",
                "CLI指令",
                "STI指令",
                "INT2",
                "INT8"
            ]
        },
        {
            "id": "https://or0kit.github.io/Bin/Core/WindowsXp/Protect-Mode/%E4%BF%9D%E6%8A%A4%E6%A8%A1%E5%BC%8F-TLB/",
            "url": "https://or0kit.github.io/Bin/Core/WindowsXp/Protect-Mode/%E4%BF%9D%E6%8A%A4%E6%A8%A1%E5%BC%8F-TLB/",
            "title": "保护模式-TLB",
            "date_published": "2021-09-03T14:42:24.000Z",
            "content_html": "<h1 id=\"地址解析\"><a class=\"anchor\" href=\"#地址解析\">#</a> 地址解析</h1>\n<p>当我们通过一个线性地址访问一个物理页（比如：MOV EAX,[0x12345678]）时，实际上 CPU 未必只读了 4 个字节。</p>\n<ul>\n<li>10-10-12 分页</li>\n</ul>\n<blockquote>\n<p>CPU 先通过线性地址找到对应的 PDE：4 个字节<br />\n CPU 再通过 PDE 和线性地址找到 PTE：4 个字节<br />\n最后再通过 PTE 找到对应物理页：4 个字节<br />\n一共访问了 12 个字节，如果跨页可能更多。</p>\n</blockquote>\n<ul>\n<li>2-9-9-12 分页</li>\n</ul>\n<blockquote>\n<p>找到 PDPTE：8 个字节<br />\n找到 PDE：8 个字节<br />\n找到 PTE：8 个字节<br />\n最后找到物理页：4 个字节<br />\n一共访问了 20 个字节，如果跨页可能更多。</p>\n</blockquote>\n<p>为了提高访问效率，只能对线性地址与其对应的物理地址做记录。<br />\nCPU 内部做了一张表，用来记录这些东西。它的效率和寄存器一样快，名字叫做 TLB（Translation Lookaside Buffer）。<br />\n由于 TLB 的效率很快，因此它的大小不能太大，少则几十条，多则也只有上百条。</p>\n<p>思考：在一个进程的 4GB 空间中，有无数个线性地址，但是一个 TLB 最多只能记录上百条记录，那么这张表真的有意义吗？</p>\n<h1 id=\"tlb\"><a class=\"anchor\" href=\"#tlb\">#</a> TLB</h1>\n<h2 id=\"tlb结构\"><a class=\"anchor\" href=\"#tlb结构\">#</a> TLB 结构</h2>\n<p><img data-src=\"image001.png\" alt=\"\" /></p>\n<p><code>ATTR：</code> 属性<br />\n在 10-10-12 分页模式下：ATTR = PDE 属性 &amp; PTE 属性<br />\n在 2-9-9-12 分页模式下：ATTR = PDPTE 属性 &amp; PDE 属性 &amp; PTE 属性</p>\n<p><code>LRU：</code> 统计信息<br />\n由于 TLB 的大小有限，因此当 TLB 被写满、又有新的地址即将写入时，TLB 就会根据统计信息来判断哪些地址是不常用的，从而将不常用的记录从 TLB 中移除。</p>\n<p>注意：</p>\n<p>不同的 CPU，TLB 大小不同<br />\n只要 Cr3 发生变化，TLB 立即刷新，一核一套 TLB<br />\n 由于操作系统的高 2G 映射基本不变，因此如果 Cr3 改了，TLB 刷新的话，重建高 2G 以上很浪费。<br />\n所以 PDE 和 PTE 中有个 G 标志位（当 PDE 为大页时，G 标志位才起作用），如果 G 位为 1，刷新 TLB 时将不会刷新 PDE/PTE<br />\nG 位为 1 的页，当 TLB 写满时，CPU 根据统计信息将不常用的地址废弃，保留最常用的地址</p>\n<h2 id=\"tlb种类\"><a class=\"anchor\" href=\"#tlb种类\">#</a> TLB 种类</h2>\n<p>TLB 在 X86 体系的 CPU 中的实际应用最早是从 Intel 的 486CPU 开始的，在 X86 体系的 CPU 中，一般都设有如下 4 组 TLB:</p>\n<blockquote>\n<p>第一组：缓存一般页表（4K 字节页面）的指令页表缓存（Instruction-TLB）；<br />\n第二组：缓存一般页表（4K 字节页面）的数据页表缓存（Data-TLB）；<br />\n第三组：缓存大尺寸页表（2M/4M 字节页面）的指令页表缓存（Instruction-TLB）；<br />\n第四组：缓存大尺寸页表（2M/4M 字节页面）的数据页表缓存（Data-TLB）</p>\n</blockquote>\n<h1 id=\"全局页\"><a class=\"anchor\" href=\"#全局页\">#</a> 全局页</h1>\n<p>G=1，即为全局页，进程（CR3）切换时，TLB 中的记录不会被刷新。</p>\n<h1 id=\"实验\"><a class=\"anchor\" href=\"#实验\">#</a> 实验</h1>\n<h2 id=\"编写代码实现修改页属性实现应用层读写高2g内存地址\"><a class=\"anchor\" href=\"#编写代码实现修改页属性实现应用层读写高2g内存地址\">#</a> 编写代码实现修改页属性，实现应用层读写高 2G 内存地址</h2>\n<p>改 U/S 位，和 PTE 的 G 位<br />\n G=1 时，程序会崩，只有 G=0 才能成功。<br />\n简单解释一下 G 位：<br />\nPDE 中，只有 PS=1（大页）时，G 才有效。<br />\nG 位是全局页的意思，G=1 时，这个线性地址对应的页是全局页，进程切换时，对应的 TLB 不会改变。多个进程的高 2G 数据大部分都是相同的，我们不希望在切换进程时对这部分 TLB 做多余的刷新，所以需要设置 G=1 以提高效率。</p>\n<p>回到本文，我们已经知道 PDE 的 PS=0，所以我们不用管 PDE 的 G。关键是 PTE 的 G，为什么要改成 0 呢？因为线性地址 0x8003f048 默认是 G=1，它在 CPU 中有 TLB 缓存。<br />\n2-9-9-12 模式下获取 PDPTI-PDI-PTI-OFFSET</p>\n<p>公式：</p>\n<blockquote>\n<p>pPDE = 0xc0600000 + (PDPTI*4KB) + (PDI*8)\t\t\t\t\t<br />\npPTE = 0xc0000000 + (PDPTI*2MB) + (PDI*4KB) + (PTI*8)</p>\n</blockquote>\n<p>更高效的公式（MmIsAddressValid 是这么干的）</p>\n<blockquote>\n<p>pPDE = 0xc0600000 + ((addr &gt;&gt; 18) &amp; 0x3ff8)\t<br />\npPTE = 0xc0000000 + ((addr &gt;&gt; 9) &amp; 0x7ffff8)</p>\n</blockquote>\n<p>代码转自<span class=\"exturl\" data-url=\"aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L0t3YW5zeS9hcnRpY2xlL2RldGFpbHMvMTA4OTY1MTk2\"> https://blog.csdn.net/Kwansy/article/details/108965196</span></p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;stdio.h></span></span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;windows.h></span></span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token comment\">//2-9-9-12</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token comment\">//PDPTI-PDI-PTI-OFFSET</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>DWORD <span class=\"token operator\">*</span><span class=\"token function\">GetPDE</span><span class=\"token punctuation\">(</span>DWORD addr<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\t<span class=\"token comment\">//return (DWORD *)(0xc0600000 + ((addr >> 18) &amp; 0x3ff8));</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\tDWORD PDPTI <span class=\"token operator\">=</span> addr <span class=\"token operator\">>></span> <span class=\"token number\">30</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>\tDWORD PDI <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>addr <span class=\"token operator\">>></span> <span class=\"token number\">21</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;</span> <span class=\"token number\">0x000001FF</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>\tDWORD PTI <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>addr <span class=\"token operator\">>></span> <span class=\"token number\">12</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;</span> <span class=\"token number\">0x000001FF</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>\t<span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span>DWORD <span class=\"token operator\">*</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span><span class=\"token number\">0xC0600000</span> <span class=\"token operator\">+</span> PDPTI <span class=\"token operator\">*</span> <span class=\"token number\">0x1000</span> <span class=\"token operator\">+</span> PDI <span class=\"token operator\">*</span> <span class=\"token number\">8</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>DWORD <span class=\"token operator\">*</span><span class=\"token function\">GetPTE</span><span class=\"token punctuation\">(</span>DWORD addr<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>\t<span class=\"token comment\">//return (DWORD *)(0xc0000000 + ((addr >> 9) &amp; 0x7ffff8));</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>\tDWORD PDPTI <span class=\"token operator\">=</span> addr <span class=\"token operator\">>></span> <span class=\"token number\">30</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>\tDWORD PDI <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>addr <span class=\"token operator\">>></span> <span class=\"token number\">21</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;</span> <span class=\"token number\">0x000001FF</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>\tDWORD PTI <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>addr <span class=\"token operator\">>></span> <span class=\"token number\">12</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;</span> <span class=\"token number\">0x000001FF</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>\t<span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span>DWORD <span class=\"token operator\">*</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span><span class=\"token number\">0xC0000000</span> <span class=\"token operator\">+</span> PDPTI <span class=\"token operator\">*</span> <span class=\"token number\">0x200000</span> <span class=\"token operator\">+</span> PDI <span class=\"token operator\">*</span> <span class=\"token number\">0x1000</span> <span class=\"token operator\">+</span> PTI <span class=\"token operator\">*</span> <span class=\"token number\">8</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre></pre></td></tr><tr><td data-num=\"25\"></td><td><pre><span class=\"token keyword\">void</span> <span class=\"token function\">__declspec</span><span class=\"token punctuation\">(</span>naked<span class=\"token punctuation\">)</span> <span class=\"token function\">R0Function</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>\t__asm</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>\t\tpush ebp</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>\t\tmov ebp<span class=\"token punctuation\">,</span>esp</pre></td></tr><tr><td data-num=\"31\"></td><td><pre>\t\tsub esp<span class=\"token punctuation\">,</span><span class=\"token number\">0x1000</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>\t\tpushad</pre></td></tr><tr><td data-num=\"33\"></td><td><pre>\t\tpushfd\t\t</pre></td></tr><tr><td data-num=\"34\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>\t__asm push fs</pre></td></tr><tr><td data-num=\"36\"></td><td><pre>\t<span class=\"token comment\">//__asm int 3</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>\t<span class=\"token comment\">// 修改 8003f048 的 U/S 位</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>\t<span class=\"token operator\">*</span><span class=\"token function\">GetPDE</span><span class=\"token punctuation\">(</span><span class=\"token number\">0x8003f048</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">|=</span> <span class=\"token number\">0x00000004</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>\t<span class=\"token operator\">*</span><span class=\"token function\">GetPTE</span><span class=\"token punctuation\">(</span><span class=\"token number\">0x8003f048</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">|=</span> <span class=\"token number\">0x00000004</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>\t<span class=\"token comment\">// 修改 PTE 的 G 位</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>\t<span class=\"token operator\">*</span><span class=\"token function\">GetPTE</span><span class=\"token punctuation\">(</span><span class=\"token number\">0x8003f048</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;=</span> <span class=\"token number\">0xFFFFFEFF</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>\t<span class=\"token comment\">//__asm int 3</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>\t__asm pop fs</pre></td></tr><tr><td data-num=\"44\"></td><td><pre></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>\t__asm</pre></td></tr><tr><td data-num=\"46\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>\t\tpopfd</pre></td></tr><tr><td data-num=\"48\"></td><td><pre>\t\tpopad</pre></td></tr><tr><td data-num=\"49\"></td><td><pre>\t\tadd esp<span class=\"token punctuation\">,</span><span class=\"token number\">0x1000</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>\t\tmov esp<span class=\"token punctuation\">,</span>ebp</pre></td></tr><tr><td data-num=\"51\"></td><td><pre>\t\tpop ebp</pre></td></tr><tr><td data-num=\"52\"></td><td><pre>\t\tiretd</pre></td></tr><tr><td data-num=\"53\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre></pre></td></tr><tr><td data-num=\"56\"></td><td><pre><span class=\"token keyword\">int</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> argc<span class=\"token punctuation\">,</span> <span class=\"token keyword\">char</span><span class=\"token operator\">*</span> argv<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre>\t<span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"在IDT表构建中断门，请在windbg中执行下面的指令：\\n\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"59\"></td><td><pre>\t<span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"eq 8003f500 %04xee00`0008%04x\\n\"</span><span class=\"token punctuation\">,</span><span class=\"token punctuation\">(</span>DWORD<span class=\"token punctuation\">)</span>R0Function<span class=\"token operator\">>></span><span class=\"token number\">16</span><span class=\"token punctuation\">,</span><span class=\"token punctuation\">(</span>DWORD<span class=\"token punctuation\">)</span>R0Function <span class=\"token operator\">&amp;</span> <span class=\"token number\">0x0000FFFF</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre>\t<span class=\"token function\">getchar</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"61\"></td><td><pre>\t__asm <span class=\"token keyword\">int</span> <span class=\"token number\">0x20</span></pre></td></tr><tr><td data-num=\"62\"></td><td><pre>\t<span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"0x8003f048 U/S,G位修改成功.\\n\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"63\"></td><td><pre>\t<span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"*(PDWORD)0x8003f048 = %08x\\n\"</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">*</span><span class=\"token punctuation\">(</span>PDWORD<span class=\"token punctuation\">)</span><span class=\"token number\">0x8003f048</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// 读</span></pre></td></tr><tr><td data-num=\"64\"></td><td><pre>\t<span class=\"token operator\">*</span><span class=\"token punctuation\">(</span>PDWORD<span class=\"token punctuation\">)</span><span class=\"token number\">0x8003f048</span> <span class=\"token operator\">=</span> <span class=\"token number\">0x12345678</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// 写</span></pre></td></tr><tr><td data-num=\"65\"></td><td><pre>\t<span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"*(PDWORD)0x8003f048 = %08x\\n\"</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">*</span><span class=\"token punctuation\">(</span>PDWORD<span class=\"token punctuation\">)</span><span class=\"token number\">0x8003f048</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// 读</span></pre></td></tr><tr><td data-num=\"66\"></td><td><pre>\t<span class=\"token function\">getchar</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"67\"></td><td><pre></pre></td></tr><tr><td data-num=\"68\"></td><td><pre>\t<span class=\"token keyword\">return</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"69\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>结果：</p>\n<p><img data-src=\"image017.png\" alt=\"\" /></p>\n<h2 id=\"体验tlb的存在\"><a class=\"anchor\" href=\"#体验tlb的存在\">#</a> 体验 TLB 的存在</h2>\n<p>火哥的思路是：</p>\n<p>挂上物理页后，修改一下数据，再挂上另外一个物理页，然后在读取这个线性地址，查看数值是以前的还是后面挂上物理页的，由此推测 TLB 是否存在。</p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span><span class=\"token string\">&lt;stdio.h></span></span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span><span class=\"token string\">&lt;Windows.h></span></span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>DWORD g_Value <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token comment\">//DWORD pPDE, pPTE;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token keyword\">void</span> <span class=\"token function\">__declspec</span><span class=\"token punctuation\">(</span>naked<span class=\"token punctuation\">)</span> <span class=\"token function\">CallGate</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\t__asm <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>\t\tpush <span class=\"token number\">0x30</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>\t\tpop fs<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>\t\tpushad<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>\t\tpushfd<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre></pre></td></tr><tr><td data-num=\"16\"></td><td><pre></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>\t\t<span class=\"token comment\">// 获取 p1 的 PTE</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>\t\tmov eax<span class=\"token punctuation\">,</span><span class=\"token number\">0x600000</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>\t\tshr eax<span class=\"token punctuation\">,</span> <span class=\"token number\">9</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>\t\tand eax<span class=\"token punctuation\">,</span> <span class=\"token number\">0x7FFFF8</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>\t\tsub eax<span class=\"token punctuation\">,</span> <span class=\"token number\">0x40000000</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>\t\tmov ecx<span class=\"token punctuation\">,</span> eax<span class=\"token punctuation\">;</span><span class=\"token comment\">//ecx 指向 p1 的 PTE</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>\t\t</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>\t\t<span class=\"token comment\">//0 地址一般都是有 PDE 的，直接更换它的 PTE</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>\t\tmov eax<span class=\"token punctuation\">,</span> <span class=\"token number\">0xC0000000</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>\t\tmov ecx<span class=\"token punctuation\">,</span><span class=\"token punctuation\">[</span>ecx<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>\t\t<span class=\"token comment\">//or ecx,0x100;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>\t\tmov<span class=\"token punctuation\">[</span>eax<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> ecx<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>\t\tmov dword ptr ds<span class=\"token operator\">:</span><span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x12345678</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>\t\t<span class=\"token comment\">// 获取 p2 的 PTE</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>\t\tmov eax<span class=\"token punctuation\">,</span><span class=\"token number\">0x700000</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>\t\tshr eax<span class=\"token punctuation\">,</span> <span class=\"token number\">9</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>\t\tand eax<span class=\"token punctuation\">,</span> <span class=\"token number\">0x7FFFF8</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>\t\tsub eax<span class=\"token punctuation\">,</span> <span class=\"token number\">0x40000000</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>\t\tmov ecx<span class=\"token punctuation\">,</span> eax<span class=\"token punctuation\">;</span><span class=\"token comment\">//ecx 指向 p1 的 PTE</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>\t\t</pre></td></tr><tr><td data-num=\"41\"></td><td><pre>\t\t<span class=\"token comment\">//0 地址一般都是有 PDE 的，直接更换它的 PTE</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>\t\tmov eax<span class=\"token punctuation\">,</span> <span class=\"token number\">0xC0000000</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>\t\tmov ecx<span class=\"token punctuation\">,</span><span class=\"token punctuation\">[</span>ecx<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>\t\tmov<span class=\"token punctuation\">[</span>eax<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> ecx<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>\t\t<span class=\"token comment\">// 刷新 CR3</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>\t\t<span class=\"token comment\">//mov eax,cr3;</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>\t\t<span class=\"token comment\">//mov cr3,eax;</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>\t\t<span class=\"token comment\">//invlpg dword ptr ds:[0];</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>\t\tmov eax<span class=\"token punctuation\">,</span> dword ptr ds <span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span> <span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre>\t\tmov g_Value<span class=\"token punctuation\">,</span> eax<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>\t\tpopfd<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre>\t\tpopad<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre></pre></td></tr><tr><td data-num=\"59\"></td><td><pre>\t\tretf<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"61\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"62\"></td><td><pre></pre></td></tr><tr><td data-num=\"63\"></td><td><pre><span class=\"token keyword\">int</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> argc<span class=\"token punctuation\">,</span> <span class=\"token keyword\">char</span><span class=\"token operator\">*</span> argv<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"64\"></td><td><pre>\t<span class=\"token keyword\">char</span> buf<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span><span class=\"token number\">0x48</span><span class=\"token punctuation\">,</span><span class=\"token number\">0</span> <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"65\"></td><td><pre></pre></td></tr><tr><td data-num=\"66\"></td><td><pre>\t<span class=\"token keyword\">void</span><span class=\"token operator\">*</span> p1 <span class=\"token operator\">=</span> <span class=\"token function\">VirtualAlloc</span><span class=\"token punctuation\">(</span><span class=\"token number\">0x600000</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x1000</span><span class=\"token punctuation\">,</span> MEM_COMMIT <span class=\"token operator\">|</span> MEM_RESERVE<span class=\"token punctuation\">,</span> PAGE_EXECUTE_READWRITE<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"67\"></td><td><pre>\t<span class=\"token keyword\">void</span><span class=\"token operator\">*</span> p2 <span class=\"token operator\">=</span> <span class=\"token function\">VirtualAlloc</span><span class=\"token punctuation\">(</span><span class=\"token number\">0x700000</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x1000</span><span class=\"token punctuation\">,</span> MEM_COMMIT <span class=\"token operator\">|</span> MEM_RESERVE<span class=\"token punctuation\">,</span> PAGE_EXECUTE_READWRITE<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"68\"></td><td><pre>\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>p1 <span class=\"token operator\">==</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"69\"></td><td><pre>\t\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>p2 <span class=\"token operator\">!=</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">)</span> <span class=\"token function\">VirtualFree</span><span class=\"token punctuation\">(</span>p2<span class=\"token punctuation\">,</span> <span class=\"token number\">0x1000</span><span class=\"token punctuation\">,</span> MEM_COMMIT <span class=\"token operator\">|</span> MEM_RESERVE<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"70\"></td><td><pre>\t\t<span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"virtual failed p1\\n\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"71\"></td><td><pre>\t\t<span class=\"token keyword\">return</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"72\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"73\"></td><td><pre></pre></td></tr><tr><td data-num=\"74\"></td><td><pre>\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>p2 <span class=\"token operator\">==</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"75\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"76\"></td><td><pre>\t\t<span class=\"token function\">VirtualFree</span><span class=\"token punctuation\">(</span>p1<span class=\"token punctuation\">,</span> <span class=\"token number\">0x1000</span><span class=\"token punctuation\">,</span> MEM_COMMIT <span class=\"token operator\">|</span> MEM_RESERVE<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"77\"></td><td><pre>\t\t<span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"virtual failed p2\\n\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"78\"></td><td><pre>\t\t<span class=\"token keyword\">return</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"79\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"80\"></td><td><pre></pre></td></tr><tr><td data-num=\"81\"></td><td><pre>\t<span class=\"token operator\">*</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>DWORD<span class=\"token operator\">*</span><span class=\"token punctuation\">)</span>p1<span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span> <span class=\"token number\">0x100</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"82\"></td><td><pre>\t<span class=\"token operator\">*</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>DWORD<span class=\"token operator\">*</span><span class=\"token punctuation\">)</span>p2<span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span> <span class=\"token number\">0x200</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"83\"></td><td><pre></pre></td></tr><tr><td data-num=\"84\"></td><td><pre>\t<span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"windbg execute eq 8003f048 %04xec00`0008%04x\\n\"</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">unsigned</span> <span class=\"token keyword\">int</span><span class=\"token punctuation\">)</span>CallGate <span class=\"token operator\">>></span> <span class=\"token number\">0x10</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;</span> <span class=\"token number\">0xffff</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">unsigned</span> <span class=\"token keyword\">int</span><span class=\"token punctuation\">)</span>CallGate <span class=\"token operator\">&amp;</span> <span class=\"token number\">0xffff</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"85\"></td><td><pre>\t<span class=\"token function\">getchar</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"86\"></td><td><pre></pre></td></tr><tr><td data-num=\"87\"></td><td><pre>\t__asm <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"88\"></td><td><pre>\t\tcall fword ptr buf<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"89\"></td><td><pre>\t\tpush <span class=\"token number\">0x3b</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"90\"></td><td><pre>\t\tpop fs<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"91\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"92\"></td><td><pre>\t<span class=\"token comment\">//printf(\"%#010X\\n\", pPDE);</span></pre></td></tr><tr><td data-num=\"93\"></td><td><pre>\t<span class=\"token comment\">//printf(\"%#010X\\n\", pPDE);</span></pre></td></tr><tr><td data-num=\"94\"></td><td><pre>\t<span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"g_Value=%#010X\\n\"</span><span class=\"token punctuation\">,</span> g_Value<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"95\"></td><td><pre>\t<span class=\"token function\">getchar</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"96\"></td><td><pre>\t<span class=\"token function\">VirtualFree</span><span class=\"token punctuation\">(</span>p1<span class=\"token punctuation\">,</span> <span class=\"token number\">0x1000</span><span class=\"token punctuation\">,</span> MEM_COMMIT <span class=\"token operator\">|</span> MEM_RESERVE<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"97\"></td><td><pre>\t<span class=\"token function\">VirtualFree</span><span class=\"token punctuation\">(</span>p2<span class=\"token punctuation\">,</span> <span class=\"token number\">0x1000</span><span class=\"token punctuation\">,</span> MEM_COMMIT <span class=\"token operator\">|</span> MEM_RESERVE<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"98\"></td><td><pre>\t<span class=\"token keyword\">return</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"99\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p><code>or ecx,0x100</code>  ecx 中存储的是 PDE，进行或运算，使 G 位为 1，即开起全局页，这样进程（CR3）切换时，TLB 中的记录不会被刷新</p>\n<p><code>mov eax,cr3;</code>   <code>mov cr3,eax;</code>  刷新 CR3。</p>\n<p><code>INVLPG:</code>  使 TLB 数据失效。<br />\n这个指令与直接加载 CR3 的区别在于 CR3 是整个 TLB 都失效，并重新加载。<br />\nINVLPG 则是指定去失效某个页的 TLB。它是一个更细粒度的控制。</p>\n<h3 id=\"实验结果\"><a class=\"anchor\" href=\"#实验结果\">#</a> 实验结果</h3>\n<ul>\n<li><strong>不开启全局页，不刷新 CR3</strong></li>\n</ul>\n<p><img data-src=\"image002.png\" alt=\"\" /></p>\n<ul>\n<li><strong>不开启全局页，刷新 CR3</strong></li>\n</ul>\n<p><img data-src=\"image003.png\" alt=\"\" /></p>\n<ul>\n<li><strong>开启全局页，刷新 CR3</strong></li>\n</ul>\n<p><img data-src=\"image004.png\" alt=\"\" /></p>\n<ul>\n<li><strong>开启全局页，刷新 CR3，使用 INVLPG 指令</strong></li>\n</ul>\n<p><img data-src=\"image005.png\" alt=\"\" /></p>\n<h2 id=\"shadowwalker\"><a class=\"anchor\" href=\"#shadowwalker\">#</a> ShadowWalker</h2>\n<p>一种利用 TLB 机制实现内存隐藏的方式 ——ShadowWalker。这种技术利用了 TLB 会缓存线性地址到物理地址映射的特性，当 CRC 线程检查某段代码时，它使用的线性地址会缓存到 TLB 的数据页表缓存（Data-TLB）中。而当 EIP 运行到这段代码时，又会把代码的线性地址缓存到 TLB 的指令页表缓存（Instruction-TLB）中。这样 CPU 中就缓存了同一个地址的两份记录，CRC 线程从数据页表缓存中读取物理地址，EIP 执行流从指令页表缓存中读取物理地址，这两个物理地址是相同的。</p>\n<p>ShadowWalker 技术的核心就在于修改指令页表缓存中的物理地址，让 CRC 线程读取原来的代码，而程序真正执行的时候则跳转到其他代码。</p>\n<p>这种方式在 3 环是不稳定的，原因是 TLB 经常刷新。</p>\n<p>复现暂时先鸽了。</p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cuY25ibG9ncy5jb20vbGVpYnNvLWN5L3AvMTE3MTkyODEuaHRtbA==\">https://www.cnblogs.com/leibso-cy/p/11719281.html</span></p>\n<h1 id=\"reference\"><a class=\"anchor\" href=\"#reference\">#</a> Reference</h1>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQxOTg4NDQ4L2FydGljbGUvZGV0YWlscy8xMDI3MzYwNjI=\">https://blog.csdn.net/qq_41988448/article/details/102736062</span><br />\n<span class=\"exturl\" data-url=\"aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L0t3YW5zeS9hcnRpY2xlL2RldGFpbHMvMTA4OTY1MTk2\">https://blog.csdn.net/Kwansy/article/details/108965196</span><br />\n<span class=\"exturl\" data-url=\"aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L0t3YW5zeS9hcnRpY2xlL2RldGFpbHMvMTA5MDEzMTUy\">https://blog.csdn.net/Kwansy/article/details/109013152</span></p>\n",
            "tags": [
                "TLB",
                "INVLPG指令",
                "全局页",
                "ShadowWalker"
            ]
        },
        {
            "id": "https://or0kit.github.io/Bin/Core/WindowsXp/Protect-Mode/%E4%BF%9D%E6%8A%A4%E6%A8%A1%E5%BC%8F-2-9-9-12%E5%88%86%E9%A1%B5/",
            "url": "https://or0kit.github.io/Bin/Core/WindowsXp/Protect-Mode/%E4%BF%9D%E6%8A%A4%E6%A8%A1%E5%BC%8F-2-9-9-12%E5%88%86%E9%A1%B5/",
            "title": "保护模式-2-9-9-12分页",
            "date_published": "2021-08-31T14:19:22.000Z",
            "content_html": "<h1 id=\"10-10-12-分页的寻址范围\"><a class=\"anchor\" href=\"#10-10-12-分页的寻址范围\">#</a> 10-10-12 分页的寻址范围</h1>\n<p>在之前的学习中，有一个课后思考题：10-10-12 分页模式物理内存能够识别的最多范围是多少？<br />\n我们当时是怎么算的呢？很简单嘛，有 1024 个页表，每个页表有 1024 个物理页，每个物理页有 4KB，那不就是 1024 * 1024 * 4KB = 4GB 吗？！<br />\n答案确实是 4GB，但很遗憾，如果你是这样算的，那你对 10-10-12 分页就还没有理解到位。<br />\n更有甚者可能会说，32 位系统，2^32=4GB，所以寻址范围是 4GB，这就更加错的离谱。</p>\n<p>实际上，决定物理内存寻址范围的是页表项 PTE。</p>\n<p><img data-src=\"image001.png\" alt=\"\" /></p>\n<p>PTE 的低 12 位是属性；高 20 位是基址，低 12 位补零后构成了<strong>物理页基址</strong>。所以，物理地址的寻址范围是由 PTE 构成的这 32 位物理页基址决定的，4GB 是从这里来的。</p>\n<p><strong>注意，线程的 4GB 和物理地址寻址范围的 4GB 不是一个东西。</strong> 物理地址寻址的 4GB 我们刚才已经解释过，是由 PTE 决定的。而线程的 4GB 其实指的是 32 位线性地址确定的，这个才是和 32 位系统相关的，和分页模式无关，32 位系统的线性地址就是 32 位。</p>\n<h1 id=\"10-10-12-分页的缺点\"><a class=\"anchor\" href=\"#10-10-12-分页的缺点\">#</a> 10-10-12 分页的缺点</h1>\n<p>缺点就是物理地址寻址范围太小了，只有 4GB。随着硬件的发展，物理内存已经超过 4GB 了，所以我们需要一种新的分页模式来映射更多的物理内存，2-9-9-12 分页又称为 PAE（物理地址扩展）分页就应运而生了。</p>\n<h1 id=\"2-9-9-12-分页\"><a class=\"anchor\" href=\"#2-9-9-12-分页\">#</a> 2-9-9-12 分页</h1>\n<p>2-9-9-12 分页将物理地址寻址范围扩大到 2^36=64GB。</p>\n<h1 id=\"为什么是2-9-9-12\"><a class=\"anchor\" href=\"#为什么是2-9-9-12\">#</a> 为什么是 2-9-9-12</h1>\n<ul>\n<li>页的大小是确定的，4KB 不能随便改，所以 32 位的最后一部分就确定为了 12 位。</li>\n<li>如果想增大物理内存的访问范围，就需要增大 PTE，增大了多少呢？考虑对齐的因素，增加到 8 个字节，由于 PTE 增大了，而 PTT 表的大小没变，依然是 4KB，所以每张 PTT 表能放的 PTE 个数由原来的 1024 个减少到 512 个，512 等于 2 的 9 次方，因此 PTI=9</li>\n</ul>\n<p><img data-src=\"image003.png\" alt=\"\" /></p>\n<ul>\n<li>由于 2 的 9 次方个 PDE 就能找到所有的 PTT 表，因此 PDI=9</li>\n<li>分配到这里时，还剩下前 2 位未分配。与 10-10-12 不同，CR3 不直接指向 PDT 表，而是指向一张新的表，叫做 PDPT 表（页目录指针表），PDPT 表中的每一个成员叫做 PDPTE（Page-Directory-Point-Table Entry，页目录指针表项），每项占 8 个字节。PDPT 表只有 4 个成员，因为 2 位比特位只能满足四种情况： <code>00 01 10 11</code> 。</li>\n</ul>\n<p>2-9-9-12 分页结构图</p>\n<p><img data-src=\"image002.png\" alt=\"\" /></p>\n<h1 id=\"pdpte\"><a class=\"anchor\" href=\"#pdpte\">#</a> PDPTE</h1>\n<p><img data-src=\"image004.png\" alt=\"\" /></p>\n<p><code>P位</code> ：第 0 位，有效位<br />\n <code>Avail</code> ：这部分供操作系统软件随意使用，CPU 不使用<br />\n <code>Base Addr</code> ：指向 PDT 表地址，由两部分组成</p>\n<blockquote>\n<p>第一部分：高四字节 32~35 位<br />\n第二部分：低 4 字节 12~31 位<br />\n这两部分加起来共 24 位，后 12 位补 0</p>\n</blockquote>\n<p><code>灰色部分</code> ：保留位</p>\n<p>PWT 位与 PCD 位下节学。</p>\n<h1 id=\"pde\"><a class=\"anchor\" href=\"#pde\">#</a> PDE</h1>\n<p><img data-src=\"image005.png\" alt=\"\" /></p>\n<p>低二十一位是对齐用的，所以每一页为 2^21=2MB。</p>\n<p>PAT 位：页属性表<br />\n只有当 PS=1 时，PAT 位才是有意义的（页属性表只针对页）<br />\n具体含义用到时再查资吧。</p>\n<p>注意：</p>\n<blockquote>\n<p>G 位、PCD 位、PWT 位可以暂且不管。<br />\n其他属性位的含义在上面学习 PDPTE 时或在学习 10-10-12 分页的 PDE 与 PTE 时已经介绍，这里不再详述</p>\n</blockquote>\n<h1 id=\"pte\"><a class=\"anchor\" href=\"#pte\">#</a> PTE</h1>\n<p><img data-src=\"image006.png\" alt=\"\" /></p>\n<p>特别说明：</p>\n<blockquote>\n<p>PTE 中 35-12 是物理页基址，24 位，低 12 位补 0<br />\n 物理页基址 + 12 位的页内偏移指向具体数据</p>\n</blockquote>\n<h1 id=\"xd标志位amd中称为nx即no-excetion\"><a class=\"anchor\" href=\"#xd标志位amd中称为nx即no-excetion\">#</a> XD 标志位（AMD 中称为 NX, 即 No Excetion ）</h1>\n<p>PDE/PTE 结构</p>\n<p><img data-src=\"image007.png\" alt=\"\" /></p>\n<p>段的属性有可读、可写和可执行</p>\n<p>页的属性有可读、可写</p>\n<p>当 RET 执行返回的时候，如果我修改堆栈里面的数据指向一个我提前准备<br />\n好的数据（把数据当作代码来执行，漏洞都是依赖这点，比如 SQL 注入也是）</p>\n<p>所以，Intel 就做了硬件保护，做了一个不可执行位，XD=1 时。那么你的软件溢出<br />\n了也没有关系，即使你的 EIP 蹦到了危险的 “数据区”，也是不可以执行的！</p>\n<p>在 PAE 分页模式下，PDE 与 PTE 的最高位为 XD/NX 位.</p>\n<h1 id=\"实验\"><a class=\"anchor\" href=\"#实验\">#</a> 实验</h1>\n<h2 id=\"在2-9-9-12分页模式下寻找物理地址\"><a class=\"anchor\" href=\"#在2-9-9-12分页模式下寻找物理地址\">#</a> 在 2-9-9-12 分页模式下寻找物理地址</h2>\n<p>老办法利用 CE 查找</p>\n<p><img data-src=\"image008.png\" alt=\"\" /></p>\n<p>按照 2-9-9-12 拆分 <code>000B1C18</code></p>\n<p>00<br />\n0 0000 0000<br />\n0 1011 0001</p>\n<p>2-9-9-12: <code>0-0-B1-C18</code></p>\n<p>在 windbg 中查找</p>\n<p>其中 notepad.exe 的 CR3 为： <code>0aac01a0</code></p>\n<p>在 windbg 中执行：<br />\n <code>!dq 0aac01a0</code></p>\n<p><img data-src=\"image009.png\" alt=\"\" /></p>\n<p><code>!dq 2bdcd000</code></p>\n<p><img data-src=\"image010.png\" alt=\"\" /></p>\n<p><code>!dq 2bdc8000 + b1*8</code></p>\n<p><img data-src=\"image011.png\" alt=\"\" /></p>\n<p><code>!db 2be1f000 + C18</code></p>\n<p><img data-src=\"image012.png\" alt=\"\" /></p>\n<h2 id=\"给0地址挂物理页\"><a class=\"anchor\" href=\"#给0地址挂物理页\">#</a> 给 0 地址挂物理页</h2>\n<p>代码</p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span><span class=\"token string\">&lt;stdio.h></span></span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">int</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> argc<span class=\"token punctuation\">,</span><span class=\"token keyword\">char</span><span class=\"token operator\">*</span> argv<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>\t<span class=\"token keyword\">unsigned</span> <span class=\"token keyword\">int</span><span class=\"token operator\">*</span> p <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>\t<span class=\"token keyword\">unsigned</span> <span class=\"token keyword\">int</span> a <span class=\"token operator\">=</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>\t<span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"a Value Adress:%p\\n\"</span><span class=\"token punctuation\">,</span><span class=\"token operator\">&amp;</span>a<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\t<span class=\"token function\">getchar</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>\t<span class=\"token operator\">*</span>p <span class=\"token operator\">=</span> <span class=\"token number\">0x666</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>\t<span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"p Value;%x\"</span><span class=\"token punctuation\">,</span><span class=\"token operator\">*</span>p<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>\t<span class=\"token function\">getchar</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>\t<span class=\"token keyword\">return</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>程序的 CR3： <code>0aac02c0</code></p>\n<p>直接用 <code>!vtop</code>  命令了，不在手动拆分了。</p>\n<p>0 和 0012ff54 地址对应的 PDPE、PDE、PTE</p>\n<p><img data-src=\"image013.png\" alt=\"\" /></p>\n<p>这里就把 0 地址 PTE 指向的物理页修改为变量 aPTE 指向的物理页了。</p>\n<p><img data-src=\"image014.png\" alt=\"\" /></p>\n<p>没有！eq 命令，这里要用！ed, 注意地址在内存中的排序。</p>\n<p><code>!ed ac168000 acdb2867</code> <br />\n <code>!ed ac168004 80000000</code></p>\n<p><img data-src=\"image014.png\" alt=\"\" /></p>\n<p>成功！</p>\n<h2 id=\"逆向分析mmisaddressvalid函数2-9-9-12\"><a class=\"anchor\" href=\"#逆向分析mmisaddressvalid函数2-9-9-12\">#</a> 逆向分析 MmIsAddressValid 函数 (2-9-9-12)</h2>\n<p><img data-src=\"image015.png\" alt=\"\" /></p>\n<ul>\n<li>\n<p>学习操作系统是如何判断线性地址有效的。</p>\n</li>\n<li>\n<p>学习操作系统是如何找到 PDE、PTE 的，与之相关的汇编代码我们可以用到。也可以把汇编转成 C。</p>\n</li>\n</ul>\n<pre><code>mov     eax, VirtualAddress;\nshr     eax, 12h        ; 右移18位，相当于右移21位取PDI,然后乘以8，即再左移3位。\nand     eax, 3FF8h        ; 与操作，取 eax = PDPTI * 4KB + PDI * 8\nsub     eax, 3FA00000h  ; eax = C0600000 + PDPTI * 4KB + PDI * 8\n\t\t\t\t\t\t; eax 指向了 PDE\n</code></pre>\n<pre><code>mov     ecx, VirtualAddress;\nshr     ecx, 9          ; 相当于右移12位，然后乘以8\nand     ecx, 7FFFF8h    ; ecx = PDPTI * 2MB + PDI * 4KB + PTI * 8\nsub     ecx, 40000000h  ; ecx = C0000000 + PDPTI * 2MB + PDI * 4KB + PTI * 8\n\t\t                ; ecx 指向 PTE\n</code></pre>\n<h3 id=\"内存中的2-9-9-12分页结构图\"><a class=\"anchor\" href=\"#内存中的2-9-9-12分页结构图\">#</a> 内存中的 2-9-9-12 分页结构图</h3>\n<p>由 <strong>逆向分析 MmIsAddressValid 函数 (2-9-9-12)</strong> 可以联想到内存中的 2-9-9-12 分页结构图</p>\n<p><img data-src=\"image016.png\" alt=\"\" /></p>\n<p>总结如下:\t<br />\n1. 第三个 PDPTE 指向了一个 PDT 表，此表的前四项 指向了 PDPTE 的每一个元素<br />\n 2. 根据计算 C0600000 的最大索引，不会超过 C0604000</p>\n<pre><code class=\"language-asm\">\t \t\t\t\t\t\t\t\t\t\t\t\t mov     edi, edi\n\t.text:0043C92A 55                                push    ebp\n\t.text:0043C92B 8B EC                             mov     ebp, esp\n\t.text:0043C92D 51                                push    ecx\n\t.text:0043C92E 51                                push    ecx\n\t.text:0043C92F 8B 4D 08                          mov     ecx, [ebp+VirtualAddress]\n\t.text:0043C932 56                                push    esi\n\t.text:0043C933 8B C1                             mov     eax, ecx\n\t.text:0043C935 C1 E8 12                          shr     eax, 12h\n\t.text:0043C938 BE F8 3F 00 00                    mov     esi, 3FF8h\n\t.text:0043C93D 23 C6                             and     eax, esi\n\t.text:0043C93F 2D 00 00 A0 3F                    sub     eax, 3FA00000h\n</code></pre>\n<p><code>线性地址 &gt;&gt;18 +C0600000</code>  也就是说。得出的索引是 <code>2^14</code> ，最大值 <code>4000H</code>  实际应用从 0 开始，也就是  <code>4000H-(1*8byte)</code> <br />\n 那么得到最后一个 PDE 也就是 <code>C06003FFE8</code></p>\n<p>由此可推出</p>\n<blockquote>\n<p>C0600000 是第一个 PDT 表的首地址<br />\n C0601000 是第二个 PDT 表的首地址<br />\n C0602000 是第三个 PDT 表的首地址<br />\n C0603000 是第四个 PDT 表的首地址</p>\n</blockquote>\n<p>2-9-9-12 分页下</p>\n<p>总结进程的 0xC06000000-0xC0603000 线性地址对应的物理页分别存储第一个 PDT 表到第 4 个 PDT 表</p>\n<p>而通过当前进程 CR3 指向 PDPT 表只有四项，每项指向一 PDT 表基址</p>\n<p>第一个 PDT 表可以寻址 0x00000000-0x3FFFFFFF           这个 PDT 表映射的线性地址是 0xC0600000</p>\n<p>第二个 PDT 表可以寻址 0x40000000-0x7FFFFFFF           这个 PDT 表映射的线性地址是 0xC0601000</p>\n<p>第三个 PDT 表可以寻址 0x80000000-0xBFFFFFFF           这个 PDT 表映射的线性地址是 0xC0602000</p>\n<p>第四个 PDT 表可以寻址 0xC0000000-0xFFFFFFFF          这个 PDT 表映射的线性地址是 0xC0603000</p>\n<p>注意的是仔细看上面第 0xC0600000 地址拆分的时候可以看到这个线性地址对应物理页既是的 PDT 表有是 PTT 表</p>\n<p>本来就是 2-9-9-12PTT 表有  4KB*512*4=8M 线性地址存储，还有 4 个 PDT，这四个 PDT 存储在 0xC0600000-0xC0603000</p>\n<p>这个四个 PDT 表都既是 PDT 也是 PTT 表，否则 8M 的内存是不够的</p>\n<p>具体内容参考原文，链接为：<span class=\"exturl\" data-url=\"aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3Rhb2xhb2Rhd2hvL2FydGljbGUvZGV0YWlscy8xMDkxODM4ODM=\">https://blog.csdn.net/taolaodawho/article/details/109183883</span></p>\n<h2 id=\"测试xd位\"><a class=\"anchor\" href=\"#测试xd位\">#</a> 测试 XD 位</h2>\n<p>CPU 可读 可写 可执行判断</p>\n<p>可读 可写的判断</p>\n<blockquote>\n<p>mov eax,ebx</p>\n</blockquote>\n<p>ebx 就是要进行可读判断 eax 进行可写判断</p>\n<blockquote>\n<p>jmp 0x12345678 // 可以修改 EIP 的指令都会进行可执行判断</p>\n</blockquote>\n<p>可执行判断，如果 PDE PTE 其中任何一个的最高位是 1 那么这个指令就会执行失败。</p>\n<p>代码转自<span class=\"exturl\" data-url=\"aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L0t3YW5zeS9hcnRpY2xlL2RldGFpbHMvMTA4OTY1MTk2\"> https://blog.csdn.net/Kwansy/article/details/108965196</span></p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;stdio.h></span></span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;Windows.h></span></span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">char</span> <span class=\"token operator\">*</span>buff<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>DWORD <span class=\"token operator\">*</span><span class=\"token function\">GetPDE</span><span class=\"token punctuation\">(</span>DWORD addr<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>\t<span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span>DWORD <span class=\"token operator\">*</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span><span class=\"token number\">0xc0600000</span> <span class=\"token operator\">+</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>addr <span class=\"token operator\">>></span> <span class=\"token number\">18</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;</span> <span class=\"token number\">0x3ff8</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\t<span class=\"token comment\">//DWORD PDPTI = addr >> 30;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\t<span class=\"token comment\">//DWORD PDI = (addr >> 21) &amp; 0x000001FF;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>\t<span class=\"token comment\">//DWORD PTI = (addr >> 12) &amp; 0x000001FF;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>\t<span class=\"token comment\">//return (DWORD *)(0xC0600000 + PDPTI * 0x1000 + PDI * 8);</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>DWORD <span class=\"token operator\">*</span><span class=\"token function\">GetPTE</span><span class=\"token punctuation\">(</span>DWORD addr<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>\t<span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span>DWORD <span class=\"token operator\">*</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span><span class=\"token number\">0xc0000000</span> <span class=\"token operator\">+</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>addr <span class=\"token operator\">>></span> <span class=\"token number\">9</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;</span> <span class=\"token number\">0x7ffff8</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>\t<span class=\"token comment\">//DWORD PDPTI = addr >> 30;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>\t<span class=\"token comment\">//DWORD PDI = (addr >> 21) &amp; 0x000001FF;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>\t<span class=\"token comment\">//DWORD PTI = (addr >> 12) &amp; 0x000001FF;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>\t<span class=\"token comment\">//return (DWORD *)(0xC0000000 + PDPTI * 0x200000 + PDI * 0x1000 + PTI * 8);</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre></pre></td></tr><tr><td data-num=\"24\"></td><td><pre><span class=\"token keyword\">void</span> <span class=\"token function\">__declspec</span><span class=\"token punctuation\">(</span>naked<span class=\"token punctuation\">)</span> <span class=\"token function\">R0Function</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>\t__asm</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>\t\tpush ebp</pre></td></tr><tr><td data-num=\"29\"></td><td><pre>\t\t\tmov ebp<span class=\"token punctuation\">,</span>esp</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>\t\t\tsub esp<span class=\"token punctuation\">,</span><span class=\"token number\">0x1000</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>\t\t\tpushad</pre></td></tr><tr><td data-num=\"32\"></td><td><pre>\t\t\tpushfd\t\t</pre></td></tr><tr><td data-num=\"33\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>\t__asm push fs</pre></td></tr><tr><td data-num=\"35\"></td><td><pre>\t<span class=\"token comment\">//__asm int 3</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>\t<span class=\"token comment\">// 修改 buff 的 XD 位</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>\t<span class=\"token operator\">*</span><span class=\"token punctuation\">(</span><span class=\"token function\">GetPDE</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>DWORD<span class=\"token punctuation\">)</span>buff<span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">|=</span> <span class=\"token number\">0x80000000</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>\t<span class=\"token operator\">*</span><span class=\"token punctuation\">(</span><span class=\"token function\">GetPTE</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>DWORD<span class=\"token punctuation\">)</span>buff<span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">|=</span> <span class=\"token number\">0x80000000</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>\t<span class=\"token comment\">//__asm int 3</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>\t__asm pop fs</pre></td></tr><tr><td data-num=\"41\"></td><td><pre></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>\t__asm</pre></td></tr><tr><td data-num=\"43\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>\t\tpopfd</pre></td></tr><tr><td data-num=\"45\"></td><td><pre>\t\t\tpopad</pre></td></tr><tr><td data-num=\"46\"></td><td><pre>\t\t\tadd esp<span class=\"token punctuation\">,</span><span class=\"token number\">0x1000</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>\t\t\tmov esp<span class=\"token punctuation\">,</span>ebp</pre></td></tr><tr><td data-num=\"48\"></td><td><pre>\t\t\tpop ebp</pre></td></tr><tr><td data-num=\"49\"></td><td><pre>\t\t\tiretd</pre></td></tr><tr><td data-num=\"50\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre></pre></td></tr><tr><td data-num=\"53\"></td><td><pre><span class=\"token keyword\">int</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> argc<span class=\"token punctuation\">,</span> <span class=\"token keyword\">char</span><span class=\"token operator\">*</span> argv<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre>\tDWORD dwEAX <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>\tBYTE bytecode <span class=\"token punctuation\">[</span><span class=\"token number\">7</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span><span class=\"token number\">0x90</span><span class=\"token punctuation\">,</span><span class=\"token number\">0xB8</span><span class=\"token punctuation\">,</span><span class=\"token number\">0x01</span><span class=\"token punctuation\">,</span><span class=\"token number\">0x00</span><span class=\"token punctuation\">,</span><span class=\"token number\">0x00</span><span class=\"token punctuation\">,</span><span class=\"token number\">0x00</span><span class=\"token punctuation\">,</span><span class=\"token number\">0xC3</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// NOP, MOV EAX,1, RET</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre>\t<span class=\"token keyword\">int</span> xd<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre>\t<span class=\"token comment\">// 申请一个内存页，写入硬编码</span></pre></td></tr><tr><td data-num=\"59\"></td><td><pre>\tbuff <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">char</span> <span class=\"token operator\">*</span><span class=\"token punctuation\">)</span><span class=\"token function\">VirtualAlloc</span><span class=\"token punctuation\">(</span><span class=\"token constant\">NULL</span><span class=\"token punctuation\">,</span><span class=\"token number\">0x1000</span><span class=\"token punctuation\">,</span>MEM_COMMIT<span class=\"token punctuation\">,</span>PAGE_EXECUTE_READWRITE<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre>\t<span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"buff: %p\\n\"</span><span class=\"token punctuation\">,</span> buff<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"61\"></td><td><pre></pre></td></tr><tr><td data-num=\"62\"></td><td><pre>\t<span class=\"token function\">memcpy</span><span class=\"token punctuation\">(</span>buff<span class=\"token punctuation\">,</span>bytecode<span class=\"token punctuation\">,</span><span class=\"token number\">7</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"63\"></td><td><pre></pre></td></tr><tr><td data-num=\"64\"></td><td><pre>\t<span class=\"token comment\">// 测试，对比 XD=0 和 XD=1 的运行结果</span></pre></td></tr><tr><td data-num=\"65\"></td><td><pre>\t<span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"输入XD位：\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"66\"></td><td><pre>\t<span class=\"token function\">scanf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"%d\"</span><span class=\"token punctuation\">,</span><span class=\"token operator\">&amp;</span>xd<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// 输入 0 可以调用，输入 1 调用失败</span></pre></td></tr><tr><td data-num=\"67\"></td><td><pre>\t<span class=\"token function\">getchar</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"68\"></td><td><pre></pre></td></tr><tr><td data-num=\"69\"></td><td><pre>\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>xd <span class=\"token operator\">==</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"70\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"71\"></td><td><pre>\t\t<span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"在IDT表构建中断门，请在windbg中执行下面的指令：\\n\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"72\"></td><td><pre>\t\t<span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"eq 8003f500 %04xee00`0008%04x\\n\"</span><span class=\"token punctuation\">,</span><span class=\"token punctuation\">(</span>DWORD<span class=\"token punctuation\">)</span>R0Function<span class=\"token operator\">>></span><span class=\"token number\">16</span><span class=\"token punctuation\">,</span><span class=\"token punctuation\">(</span>DWORD<span class=\"token punctuation\">)</span>R0Function <span class=\"token operator\">&amp;</span> <span class=\"token number\">0x0000FFFF</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"73\"></td><td><pre>\t\t<span class=\"token function\">getchar</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"74\"></td><td><pre>\t\t__asm <span class=\"token keyword\">int</span> <span class=\"token number\">0x20</span></pre></td></tr><tr><td data-num=\"75\"></td><td><pre>\t\t<span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"XD位修改成功，buff不可执行.\\n\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"76\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"77\"></td><td><pre>\t__asm</pre></td></tr><tr><td data-num=\"78\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"79\"></td><td><pre>\t\t\tpush eax</pre></td></tr><tr><td data-num=\"80\"></td><td><pre>\t\t\txor eax<span class=\"token punctuation\">,</span>eax</pre></td></tr><tr><td data-num=\"81\"></td><td><pre>\t\t\tcall buff</pre></td></tr><tr><td data-num=\"82\"></td><td><pre>\t\t\tmov dwEAX<span class=\"token punctuation\">,</span>eax</pre></td></tr><tr><td data-num=\"83\"></td><td><pre>\t\t\tpop eax</pre></td></tr><tr><td data-num=\"84\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"85\"></td><td><pre>\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>dwEAX <span class=\"token operator\">==</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"调用失败.\\n\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"86\"></td><td><pre>\t<span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>dwEAX <span class=\"token operator\">==</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"调用成功.\\n\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"87\"></td><td><pre>\t<span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"bye!\\n\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"88\"></td><td><pre>\t<span class=\"token function\">getchar</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"89\"></td><td><pre>\t<span class=\"token keyword\">return</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"90\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>如果将 XD 修改为 1，那么执行 CALL 会失败，程序会卡死。</p>\n<p><img data-src=\"image018.png\" alt=\"\" /></p>\n<p>如果 XD=0，就是默认情况了，可以正常调用函数并返回。</p>\n<p><img data-src=\"image019.png\" alt=\"\" /></p>\n<h1 id=\"windbg中查看0xc0000000与0xc0600000\"><a class=\"anchor\" href=\"#windbg中查看0xc0000000与0xc0600000\">#</a> windbg 中查看 0xC0000000 与 0xC0600000</h1>\n<p>其中 <code>0aac0300</code>  是 CR3。<br />\n <code>!vtop 0aac0300</code>  查看 0 地址的分页</p>\n<p><img data-src=\"image020.png\" alt=\"\" /></p>\n<p>可以发现这两个地址的特殊性， <code>0xC0600000</code>  所在的物理页既是 PDE 也是 PTE 还是物理页， <code>0xC0000000</code>  所在的物理页既是 PTE 还是物理页。</p>\n<p><img data-src=\"image021.png\" alt=\"\" /></p>\n<p><code>0xC0600000</code>  所在的物理页是 0 地址的 PDE</p>\n<p><img data-src=\"image022.png\" alt=\"\" /></p>\n<p><code>0xC0000000</code>  所在的物理页是 0 地址的 PTE</p>\n<h1 id=\"reference\"><a class=\"anchor\" href=\"#reference\">#</a> Reference</h1>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L0t3YW5zeS9hcnRpY2xlL2RldGFpbHMvMTA4OTU2OTcx\">https://blog.csdn.net/Kwansy/article/details/108956971</span><br />\n<span class=\"exturl\" data-url=\"aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQxOTg4NDQ4L2FydGljbGUvZGV0YWlscy8xMDI3MDk0NzA=\">https://blog.csdn.net/qq_41988448/article/details/102709470</span><br />\n<span class=\"exturl\" data-url=\"aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L0t3YW5zeS9hcnRpY2xlL2RldGFpbHMvMTA4OTY1MTk2\">https://blog.csdn.net/Kwansy/article/details/108965196</span><br />\n 页机制和 2-9-9-12 分页线性地址页表之间的映射关系<span class=\"exturl\" data-url=\"aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3Rhb2xhb2Rhd2hvL2FydGljbGUvZGV0YWlscy8xMDkxODM4ODM=\"> https://blog.csdn.net/taolaodawho/article/details/109183883</span></p>\n",
            "tags": [
                "2-9-9-12分页",
                "PAE",
                "PDPTE",
                "PDE",
                "PTE",
                "XD标志位",
                "逆向分析MmIsAddressValid函数(2-9-9-12)"
            ]
        },
        {
            "id": "https://or0kit.github.io/Bin/Core/WindowsXp/Protect-Mode/%E4%BF%9D%E6%8A%A4%E6%A8%A1%E5%BC%8F-%E9%80%86%E5%90%91%E5%88%86%E6%9E%90MmIsAddressValid%E5%87%BD%E6%95%B0-10-10-12/",
            "url": "https://or0kit.github.io/Bin/Core/WindowsXp/Protect-Mode/%E4%BF%9D%E6%8A%A4%E6%A8%A1%E5%BC%8F-%E9%80%86%E5%90%91%E5%88%86%E6%9E%90MmIsAddressValid%E5%87%BD%E6%95%B0-10-10-12/",
            "title": "保护模式-逆向分析MmIsAddressValid函数(10-10-12)",
            "date_published": "2021-08-30T06:17:30.000Z",
            "content_html": "<h1 id=\"逆向分析mmisaddressvalid函数\"><a class=\"anchor\" href=\"#逆向分析mmisaddressvalid函数\">#</a> 逆向分析 MmIsAddressValid 函数</h1>\n<h2 id=\"找到-mmisaddressvalid-函数\"><a class=\"anchor\" href=\"#找到-mmisaddressvalid-函数\">#</a> 找到 MmIsAddressValid 函数</h2>\n<p>方法一：在 windbg 中输入  <code>u MmIsAddressValid l1A</code></p>\n<p><img data-src=\"image001.png\" alt=\"\" /></p>\n<p>方法二：在 c:\\windows\\system32\\ 中找到内核程序，用 IDA 分析。</p>\n<p>ntkrnlpa.exe 2-9-9-12 分页内核<br />\n ntoskrnl.exe 10-10-12 分页内核</p>\n<p>打开 ntoskrnl.exe 后，加载 pdb 文件，即可查看函数名称。</p>\n<p><img data-src=\"image002.png\" alt=\"\" /></p>\n<h2 id=\"分析代码\"><a class=\"anchor\" href=\"#分析代码\">#</a> 分析代码</h2>\n<p>分析前，先聊聊函数头的 MOV EDI,EDI 指令。这条指令看起来什么也没做，但是很多系统函数开头都有这条指令，why？其实这是为了实现对函数行为的动态修改（热补丁），可以一下这篇文章 <span class=\"exturl\" data-url=\"aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3N3YW5hYmluL2FydGljbGUvZGV0YWlscy8xNzU1MDg5Nw==\">函数开始处的 MOV EDI, EDI 的作用</span></p>\n<p><img data-src=\"image003.png\" alt=\"\" /></p>\n<p>函数主要是检测 P 位是否有效。<br />\nPAT 还没学，就不多逆了。</p>\n<h2 id=\"总结\"><a class=\"anchor\" href=\"#总结\">#</a> 总结</h2>\n<p>学习操作系统的汇编算法。</p>\n<h1 id=\"reference\"><a class=\"anchor\" href=\"#reference\">#</a> Reference</h1>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L0t3YW5zeS9hcnRpY2xlL2RldGFpbHMvMTA4OTQ1MDY4\">https://blog.csdn.net/Kwansy/article/details/108945068</span></p>\n",
            "tags": [
                "逆向分析MmIsAddressValid函数"
            ]
        },
        {
            "id": "https://or0kit.github.io/Bin/Core/WindowsXp/Protect-Mode/%E4%BF%9D%E6%8A%A4%E6%A8%A1%E5%BC%8F-%E6%89%A9%E5%B1%95-%E4%BD%BF%E7%94%A8LDT/",
            "url": "https://or0kit.github.io/Bin/Core/WindowsXp/Protect-Mode/%E4%BF%9D%E6%8A%A4%E6%A8%A1%E5%BC%8F-%E6%89%A9%E5%B1%95-%E4%BD%BF%E7%94%A8LDT/",
            "title": "保护模式-扩展-使用LDT",
            "date_published": "2021-08-29T07:24:10.000Z",
            "content_html": "<h1 id=\"楔子\"><a class=\"anchor\" href=\"#楔子\">#</a> 楔子</h1>\n<p>野路子出身，之前一直没看懂火哥的使用 LDT 的代码，看了看《x86/x64 体系探索及编程》研究了一下。</p>\n<h2 id=\"ldt\"><a class=\"anchor\" href=\"#ldt\">#</a> LDT</h2>\n<p>Local Descriptor Table 是其中的一个描述符表，LDT 由 LDTR 的 base 域进行定位。</p>\n<p><img data-src=\"image001.png\" alt=\"\" /></p>\n<p>LDTR 的结构与段寄存器的结构是完全一致的，包括：base、limit、attribute 域，以及 selector 域，base、limit 和 atribute 组成 LDTR 的 Cache 部分，也是隐藏不可见的。像段寄存器一样，LDTR 需要使用 LDT 描述符进行加载，LDT 描述符只能存放在 GDT 中。 <strong>32 位的 LDTR.base 值能让 LDT 定位在 4G 的线性地址空间任何位置。</strong> 在 64 位模式下，LDTR.base 被扩展为 64 位。</p>\n<h2 id=\"ldt描述符\"><a class=\"anchor\" href=\"#ldt描述符\">#</a> LDT 描述符</h2>\n<p>LDT 描述符属于系统级的描述符，它的结构与 TSS 完全一致。</p>\n<p><img data-src=\"image002.png\" alt=\"\" /></p>\n<p>LDT 描述符的类型是 0x02，S 标志位为 0 值，表示属于一个 system 描述符。</p>\n<h2 id=\"ldtr的加载\"><a class=\"anchor\" href=\"#ldtr的加载\">#</a> LDTR 的加载</h2>\n<p>系统使用 LLDT 指令进行显式加载，或在进行任务切换时隐式地从 TSS 段里加载。</p>\n<p><code>mov ax, LDT_SEL ; LDT selector</code> <br />\n <code>lldt ax </code></p>\n<p><span class=\"label primary\">lldt 指令执行在 0 级权限里。处理器会检查以下内容:</span></p>\n<blockquote>\n<p><strong>selector 检查</strong></p>\n</blockquote>\n<blockquote>\n<p>对 selector 检查两个方面。</p>\n<ul>\n<li>如果提供的 selector 是 Null selector，则会产生 #GP 异常。</li>\n<li>如果 selector.TI=1，表示在 LDT 里，将产生 #GP 异常。</li>\n</ul>\n</blockquote>\n<blockquote>\n<p><strong>limit 检查</strong></p>\n</blockquote>\n<blockquote>\n<p>selector 是否超出 GDT limit 值。也就是 0x3ff。</p>\n</blockquote>\n<blockquote>\n<p><strong>LDT 描述符类型检查</strong></p>\n</blockquote>\n<blockquote>\n<p>能被加载到 LDTR 里的描述符必须如下。</p>\n<ul>\n<li>s 标志为 0，属于 system 描述符。</li>\n<li>P 标志为 1，表示在内存中。</li>\n<li>Type 值为 0x02，它是 LDT 描述符。</li>\n</ul>\n</blockquote>\n<h2 id=\"构ldt造段描述符\"><a class=\"anchor\" href=\"#构ldt造段描述符\">#</a> 构 LDT 造段描述符</h2>\n<p>让 base=0x00000000，limit=0x3ff。<br />\nLDT 段描述符： <code>0000e200`000003ff</code></p>\n<h2 id=\"实验\"><a class=\"anchor\" href=\"#实验\">#</a> 实验</h2>\n<p>知道了理论我们来实际使用一下。</p>\n<p>火哥说把权限转移到 LDT 表中，写保护时别人很难检测…… 小白不懂，扩展一下思路。</p>\n<p><span class=\"label primary\">这里有一个小细节需要注意:</span></p>\n<p><img data-src=\"image003.png\" alt=\"\" /></p>\n<p>其中红色箭头所指的内容，才是数据在计算机中的真实样子，其余的几种是 windbg 以数据宽度排好显示的。构建段描述符时要注意。<br />\n这是大端序、小段序排列的原因。</p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span><span class=\"token string\">&lt;stdio.h></span></span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">unsigned</span> <span class=\"token keyword\">char</span> dwLDT<span class=\"token punctuation\">[</span><span class=\"token number\">0x3ff</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span> <span class=\"token number\">0</span> <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token comment\">// 这里为什么用 6 个字节存储 GDT 的地址我也不清楚</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token keyword\">unsigned</span> <span class=\"token keyword\">char</span> GDTAddress<span class=\"token punctuation\">[</span><span class=\"token number\">6</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span> <span class=\"token number\">0</span> <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token function\">__declspec</span><span class=\"token punctuation\">(</span>naked<span class=\"token punctuation\">)</span> <span class=\"token keyword\">void</span> <span class=\"token function\">Func</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\t__asm <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>\t\tpushad<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>\t\tpushfd<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>\t\t<span class=\"token comment\">// 取 GDT 表的地址</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>\t\tlea eax<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span>GDTAddress <span class=\"token operator\">+</span> <span class=\"token number\">2</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>\t\tmov eax<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span>eax<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>\t\t<span class=\"token comment\">//eax = 8003f090</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>\t\tlea eax<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span>eax <span class=\"token operator\">+</span> <span class=\"token number\">0x90</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>\t\t<span class=\"token comment\">// 取定义的 dwLDT 的地址 本程序中是 0X00417138，ecx = 00417138</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>\t\tlea ecx<span class=\"token punctuation\">,</span> dwLDT<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>\t\t<span class=\"token comment\">// 将 7138 放进 ebx 的低 16 位中，bx =  7138</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>\t\tmov bx<span class=\"token punctuation\">,</span> cx<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>\t\t<span class=\"token comment\">// 左移 16 位，将 7138 放进 ebx 的高 16 位中 ebx = 71380000</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>\t\tshl ebx<span class=\"token punctuation\">,</span> <span class=\"token number\">0x10</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>\t\t<span class=\"token comment\">// 把 0x03ff 放进 ebx 的低 16 位中，此时 ebx 的值为 0x713803ff</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>\t\tmov bx<span class=\"token punctuation\">,</span> <span class=\"token number\">0x03ff</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>\t\t<span class=\"token comment\">// 给地址为 0x8003f090 内存空间赋值为： ff 03 38 71 </span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>\t\tmov dword ptr ds <span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>eax<span class=\"token punctuation\">]</span> <span class=\"token punctuation\">,</span> ebx<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>\t\t<span class=\"token comment\">//eax 的值为 0x8003f094</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>\t\tlea eax<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span>eax <span class=\"token operator\">+</span> <span class=\"token number\">4</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>\t\t<span class=\"token comment\">// 右移 16 位，ecx 的值为 0x00000041</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>\t\tshr ecx<span class=\"token punctuation\">,</span> <span class=\"token number\">0x10</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>\t\t<span class=\"token comment\">// 给地址为 0x8003f094 内存赋值为 0x41</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>\t\tmov byte ptr ds <span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>eax<span class=\"token punctuation\">]</span> <span class=\"token punctuation\">,</span> cl<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>\t\t<span class=\"token comment\">// 给地址为 0x8003f095 内存赋值为 0x00e2</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>\t\tmov word ptr ds <span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>eax <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span> <span class=\"token punctuation\">,</span> <span class=\"token number\">0x00e2</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>\t\t<span class=\"token comment\">// 给地址为 0x8003f097 内存赋值为 0x</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>\t\tmov byte ptr ds <span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>eax <span class=\"token operator\">+</span> <span class=\"token number\">3</span><span class=\"token punctuation\">]</span> <span class=\"token punctuation\">,</span> ch<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>\t\t<span class=\"token comment\">// 加载 LDT，使 LDTR 装载 LDT 选择子</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>\t\tmov ax<span class=\"token punctuation\">,</span> <span class=\"token number\">0x93</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>\t\tlldt ax<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>\t\tpopfd<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>\t\tpopad<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>\t\tretf<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre></pre></td></tr><tr><td data-num=\"51\"></td><td><pre><span class=\"token keyword\">int</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> argc<span class=\"token punctuation\">,</span> <span class=\"token keyword\">char</span><span class=\"token operator\">*</span> argv<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre>\t<span class=\"token keyword\">unsigned</span> <span class=\"token keyword\">char</span> Selector<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span><span class=\"token number\">0x48</span><span class=\"token punctuation\">,</span><span class=\"token number\">0</span> <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span><span class=\"token comment\">// 准备调用门提权</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>\t<span class=\"token keyword\">unsigned</span> <span class=\"token keyword\">char</span> cLdtr <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span> <span class=\"token number\">0</span> <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre>\t<span class=\"token keyword\">int</span> a <span class=\"token operator\">=</span> <span class=\"token number\">10</span><span class=\"token punctuation\">,</span> b <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre>\t<span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"b=%d\\n\"</span><span class=\"token punctuation\">,</span>b<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>\t<span class=\"token operator\">*</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">unsigned</span> <span class=\"token keyword\">int</span><span class=\"token operator\">*</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span>dwLDT <span class=\"token operator\">+</span> <span class=\"token number\">8</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span> <span class=\"token number\">0x0000ffff</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre>\t<span class=\"token operator\">*</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">unsigned</span> <span class=\"token keyword\">int</span><span class=\"token operator\">*</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span>dwLDT <span class=\"token operator\">+</span> <span class=\"token number\">0xc</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span> <span class=\"token number\">0x00cff300</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre>\t<span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"windbg execute eq 8003f048 %04xec00`0008%04x\\n\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"59\"></td><td><pre>\t\t<span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">unsigned</span> <span class=\"token keyword\">int</span><span class=\"token punctuation\">)</span>Func <span class=\"token operator\">>></span> <span class=\"token number\">0x10</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;</span> <span class=\"token number\">0xffff</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre>\t\t<span class=\"token punctuation\">(</span><span class=\"token keyword\">unsigned</span> <span class=\"token keyword\">int</span><span class=\"token punctuation\">)</span>Func <span class=\"token operator\">&amp;</span> <span class=\"token number\">0xffff</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"61\"></td><td><pre>\t<span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"dwLDT Address:%#010X\\n\"</span><span class=\"token punctuation\">,</span> dwLDT<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"62\"></td><td><pre>\t<span class=\"token function\">getchar</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"63\"></td><td><pre>\t__asm <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"64\"></td><td><pre>\t\tsgdt GDTAddress<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"65\"></td><td><pre>\t\tpush fs<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"66\"></td><td><pre>\t\tcall fword ptr Selector<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"67\"></td><td><pre>\t\tsldt cLdtr<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"68\"></td><td><pre>\t\tpop fs<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"69\"></td><td><pre>\t\tmov ax<span class=\"token punctuation\">,</span> <span class=\"token number\">0x0f</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"70\"></td><td><pre>\t\tmov ds<span class=\"token punctuation\">,</span> ax<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"71\"></td><td><pre>\t\tmov eax<span class=\"token punctuation\">,</span> a<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"72\"></td><td><pre>\t\tmov b<span class=\"token punctuation\">,</span> eax<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"73\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"74\"></td><td><pre>\t<span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"b=%d\\n\"</span><span class=\"token punctuation\">,</span>b<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"75\"></td><td><pre>\t<span class=\"token function\">getchar</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"76\"></td><td><pre>\t<span class=\"token keyword\">return</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"77\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>调试过程中的截图</p>\n<p>程序执行完 <code>mov dword ptr ds : [eax] , ebx</code>  后，各寄存器的值与内存中 <code>0x8003f090</code>  处的数据</p>\n<p><img data-src=\"image004.png\" alt=\"\" /></p>\n<p>成功执行</p>\n<p><img data-src=\"image005.png\" alt=\"\" /></p>\n<p>修改一下 LDT 表中段描述符的 DPL<br />\n <code>*((unsigned int*)(dwLDT + 0xc)) = 0x00cff300;</code></p>\n<p>==&gt;&gt;</p>\n<p><code>*((unsigned int*)(dwLDT + 0xc)) = 0x00cf9300;</code></p>\n<p>执行结果：</p>\n<p><img data-src=\"image006.png\" alt=\"\" /></p>\n<p>权限异常。</p>\n<p>实验结束！</p>\n",
            "tags": [
                "LDT段描述符",
                "LDT"
            ]
        },
        {
            "id": "https://or0kit.github.io/Bin/Core/WindowsXp/Protect-Mode/%E4%BF%9D%E6%8A%A4%E6%A8%A1%E5%BC%8F-%E9%A1%B5%E7%9B%AE%E5%BD%95%E8%A1%A8%E4%B8%8E%E9%A1%B5%E8%A1%A8%E7%9A%84%E5%9F%BA%E5%9D%80/",
            "url": "https://or0kit.github.io/Bin/Core/WindowsXp/Protect-Mode/%E4%BF%9D%E6%8A%A4%E6%A8%A1%E5%BC%8F-%E9%A1%B5%E7%9B%AE%E5%BD%95%E8%A1%A8%E4%B8%8E%E9%A1%B5%E8%A1%A8%E7%9A%84%E5%9F%BA%E5%9D%80/",
            "title": "保护模式-页目录表与页表的基址",
            "date_published": "2021-08-29T06:16:49.000Z",
            "content_html": "<h1 id=\"楔子\"><a class=\"anchor\" href=\"#楔子\">#</a> 楔子</h1>\n<p>如果我们想填充 PDE 与 PTE，那么必须能够访问 PDT 与 PTT，这样就存在 2 个问题：</p>\n<ol>\n<li>一定已经有 “人” 为我们访问 PDT 与 PTT 挂好了 PDE 与 PTE, 我们只用找到这个线性地址就可以了</li>\n<li>这个为我们挂好 PDE 与 PTE 的 “人” 是谁？</li>\n</ol>\n<p>注意：<br />\nCR3 中存储的是物理地址，不能在程序中直接读取的。如果想读取，也要把 Cr3 的值挂到 PDT 和 PTT 中才能访问，那么怎么通过线性地址访问 PDT 和 PTT 呢？</p>\n<h1 id=\"页目录表基址\"><a class=\"anchor\" href=\"#页目录表基址\">#</a> 页目录表基址</h1>\n<p>页目录表基址 = 线性地址： <code>C0300000</code></p>\n<h2 id=\"实验拆分线性地址c0300000并查看其对应的物理页\"><a class=\"anchor\" href=\"#实验拆分线性地址c0300000并查看其对应的物理页\">#</a> 实验：拆分线性地址 C0300000，并查看其对应的物理页</h2>\n<p>随便使用某个程序的 CR3，访问线性地址 <code>C0300000</code>  的物理地址。</p>\n<p><img data-src=\"image001.png\" alt=\"\" /></p>\n<p>可以发现 <code>C0300000</code>  的物理页内容与 PDT 表完全相同。</p>\n<p><strong>实验总结</strong></p>\n<ul>\n<li>线性地址 C0300000 对应的物理页就是页目录表</li>\n<li>这个物理页即页目录表本身也是页表</li>\n<li>这个物理页是一张特殊的页表，每一项 PTE 指向的不是普通的物理页，而是指向其它的页表</li>\n<li>访问页目录表的公式：C0300000 + PDI*4（I=index）</li>\n</ul>\n<p>页目录表基址 (XP 系统 10-10-12 分页模式)</p>\n<p><img data-src=\"image002.png\" alt=\"\" /></p>\n<h1 id=\"页表基址\"><a class=\"anchor\" href=\"#页表基址\">#</a> 页表基址</h1>\n<p>页表基址 = 线性地址： <code>C0000000</code></p>\n<h2 id=\"实验拆分线性地址c0000000并查看其对应的物理页\"><a class=\"anchor\" href=\"#实验拆分线性地址c0000000并查看其对应的物理页\">#</a> 实验：拆分线性地址 C0000000，并查看其对应的物理页</h2>\n<p>随便使用某个程序的 CR3，访问线性地址 <code>C0000000</code>  的物理地址。</p>\n<p>查看第一个 PTE</p>\n<p><img data-src=\"image004.png\" alt=\"\" /></p>\n<p>可以发现 PTE 完全一样。</p>\n<p><img data-src=\"image003.png\" alt=\"\" /></p>\n<p>因为微软与新特尔协商，CR3 的值 + 0xC00 的的地址处存放的值还是 CR3 的值。所以访问线性地址 <code>C0000000</code>  就是找第一个 PTE 的地址。</p>\n<p><strong>实验总结</strong></p>\n<ul>\n<li>页表被映射到了从 0xC0000000~0xC03FFFFF 的 4M 地址空间</li>\n<li>在这 1024 个表中有一张特殊的表：页目录表，是第 0x300 张表。</li>\n<li>页目录被映射到了 0xC0300000 开始处的 4K 地址空间</li>\n<li>访问页表的公式：0xC0000000 + PDI*4096 + PTI*4（I=index）</li>\n</ul>\n<p>再看一遍这个图</p>\n<p><img data-src=\"image002.png\" alt=\"\" /></p>\n<h1 id=\"总结\"><a class=\"anchor\" href=\"#总结\">#</a> 总结</h1>\n<p>有了 0xC0300000 和 0xC0000000 能做什么：</p>\n<p><strong>掌握了这两个地址，就掌握了一个进程所有的物理内存读写权限</strong></p>\n<p>公式总结：</p>\n<ol>\n<li>访问页目录表的公式：C0300000 + PDI*4（I=index）</li>\n<li>访问页表的公式：0xC0000000 + PDI*4096 + PTI*4（I=index）</li>\n</ol>\n<h2 id=\"实践\"><a class=\"anchor\" href=\"#实践\">#</a> 实践</h2>\n<p>理论知道了开始实践。</p>\n<h3 id=\"在0地址执行shellcode\"><a class=\"anchor\" href=\"#在0地址执行shellcode\">#</a> 在 0 地址执行 ShellCode</h3>\n<p>所需知识：</p>\n<ul>\n<li>内联汇编</li>\n<li>硬编码</li>\n<li>CPU 提权</li>\n<li>10-10-12 页表基址</li>\n</ul>\n<p>除了自己构造调用门描述符外，其他都代码实现。</p>\n<p>实际用途：火哥说的是写保护…… 小白也不懂，有些检测并不检测空指针赋值区和 64K 禁入区。</p>\n<p><img data-src=\"image005.png\" alt=\"\" /></p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">// 在 0 地址挂载物理页并执行 ShellCode</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span><span class=\"token string\">&lt;stdio.h></span></span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span><span class=\"token string\">&lt;Windows.h></span></span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token keyword\">char</span> ShellCode<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>\t\t\t<span class=\"token number\">0x6a</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>\t\t\t<span class=\"token number\">0x6a</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\t\t\t<span class=\"token number\">0x6a</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\t\t\t<span class=\"token number\">0x6a</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>\t\t\t<span class=\"token number\">0xe8</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>\t\t\t<span class=\"token number\">0xc3</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token keyword\">void</span> <span class=\"token function\">__declspec</span><span class=\"token punctuation\">(</span>naked<span class=\"token punctuation\">)</span> <span class=\"token function\">CallGate</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>\t__asm</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>\t\tpush <span class=\"token number\">0x30</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>\t\tpop fs<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>\t\t</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>\t\tpushad<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>\t\tpushfd<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>\t\tlea eax<span class=\"token punctuation\">,</span>ShellCode<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>\t\tmov ebx<span class=\"token punctuation\">,</span>dword ptr ds<span class=\"token operator\">:</span><span class=\"token punctuation\">[</span><span class=\"token number\">0xc0300000</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>\t\ttest ebx<span class=\"token punctuation\">,</span>ebx<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>\t\tje __gpPDE<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>\t\tshr eax<span class=\"token punctuation\">,</span><span class=\"token number\">12</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>\t\t<span class=\"token operator\">and</span> eax<span class=\"token punctuation\">,</span><span class=\"token number\">0xfffff</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>\t\tshl eax<span class=\"token punctuation\">,</span><span class=\"token number\">2</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>\t\tadd eax<span class=\"token punctuation\">,</span> <span class=\"token number\">0xc0000000</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>\t\tmov eax<span class=\"token punctuation\">,</span><span class=\"token punctuation\">[</span>eax<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>\t\tmov dword ptr ds<span class=\"token operator\">:</span><span class=\"token punctuation\">[</span><span class=\"token number\">0xc0000000</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>eax<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>\t\tjmp __back<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre></pre></td></tr><tr><td data-num=\"37\"></td><td><pre></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>__gpPDE<span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>\t\tshr eax<span class=\"token punctuation\">,</span><span class=\"token number\">22</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>\t\t<span class=\"token operator\">and</span> eax<span class=\"token punctuation\">,</span><span class=\"token number\">0x3ff</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>\t\tshl eax<span class=\"token punctuation\">,</span><span class=\"token number\">2</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>\t\tadd eax<span class=\"token punctuation\">,</span><span class=\"token number\">0xc0300000</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>\t\tmov eax<span class=\"token punctuation\">,</span><span class=\"token punctuation\">[</span>eax<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>\t\tmov dword ptr ds<span class=\"token operator\">:</span><span class=\"token punctuation\">[</span><span class=\"token number\">0xc0300000</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>eax<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>__back<span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>\t\tpopfd<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>\t\tpopad<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>\t\tretf<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre></pre></td></tr><tr><td data-num=\"52\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre></pre></td></tr><tr><td data-num=\"55\"></td><td><pre><span class=\"token keyword\">int</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> argc<span class=\"token punctuation\">,</span><span class=\"token keyword\">char</span><span class=\"token operator\">*</span> argv<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>\t<span class=\"token keyword\">unsigned</span> <span class=\"token keyword\">int</span> FuncAddress <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">unsigned</span> <span class=\"token keyword\">int</span><span class=\"token punctuation\">)</span>MessageBox<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre>\t<span class=\"token keyword\">int</span> OFA <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">unsigned</span> <span class=\"token keyword\">int</span><span class=\"token punctuation\">)</span>ShellCode<span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;</span> <span class=\"token number\">0xfff</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"59\"></td><td><pre>\t<span class=\"token comment\">//Amendment EIP</span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre>\t<span class=\"token operator\">*</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">unsigned</span> <span class=\"token keyword\">int</span> <span class=\"token operator\">*</span><span class=\"token punctuation\">)</span><span class=\"token operator\">&amp;</span>ShellCode<span class=\"token punctuation\">[</span><span class=\"token number\">9</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span> FuncAddress <span class=\"token operator\">-</span> <span class=\"token punctuation\">(</span><span class=\"token number\">13</span> <span class=\"token operator\">+</span> OFA<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"61\"></td><td><pre>\t<span class=\"token keyword\">char</span> GateSegment<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span><span class=\"token number\">0x48</span><span class=\"token punctuation\">,</span><span class=\"token number\">0</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"62\"></td><td><pre>\t<span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"MessageBox Address:%#010X\\nCallGate Address:%#010X\\nShellCode:%#010X\\n\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"63\"></td><td><pre>\t\t   FuncAddress<span class=\"token punctuation\">,</span>CallGate<span class=\"token punctuation\">,</span>ShellCode<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"64\"></td><td><pre>\t<span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"windbg execute eq 8003f048 %04xec00`0008%04x\\n\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"65\"></td><td><pre>\t\t   <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">unsigned</span> <span class=\"token keyword\">int</span><span class=\"token punctuation\">)</span>CallGate<span class=\"token operator\">>></span><span class=\"token number\">0x10</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;</span> <span class=\"token number\">0xffff</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"66\"></td><td><pre>\t\t   <span class=\"token punctuation\">(</span><span class=\"token keyword\">unsigned</span> <span class=\"token keyword\">int</span><span class=\"token punctuation\">)</span>CallGate <span class=\"token operator\">&amp;</span> <span class=\"token number\">0xffff</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"67\"></td><td><pre></pre></td></tr><tr><td data-num=\"68\"></td><td><pre>\t<span class=\"token function\">system</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"pause\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"69\"></td><td><pre></pre></td></tr><tr><td data-num=\"70\"></td><td><pre>\t__asm</pre></td></tr><tr><td data-num=\"71\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"72\"></td><td><pre>\t\tcall fword ptr ds<span class=\"token operator\">:</span><span class=\"token punctuation\">[</span>GateSegment<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"73\"></td><td><pre>\t\tpush <span class=\"token number\">0x3b</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">//R3 FS Value</span></pre></td></tr><tr><td data-num=\"74\"></td><td><pre>\t\tpop fs<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"75\"></td><td><pre>\t\tmov eax<span class=\"token punctuation\">,</span>OFA<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"76\"></td><td><pre>\t\tcall eax<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"77\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"78\"></td><td><pre></pre></td></tr><tr><td data-num=\"79\"></td><td><pre>\t<span class=\"token function\">system</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"pause\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"80\"></td><td><pre>\t<span class=\"token keyword\">return</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"81\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>成功！这个例子只是抛砖引玉，更多的还是需要自身区专研。</p>\n<p><img data-src=\"image006.png\" alt=\"\" /></p>\n<h1 id=\"reference\"><a class=\"anchor\" href=\"#reference\">#</a> Reference</h1>\n<p>滴水中级课程<br />\n<span class=\"exturl\" data-url=\"aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQxOTg4NDQ4L2FydGljbGUvZGV0YWlscy8xMDI2NTI3NzY=\"> https://blog.csdn.net/qq_41988448/article/details/102652776</span></p>\n",
            "tags": [
                "页目录表基址",
                "页表的基址",
                "0地址执行ShellCode"
            ]
        },
        {
            "id": "https://or0kit.github.io/Bin/Core/WindowsXp/Protect-Mode/%E4%BF%9D%E6%8A%A4%E6%A8%A1%E5%BC%8F%E2%80%94PDE-PTE/",
            "url": "https://or0kit.github.io/Bin/Core/WindowsXp/Protect-Mode/%E4%BF%9D%E6%8A%A4%E6%A8%A1%E5%BC%8F%E2%80%94PDE-PTE/",
            "title": "保护模式—PDE_PTE",
            "date_published": "2021-08-25T08:51:04.000Z",
            "content_html": "<h1 id=\"10-10-12分页\"><a class=\"anchor\" href=\"#10-10-12分页\">#</a> 10-10-12 分页</h1>\n<blockquote>\n<p>一个物理页的大小为 4096 字节，即 2 的 12 次方，若要遍历整个物理页，则需要 12 个比特位<br />\n一个页表有 1024 个页表项，1024 等于 2 的十次方，即需要 10 个比特位<br />\n页目录表里有 1024 个页目录项，也需要 10 个比特位</p>\n</blockquote>\n<h1 id=\"cr3\"><a class=\"anchor\" href=\"#cr3\">#</a> CR3</h1>\n<blockquote>\n<p>在所有的寄存器中，只有 Cr3 存储的是物理地址，其它寄存器存的都是线性地址<br />\n Cr3 所存储的物理地址指向了一个页目录表（PDT）<br />\n在 Windows 中，一个页的大小通常为 4KB，即一个页可以存储 1024 个页目录表项（PDE）</p>\n</blockquote>\n<h1 id=\"pde与pte\"><a class=\"anchor\" href=\"#pde与pte\">#</a> PDE 与 PTE</h1>\n<p><img data-src=\"image001.png\" alt=\"\" /></p>\n<ul>\n<li><strong>PDE（页目录表项）</strong></li>\n</ul>\n<p>描述：</p>\n<blockquote>\n<p>页目录表（PDT）的每一项元素称为页目录表项（PDE）<br />\n每个页目录表项指向一个页表（PTT）<br />\n每个页表的大小为 4KB，即一个页表可以存储 1024 个页表项（PTE）</p>\n</blockquote>\n<ul>\n<li><strong>PTE（页表项）</strong></li>\n</ul>\n<p>描述：</p>\n<blockquote>\n<p>页表（PTT）的每一个元素称为页表项（PTE）<br />\n页表项（PTE）所指向的才是真正的物理页</p>\n</blockquote>\n<p>特征：</p>\n<ol>\n<li>PTE 可以指向一个物理页，也可以不指向物理页</li>\n<li>多个 PTE 可以指向同一个物理页</li>\n<li>一个 PTE 只能指向一个物理页</li>\n</ol>\n<h1 id=\"物理页的属性\"><a class=\"anchor\" href=\"#物理页的属性\">#</a> 物理页的属性</h1>\n<p>物理页的属性 = PDE 属性 &amp; PTE 属性</p>\n<p><img data-src=\"image002.png\" alt=\"\" /></p>\n<p><img data-src=\"image003.png\" alt=\"\" /></p>\n<p><code>P位</code> ：是否有效位<br />\n注意：当 PDE 或 PTE 中有一个的属性 P=0 时，物理页就是无效的</p>\n<p><code>R/W位</code> ：读写位<br />\n R/W=0：只读<br />\n R/W=1：可读可写</p>\n<p><code>U/S位</code> ：权限位<br />\n U/S=0：特权用户<br />\n U/S=1：普通用户</p>\n<p><code>PS位</code> ：PDE 特有<br />\n PS == PageSize<br />\nPS=1：PDE 直接指向物理页，低 22 位 = 页内偏移，偏移最大值为 4MB，俗称 &quot;大页&quot;<br />\nPS=0：PDE 指向 PTE</p>\n<p><code>A位</code> ：访问位<br />\n A=1：该 PDE/PTE 被访问过<br />\n A=0：该 PDE/PTE 未被访问过</p>\n<p><code>D位</code> ：脏位<br />\n D=1：该 PDE/PTE 被写过<br />\n D=0：该 PDE/PTE 未被写过</p>\n<p><em><strong>关于 G 位，PWT 位，PCD 位，学完控制寄存器域 TLB 才能讲。</strong></em></p>\n<h1 id=\"实验\"><a class=\"anchor\" href=\"#实验\">#</a> 实验</h1>\n<h2 id=\"修改us位访问高2g内存\"><a class=\"anchor\" href=\"#修改us位访问高2g内存\">#</a> 修改 U/S 位访问高 2G 内存</h2>\n<p>之前学习段的时候，我们可以通过调用门，中断门，任务门等方式将 CPL 提升到 0，从而可以读写高 2G 内存。学习了 U/S 位后，我们可以不提权也能访问高 2G，只需要将想访问的物理页对应的 PDE PTE 的 U/S 位改写为 1 即可。</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span><span class=\"token string\">&lt;stdio.h></span></span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">int</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>\t<span class=\"token keyword\">unsigned</span> <span class=\"token keyword\">int</span><span class=\"token operator\">*</span> p <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">unsigned</span> <span class=\"token keyword\">int</span><span class=\"token operator\">*</span><span class=\"token punctuation\">)</span><span class=\"token number\">0x8003f020</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>\t<span class=\"token keyword\">unsigned</span> <span class=\"token keyword\">int</span> addr <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">unsigned</span> <span class=\"token keyword\">int</span><span class=\"token punctuation\">)</span>p<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>\t<span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"addr Linear Address:%#010X\\n10-10-12: %x-%x-%x\\n\"</span><span class=\"token punctuation\">,</span>addr<span class=\"token punctuation\">,</span>addr<span class=\"token operator\">>></span><span class=\"token number\">22</span><span class=\"token punctuation\">,</span><span class=\"token punctuation\">(</span>addr<span class=\"token operator\">>></span><span class=\"token number\">12</span><span class=\"token punctuation\">)</span><span class=\"token operator\">&amp;</span><span class=\"token number\">0x3FF</span><span class=\"token punctuation\">,</span>addr<span class=\"token operator\">&amp;</span><span class=\"token number\">0xFFF</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>\t<span class=\"token function\">getchar</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\t<span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Read High 2G Memory %#010X:%#010X\\n\"</span><span class=\"token punctuation\">,</span>addr<span class=\"token punctuation\">,</span><span class=\"token operator\">*</span>p<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\t<span class=\"token function\">getchar</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>\t<span class=\"token keyword\">return</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>查看 PDE 和 PTE</p>\n<p><img data-src=\"image004.png\" alt=\"\" /></p>\n<p>修改 U/S 位并查看是否修改成功</p>\n<p><img data-src=\"image005.png\" alt=\"\" /></p>\n<p>成功读取高 2G 内存的值</p>\n<p><img data-src=\"image006.png\" alt=\"\" /></p>\n<h2 id=\"ps位验证\"><a class=\"anchor\" href=\"#ps位验证\">#</a> PS 位验证</h2>\n<p>随便找一个进程的 CR3，看一下</p>\n<p><img data-src=\"image007.png\" alt=\"\" /></p>\n<p>CR3: 143d3000<br />\n10-10-12:50-3d3-0</p>\n<h2 id=\"通过修改页表使代码能在0地址处读写\"><a class=\"anchor\" href=\"#通过修改页表使代码能在0地址处读写\">#</a> 通过修改页表使代码能在 0 地址处读写</h2>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span><span class=\"token string\">&lt;stdio.h></span></span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">int</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>\t<span class=\"token keyword\">unsigned</span> <span class=\"token keyword\">int</span><span class=\"token operator\">*</span> p <span class=\"token operator\">=</span> <span class=\"token number\">0x0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>\t<span class=\"token keyword\">unsigned</span> <span class=\"token keyword\">int</span> a <span class=\"token operator\">=</span> <span class=\"token number\">0x12345678</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>\t<span class=\"token keyword\">unsigned</span> <span class=\"token keyword\">int</span> addr <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">unsigned</span> <span class=\"token keyword\">int</span><span class=\"token punctuation\">)</span>p<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>\t<span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"a VirtualAddress:%#010X\\n10-10-12:%x-%x-%x\\n\\n\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>\t\t<span class=\"token punctuation\">(</span><span class=\"token keyword\">unsigned</span> <span class=\"token keyword\">int</span><span class=\"token punctuation\">)</span><span class=\"token operator\">&amp;</span>a<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\t\t<span class=\"token punctuation\">(</span><span class=\"token keyword\">unsigned</span> <span class=\"token keyword\">int</span><span class=\"token punctuation\">)</span><span class=\"token operator\">&amp;</span>a<span class=\"token operator\">>></span><span class=\"token number\">22</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\t\t<span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">unsigned</span> <span class=\"token keyword\">int</span><span class=\"token punctuation\">)</span><span class=\"token operator\">&amp;</span>a<span class=\"token operator\">>></span><span class=\"token number\">12</span><span class=\"token operator\">&amp;</span><span class=\"token number\">0x3FF</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>\t\t<span class=\"token punctuation\">(</span><span class=\"token keyword\">unsigned</span> <span class=\"token keyword\">int</span><span class=\"token punctuation\">)</span><span class=\"token operator\">&amp;</span>a<span class=\"token operator\">&amp;</span><span class=\"token number\">0xFFF</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>\t<span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"addr VirtualAddress:%#010X\\n10-10-12:%x-%x-%x\\n\\n\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>\t\taddr<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>\t\taddr<span class=\"token operator\">>></span><span class=\"token number\">22</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>\t\t<span class=\"token punctuation\">(</span>addr<span class=\"token operator\">>></span><span class=\"token number\">12</span><span class=\"token operator\">&amp;</span><span class=\"token number\">0x3FF</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>\t\taddr<span class=\"token operator\">&amp;</span><span class=\"token number\">0xFFF</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>\t<span class=\"token function\">getchar</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>\t<span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Write 0x0 Address Data 0x666 *p=%#010X\"</span><span class=\"token punctuation\">,</span><span class=\"token operator\">*</span>p<span class=\"token operator\">=</span><span class=\"token number\">0x666</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>\t<span class=\"token function\">getchar</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>\t<span class=\"token keyword\">return</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>查看程序的 CR3，找到 a 变量的物理地址。</p>\n<p><img data-src=\"image008.png\" alt=\"\" /></p>\n<p>更改 0 地址的 PTE，使 0 地址的 PDE 指向变量 a 的 PTE。</p>\n<p><img data-src=\"image009.png\" alt=\"\" /></p>\n<p>结果：</p>\n<p><img data-src=\"image010.png\" alt=\"\" /></p>\n<h2 id=\"通过修改物理页属性使字符串常量可修改\"><a class=\"anchor\" href=\"#通过修改物理页属性使字符串常量可修改\">#</a> 通过修改物理页属性使字符串常量可修改</h2>\n<p>懒得做了，修改一下 <code>R/w</code>  位就行了</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;stdio.h></span></span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">int</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> argc<span class=\"token punctuation\">,</span> <span class=\"token keyword\">char</span> <span class=\"token operator\">*</span>argv<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>\t<span class=\"token keyword\">char</span> <span class=\"token operator\">*</span>str <span class=\"token operator\">=</span> <span class=\"token string\">\"Hello World\"</span><span class=\"token punctuation\">;</span><span class=\"token comment\">// 众所周知，C 语言中字符串是不能直接修改的。</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>\t<span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"线性地址：%x\"</span><span class=\"token punctuation\">,</span> str<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\t<span class=\"token function\">getchar</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\t\t\t\t\t\t<span class=\"token comment\">// 让程序执行到这里</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>\t<span class=\"token comment\">// 修改只读变量</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>\tstr<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token string\">'M'</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>\t<span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"修改后的值：%s\\n\"</span><span class=\"token punctuation\">,</span>str<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>\t<span class=\"token function\">getchar</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>\t<span class=\"token keyword\">return</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h1 id=\"reference\"><a class=\"anchor\" href=\"#reference\">#</a> Reference</h1>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L0t3YW5zeS9hcnRpY2xlL2RldGFpbHMvMTA4OTE0Mzkz\">https://blog.csdn.net/Kwansy/article/details/108914393</span><br />\n<span class=\"exturl\" data-url=\"aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQxOTg4NDQ4L2FydGljbGUvZGV0YWlscy8xMDI2MjcyMzk=\">https://blog.csdn.net/qq_41988448/article/details/102627239</span></p>\n",
            "tags": [
                "PDE_PTE",
                "物理页"
            ]
        },
        {
            "id": "https://or0kit.github.io/Bin/Core/WindowsXp/Protect-Mode/%E4%BF%9D%E6%8A%A4%E6%A8%A1%E5%BC%8F%E2%80%9410-10-12%E5%88%86%E9%A1%B5/",
            "url": "https://or0kit.github.io/Bin/Core/WindowsXp/Protect-Mode/%E4%BF%9D%E6%8A%A4%E6%A8%A1%E5%BC%8F%E2%80%9410-10-12%E5%88%86%E9%A1%B5/",
            "title": "保护模式—10-10-12分页",
            "date_published": "2021-08-25T08:50:39.000Z",
            "content_html": "<h1 id=\"正文\"><a class=\"anchor\" href=\"#正文\">#</a> 正文</h1>\n<p>进入页模式</p>\n<p>首先更改内核的分页模式</p>\n<p><img data-src=\"image001.png\" alt=\"\" /></p>\n<p><code>multi(0)disk(0)rdisk(0)partition(1)\\WINDOWS=&quot;XP[debug 10-10-12]&quot; /debug /debugport=com1 /execute=optin /fastdetect</code></p>\n<p>将 noexecute 改成 execute，就改为了 10-10-12 分页模式</p>\n<p>后面会学习 2-9-9-12 分页模式，默认的是 2-9-9-12 分页模式</p>\n<p><code>multi(0)disk(0)rdisk(0)partition(1)\\WINDOWS=&quot;XP[debug 2-9-9-12]&quot; /debug /debugport=com1 /noexecute=optin /fastdetect</code></p>\n<p><img data-src=\"image002.png\" alt=\"\" /></p>\n<h1 id=\"4gb内存\"><a class=\"anchor\" href=\"#4gb内存\">#</a> 4GB 内存</h1>\n<p>每一个进程都有 4GB 内存，一个程序的最大寻址范围 4GB 怎么来的？</p>\n<p>答案是 PTE 的前 20 位 + 线性地址的最后 12 位得到的寻址范围（32 位）就是 4GB</p>\n<h1 id=\"线性地址-有效地址-物理地址\"><a class=\"anchor\" href=\"#线性地址-有效地址-物理地址\">#</a> 线性地址、有效地址、物理地址</h1>\n<p>如下指令：</p>\n<p>MOV eax,dword ptr ds:[0x12345678]</p>\n<p>其中，0x12345678 是有效地址</p>\n<p>ds.Base + 0x12345678 是线性地址</p>\n<p>线性地址挂载在了物理地址上</p>\n<h1 id=\"cpu如何寻找到物理地址\"><a class=\"anchor\" href=\"#cpu如何寻找到物理地址\">#</a> CPU 如何寻找到物理地址</h1>\n<p>每个进程都有一个 CR3,(准确的说是都一个 CR3 的值，CR3 本身是<br />\n个寄存器，一个核，只有一套寄存器)<br />\n CR3 指向一个物理页，一共 4096 字节，如图：</p>\n<p><img data-src=\"image003.png\" alt=\"\" /></p>\n<h1 id=\"10-10-12\"><a class=\"anchor\" href=\"#10-10-12\">#</a> 10-10-12</h1>\n<p><img data-src=\"image004.png\" alt=\"\" /></p>\n<h2 id=\"实验寻找物理地址\"><a class=\"anchor\" href=\"#实验寻找物理地址\">#</a> 实验：寻找物理地址</h2>\n<p>创建一个 txt 程序并用 notepad.exe 打开，写入内容，CE 附加 notepad.exe 进程</p>\n<p><img data-src=\"image005.png\" alt=\"\" /></p>\n<p>附加后配置选项，进行内存扫描</p>\n<p><img data-src=\"image006.png\" alt=\"\" /></p>\n<p>改变 txt 中的内容再次扫描，直到确认地址</p>\n<p><img data-src=\"image007.png\" alt=\"\" /></p>\n<p>确认内存地址为 0x125800<br />\n 开始拆分地址</p>\n<p><img data-src=\"image008.png\" alt=\"\" /></p>\n<pre><code>00125800\n\n0000 0000 0001 0010 0101 1000 0000 0000\n\n用的时候要乘以4\n\n0000 0000 00 ---------------------------  0x0 * 4 = 0x0 \n\t    01 0010 0101  --------------  0x125 * 4 = 0x494\n\t\t\t1000 0000 0000 ---0x800\n</code></pre>\n<p>找那个进程的物理页，物理地址就看哪个进程的 CR3，这里查看 notepad.exe 的 CR3: <code>3c932000</code></p>\n<p><img data-src=\"image009.png\" alt=\"\" /></p>\n<p>突然虚拟机卡住了 windbg 也没用，这俩不知道怪谁。只能重启了，数据也都变了。后面的截图有些误差，重要的是流程。</p>\n<p>获得 cr3 后，在 windbg 中执行</p>\n<p>!dd cr3 + （拆分出来的第一个 10 的值乘以 4）</p>\n<p><code>!dd 3c932000 + 0</code></p>\n<p>重启虚拟机后获取的数据是这个</p>\n<pre><code>000B04B8\n\n10 0\n10 B0\n12 4B8\n</code></pre>\n<p><img data-src=\"image010.png\" alt=\"\" /></p>\n<p>获取第一个值并把后三位去掉变成 0</p>\n<p><img data-src=\"image011.png\" alt=\"\" /></p>\n<p>最后找到物理地址，查看一下</p>\n<p><img data-src=\"image012.png\" alt=\"\" /></p>\n<h1 id=\"总结\"><a class=\"anchor\" href=\"#总结\">#</a> 总结</h1>\n<p>这节主要是对分页模式有个模糊的轮廓。</p>\n",
            "tags": [
                "10-10-12分页"
            ]
        },
        {
            "id": "https://or0kit.github.io/Bin/Core/WindowsXp/Protect-Mode/%E4%BF%9D%E6%8A%A4%E6%A8%A1%E5%BC%8F-%E4%BB%BB%E5%8A%A1%E9%97%A8/",
            "url": "https://or0kit.github.io/Bin/Core/WindowsXp/Protect-Mode/%E4%BF%9D%E6%8A%A4%E6%A8%A1%E5%BC%8F-%E4%BB%BB%E5%8A%A1%E9%97%A8/",
            "title": "保护模式-任务门",
            "date_published": "2021-08-13T06:40:49.000Z",
            "content_html": "<h1 id=\"要点回顾\"><a class=\"anchor\" href=\"#要点回顾\">#</a> 要点回顾：</h1>\n<p>在上一节中讲解了如何通过 CALL、JMP 指令访问任务段</p>\n<p>这一节课主要介绍如何通过任务门去访问任务段</p>\n<p>既然已经可以访问任务段了，那为什么还要有任务门呢？</p>\n<h1 id=\"任务门\"><a class=\"anchor\" href=\"#任务门\">#</a> 任务门</h1>\n<p>IDT 表可以包含 3 种门描述符：</p>\n<ul>\n<li>\n<p>任务门描述符</p>\n</li>\n<li>\n<p>中断门描述符</p>\n</li>\n<li>\n<p>陷阱门描述符</p>\n</li>\n</ul>\n<p>接下来我们学习任务门</p>\n<h2 id=\"任务门描述符\"><a class=\"anchor\" href=\"#任务门描述符\">#</a> 任务门描述符</h2>\n<p><img data-src=\"image001.png\" alt=\"\" /></p>\n<p>除了 TSS 描述符选择子以外， 其他位都是固定的。<br />\n我们在 <code>8003f048</code>  处设置 TSS 描述符，因此，任务门描述符的值可以确定： <code>0000e500`00480000</code></p>\n<h2 id=\"任务门执行过程\"><a class=\"anchor\" href=\"#任务门执行过程\">#</a> 任务门执行过程：</h2>\n<ol>\n<li>\n<p>INT N</p>\n</li>\n<li>\n<p>查 IDT 表，找到任务门描述符</p>\n</li>\n<li>\n<p>通过任务门描述符，查 GDT 表，找到 TSS 段描述符</p>\n</li>\n<li>\n<p>使用 TSS 段中的值修改 TR 寄存器</p>\n</li>\n<li>\n<p>IRETD 返回</p>\n</li>\n</ol>\n<h2 id=\"实验\"><a class=\"anchor\" href=\"#实验\">#</a> 实验</h2>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span><span class=\"token string\">&lt;stdio.h></span></span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span><span class=\"token string\">&lt;Windows.h></span></span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>DWORD<span class=\"token operator\">*</span> TSS<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>DWORD dwOk<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token keyword\">void</span> <span class=\"token function\">__declspec</span><span class=\"token punctuation\">(</span>naked<span class=\"token punctuation\">)</span> <span class=\"token function\">TestFunc</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\tdwOk <span class=\"token operator\">=</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\t__asm<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>\t\tiretd</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre></pre></td></tr><tr><td data-num=\"15\"></td><td><pre></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token keyword\">int</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>\tDWORD dwCr3<span class=\"token punctuation\">;</span> <span class=\"token comment\">//windbg 获取</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>\t<span class=\"token keyword\">char</span> esp<span class=\"token punctuation\">[</span><span class=\"token number\">0x1000</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// 任务切换后的栈</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>\tTSS <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>DWORD<span class=\"token operator\">*</span><span class=\"token punctuation\">)</span><span class=\"token function\">VirtualAlloc</span><span class=\"token punctuation\">(</span><span class=\"token constant\">NULL</span><span class=\"token punctuation\">,</span><span class=\"token number\">104</span><span class=\"token punctuation\">,</span>MEM_COMMIT<span class=\"token punctuation\">,</span>PAGE_READWRITE<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>TSS <span class=\"token operator\">==</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>\t\t<span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"VirtualAlloc 失败，%d\\n\"</span><span class=\"token punctuation\">,</span> <span class=\"token function\">GetLastError</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>\t\t<span class=\"token function\">system</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"pause\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>\t\t<span class=\"token keyword\">return</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>\t<span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"请在windbg执行: eq 8003f048 %02x00e9%02x`%04x0068\\n\"</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>DWORD<span class=\"token punctuation\">)</span>TSS<span class=\"token operator\">>></span><span class=\"token number\">24</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;</span> <span class=\"token number\">0x000000FF</span><span class=\"token punctuation\">,</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>DWORD<span class=\"token punctuation\">)</span>TSS<span class=\"token operator\">>></span><span class=\"token number\">16</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;</span> <span class=\"token number\">0x000000FF</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span>WORD<span class=\"token punctuation\">)</span>TSS<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>\t<span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"请在windbg执行: eq 8003f500 0000e500`00480000\\n\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>\t<span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"请在windbg中执行!process 0 0，复制进程DirBase的值，并输入.\\nCR3: \"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> </pre></td></tr><tr><td data-num=\"31\"></td><td><pre>\t<span class=\"token function\">scanf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"%x\"</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>dwCr3<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> </pre></td></tr><tr><td data-num=\"32\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"33\"></td><td><pre>\tTSS<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token number\">0x00000000</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// Previous Task Link CPU 填充，表示上一个任务的选择子</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>\tTSS<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token number\">0x00000000</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// ESP0</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>\tTSS<span class=\"token punctuation\">[</span><span class=\"token number\">2</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token number\">0x00000000</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// SS0</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>\tTSS<span class=\"token punctuation\">[</span><span class=\"token number\">3</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token number\">0x00000000</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// ESP1</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>\tTSS<span class=\"token punctuation\">[</span><span class=\"token number\">4</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token number\">0x00000000</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// SS1</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>\tTSS<span class=\"token punctuation\">[</span><span class=\"token number\">5</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token number\">0x00000000</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// ESP2</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>\tTSS<span class=\"token punctuation\">[</span><span class=\"token number\">6</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token number\">0x00000000</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// SS2</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>\tTSS<span class=\"token punctuation\">[</span><span class=\"token number\">7</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> dwCr3<span class=\"token punctuation\">;</span> <span class=\"token comment\">// CR3 学到页就知道是啥了</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>\tTSS<span class=\"token punctuation\">[</span><span class=\"token number\">8</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>DWORD<span class=\"token punctuation\">)</span>TestFunc<span class=\"token punctuation\">;</span> <span class=\"token comment\">// EIP</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>\tTSS<span class=\"token punctuation\">[</span><span class=\"token number\">9</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token number\">0x00000000</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// EFLAGS</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>\tTSS<span class=\"token punctuation\">[</span><span class=\"token number\">10</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token number\">0x00000000</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// EAX</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>\tTSS<span class=\"token punctuation\">[</span><span class=\"token number\">11</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token number\">0x00000000</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// ECX</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>\tTSS<span class=\"token punctuation\">[</span><span class=\"token number\">12</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token number\">0x00000000</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// EDX</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>\tTSS<span class=\"token punctuation\">[</span><span class=\"token number\">13</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token number\">0x00000000</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// EBX</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>\tTSS<span class=\"token punctuation\">[</span><span class=\"token number\">14</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>DWORD<span class=\"token punctuation\">)</span>esp<span class=\"token operator\">+</span><span class=\"token number\">0x1000</span><span class=\"token punctuation\">;</span> </pre></td></tr><tr><td data-num=\"48\"></td><td><pre>\tTSS<span class=\"token punctuation\">[</span><span class=\"token number\">15</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token number\">0x00000000</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// EBP</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>\tTSS<span class=\"token punctuation\">[</span><span class=\"token number\">16</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token number\">0x00000000</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// ESI</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>\tTSS<span class=\"token punctuation\">[</span><span class=\"token number\">17</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token number\">0x00000000</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// EDI</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>\tTSS<span class=\"token punctuation\">[</span><span class=\"token number\">18</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token number\">0x00000000</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// ES</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre>\tTSS<span class=\"token punctuation\">[</span><span class=\"token number\">19</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token number\">0x00000008</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// CS </span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>\tTSS<span class=\"token punctuation\">[</span><span class=\"token number\">20</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token number\">0x00000010</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// SS </span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre>\tTSS<span class=\"token punctuation\">[</span><span class=\"token number\">21</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token number\">0x00000000</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// DS</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre>\tTSS<span class=\"token punctuation\">[</span><span class=\"token number\">22</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token number\">0x00000000</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// FS </span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>\tTSS<span class=\"token punctuation\">[</span><span class=\"token number\">23</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token number\">0x00000000</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// GS</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre>\tTSS<span class=\"token punctuation\">[</span><span class=\"token number\">24</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token number\">0x00000000</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// LDT Segment Selector</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre>\tTSS<span class=\"token punctuation\">[</span><span class=\"token number\">25</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token number\">0x20ac0000</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// I/O Map Base Address</span></pre></td></tr><tr><td data-num=\"59\"></td><td><pre></pre></td></tr><tr><td data-num=\"60\"></td><td><pre>\t__asm</pre></td></tr><tr><td data-num=\"61\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"62\"></td><td><pre>\t\t<span class=\"token keyword\">int</span> <span class=\"token number\">0x20</span></pre></td></tr><tr><td data-num=\"63\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"64\"></td><td><pre>\t<span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"ok: %d\\n\"</span><span class=\"token punctuation\">,</span>dwOk<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"65\"></td><td><pre>\t<span class=\"token function\">system</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"pause\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"66\"></td><td><pre>\t<span class=\"token keyword\">return</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"67\"></td><td><pre></pre></td></tr><tr><td data-num=\"68\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p><img data-src=\"image002.png\" alt=\"\" /></p>\n<h2 id=\"int-8-逆向分析\"><a class=\"anchor\" href=\"#int-8-逆向分析\">#</a> INT 8 逆向分析</h2>\n<p>看看操作系统是如何使用任务门的，但因为我太菜了，只能……</p>\n<p><strong>寻找 int 8 的代码</strong></p>\n<p>由 <code>INT 8</code>  查询 IDT 表中索引为 8 的段描述符</p>\n<p><img data-src=\"image003.png\" alt=\"\" /></p>\n<p>可以发现是任务们的描述符 <code>00008500`00501198</code></p>\n<p>其中 TSS 的段选择子为 <code>0050</code></p>\n<p>去 GDT 表中查询 TSS 段描述符</p>\n<p><img data-src=\"image004.png\" alt=\"\" /></p>\n<p>TSS 段描述符为 <code>80008955`87000068</code></p>\n<p>TSS 在内存中的地址为 <code>0x80558700</code></p>\n<p><img data-src=\"image005.png\" alt=\"\" /></p>\n<p>可以看到 TSS 的结束位: <code>0x000020ac</code></p>\n<p>EIP 为 <code>0x804e08a5</code></p>\n<p>查看 0x804e08a5 处函数的汇编代码</p>\n<p><img data-src=\"image006.png\" alt=\"\" /></p>\n<p>在火哥的视频中让逆向图中高亮的代码。</p>\n<pre><code class=\"language-汇编\">804e08a6 648b0d3c000000  mov     ecx,dword ptr fs:[3Ch]\n804e08ad 8d4150          lea     eax,[ecx+50h]\n804e08b0 c6400589        mov     byte ptr [eax+5],89h\n804e08b4 9c              pushfd\n804e08b5 812424ffbfffff  and     dword ptr [esp],0FFFFBFFFh\n804e08bc 9d              popfd\n804e08bd 64a13c000000    mov     eax,dword ptr fs:[0000003Ch]\n804e08c3 8a6857          mov     ch,byte ptr [eax+57h]\n804e08c6 8a4854          mov     cl,byte ptr [eax+54h]\n804e08c9 c1e110          shl     ecx,10h\n804e08cc 668b4852        mov     cx,word ptr [eax+52h]\n804e08d0 64a140000000    mov     eax,dword ptr fs:[00000040h]\n804e08d6 64890d40000000  mov     dword ptr fs:[40h],ecx\n</code></pre>\n<p><img data-src=\"image007.png\" alt=\"\" /></p>\n<p>这是火哥在视频中分析好的，我截图了。</p>\n<hr />\n<hr />\n<p>今天搜索 FS 寄存器的资料，发现了这里涉及了 FS 寄存器在 R0 和 R3 下的不同。</p>\n<p>具体参见<span class=\"exturl\" data-url=\"aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3B5X3Bhbnl1L2FydGljbGUvZGV0YWlscy80NTAxMTUwNQ==\"> https://blog.csdn.net/py_panyu/article/details/45011505</span> 这篇博客，衷心感谢作者。</p>\n<p>当线程运行在 R0 下时，FS 指向的段是 GDT 中的 0x30 段。该段的长度也为 4K, 基地址为 0xFFDFF000. 该地址指向系统的处理器控制区域（KPCR）. 这个区域中保存这处理器相关的一些重要数据值，如 GDT、IDT 表的值等等.</p>\n<pre><code>kd&gt; dt _kpcr\nnt!_KPCR\n   +0x000 NtTib            : _NT_TIB\n   +0x01c SelfPcr          : Ptr32 _KPCR\n   +0x020 Prcb             : Ptr32 _KPRCB\n   +0x024 Irql             : UChar\n   +0x028 IRR              : Uint4B\n   +0x02c IrrActive        : Uint4B\n   +0x030 IDR              : Uint4B\n   +0x034 KdVersionBlock   : Ptr32 Void\n   +0x038 IDT              : Ptr32 _KIDTENTRY\n   +0x03c GDT              : Ptr32 _KGDTENTRY\n   +0x040 TSS              : Ptr32 _KTSS\n   +0x044 MajorVersion     : Uint2B\n   +0x046 MinorVersion     : Uint2B\n   +0x048 SetMember        : Uint4B\n   +0x04c StallScaleFactor : Uint4B\n   +0x050 DebugActive      : UChar\n   +0x051 Number           : UChar\n   +0x052 Spare0           : UChar\n   +0x053 SecondLevelCacheAssociativity : UChar\n   +0x054 VdmAlert         : Uint4B\n   +0x058 KernelReserved   : [14] Uint4B\n   +0x090 SecondLevelCacheSize : Uint4B\n   +0x094 HalReserved      : [16] Uint4B\n   +0x0d4 InterruptMode    : Uint4B\n   +0x0d8 Spare1           : UChar\n   +0x0dc KernelReserved2  : [17] Uint4B\n   +0x120 PrcbData         : _KPRCB\n</code></pre>\n<p>主要是学习操作系统的思路。编写操作系统的人，厉害 (๑・̀ㅂ・́)و✧</p>\n<h2 id=\"任务切换\"><a class=\"anchor\" href=\"#任务切换\">#</a> 任务切换</h2>\n<p>概述一下任务门进行任务切换的流程：</p>\n<ol>\n<li>\n<p>当中断发生时，处理器用中断号乘以 8（段描述符的大小为 8 个字节）作为索引访问中断描述符表。当它发现这是一个任务门描述符时，就知道应当发起任务切换。</p>\n</li>\n<li>\n<p>取出任务门描述符。</p>\n</li>\n<li>\n<p>从任务门描述符中取出新任务的 TSS 选择子；</p>\n</li>\n<li>\n<p>再用 TSS 选择子访问 GDT，取出新任务的 TSS 描述符</p>\n</li>\n<li>\n<p>到这里就和上一节用 TSS 切换任务一样了……TSS…… 切换寄存器……</p>\n</li>\n</ol>\n<p>最终任务寄存器 TR 指向新任务的 TSS，而处理器开始新任务的执行。</p>\n<p>一旦新任务开始执行，处理器固件会自动将其 TSS 描述符的 B 位置 1，表示该任务状态为忙。</p>\n<h1 id=\"reference\"><a class=\"anchor\" href=\"#reference\">#</a> Reference</h1>\n<p>任务门 --- 任务切换:<span class=\"exturl\" data-url=\"aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM3Mzc1NDI3L2FydGljbGUvZGV0YWlscy84NTA0NjU0Mw==\">https://blog.csdn.net/qq_37375427/article/details/85046543</span><br />\n 任务门<span class=\"exturl\" data-url=\"aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L0t3YW5zeS9hcnRpY2xlL2RldGFpbHMvMTA4ODk2OTg5\"> https://blog.csdn.net/Kwansy/article/details/108896989</span><br />\n 浅谈 FS 段寄存器在用户层和内核层的使用<span class=\"exturl\" data-url=\"aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3B5X3Bhbnl1L2FydGljbGUvZGV0YWlscy80NTAxMTUwNQ==\"> https://blog.csdn.net/py_panyu/article/details/45011505</span></p>\n",
            "tags": [
                "任务门"
            ]
        },
        {
            "id": "https://or0kit.github.io/Bin/Core/WindowsXp/Protect-Mode/%E4%BF%9D%E6%8A%A4%E6%A8%A1%E5%BC%8F-%E4%BB%BB%E5%8A%A1%E6%AE%B5/",
            "url": "https://or0kit.github.io/Bin/Core/WindowsXp/Protect-Mode/%E4%BF%9D%E6%8A%A4%E6%A8%A1%E5%BC%8F-%E4%BB%BB%E5%8A%A1%E6%AE%B5/",
            "title": "保护模式-任务段",
            "date_published": "2021-08-13T06:40:43.000Z",
            "content_html": "<h1 id=\"前言\"><a class=\"anchor\" href=\"#前言\">#</a> 前言</h1>\n<p>当权限发生发生改变时堆栈也会随之发生改变 (如：3 环进 0 环)，由于 CS 的 CPL 发生变化，导致了 SS 也必须切换。<br />\n堆栈段寄存器 SS（Stack Segment），指出当前堆栈的底部地址，即存放堆栈段的段基址。</p>\n<p>当发生权限切换的时候，会有新的 ESP 和 SS（CS 是由中断门或者调用门指定），那么 ESP 和 SS 从何而来呢？</p>\n<p>答案：TSS (Task-state segment)，任务状态段</p>\n<h2 id=\"tsstask-state-segment任务状态段的结构\"><a class=\"anchor\" href=\"#tsstask-state-segment任务状态段的结构\">#</a> TSS (Task-State Segment) 任务状态段的结构</h2>\n<p><img data-src=\"image001.png\" alt=\"\" /></p>\n<p>TSS 是一块内存，大小 104 字节。</p>\n<h2 id=\"tss的作用\"><a class=\"anchor\" href=\"#tss的作用\">#</a> TSS 的作用</h2>\n<p>这关乎于：<ins>Intel 的设计思想</ins>和<ins>操作系统的设计思想</ins></p>\n<p>TSS 里存储了段寄存器，通用寄存器，标志寄存器，EIP，CR3 寄存器，4 个堆栈<br />\n TSS 的设计初衷是任务切换 (线程切换)，当线程切换的时候，同时替换寄存器的值，可是操作系统 (Windows，Linux) 并没有使用 TSS 来切换线程。<br />\n但我们却可以用 TSS 做其他事情。☺</p>\n<p>那我们就要学习 CPU 是如何使用 TSS 的了。</p>\n<h2 id=\"cpu如何找到tss\"><a class=\"anchor\" href=\"#cpu如何找到tss\">#</a> CPU 如何找到 TSS？</h2>\n<p>答案：TR 寄存器</p>\n<p><strong>通过 <code>TR</code>  寄存器的段选择子，查询 <code>GDT</code>  表，找到 <code>TSS</code>  段描述符，然后获取 TR 的 <code>Base</code> , <code>Base</code>  中存储的就是 <code>TSS</code>  的地址， <code>Limit</code>  中存储的是 <code>TSS</code>  的大小</strong></p>\n<p>如图所示:</p>\n<p><img data-src=\"image002.png\" alt=\"\" /></p>\n<h2 id=\"tss段描述符\"><a class=\"anchor\" href=\"#tss段描述符\">#</a> TSS 段描述符</h2>\n<p><img data-src=\"image003.png\" alt=\"\" /></p>\n<ul>\n<li><strong>当 TYPE 位为 9 (1001) 的时候，说明这个段描述符是一个 TSS 段描述符，这个段描述符没有加载到 TR 寄存器中</strong></li>\n<li><strong>当 TYPE 位为 B (1011) 的时候，说明也是 TSS 段描述符，这个段描述符已经加载到了 TR 寄存器中</strong></li>\n</ul>\n<h2 id=\"tr寄存器的读写\"><a class=\"anchor\" href=\"#tr寄存器的读写\">#</a> TR 寄存器的读写</h2>\n<ul>\n<li>将 TSS 段描述符加载到 TR 寄存器</li>\n</ul>\n<p>指令： <code>LTR</code> <br />\n 用 <code>LTR</code>  指令去装载 TR 寄存器，仅仅是改变了 TR 寄存器里面的内容 (96 位)<br />\n 并没有真正改变 TSS，原来的 TSS 还在。</p>\n<p><code>LTR</code>  指令只能在系统层使用</p>\n<p>加载后 TSS 段描述符会 TYPE 位发生改变 1001-&gt;1011，9 变成 B，说明这个段描述符被加载到了 TR 寄存器</p>\n<ul>\n<li>读 TR 寄存器</li>\n</ul>\n<p>指令：STR<br />\n 如果用 STR 去读 TR 寄存器，只能读到 TR 寄存器的 16 位，也就是段选择子，和读普通段寄存器一样，96 位只能读出其中 16 位</p>\n<h2 id=\"修改tr寄存器\"><a class=\"anchor\" href=\"#修改tr寄存器\">#</a> 修改 TR 寄存器</h2>\n<p>在 Ring0 我们可以通过 LTR 指令去修改 TR 寄存器<br />\n在 Ring3 我们可以通过 CALL FAR 或者 JMP FAR 指令来修改</p>\n<p>用 JMP 去访问一个代码段的时候，改变的是 CS 和 EIP ：<br />\nJMP 0x48:0x123456 如果 0x48 是代码段<br />\n执行后：CS-- &gt; 0x48 EIP-- &gt; 0x123456</p>\n<p>用 JMP 去访问一个任务段的时候：<br />\n如果 0x48 是 TSS 段描述符，先修改 TR 寄存器，在用 TR.Base 指向的 TSS 中的值修改当前的寄存器<br />\n JMP 指令会清当前 TR 所使用的的 TSS descriptor 的 Busy 位是当前 TSS descriptor 置为 available 状态</p>\n<p>如果使用 CALL 指令进行调用，将会在新的 TSS 段里的 LINk 域写入原 TSS selector 值。</p>\n<p>使用 CALL 指令进行调用时，Eflags.NT 标志位会被处理器进行置位，指示新的 task 进入 Nested（嵌套）状态。JMP 指令则相反，Eflags.NT 标志位会被进行清位。</p>\n<p>NT=0 IRET 指令 堆栈取返回地址<br />\n NT=1 IRET 指令 返回时会找 TSS 的 LINK 域的值</p>\n<h2 id=\"实践加载自定义tss\"><a class=\"anchor\" href=\"#实践加载自定义tss\">#</a> 实践：加载自定义 TSS</h2>\n<p>知道了原理，我们就可以在这个过程中动些手脚。</p>\n<p>CPU 通过 TR 寄存器来找到 TSS，如果我们使用自己的 TSS 来替换原来的寄存器，就必须要修改 TR 寄存器，TR 寄存器里面的值又是来自 TSS 段描述符。</p>\n<p>首先我们要构建 TSS 段描述符</p>\n<p><strong>G 位为 0，粒度为字节，TSS 以字节为单位</strong><br />\n<strong> <code>Segment Limit</code>  必须得大于等于 <code>67H</code> </strong></p>\n<blockquote>\n<p>BASE+G+AVL+LIMT    +    P+DPL+TYPE    +    BASE     +BASE   +Segment Limit<br />\n00    00              E(1110)+9(1001)       00       0000    0068</p>\n</blockquote>\n<p>暂取 TSS 段描述符为 <code>0000E900`00000068</code>  Base 的值填写的是内存中 tss 结构的地址。</p>\n<p>新的 TSS 段必须要指定要素： <code>EIP</code> 、 <code>ESP</code> 、 <code>CS</code> 、 <code>SS</code>  以及 <code>CR3</code>  的值。</p>\n<p>ESP 的值：定义局部数组作为裸函数的栈，因为我们不知道进入 0 环后哪里的堆栈地址可以使用，所以需要自己指定一个可以使用的地址，传给 TSS [14] 时，应该传数组尾部的指针，因为压栈 ESP 减小，如果传数组首地址，那一压栈就越界了。</p>\n<h3 id=\"使用call去访问一个任务段并能够正确返回\"><a class=\"anchor\" href=\"#使用call去访问一个任务段并能够正确返回\">#</a> 使用 CALL 去访问一个任务段，并能够正确返回</h3>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span><span class=\"token string\">&lt;stdio.h></span></span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span><span class=\"token string\">&lt;Windows.h></span></span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>DWORD dwOk<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>DWORD dwESP<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>DWORD dwCS<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token comment\">// 任务切换后的 EIP</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token keyword\">void</span> <span class=\"token function\">__declspec</span><span class=\"token punctuation\">(</span>naked<span class=\"token punctuation\">)</span> <span class=\"token function\">R0Func</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>\t__asm</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>\t\tpushad</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>\t\tpushfd</pre></td></tr><tr><td data-num=\"16\"></td><td><pre></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>\t\tpush fs</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>\t\t<span class=\"token keyword\">int</span> <span class=\"token number\">3</span> <span class=\"token comment\">//int 3 会修改 FS</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>\t\tpop fs</pre></td></tr><tr><td data-num=\"20\"></td><td><pre></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>\t\tmov eax<span class=\"token punctuation\">,</span><span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>\t\tmov dword ptr ds<span class=\"token operator\">:</span><span class=\"token punctuation\">[</span>dwOk<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>eax</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>\t\tmov eax<span class=\"token punctuation\">,</span>esp</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>\t\tmov dword ptr ds<span class=\"token operator\">:</span><span class=\"token punctuation\">[</span>dwESP<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>eax</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>\t\tmov ax<span class=\"token punctuation\">,</span>cs</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>\t\tmov word ptr ds<span class=\"token operator\">:</span><span class=\"token punctuation\">[</span>dwCS<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>ax</pre></td></tr><tr><td data-num=\"27\"></td><td><pre></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>\t\tpopfd</pre></td></tr><tr><td data-num=\"29\"></td><td><pre>\t\tpopad</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>\t\tiretd</pre></td></tr><tr><td data-num=\"31\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre></pre></td></tr><tr><td data-num=\"34\"></td><td><pre><span class=\"token keyword\">int</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> argc<span class=\"token punctuation\">,</span> <span class=\"token keyword\">char</span><span class=\"token operator\">*</span> argv<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre><span class=\"token punctuation\">&#123;</span>\t</pre></td></tr><tr><td data-num=\"36\"></td><td><pre>\tDWORD dwCr3<span class=\"token punctuation\">;</span> <span class=\"token comment\">//windbg 获取</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>\t<span class=\"token keyword\">char</span> esp<span class=\"token punctuation\">[</span><span class=\"token number\">0x1000</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// 任务切换后的栈</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>\t<span class=\"token comment\">// 此数组的地址就是 TSS 描述符中的 Base</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>\tDWORD TSS<span class=\"token punctuation\">[</span><span class=\"token number\">26</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>\t<span class=\"token comment\">// 也可以直接开辟一块私有内存</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>\t<span class=\"token comment\">//DWORD *TSS = (DWORD*)VirtualAlloc(NULL,104,MEM_COMMIT,PAGE_READWRITE);</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>\t<span class=\"token comment\">//if (TSS == NULL)</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>\t<span class=\"token comment\">//&#123;</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>\t<span class=\"token comment\">//\tprintf (\"VirtualAlloc 失败，% d\\n\", GetLastError ());</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>\t<span class=\"token comment\">//\tgetchar();</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>\t<span class=\"token comment\">//\treturn -1;</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>\t<span class=\"token comment\">//&#125;</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>\t<span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"请在windbg执行: eq 8003f048 %02x00e9%02x`%04x0068\\n\"</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>DWORD<span class=\"token punctuation\">)</span>TSS<span class=\"token operator\">>></span><span class=\"token number\">24</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;</span> <span class=\"token number\">0x000000FF</span><span class=\"token punctuation\">,</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>DWORD<span class=\"token punctuation\">)</span>TSS<span class=\"token operator\">>></span><span class=\"token number\">16</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;</span> <span class=\"token number\">0x000000FF</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span>WORD<span class=\"token punctuation\">)</span>TSS<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre>\t<span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"请在windbg中执行!process 0 0，复制进程DirBase的值，并输入.\\nCR3: \"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> </pre></td></tr><tr><td data-num=\"53\"></td><td><pre>\t<span class=\"token function\">scanf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"%x\"</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>dwCr3<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// 注意是 % x</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"55\"></td><td><pre>\tTSS<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token number\">0x00000000</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// Previous Task Link CPU 填充，表示上一个任务的选择子</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>\tTSS<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token number\">0x00000000</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// ESP0</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre>\tTSS<span class=\"token punctuation\">[</span><span class=\"token number\">2</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token number\">0x00000000</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// SS0</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre>\tTSS<span class=\"token punctuation\">[</span><span class=\"token number\">3</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token number\">0x00000000</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// ESP1</span></pre></td></tr><tr><td data-num=\"59\"></td><td><pre>\tTSS<span class=\"token punctuation\">[</span><span class=\"token number\">4</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token number\">0x00000000</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// SS1</span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre>\tTSS<span class=\"token punctuation\">[</span><span class=\"token number\">5</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token number\">0x00000000</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// ESP2</span></pre></td></tr><tr><td data-num=\"61\"></td><td><pre>\tTSS<span class=\"token punctuation\">[</span><span class=\"token number\">6</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token number\">0x00000000</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// SS2</span></pre></td></tr><tr><td data-num=\"62\"></td><td><pre>\tTSS<span class=\"token punctuation\">[</span><span class=\"token number\">7</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> dwCr3<span class=\"token punctuation\">;</span> \t <span class=\"token comment\">// CR3 学到页就知道是啥了</span></pre></td></tr><tr><td data-num=\"63\"></td><td><pre>\tTSS<span class=\"token punctuation\">[</span><span class=\"token number\">8</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>DWORD<span class=\"token punctuation\">)</span>R0Func<span class=\"token punctuation\">;</span> <span class=\"token comment\">// EIP</span></pre></td></tr><tr><td data-num=\"64\"></td><td><pre>\tTSS<span class=\"token punctuation\">[</span><span class=\"token number\">9</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token number\">0x00000000</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// EFLAGS</span></pre></td></tr><tr><td data-num=\"65\"></td><td><pre>\tTSS<span class=\"token punctuation\">[</span><span class=\"token number\">10</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token number\">0x00000000</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// EAX</span></pre></td></tr><tr><td data-num=\"66\"></td><td><pre>\tTSS<span class=\"token punctuation\">[</span><span class=\"token number\">11</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token number\">0x00000000</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// ECX</span></pre></td></tr><tr><td data-num=\"67\"></td><td><pre>\tTSS<span class=\"token punctuation\">[</span><span class=\"token number\">12</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token number\">0x00000000</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// EDX</span></pre></td></tr><tr><td data-num=\"68\"></td><td><pre>\tTSS<span class=\"token punctuation\">[</span><span class=\"token number\">13</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token number\">0x00000000</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// EBX</span></pre></td></tr><tr><td data-num=\"69\"></td><td><pre>\tTSS<span class=\"token punctuation\">[</span><span class=\"token number\">14</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>DWORD<span class=\"token punctuation\">)</span>esp<span class=\"token operator\">+</span><span class=\"token number\">0x1000</span><span class=\"token punctuation\">;</span> </pre></td></tr><tr><td data-num=\"70\"></td><td><pre>\tTSS<span class=\"token punctuation\">[</span><span class=\"token number\">15</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token number\">0x00000000</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// EBP</span></pre></td></tr><tr><td data-num=\"71\"></td><td><pre>\tTSS<span class=\"token punctuation\">[</span><span class=\"token number\">16</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token number\">0x00000000</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// ESI</span></pre></td></tr><tr><td data-num=\"72\"></td><td><pre>\tTSS<span class=\"token punctuation\">[</span><span class=\"token number\">17</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token number\">0x00000000</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// EDI</span></pre></td></tr><tr><td data-num=\"73\"></td><td><pre>\tTSS<span class=\"token punctuation\">[</span><span class=\"token number\">18</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token number\">0x00000023</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// ES</span></pre></td></tr><tr><td data-num=\"74\"></td><td><pre>\tTSS<span class=\"token punctuation\">[</span><span class=\"token number\">19</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token number\">0x00000008</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// CS</span></pre></td></tr><tr><td data-num=\"75\"></td><td><pre>\tTSS<span class=\"token punctuation\">[</span><span class=\"token number\">20</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token number\">0x00000010</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// SS</span></pre></td></tr><tr><td data-num=\"76\"></td><td><pre>\tTSS<span class=\"token punctuation\">[</span><span class=\"token number\">21</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token number\">0x00000000</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// DS</span></pre></td></tr><tr><td data-num=\"77\"></td><td><pre>\tTSS<span class=\"token punctuation\">[</span><span class=\"token number\">22</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token number\">0x00000000</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// FS</span></pre></td></tr><tr><td data-num=\"78\"></td><td><pre>\tTSS<span class=\"token punctuation\">[</span><span class=\"token number\">23</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token number\">0x00000000</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// GS</span></pre></td></tr><tr><td data-num=\"79\"></td><td><pre>\tTSS<span class=\"token punctuation\">[</span><span class=\"token number\">24</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token number\">0x00000000</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// LDT Segment Selector</span></pre></td></tr><tr><td data-num=\"80\"></td><td><pre>\tTSS<span class=\"token punctuation\">[</span><span class=\"token number\">25</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token number\">0x20ac0000</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// I/O Map Base Address</span></pre></td></tr><tr><td data-num=\"81\"></td><td><pre></pre></td></tr><tr><td data-num=\"82\"></td><td><pre>\t<span class=\"token keyword\">char</span> buff<span class=\"token punctuation\">[</span><span class=\"token number\">6</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span><span class=\"token number\">0x48</span><span class=\"token punctuation\">,</span><span class=\"token number\">0</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span>\t</pre></td></tr><tr><td data-num=\"83\"></td><td><pre>\t__asm</pre></td></tr><tr><td data-num=\"84\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"85\"></td><td><pre>\t\tcall fword ptr<span class=\"token punctuation\">[</span>buff<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"86\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"87\"></td><td><pre>\t<span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"ok: %d\\nESP: %x\\nCS: %x\\n\"</span><span class=\"token punctuation\">,</span> dwOk<span class=\"token punctuation\">,</span> dwESP<span class=\"token punctuation\">,</span> dwCS<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"88\"></td><td><pre></pre></td></tr><tr><td data-num=\"89\"></td><td><pre>\t<span class=\"token keyword\">return</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"90\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p><img data-src=\"image004.png\" alt=\"\" /></p>\n<h3 id=\"使用jmp去访问一个任务段并能够正确返回\"><a class=\"anchor\" href=\"#使用jmp去访问一个任务段并能够正确返回\">#</a> 使用 JMP 去访问一个任务段，并能够正确返回</h3>\n<p>和 CALL FAR 对比，NT 位不会置 1，TSS  <code>previous task link</code>  也不会填充旧的 TR，因此想要返回，可以先保存旧的 TR，然后 JMP FAR 回去。</p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;Windows.h></span></span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;stdio.h></span></span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>DWORD dwOk<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>DWORD dwESP<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>DWORD dwCS<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>BYTE PrevTr<span class=\"token punctuation\">[</span><span class=\"token number\">6</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// 旧 TR，供裸函数返回</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token comment\">// 任务切换后的 EIP</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token keyword\">void</span> <span class=\"token function\">__declspec</span><span class=\"token punctuation\">(</span>naked<span class=\"token punctuation\">)</span> <span class=\"token function\">R3Func</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>\t__asm</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>\t\tpushad</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>\t\tpushfd</pre></td></tr><tr><td data-num=\"17\"></td><td><pre></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>\t\tpush fs</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>\t\t<span class=\"token keyword\">int</span> <span class=\"token number\">3</span> <span class=\"token comment\">//int 3 会修改 FS</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>\t\tpop fs</pre></td></tr><tr><td data-num=\"21\"></td><td><pre></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>\t\tmov eax<span class=\"token punctuation\">,</span><span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>\t\tmov dword ptr ds<span class=\"token operator\">:</span><span class=\"token punctuation\">[</span>dwOk<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>eax</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>\t\tmov eax<span class=\"token punctuation\">,</span>esp</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>\t\tmov dword ptr ds<span class=\"token operator\">:</span><span class=\"token punctuation\">[</span>dwESP<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>eax</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>\t\tmov ax<span class=\"token punctuation\">,</span>cs</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>\t\tmov word ptr ds<span class=\"token operator\">:</span><span class=\"token punctuation\">[</span>dwCS<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>ax</pre></td></tr><tr><td data-num=\"28\"></td><td><pre></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>\t\tpopfd</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>\t\tpopad</pre></td></tr><tr><td data-num=\"31\"></td><td><pre>\t\t</pre></td></tr><tr><td data-num=\"32\"></td><td><pre>\t\tjmp fword ptr ds<span class=\"token operator\">:</span><span class=\"token punctuation\">[</span>PrevTr<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre></pre></td></tr><tr><td data-num=\"36\"></td><td><pre><span class=\"token keyword\">int</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> argc<span class=\"token punctuation\">,</span> <span class=\"token keyword\">char</span><span class=\"token operator\">*</span> argv<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre><span class=\"token punctuation\">&#123;</span>\t</pre></td></tr><tr><td data-num=\"38\"></td><td><pre>\tDWORD dwCr3<span class=\"token punctuation\">;</span> <span class=\"token comment\">//windbg 获取</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>\t<span class=\"token keyword\">char</span> esp<span class=\"token punctuation\">[</span><span class=\"token number\">0x1000</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// 任务切换后的栈，数组名就是 ESP</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"41\"></td><td><pre>\t<span class=\"token comment\">// 此数组的地址就是 TSS 描述符中的 Base</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>\tDWORD <span class=\"token operator\">*</span>TSS <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>DWORD<span class=\"token operator\">*</span><span class=\"token punctuation\">)</span><span class=\"token function\">VirtualAlloc</span><span class=\"token punctuation\">(</span><span class=\"token constant\">NULL</span><span class=\"token punctuation\">,</span><span class=\"token number\">104</span><span class=\"token punctuation\">,</span>MEM_COMMIT<span class=\"token punctuation\">,</span>PAGE_READWRITE<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>TSS <span class=\"token operator\">==</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>\t\t<span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"VirtualAlloc 失败，%d\\n\"</span><span class=\"token punctuation\">,</span> <span class=\"token function\">GetLastError</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>\t\t<span class=\"token function\">getchar</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>\t\t<span class=\"token keyword\">return</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>\t<span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"请在windbg执行: eq 8003f048 %02x00e9%02x`%04x0068\\n\"</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>DWORD<span class=\"token punctuation\">)</span>TSS<span class=\"token operator\">>></span><span class=\"token number\">24</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;</span> <span class=\"token number\">0x000000FF</span><span class=\"token punctuation\">,</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>DWORD<span class=\"token punctuation\">)</span>TSS<span class=\"token operator\">>></span><span class=\"token number\">16</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;</span> <span class=\"token number\">0x000000FF</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span>WORD<span class=\"token punctuation\">)</span>TSS<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>\t<span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"请在windbg中执行!process 0 0，复制进程DirBase的值，并输入.\\nCR3: \"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> </pre></td></tr><tr><td data-num=\"51\"></td><td><pre>\t<span class=\"token function\">scanf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"%x\"</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>dwCr3<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// 注意是 % x</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"53\"></td><td><pre>\tTSS<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token number\">0x00000000</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// Previous Task Link CPU 填充，表示上一个任务的选择子</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre>\tTSS<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token number\">0x00000000</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// ESP0</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre>\tTSS<span class=\"token punctuation\">[</span><span class=\"token number\">2</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token number\">0x00000000</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// SS0</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>\tTSS<span class=\"token punctuation\">[</span><span class=\"token number\">3</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token number\">0x00000000</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// ESP1</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre>\tTSS<span class=\"token punctuation\">[</span><span class=\"token number\">4</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token number\">0x00000000</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// SS1</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre>\tTSS<span class=\"token punctuation\">[</span><span class=\"token number\">5</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token number\">0x00000000</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// ESP2</span></pre></td></tr><tr><td data-num=\"59\"></td><td><pre>\tTSS<span class=\"token punctuation\">[</span><span class=\"token number\">6</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token number\">0x00000000</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// SS2</span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre>\tTSS<span class=\"token punctuation\">[</span><span class=\"token number\">7</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> dwCr3<span class=\"token punctuation\">;</span> <span class=\"token comment\">// CR3 学到页就知道是啥了</span></pre></td></tr><tr><td data-num=\"61\"></td><td><pre>\tTSS<span class=\"token punctuation\">[</span><span class=\"token number\">8</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>DWORD<span class=\"token punctuation\">)</span>R3Func<span class=\"token punctuation\">;</span> <span class=\"token comment\">// EIP</span></pre></td></tr><tr><td data-num=\"62\"></td><td><pre>\tTSS<span class=\"token punctuation\">[</span><span class=\"token number\">9</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token number\">0x00000000</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// EFLAGS</span></pre></td></tr><tr><td data-num=\"63\"></td><td><pre>\tTSS<span class=\"token punctuation\">[</span><span class=\"token number\">10</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token number\">0x00000000</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// EAX</span></pre></td></tr><tr><td data-num=\"64\"></td><td><pre>\tTSS<span class=\"token punctuation\">[</span><span class=\"token number\">11</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token number\">0x00000000</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// ECX</span></pre></td></tr><tr><td data-num=\"65\"></td><td><pre>\tTSS<span class=\"token punctuation\">[</span><span class=\"token number\">12</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token number\">0x00000000</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// EDX</span></pre></td></tr><tr><td data-num=\"66\"></td><td><pre>\tTSS<span class=\"token punctuation\">[</span><span class=\"token number\">13</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token number\">0x00000000</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// EBX</span></pre></td></tr><tr><td data-num=\"67\"></td><td><pre>\tTSS<span class=\"token punctuation\">[</span><span class=\"token number\">14</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>DWORD<span class=\"token punctuation\">)</span>esp<span class=\"token operator\">+</span><span class=\"token number\">0x1000</span><span class=\"token punctuation\">;</span> </pre></td></tr><tr><td data-num=\"68\"></td><td><pre>\tTSS<span class=\"token punctuation\">[</span><span class=\"token number\">15</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token number\">0x00000000</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// EBP</span></pre></td></tr><tr><td data-num=\"69\"></td><td><pre>\tTSS<span class=\"token punctuation\">[</span><span class=\"token number\">16</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token number\">0x00000000</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// ESI</span></pre></td></tr><tr><td data-num=\"70\"></td><td><pre>\tTSS<span class=\"token punctuation\">[</span><span class=\"token number\">17</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token number\">0x00000000</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// EDI</span></pre></td></tr><tr><td data-num=\"71\"></td><td><pre>\tTSS<span class=\"token punctuation\">[</span><span class=\"token number\">18</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token number\">0x00000023</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// ES</span></pre></td></tr><tr><td data-num=\"72\"></td><td><pre>\tTSS<span class=\"token punctuation\">[</span><span class=\"token number\">19</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token number\">0x00000008</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// CS</span></pre></td></tr><tr><td data-num=\"73\"></td><td><pre>\tTSS<span class=\"token punctuation\">[</span><span class=\"token number\">20</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token number\">0x00000010</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// SS</span></pre></td></tr><tr><td data-num=\"74\"></td><td><pre>\tTSS<span class=\"token punctuation\">[</span><span class=\"token number\">21</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token number\">0x00000000</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// DS</span></pre></td></tr><tr><td data-num=\"75\"></td><td><pre>\tTSS<span class=\"token punctuation\">[</span><span class=\"token number\">22</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token number\">0x00000000</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// FS</span></pre></td></tr><tr><td data-num=\"76\"></td><td><pre>\tTSS<span class=\"token punctuation\">[</span><span class=\"token number\">23</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token number\">0x00000000</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// GS</span></pre></td></tr><tr><td data-num=\"77\"></td><td><pre>\tTSS<span class=\"token punctuation\">[</span><span class=\"token number\">24</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token number\">0x00000000</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// LDT Segment Selector</span></pre></td></tr><tr><td data-num=\"78\"></td><td><pre>\tTSS<span class=\"token punctuation\">[</span><span class=\"token number\">25</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token number\">0x20ac0000</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// I/O Map Base Address</span></pre></td></tr><tr><td data-num=\"79\"></td><td><pre></pre></td></tr><tr><td data-num=\"80\"></td><td><pre>\t<span class=\"token keyword\">char</span> buff<span class=\"token punctuation\">[</span><span class=\"token number\">6</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span><span class=\"token number\">0x48</span><span class=\"token punctuation\">,</span><span class=\"token number\">0</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span>\t</pre></td></tr><tr><td data-num=\"81\"></td><td><pre>\t__asm</pre></td></tr><tr><td data-num=\"82\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"83\"></td><td><pre>\t\tstr ax</pre></td></tr><tr><td data-num=\"84\"></td><td><pre>\t\tlea edi<span class=\"token punctuation\">,</span><span class=\"token punctuation\">[</span>PrevTr<span class=\"token operator\">+</span><span class=\"token number\">4</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"85\"></td><td><pre>\t\tmov <span class=\"token punctuation\">[</span>edi<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>ax</pre></td></tr><tr><td data-num=\"86\"></td><td><pre>\t\t</pre></td></tr><tr><td data-num=\"87\"></td><td><pre>\t\tjmp fword ptr<span class=\"token punctuation\">[</span>buff<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"88\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"89\"></td><td><pre>\t<span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"ok: %d\\nESP: %x\\nCS: %x\\n\"</span><span class=\"token punctuation\">,</span> dwOk<span class=\"token punctuation\">,</span> dwESP<span class=\"token punctuation\">,</span> dwCS<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"90\"></td><td><pre>\t<span class=\"token function\">system</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"pause\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"91\"></td><td><pre>\t<span class=\"token keyword\">return</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"92\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p><img data-src=\"image005.png\" alt=\"\" /></p>\n<p>由这个例子我们可以发现系统的 TSS 描述符为 <code>80008b04`200020ab</code> （TR 的段选择子为 0x28）</p>\n<p><img data-src=\"image006.png\" alt=\"\" /></p>\n<p>系统 TSS 的地址为： <code>80042000</code> ，查看一下。</p>\n<p><img data-src=\"image007.png\" alt=\"\" /></p>\n<h1 id=\"reference\"><a class=\"anchor\" href=\"#reference\">#</a> Reference</h1>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L0t3YW5zeS9hcnRpY2xlL2RldGFpbHMvMTA4ODkwNTg2\">https://blog.csdn.net/Kwansy/article/details/108890586</span><br />\n<span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cuY25ibG9ncy5jb20vcmV2ZXJjYy9wLzE0NDY4MzMwLmh0bWw=\">https://www.cnblogs.com/revercc/p/14468330.html</span></p>\n",
            "tags": [
                "TSS"
            ]
        },
        {
            "id": "https://or0kit.github.io/Bin/Core/WindowsXp/Protect-Mode/%E4%BF%9D%E6%8A%A4%E6%A8%A1%E5%BC%8F-%E9%99%B7%E9%98%B1%E9%97%A8/",
            "url": "https://or0kit.github.io/Bin/Core/WindowsXp/Protect-Mode/%E4%BF%9D%E6%8A%A4%E6%A8%A1%E5%BC%8F-%E9%99%B7%E9%98%B1%E9%97%A8/",
            "title": "保护模式-陷阱门",
            "date_published": "2021-08-13T06:40:28.000Z",
            "content_html": "<h1 id=\"前言\"><a class=\"anchor\" href=\"#前言\">#</a> 前言</h1>\n<p>Windows 使用了中断门，用于系统调用和调试（比如调试断点）</p>\n<p>IF 位，是标志寄存器 EFLEAG，下标为 9 的位置。</p>\n<p>中断门和陷阱门都不可以传递参数，可能它们的作用被 CPU 制造商规定为辅助作用，但是操作系统怎么使用，就看操作系统的设计者怎么想的。</p>\n<p>它们的段描述符区别在于 TYPE 域，且都是系统段描述符</p>\n<p>这些都是 CPU 层面的概念，操作系统只是使用，然后根据硬件返回出来的值（在硬件方面可能就是电压表示的二进制）进行判断对与错，然后操作系统会提示用户正确或错误。</p>\n<p>转自<span class=\"exturl\" data-url=\"aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQxOTg4NDQ4L2FydGljbGUvZGV0YWlscy8xMDI1OTk5NjE=\"> https://blog.csdn.net/qq_41988448/article/details/102599961</span> 的评论</p>\n<h2 id=\"陷阱门与中断门的区别\"><a class=\"anchor\" href=\"#陷阱门与中断门的区别\">#</a> 陷阱门与中断门的区别</h2>\n<p>中断门执行时，会将 IF 标志位清零，但陷阱门不会</p>\n<p>IF=0 时：程序不再接收可屏蔽中断</p>\n<p>可屏蔽中断：比如程序正在运行时，我们通过键盘敲击了锁屏的快捷键，若 IF 位为 1，CPU 就能够接收到我们敲击键盘的指令并锁屏</p>\n<p>可屏蔽中断：<br />\n简述：保存断点入栈，响应经中断控制器 8259 优先级判断后的中断请求，恢复断点。<br />\nI/O 设备发出的所有中断 (IRQ) 都可以产生可屏蔽中断，受标志位 IF 的影响，根据中断循序标志的设置来判断 CPU 是否响应中断请求。</p>\n<blockquote>\n<p>接口发出中断请求<br />\n当前指令执行完后，CPU 响应中断<br />\n中断类型号 N 送 CPU<br />\n 当前的 EFR CS HE EIP 推入栈<br />\n清除 IF (中断允许标志位，IF=0，禁止 CPU 响应外部中断请求，IF=1，允许响应) 和 TF（跟踪标志，也称单步执行，CPU 按跟踪方式执行）<br />\n由中断类型号，查中断向量表获得中断服务子程序的入口地址<br />\n CPU 执行中断子程序<br />\n开中断<br />\n IRET 指令使 EIP CS HE EFR 弹出栈 ，返回被中断的源程序</p>\n</blockquote>\n<p>不可屏蔽中断：不可阻止的中断请求。如： 当突然断电，CPU 不是立马死掉，CPU 内部有一个电容，断电的时候，还会运行一会儿，用于处理后续工作，这个是不可屏蔽中断。</p>\n<h2 id=\"trap-gate-descriptor\"><a class=\"anchor\" href=\"#trap-gate-descriptor\">#</a> Trap-Gate-Descriptor</h2>\n<p><img data-src=\"image001.png\" alt=\"\" /></p>\n<h2 id=\"实践\"><a class=\"anchor\" href=\"#实践\">#</a> 实践</h2>\n<p>知道了理论，开始实践。<br />\n和中断门一样的流程，只是我们构造的描述符有一点不同： <code>0040EF00`00081020</code>   把中断门的 <code>EE</code>  改为了 <code>EF</code></p>\n<p>代码还是以前的代码，结果也是一样的。<br />\n不再复写一份了（懒）。</p>\n<h1 id=\"reference\"><a class=\"anchor\" href=\"#reference\">#</a> Reference</h1>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM1NDI1MjQzL2FydGljbGUvZGV0YWlscy84MzY1NzIwMw==\">https://blog.csdn.net/qq_35425243/article/details/83657203</span></p>\n",
            "tags": [
                "IDT",
                "提权",
                "陷阱门描述符"
            ]
        },
        {
            "id": "https://or0kit.github.io/Bin/Core/WindowsXp/Protect-Mode/%E4%BF%9D%E6%8A%A4%E6%A8%A1%E5%BC%8F-%E4%B8%AD%E6%96%AD%E9%97%A8/",
            "url": "https://or0kit.github.io/Bin/Core/WindowsXp/Protect-Mode/%E4%BF%9D%E6%8A%A4%E6%A8%A1%E5%BC%8F-%E4%B8%AD%E6%96%AD%E9%97%A8/",
            "title": "保护模式-中断门",
            "date_published": "2021-08-13T06:40:15.000Z",
            "content_html": "<h1 id=\"中断门\"><a class=\"anchor\" href=\"#中断门\">#</a> 中断门</h1>\n<h2 id=\"中断门的作用\"><a class=\"anchor\" href=\"#中断门的作用\">#</a> 中断门的作用</h2>\n<p>先前学习的调用门在实际的 Windows 中并没有被使用，只是操作系统提供了调用门描述符给开发人员使用。相比之下，Windows 使用了中断门，用于：</p>\n<blockquote>\n<p>系统调用（老的 CPU 通过中断门进入 RING（内核）0 层；新的 CPU 使用快速调用）<br />\n调试（常见的 INT3 对应硬编码为 0xCC）</p>\n</blockquote>\n<h2 id=\"中断门执行流程\"><a class=\"anchor\" href=\"#中断门执行流程\">#</a> 中断门执行流程</h2>\n<p>【重点】</p>\n<ul>\n<li>根据 INT XXX 的值 查 IDT（中断描述符表），找到对应的段描述符 这个描述符是一个中断门描述符</li>\n<li>在中断门描述符中存储另一个代码段的选择子</li>\n<li>选择子指向的段 段.Base + 偏移地址 就是真正要执行的地址</li>\n</ul>\n<h2 id=\"idt\"><a class=\"anchor\" href=\"#idt\">#</a> IDT</h2>\n<p>IDT 全称 Interrupt Descriptor Table（中断描述符表）, 同 GDT 一样，IDT 也是由一系列描述符组成的，每个<br />\n描述符占 8 个字节。但要注意的是，IDT 表中的第一个元素不是 NULL。</p>\n<p>IDT 中存储的段描述符都是<ins>系统段描述符</ins></p>\n<p>IDT 可以包含三种门描述符：①任务门描述符；②中断门描述符；③陷阱门描述符</p>\n<p>在 windbg 中查看 IDT 表的基址和长度:</p>\n<p>查看地址： <code>r idtr</code></p>\n<p>查看长度： <code>r idtl</code></p>\n<h2 id=\"中断门描述符\"><a class=\"anchor\" href=\"#中断门描述符\">#</a> 中断门描述符</h2>\n<p><img data-src=\"image001.png\" alt=\"\" /></p>\n<p>当一个段描述符是一个调用门描述符时，有以下特征：</p>\n<ul>\n<li>S 位为 0，表示该段描述符为系统段描述符（中断门描述符属于系统段描述符）</li>\n<li>Type 域为 1110，表示该段描述符为 32 位中断门</li>\n<li>低 16 位到 31 位存储一个段选择子，该段选择子才和代码真正要调用的地址相关</li>\n<li>真正要调用的地址 = 段选择子所指向的段.Base + 32 位的段中偏移 （段中偏移分为两部分：高位 31-16 位和低位 15-0 位）</li>\n<li>段.Base 默认为 0，故真正要调用的地址 = 32 位的段中偏移</li>\n</ul>\n<h2 id=\"调用门描述符和中断门描述符各部分的对比\"><a class=\"anchor\" href=\"#调用门描述符和中断门描述符各部分的对比\">#</a> 调用门描述符和中断门描述符各部分的对比</h2>\n<p><img data-src=\"image002.png\" alt=\"\" /></p>\n<p>可以发现中断门描述符和调用门描述符的结构基本一致，只在 Type 域和参数计数处不同（Type 域是描述符的类型标识；中断门不允许传参）</p>\n<h2 id=\"中断门堆栈变化\"><a class=\"anchor\" href=\"#中断门堆栈变化\">#</a> 中断门堆栈变化</h2>\n<p>使用调用门的方法是 CALL FAR，而使用中断门的方法是  <code>INT N</code> ，其中，N 表示中断门描述符在 IDT 表中的下标。</p>\n<p>和调用门一样，中断门也可以用来提权。不提权时， <code>INT N</code>  会压栈 CS，EFLAG EIP；<br />\n提权时，会依次压栈 SS ESP EFLAG CS EIP。<br />\n需要用堆栈保存 EFLAG 是因为中断门会将 EFLAG 的 IF 位置 0。</p>\n<p><img data-src=\"image006.png\" alt=\"\" /></p>\n<h2 id=\"实践\"><a class=\"anchor\" href=\"#实践\">#</a> 实践</h2>\n<p>知道了理论，开始实践。</p>\n<ol>\n<li>构造 Interrupt Gate Descriptor</li>\n</ol>\n<p><code>0000 0000 0000 0000 1110 1110 0000 0000`0000 0000 0000 1000 0000 0000 0000 0000</code></p>\n<p>段内偏移还不确定，暂时置为 0。<br />\n十六进制为 <code>0000ee00`00080000</code></p>\n<ol start=\"2\">\n<li>测试代码</li>\n</ol>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span><span class=\"token string\">&lt;stdio.h></span></span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span><span class=\"token string\">&lt;windows.h></span></span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>DWORD dwH2GValue<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token function\">__declspec</span><span class=\"token punctuation\">(</span>naked<span class=\"token punctuation\">)</span> <span class=\"token keyword\">void</span> <span class=\"token function\">GetH2GValue</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>\t__asm</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\t\tpushad</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>\t\tpushfd</pre></td></tr><tr><td data-num=\"12\"></td><td><pre></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    <span class=\"token comment\">// 读高 2G 内存</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>\t\tmov eax<span class=\"token punctuation\">,</span><span class=\"token punctuation\">[</span><span class=\"token number\">0x8003f00c</span><span class=\"token punctuation\">]</span>  </pre></td></tr><tr><td data-num=\"15\"></td><td><pre>\t\tmov ebx<span class=\"token punctuation\">,</span><span class=\"token punctuation\">[</span>eax<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>\t\tmov dwH2GValue<span class=\"token punctuation\">,</span>ebx</pre></td></tr><tr><td data-num=\"17\"></td><td><pre></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>\t\tpopfd</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>\t\tpopad</pre></td></tr><tr><td data-num=\"20\"></td><td><pre></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>\t\tiretd</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre></pre></td></tr><tr><td data-num=\"25\"></td><td><pre><span class=\"token keyword\">void</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>\t__asm</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>\t\tINT <span class=\"token number\">0x20</span>      <span class=\"token comment\">// 暂时有疑问，选这个索引是因为有的博客说这个地址没有用上。可是我在 windbg 中看到这个地址也是有值的。</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>\t<span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"dwH2GValue:%#X\"</span><span class=\"token punctuation\">,</span>dwH2GValue<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>VC 中反汇编查看</p>\n<p><img data-src=\"image003.png\" alt=\"\" /></p>\n<p>我们要跳转的地址为 <code>0x00401020</code></p>\n<p>确定 Interrupt Gate Descriptor 为： <code>0040ee00`00081020</code></p>\n<ol start=\"3\">\n<li>在 windbg 中赋值</li>\n</ol>\n<p>直接在 IDT 表中修改索引为 0x20 的中断门描述符</p>\n<p><code>eq 8003f500 0040ee00`00081020</code></p>\n<ol start=\"4\">\n<li>在调试机中运行代码</li>\n</ol>\n<p>结果：</p>\n<p><img data-src=\"image004.png\" alt=\"\" /></p>\n<p>在 windbg 中确认打印数值无误。</p>\n<p><img data-src=\"image005.png\" alt=\"\" /></p>\n<h1 id=\"reference\"><a class=\"anchor\" href=\"#reference\">#</a> Reference</h1>\n<p>滴水课件<br />\n<span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cuNTJwb2ppZS5jbi90aHJlYWQtMTQ1NTY4NC0xLTEuaHRtbA==\"> https://www.52pojie.cn/thread-1455684-1-1.html</span></p>\n",
            "tags": [
                "中断门描述符",
                "IDT",
                "提权"
            ]
        },
        {
            "id": "https://or0kit.github.io/Bin/Core/WindowsXp/Protect-Mode/%E4%BF%9D%E6%8A%A4%E6%A8%A1%E5%BC%8F-%E8%B0%83%E7%94%A8%E9%97%A8%E6%8F%90%E6%9D%83/",
            "url": "https://or0kit.github.io/Bin/Core/WindowsXp/Protect-Mode/%E4%BF%9D%E6%8A%A4%E6%A8%A1%E5%BC%8F-%E8%B0%83%E7%94%A8%E9%97%A8%E6%8F%90%E6%9D%83/",
            "title": "保护模式-调用门提权",
            "date_published": "2021-08-09T04:02:20.000Z",
            "content_html": "<h1 id=\"前言\"><a class=\"anchor\" href=\"#前言\">#</a> 前言</h1>\n<p>在学习长调用时没有用实例具体分析，因为牵扯到了调用门的知识。</p>\n<h1 id=\"调用门\"><a class=\"anchor\" href=\"#调用门\">#</a> 调用门</h1>\n<h2 id=\"调用门的作用\"><a class=\"anchor\" href=\"#调用门的作用\">#</a> 调用门的作用</h2>\n<p>调用门可以用来提权，通过提权可以实现访问高地址空间等 RING0（内核）层才能进行的操作</p>\n<hr />\n<h2 id=\"调用门和长调用关系\"><a class=\"anchor\" href=\"#调用门和长调用关系\">#</a> 调用门和长调用关系</h2>\n<p>回顾先前的笔记可知：</p>\n<p>长调用 CALL FAR CS:EIP 指令要<strong>调用的地址</strong>是由 CS 段选择子查 GDT 得到的<strong>调用门</strong> 段描述符得来的，后面的 EIP 不发挥作用</p>\n<h2 id=\"调用门执行流程\"><a class=\"anchor\" href=\"#调用门执行流程\">#</a> 调用门执行流程</h2>\n<ol>\n<li>根据 CS 的值 查 GDT，找到对应的段描述符 这个描述符是一个调用门</li>\n<li>在调用门描述符中存储另一个代码段的选择子</li>\n<li>选择子指向的段 段.Base + 偏移地址 就是真正要执行的地址</li>\n</ol>\n<h2 id=\"调用门描述符\"><a class=\"anchor\" href=\"#调用门描述符\">#</a> 调用门描述符</h2>\n<h3 id=\"对比段描述符\"><a class=\"anchor\" href=\"#对比段描述符\">#</a> 对比段描述符</h3>\n<p><img data-src=\"image001.png\" alt=\"\" /></p>\n<p>调用门描述符结构</p>\n<p><img data-src=\"image002.png\" alt=\"\" /></p>\n<hr />\n<p>当一个段描述符是一个调用门描述符时，有以下特征：</p>\n<ul>\n<li>S 位为 0，表示该段描述符为系统段描述符（调用门描述符属于系统段描述符）</li>\n<li>Type 域为 1100，表示该段描述符为 32 位调用门</li>\n<li>低 16 位到 31 位由原本的基地址变为存储一个段选择子，该段选择子才和代码<strong>真正要调用的地址</strong>相关</li>\n<li>真正要调用的地址 = 段选择子所指向的段.Base + 32 位的段中偏移 （段中偏移分为两部分：高位 31-16 位和低位 15-0 位）</li>\n<li>段.Base 默认为 0，故真正要调用的地址 = 32 位的段中偏移</li>\n</ul>\n<hr />\n<p>给出段描述符和调用门描述符各部分的对比：</p>\n<hr />\n<h2 id=\"段描述符\"><a class=\"anchor\" href=\"#段描述符\">#</a> 段描述符</h2>\n<table>\n<thead>\n<tr>\n<th>数据位</th>\n<th>31-24</th>\n<th>23</th>\n<th>22</th>\n<th>21</th>\n<th>20</th>\n<th>19-16</th>\n<th>15</th>\n<th>14-13</th>\n<th>12</th>\n<th>11-8</th>\n<th>7-0</th>\n<th></th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>含义</td>\n<td>Base</td>\n<td>G</td>\n<td>D/B</td>\n<td>0</td>\n<td>AVL</td>\n<td>Seg.Limit</td>\n<td>P</td>\n<td>DPL</td>\n<td>S</td>\n<td>Type</td>\n<td>Base</td>\n<td></td>\n</tr>\n<tr>\n<td>解释</td>\n<td>基地址</td>\n<td>粒度</td>\n<td>默认操作大小</td>\n<td>固定为 0</td>\n<td>用于系统软件使用</td>\n<td>段大小限制</td>\n<td>有效位</td>\n<td>特权等级</td>\n<td>描述符类型</td>\n<td>段类型</td>\n<td>基地址</td>\n<td></td>\n</tr>\n</tbody>\n<tbody>\n<tr>\n<td>数据位</td>\n<td>31-16</td>\n<td>15</td>\n<td>14-13</td>\n<td>12</td>\n<td>11-8</td>\n<td>7-5</td>\n<td>4-0</td>\n</tr>\n<tr>\n<td>------</td>\n<td>--------</td>\n<td>------</td>\n<td>--------</td>\n<td>-----</td>\n<td>--------</td>\n<td>-------</td>\n<td>-----------</td>\n</tr>\n<tr>\n<td>含义</td>\n<td>offset</td>\n<td>P</td>\n<td>DPL</td>\n<td>S</td>\n<td>Type</td>\n<td>无</td>\n<td>param.count</td>\n</tr>\n<tr>\n<td>解释</td>\n<td>段中偏移</td>\n<td>有效位</td>\n<td>特权等级</td>\n<td>值为 0</td>\n<td>值为 1100</td>\n<td>值为 000</td>\n<td>参数计数</td>\n</tr>\n</tbody>\n</table>\n<hr />\n<h2 id=\"调用门描述符-2\"><a class=\"anchor\" href=\"#调用门描述符-2\">#</a> 调用门描述符</h2>\n<table>\n<thead>\n<tr>\n<th>数据位</th>\n<th>31-16</th>\n<th>15-0</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>含义</td>\n<td>Base Adress</td>\n<td>Segment Limit</td>\n</tr>\n<tr>\n<td>解释</td>\n<td>基地址</td>\n<td>段大小限制</td>\n</tr>\n<tr>\n<td></td>\n<td></td>\n<td></td>\n</tr>\n<tr>\n<td>数据位</td>\n<td>31-16</td>\n<td>15-0</td>\n</tr>\n<tr>\n<td>含义</td>\n<td>selector</td>\n<td>offset</td>\n</tr>\n<tr>\n<td>解释</td>\n<td>段选择子</td>\n<td>段中偏移</td>\n</tr>\n</tbody>\n</table>\n<h2 id=\"构造无参调用门描述符\"><a class=\"anchor\" href=\"#构造无参调用门描述符\">#</a> 构造无参调用门描述符</h2>\n<p>了解了调用门描述符的结构后，尝试自己构造一个无参的调用门描述符，如下：</p>\n<table>\n<thead>\n<tr>\n<th>数据位</th>\n<th>31-16</th>\n<th>15</th>\n<th>14-13</th>\n<th>12</th>\n<th>11-8</th>\n<th>7-5</th>\n<th>4-0</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>含义</td>\n<td>offset</td>\n<td>P</td>\n<td>DPL</td>\n<td>S</td>\n<td>Type</td>\n<td>无</td>\n<td>param</td>\n</tr>\n<tr>\n<td>解释</td>\n<td>段中偏移</td>\n<td>有效位</td>\n<td>特权等级</td>\n<td>值为 0</td>\n<td>值为 1100</td>\n<td>值为 000</td>\n<td>参数</td>\n</tr>\n<tr>\n<td>值（二进制）</td>\n<td>0</td>\n<td>1</td>\n<td>11</td>\n<td>0</td>\n<td>1100</td>\n<td>000</td>\n<td>0000</td>\n</tr>\n</tbody>\n<tbody>\n<tr>\n<td>数据位</td>\n<td>31-16</td>\n<td>15-0</td>\n</tr>\n<tr>\n<td>:-------------</td>\n<td>--------</td>\n<td>--------</td>\n</tr>\n<tr>\n<td>含义</td>\n<td>selector</td>\n<td>offset</td>\n</tr>\n<tr>\n<td>解释</td>\n<td>段选择子</td>\n<td>段中偏移</td>\n</tr>\n<tr>\n<td>值（十六进制）</td>\n<td>0x0008</td>\n<td>0</td>\n</tr>\n</tbody>\n</table>\n<p>得到调用门描述符为：0000EC00`00080000</p>\n<p>段中偏移暂时不明确要调用的代码段，先置 0</p>\n<h3 id=\"示例代码\"><a class=\"anchor\" href=\"#示例代码\">#</a> 示例代码</h3>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">__declspec</span><span class=\"token punctuation\">(</span>naked<span class=\"token punctuation\">)</span> <span class=\"token keyword\">void</span> <span class=\"token function\">callGate</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>         _asm<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>                 <span class=\"token keyword\">int</span> <span class=\"token number\">3</span>                                <span class=\"token comment\">// 软中断</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>                 retf                                <span class=\"token comment\">// 注意这里长调用对应长返回</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>         <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre> <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token keyword\">int</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>        <span class=\"token keyword\">char</span> buff<span class=\"token punctuation\">[</span><span class=\"token number\">6</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>        <span class=\"token comment\">//*(DWORD*)&amp;buff [0]= 0x12345678;        // 低地址 32 位为 0x12345678，EIP 已废弃，故随便填即可</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>        <span class=\"token comment\">//*(DWORD*)&amp;buff [4]=0x48;                        // 高地址 16 位为 0x48，段选择子</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>        <span class=\"token comment\">// 也可以换作这种写法</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>        _asm<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>                mov dword ptr ds<span class=\"token operator\">:</span><span class=\"token punctuation\">[</span>buff<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span><span class=\"token number\">0x12345678</span>        <span class=\"token comment\">// 低 32 位赋值废弃 EIP</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>                lea eax<span class=\"token punctuation\">,</span>dword ptr ds<span class=\"token operator\">:</span><span class=\"token punctuation\">[</span>buff<span class=\"token punctuation\">]</span>                        <span class=\"token comment\">// 将 buff 地址给 EAX</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>                add eax<span class=\"token punctuation\">,</span><span class=\"token number\">4</span>                                                        <span class=\"token comment\">// 地址 + 4，即得到高地址</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>                mov word ptr ds<span class=\"token operator\">:</span><span class=\"token punctuation\">[</span>eax<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span><span class=\"token number\">0x48</span>                        <span class=\"token comment\">// 高 16 位赋值段选择子 selector</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>        <span class=\"token comment\">// 使用 调用门</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>        _asm<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>                call fword ptr ds<span class=\"token operator\">:</span><span class=\"token punctuation\">[</span>buff<span class=\"token punctuation\">]</span>                        <span class=\"token comment\">//fword 数据宽度为 6 字节</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>        <span class=\"token keyword\">return</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h3 id=\"代码说明\"><a class=\"anchor\" href=\"#代码说明\">#</a> 代码说明</h3>\n<p>代码十分简单，主要分为两部分：</p>\n<ul>\n<li>callGate：调用门真正要调用的函数，先软中断，然后长返回</li>\n<li>main：先构造一个 CS:EIP，这里为 0x48:0x12345678，然后使用调用门</li>\n</ul>\n<p>当我们发动调用门技能时，程序会跳转到我们构造的调用门描述符中预先设置的地址，并且我们的权限会提升到我们设置的权限！！可以做一些操作系统才能做的事情。</p>\n<h3 id=\"实验过程\"><a class=\"anchor\" href=\"#实验过程\">#</a> 实验过程</h3>\n<p>目前一些重要操作只能手动……</p>\n<ol>\n<li>确定要跳转的函数的地址</li>\n</ol>\n<p><img data-src=\"image003.png\" alt=\"\" /></p>\n<ol start=\"2\">\n<li>构造 Call-Gate 描述符</li>\n</ol>\n<p>要跳转的地址为： <code>0x00401020</code></p>\n<p>Call-Gate Descriptor: <code>0040ec00`00081020</code></p>\n<ol start=\"3\">\n<li>修改 GDT 表</li>\n</ol>\n<p><img data-src=\"image004.png\" alt=\"\" /></p>\n<p>修改 <code>0x8003f048</code>  这个地址，因为这是一个没有被用到的段描述符。</p>\n<p><code>eq 8003f048 0040ec00`00081020</code></p>\n<ol start=\"4\">\n<li>在调试机中执行上面的代码</li>\n</ol>\n<p>如果没有意外的话，调试机会被中断。</p>\n<h2 id=\"构造有参的调用门\"><a class=\"anchor\" href=\"#构造有参的调用门\">#</a> 构造有参的调用门</h2>\n<p>在构造调用门描述符时要说明参数个数，关于这个参数个数，需要注意的是，它的值共 5 位（5 个比特位）。</p>\n<h3 id=\"代码\"><a class=\"anchor\" href=\"#代码\">#</a> 代码</h3>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;stdio.h></span></span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;windows.h></span></span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>DWORD x<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>DWORD y<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>DWORD z<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre> <span class=\"token function\">__declspec</span><span class=\"token punctuation\">(</span>naked<span class=\"token punctuation\">)</span> <span class=\"token keyword\">void</span> <span class=\"token function\">callGate</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>        _asm<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>                pushad                        <span class=\"token comment\">// 将所有 32 位通用寄存器压入堆栈</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>                pushfd                        <span class=\"token comment\">// 将 32 位标志寄存器 EFLFAGS 压入堆栈</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>                mov eax<span class=\"token punctuation\">,</span><span class=\"token punctuation\">[</span>esp<span class=\"token operator\">+</span><span class=\"token number\">0x24</span><span class=\"token operator\">+</span><span class=\"token number\">0x8</span><span class=\"token operator\">+</span><span class=\"token number\">0x8</span><span class=\"token punctuation\">]</span>    <span class=\"token comment\">// 从堆栈中取出第一个参数</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>                mov dword ptr ds<span class=\"token operator\">:</span><span class=\"token punctuation\">[</span>x<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>eax      <span class=\"token comment\">// 将取出的参数赋值给全局变量 x</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>                mov eax<span class=\"token punctuation\">,</span><span class=\"token punctuation\">[</span>esp<span class=\"token operator\">+</span><span class=\"token number\">0x24</span><span class=\"token operator\">+</span><span class=\"token number\">0x8</span><span class=\"token operator\">+</span><span class=\"token number\">0x4</span><span class=\"token punctuation\">]</span>    <span class=\"token comment\">// 从堆栈中取出第二个参数</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>                mov dword ptr ds<span class=\"token operator\">:</span><span class=\"token punctuation\">[</span>y<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>eax      <span class=\"token comment\">// 将取出的参数赋值给全局变量 y</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>                mov eax<span class=\"token punctuation\">,</span><span class=\"token punctuation\">[</span>esp<span class=\"token operator\">+</span><span class=\"token number\">0x24</span><span class=\"token operator\">+</span><span class=\"token number\">8</span><span class=\"token operator\">+</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span>        <span class=\"token comment\">// 从堆栈中取出第三个参数</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>                mov dword ptr ds<span class=\"token operator\">:</span><span class=\"token punctuation\">[</span>z<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>eax      <span class=\"token comment\">// 将取出的参数赋值给全局变量 z</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>                popfd                         <span class=\"token comment\">// 将所有 32 位通用寄存器出栈</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>                popad                         <span class=\"token comment\">// 将所有 32 位标志寄存器 EFLFAGS 出栈</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>                retf <span class=\"token number\">0xC</span>                      <span class=\"token comment\">// 注意这里长调用对应长返回，堆栈平衡 0xC=12=3*4 = 参数个数 * 参数的数据宽度（单位字节）</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre> <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre></pre></td></tr><tr><td data-num=\"29\"></td><td><pre><span class=\"token keyword\">int</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>        <span class=\"token keyword\">char</span> buff<span class=\"token punctuation\">[</span><span class=\"token number\">6</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>        <span class=\"token operator\">*</span><span class=\"token punctuation\">(</span>DWORD<span class=\"token operator\">*</span><span class=\"token punctuation\">)</span><span class=\"token operator\">&amp;</span>buff <span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token operator\">=</span> <span class=\"token number\">0x12345678</span><span class=\"token punctuation\">;</span>        <span class=\"token comment\">// 低地址 32 位为 0x12345678，EIP 已废弃，故随便填即可</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>        <span class=\"token operator\">*</span><span class=\"token punctuation\">(</span>DWORD<span class=\"token operator\">*</span><span class=\"token punctuation\">)</span><span class=\"token operator\">&amp;</span>buff <span class=\"token punctuation\">[</span><span class=\"token number\">4</span><span class=\"token punctuation\">]</span><span class=\"token operator\">=</span><span class=\"token number\">0x48</span><span class=\"token punctuation\">;</span>                        <span class=\"token comment\">// 高地址 16 位为 0x48，段选择子</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>        <span class=\"token comment\">// 也可以换作这种写法</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>        <span class=\"token comment\">//_asm&#123;</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>        <span class=\"token comment\">//        mov dword ptr ds:[buff],0x12345678        // 低 32 位赋值废弃 EIP</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>        <span class=\"token comment\">//        lea eax,dword ptr ds:[buff]                        // 将 buff 地址给 EAX</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>        <span class=\"token comment\">//        add eax,4                                                        // 地址 + 4，即得到高地址</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>        <span class=\"token comment\">//        mov word ptr ds:[eax],0x48                        // 高 16 位赋值段选择子 selector</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>        <span class=\"token comment\">//&#125;</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>        <span class=\"token comment\">// 使用 调用门</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>        _asm<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>                push <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>                push <span class=\"token number\">2</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>                push <span class=\"token number\">3</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>                call fword ptr<span class=\"token punctuation\">[</span>buff<span class=\"token punctuation\">]</span>                        <span class=\"token comment\">//fword 数据宽度为 6 字节</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>        <span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"%X\\t%X\\t%X\\n\"</span><span class=\"token punctuation\">,</span>x<span class=\"token punctuation\">,</span>y<span class=\"token punctuation\">,</span>z<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre>        <span class=\"token keyword\">return</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h3 id=\"代码说明-2\"><a class=\"anchor\" href=\"#代码说明-2\">#</a> 代码说明</h3>\n<p>与构造无参调用门描述符相比，主要变化为：</p>\n<p>在使用调用门前压入了三个参数：1、2、3<br />\n 调用代码作用为：①保护现场（压入所有通用寄存器和标志寄存器）；②从堆栈中取出对应的参数；③将取出的参数赋值给对应的全局变量<br />\n调用代码最后要平衡堆栈，ret 0xC         0xC=12=3*4 = 参数个数 * 参数的数据宽度（单位字节）<br />\n在调用结束后，输出调用后被赋值的全局变量，验证参数是否成功传递</p>\n<h3 id=\"实验过程-2\"><a class=\"anchor\" href=\"#实验过程-2\">#</a> 实验过程</h3>\n<p>与无参基本一样。描述符中记加参数个数。<br />\n注意观察堆栈变化。</p>\n<h2 id=\"总结\"><a class=\"anchor\" href=\"#总结\">#</a> 总结</h2>\n<p>当通过门，权限不变的时候，只会 PUSH 两个值：①CS（新的 CS 的值由调用门决定） ；②返回地址<br />\n当通过门，权限改变的时候，会 PUSH 四个值：①SS；② ESP；③ CS ；④ 返回地址   （新的 CS 的值由调用门决定  新的 SS 和 ESP 由 TSS 提供）<br />\n通过门调用时，要执行代码的地址由调用门中的选择子决定；使用 RETF 返回时，由堆栈中压入的返回地址决定</p>\n<h1 id=\"reference\"><a class=\"anchor\" href=\"#reference\">#</a> Reference</h1>\n<p>详细参见：<span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cuNTJwb2ppZS5jbi90aHJlYWQtMTQ1NDM1My0xLTEuaHRtbA==\">https://www.52pojie.cn/thread-1454353-1-1.html</span></p>\n",
            "tags": [
                "提权",
                "调用门",
                "调用门描述符"
            ]
        },
        {
            "id": "https://or0kit.github.io/Bin/Core/WindowsXp/Protect-Mode/%E4%BF%9D%E6%8A%A4%E6%A8%A1%E5%BC%8F-%E9%95%BF%E8%B0%83%E7%94%A8%E4%B8%8E%E7%9F%AD%E8%B0%83%E7%94%A8/",
            "url": "https://or0kit.github.io/Bin/Core/WindowsXp/Protect-Mode/%E4%BF%9D%E6%8A%A4%E6%A8%A1%E5%BC%8F-%E9%95%BF%E8%B0%83%E7%94%A8%E4%B8%8E%E7%9F%AD%E8%B0%83%E7%94%A8/",
            "title": "保护模式-长调用与短调用",
            "date_published": "2021-08-08T12:51:45.000Z",
            "content_html": "<h1 id=\"短调用\"><a class=\"anchor\" href=\"#短调用\">#</a> 短调用</h1>\n<h2 id=\"短调用指令格式\"><a class=\"anchor\" href=\"#短调用指令格式\">#</a> 短调用指令格式</h2>\n<p>CALL 立即数 / 寄存器 / 内存</p>\n<table>\n<thead>\n<tr>\n<th>指令类型</th>\n<th>指令例子</th>\n<th>对应硬编码</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>CALL 立即数</td>\n<td>call 52610610</td>\n<td>E8 F4560A52</td>\n</tr>\n<tr>\n<td>CALL 寄存器</td>\n<td>call eax</td>\n<td>FFD0</td>\n</tr>\n<tr>\n<td>CALL 内存</td>\n<td>call dword ptr ds:[0x52610610]</td>\n<td>FF15 10066152</td>\n</tr>\n</tbody>\n</table>\n<p><img data-src=\"image003.png\" alt=\"\" /></p>\n<p>关于 CALL 指令详细内容参见<span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cuNTJwb2ppZS5jbi90aHJlYWQtMTM3OTk1Mi0xLTEuaHRtbA==\"> https://www.52pojie.cn/thread-1379952-1-1.html</span></p>\n<p>在 OllyDbg 中随便打开一个 EXE，执行 CALL 指令。<br />\n观察堆栈的变化。</p>\n<p><img data-src=\"image001.png\" alt=\"\" /></p>\n<p>单步执行后</p>\n<p><img data-src=\"image002.png\" alt=\"\" /></p>\n<p>对比前后的堆栈情况变化，可以发现：</p>\n<p>短调用影响了 ESP 和 EIP 两个寄存器，并且会将返回地址压入到堆栈中</p>\n<p>短调用通过 RET 指令返回</p>\n<h1 id=\"长调用\"><a class=\"anchor\" href=\"#长调用\">#</a> 长调用</h1>\n<h2 id=\"长调用指令格式\"><a class=\"anchor\" href=\"#长调用指令格式\">#</a> 长调用指令格式</h2>\n<p><code>CALL FAR CS:EIP</code>  (EIP 是废弃的)</p>\n<p>如： <code>CALL FAR 002B:00610610</code></p>\n<p>CALL 指令要调用的地址是由 CS 段选择子查 GDT 表得到的调用门 段描述符得来的，后面的 EIP 不发挥作用。</p>\n<p>长调用可以分为两种：跨段不提权和跨段提权。</p>\n<p>长调用通过 RETF 指令返回。</p>\n<h2 id=\"跨段不提权\"><a class=\"anchor\" href=\"#跨段不提权\">#</a> 跨段不提权</h2>\n<p>所谓的跨段不提权就是指要跳转段和当前段的特权级别相同。</p>\n<p>和短调用不同，长调用会先将 CS 压入堆栈，然后再将返回地址压入堆栈。</p>\n<p>跨段不提权的长调用影响了 ESP EIP CS 三个寄存器，并且会将 CS 和返回地址压入到堆栈中。</p>\n<p>堆栈变化图：</p>\n<p><img data-src=\"image004.png\" alt=\"\" /></p>\n<h2 id=\"跨段提权\"><a class=\"anchor\" href=\"#跨段提权\">#</a> 跨段提权</h2>\n<p>与跨段不提权相对，所谓的跨段提权就是指要跳转段和当前段的特权级别不同。</p>\n<p>跨段提权的长调用 涉及到了权限的变化，一旦涉及到了权限的变化，堆栈也将随之切换，因此相比跨段不提权，还会影响 SS 寄存器。</p>\n<p>跨段提权的长调用影响了 ESP EIP CS SS 四个寄存器，并且会将 SS、ESP、CS 和返回地址压入到堆栈中。</p>\n<p>为什么要压入 SS 和 ESP？</p>\n<p>因为当跨段提权时，堆栈会发生切换，压入 SS 和 ESP 是为了在调用结束后将堆栈恢复成原来的（切换前）的堆栈。</p>\n<p>堆栈切换的来源是什么？</p>\n<p>堆栈切换的来源是 TSS 段，这个留作之后再深入。</p>\n<p>由 RING3 切换到 RING0 的跨段提权堆栈变化图</p>\n<p><img data-src=\"image005.png\" alt=\"\" /></p>\n<h1 id=\"总结\"><a class=\"anchor\" href=\"#总结\">#</a> 总结</h1>\n<p>跨段调用时，一旦有权限切换，就会切换堆栈</p>\n<p>CS 的权限一旦改变，SS 的权限也要随着改变，CS 与 SS 的特权级别必须一致（INTEL 定义的规则）</p>\n<p>JMP FAR 只能跳转到同级代码段，但 CALL FAR 可以通过调用门进行提权（提升 CPL 的权限）</p>\n<h1 id=\"reference\"><a class=\"anchor\" href=\"#reference\">#</a> Reference</h1>\n<p>滴水中级课件<br />\n<span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cuNTJwb2ppZS5jbi90aHJlYWQtMTQyMzg5NC0xLTEuaHRtbA==\"> https://www.52pojie.cn/thread-1423894-1-1.html</span></p>\n",
            "tags": [
                "CALL与CALL FAR"
            ]
        },
        {
            "id": "https://or0kit.github.io/Bin/Core/WindowsXp/Protect-Mode/%E4%BF%9D%E6%8A%A4%E6%A8%A1%E5%BC%8F-%E4%BB%A3%E7%A0%81%E8%B7%A8%E6%AE%B5%E8%B7%B3%E8%BD%AC/",
            "url": "https://or0kit.github.io/Bin/Core/WindowsXp/Protect-Mode/%E4%BF%9D%E6%8A%A4%E6%A8%A1%E5%BC%8F-%E4%BB%A3%E7%A0%81%E8%B7%A8%E6%AE%B5%E8%B7%B3%E8%BD%AC/",
            "title": "保护模式-代码跨段跳转",
            "date_published": "2021-08-08T05:48:15.000Z",
            "content_html": "<h1 id=\"代码跨段跳转\"><a class=\"anchor\" href=\"#代码跨段跳转\">#</a> 代码跨段跳转</h1>\n<h2 id=\"要点回顾\"><a class=\"anchor\" href=\"#要点回顾\">#</a> 要点回顾</h2>\n<p>段寄存器:<br />\n <code>ES,CS,SS,DS,FS,GS,LDTR,TR</code> <br />\n 除 CS 外，其他的段寄存器都可以通过  <code>MOV,LES,LSS,LDS,LFS,LGS</code>  指令进行修改</p>\n<p>思考：CS 为什么不可以直接修改呢？</p>\n<p><strong>CS 的改变意味着 EIP 的改变，改变 CS 的同时必须修改 EIP, 所以我们无法使用上面的指令来进行修改</strong></p>\n<h2 id=\"代码段跳转流程\"><a class=\"anchor\" href=\"#代码段跳转流程\">#</a> 代码段跳转流程</h2>\n<p>段间跳转分为两种情况：</p>\n<p>要跳转的段是一致代码段<br />\n要跳转的段是非一致代码段</p>\n<p><strong>同时修改 CS 和 EIP 的指令:</strong></p>\n<table>\n<thead>\n<tr>\n<th style=\"text-align:left\">指令</th>\n<th style=\"text-align:left\">含义</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td style=\"text-align:left\">JMP FAR</td>\n<td style=\"text-align:left\">远跳转</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">CALL FAR</td>\n<td style=\"text-align:left\">远调用</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">RETF(return far)</td>\n<td style=\"text-align:left\">远返回</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">INT(interrupt)</td>\n<td style=\"text-align:left\">中断</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">IRET(interrupt return)</td>\n<td style=\"text-align:left\">执行到中断程序或过程的远返回</td>\n</tr>\n</tbody>\n</table>\n<p><strong>只改变 EIP 的指令：</strong></p>\n<table>\n<thead>\n<tr>\n<th style=\"text-align:left\">指令</th>\n<th style=\"text-align:left\">含义</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td style=\"text-align:left\">JMP</td>\n<td style=\"text-align:left\">跳转</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">CALL</td>\n<td style=\"text-align:left\">调用</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">JCC(jump condition code)</td>\n<td style=\"text-align:left\">跳转指令状态码 / 条件跳转</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">RET</td>\n<td style=\"text-align:left\">返回</td>\n</tr>\n</tbody>\n</table>\n<h3 id=\"执行流程\"><a class=\"anchor\" href=\"#执行流程\">#</a> 执行流程</h3>\n<p>JMP FAR 指令<br />\n指令格式<br />\n <code>JMP Selector:Offset</code></p>\n<p>如： <code>JMP 0x20:0x00452610</code></p>\n<p>Selector 为段选择子<br />\n Offset 为要跳转的偏移</p>\n<p>思考：CPU 如何执行  <code>JMP 0x20:0x004183D</code>  这行指令</p>\n<ul>\n<li><strong>1）段选择子拆分</strong></li>\n</ul>\n<blockquote>\n<p>0x20 二进制：0000 0000 0010 0000 即<br />\n RPL = 00<br />\nTI = 0<br />\nIndex = 4</p>\n</blockquote>\n<ul>\n<li><strong>2）查表得到段描述符</strong></li>\n</ul>\n<p>TI=0：查 GDT 表<br />\n Index=4：找到对应的段描述符</p>\n<p>四种情况可以跳转：</p>\n<blockquote>\n<p>代码段<br />\n调用门<br />\n TSS 任务段<br />\n任务门</p>\n</blockquote>\n<ul>\n<li><strong>3）权限检查</strong></li>\n</ul>\n<p>一致代码段：要求  <code>CPL &gt;= DPL</code> <br />\n 非一致代码段：要求  <code>CPL == DPL</code>  并且  <code>RPL &lt;= DPL</code></p>\n<ul>\n<li><strong>4）加载段描述符</strong></li>\n</ul>\n<p>通过上面的权限检查后，CPU 会将段描述符加载到 CS 段寄存器中</p>\n<ul>\n<li><strong>5）代码执行</strong></li>\n</ul>\n<p>CPU 将  <code>CS.Base + Offset</code>  的值写入 EIP，然后执行 CS:EIP 处的代码</p>\n<p>段间跳转到此结束</p>\n<ul>\n<li><strong>6）总结</strong></li>\n</ul>\n<p>一致代码段（共享的段）<br />\n特权级高的程序不允许访问特权级低的数据：核心态不允许访问用户态的数据<br />\n特权级低的程序可以访问到特权级高的数据，但特权级不会改变：用户态还是用户态</p>\n<p>非一致代码段（普通代码段）<br />\n只允许同级访问<br />\n绝对禁止不同级别的访问：核心态不是用户态，用户态也不是核心态</p>\n<p><strong>注意：直接对代码段进行 JMP 或者 CALL 的操作，无论目标是一致代码段还是非一致代码段，CPL 都不会发生改变。如果要提升 CPL 的权限，只能通过调用门</strong></p>\n<h2 id=\"代码跳转实验\"><a class=\"anchor\" href=\"#代码跳转实验\">#</a> 代码跳转实验</h2>\n<p>验证 JMP FAR 指令执行的结果。自己构造一个段描述符，并使用对应的段选择子进行测试。</p>\n<h3 id=\"计算段选择子\"><a class=\"anchor\" href=\"#计算段选择子\">#</a> 计算段选择子</h3>\n<p>使用 Windbg 找到一处未被使用的段描述符：</p>\n<p><img data-src=\"image001.png\" alt=\"\" /></p>\n<p>确定了要被构造的段描述符的地址为： <code>0x8003f048</code></p>\n<p>根据 <strong>段描述符地址 = GDT 表首地址 + 索引 × 段描述符长度 = GDT 表首地址 + 索引 × 8</strong> 可以逆推出</p>\n<p><code>索引 =（ 段描述符地址 - GDT表首地址）÷ 8</code></p>\n<p>即 索引 = (0x8003f048-0x8003f000) ÷ 8 = 0x48 ÷ 8 = 72 ÷ 8 = 9</p>\n<p>既我们的段选择子的索引（Index）为 9，查询（Ti=0）GDT 表，请求特权（RPL=0b11）等级为 3。</p>\n<p>得到： <code>0000 0000 0100 1011</code>  既  <code>0x4B</code></p>\n<h3 id=\"构造段描述符\"><a class=\"anchor\" href=\"#构造段描述符\">#</a> 构造段描述符</h3>\n<table>\n<thead>\n<tr>\n<th>数据位</th>\n<th>31-24</th>\n<th>23</th>\n<th>22</th>\n<th>21</th>\n<th>20</th>\n<th>19-16</th>\n<th>15</th>\n<th>14-13</th>\n<th>12</th>\n<th>11-8</th>\n<th>7-0</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>含义</td>\n<td>Base</td>\n<td>G</td>\n<td>D/B</td>\n<td>0</td>\n<td>AVL</td>\n<td>Seg.Limit</td>\n<td>P</td>\n<td>DPL</td>\n<td>S</td>\n<td>Type</td>\n<td>Base</td>\n</tr>\n<tr>\n<td>解释</td>\n<td>基地址</td>\n<td>粒度</td>\n<td>默认操作大小</td>\n<td>固定为 0</td>\n<td>用于系统软件使用</td>\n<td>段大小限制</td>\n<td>有效位</td>\n<td>特权等级</td>\n<td>描述符类型</td>\n<td>段类型</td>\n<td>基地址</td>\n</tr>\n<tr>\n<td>数值</td>\n<td>00000000</td>\n<td>1</td>\n<td>1</td>\n<td>0</td>\n<td>0</td>\n<td>1111</td>\n<td>1</td>\n<td>00</td>\n<td>1</td>\n<td>1111</td>\n<td>0000000</td>\n</tr>\n</tbody>\n</table>\n<hr />\n<table>\n<thead>\n<tr>\n<th>数据位</th>\n<th>31-16</th>\n<th>15-0</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>含义</td>\n<td>Base Adress</td>\n<td>Segment Limit</td>\n</tr>\n<tr>\n<td>解释</td>\n<td>基地址</td>\n<td>段大小限制</td>\n</tr>\n<tr>\n<td>数值</td>\n<td>0000000000000000</td>\n<td>1111111111111111</td>\n</tr>\n</tbody>\n</table>\n<hr />\n<p>主要修改了 DPL 为 0；段类型设置为可执行可读，可从较低特权级别调用，可访问的 代码段描述符</p>\n<p>将上面的二进制拼接得到： <code>00cf9f00`0000ffff</code></p>\n<h3 id=\"写入段描述符\"><a class=\"anchor\" href=\"#写入段描述符\">#</a> 写入段描述符</h3>\n<p>将构造好的段描述符写入</p>\n<p>在 windbg 中使用指令</p>\n<p><code>eq  8003f048 00cf9f00`0000ffff</code></p>\n<p><code>eq ：edit qword</code> ，以 qword 的数据宽度编辑修改指定地址的数据</p>\n<p>指令格式为： <code>eq address data</code></p>\n<p>修改后再用 windbg 查看</p>\n<p><img data-src=\"image002.png\" alt=\"\" /></p>\n<h3 id=\"od测试指令\"><a class=\"anchor\" href=\"#od测试指令\">#</a> OD 测试指令</h3>\n<p>使用 OD 随便打开一个软件。选择一个跳转的地址。</p>\n<p><code>jmp 0x4B:0x0085F472</code></p>\n<p><img data-src=\"image003.png\" alt=\"\" /></p>\n<p>可以看到 EIP 被修改为了 Offset (偏移)，CS 被修改为了 Selector (段选择子)。EIP 和 CS 同时被修改了。</p>\n<p><img data-src=\"image004.png\" alt=\"\" /></p>\n<h3 id=\"尝试修改cpl\"><a class=\"anchor\" href=\"#尝试修改cpl\">#</a> 尝试修改 CPL</h3>\n<p>原本的 CPL 为 3，CPL 为当前特权级别，等于 CS 和 SS 的 RPL（请求特权级别）</p>\n<p>前面的其它操作不变，将段选择子的请求特权级别修改为 0</p>\n<p>即将段选择子修改为</p>\n<table>\n<thead>\n<tr>\n<th></th>\n<th>Index</th>\n<th>TI</th>\n<th>RPL</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>二进制值</td>\n<td>0000 0000 0100 1</td>\n<td>0</td>\n<td>00</td>\n</tr>\n<tr>\n<td>十进制值</td>\n<td>9</td>\n<td>0</td>\n<td>0</td>\n</tr>\n<tr>\n<td>含义</td>\n<td>索引为 9</td>\n<td>查询 GDT 表</td>\n<td>请求特权等级为 0</td>\n</tr>\n</tbody>\n</table>\n<p>得到新的段选择子为 <code>0x48</code></p>\n<p>使用 OD 执行新的指令</p>\n<p><code>jmp 0x48:0x0085F47E</code></p>\n<p><img data-src=\"image005.png\" alt=\"\" /></p>\n<p>可以看到，CS 仍然是 0x4B，CPL 仍然没有发生改变，当前特权等级依旧为 3</p>\n<p>也就是说 CPL 无法通过这种方式改变</p>\n<h1 id=\"reference\"><a class=\"anchor\" href=\"#reference\">#</a> Reference</h1>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQxOTg4NDQ4L2FydGljbGUvZGV0YWlscy8xMDI1Nzk2OTU=\">https://blog.csdn.net/qq_41988448/article/details/102579695</span><br />\n<span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cuNTJwb2ppZS5jbi90aHJlYWQtMTQyMzQ4NC0xLTEuaHRtbA==\">https://www.52pojie.cn/thread-1423484-1-1.html</span></p>\n",
            "tags": [
                "跨段跳转流程",
                "JMP FAR指令"
            ]
        },
        {
            "id": "https://or0kit.github.io/Bin/Core/WindowsXp/Protect-Mode/%E4%BF%9D%E6%8A%A4%E6%A8%A1%E5%BC%8F-%E6%AE%B5%E6%9D%83%E9%99%90%E6%A3%80%E6%B5%8B/",
            "url": "https://or0kit.github.io/Bin/Core/WindowsXp/Protect-Mode/%E4%BF%9D%E6%8A%A4%E6%A8%A1%E5%BC%8F-%E6%AE%B5%E6%9D%83%E9%99%90%E6%A3%80%E6%B5%8B/",
            "title": "保护模式--段权限检测",
            "date_published": "2021-07-29T14:22:31.000Z",
            "content_html": "<h1 id=\"段权限检测\"><a class=\"anchor\" href=\"#段权限检测\">#</a> 段权限检测</h1>\n<h2 id=\"cpu权限等级划分\"><a class=\"anchor\" href=\"#cpu权限等级划分\">#</a> CPU 权限等级划分</h2>\n<p><img data-src=\"image001.png\" alt=\"\" /></p>\n<p>CPU 一共四个等级. ring3 - ring 0 而操作系统只使用了 ring3 与 ring0 所以 ring3 就是应用程序，ring0 就是内核程序。<br />\n应用程序不可以执行特权指令，内核程序可以执行特权指令。</p>\n<h1 id=\"cpl-rpl-dpl-介绍\"><a class=\"anchor\" href=\"#cpl-rpl-dpl-介绍\">#</a> CPL RPL DPL 介绍</h1>\n<p>描述符特权级 (DPL) 域 ——(段描述符的第二个双字的 bit 13 和 bit 14) 确定该段的特权级。<br />\n请求特权级 (RPL) 域 ——(段选择符的 bit 0 和 bit 1) 确定一个段选择符的请求特权级。<br />\n当前特权级 (CPL) 域 ——(CS 段寄存器的 bit 0 和 bit 1) 指明当前运行的进程的特权级。术语当前特权级 (CPL) 就是指该域的设置。</p>\n<ul>\n<li><strong>当前特权级（CPL）</strong></li>\n</ul>\n<p>描述：</p>\n<p>段寄存器 CS 的后两位比特位称为当前特权级<br />\n注意：段选择子 SS 和 CS 的后两位比特位相同</p>\n<p><em>如：</em></p>\n<pre><code>→ CS = 0x001B\n→ 0x001B = 二进制:0000 0000 0001 1011\n→ 二进制:11 = 十进制:3\n→ 因此：当前进程处于3环\n</code></pre>\n<ul>\n<li><strong>请求特权级（RPL）</strong></li>\n</ul>\n<p>描述：</p>\n<p>RPL 是段选择子结构中的一部分<br />\n RPL 是针对段选择子而言的，每个段的选择子都有自己的 RPL<br />\nRPL 表示用什么权限去访问一个段</p>\n<p><em>例：</em></p>\n<pre><code>MOV AX,0008\nMOV DS,AX\n与\nMOV AX,000B\nMOV DS,AX\n指向的是同一个段描述符，但RPL不同\n</code></pre>\n<ul>\n<li><strong>3）数据段的权限检查</strong></li>\n</ul>\n<p>检查：CPL&lt;= DPL 并且 RPL&lt;= DPL（数值上的比较）</p>\n<p><em>例：</em></p>\n<pre><code>当CPL = 0时执行以下指令：\n  MOV AX,000B\t\t\t// RPL=3，请求权限为3\n  MOV DS,AX\t\t\t// 假设ax指向的段描述符的DPL=0\n上述指令虽然满足了CPL&lt;=DPL，但RPL&gt;DPL，因此执行失败\n</code></pre>\n<p>注意：代码段和系统端描述符的检查方式不一样</p>\n<p><strong>既然已经有 CPL（当前特权级别）了，为什么还要有 RPL（请求特权级别）呢？<br />\n原因：我们本可以用 “读写” 的权限去打开一个文件，但为了避免出错，有些时候我们使用 “只读” 的权限去打开</strong></p>\n<h1 id=\"reference\"><a class=\"anchor\" href=\"#reference\">#</a> Reference</h1>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQxOTg4NDQ4L2FydGljbGUvZGV0YWlscy8xMDI1NjMzMjU=\">https://blog.csdn.net/qq_41988448/article/details/102563325</span></p>\n",
            "tags": [
                "CRL",
                "DPL",
                "RPL"
            ]
        },
        {
            "id": "https://or0kit.github.io/Bin/Core/WindowsXp/Protect-Mode/%E4%BF%9D%E6%8A%A4%E6%A8%A1%E5%BC%8F-%E6%AE%B5%E5%AF%84%E5%AD%98%E5%99%A8%E7%BB%93%E6%9E%84%E3%80%81%E6%AE%B5%E6%8F%8F%E8%BF%B0%E7%AC%A6%E3%80%81%E6%AE%B5%E9%80%89%E6%8B%A9%E5%AD%90/",
            "url": "https://or0kit.github.io/Bin/Core/WindowsXp/Protect-Mode/%E4%BF%9D%E6%8A%A4%E6%A8%A1%E5%BC%8F-%E6%AE%B5%E5%AF%84%E5%AD%98%E5%99%A8%E7%BB%93%E6%9E%84%E3%80%81%E6%AE%B5%E6%8F%8F%E8%BF%B0%E7%AC%A6%E3%80%81%E6%AE%B5%E9%80%89%E6%8B%A9%E5%AD%90/",
            "title": "保护模式--段寄存器结构、段描述符、段选择子",
            "date_published": "2021-07-29T13:25:00.000Z",
            "content_html": "<h1 id=\"段寄存器\"><a class=\"anchor\" href=\"#段寄存器\">#</a> 段寄存器</h1>\n<p>什么是段寄存器，有哪些段寄存器</p>\n<p>当我们用汇编读写某一个地址时： <code>mov dword ptr ds:[0x123456],eax</code> <br />\n 我们真正读写的地址是： <code>ds.base + 0x123456</code> <br />\n <code>ES</code>   <code>CS</code>   <code>SS</code>   <code>DS</code>   <code>FS</code>   <code>GS</code>   <code>LDTR</code>   <code>TR</code>  共 8 个</p>\n<p>代码段寄存器 CS（Code Segment）<br />\n存放当前正在运行的程序代码所在段的段基址，表示当前使用的指令代码可以从该段寄存器指定的存储器段中取得，相应的偏移量则由 IP 提供。</p>\n<p>数据段寄存器 DS（Data Segment）<br />\n指出当前程序使用的数据所存放段的最低地址，即存放数据段的段基址。</p>\n<p>堆栈段寄存器 SS（Stack Segment）<br />\n指出当前堆栈的底部地址，即存放堆栈段的段基址。</p>\n<p>附加段寄存器 ES（Extra Segment）<br />\n指出当前程序使用附加数据段的段基址，该段是串操作指令中目的串所在的段。</p>\n<p>FS、GS 是从 80386 开始增加的，没有全称。</p>\n<p>FS,GS 是 80386 起增加的两个辅助段寄存器，在这之前只有一个辅助段寄存器 ES, 增加这两个寄存器是为了减轻 ES 寄存器的负担，并能更好地配合适用于通用寄存器组的基址和变址寄存器。</p>\n<p>寄存器 FS 和 GS 是段寄存器。它们没有处理器定义的目的，而是由操作系统运行它们来赋予目的。<br />\n附加段寄存器，F 为上一个附加段寄存器字母 E 后的字母，没有对应的名称</p>\n<ul>\n<li><strong>FS</strong></li>\n</ul>\n<p>指向一种被称为线程信息块（TEB）的结构，这种结构是由内核在创建线程时创建的，用于支持操作系统相关功能、服务和 API</p>\n<ul>\n<li><strong>GS</strong></li>\n</ul>\n<p>附加段寄存器，G 为上一个附加段寄存器字母 F 后的字母，没有对应的名称</p>\n<p>在 32 位 Windows 上 GS 保留供将来使用</p>\n<p>在 x64 模式下，FS 和 GS 段寄存器已交换</p>\n<p>Win64 使用 GS 的原因是该 FS 寄存器用于 32 位兼容性层（称为 Wow64）</p>\n<p>32 位应用程序永远不会导致 GS 更改，而 64 位应用程序永远不会导致 FS 更改</p>\n<p>注意，在 Win64 和 Wow64 中 GS 是非零的，这可以用来检测一个 32 位应用程序是否在 64 位 Windows 中运行，在一个 “真正 “的 32 位 Windows 中 GS 总是零</p>\n<h2 id=\"段寄存器结构\"><a class=\"anchor\" href=\"#段寄存器结构\">#</a> 段寄存器结构</h2>\n<p><img data-src=\"image001.png\" alt=\"\" /></p>\n<p>段寄存器中有 16 位是可见部分，有 80 位是不可见部分，一共 96 位。<br />\n可见部分为 16 位的 Selector 部分<br />\n 16 位的 Attribute 为这个段寄存器的属性，它的意义为：表示该段寄存器是可读还是可写还是可执行的。<br />\n32 位的 Base 表示该段是从哪里开始的。<br />\n32 位的 Limit 表示整个段的长度有多少。</p>\n<h2 id=\"段寄存器的读写\"><a class=\"anchor\" href=\"#段寄存器的读写\">#</a> 段寄存器的读写</h2>\n<p>读段寄存器的时候只能够读 16 位。<br />\n比如： <code>mov ax,es</code>  只能读 16 位的可见部分</p>\n<p>读写 LDTR 的指令为： <code>SLDT/LLDT</code></p>\n<p>读写 TR 的指令为： <code>STR/LTR</code></p>\n<p>写段寄存器的时候写的是 96 位。<br />\n比如： <code>mov ds,ax</code>  写时是写 96 位</p>\n<h2 id=\"加载段描述符至段寄存器\"><a class=\"anchor\" href=\"#加载段描述符至段寄存器\">#</a> 加载段描述符至段寄存器</h2>\n<p>除了 MOV 指令，还可以使用 LES、LSS、LDS、LFS、LGS 指令修改段寄存器</p>\n<p>例如：</p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">char</span> buffer<span class=\"token punctuation\">[</span><span class=\"token number\">6</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>__asm<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  les ecx<span class=\"token punctuation\">,</span>fword ptr ds<span class=\"token operator\">:</span><span class=\"token punctuation\">[</span>buffer<span class=\"token punctuation\">]</span>  <span class=\"token comment\">// 高 2 个字节给 es, 低四个字节给 ecx</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h2 id=\"段寄存器属性简介\"><a class=\"anchor\" href=\"#段寄存器属性简介\">#</a> 段寄存器属性简介</h2>\n<p>段寄存器 | Selector | Attribute    | Base       | Limit</p>\n<p>GS 寄存器 Windows 并没有使用。</p>\n<h2 id=\"gdt全局描述符表-ldt局部描述符表\"><a class=\"anchor\" href=\"#gdt全局描述符表-ldt局部描述符表\">#</a> GDT (全局描述符表) LDT (局部描述符表)</h2>\n<p><strong>LDT 表在 Windows 中并没有使用。</strong><br />\n当我们执行类似  <code>mov ds,ax</code>  指令时，CPU 会查表，根据  <code>ax</code>  的值来决定查找  <code>GDT</code>  还是  <code>LDT</code> , 查找表的什么位置，查出多少数据。<br />\n <code>gdtr</code>  寄存器中存储了  <code>GDT</code>  表的起始地址和  <code>gdt</code>  表中的长度<br />\n gdtr 是 48 位的寄存器，其中 32 位存储的这张表的位置，16 位存储的这张表的大小。</p>\n<p><strong>在 windbg 中查看</strong></p>\n<pre><code>r gdtr //gdt表的存储位置\nr gdtl //gdt表的大小\n</code></pre>\n<p><img data-src=\"image002.png\" alt=\"\" /></p>\n<p>每次从  <code>GDT</code>  表中查表：每 8 个字节为一个<strong>段描述符</strong>。</p>\n<h1 id=\"段选择子\"><a class=\"anchor\" href=\"#段选择子\">#</a> 段选择子</h1>\n<p>段选择子是一个 16 位的段描述符，该描述符指向了定义该段的段描述符.</p>\n<h2 id=\"段选择子和段寄存器的对应关系\"><a class=\"anchor\" href=\"#段选择子和段寄存器的对应关系\">#</a> 段选择子和段寄存器的对应关系</h2>\n<p>对应可见部分的 16 位既段寄存器中的 Selector。</p>\n<h2 id=\"段选择子的结构\"><a class=\"anchor\" href=\"#段选择子的结构\">#</a> 段选择子的结构</h2>\n<p><img data-src=\"image009.png\" alt=\"\" /></p>\n<p>RPL：请求特权级别<br />\n TI：TI=0 查 GDT 表；TI=1 查 LDT 表<br />\n Index：处理器将索引值乘以 8 在加上 GDT 或者 LDT 的基地址，就是要加载的段描述符</p>\n<h1 id=\"段描述符\"><a class=\"anchor\" href=\"#段描述符\">#</a> 段描述符</h1>\n<h2 id=\"段描述符的结构\"><a class=\"anchor\" href=\"#段描述符的结构\">#</a> 段描述符的结构</h2>\n<p><img data-src=\"image003.png\" alt=\"\" /></p>\n<ol>\n<li>\n<p>16 位的 Attribute 对应段寄存器中高四字节从 8 位开始到第 23 位结束。</p>\n</li>\n<li>\n<p>32 位的 Base 包含了三个部分：</p>\n<ul>\n<li>高四字节的第 24 位到第 31 部分</li>\n<li>高四字节的第 0 位到第 7 位</li>\n<li>低四字节的第 16 位到 31 位</li>\n</ul>\n</li>\n<li>\n<p>32 位的 Limit 包括两部分一共二十位（最大值为 FFFFF）：</p>\n<ul>\n<li>高四字节的 16 位到 19 位</li>\n<li>低四个字节的 0 位到 15 位</li>\n</ul>\n</li>\n</ol>\n<h2 id=\"段描述符的属性\"><a class=\"anchor\" href=\"#段描述符的属性\">#</a> 段描述符的属性</h2>\n<p>段寄存器的值是通过段描述符填写的，但段描述符只有 64 位，可是要填写的有 80 位，如何从 64 位变成 80 位呢？</p>\n<h3 id=\"p位\"><a class=\"anchor\" href=\"#p位\">#</a> P 位</h3>\n<p>P 位 位于段描述符的高四个字节的第 15 位（下标为 15）的位置.</p>\n<p>P = 1 段描述符有效<br />\n P = 0 段描述符无效</p>\n<p>当使用指令将段描述符加载至段寄存器的时候，CPU 第一个检测的就是 P 位，当 P 位为 0 时就不做继续的检测了。</p>\n<p><img data-src=\"image004.png\" alt=\"\" /></p>\n<p>在段描述符中，只要看这一行的数是否小于 8，若小于 8，则证明 P 位 = 0 段描述符无效。</p>\n<h3 id=\"g位\"><a class=\"anchor\" href=\"#g位\">#</a> G 位</h3>\n<p>G 位 位于段描述符的高四个字节的第 23 位（下标为 23）的位置。</p>\n<p>G=0 的时候：表示 Limit 字段单位（粒度）是字节：最大值就是 limit 域。<br />\nG=1 的时候：表示 Limit 字段单位（粒度）是 4KB：最大值就是 limit 域 * 0x4K + 0xFFF。</p>\n<p><img data-src=\"image005.png\" alt=\"\" /></p>\n<p>在段描述符中，只要看这一行的数是否小于 8，若小于 8，则证明 G 位 = 0。</p>\n<h3 id=\"s位\"><a class=\"anchor\" href=\"#s位\">#</a> S 位</h3>\n<p>S 位 位于段描述符的高四个字节的第 12 位（下标为 12）的位置。</p>\n<p>S = 1 时表示： 代码段或者数据段描述符<br />\n S = 0 时表示： 系统段描述符</p>\n<ul>\n<li><strong>十六进制下，从右到左看高字节的第五位，若是偶数则 S 位 = 0，若是奇数则 S 位 = 1。</strong></li>\n</ul>\n<h3 id=\"type域\"><a class=\"anchor\" href=\"#type域\">#</a> type 域</h3>\n<p>type 域 包含段描述符的高四个字节的 8、9、10、11 共四位。</p>\n<p><img data-src=\"image006.png\" alt=\"\" /></p>\n<h4 id=\"数据段\"><a class=\"anchor\" href=\"#数据段\">#</a> 数据段</h4>\n<p>当 s 位为 1 且当 type 域中的 11 位为 0 时，表示是数据段。<br />\n其中图中的 A、W、E 分别代表不同的意思</p>\n<p><img data-src=\"image007.png\" alt=\"\" /></p>\n<p>E 位表示拓展位，为 0 表示向上拓展，为 1 表示向下拓展。<br />\n向上拓展：有效范围为 <code>fs.Base ~ fs.Base+Limit</code> <br />\n 向下拓展：有效范围除了 <code>fs.Base ~ fs.Base+Limit</code></p>\n<h4 id=\"代码段\"><a class=\"anchor\" href=\"#代码段\">#</a> 代码段</h4>\n<p>当 s 位为 1 且当 type 域中的 11 位为 1 时，表示是代码段。<br />\n其中图中的 A、R、C 分别代表不同的意思</p>\n<p>A 代表是否访问过，未访问过为 0，访问过为 1。<br />\nR 代表是否可读位，表示该段是否可以读。<br />\nC 代表一致位：C = 1 表示一致代码段 ，C = 0 表示非一致代码段</p>\n<h4 id=\"系统描述符\"><a class=\"anchor\" href=\"#系统描述符\">#</a> 系统描述符</h4>\n<p>当 s 位为 0 的时候，表示该段描述符为系统描述符。系统描述符有分为以下类型：</p>\n<p><img data-src=\"image008.png\" alt=\"\" /></p>\n<h3 id=\"dpl\"><a class=\"anchor\" href=\"#dpl\">#</a> DPL</h3>\n<ul>\n<li><strong>描述：</strong></li>\n</ul>\n<p>DPL 存储在段描述符中，规定了访问所在段描述符所需要的特权级别是多少<br />\n DPL 数值越大，访问所在段描述符所需要的权限越低<br />\n注意：在 Windows 中，DPL 只会出现两种情况，要么全为 0，要么全为 1</p>\n<p><strong>十六进制下，从右到左看高字节的第五位，若是 <code>8</code>  或 <code>9</code>  则 DPL=0，若是 <code>E</code>  或 <code>F</code>  则 DPL=3。</strong></p>\n<ul>\n<li><strong>例：</strong></li>\n</ul>\n<p>若 AX 指向的段描述符的 DPL=0，但当前程序的 CPL=3，那么这条指令是不会成功的！</p>\n<h3 id=\"db位\"><a class=\"anchor\" href=\"#db位\">#</a> D\\B 位</h3>\n<p><strong>情况 1：对 CS 段的影响</strong></p>\n<p>D=1：采用 32 位寻址方式<br />\n D=0：采用 16 位寻址方式</p>\n<p><strong>情况 2：对 SS 段的影响</strong></p>\n<p>D=1：隐式堆栈访问指令（如：PUSH POP CALL）使用 32 位堆栈指针寄存器 ESP<br />\nD=0：隐式堆栈访问指令（如：PUSH POP CALL）使用 16 位堆栈指针寄存器 SP</p>\n<p><strong>情况 3：向下拓展的数据段</strong></p>\n<p>D=1：段上限为 4GB<br />\nD=0：段上限为 64KB</p>\n<p><img data-src=\"image010.png\" alt=\"\" /></p>\n<h2 id=\"reference\"><a class=\"anchor\" href=\"#reference\">#</a> Reference</h2>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM2OTE2MTc5L2FydGljbGUvZGV0YWlscy85MTU1MDYzMQ==\">https://blog.csdn.net/qq_36916179/article/details/91550631</span><br />\n<span class=\"exturl\" data-url=\"aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM2OTE2MTc5L2FydGljbGUvZGV0YWlscy85MTYyMTk0Nw==\">https://blog.csdn.net/qq_36916179/article/details/91621947</span><br />\n<span class=\"exturl\" data-url=\"aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQxOTg4NDQ4L2FydGljbGUvZGV0YWlscy8xMDI1NjMzMjU=\">https://blog.csdn.net/qq_41988448/article/details/102563325</span></p>\n",
            "tags": [
                "段寄存器结构",
                "段描述符",
                "段选择子",
                "GDT表"
            ]
        }
    ]
}