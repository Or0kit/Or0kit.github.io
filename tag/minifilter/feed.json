{
    "version": "https://jsonfeed.org/version/1",
    "title": "Or0kit • All posts by \"minifilter\" tag",
    "description": "临渊羡鱼，不如退而结网",
    "home_page_url": "https://Or0kit.github.io",
    "items": [
        {
            "id": "https://or0kit.github.io/Bin/Core/Drive-Development/%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E5%BE%AE%E8%BF%87%E6%BB%A4%E9%A9%B1%E5%8A%A8/",
            "url": "https://or0kit.github.io/Bin/Core/Drive-Development/%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E5%BE%AE%E8%BF%87%E6%BB%A4%E9%A9%B1%E5%8A%A8/",
            "title": "文件系统微过滤驱动",
            "date_published": "2022-08-06T15:24:13.000Z",
            "content_html": "<h1 id=\"文件系统微过滤驱动\"><a class=\"anchor\" href=\"#文件系统微过滤驱动\">#</a> 文件系统微过滤驱动</h1>\n<p>微软的 Windows 内核开发者开发了一个新的驱动， 称为过滤管理器（Filter Manager 或 fltmgr）</p>\n<h1 id=\"minifilter的编程框架\"><a class=\"anchor\" href=\"#minifilter的编程框架\">#</a> Minifilter 的编程框架</h1>\n<p>接下来介绍一个有关 Minifilter 应用的例子， 这个例子的作用主要是开发 Minifilter 的功能来限制对应用程序 “记事本” 文件（notepad.xe） 的操作， 进而达到限制扩展名为 txt 等使用记事本程序来编辑的功能。这是一个有意思的例子， 因为文件名为 notepad.exe 的文件被禁止打开， 所以这个文件无法被双击执行、 无法被复制、 无法被改名， 也无法被删除。这个例子在实际中可能没有什么用处。 这样不可能限制文本文档不被编辑， 因为记事本不能使用， 用户依然可以使用其他的文本编辑工具， 甚至可以在别的计算机上为 notepad.exe 改一个名字， 然后拷贝到本机上来使用。 但是它足以说明 Minifilter 的简单使用效果。 在实际应用中， Minifilter 的应用和 sfilter 的应用是一样广泛的。 有兴趣的读者在读完这个简单的例子之后， 可以在它的基础上编写一些更符合自己实际需求的例子。</p>\n<h2 id=\"微文件系统过滤的注册\"><a class=\"anchor\" href=\"#微文件系统过滤的注册\">#</a> 微文件系统过滤的注册</h2>\n<p>编写 Minifilter 的第一件事是向过滤管理器宣告我们的微过滤器的存在。<br />\n这里所谓的微过滤器是符合过滤管理器标准的过滤组件， 它其实是一组回调函数， 这组回调函数向过滤管理器注册之后， 过滤管理器就会在合适的时机（比如， 要求的文件操作发生时） 以合适的方式调用某个回调函数。如果我们编写这个回调函数中的内容， 就可以对文件系统加以过滤了。</p>\n<p>这比花很多精力去绑定各种设备要简单得多， 因为复杂的任务都在过滤管理器里做了。</p>\n<p>下面直接通过程序代码来了解一下程序的架构。<br />\n一开始我们必须要宣告注册的函数，这个宣告要符合 Minifilter 开发文件内的定义， 我们可以从 WDK 或文件内找到这个函数的意思。</p>\n<p>接下来按照惯例， 我们介绍一下  <code>DriverEntry</code>  入口函数。 和  <code>sfilter</code>  形成鲜明的对比， 这个例子的  <code>DriverEntry</code>  显得非常简单。 关键的函数有两个： 一个是  <code>FltReigsterFilter</code>  ， 用来注册一个微过滤器； 另一个是  <code>FltStartFiltering</code>  ， 用来开启过滤。</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>NTSTATUS</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token function\">DriverEntry</span> <span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    _In_ PDRIVER_OBJECT DriverObject<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    _In_ PUNICODE_STRING RegistryPath</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    NTSTATUS status<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token function\">UNREFERENCED_PARAMETER</span><span class=\"token punctuation\">(</span> RegistryPath <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    <span class=\"token comment\">// 向过滤管理器注册一个过滤器。这个过滤器使用 FilterRegistration 表示的</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    status <span class=\"token operator\">=</span> <span class=\"token function\">FltRegisterFilter</span><span class=\"token punctuation\">(</span> DriverObject<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>                                <span class=\"token operator\">&amp;</span>FilterRegistration<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>                                <span class=\"token operator\">&amp;</span>gFilterHandle <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    <span class=\"token function\">ASSERT</span><span class=\"token punctuation\">(</span> <span class=\"token function\">NT_SUCCESS</span><span class=\"token punctuation\">(</span> status <span class=\"token punctuation\">)</span> <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>   <span class=\"token comment\">// VS2019 中用的是 FLT_ASSERT</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">NT_SUCCESS</span><span class=\"token punctuation\">(</span> status <span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>        <span class=\"token comment\">// 开启过滤行为</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>        status <span class=\"token operator\">=</span> <span class=\"token function\">FltStartFiltering</span><span class=\"token punctuation\">(</span> gFilterHandle <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token function\">NT_SUCCESS</span><span class=\"token punctuation\">(</span> status <span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>            <span class=\"token comment\">// 如果不能正常开启，那么这个注册没有意义，取消注册并以失败退出</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>            <span class=\"token function\">FltUnregisterFilter</span><span class=\"token punctuation\">(</span> gFilterHandle <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>    <span class=\"token keyword\">return</span> status<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h3 id=\"fltregisterfilter-fltstartfiltering和fltregisterfilter\"><a class=\"anchor\" href=\"#fltregisterfilter-fltstartfiltering和fltregisterfilter\">#</a> FltRegisterFilter、FltStartFiltering 和 FltRegisterFilter</h3>\n<p>其中，  <code>FltRegisterFilter</code>  是一个非常重要的内核 API， 是微过滤器生命的开始。 这个函数的原型如下：</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">NTAPI</span> <span class=\"token expression\">__stdcall</span></span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">FLTAPI</span> <span class=\"token expression\">NTAPI</span></span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>NTSTATUS</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>FLTAPI</pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token function\">FltRegisterFilter</span> <span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    _In_ PDRIVER_OBJECT Driver<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    _In_ CONST FLT_REGISTRATION <span class=\"token operator\">*</span>Registration<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    _Outptr_ PFLT_FILTER <span class=\"token operator\">*</span>RetFilter</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>第 1 个参数是本驱动的驱动对象， 是在入口函数  <code>DriverEntry</code>  中作为参数传入的。<br />\n第 2 个参数就是一个宣告注册信息的结构， 这个结构内含描述这个过滤器的所有信息， 在本节中， 称为微过滤器注册结构。<br />\n第 3 个参数（RetFilter） 是一个返回参数， 返回注册成功的微过滤器句柄。 微过滤器句柄非常常用， 一般都保存在全局变量中以备后用， 在下面调用函数  <code>FltStartFiltering</code>  时就需要以这个句柄作为参数。</p>\n<p>显而易见， 调用  <code>FltRegisterFilter</code>  本身并不复杂， 问题在于要填写一个合法的  <code>FLT_REGISTRATION</code>  结构。 这个结构将在下面介绍。</p>\n<p>另一个函数是  <code>FltStartFiltering</code>  ， 在调用这个函数之前， 过滤是不起作用的。 这个函数的作用是开启。 它的原型如下：</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>NTSTATUS</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>FLTAPI</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token function\">FltStartFiltering</span> <span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    _In_ PFLT_FILTER Filter</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>此函数非常简单， 只有一个参数， 就是调用  <code>FltRegisterFilter</code>  时返回的微过滤器句柄。<br />\n一般情况下， 这个函数的调用会成功； 如果失败， 除了放弃过滤， 几乎别无选择。</p>\n<h2 id=\"微过滤器的数据结构\"><a class=\"anchor\" href=\"#微过滤器的数据结构\">#</a> 微过滤器的数据结构</h2>\n<p>注册微过滤器时， 我们填写了一个名为微过滤器注册结构（ <code>FLT_REGISTRATION</code> ）的数据结构。<br />\n定义如下：</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">typedef</span> <span class=\"token keyword\">struct</span> <span class=\"token class-name\">_FLT_REGISTRATION</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token comment\">// 结构的大小和结构的版本</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    USHORT Size<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    USHORT Version<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token comment\">// 微过滤器的标志位</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    FLT_REGISTRATION_FLAGS Flags<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    <span class=\"token comment\">//  Variable length array of routines that are used to manage contexts in the system.</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    <span class=\"token comment\">//  </span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    <span class=\"token comment\">// </span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    CONST FLT_CONTEXT_REGISTRATION <span class=\"token operator\">*</span>ContextRegistration<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>    <span class=\"token comment\">//  Variable length array of routines used for processing pre- and post-</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    <span class=\"token comment\">//  file system operations.</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>    <span class=\"token comment\">// 操作回调函数。这是重点中的重点。</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>    CONST FLT_OPERATION_REGISTRATION <span class=\"token operator\">*</span>OperationRegistration<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>    <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>    <span class=\"token comment\">//  This is called before a filter is unloaded.  If an ERROR or WARNING</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>    <span class=\"token comment\">//  status is returned then the filter is NOT unloaded.  A mandatory unload</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>    <span class=\"token comment\">//  can not be failed.</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>    <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>    <span class=\"token comment\">//  If a NULL is specified for this routine, then the filter can never be</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>    <span class=\"token comment\">//  unloaded.</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>    <span class=\"token comment\">// 卸载回调函数</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>    PFLT_FILTER_UNLOAD_CALLBACK FilterUnloadCallback<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>    <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>    <span class=\"token comment\">//  This is called to see if a filter would like to attach an instance</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>    <span class=\"token comment\">//  to the given volume.  If an ERROR or WARNING status is returned, an</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>    <span class=\"token comment\">//  attachment is not made.</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>    <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>    <span class=\"token comment\">//  If a NULL is specified for this routine, the attachment is always made.</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>    <span class=\"token comment\">// 实例安装回调</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>    PFLT_INSTANCE_SETUP_CALLBACK InstanceSetupCallback<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>    <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>    <span class=\"token comment\">//  This is called to see if the filter wants to detach from the given</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>    <span class=\"token comment\">//  volume.  This is only called for manual detach requests.  If an</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>    <span class=\"token comment\">//  ERROR or WARNING status is returned, the filter is not detached.</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>    <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>    <span class=\"token comment\">//  If a NULL is specified for this routine, then instances can never be</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>    <span class=\"token comment\">//  manually detached.</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre>    <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre></pre></td></tr><tr><td data-num=\"54\"></td><td><pre>    PFLT_INSTANCE_QUERY_TEARDOWN_CALLBACK InstanceQueryTeardownCallback<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>    <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre>    <span class=\"token comment\">//  This is called at the start of a filter detaching from a volume.</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre>    <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"59\"></td><td><pre>    <span class=\"token comment\">//  It is OK for this field to be NULL.</span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre>    <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"61\"></td><td><pre></pre></td></tr><tr><td data-num=\"62\"></td><td><pre>    PFLT_INSTANCE_TEARDOWN_CALLBACK InstanceTeardownStartCallback<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"63\"></td><td><pre></pre></td></tr><tr><td data-num=\"64\"></td><td><pre>    <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"65\"></td><td><pre>    <span class=\"token comment\">//  This is called at the end of a filter detaching from a volume.  All</span></pre></td></tr><tr><td data-num=\"66\"></td><td><pre>    <span class=\"token comment\">//  outstanding operations have been completed by the time this routine</span></pre></td></tr><tr><td data-num=\"67\"></td><td><pre>    <span class=\"token comment\">//  is called.</span></pre></td></tr><tr><td data-num=\"68\"></td><td><pre>    <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"69\"></td><td><pre>    <span class=\"token comment\">//  It is OK for this field to be NULL.</span></pre></td></tr><tr><td data-num=\"70\"></td><td><pre>    <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"71\"></td><td><pre></pre></td></tr><tr><td data-num=\"72\"></td><td><pre>    PFLT_INSTANCE_TEARDOWN_CALLBACK InstanceTeardownCompleteCallback<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"73\"></td><td><pre></pre></td></tr><tr><td data-num=\"74\"></td><td><pre>    <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"75\"></td><td><pre>    <span class=\"token comment\">//  The following callbacks are provided by a filter only if it is</span></pre></td></tr><tr><td data-num=\"76\"></td><td><pre>    <span class=\"token comment\">//  interested in modifying the name space.</span></pre></td></tr><tr><td data-num=\"77\"></td><td><pre>    <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"78\"></td><td><pre>    <span class=\"token comment\">//  If NULL is specified for these callbacks, it is assumed that the</span></pre></td></tr><tr><td data-num=\"79\"></td><td><pre>    <span class=\"token comment\">//  filter would not affect the name being requested.</span></pre></td></tr><tr><td data-num=\"80\"></td><td><pre>    <span class=\"token comment\">//  生成文件名回调</span></pre></td></tr><tr><td data-num=\"81\"></td><td><pre></pre></td></tr><tr><td data-num=\"82\"></td><td><pre>    PFLT_GENERATE_FILE_NAME GenerateFileNameCallback<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"83\"></td><td><pre>    <span class=\"token comment\">// 格式化名字组件</span></pre></td></tr><tr><td data-num=\"84\"></td><td><pre>    PFLT_NORMALIZE_NAME_COMPONENT NormalizeNameComponentCallback<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"85\"></td><td><pre>    <span class=\"token comment\">// 格式化上下文清理回调</span></pre></td></tr><tr><td data-num=\"86\"></td><td><pre>    PFLT_NORMALIZE_CONTEXT_CLEANUP NormalizeContextCleanupCallback<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"87\"></td><td><pre></pre></td></tr><tr><td data-num=\"88\"></td><td><pre>    <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"89\"></td><td><pre>    <span class=\"token comment\">//  The PFLT_NORMALIZE_NAME_COMPONENT_EX callback is also a name</span></pre></td></tr><tr><td data-num=\"90\"></td><td><pre>    <span class=\"token comment\">//  provider callback. It is not included here along with the</span></pre></td></tr><tr><td data-num=\"91\"></td><td><pre>    <span class=\"token comment\">//  other name provider callbacks to take care of the registration</span></pre></td></tr><tr><td data-num=\"92\"></td><td><pre>    <span class=\"token comment\">//  structure versioning issues.</span></pre></td></tr><tr><td data-num=\"93\"></td><td><pre>    <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"94\"></td><td><pre></pre></td></tr><tr><td data-num=\"95\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">if</span> <span class=\"token expression\">FLT_MGR_LONGHORN</span></span></pre></td></tr><tr><td data-num=\"96\"></td><td><pre></pre></td></tr><tr><td data-num=\"97\"></td><td><pre>    <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"98\"></td><td><pre>    <span class=\"token comment\">//  This is called for transaction notifications received from the KTM</span></pre></td></tr><tr><td data-num=\"99\"></td><td><pre>    <span class=\"token comment\">//  when a filter has enlisted on that transaction.</span></pre></td></tr><tr><td data-num=\"100\"></td><td><pre>    <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"101\"></td><td><pre></pre></td></tr><tr><td data-num=\"102\"></td><td><pre>    PFLT_TRANSACTION_NOTIFICATION_CALLBACK TransactionNotificationCallback<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"103\"></td><td><pre></pre></td></tr><tr><td data-num=\"104\"></td><td><pre>    <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"105\"></td><td><pre>    <span class=\"token comment\">//  This is the extended normalize name component callback</span></pre></td></tr><tr><td data-num=\"106\"></td><td><pre>    <span class=\"token comment\">//  If a mini-filter provides this callback, then  this callback</span></pre></td></tr><tr><td data-num=\"107\"></td><td><pre>    <span class=\"token comment\">//  will be used as opposed to using PFLT_NORMALIZE_NAME_COMPONENT</span></pre></td></tr><tr><td data-num=\"108\"></td><td><pre>    <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"109\"></td><td><pre>    <span class=\"token comment\">//  The PFLT_NORMALIZE_NAME_COMPONENT_EX provides an extra parameter</span></pre></td></tr><tr><td data-num=\"110\"></td><td><pre>    <span class=\"token comment\">//  (PFILE_OBJECT) in addition to the parameters provided to</span></pre></td></tr><tr><td data-num=\"111\"></td><td><pre>    <span class=\"token comment\">//  PFLT_NORMALIZE_NAME_COMPONENT. A mini-filter may use this parameter</span></pre></td></tr><tr><td data-num=\"112\"></td><td><pre>    <span class=\"token comment\">//  to get to additional information like the TXN_PARAMETER_BLOCK.</span></pre></td></tr><tr><td data-num=\"113\"></td><td><pre>    <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"114\"></td><td><pre>    <span class=\"token comment\">//  A mini-filter that has no use for the additional parameter may</span></pre></td></tr><tr><td data-num=\"115\"></td><td><pre>    <span class=\"token comment\">//  only provide a PFLT_NORMALIZE_NAME_COMPONENT callback.</span></pre></td></tr><tr><td data-num=\"116\"></td><td><pre>    <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"117\"></td><td><pre>    <span class=\"token comment\">//  A mini-filter may provide both a PFLT_NORMALIZE_NAME_COMPONENT</span></pre></td></tr><tr><td data-num=\"118\"></td><td><pre>    <span class=\"token comment\">//  callback and a PFLT_NORMALIZE_NAME_COMPONENT_EX callback. The</span></pre></td></tr><tr><td data-num=\"119\"></td><td><pre>    <span class=\"token comment\">//  PFLT_NORMALIZE_NAME_COMPONENT_EX callback will be used by fltmgr</span></pre></td></tr><tr><td data-num=\"120\"></td><td><pre>    <span class=\"token comment\">//  versions that understand this callback (Vista RTM and beyond)</span></pre></td></tr><tr><td data-num=\"121\"></td><td><pre>    <span class=\"token comment\">//  and PFLT_NORMALIZE_NAME_COMPONENT callback will be used by fltmgr</span></pre></td></tr><tr><td data-num=\"122\"></td><td><pre>    <span class=\"token comment\">//  versions that do not understand the PFLT_NORMALIZE_NAME_COMPONENT_EX</span></pre></td></tr><tr><td data-num=\"123\"></td><td><pre>    <span class=\"token comment\">//  callback (prior to Vista RTM). This allows the same mini-filter</span></pre></td></tr><tr><td data-num=\"124\"></td><td><pre>    <span class=\"token comment\">//  binary to run with all versions of fltmgr.</span></pre></td></tr><tr><td data-num=\"125\"></td><td><pre>    <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"126\"></td><td><pre></pre></td></tr><tr><td data-num=\"127\"></td><td><pre>    PFLT_NORMALIZE_NAME_COMPONENT_EX NormalizeNameComponentExCallback<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"128\"></td><td><pre></pre></td></tr><tr><td data-num=\"129\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">endif</span> <span class=\"token comment\">// FLT_MGR_LONGHORN</span></span></pre></td></tr><tr><td data-num=\"130\"></td><td><pre></pre></td></tr><tr><td data-num=\"131\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">if</span> <span class=\"token expression\">FLT_MGR_WIN8</span></span></pre></td></tr><tr><td data-num=\"132\"></td><td><pre></pre></td></tr><tr><td data-num=\"133\"></td><td><pre>    <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"134\"></td><td><pre>    <span class=\"token comment\">//  This is called for IO failures due to the existence of sections</span></pre></td></tr><tr><td data-num=\"135\"></td><td><pre>    <span class=\"token comment\">//  when those sections are created through FltCreateSectionForDatascan.</span></pre></td></tr><tr><td data-num=\"136\"></td><td><pre>    <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"137\"></td><td><pre></pre></td></tr><tr><td data-num=\"138\"></td><td><pre>    PFLT_SECTION_CONFLICT_NOTIFICATION_CALLBACK SectionNotificationCallback<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"139\"></td><td><pre></pre></td></tr><tr><td data-num=\"140\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">endif</span> <span class=\"token comment\">// FLT_MGR_WIN8</span></span></pre></td></tr><tr><td data-num=\"141\"></td><td><pre></pre></td></tr><tr><td data-num=\"142\"></td><td><pre><span class=\"token punctuation\">&#125;</span> FLT_REGISTRATION<span class=\"token punctuation\">,</span> <span class=\"token operator\">*</span>PFLT_REGISTRATION<span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>上面的结构来自 VS2019 中的定义，中文是书中的介绍。</p>\n<p>第 1 个域 Size 表示  <code>FLT_REGISTRATION</code>  结构的大小， 当然大小就是  <code>sizeof(FLT_REGISTRATION)</code> 。 微软习惯在 Windows 内核的数据结构前面加上大小， 易于排错。</p>\n<p>第 2 个域 Version 是  <code>FLT_REGISTRATION</code>  结构的版本号。 对于这个域， 读者不需要多加考虑， 直接按照惯例填写  <code>FLT_REGISTRATION_VERSION</code>  即可。</p>\n<p>第 3 个域 Flags 是标志位， 标记是否要收到这类的操作。 但是有趣的是， 这个域只有两种设置法： 一种设置为 NULL， 不起任何作用； 另一种则设置为  <code>FLTFL_REGISTRATION_DO_NOT_ SUPPORT_SERVICE_STOP</code>  ， 代表当停止服务时  <code>Minifilter</code>  不会响应且不会调用到  <code>FilterUnloadCallback</code>  ， 即使  <code>FilterUnloadCallback</code>  并不是 NULL。</p>\n<p>第 4 个域  <code>Context Registration</code>  是上下文注册， 注册处理上下文的函数。</p>\n<p>第 5 个域  <code>Operation Registration</code>  是操作回调函数集注册。 这是最重要的一个域， 我们将要过滤的文件操作回调函数写在其中， 可以定义所有功能代码对应的回调函数。</p>\n<p>举例如下：</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>CONST FLT_OPERATION_REGISTRATION Callbacks<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span> IRP_MJ_CREATE<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>      <span class=\"token number\">0</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>      XxxPreCreate<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>      XxxPostCreate <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span> IRP_MJ_CLEANUP<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>      <span class=\"token number\">0</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>      XxxPreCleanup<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>      <span class=\"token constant\">NULL</span> <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span> IRP_MJ_WRITE<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>      <span class=\"token number\">0</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>      XxxPreWrite<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>      XxxPostWrite <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    <span class=\"token comment\">// 填写要过滤的定义集合</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span> IRP_MJ_OPERATION_END <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>这是  <code>FLT_OPERATION_REGISTRATION</code>  这个结构， 后面会做更详细的学习。</p>\n<p>第 6 个域 FilterUnloadCallback 是驱动卸载回调函数。 在驱动被停止时， 函数被调用，<br />\n代表要释放程序内的资源以结束过滤行为。 这个域可以设置为 NULL。</p>\n<p>第 7 个域 InstanceSetupCallback 是实例安装回调函数， 当一个卷实例要加载时会通过此<br />\n回调函数处理。 这个域可以设置为 NULL。</p>\n<p>第 8 个域 InstanceQueryTeardownCallback 是控制实例销毁函数， 这个回调函数只会在一<br />\n个手工解除绑定的请求时被调用。 这个域可以设置为 NULL。</p>\n<p>第 9 个域 InstanceTeardownStartCallback 是实例解绑定函数， 当调用时代表已经决定解<br />\n除绑定。 这个域可以设置为 NULL。</p>\n<p>第 10 个域 InstanceTeardownCompleteCallback 是实例解绑定完成函数， 当确定时调用解<br />\n除绑定后的完成函数。 这个域可以设置为 NULL。</p>\n<p>还有一些域因为使用不多， 所以本书将其略去， 有兴趣的读者可以自己参考相关文档。 笔者习惯将它们设置为 NULL。</p>\n<p>下面是一个设置的例子。</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>CONST FLT_REGISTRATION FilterRegistration <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token keyword\">sizeof</span><span class=\"token punctuation\">(</span> FLT_REGISTRATION <span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>         <span class=\"token comment\">//  Size</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    FLT_REGISTRATION_VERSION<span class=\"token punctuation\">,</span>           <span class=\"token comment\">//  Version</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token number\">0</span><span class=\"token punctuation\">,</span>                                  <span class=\"token comment\">//  Flags</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token constant\">NULL</span><span class=\"token punctuation\">,</span>                               <span class=\"token comment\">//  Context</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    Callbacks<span class=\"token punctuation\">,</span>                          <span class=\"token comment\">//  Operation callbacks</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    PtUnload<span class=\"token punctuation\">,</span>                           <span class=\"token comment\">//  MiniFilterUnload</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    PtInstanceSetup<span class=\"token punctuation\">,</span>                    <span class=\"token comment\">//  InstanceSetup</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    PtInstanceQueryTeardown<span class=\"token punctuation\">,</span>            <span class=\"token comment\">//  InstanceQueryTeardown</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    PtInstanceTeardownStart<span class=\"token punctuation\">,</span>            <span class=\"token comment\">//  InstanceTeardownStart</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    PtInstanceTeardownComplete<span class=\"token punctuation\">,</span>         <span class=\"token comment\">//  InstanceTeardownComplete</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    <span class=\"token constant\">NULL</span><span class=\"token punctuation\">,</span>                               <span class=\"token comment\">//  GenerateFileName</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>    <span class=\"token constant\">NULL</span><span class=\"token punctuation\">,</span>                               <span class=\"token comment\">//  GenerateDestinationFileName</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    <span class=\"token constant\">NULL</span>                                <span class=\"token comment\">//  NormalizeNameComponent</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre></pre></td></tr><tr><td data-num=\"21\"></td><td><pre><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>其中， 最重要的就是  <code>CallBacks</code> 。这是一个回调函数数组， 在其中可以处理所有的请求。</p>\n<p>但是处理方式和以前做请求过滤时有所不同， 以前处理的是 IRP， 其实有两种处理：<strong>一种是在请求完成之前就进行处理</strong>； <strong>另一种是用事件等待请求完成之后， 或者在完成函数中进行处理</strong>。</p>\n<p>前一种适合要拦截请求本身的情况， 后一种适合要拦截请求之后返回的结果的情况。<br />\n在 Minifilter 中， 这两种过滤被分在两个回调函数中， 一个称为预操作回调函数（Pre-Operation Function） ， 另一个称为后操作回调函数（Post-Operation Function） 。</p>\n<p>下面是一个例子。仅供参考。</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>CONST FLT_OPERATION_REGISTRATION Callbacks<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span> IRP_MJ_CREATE<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>      <span class=\"token number\">0</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>      XxxPreCreate<span class=\"token punctuation\">,</span> <span class=\"token comment\">// 生成预操作回调函数</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>      XxxPostCreate <span class=\"token comment\">// 生成后操作回调函数</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span> IRP_MJ_WRITE<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>      FLTFL_OPERATION_REGISTRATION_SKIP_CACHED_IO<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>      XxxPreWrite<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>      XxxPostWrite </pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p><code>Callbacks</code>  数组内存储数据结构为  <code>FLT_OPERATION_REGISTRATION</code>  的数组， 用意是把需要做过滤的请求一个个声明出来， 每个都包括了预操作回调函数与后操作回调函数，宣告过后通过注册就能使 IRP 包顺利地通过这边指定的函数来做处理了。 当有多个微过滤器时， IRP 会通过每一个微过滤器的预操作回调函数与后操作回调函数， 除非 IRP 传递到中途被直接返回而不再继续传递下去。</p>\n<p>读者可以看到， 这个数组的每个元素由四部分组成。 第 1 个域是请求的主功能号， 这是我们熟知的。 第 2 个域是一个标志位， 有三种写法： 第 1 种是写 0， 这个标志仅仅对读 / 写回调有用， 所以对生成请求的处理直接写 0 即可； 第 2 种是写  <code>FLTFL_OPERATION_REGISTRATION_SKIP_CACHED_IO</code>  ， 表示不过滤缓冲读 / 写请求； 第 3 种是写  <code>FLTFL_OPERATION_REGISTRATION_SKIP_PAGING_IO</code>  ， 表示不过滤分页读 / 写请求。 接下来的两个域就是预操作回调函数和后操作回调函数。请注意最后一个元素必须是  <code>IRP_MJ_OPERATION_END</code>  ， 否则过滤管理器无法知道到底有多少个元素。</p>\n<p>读者已经看到了上面有若干个回调函数， 其中有一些回调函数在操作回调函数集 Callbacks 中， 还有一些回调函数就直接在微过滤器注册结构中。 下面的任务就是逐个实现这些函数。在操作回调函数集中， 本章的例子只需要用到生成回调函数， 其他的回调处理可以按这个类推。 读者完全可以把第 12 章相关的各种请求的处理逐个挪到 Minifilter 的框架里。</p>\n<h2 id=\"卸载函数\"><a class=\"anchor\" href=\"#卸载函数\">#</a> 卸载函数</h2>\n<p>在卸载回调函数中， 应该注销我们曾经注册过的微过滤器， 这可以通过调用内核 API 函数 FltUnregisterFilter 来实现。 除此之外， 在这个回调函数中， 读者可以完成以前在传统型的文件过滤驱动中驱动卸载函数所完成的所有工作。 但是本例非常简单， 仅仅是调用 FltUnregisterFilter 而已。 这个函数也只有一个参数， 就是微过滤器句柄。</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>NTSTATUS</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token function\">FsFilter01Unload</span> <span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    _In_ FLT_FILTER_UNLOAD_FLAGS Flags</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token function\">UNREFERENCED_PARAMETER</span><span class=\"token punctuation\">(</span> Flags <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token function\">PAGED_CODE</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    <span class=\"token function\">PT_DBG_PRINT</span><span class=\"token punctuation\">(</span> PTDBG_TRACE_ROUTINES<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>                  <span class=\"token punctuation\">(</span><span class=\"token string\">\"FsFilter01!FsFilter01Unload: Entered\\n\"</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    <span class=\"token function\">FltUnregisterFilter</span><span class=\"token punctuation\">(</span> gFilterHandle <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    <span class=\"token keyword\">return</span> STATUS_SUCCESS<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>这个函数的主要工作是释放资源，  <code>FltUnregisterFilter</code>  与  <code>FltRegisterFilter</code>  互相对应， <code>FltUnregisterFilter</code> <strong> 用来释放已注册的微过滤器在 Windows 内核内部所使用的资源</strong>。</p>\n<h2 id=\"预操作回调函数\"><a class=\"anchor\" href=\"#预操作回调函数\">#</a> 预操作回调函数</h2>\n<p>我们针对  <code>IRP_MJ_CREATE</code>  这个主功能号<em>来设置预操作回调函数与后操作回调函数</em>，当系统接收到标识为  <code>IRP_MJ_CREATE</code>  的 IRP 也就是试图生成或者打开文件时， 就会调用到预操作回调函数与后操作回调函数。</p>\n<p><code>NPPreCreate</code>  是我们<strong>设置的预操作回调函数</strong>。这个函数有三个参数， 其中第一个参数是一个  <code>FLT_CALLBACK_DATA</code>  的指针，   <code>FLT_CALLBACK_DATA</code>  称为回调数据包， 这个数据包内含有和这个请求相关的全部信息。 正是因为有了这个参数， 所以不再直接读取 IRP 的信息了。 这个函数的参数中不再有 IRP 的指针。</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>FLT_PREOP_CALLBACK_STATUS</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token function\">NPPreCreate</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    __inout PFLT_CALLBACK_DATA Data<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    __in PCFLT_RELATED_OBJECTS FltObjects<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    __deref_out_opt PVOID<span class=\"token operator\">*</span> CompletionContext</pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token comment\">// 缓存区，用来获得文件名</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token keyword\">char</span> FileName<span class=\"token punctuation\">[</span><span class=\"token number\">260</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token string\">\"X:\"</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    NTSTATUS status<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    PFLT_FILE_NAME_INFORMATION nameInfo<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    <span class=\"token comment\">// 未使用的参数，用宏掩盖之使其不发生编译警告</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    <span class=\"token function\">UNREFERENCED_PARAMETER</span><span class=\"token punctuation\">(</span>FltObjects<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    <span class=\"token function\">UNREFERENCED_PARAMETER</span><span class=\"token punctuation\">(</span>CompletionContext<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    <span class=\"token comment\">// 检测可分页代码</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    <span class=\"token function\">PAGED_CODE</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    __try <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>        <span class=\"token comment\">// 这里有获取文件名信息，获取文件名和解析文件名等几个函数，稍后在详细了解。</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>        status <span class=\"token operator\">=</span> <span class=\"token function\">FltGetFileNameInformation</span><span class=\"token punctuation\">(</span>Data<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>            FLT_FILE_NAME_NORMALIZED <span class=\"token operator\">|</span> FLT_FILE_NAME_QUERY_DEFAULT<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>            <span class=\"token operator\">&amp;</span>nameInfo<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">NT_SUCCESS</span><span class=\"token punctuation\">(</span>status<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>            <span class=\"token comment\">//如果成功了，解析文件名信息，然后比较其中是否有 NOTEPAD.EXE 子字符串</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>gCommand <span class=\"token operator\">==</span> ENUM_BLOCK<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>                <span class=\"token function\">FltParseFileNameInformation</span><span class=\"token punctuation\">(</span>nameInfo<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>                <span class=\"token comment\">// 将字符串转换为 CHAR 大写以利于比对字符串</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>                <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">NPUnicodeStringToChar</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>nameInfo<span class=\"token operator\">-></span>Name<span class=\"token punctuation\">,</span> FileName<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>                    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">strstr</span><span class=\"token punctuation\">(</span>FileName<span class=\"token punctuation\">,</span> <span class=\"token string\">\"NOTEPAD.EXE\"</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">></span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>                        <span class=\"token comment\">// 填写拒绝</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>                        Data<span class=\"token operator\">-></span>IoStatus<span class=\"token punctuation\">.</span>Status <span class=\"token operator\">=</span> STATUS_ACCESS_DENIED<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>                        Data<span class=\"token operator\">-></span>IoStatus<span class=\"token punctuation\">.</span>Information <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>                        <span class=\"token function\">FltReleaseFileNameInformation</span><span class=\"token punctuation\">(</span>nameInfo<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>                        <span class=\"token comment\">// 返回请求已经结束，，也就是不用在下传了</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>                        <span class=\"token keyword\">return</span> FLT_PREOP_COMPLETE<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>                    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>                <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>            <span class=\"token comment\">// 释放名字资源 </span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>            <span class=\"token function\">FltReleaseFileNameInformation</span><span class=\"token punctuation\">(</span>nameInfo<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>    <span class=\"token function\">__except</span> <span class=\"token punctuation\">(</span>EXCEPTION_EXECUTE_HANDLER<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>        <span class=\"token function\">DbgPrint</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"NPPreCreate EXCEPTION_EXECUTE_HANDLER\\n\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>    <span class=\"token keyword\">return</span> FLT_PREOP_SUCCESS_WITH_CALLBACK<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>这是一个很简单的预操作回调函数， 它的主要作用就是尽可能地解析目前的文件名称， 然后判断这个名称是否符合我们需要的条件。 我们的目的是限制名为 “notepad.exe” 的文件被使用， 任何文件的操作比如读取、 删除、 覆盖、 重命名、 执行等， 必定都会先调用到打开请求。 因此，在这里做个简单的判断， 试图分辨出目前系统操作的文件是否符合我们所寻找的条件。</p>\n<p>上面用到了一个自定义函数  <code>NPUnicodeStringToChar</code> 。 该函数将  <code>UNICODE_STRING</code>  转换为全大写的 CHAR 数组， 以便搜索子字符串 “NOTEPAD.EXE”。 其中使用了内核 API 函数  <code>RtlUpperChar</code>  转换大小写， 我们可以试着自己实现这个函数。</p>\n<h3 id=\"了解相关数据结构\"><a class=\"anchor\" href=\"#了解相关数据结构\">#</a> 了解相关数据结构</h3>\n<p><code>FLT_CALLBACK_DATA</code>  、  <code>PFLT_IO_PARAMETER_BLOCK</code>  、  <code>FLT_PARAMETERS</code></p>\n<h4 id=\"flt_callback_data\"><a class=\"anchor\" href=\"#flt_callback_data\">#</a> FLT_CALLBACK_DATA</h4>\n<p>下面是回调数据包  <code>FLT_CALLBACK_DATA</code>  的定义:</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">typedef</span> <span class=\"token keyword\">struct</span> <span class=\"token class-name\">_FLT_CALLBACK_DATA</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token comment\">//  Flags</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    FLT_CALLBACK_DATA_FLAGS Flags<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    <span class=\"token comment\">//  Thread that initiated this operation.</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    PETHREAD CONST Thread<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    <span class=\"token comment\">//  Pointer to the changeable i/o parameters</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    PFLT_IO_PARAMETER_BLOCK CONST Iopb<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>    <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>    <span class=\"token comment\">//  For pre-op calls: if filter returns STATUS_IO_COMPLETE, then it should</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>    <span class=\"token comment\">//  set the return i/o status here.  For post-operation calls, this is set</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>    <span class=\"token comment\">//  by filter-manager indicating the completed i/o status.</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>    <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>    IO_STATUS_BLOCK IoStatus<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre></pre></td></tr><tr><td data-num=\"29\"></td><td><pre></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>    <span class=\"token keyword\">struct</span> <span class=\"token class-name\">_FLT_TAG_DATA_BUFFER</span> <span class=\"token operator\">*</span>TagData<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>    <span class=\"token keyword\">union</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>        <span class=\"token keyword\">struct</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>            <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>            <span class=\"token comment\">//  Queue links if the FltMgr queue is used to</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>            <span class=\"token comment\">//  pend the callback</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>            <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>            LIST_ENTRY QueueLinks<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>            <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>            <span class=\"token comment\">//  Additional context</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>            <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>            PVOID QueueContext<span class=\"token punctuation\">[</span><span class=\"token number\">2</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>        <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>        <span class=\"token comment\">//  The following are available to filters to use</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>        <span class=\"token comment\">//  in whatever manner desired if not using the filter manager</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre>        <span class=\"token comment\">//  queues.</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>        <span class=\"token comment\">//  NOTE:  These fields are only valid while the filter is</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre>        <span class=\"token comment\">//         processing this operation which is inside the operation</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre>        <span class=\"token comment\">//         callback or while the operation is pended.</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>        <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre></pre></td></tr><tr><td data-num=\"58\"></td><td><pre>        PVOID FilterContext<span class=\"token punctuation\">[</span><span class=\"token number\">4</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"59\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre></pre></td></tr><tr><td data-num=\"61\"></td><td><pre>    <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"62\"></td><td><pre>    <span class=\"token comment\">//  Original requester mode of caller</span></pre></td></tr><tr><td data-num=\"63\"></td><td><pre>    <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"64\"></td><td><pre></pre></td></tr><tr><td data-num=\"65\"></td><td><pre>    KPROCESSOR_MODE RequestorMode<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"66\"></td><td><pre></pre></td></tr><tr><td data-num=\"67\"></td><td><pre><span class=\"token punctuation\">&#125;</span> FLT_CALLBACK_DATA<span class=\"token punctuation\">,</span> <span class=\"token operator\">*</span>PFLT_CALLBACK_DATA<span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>回调数据包结构代表了一个 I/O 操作。 过滤管理器与微过滤驱动都使用这个结构来初始化与处理 I/O 操作， 内含许多嵌套结构定义， 可以在 WDK 头文件  <code>fltkernel.h</code>  中找到更多有关的数据。这个结构可以说是 Minifilter 的基础。</p>\n<p>大部分读者会提出疑问， 以前在  <code>sfilter</code>  中， 我们从 IRP 指针及 IRP 的当前栈空间指针中得到许多信息， 比如写请求的长度等， 现<br />\n在如何能得到这些信息呢？</p>\n<h4 id=\"pflt_io_parameter_block\"><a class=\"anchor\" href=\"#pflt_io_parameter_block\">#</a> PFLT_IO_PARAMETER_BLOCK</h4>\n<p>注意  <code>Iopb</code>  域， 这是一个  <code>PFLT_IO_PARAMETER_BLOCK</code>  指针。 这个数据结构定义如下：</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">typedef</span> <span class=\"token keyword\">struct</span> <span class=\"token class-name\">_FLT_IO_PARAMETER_BLOCK</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token comment\">//  Fields from IRP</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token comment\">//  Flags</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    ULONG IrpFlags<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token comment\">//  Major/minor functions from IRP</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    UCHAR MajorFunction<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    UCHAR MinorFunction<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    <span class=\"token comment\">//  The flags associated with operations.</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    <span class=\"token comment\">//  The IO_STACK_LOCATION.Flags field in the old model (SL_* flags)</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>    <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>    UCHAR OperationFlags<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>    <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>    <span class=\"token comment\">//  For alignment</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>    <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>    UCHAR Reserved<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre></pre></td></tr><tr><td data-num=\"28\"></td><td><pre></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>    <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>    <span class=\"token comment\">//  The FileObject that is the target for this</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>    <span class=\"token comment\">//  IO operation.</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>    <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>    PFILE_OBJECT TargetFileObject<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>    <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>    <span class=\"token comment\">//  Instance that i/o is directed to</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>    <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>    PFLT_INSTANCE TargetInstance<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>    <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>    <span class=\"token comment\">//  Normalized parameters for the operation</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>    <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>    FLT_PARAMETERS Parameters<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre></pre></td></tr><tr><td data-num=\"48\"></td><td><pre><span class=\"token punctuation\">&#125;</span> FLT_IO_PARAMETER_BLOCK<span class=\"token punctuation\">,</span> <span class=\"token operator\">*</span>PFLT_IO_PARAMETER_BLOCK<span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>在这里就可以找到以前熟悉的许多信息了， 包括主功能号、 次功能号和文件对象指针等。</p>\n<h4 id=\"flt_parameters\"><a class=\"anchor\" href=\"#flt_parameters\">#</a> FLT_PARAMETERS</h4>\n<p>此外， 其中还有一个结构为  <code>FLT_PARAMETERS</code>  的<strong>参数域</strong>， 这个数据结构是一个共用体， 应用的域根据不同的主功能号而不同， 该结构体的部分如下：</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">typedef</span> <span class=\"token keyword\">union</span> _FLT_PARAMETERS <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token comment\">//  IRP_MJ_CREATE</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token keyword\">struct</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>        PIO_SECURITY_CONTEXT SecurityContext<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>        <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>        <span class=\"token comment\">//  The low 24 bits contains CreateOptions flag values.</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>        <span class=\"token comment\">//  The high 8 bits contains the CreateDisposition values.</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>        <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>        ULONG Options<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>        USHORT POINTER_ALIGNMENT FileAttributes<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>        USHORT ShareAccess<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>        ULONG POINTER_ALIGNMENT EaLength<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>        PVOID EaBuffer<span class=\"token punctuation\">;</span>                 <span class=\"token comment\">//Not in IO_STACK_LOCATION parameters list</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>        LARGE_INTEGER AllocationSize<span class=\"token punctuation\">;</span>   <span class=\"token comment\">//Not in IO_STACK_LOCATION parameters list</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span> Create<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>    ………</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>    <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>    <span class=\"token comment\">//  IRP_MJ_READ</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>    <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>    <span class=\"token keyword\">struct</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>        ULONG Length<span class=\"token punctuation\">;</span>                   <span class=\"token comment\">//Length of transfer</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>        ULONG POINTER_ALIGNMENT Key<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>        LARGE_INTEGER ByteOffset<span class=\"token punctuation\">;</span>       <span class=\"token comment\">//Offset to read from</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>        PVOID ReadBuffer<span class=\"token punctuation\">;</span>       <span class=\"token comment\">//Not in IO_STACK_LOCATION parameters list</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>        PMDL MdlAddress<span class=\"token punctuation\">;</span>        <span class=\"token comment\">//Mdl address for the buffer  (maybe NULL)</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span> Read<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>    <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>    <span class=\"token comment\">//  IRP_MJ_WRITE</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>    <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>    <span class=\"token keyword\">struct</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>        ULONG Length<span class=\"token punctuation\">;</span>                   <span class=\"token comment\">//Length of transfer</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>        ULONG POINTER_ALIGNMENT Key<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>        LARGE_INTEGER ByteOffset<span class=\"token punctuation\">;</span>       <span class=\"token comment\">//Offset to write to</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>        PVOID WriteBuffer<span class=\"token punctuation\">;</span>      <span class=\"token comment\">//Not in IO_STACK_LOCATION parameters list</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>        PMDL MdlAddress<span class=\"token punctuation\">;</span>        <span class=\"token comment\">//Mdl address for the buffer  (maybe NULL)</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span> Write<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre></pre></td></tr><tr><td data-num=\"52\"></td><td><pre>    ………</pre></td></tr><tr><td data-num=\"53\"></td><td><pre><span class=\"token punctuation\">&#125;</span> FLT_PARAMETERS<span class=\"token punctuation\">,</span> <span class=\"token operator\">*</span>PFLT_PARAMETERS<span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>从这里就很容易找到写请求包括的写入位置、 长度和缓冲区等相关参数。</p>\n<h3 id=\"解析文件路径所需要调用的函数\"><a class=\"anchor\" href=\"#解析文件路径所需要调用的函数\">#</a> 解析文件路径所需要调用的函数</h3>\n<h4 id=\"fltgetfilenameinformation\"><a class=\"anchor\" href=\"#fltgetfilenameinformation\">#</a> FltGetFileNameInformation</h4>\n<p>第一个函数是  <code>FltGetFileNameInformation</code>  ，这个函数可以取得一个文件或目录的文件名信息结构。</p>\n<p><strong>语法:</strong></p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>NTSTATUS FLTAPI <span class=\"token function\">FltGetFileNameInformation</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>  <span class=\"token punctuation\">[</span>in<span class=\"token punctuation\">]</span>  PFLT_CALLBACK_DATA         CallbackData<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  <span class=\"token punctuation\">[</span>in<span class=\"token punctuation\">]</span>  FLT_FILE_NAME_OPTIONS      NameOptions<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  <span class=\"token punctuation\">[</span>out<span class=\"token punctuation\">]</span> PFLT_FILE_NAME_INFORMATION <span class=\"token operator\">*</span>FileNameInformation</pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p><strong>参数:</strong></p>\n<p><code>[in] CallbackData</code></p>\n<p>指向  <code>FLT_CALLBACK_DATA</code>  结构的指针，它是 I/O 操作的回调数据结构。 此参数是必需的，不能为  <strong>NULL</strong> 。</p>\n<p><code>[in] NameOptions</code></p>\n<p>一个  <code>FLT_FILE_NAME_OPTIONS</code>  值，该值包含指定要返回的名称信息的格式以及筛选器管理器要使用的查询方法的标志。 (名称提供程序微型筛选器驱动程序可以使用其他标志来指定名称查询选项。) 此参数是必需的，不能为  <strong>NULL</strong> 。</p>\n<p>下面是文件名格式标志值。 只能指定以下标志之一。 有关这些格式的说明，请参阅  <code>FLT_FILE_NAME_INFORMATION</code>  。</p>\n<table>\n<thead>\n<tr>\n<th>名称格式标志值</th>\n<th>含义</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>FLT_FILE_NAME_NORMALIZED</td>\n<td><em>FileNameInformation</em> 参数接收包含文件的规范化名称的结构的地址。</td>\n</tr>\n<tr>\n<td>FLT_FILE_NAME_OPENED</td>\n<td><em>FileNameInformation</em> 参数接收包含打开文件时使用的名称的结构的地址。</td>\n</tr>\n<tr>\n<td>FLT_FILE_NAME_SHORT</td>\n<td><em>FileNameInformation</em> 参数接收包含文件的短 (8.3) 名称的结构的地址。 短名称由最多 8 个字符组成，后跟一个句点，最多 3 个字符。 文件的短名称不包括卷名称、目录路径或流名称。 在预创建路径中无效。</td>\n</tr>\n</tbody>\n</table>\n<p>下面是文件名查询方法标志值。 只能指定以下标志之一。</p>\n<table>\n<thead>\n<tr>\n<th>查询方法标志值</th>\n<th>含义</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>FLT_FILE_NAME_QUERY_DEFAULT</td>\n<td>如果目前无法安全地查询文件系统中的文件名，<strong>FltGetFileNameInformation</strong> 不执行任何操作。 否则， <strong>FltGetFileNameInformation</strong> 会查询筛选器管理器的名称缓存以获取文件名信息。 如果在缓存中找不到该名称， <strong>FltGetFileNameInformation</strong> 会查询文件系统并缓存结果。</td>\n</tr>\n<tr>\n<td>FLT_FILE_NAME_QUERY_CACHE_ONLY</td>\n<td><strong>FltGetFileNameInformation</strong> 查询筛选器管理器的名称缓存以获取文件名信息。 <strong>FltGetFileNameInformation</strong> 不查询文件系统。</td>\n</tr>\n<tr>\n<td>FLT_FILE_NAME_QUERY_FILESYSTEM_ONLY</td>\n<td><strong>FltGetFileNameInformation</strong> 查询文件系统以获取文件名信息。 <strong>FltGetFileNameInformation</strong> 不会查询筛选器管理器的名称缓存，也不会缓存文件系统查询的结果。</td>\n</tr>\n<tr>\n<td>FLT_FILE_NAME_QUERY_ALWAYS_ALLOW_CACHE_LOOKUP</td>\n<td><strong>FltGetFileNameInformation</strong> 查询筛选器管理器的名称缓存以获取文件名信息。 如果在缓存中找不到该名称，并且目前可以安全地执行此操作， <strong>FltGetFileNameInformation</strong> 会查询文件系统以获取文件名信息并缓存结果。</td>\n</tr>\n</tbody>\n</table>\n<p>名称提供程序微型筛选器使用以下标志来指定文件名操作的属性。</p>\n<table>\n<thead>\n<tr>\n<th>名称提供程序标志值</th>\n<th>含义</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>FLT_FILE_NAME_REQUEST_FROM_CURRENT_PROVIDER</td>\n<td>名称提供程序微型筛选器可以使用此标志指定名称查询请求应重定向到自身， (名称提供程序微型筛选器) ，而不是由堆栈中较低的名称提供程序满足。</td>\n</tr>\n<tr>\n<td>FLT_FILE_NAME_DO_NOT_CACHE</td>\n<td>此标志表示不应缓存从此查询检索到的名称。 名称提供程序微型筛选器使用此标志来执行中间查询以生成名称。</td>\n</tr>\n<tr>\n<td>FLT_FILE_NAME_ALLOW_QUERY_ON_REPARSE</td>\n<td>名称提供程序微型筛选器可以使用此标志指定在创建后路径中查询名称是安全的，即使返回了 STATUS_REPARSE 也是如此。 调用方负责确保<strong> FileObject-FileName&gt;</strong> 字段未更改。 请勿将此标志用于装入点或符号链接重新分析点。</td>\n</tr>\n</tbody>\n</table>\n<p><code>[out] FileNameInformation</code></p>\n<p>指向调用方分配的变量的指针，该变量接收包含文件名信息的系统分配 <span class=\"exturl\" data-url=\"aHR0cHM6Ly9kb2NzLm1pY3Jvc29mdC5jb20vemgtY24vd2luZG93cy1oYXJkd2FyZS9kcml2ZXJzL2RkaS9mbHRrZXJuZWwvbnMtZmx0a2VybmVsLV9mbHRfZmlsZV9uYW1lX2luZm9ybWF0aW9u\">FLT_FILE_NAME_INFORMATION</span> 结构的地址。 <strong>FltGetFileNameInformation</strong> 从分页池分配此结构。 此参数是必需的，不能为  <strong>NULL</strong> 。</p>\n<p><strong>返回值:</strong></p>\n<p>如果成功返回名称信息， <strong>FltGetFileNameInformation</strong> 将返回 STATUS_SUCCESS。 否则，它将返回相应的 NTSTATUS 值，例如以下值之一：</p>\n<p><img data-src=\"image001.png\" alt=\"\" /></p>\n<h4 id=\"fltparsefilenameinformation\"><a class=\"anchor\" href=\"#fltparsefilenameinformation\">#</a> FltParseFileNameInformation</h4>\n<p>第二个函数是  <code>FltParseFileNameInformation</code> ，</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>NTSTATUS FLTAPI <span class=\"token function\">FltParseFileNameInformation</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>  <span class=\"token punctuation\">[</span>in<span class=\"token punctuation\">,</span> out<span class=\"token punctuation\">]</span> PFLT_FILE_NAME_INFORMATION FileNameInformation</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>详细参见微软的官方文档→<span class=\"exturl\" data-url=\"aHR0cHM6Ly9kb2NzLm1pY3Jvc29mdC5jb20vemgtY24vd2luZG93cy1oYXJkd2FyZS9kcml2ZXJzL2RkaS9mbHRrZXJuZWwvbmYtZmx0a2VybmVsLWZsdHBhcnNlZmlsZW5hbWVpbmZvcm1hdGlvbj9mMXVybD0lM0ZhcHBJZCUzRERldjE2SURFRjElMjZsJTNEWkgtQ04lMjZrJTNEayhGTFRLRVJORUwlMjUyRkZsdFBhcnNlRmlsZU5hbWVJbmZvcm1hdGlvbiklM0JrKEZsdFBhcnNlRmlsZU5hbWVJbmZvcm1hdGlvbiklM0JrKERldkxhbmctQyUyNTJCJTI1MkIpJTNCayhUYXJnZXRPUy1XaW5kb3dzKSUyNnJkJTNEdHJ1ZQ==\">fltParseFileNameInformation 函数</span></p>\n<p><em>通过  <code>FltParseFileNameInformation</code>  函数可以得到一个含有路径名称与文件名的结构</em>， 我们再用字符串转换与比对便可以轻易地找出路径内是否有 NOTEPAD.EXE 等字符串。</p>\n<h3 id=\"否决请求\"><a class=\"anchor\" href=\"#否决请求\">#</a> 否决请求</h3>\n<p>在决定否决这个请求之后， 我们采用常见的与填写 IRP 的 IoStatus 域完全一样的方法否决这次请求， 相关代码如下：</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>Data<span class=\"token operator\">-></span>IoStatus<span class=\"token punctuation\">.</span>Status <span class=\"token operator\">=</span> STATUS_ACCESS_DENIED<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>Data<span class=\"token operator\">-></span>IoStatus<span class=\"token punctuation\">.</span>Information <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token function\">FltReleaseFileNameInformation</span><span class=\"token punctuation\">(</span>nameInfo<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">return</span> FLT_PREOP_COMPLETE<span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>这段程序代码主要是告诉过滤管理器， 这个请求要即刻返回失败， 即代表这个 IRP 不会往下处理， 在操作系统里我们就会看到类似于图 13-1 所示的信息。</p>\n<p><img data-src=\"image002.png\" alt=\"\" /></p>\n<h2 id=\"后操作回调函数\"><a class=\"anchor\" href=\"#后操作回调函数\">#</a> 后操作回调函数</h2>\n<p>当 IRP 完成返回时就会通过后操作回调函数， 例如， 若不想让文件新建成功， 则可以通过 FltCancelFileOpen 来取消之前的 FILE_CREATE、 FILE_OPEN 等操作。</p>\n<p>在这段程序代码中并无 FltCancelFileOpen 操作， 是因为我们在预操作回调函数内就已经过滤该行为且设定返回值的动作了， 并不需要在这里重复操作。</p>\n<p>下面<strong>这个后处理回调函数对程序的功能本身并没有意义</strong>， 仅仅作为后处理回调写法的说明展示。</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>FLT_POSTOP_CALLBACK_STATUS</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token function\">NPPostCreate</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    __inout PFLT_CALLBACK_DATA Data<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    __in PCFLT_RELATED_OBJECTS FltObjects<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    __in_opt PVOID CompletionContext<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    __in FLT_POST_OPERATION_FLAGS Flags</pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    FLT_POSTOP_CALLBACK_STATUS returnStatus <span class=\"token operator\">=</span> FLT_POSTOP_FINISHED_PROCESSING<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    PFLT_FILE_NAME_INFORMATION nameInfo<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    NTSTATUS status<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    <span class=\"token function\">UNREFERENCED_PARAMETER</span><span class=\"token punctuation\">(</span>CompletionContext<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    <span class=\"token function\">UNREFERENCED_PARAMETER</span><span class=\"token punctuation\">(</span>Flags<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    <span class=\"token comment\">//  If this create was failing anyway, don't bother scanning now.</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>    <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token function\">NT_SUCCESS</span><span class=\"token punctuation\">(</span>Data<span class=\"token operator\">-></span>IoStatus<span class=\"token punctuation\">.</span>Status<span class=\"token punctuation\">)</span> <span class=\"token operator\">||</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>        <span class=\"token punctuation\">(</span>STATUS_REPARSE <span class=\"token operator\">==</span> Data<span class=\"token operator\">-></span>IoStatus<span class=\"token punctuation\">.</span>Status<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>        <span class=\"token keyword\">return</span> FLT_POSTOP_FINISHED_PROCESSING<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>    <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>    <span class=\"token comment\">//  Check if we are interested in this file.</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>    <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>    status <span class=\"token operator\">=</span> <span class=\"token function\">FltGetFileNameInformation</span><span class=\"token punctuation\">(</span>Data<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>        FLT_FILE_NAME_NORMALIZED <span class=\"token operator\">|</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>        FLT_FILE_NAME_QUERY_DEFAULT<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>        <span class=\"token operator\">&amp;</span>nameInfo<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token function\">NT_SUCCESS</span><span class=\"token punctuation\">(</span>status<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>        <span class=\"token keyword\">return</span> FLT_POSTOP_FINISHED_PROCESSING<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>    <span class=\"token keyword\">return</span> returnStatus<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>返回  <code>FLT_POSTOP_FINISHED_PROCESSING</code> ， 代表 Minifilter 已经完成对 I/O 的所有处理， 并返回控制给过滤管理器。</p>\n<h2 id=\"其他回调函数\"><a class=\"anchor\" href=\"#其他回调函数\">#</a> 其他回调函数</h2>\n<p>除了前面介绍的回调函数， 还有其他的回调函数需要实现。 但是在大多数情况下， 这些函数的实现非常简单， 以至于用户只需要简单地拷贝例子中的代码就可以实现它们。 根据笔者的开发经验， 极少会利用到这些回调函数提供的功能。 下面对这些回调函数集中做个简单的介绍。 请注意这些函数都是可选的， 编程者可以不实现它们， 在微过滤器注册结构中将它们设置为 NULL。</p>\n<p>（1）  <code>InstatanceSetupCallback</code></p>\n<p><code>InstatanceSetupCallback</code>  这个回调函数存在的目的， 在于让本驱动的开发者来决定哪个<br />\n卷需要绑定， 哪个卷不需要绑定。  <code>InstatanceSetupCallback</code>  在下列情况下会被调用。</p>\n<ol>\n<li>当一个微过滤器加载时， 每个存在的卷都会导致这个调用。</li>\n<li>当一个新的卷被挂载时。</li>\n<li>当 FltAttachVolume 被调用（内核模式） 时。</li>\n<li>当 FltAttachVolumeAtAltitude 被调用（内核模式） 时。</li>\n<li>当 FilterAttach 被调用（用户模式） 时。</li>\n<li>当 FilterAttachAtAltitude 被调用（用户模式） 时。</li>\n</ol>\n<p>在这个过程中， 微过滤器决定是否在这个卷上生成实例。 这个回调函数的原型如下：</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">typedef</span> <span class=\"token function\">NTSTATUS</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">(</span>FLTAPI <span class=\"token operator\">*</span>PFLT_INSTANCE_SETUP_CALLBACK<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    _In_ PCFLT_RELATED_OBJECTS FltObjects<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    _In_ FLT_INSTANCE_SETUP_FLAGS Flags<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    _In_ DEVICE_TYPE VolumeDeviceType<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    _In_ FLT_FILESYSTEM_TYPE VolumeFilesystemType</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p><strong>参数详解：</strong></p>\n<p><code>FltObjects</code>  结构含有指向微过滤器、 卷和实例的指针。<em>这个实例是指将要在 InstanceSetupCallback 函数中生成的实例。</em></p>\n<p><code>Flags</code>  标记是什么操作导致激发了  <code>InstanceSetupCallback</code> ：<br />\nFLTFL_INSTANCE_SETUP_AUTOMATIC_ATTACHMENT： 这是一个微过滤器注册时， 一个自动的绑定通知。 过滤管理器为每个刚加载的微过滤器枚举所有的卷。 如果使用<br />\n者明确地指定一个实例绑定到某一个卷， 则不会设置这个标记。<br />\nFLTFL_INSTANCE_SETUP_MANUAL_ATTACHMENT： 通过调用 FilterAttach（用<br />\n户态） 、 FilterAttachVolumeAtAltitude（用户态） 或者 FltAttachVolume（内核态） 所发起<br />\n的一个手工请求。<br />\nFLTFL_INSTANCE_SETUP_NEWLY_MOUNTED_VOLUME： 文件系统刚刚挂载了<br />\n一个卷， 所以呼叫 InstanceSetupCallback 来通知微过滤器， 如果它愿意则可以生成实例来<br />\n绑定这个卷。<br />\n在 InstanceSetupCallback 中， 微过滤器同时得到了卷设备类型（VolumeDeviceType）<br />\n和卷文件系统类型（VolumeFilesystemType） ， 用来判断这个卷是否是过滤器所感兴趣<br />\n的。 同时， 微过滤器可以调用 FltGetVolumeProperties 来获取卷属性。 通过<br />\n FltSetInstanceContext 在实例上设置上下文， 当然这是在需要绑定时。 它甚至可以在卷上打<br />\n开或者关闭文件。 如果这个回调函数返回了成功， 那么这个实例将绑定到卷上； 如果返回<br />\n了一个警告或者错误， 那么不会绑定。 如果微过滤器没有指定这个回调函数回调， 那么系<br />\n统将认为用户总是返回 STATUS_SUCCESS， 实例总是会生成并绑定。</p>\n<h2 id=\"minifilter与应用程序通信\"><a class=\"anchor\" href=\"#minifilter与应用程序通信\">#</a> Minifilter 与应用程序通信</h2>\n<p>考虑到内核态和用户态之间的互动， 以前的做法是使用用户态的 API 函数  <code>DeviceIoControl</code>  结合在内核模块中的处理控制请求来实现双方数据的传递。 但是在 Minifilter 中则不同， Minifilter 有内建支持的 API 提供给开发者使用， 这里就先针对这些 API 来做介绍。</p>\n<p>该方法叫作通信端口（Communication Port） ， 顾名思义， 就是<strong>先定义一个通道名称， 通过双边已经定义好的通信端口来做数据上的沟通</strong>； 使用上很像 socket 或管道（pipe） 之类的通信程序设计。</p>\n<h3 id=\"建立通信端口\"><a class=\"anchor\" href=\"#建立通信端口\">#</a> 建立通信端口</h3>\n<p>下面的代码演示了如何建立一个通信端口。</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>PSECURITY_DESCRIPTOR sd<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>OBJECT_ATTRIBUTES oa<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>status <span class=\"token operator\">=</span> <span class=\"token function\">FltBuildDefaultSecurityDescriptor</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>sd<span class=\"token punctuation\">,</span> FLT_PORT_ALL_ACCESS<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token function\">NT_SUCCESS</span><span class=\"token punctuation\">(</span>status<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token keyword\">goto</span> final<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>status <span class=\"token operator\">=</span> <span class=\"token function\">FltBuildDefaultSecurityDescriptor</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>sd<span class=\"token punctuation\">,</span> FLT_PORT_ALL_ACCESS<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token function\">NT_SUCCESS</span><span class=\"token punctuation\">(</span>status<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    <span class=\"token keyword\">goto</span> final<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre></pre></td></tr><tr><td data-num=\"17\"></td><td><pre></pre></td></tr><tr><td data-num=\"18\"></td><td><pre><span class=\"token function\">RtlInitUnicodeString</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>uniString<span class=\"token punctuation\">,</span> MINISPY_PORT_NAME<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre></pre></td></tr><tr><td data-num=\"20\"></td><td><pre><span class=\"token function\">InitializeObjectAttributes</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>oa<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>    <span class=\"token operator\">&amp;</span>uniString<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>    OBJ_KERNEL_HANDLE <span class=\"token operator\">|</span> OBJ_CASE_INSENSITIVE<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>    <span class=\"token constant\">NULL</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>    sd<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>status <span class=\"token operator\">=</span> <span class=\"token function\">FltCreateCommunicationPort</span><span class=\"token punctuation\">(</span>gFilterHandle<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>    <span class=\"token operator\">&amp;</span>gServerPort<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>    <span class=\"token operator\">&amp;</span>oa<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>    <span class=\"token constant\">NULL</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>    NPMiniConnect<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>    NPMiniDisconnect<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>    NPMiniMessage<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>    <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p><strong>代码详解如下：</strong></p>\n<p><code>FltBuildDefaultSecurityDescriptor</code>  以  <code>FLT_PORT_ALL_ACCESS</code>  权限来产生一个安全性的描述符，  <code>MINISPY_PORT_NAME</code>  是刚刚所讲的通信端口定义的名称， 通过  <code>InitializeObjectAttributes</code>  来初始化对象属性（OBJECT_ATTRIBUTES） ， 接下来便要注册这个通信端口以及所需要使用到的函数。</p>\n<p>这里必须提供三个回调函数， 类似于以前我们为了实现通信所写的控制请求的分发函数。<br />\n这三个回调函数分别是  <code>NPMiniConnect</code> 、  <code>NPMiniDisconnect</code> 、  <code>NPMiniMessage</code> 。</p>\n<p><code>NPMiniConnect</code>  是用户态与内核态建立连接时内核会调用到的函数。<br />\n <code>NPMiniDisconnect</code>  是用户态与内核态连接结束时内核会调用到的函数。<br />\n <code>NPMiniMessage</code>  是用户态与内核态传送数据时内核会调用到的函数。</p>\n<p><em>用户态不需要再使用  <code>CreateFile</code>  和  <code>DeviceIoControl</code>  系列的 API， Minifilter 有专门的 API 提供给用户态程序使用</em>。</p>\n<p>这里用到的相关的 API 主要有两个：  <code>FilterConnectCommunicationPort</code>  和  <code>FilterSendMessage</code> ， 通过  <code>FilterConnectCommunicationPort</code>  可以调用到我们提供的  <code>NPMiniConnec</code> t 函数， 通过  <code>FilterSendMessage</code>  可以调用到相对应的  <code>NPMiniMessage</code> 。一对一关系很容易理解。</p>\n<p>至于参数则都是  <code>PVOID</code>  的指针， 开发时两边程序<strong>通过自定义的数据结构</strong>， 传入指针即可将数据传入或取出。</p>\n<p>接下来学习一下  <code>FilterConnectCommunicationPort</code>  和 <code>FilterSendMessage</code>  函数</p>\n<h4 id=\"filterconnectcommunicationport和filtersendmessage函数\"><a class=\"anchor\" href=\"#filterconnectcommunicationport和filtersendmessage函数\">#</a> FilterConnectCommunicationPort 和 FilterSendMessage 函数</h4>\n<p>WDK 定义的  <code>FilterConnectCommunicationPort</code>  原型如下：</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>HRESULT <span class=\"token function\">FilterConnectCommunicationPort</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>  <span class=\"token punctuation\">[</span>in<span class=\"token punctuation\">]</span>           LPCWSTR               lpPortName<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  <span class=\"token punctuation\">[</span>in<span class=\"token punctuation\">]</span>           DWORD                 dwOptions<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  <span class=\"token punctuation\">[</span>in<span class=\"token punctuation\">,</span> optional<span class=\"token punctuation\">]</span> LPCVOID               lpContext<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  <span class=\"token punctuation\">[</span>in<span class=\"token punctuation\">]</span>           WORD                  wSizeOfContext<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  <span class=\"token punctuation\">[</span>in<span class=\"token punctuation\">,</span> optional<span class=\"token punctuation\">]</span> LPSECURITY_ATTRIBUTES lpSecurityAttributes<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  <span class=\"token punctuation\">[</span>out<span class=\"token punctuation\">]</span>          HANDLE                <span class=\"token operator\">*</span>hPort</pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>函数在头文件  <code>fltuser.h</code>  中。</p>\n<p><strong>参数</strong></p>\n<p><code>[in] lpPortName</code></p>\n<p>指向以 NULL 结尾的宽字符串的指针，该字符串包含通信服务器端口的完全限定名称（例如，L&quot;\\MyFilterPort&quot;）。</p>\n<p><code>[in] dwOptions</code></p>\n<p>通信端口的连接选项。在 Windows 8.1 之前，此值设置为 0。</p>\n<table>\n<thead>\n<tr>\n<th>值</th>\n<th>意义</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><strong>FLT_PORT_FLAG_SYNC_HANDLE</strong></td>\n<td><em>hPort</em> 中 返回的句柄用于同步 I/O。此标志从 Windows 8.1 开始可用。</td>\n</tr>\n</tbody>\n</table>\n<p><code>[in, optional] lpContext</code></p>\n<p>指向调用者提供的上下文信息的指针，该上下文信息将传递给内核模式微过滤器的连接通知例程。（请参阅 FltCreateCommunicationPort 参考页面中的<em> ConnectNotifyCallback</em> 参数。）此参数是可选的，可以为 NULL。</p>\n<p><code>[in] wSizeOfContext</code></p>\n<p><em>lpContext</em> 参数指向的结构的大小（以字节为单位） 。如果<em> lpContext</em> 的值为非 <strong>NULL</strong> ，则此参数必须为非零。如果<em> lpContext</em> 为 <strong>NULL</strong> ，则此参数必须为零。</p>\n<p><code>[in, optional] lpSecurityAttributes</code></p>\n<p>指向 SECURITY_ATTRIBUTES 结构的指针，该结构确定返回的句柄是否可以被子进程继承。有关 SECURITY_ATTRIBUTES 结构的详细信息，请参阅 Microsoft Windows SDK 文档。此参数是可选的，可以是 <strong>NULL</strong> 。如果此参数为 <strong>NULL</strong> ，则无法继承句柄。</p>\n<p><code>[out] hPort</code></p>\n<p>指向调用者分配的变量的指针，如果对<strong> FilterConnectCommunicationPort</strong> 的调用成功，该变量将接收新创建的连接端口的句柄；否则，它会收到 INVALID_HANDLE_VALUE。</p>\n<p><strong>返回值</strong><br />\n如果成功， FilterConnectCommunicationPort 返回 S_OK。否则，它返回一个错误值。</p>\n<hr />\n<hr />\n<p>接下来是  <code>FilterSendMessage</code>  函数，其功能是向微过滤器发送消息。</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>HRESULT <span class=\"token function\">FilterSendMessage</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>  <span class=\"token punctuation\">[</span>in<span class=\"token punctuation\">]</span>           HANDLE  hPort<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  <span class=\"token punctuation\">[</span>in<span class=\"token punctuation\">,</span> optional<span class=\"token punctuation\">]</span> LPVOID  lpInBuffer<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  <span class=\"token punctuation\">[</span>in<span class=\"token punctuation\">]</span>           DWORD   dwInBufferSize<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  <span class=\"token punctuation\">[</span>out<span class=\"token punctuation\">]</span>          LPVOID  lpOutBuffer<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  <span class=\"token punctuation\">[</span>in<span class=\"token punctuation\">]</span>           DWORD   dwOutBufferSize<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  <span class=\"token punctuation\">[</span>out<span class=\"token punctuation\">]</span>          LPDWORD lpBytesReturned</pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>各参数说明如下。<br />\n <code>hPort</code>  ： 连接端口名称， 宽字符字符串。<br />\n <code>lpInBuffer</code>  ： 输入缓冲区。 将定义好的结构用指针传入。<br />\n <code>dwInBufferSize</code>  ： 输入缓冲区大小。<br />\n <code>lpOutBuffer</code>  ： 输出缓冲区。 既可传入数据也可取得返回的数据。<br />\n <code>dwOutBufferSize</code>  ： 输出缓冲区大小。<br />\n <code>lpBytesReturned</code>  ： FilterSendMessage 调用成功则会返回一个标识 lpOutBuffer 大小的<br />\n值。</p>\n<p><code>[in] hPort</code></p>\n<p>先前调用<span class=\"exturl\" data-url=\"aHR0cHM6Ly9kb2NzLm1pY3Jvc29mdC5jb20vZW4tdXMvd2luZG93cy9kZXNrdG9wL2FwaS9mbHR1c2VyL25mLWZsdHVzZXItZmlsdGVyY29ubmVjdGNvbW11bmljYXRpb25wb3J0\"> FilterConnectCommunicationPort</span> 返回的通信端口句柄。此参数是必需的，不能为 <strong>NULL</strong> 。</p>\n<p><code>[in, optional] lpInBuffer</code></p>\n<p>指向调用者分配的缓冲区的指针，该缓冲区包含要发送到微过滤器的消息。消息格式是调用者定义的。此参数是必需的，不能为 <strong>NULL</strong> 。</p>\n<p><code>[in] dwInBufferSize</code></p>\n<p><em>lpInBuffer</em> 指向的缓冲区的大小，以字节为单位。</p>\n<p><code>[out] lpOutBuffer</code></p>\n<p>指向调用者分配的缓冲区的指针，该缓冲区接收来自微过滤器的回复（如果有的话）。</p>\n<p><code>[in] dwOutBufferSize</code></p>\n<p><em>lpOutBuffer</em> 指向的缓冲区的大小，以字节为单位。如果<em> lpOutBuffer</em> 为<strong> NULL</strong> ，则忽略此值。</p>\n<p><code>[out] lpBytesReturned</code></p>\n<p>指向调用者分配的变量的指针，如果对 FilterSendMessage 的调用成功，则该变量接收<em> lpOutBuffer</em> 指向的缓冲区中返回的字节数。此参数是必需的，不能为 NULL。</p>\n<p><strong>返回值</strong></p>\n<p><strong>如果成功， FilterSendMessage</strong> 返回 S_OK。否则，它返回一个错误值。</p>\n<h3 id=\"在用户态通过dll使用通信端口的范例\"><a class=\"anchor\" href=\"#在用户态通过dll使用通信端口的范例\">#</a> 在用户态通过 DLL 使用通信端口的范例</h3>\n<p>为什么编写一个 dll：<em>在用户态编写应用程序时， 开发者可以编写一个简单的动态链接库（DLL） 来提供与内核中的 Minifilter 内核驱动程序通信的功能， 在应用程序中就可以调用这个 DLL 来与内核通信了</em>。</p>\n<p>在编写这个 DLL 时， 必须要包含 WDK 中的头文件 <code>fltUser.h</code> ， 此外还必须连接 Minifilter 提供给用户态程序使用的静态库 <code>fltLib.lib</code>  和 <code>fltMgr.lib</code> 。</p>\n<p>编程中要注意的第一件事是： <strong>在处理 <code>DLL_PROCESS_ATTACH</code>  时要调用 <code>FilterConnectCommunicationPort</code> ， 便能完成与 Minifilter 沟通的通信端口的初始化， 然后可以通过 <code>FilterSendMessage</code>  传送数据， 等到程序关闭后关闭并释放这个通信端口</strong>。</p>\n<p>以下是本章的例子中 <code>NPdll.dll</code>  的程序代码示例。</p>\n<p>这是头文件。</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">// 首先要引入头文件和要连接的静态库。</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">\"windows.h\"</span></span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;stdio.h></span></span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token comment\">// 一定要包含 Minifilter 的头文件</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;fltUser.h></span></span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">pragma</span> <span class=\"token expression\"><span class=\"token function\">comment</span><span class=\"token punctuation\">(</span>lib<span class=\"token punctuation\">,</span> </span><span class=\"token string\">\"user32.lib\"</span><span class=\"token expression\"><span class=\"token punctuation\">)</span></span></span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">pragma</span> <span class=\"token expression\"><span class=\"token function\">comment</span><span class=\"token punctuation\">(</span>lib<span class=\"token punctuation\">,</span> </span><span class=\"token string\">\"kernel32.lib\"</span><span class=\"token expression\"><span class=\"token punctuation\">)</span></span></span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token comment\">// 注意必须连接 Minifilter 提供的静态库</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">pragma</span> <span class=\"token expression\"><span class=\"token function\">comment</span><span class=\"token punctuation\">(</span>lib<span class=\"token punctuation\">,</span> </span><span class=\"token string\">\"fltLib.lib\"</span><span class=\"token expression\"><span class=\"token punctuation\">)</span></span></span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">pragma</span> <span class=\"token expression\"><span class=\"token function\">comment</span><span class=\"token punctuation\">(</span>lib<span class=\"token punctuation\">,</span> </span><span class=\"token string\">\"fltMgr.lib\"</span><span class=\"token expression\"><span class=\"token punctuation\">)</span></span></span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">pragma</span> <span class=\"token expression\"><span class=\"token function\">comment</span><span class=\"token punctuation\">(</span>lib<span class=\"token punctuation\">,</span> </span><span class=\"token string\">\"ntoskrnl.lib\"</span><span class=\"token expression\"><span class=\"token punctuation\">)</span></span></span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">pragma</span> <span class=\"token expression\"><span class=\"token function\">comment</span><span class=\"token punctuation\">(</span>lib<span class=\"token punctuation\">,</span> </span><span class=\"token string\">\"hal.lib\"</span><span class=\"token expression\"><span class=\"token punctuation\">)</span></span></span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token comment\">// 在全局变量 g_hPort 中保存通信端口的句柄；</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token keyword\">extern</span> HANDLE g_hPort<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token comment\">// 定义微过滤器的名字和通信端口的名字。 注意： 必须是宽字符的。</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">NPMINI_NAME</span>            <span class=\"token expression\">L</span><span class=\"token string\">\"NPminifilter\"</span></span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">NPMINI_PORT_NAME</span>       <span class=\"token expression\">L</span><span class=\"token string\">\"\\\\NPMiniPort\"</span></span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre></pre></td></tr><tr><td data-num=\"20\"></td><td><pre><span class=\"token comment\">// DLL 的编程规范， 声明导出函数</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre><span class=\"token function\">__declspec</span><span class=\"token punctuation\">(</span>dllexport<span class=\"token punctuation\">)</span>\t<span class=\"token keyword\">int</span> <span class=\"token function\">InitialCommunicationPort</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">void</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre><span class=\"token function\">__declspec</span><span class=\"token punctuation\">(</span>dllexport<span class=\"token punctuation\">)</span>   <span class=\"token keyword\">int</span> <span class=\"token function\">NPSendMessage</span><span class=\"token punctuation\">(</span>PVOID InputBuffer<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre></pre></td></tr><tr><td data-num=\"24\"></td><td><pre><span class=\"token comment\">// 自定义的数据结构</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre><span class=\"token keyword\">typedef</span> <span class=\"token keyword\">enum</span> <span class=\"token class-name\">_NPMINI_COMMAND</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>    ENUM_PASS <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>    ENUM_BLOCK</pre></td></tr><tr><td data-num=\"28\"></td><td><pre><span class=\"token punctuation\">&#125;</span> NPMINI_COMMAND<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre></pre></td></tr><tr><td data-num=\"30\"></td><td><pre><span class=\"token keyword\">typedef</span> <span class=\"token keyword\">struct</span> <span class=\"token class-name\">_COMMAND_MESSAGE</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>    <span class=\"token comment\">// 储存列举 NPMINI_COMMAND 命令的结构</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>    NPMINI_COMMAND \tCommand<span class=\"token punctuation\">;</span>  </pre></td></tr><tr><td data-num=\"33\"></td><td><pre><span class=\"token punctuation\">&#125;</span> COMMAND_MESSAGE<span class=\"token punctuation\">,</span> <span class=\"token operator\">*</span>PCOMMAND_MESSAGE<span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>接下来开始编写 DLL 程序的进入点：</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">\"NPdll.h\"</span></span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>HANDLE g_hPort <span class=\"token operator\">=</span> INVALID_HANDLE_VALUE<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">ifdef</span> <span class=\"token expression\">_MANAGED</span></span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">pragma</span> <span class=\"token expression\"><span class=\"token function\">managed</span><span class=\"token punctuation\">(</span>push<span class=\"token punctuation\">,</span> off<span class=\"token punctuation\">)</span></span></span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">endif</span></span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>BOOL APIENTRY <span class=\"token function\">DllMain</span><span class=\"token punctuation\">(</span> HMODULE hModule<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>                       DWORD  ul_reason_for_call<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>                       LPVOID lpReserved</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>\t\t\t\t\t <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>\t<span class=\"token keyword\">switch</span> <span class=\"token punctuation\">(</span>ul_reason_for_call<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>\t<span class=\"token keyword\">case</span> DLL_PROCESS_ATTACH<span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>\t\t<span class=\"token function\">InitialCommunicationPort</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>\t<span class=\"token keyword\">case</span> DLL_THREAD_ATTACH<span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>\t<span class=\"token keyword\">case</span> DLL_THREAD_DETACH<span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>\t<span class=\"token keyword\">case</span> DLL_PROCESS_DETACH<span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>\t\t<span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>    <span class=\"token keyword\">return</span> TRUE<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre></pre></td></tr><tr><td data-num=\"26\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">ifdef</span> <span class=\"token expression\">_MANAGED</span></span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">pragma</span> <span class=\"token expression\"><span class=\"token function\">managed</span><span class=\"token punctuation\">(</span>pop<span class=\"token punctuation\">)</span></span></span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">endif</span></span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre></pre></td></tr><tr><td data-num=\"30\"></td><td><pre><span class=\"token keyword\">int</span> <span class=\"token function\">InitialCommunicationPort</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">void</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>    DWORD hResult <span class=\"token operator\">=</span> <span class=\"token function\">FilterConnectCommunicationPort</span><span class=\"token punctuation\">(</span> </pre></td></tr><tr><td data-num=\"33\"></td><td><pre>\t\tNPMINI_PORT_NAME<span class=\"token punctuation\">,</span>   <span class=\"token comment\">// 通信端口名称</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>\t\t<span class=\"token number\">0</span><span class=\"token punctuation\">,</span> </pre></td></tr><tr><td data-num=\"35\"></td><td><pre>\t\t<span class=\"token constant\">NULL</span><span class=\"token punctuation\">,</span> </pre></td></tr><tr><td data-num=\"36\"></td><td><pre>\t\t<span class=\"token number\">0</span><span class=\"token punctuation\">,</span> </pre></td></tr><tr><td data-num=\"37\"></td><td><pre>\t\t<span class=\"token constant\">NULL</span><span class=\"token punctuation\">,</span> </pre></td></tr><tr><td data-num=\"38\"></td><td><pre>\t\t<span class=\"token operator\">&amp;</span>g_hPort <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>     <span class=\"token comment\">// 通信端口句柄</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>hResult <span class=\"token operator\">!=</span> S_OK<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>\t\t<span class=\"token keyword\">return</span> hResult<span class=\"token punctuation\">;</span> <span class=\"token comment\">// 当连接失败时返回错误信息</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>\t<span class=\"token keyword\">return</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre></pre></td></tr><tr><td data-num=\"46\"></td><td><pre><span class=\"token comment\">// 传送数据函数</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre><span class=\"token keyword\">int</span> <span class=\"token function\">NPSendMessage</span><span class=\"token punctuation\">(</span>PVOID InputBuffer<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>\tDWORD bytesReturned <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>    <span class=\"token comment\">// 返回的结构大小</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>\tDWORD hResult <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>          <span class=\"token comment\">// 返回值</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>\tPCOMMAND_MESSAGE commandMessage <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>PCOMMAND_MESSAGE<span class=\"token punctuation\">)</span> InputBuffer<span class=\"token punctuation\">;</span>\t</pre></td></tr><tr><td data-num=\"52\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"53\"></td><td><pre>    hResult <span class=\"token operator\">=</span> <span class=\"token function\">FilterSendMessage</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre>\t\tg_hPort<span class=\"token punctuation\">,</span>                    <span class=\"token comment\">// 通信端口句柄</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre>        commandMessage<span class=\"token punctuation\">,</span>             <span class=\"token comment\">// 传入结构</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>        <span class=\"token keyword\">sizeof</span><span class=\"token punctuation\">(</span>COMMAND_MESSAGE<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>    <span class=\"token comment\">// 传入结构长度</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre>        <span class=\"token constant\">NULL</span><span class=\"token punctuation\">,</span>                       <span class=\"token comment\">// 传入货返回结构</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre>        <span class=\"token constant\">NULL</span><span class=\"token punctuation\">,</span>                       <span class=\"token comment\">// 传入结构</span></pre></td></tr><tr><td data-num=\"59\"></td><td><pre>        <span class=\"token operator\">&amp;</span>bytesReturned <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre></pre></td></tr><tr><td data-num=\"61\"></td><td><pre>\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>hResult <span class=\"token operator\">!=</span> S_OK<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"62\"></td><td><pre>\t\t<span class=\"token keyword\">return</span> hResult<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"63\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"64\"></td><td><pre>\t<span class=\"token keyword\">return</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"65\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>当载入 DLL 时（DLL_PROCESS_ATTACH） 会调用 <code>InitialCommunicationPort</code> ， 这个调用主要是为了初始化通信端口， 以便后面的函数可以调用这个接口的 API。</p>\n<p>当调用到 <code>NPSendMessage</code>  时，传入的参数也需要是一个 <code>COMMAND_MESSAGE</code>  结构的指针， 当传送成功时返回 <code>S_OK</code> ， 失败时可根据返回值 <code>hResult</code>  得知错误代码。</p>\n<h2 id=\"minifilter的安装与加载\"><a class=\"anchor\" href=\"#minifilter的安装与加载\">#</a> Minifilter 的安装与加载</h2>\n<p>安装驱动的方法有许多种， 可以通过函数注册或用 INF 文件向系统注册驱动。</p>\n<p>接下来学习有关安装 Minifilter 驱动的方法， 在安装驱动时， 使用 INF 的方式来进行安装。</p>\n<h3 id=\"安装minifilter的inf文件\"><a class=\"anchor\" href=\"#安装minifilter的inf文件\">#</a> 安装 Minifilter 的 INF 文件</h3>\n<p><code>inf</code>  文件是一个暗转信息的配置文件，指明了安装的  <code>.sys</code>  文件路径，、安装到哪个位置、以及写到注册表中的何种位置。</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>Version<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>Signature   <span class=\"token operator\">=</span> <span class=\"token string\">\"$Windows NT$\"</span>     </pre></td></tr><tr><td data-num=\"3\"></td><td><pre>Class       <span class=\"token operator\">=</span> <span class=\"token string\">\"ActivityMonitor\"</span>  <span class=\"token punctuation\">;</span>指明了驱动的分组<span class=\"token punctuation\">,</span>必须指定<span class=\"token punctuation\">.</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>ClassGuid   <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span>b86dff51<span class=\"token operator\">-</span>a31e<span class=\"token operator\">-</span><span class=\"token number\">4</span>bac<span class=\"token operator\">-</span>b3cf<span class=\"token operator\">-</span>e8cfe75c9fc2<span class=\"token punctuation\">&#125;</span>  <span class=\"token punctuation\">;</span>GUID 每个分组都有固定的GUID</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>Provider    <span class=\"token operator\">=</span> <span class=\"token operator\">%</span>Msft<span class=\"token operator\">%</span> <span class=\"token punctuation\">;</span>变量值 从STRING节中可以看到驱动提供者的名称 </pre></td></tr><tr><td data-num=\"6\"></td><td><pre>DriverVer   <span class=\"token operator\">=</span> <span class=\"token number\">06</span><span class=\"token operator\">/</span><span class=\"token number\">16</span><span class=\"token operator\">/</span><span class=\"token number\">2007</span><span class=\"token punctuation\">,</span><span class=\"token number\">1.0</span><span class=\"token punctuation\">.</span><span class=\"token number\">0.1</span> <span class=\"token punctuation\">;</span>版本号</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>CatalogFile <span class=\"token operator\">=</span> passthrough<span class=\"token punctuation\">.</span>cat    <span class=\"token punctuation\">;</span>inf对应的cat 文件 可以不需要</pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token punctuation\">[</span>DestinationDirs<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>DefaultDestDir          <span class=\"token operator\">=</span> <span class=\"token number\">12</span>    <span class=\"token punctuation\">;</span>告诉我们驱动拷贝到哪里 <span class=\"token number\">12</span>代表拷贝到<span class=\"token operator\">%</span>windir<span class=\"token operator\">%</span>\\system32\\drivers</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>MiniFilter<span class=\"token punctuation\">.</span>DriverFiles  <span class=\"token operator\">=</span> <span class=\"token number\">12</span>   </pre></td></tr><tr><td data-num=\"13\"></td><td><pre></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token punctuation\">;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token punctuation\">;</span><span class=\"token punctuation\">;</span> Default install sections</pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token punctuation\">;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre></pre></td></tr><tr><td data-num=\"18\"></td><td><pre><span class=\"token punctuation\">[</span>DefaultInstall<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>OptionDesc          <span class=\"token operator\">=</span> <span class=\"token operator\">%</span>ServiceDescription<span class=\"token operator\">%</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>CopyFiles           <span class=\"token operator\">=</span> MiniFilter<span class=\"token punctuation\">.</span>DriverFiles</pre></td></tr><tr><td data-num=\"21\"></td><td><pre></pre></td></tr><tr><td data-num=\"22\"></td><td><pre><span class=\"token punctuation\">[</span>DefaultInstall<span class=\"token punctuation\">.</span>Services<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>AddService          <span class=\"token operator\">=</span> <span class=\"token operator\">%</span>ServiceName<span class=\"token operator\">%</span><span class=\"token punctuation\">,</span><span class=\"token punctuation\">,</span>MiniFilter<span class=\"token punctuation\">.</span>Service</pre></td></tr><tr><td data-num=\"24\"></td><td><pre></pre></td></tr><tr><td data-num=\"25\"></td><td><pre><span class=\"token punctuation\">;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre><span class=\"token punctuation\">;</span><span class=\"token punctuation\">;</span> Default uninstall sections</pre></td></tr><tr><td data-num=\"27\"></td><td><pre><span class=\"token punctuation\">;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre></pre></td></tr><tr><td data-num=\"29\"></td><td><pre><span class=\"token punctuation\">[</span>DefaultUninstall<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>DelFiles   <span class=\"token operator\">=</span> MiniFilter<span class=\"token punctuation\">.</span>DriverFiles</pre></td></tr><tr><td data-num=\"31\"></td><td><pre></pre></td></tr><tr><td data-num=\"32\"></td><td><pre><span class=\"token punctuation\">[</span>DefaultUninstall<span class=\"token punctuation\">.</span>Services<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>DelService <span class=\"token operator\">=</span> <span class=\"token operator\">%</span>ServiceName<span class=\"token operator\">%</span><span class=\"token punctuation\">,</span><span class=\"token number\">0x200</span>      <span class=\"token punctuation\">;</span>标识服务停止后才删除</pre></td></tr><tr><td data-num=\"34\"></td><td><pre></pre></td></tr><tr><td data-num=\"35\"></td><td><pre><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre><span class=\"token punctuation\">;</span> Services Section</pre></td></tr><tr><td data-num=\"37\"></td><td><pre><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre></pre></td></tr><tr><td data-num=\"39\"></td><td><pre><span class=\"token punctuation\">[</span>MiniFilter<span class=\"token punctuation\">.</span>Service<span class=\"token punctuation\">]</span>                 <span class=\"token punctuation\">;</span>服务的一些信息</pre></td></tr><tr><td data-num=\"40\"></td><td><pre>DisplayName      <span class=\"token operator\">=</span> <span class=\"token operator\">%</span>ServiceName<span class=\"token operator\">%</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>Description      <span class=\"token operator\">=</span> <span class=\"token operator\">%</span>ServiceDescription<span class=\"token operator\">%</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>ServiceBinary    <span class=\"token operator\">=</span> <span class=\"token operator\">%</span><span class=\"token number\">12</span><span class=\"token operator\">%</span>\\<span class=\"token operator\">%</span>DriverName<span class=\"token operator\">%</span><span class=\"token punctuation\">.</span>sys        <span class=\"token punctuation\">;</span><span class=\"token operator\">%</span>windir<span class=\"token operator\">%</span>\\system32\\drivers\\</pre></td></tr><tr><td data-num=\"43\"></td><td><pre>Dependencies     <span class=\"token operator\">=</span> <span class=\"token string\">\"FltMgr\"</span>                     <span class=\"token punctuation\">;</span>服务的依赖</pre></td></tr><tr><td data-num=\"44\"></td><td><pre>ServiceType      <span class=\"token operator\">=</span> <span class=\"token number\">2</span>                            <span class=\"token punctuation\">;</span>SERVICE_FILE_SYSTEM_DRIVER</pre></td></tr><tr><td data-num=\"45\"></td><td><pre>StartType        <span class=\"token operator\">=</span> <span class=\"token number\">3</span>                            <span class=\"token punctuation\">;</span>SERVICE_DEMAND_START</pre></td></tr><tr><td data-num=\"46\"></td><td><pre>ErrorControl     <span class=\"token operator\">=</span> <span class=\"token number\">1</span>                            <span class=\"token punctuation\">;</span>SERVICE_ERROR_NORMAL</pre></td></tr><tr><td data-num=\"47\"></td><td><pre>LoadOrderGroup   <span class=\"token operator\">=</span> <span class=\"token string\">\"FSFilter Activity Monitor\"</span>  <span class=\"token punctuation\">;</span>文件过滤分组</pre></td></tr><tr><td data-num=\"48\"></td><td><pre>AddReg           <span class=\"token operator\">=</span> MiniFilter<span class=\"token punctuation\">.</span>AddRegistry       <span class=\"token punctuation\">;</span>文件过滤注册表需要添加的高度值等信息</pre></td></tr><tr><td data-num=\"49\"></td><td><pre></pre></td></tr><tr><td data-num=\"50\"></td><td><pre><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre><span class=\"token punctuation\">;</span> Registry Modifications</pre></td></tr><tr><td data-num=\"52\"></td><td><pre><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre></pre></td></tr><tr><td data-num=\"54\"></td><td><pre><span class=\"token punctuation\">[</span>MiniFilter<span class=\"token punctuation\">.</span>AddRegistry<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre>HKR<span class=\"token punctuation\">,</span><span class=\"token punctuation\">,</span><span class=\"token string\">\"DebugFlags\"</span><span class=\"token punctuation\">,</span><span class=\"token number\">0x00010001</span> <span class=\"token punctuation\">,</span><span class=\"token number\">0x0</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>HKR<span class=\"token punctuation\">,</span><span class=\"token string\">\"Instances\"</span><span class=\"token punctuation\">,</span><span class=\"token string\">\"DefaultInstance\"</span><span class=\"token punctuation\">,</span><span class=\"token number\">0x00000000</span><span class=\"token punctuation\">,</span><span class=\"token operator\">%</span>DefaultInstance<span class=\"token operator\">%</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre>HKR<span class=\"token punctuation\">,</span><span class=\"token string\">\"Instances\\\"%Instance1.Name%,\"</span>Altitude\"<span class=\"token punctuation\">,</span><span class=\"token number\">0x00000000</span><span class=\"token punctuation\">,</span><span class=\"token operator\">%</span>Instance1<span class=\"token punctuation\">.</span>Altitude<span class=\"token operator\">%</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre>HKR<span class=\"token punctuation\">,</span><span class=\"token string\">\"Instances\\\"%Instance1.Name%,\"</span>Flags\"<span class=\"token punctuation\">,</span><span class=\"token number\">0x00010001</span><span class=\"token punctuation\">,</span><span class=\"token operator\">%</span>Instance1<span class=\"token punctuation\">.</span>Flags<span class=\"token operator\">%</span></pre></td></tr><tr><td data-num=\"59\"></td><td><pre></pre></td></tr><tr><td data-num=\"60\"></td><td><pre><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"61\"></td><td><pre><span class=\"token punctuation\">;</span> Copy Files</pre></td></tr><tr><td data-num=\"62\"></td><td><pre><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"63\"></td><td><pre></pre></td></tr><tr><td data-num=\"64\"></td><td><pre><span class=\"token punctuation\">[</span>MiniFilter<span class=\"token punctuation\">.</span>DriverFiles<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"65\"></td><td><pre><span class=\"token operator\">%</span>DriverName<span class=\"token operator\">%</span><span class=\"token punctuation\">.</span>sys</pre></td></tr><tr><td data-num=\"66\"></td><td><pre></pre></td></tr><tr><td data-num=\"67\"></td><td><pre><span class=\"token punctuation\">[</span>SourceDisksFiles<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"68\"></td><td><pre>passthrough<span class=\"token punctuation\">.</span>sys <span class=\"token operator\">=</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"69\"></td><td><pre></pre></td></tr><tr><td data-num=\"70\"></td><td><pre><span class=\"token punctuation\">[</span>SourceDisksNames<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"71\"></td><td><pre><span class=\"token number\">1</span> <span class=\"token operator\">=</span> <span class=\"token operator\">%</span>DiskId1<span class=\"token operator\">%</span><span class=\"token punctuation\">,</span><span class=\"token punctuation\">,</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"72\"></td><td><pre></pre></td></tr><tr><td data-num=\"73\"></td><td><pre><span class=\"token punctuation\">;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"74\"></td><td><pre><span class=\"token punctuation\">;</span><span class=\"token punctuation\">;</span> String Section</pre></td></tr><tr><td data-num=\"75\"></td><td><pre><span class=\"token punctuation\">;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"76\"></td><td><pre></pre></td></tr><tr><td data-num=\"77\"></td><td><pre><span class=\"token punctuation\">[</span>Strings<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"78\"></td><td><pre>Msft                    <span class=\"token operator\">=</span> <span class=\"token string\">\"Microsoft Corporation\"</span></pre></td></tr><tr><td data-num=\"79\"></td><td><pre>ServiceDescription      <span class=\"token operator\">=</span> <span class=\"token string\">\"NPminifilter Mini-Filter Driver\"</span></pre></td></tr><tr><td data-num=\"80\"></td><td><pre>ServiceName             <span class=\"token operator\">=</span> <span class=\"token string\">\"NPminifilter\"</span></pre></td></tr><tr><td data-num=\"81\"></td><td><pre>DriverName              <span class=\"token operator\">=</span> <span class=\"token string\">\"NPminifilter\"</span></pre></td></tr><tr><td data-num=\"82\"></td><td><pre>DiskId1                 <span class=\"token operator\">=</span> <span class=\"token string\">\"NPminifilter Device Installation Disk\"</span></pre></td></tr><tr><td data-num=\"83\"></td><td><pre></pre></td></tr><tr><td data-num=\"84\"></td><td><pre><span class=\"token punctuation\">;</span>Instances specific information<span class=\"token punctuation\">.</span></pre></td></tr><tr><td data-num=\"85\"></td><td><pre>DefaultInstance         <span class=\"token operator\">=</span> <span class=\"token string\">\"NPminifilter Instance\"</span></pre></td></tr><tr><td data-num=\"86\"></td><td><pre>Instance1<span class=\"token punctuation\">.</span>Name          <span class=\"token operator\">=</span> <span class=\"token string\">\"NPminifilter Instance\"</span></pre></td></tr><tr><td data-num=\"87\"></td><td><pre>Instance1<span class=\"token punctuation\">.</span>Altitude      <span class=\"token operator\">=</span> <span class=\"token string\">\"370030\"</span></pre></td></tr><tr><td data-num=\"88\"></td><td><pre>Instance1<span class=\"token punctuation\">.</span>Flags         <span class=\"token operator\">=</span> <span class=\"token number\">0x0</span>              <span class=\"token punctuation\">;</span> Allow all attachments</pre></td></tr></table></figure><p>接下来先简单了解一下</p>\n<p><code>StartType</code>  被称为启动类型。  <code>StartType</code>  为 <code>3</code>  即 <code>DEMAND_START</code> ，<em>表示当有需求加载时才启动此驱动的功能</em>；<br />\n <code>StartType</code>  为 <code>0</code>  即 <code>BOOT_START</code> ， 表示计算机开机启动时就自动加载此驱动的功能。</p>\n<p>根据上面的 INF 文件可以看出， 此驱动文件是依附于 <code>FltMgr</code>  服务的。</p>\n<p><code>Altitude</code>  是微过滤器的层级码。 层级码决定过滤层次的上下。</p>\n<p><em>根据微软的文档， 微过滤器的层级码范围是多个以数字标识的范围区段（例如： 20000~429999） ， 正式的商业软件的层级码是需要向微软申请注册的</em>。 例如， 许多防毒软件都要向微软申请一个特定的层级码， 不过我们在测试时可以先给出这个范围内的一个值， 这里先定义为 370030， 也就是本章示例的微过滤器在过滤层中的位置。</p>\n<p>编写这个 INF 文件后， 测试时只要跟 <code>Minifilter.sys</code>  放在同一个目录下， 通过鼠标右键选择 INF 菜单 “安装”， 便可以成功将 Minifilter 安装到系统目录下， 安装完毕也可以去 <code>%windir%\\system32\\drivers</code>  下查看这个文件是否存在。 另外， 也可以使用 <code>OSR driverloader</code>  来检查已经安装的 Minifilter 在系统上的 <code>Load Group</code>  顺序 (？这个工具是如何获取 Load Group 的？自己也实现一个)</p>\n<p>修改上面的 <code>[Strings]</code>  节就可以成为不同的驱动程序的 INF 文件。 比如本书的例子， 服务名为 <code>NPminifilter</code> ， 驱动名为 <code>NPMinifilter.sys</code> ， 那么把这一节改为：</p>\n<figure class=\"highlight raw\"><figcaption data-lang=\"\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>[Strings]</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>Msft                    &#x3D; &quot;Microsoft Corporation&quot;</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>ServiceDescription      &#x3D; &quot;NPminifilter Mini-Filter Driver&quot;</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>ServiceName             &#x3D; &quot;NPminifilter&quot;</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>DriverName              &#x3D; &quot;NPminifilter&quot;</pre></td></tr></table></figure><p>也就是说修改此节中的这些部分就可以了。</p>\n<h1 id=\"思维扩展\"><a class=\"anchor\" href=\"#思维扩展\">#</a> 思维扩展</h1>\n<ol>\n<li>INF 安装与普通的驱动安装方法有什么区别？</li>\n<li>模仿写一个类似的：<span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cuNTJwb2ppZS5jbi90aHJlYWQtMTMxNDA5Ni0xLTEuaHRtbA==\">https://www.52pojie.cn/thread-1314096-1-1.html</span></li>\n<li>了解 <code>OSR driverloader</code>  是如何获取系统中的 <code>Load Group</code> 。</li>\n</ol>\n",
            "tags": [
                "Minifilter"
            ]
        }
    ]
}