{
    "version": "https://jsonfeed.org/version/1",
    "title": "Or0kit • All posts by \"idt\" tag",
    "description": "临渊羡鱼，不如退而结网",
    "home_page_url": "https://Or0kit.github.io",
    "items": [
        {
            "id": "https://or0kit.github.io/Bin/Core/WindowsXp/Protect-Mode/%E4%BF%9D%E6%8A%A4%E6%A8%A1%E5%BC%8F-%E9%99%B7%E9%98%B1%E9%97%A8/",
            "url": "https://or0kit.github.io/Bin/Core/WindowsXp/Protect-Mode/%E4%BF%9D%E6%8A%A4%E6%A8%A1%E5%BC%8F-%E9%99%B7%E9%98%B1%E9%97%A8/",
            "title": "保护模式-陷阱门",
            "date_published": "2021-08-13T06:40:28.000Z",
            "content_html": "<h1 id=\"前言\"><a class=\"anchor\" href=\"#前言\">#</a> 前言</h1>\n<p>Windows 使用了中断门，用于系统调用和调试（比如调试断点）</p>\n<p>IF 位，是标志寄存器 EFLEAG，下标为 9 的位置。</p>\n<p>中断门和陷阱门都不可以传递参数，可能它们的作用被 CPU 制造商规定为辅助作用，但是操作系统怎么使用，就看操作系统的设计者怎么想的。</p>\n<p>它们的段描述符区别在于 TYPE 域，且都是系统段描述符</p>\n<p>这些都是 CPU 层面的概念，操作系统只是使用，然后根据硬件返回出来的值（在硬件方面可能就是电压表示的二进制）进行判断对与错，然后操作系统会提示用户正确或错误。</p>\n<p>转自<span class=\"exturl\" data-url=\"aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQxOTg4NDQ4L2FydGljbGUvZGV0YWlscy8xMDI1OTk5NjE=\"> https://blog.csdn.net/qq_41988448/article/details/102599961</span> 的评论</p>\n<h2 id=\"陷阱门与中断门的区别\"><a class=\"anchor\" href=\"#陷阱门与中断门的区别\">#</a> 陷阱门与中断门的区别</h2>\n<p>中断门执行时，会将 IF 标志位清零，但陷阱门不会</p>\n<p>IF=0 时：程序不再接收可屏蔽中断</p>\n<p>可屏蔽中断：比如程序正在运行时，我们通过键盘敲击了锁屏的快捷键，若 IF 位为 1，CPU 就能够接收到我们敲击键盘的指令并锁屏</p>\n<p>可屏蔽中断：<br />\n简述：保存断点入栈，响应经中断控制器 8259 优先级判断后的中断请求，恢复断点。<br />\nI/O 设备发出的所有中断 (IRQ) 都可以产生可屏蔽中断，受标志位 IF 的影响，根据中断循序标志的设置来判断 CPU 是否响应中断请求。</p>\n<blockquote>\n<p>接口发出中断请求<br />\n当前指令执行完后，CPU 响应中断<br />\n中断类型号 N 送 CPU<br />\n 当前的 EFR CS HE EIP 推入栈<br />\n清除 IF (中断允许标志位，IF=0，禁止 CPU 响应外部中断请求，IF=1，允许响应) 和 TF（跟踪标志，也称单步执行，CPU 按跟踪方式执行）<br />\n由中断类型号，查中断向量表获得中断服务子程序的入口地址<br />\n CPU 执行中断子程序<br />\n开中断<br />\n IRET 指令使 EIP CS HE EFR 弹出栈 ，返回被中断的源程序</p>\n</blockquote>\n<p>不可屏蔽中断：不可阻止的中断请求。如： 当突然断电，CPU 不是立马死掉，CPU 内部有一个电容，断电的时候，还会运行一会儿，用于处理后续工作，这个是不可屏蔽中断。</p>\n<h2 id=\"trap-gate-descriptor\"><a class=\"anchor\" href=\"#trap-gate-descriptor\">#</a> Trap-Gate-Descriptor</h2>\n<p><img data-src=\"image001.png\" alt=\"\" /></p>\n<h2 id=\"实践\"><a class=\"anchor\" href=\"#实践\">#</a> 实践</h2>\n<p>知道了理论，开始实践。<br />\n和中断门一样的流程，只是我们构造的描述符有一点不同： <code>0040EF00`00081020</code>   把中断门的 <code>EE</code>  改为了 <code>EF</code></p>\n<p>代码还是以前的代码，结果也是一样的。<br />\n不再复写一份了（懒）。</p>\n<h1 id=\"reference\"><a class=\"anchor\" href=\"#reference\">#</a> Reference</h1>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM1NDI1MjQzL2FydGljbGUvZGV0YWlscy84MzY1NzIwMw==\">https://blog.csdn.net/qq_35425243/article/details/83657203</span></p>\n",
            "tags": [
                "IDT",
                "提权",
                "陷阱门描述符"
            ]
        },
        {
            "id": "https://or0kit.github.io/Bin/Core/WindowsXp/Protect-Mode/%E4%BF%9D%E6%8A%A4%E6%A8%A1%E5%BC%8F-%E4%B8%AD%E6%96%AD%E9%97%A8/",
            "url": "https://or0kit.github.io/Bin/Core/WindowsXp/Protect-Mode/%E4%BF%9D%E6%8A%A4%E6%A8%A1%E5%BC%8F-%E4%B8%AD%E6%96%AD%E9%97%A8/",
            "title": "保护模式-中断门",
            "date_published": "2021-08-13T06:40:15.000Z",
            "content_html": "<h1 id=\"中断门\"><a class=\"anchor\" href=\"#中断门\">#</a> 中断门</h1>\n<h2 id=\"中断门的作用\"><a class=\"anchor\" href=\"#中断门的作用\">#</a> 中断门的作用</h2>\n<p>先前学习的调用门在实际的 Windows 中并没有被使用，只是操作系统提供了调用门描述符给开发人员使用。相比之下，Windows 使用了中断门，用于：</p>\n<blockquote>\n<p>系统调用（老的 CPU 通过中断门进入 RING（内核）0 层；新的 CPU 使用快速调用）<br />\n调试（常见的 INT3 对应硬编码为 0xCC）</p>\n</blockquote>\n<h2 id=\"中断门执行流程\"><a class=\"anchor\" href=\"#中断门执行流程\">#</a> 中断门执行流程</h2>\n<p>【重点】</p>\n<ul>\n<li>根据 INT XXX 的值 查 IDT（中断描述符表），找到对应的段描述符 这个描述符是一个中断门描述符</li>\n<li>在中断门描述符中存储另一个代码段的选择子</li>\n<li>选择子指向的段 段.Base + 偏移地址 就是真正要执行的地址</li>\n</ul>\n<h2 id=\"idt\"><a class=\"anchor\" href=\"#idt\">#</a> IDT</h2>\n<p>IDT 全称 Interrupt Descriptor Table（中断描述符表）, 同 GDT 一样，IDT 也是由一系列描述符组成的，每个<br />\n描述符占 8 个字节。但要注意的是，IDT 表中的第一个元素不是 NULL。</p>\n<p>IDT 中存储的段描述符都是<ins>系统段描述符</ins></p>\n<p>IDT 可以包含三种门描述符：①任务门描述符；②中断门描述符；③陷阱门描述符</p>\n<p>在 windbg 中查看 IDT 表的基址和长度:</p>\n<p>查看地址： <code>r idtr</code></p>\n<p>查看长度： <code>r idtl</code></p>\n<h2 id=\"中断门描述符\"><a class=\"anchor\" href=\"#中断门描述符\">#</a> 中断门描述符</h2>\n<p><img data-src=\"image001.png\" alt=\"\" /></p>\n<p>当一个段描述符是一个调用门描述符时，有以下特征：</p>\n<ul>\n<li>S 位为 0，表示该段描述符为系统段描述符（中断门描述符属于系统段描述符）</li>\n<li>Type 域为 1110，表示该段描述符为 32 位中断门</li>\n<li>低 16 位到 31 位存储一个段选择子，该段选择子才和代码真正要调用的地址相关</li>\n<li>真正要调用的地址 = 段选择子所指向的段.Base + 32 位的段中偏移 （段中偏移分为两部分：高位 31-16 位和低位 15-0 位）</li>\n<li>段.Base 默认为 0，故真正要调用的地址 = 32 位的段中偏移</li>\n</ul>\n<h2 id=\"调用门描述符和中断门描述符各部分的对比\"><a class=\"anchor\" href=\"#调用门描述符和中断门描述符各部分的对比\">#</a> 调用门描述符和中断门描述符各部分的对比</h2>\n<p><img data-src=\"image002.png\" alt=\"\" /></p>\n<p>可以发现中断门描述符和调用门描述符的结构基本一致，只在 Type 域和参数计数处不同（Type 域是描述符的类型标识；中断门不允许传参）</p>\n<h2 id=\"中断门堆栈变化\"><a class=\"anchor\" href=\"#中断门堆栈变化\">#</a> 中断门堆栈变化</h2>\n<p>使用调用门的方法是 CALL FAR，而使用中断门的方法是  <code>INT N</code> ，其中，N 表示中断门描述符在 IDT 表中的下标。</p>\n<p>和调用门一样，中断门也可以用来提权。不提权时， <code>INT N</code>  会压栈 CS，EFLAG EIP；<br />\n提权时，会依次压栈 SS ESP EFLAG CS EIP。<br />\n需要用堆栈保存 EFLAG 是因为中断门会将 EFLAG 的 IF 位置 0。</p>\n<p><img data-src=\"image006.png\" alt=\"\" /></p>\n<h2 id=\"实践\"><a class=\"anchor\" href=\"#实践\">#</a> 实践</h2>\n<p>知道了理论，开始实践。</p>\n<ol>\n<li>构造 Interrupt Gate Descriptor</li>\n</ol>\n<p><code>0000 0000 0000 0000 1110 1110 0000 0000`0000 0000 0000 1000 0000 0000 0000 0000</code></p>\n<p>段内偏移还不确定，暂时置为 0。<br />\n十六进制为 <code>0000ee00`00080000</code></p>\n<ol start=\"2\">\n<li>测试代码</li>\n</ol>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span><span class=\"token string\">&lt;stdio.h></span></span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span><span class=\"token string\">&lt;windows.h></span></span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>DWORD dwH2GValue<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token function\">__declspec</span><span class=\"token punctuation\">(</span>naked<span class=\"token punctuation\">)</span> <span class=\"token keyword\">void</span> <span class=\"token function\">GetH2GValue</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>\t__asm</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\t\tpushad</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>\t\tpushfd</pre></td></tr><tr><td data-num=\"12\"></td><td><pre></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    <span class=\"token comment\">// 读高 2G 内存</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>\t\tmov eax<span class=\"token punctuation\">,</span><span class=\"token punctuation\">[</span><span class=\"token number\">0x8003f00c</span><span class=\"token punctuation\">]</span>  </pre></td></tr><tr><td data-num=\"15\"></td><td><pre>\t\tmov ebx<span class=\"token punctuation\">,</span><span class=\"token punctuation\">[</span>eax<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>\t\tmov dwH2GValue<span class=\"token punctuation\">,</span>ebx</pre></td></tr><tr><td data-num=\"17\"></td><td><pre></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>\t\tpopfd</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>\t\tpopad</pre></td></tr><tr><td data-num=\"20\"></td><td><pre></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>\t\tiretd</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre></pre></td></tr><tr><td data-num=\"25\"></td><td><pre><span class=\"token keyword\">void</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>\t__asm</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>\t\tINT <span class=\"token number\">0x20</span>      <span class=\"token comment\">// 暂时有疑问，选这个索引是因为有的博客说这个地址没有用上。可是我在 windbg 中看到这个地址也是有值的。</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>\t<span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"dwH2GValue:%#X\"</span><span class=\"token punctuation\">,</span>dwH2GValue<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>VC 中反汇编查看</p>\n<p><img data-src=\"image003.png\" alt=\"\" /></p>\n<p>我们要跳转的地址为 <code>0x00401020</code></p>\n<p>确定 Interrupt Gate Descriptor 为： <code>0040ee00`00081020</code></p>\n<ol start=\"3\">\n<li>在 windbg 中赋值</li>\n</ol>\n<p>直接在 IDT 表中修改索引为 0x20 的中断门描述符</p>\n<p><code>eq 8003f500 0040ee00`00081020</code></p>\n<ol start=\"4\">\n<li>在调试机中运行代码</li>\n</ol>\n<p>结果：</p>\n<p><img data-src=\"image004.png\" alt=\"\" /></p>\n<p>在 windbg 中确认打印数值无误。</p>\n<p><img data-src=\"image005.png\" alt=\"\" /></p>\n<h1 id=\"reference\"><a class=\"anchor\" href=\"#reference\">#</a> Reference</h1>\n<p>滴水课件<br />\n<span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cuNTJwb2ppZS5jbi90aHJlYWQtMTQ1NTY4NC0xLTEuaHRtbA==\"> https://www.52pojie.cn/thread-1455684-1-1.html</span></p>\n",
            "tags": [
                "中断门描述符",
                "IDT",
                "提权"
            ]
        }
    ]
}