{
    "version": "https://jsonfeed.org/version/1",
    "title": "Or0kit • All posts by \"mmaddphysicalmemoryex\" tag",
    "description": "临渊羡鱼，不如退而结网",
    "home_page_url": "https://Or0kit.github.io",
    "items": [
        {
            "id": "https://or0kit.github.io/Bin/Core/WindowsXp/MemoryManagement/%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86-04%E7%89%A9%E7%90%86%E5%86%85%E5%AD%98%E7%9A%84%E7%AE%A1%E7%90%86/",
            "url": "https://or0kit.github.io/Bin/Core/WindowsXp/MemoryManagement/%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86-04%E7%89%A9%E7%90%86%E5%86%85%E5%AD%98%E7%9A%84%E7%AE%A1%E7%90%86/",
            "title": "内存管理-04物理内存的管理",
            "date_published": "2022-04-16T07:17:01.000Z",
            "content_html": "<h1 id=\"物理内存\"><a class=\"anchor\" href=\"#物理内存\">#</a> 物理内存</h1>\n<p>&lt;1&gt; 最大物理内存</p>\n<pre><code>10-10-12分页  最多识别物理内存为4GB\n\n2-9-9-12分页  最多识别物理内存为64GB\n</code></pre>\n<p>&lt;2&gt; 操作系统限制</p>\n<p>为什么在 xp 中，明明是 2-9-9-12 分页，单仍然无法超越 4GB 呢？</p>\n<p>具体可以分析  <code>MmAddPhysicalMemoryEx</code>  函数。存粹是操作系统限制。</p>\n<p>&lt;3&gt; 实际物理内存</p>\n<p><code>MmNumberOfPhysicalPages</code>  * 4 = 物理内存  (页为单位)</p>\n<h1 id=\"物理内存如何管理\"><a class=\"anchor\" href=\"#物理内存如何管理\">#</a> 物理内存如何管理</h1>\n<p>在 XP 上一个物理页的大小是 4096 BYTE = 0x1000 BYTE = 4 KB  = 4 * 1024B</p>\n<p>查看 XP 上的物理页：</p>\n<p><img data-src=\"image001.png\" alt=\"\" /></p>\n<p>对于物理内存，操作系统采用帧管理数据库的模式。<br />\n一个物理页就是一帧，被称之为帧数据库：</p>\n<p>其实就是数组，数组的指针： <code>_MMPFN* MmPfnDatabase</code>  而数组的长度是：  <code>MmNumberOfPhysicalPages</code></p>\n<p>而数组成员都是  <code>_MMPFN</code>  结构</p>\n<p>在 windbg 中查看：</p>\n<figure class=\"highlight raw\"><figcaption data-lang=\"\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>kd&gt; dt _MMPFN</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>nt!_MMPFN</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>   +0x000 u1               : __unnamed</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>   +0x004 PteAddress       : Ptr32 _MMPTE</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>   +0x008 u2               : __unnamed</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>   +0x00c u3               : __unnamed</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>   +0x010 OriginalPte      : _MMPTE</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>   +0x018 u4               : __unnamed</pre></td></tr></table></figure><p>在 xp 源码中查看：</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">typedef</span> <span class=\"token keyword\">struct</span> <span class=\"token class-name\">_MMPFN</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token keyword\">union</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>        PFN_NUMBER Flink<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>        WSLE_NUMBER WsIndex<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>        PKEVENT Event<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>        NTSTATUS ReadStatus<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>        SINGLE_LIST_ENTRY NextStackPfn<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span> u1<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    PMMPTE PteAddress<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    <span class=\"token keyword\">union</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>        PFN_NUMBER Blink<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>        ULONG_PTR ShareCount<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span> u2<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    <span class=\"token keyword\">union</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>        MMPFNENTRY e1<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>        <span class=\"token keyword\">struct</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>            USHORT ShortFlags<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>            USHORT ReferenceCount<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span> e2<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span> u3<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">if</span> <span class=\"token expression\"><span class=\"token function\">defined</span> <span class=\"token punctuation\">(</span>_WIN64<span class=\"token punctuation\">)</span></span></span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>    ULONG UsedPageTableEntries<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">endif</span></span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>    MMPTE OriginalPte<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>    <span class=\"token keyword\">union</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>        ULONG_PTR EntireFrame<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>        <span class=\"token keyword\">struct</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">if</span> <span class=\"token expression\"><span class=\"token function\">defined</span> <span class=\"token punctuation\">(</span>_WIN64<span class=\"token punctuation\">)</span></span></span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>            ULONG_PTR PteFrame<span class=\"token operator\">:</span> <span class=\"token number\">58</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">else</span></span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>            ULONG_PTR PteFrame<span class=\"token operator\">:</span> <span class=\"token number\">26</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">endif</span></span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>            ULONG_PTR InPageError <span class=\"token operator\">:</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>            ULONG_PTR VerifierAllocation <span class=\"token operator\">:</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>            ULONG_PTR AweAllocation <span class=\"token operator\">:</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>            ULONG_PTR LockCharged <span class=\"token operator\">:</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span>      <span class=\"token comment\">// maintained for DBG only</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>            ULONG_PTR KernelStack <span class=\"token operator\">:</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span>      <span class=\"token comment\">// only for valid (not trans) pages</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>            ULONG_PTR Reserved <span class=\"token operator\">:</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span> u4<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre></pre></td></tr><tr><td data-num=\"42\"></td><td><pre><span class=\"token punctuation\">&#125;</span> MMPFN<span class=\"token punctuation\">,</span> <span class=\"token operator\">*</span>PMMPFN<span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>可以发现这个结构体  <code>_MMPFN</code>  的大小是 0x1C。</p>\n<p>在 XP 中查看帧结构数组的基址：</p>\n<figure class=\"highlight raw\"><figcaption data-lang=\"\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>kd&gt; dd MmPfnDatabase l1</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>805630c8  80e00000</pre></td></tr></table></figure><p><code>80e00000+0x1C</code>  就是第二个物理页的帧结构数组，那么我们如何知道这个数组对应的物理页呢？</p>\n<p>这里操作系统的设计非常巧妙，帧结构数组的索引对应着相应的物理页，如果索引为  <code>0</code>  则对应的物理页地址为  <code>0 * 4kB</code>  ；如果索引为  <code>1</code>  则对应的物理页地址为  <code>1 * 4kB</code>  。</p>\n<h2 id=\"总结\"><a class=\"anchor\" href=\"#总结\">#</a> 总结：</h2>\n<p>物理页的数量是由  <code>MmNumberOfPhysicalPages</code>  决定的<br />\n物理页如何管理：每一个物理页都对应一个  <code>MMPFN</code>  的结构<br />\n如何通过帧数组找物理页和如何通过物理页找帧数组都已经知道了。</p>\n<h1 id=\"物理页的状态\"><a class=\"anchor\" href=\"#物理页的状态\">#</a> 物理页的状态</h1>\n<p>物理页有着不同的状态，正在被使用的和没有被使用的，又分为好多状态。</p>\n<p><code>_MMPFN</code>  结构体成员  <code>u3</code>  ：</p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">union</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    MMPFNENTRY e1<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token keyword\">struct</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>        USHORT ShortFlags<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>        USHORT ReferenceCount<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span> e2<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token punctuation\">&#125;</span> u3<span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>我们查看其成员  <code>e1</code>  的结构：</p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">typedef</span> <span class=\"token keyword\">struct</span> <span class=\"token class-name\">_MMPFNENTRY</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    ULONG Modified <span class=\"token operator\">:</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    ULONG ReadInProgress <span class=\"token operator\">:</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    ULONG WriteInProgress <span class=\"token operator\">:</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    ULONG PrototypePte<span class=\"token operator\">:</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    ULONG PageColor <span class=\"token operator\">:</span> <span class=\"token number\">3</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    ULONG ParityError <span class=\"token operator\">:</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    ULONG PageLocation <span class=\"token operator\">:</span> <span class=\"token number\">3</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    ULONG RemovalRequested <span class=\"token operator\">:</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    ULONG CacheAttribute <span class=\"token operator\">:</span> <span class=\"token number\">2</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    ULONG Rom <span class=\"token operator\">:</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    ULONG LockCharged <span class=\"token operator\">:</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    ULONG DontUse <span class=\"token operator\">:</span> <span class=\"token number\">16</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">//overlays USHORT for reference count field.</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token punctuation\">&#125;</span> MMPFNENTRY<span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>其中的  <code>ULONG PageLocation : 3;</code>  成员就决定了当前物理页处于什么状态。</p>\n<p>以下是没有被使用的几种状态：</p>\n<figure class=\"highlight raw\"><figcaption data-lang=\"\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>0：MmZeroedPageListHead</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>1：MmFreePageListHead</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>2：MmStandbyPageListHead</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>3：MmModifiedPageListHead</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>4：MmModifiedNoWritePageListHead</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>5：MmBadPageListHead</pre></td></tr></table></figure><h2 id=\"操作系统的6个链表\"><a class=\"anchor\" href=\"#操作系统的6个链表\">#</a> 操作系统的 6 个链表</h2>\n<p>&lt;1&gt; MmBadPageListHead<br />\n 坏链</p>\n<p>&lt;2&gt; MmZeroedPageListHead<br />\n 零化链表（是系统在空闲的时候进行零化的，不是程序自己清零的那种）</p>\n<p>&lt;3&gt; MmFreePageListHead<br />\n 空闲链表（物理页是周转使用的，刚被释放的物理页是没有清 0，系统空闲的时候有专门的线程从这个队列摘取物理页，加以清 0 后再挂入 MmZeroedPageListHead）</p>\n<p>&lt;4&gt; MmStandbyPageListHead<br />\n 备用链表（当系统内存不够的时候，操作系统会把物理内存中的数据交换到硬盘上，此时页面不是直接挂到空闲链表上去，而是挂到备用链表上，虽然我释放了，但里边的内容还是有意义的）</p>\n<p>&lt;5&gt; MmModifiedPageListHead</p>\n<p>&lt;6&gt; MmModifiedNoWritePageListHead</p>\n<p>具体可以参考 《Windows 内核原理与实现》</p>\n<p>我们看一下这些链表的结构：</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">typedef</span> <span class=\"token keyword\">struct</span> <span class=\"token class-name\">_MMPFNLIST</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    PFN_NUMBER Total<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    MMLISTS ListName<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    PFN_NUMBER Flink<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    PFN_NUMBER Blink<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">&#125;</span> MMPFNLIST<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>MMPFNLIST MmZeroedPageListHead <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>                    <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// Total</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>                    ZeroedPageList<span class=\"token punctuation\">,</span> <span class=\"token comment\">// ListName</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>                    MM_EMPTY_LIST<span class=\"token punctuation\">,</span> <span class=\"token comment\">//Flink</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>                    MM_EMPTY_LIST  <span class=\"token comment\">// Blink</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>                    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>MMPFNLIST MmFreePageListHead <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>                    <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// Total</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>                    FreePageList<span class=\"token punctuation\">,</span> <span class=\"token comment\">// ListName</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>                    MM_EMPTY_LIST<span class=\"token punctuation\">,</span> <span class=\"token comment\">//Flink</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>                    MM_EMPTY_LIST  <span class=\"token comment\">// Blink</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>                    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>MMPFNLIST MmStandbyPageListHead <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>                    <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// Total</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>                    StandbyPageList<span class=\"token punctuation\">,</span> <span class=\"token comment\">// ListName</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>                    MM_EMPTY_LIST<span class=\"token punctuation\">,</span> <span class=\"token comment\">//Flink</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>                    MM_EMPTY_LIST  <span class=\"token comment\">// Blink</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>                    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>MMPFNLIST MmModifiedPageListHead <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>                    <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// Total</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>                    ModifiedPageList<span class=\"token punctuation\">,</span> <span class=\"token comment\">// ListName</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>                    MM_EMPTY_LIST<span class=\"token punctuation\">,</span> <span class=\"token comment\">//Flink</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>                    MM_EMPTY_LIST  <span class=\"token comment\">// Blink</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>                    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>MMPFNLIST MmModifiedNoWritePageListHead <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>                    <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// Total</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>                    ModifiedNoWritePageList<span class=\"token punctuation\">,</span> <span class=\"token comment\">// ListName</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>                    MM_EMPTY_LIST<span class=\"token punctuation\">,</span> <span class=\"token comment\">//Flink</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>                    MM_EMPTY_LIST  <span class=\"token comment\">// Blink</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>                    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>MMPFNLIST MmBadPageListHead <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>                    <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// Total</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>                    BadPageList<span class=\"token punctuation\">,</span> <span class=\"token comment\">// ListName</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>                    MM_EMPTY_LIST<span class=\"token punctuation\">,</span> <span class=\"token comment\">//Flink</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>                    MM_EMPTY_LIST  <span class=\"token comment\">// Blink</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>                    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre></pre></td></tr><tr><td data-num=\"51\"></td><td><pre><span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre><span class=\"token comment\">// Note the ROM page listhead is deliberately not in the set</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre><span class=\"token comment\">// of MmPageLocationList ranges.</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre><span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>MMPFNLIST MmRomPageListHead <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre>                    <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// Total</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre>                    StandbyPageList<span class=\"token punctuation\">,</span> <span class=\"token comment\">// ListName</span></pre></td></tr><tr><td data-num=\"59\"></td><td><pre>                    MM_EMPTY_LIST<span class=\"token punctuation\">,</span> <span class=\"token comment\">//Flink</span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre>                    MM_EMPTY_LIST  <span class=\"token comment\">// Blink</span></pre></td></tr><tr><td data-num=\"61\"></td><td><pre>                    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"62\"></td><td><pre></pre></td></tr><tr><td data-num=\"63\"></td><td><pre></pre></td></tr><tr><td data-num=\"64\"></td><td><pre>PMMPFNLIST MmPageLocationList<span class=\"token punctuation\">[</span>NUMBER_OF_PAGE_LISTS<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"65\"></td><td><pre>                                      <span class=\"token operator\">&amp;</span>MmZeroedPageListHead<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"66\"></td><td><pre>                                      <span class=\"token operator\">&amp;</span>MmFreePageListHead<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"67\"></td><td><pre>                                      <span class=\"token operator\">&amp;</span>MmStandbyPageListHead<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"68\"></td><td><pre>                                      <span class=\"token operator\">&amp;</span>MmModifiedPageListHead<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"69\"></td><td><pre>                                      <span class=\"token operator\">&amp;</span>MmModifiedNoWritePageListHead<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"70\"></td><td><pre>                                      <span class=\"token operator\">&amp;</span>MmBadPageListHead<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"71\"></td><td><pre>                                      <span class=\"token constant\">NULL</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"72\"></td><td><pre>                                      <span class=\"token constant\">NULL</span> <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>那我们该如何把这些串起来呢？<br />\n先来看一张表：</p>\n<p><img data-src=\"image002.png\" alt=\"\" /></p>\n<p>理解这六个链表是如何和 MMPFN 结构串起来的。</p>\n<p>在 Windbg 中查看一下  <code>MmZeroedPageListHead</code>  链表：</p>\n<figure class=\"highlight raw\"><figcaption data-lang=\"\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>kd&gt; dd MmZeroedPageListHead l4</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>805528e8  0008ed15 00000000 0005a628 00039e07</pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>kd&gt; dt _MMPFNLIST 805528e8</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>nt!_MMPFNLIST</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>   +0x000 Total            : 0x8ed15</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>   +0x004 ListName         : 0 ( ZeroedPageList )</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>   +0x008 Flink            : 0x5a628</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>   +0x00c Blink            : 0x39e07</pre></td></tr></table></figure><figure class=\"highlight raw\"><figcaption data-lang=\"\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>kd&gt; dd 80e00000 + 0x5a628*0x1C</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>817e2c60  000363b8 c058a679 ffffffff 00003000</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>kd&gt; dd 80e00000 + 000363b8*0x1C</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>813ee820  000902a8 c0006d01 0005a628 00003000</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>kd&gt; dd 80e00000 + 000902a8*0x1C</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>81dc4a60  0007fdb8 c0710af1 000363b8 00003000</pre></td></tr></table></figure><h2 id=\"正在使用中的内存\"><a class=\"anchor\" href=\"#正在使用中的内存\">#</a> 正在使用中的内存</h2>\n<p>查看一个进程所占用的所有物理页：</p>\n<p>这里以  <code>DbgView</code>  为例:</p>\n<p>在 Windbg 中查看 <code>DbgView</code>  的  <code>EPROCESS</code>  结构体：</p>\n<figure class=\"highlight raw\"><figcaption data-lang=\"\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>kd&gt; dt _EPROCESS 89e21830</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>nt!_EPROCESS</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  ……</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  ……</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  +0x1f8 Vm               : _MMSUPPORT</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  ……</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  ……</pre></td></tr></table></figure><figure class=\"highlight raw\"><figcaption data-lang=\"\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>kd&gt; dt _MMSUPPORT 89e21830+0x1f8</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>nt!_MMSUPPORT</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>   +0x000 LastTrimTime     : _LARGE_INTEGER 0x01d86059&#96;8f011bc0</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>   +0x008 Flags            : _MMSUPPORT_FLAGS</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>   +0x00c PageFaultCount   : 0x41b</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>   +0x010 PeakWorkingSetSize : 0x3da</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>   +0x014 WorkingSetSize   : 0x3d5</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>   +0x018 MinimumWorkingSetSize : 0x32</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>   +0x01c MaximumWorkingSetSize : 0x159</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>   +0x020 VmWorkingSetList : 0xc0883000 _MMWSL</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>   +0x024 WorkingSetExpansionLinks : _LIST_ENTRY [ 0x8a063dd4 - 0x89d34ee4 ]</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>   +0x02c Claim            : 0</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>   +0x030 NextEstimationSlot : 0</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>   +0x034 NextAgingSlot    : 0</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>   +0x038 EstimatedAvailable : 0</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>   +0x03c GrowthSinceLastEstimate : 0x41b</pre></td></tr></table></figure>",
            "tags": [
                "物理内存",
                "MmAddPhysicalMemoryEx"
            ]
        }
    ]
}